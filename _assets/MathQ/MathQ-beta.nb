(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 9.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       157,          7]
NotebookDataLength[   1311275,      30461]
NotebookOptionsPosition[   1288222,      30145]
NotebookOutlinePosition[   1288636,      30162]
CellTagsIndexPosition[   1288593,      30159]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["MathQ v0.5.6", "Section",
 CellChangeTimes->{{3.598608499066093*^9, 3.598608502815298*^9}, 
   3.614750393615856*^9, 3.629641502717063*^9, 3.630394634248829*^9, 
   3.6352417448935547`*^9, 3.656847920282181*^9, 3.7075673141431828`*^9, {
   3.714367327329368*^9, 3.7143673276078587`*^9}, {3.719554662880035*^9, 
   3.719554662994585*^9}, {3.740244070682192*^9, 3.740244070921166*^9}, {
   3.747739212076058*^9, 3.747739212208742*^9}, {3.752150828833267*^9, 
   3.7521508290346127`*^9}, {3.7802906107704477`*^9, 
   3.780290611072673*^9}},ExpressionUUID->"cd22e688-f470-4680-87da-\
25388b4b55b5"],

Cell[CellGroupData[{

Cell["LICENSE", "Subsection",
 CellChangeTimes->{{3.713450502631578*^9, 3.7134505067245827`*^9}, {
  3.713450564856954*^9, 3.713450565404491*^9}, {3.71345193769666*^9, 
  3.713451938479409*^9}},ExpressionUUID->"e96489e7-8028-41db-b27d-\
0bc3aefbac22"],

Cell[TextData[StyleBox["The MathQ package is licensed under the MIT License.",
 
 FontWeight->"Bold"]], "Text",
 CellChangeTimes->{
  3.713451942418137*^9},ExpressionUUID->"afb87119-c016-4d06-9fb7-\
9abdfac51aec"],

Cell["\<\
Copyright (c) 2009-2017: Pablo San-Jose

http://icmm.csic.es/sanjose/MathQ/MathQ.html

Permission is hereby granted, free of charge, to any person obtaining a copy \
of this software and associated documentation files (the \
\[OpenCurlyDoubleQuote]Software\[CloseCurlyDoubleQuote]), to deal in the \
Software without restriction, including without limitation the rights to use, \
copy, modify, merge, publish, distribute, sublicense, and/or sell copies of \
the Software, and to permit persons to whom the Software is furnished to do \
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in \
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED \[OpenCurlyDoubleQuote]AS \
IS\[CloseCurlyDoubleQuote], WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, \
INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A \
PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR \
COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, \
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR \
IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\
\
\>", "Text",
 CellChangeTimes->{{3.713450510703476*^9, 3.713450561685811*^9}, {
  3.713605131095096*^9, 3.713605225543127*^9}, {3.714367337000374*^9, 
  3.714367338376889*^9}},ExpressionUUID->"15b01f8d-d832-4eda-8ed7-\
239ee0a7f65e"]
}, Closed]],

Cell[CellGroupData[{

Cell["Version History", "Subsection",
 CellChangeTimes->{{3.611812134329617*^9, 
  3.611812136149852*^9}},ExpressionUUID->"a5398dc3-a4f2-45cf-bfe3-\
9873562342fc"],

Cell[CellGroupData[{

Cell["Ideas", "Subsubsection",
 CellChangeTimes->{{3.6118121460865297`*^9, 
  3.611812149189371*^9}},ExpressionUUID->"e118da1c-40fb-484e-a3cf-\
1fb98fecf5b1"],

Cell[TextData[{
 StyleBox["- Rename Fields to ",
  FontFamily->".Lucida Grande UI",
  FontVariations->{"StrikeThrough"->True}],
 "MQ",
 StyleBox["Fields (conflict with Java library, I think)\n",
  FontFamily->".Lucida Grande UI",
  FontVariations->{"StrikeThrough"->True}],
 "- Reduce redundancy in code: \n\t- Bounded and Reshape may be fused in \
BuildLattice... Currently confusing ... or not?\n",
 StyleBox["- Options for PlotLattice should contain those of Graphics (e.g. \
Axes)",
  FontFamily->".Lucida Grande UI",
  FontVariations->{"StrikeThrough"->True}],
 "\n",
 StyleBox["- More intuitive field modification syntax: lattice[function & -> \
\[OpenCurlyDoubleQuote]Sites\[CloseCurlyDoubleQuote]].. maybe?",
  FontFamily->"Helvetica",
  FontVariations->{"StrikeThrough"->True}],
 StyleBox[" Nope",
  FontFamily->"Helvetica"],
 "\n",
 StyleBox["- Redefine Supercell to take a number, not a length (divide by \
LatticeConstant).... Maybe?",
  FontFamily->".Lucida Grande UI",
  FontVariations->{"StrikeThrough"->True}],
 "\n- Aborts are inelegant. Better recover with Catch?\n",
 StyleBox["- MMA10 :  Check MaxRecursion->0 being ignored (in Sample, always \
double sweep)\n- Polish PlotEigenstates",
  FontFamily->".Lucida Grande UI",
  FontVariations->{"StrikeThrough"->True}],
 "\n- Implement Z2 invariants (Soluyanov-Vanderbilt algos?)\n",
 StyleBox["- Warning about velocities: \[OpenCurlyDoubleQuote]Is your system \
Hermitian?\[CloseCurlyDoubleQuote]",
  FontFamily->"Helvetica",
  FontVariations->{"StrikeThrough"->True}],
 "\n- SolveScatteringSystem should be SolveScattering\n- ExpandSystem (check \
MathQ_lab) to grow a unit cell after building the system\n- MaxNeighbors in \
BuildScatteringSystem, please! But like HoppingRange, it should be an array.\n\
- Routines to compute the LDOS of a general system\n\n- ",
 StyleBox["Create function Conductance, that calls GCaroli or GNambu \
depending on the Nambu flag.",
  FontVariations->{"StrikeThrough"->True},
  FontColor->RGBColor[0., 0., 0.]],
 "\n- Create MQScatteringLattice?\n- Create BuildScatteringLattice that takes \
care of attaching leads (using Reshape).\n\t- \
BuildScatteringLattice[central_MGLattice, leads__MGLattice, \
centralregion_Function]\n- Build presets: \n\t- PresetLattice[\
\[OpenCurlyDoubleQuote]name\[CloseCurlyDoubleQuote], opts:OptionsPattern[]] \
that calls different private builders with distinct Options\n\t- \
PresetScatteringLattice[..]\n\t- PresetSystem[\[OpenCurlyDoubleQuote]name\
\[CloseCurlyDoubleQuote],lattice, opts:OptionsPattern[]]\n\t- \
PresetScatteringSsystem[\[OpenCurlyDoubleQuote]name\[CloseCurlyDoubleQuote],\
ScatteringLattice, opts:OptionsPattern[]]\n- Make sure all public functions \
are Modules, not Blocks (possible scope problems with names)... Is this \
necessary with Contexts?\n- Include DOS routine for a system.\n- Change name \
PlotPoints to SamplePoints in Sample\n- Improve performance of PlotLattice \
when passing a MQSystem"
}], "Text",
 CellChangeTimes->{{3.611812237418639*^9, 3.611812323646161*^9}, {
   3.611812374764072*^9, 3.6118123756679773`*^9}, {3.611833709572826*^9, 
   3.6118337699134617`*^9}, {3.6120730592203417`*^9, 3.612073093576282*^9}, {
   3.612073201172819*^9, 3.612073202516089*^9}, {3.612590097575651*^9, 
   3.612590102245779*^9}, 3.614409659026609*^9, {3.6144114438458433`*^9, 
   3.614411458028688*^9}, {3.614506831837142*^9, 3.6145068634171963`*^9}, {
   3.614750114682349*^9, 3.614750116641354*^9}, {3.614750295115058*^9, 
   3.614750323137107*^9}, {3.6147518025743523`*^9, 3.614751812229312*^9}, {
   3.619878240698407*^9, 3.619878254894546*^9}, {3.6202870185561132`*^9, 
   3.620287034034553*^9}, {3.620469489395362*^9, 3.6204695183941936`*^9}, {
   3.6215922484767*^9, 3.6215922491077557`*^9}, {3.62228685354771*^9, 
   3.622286863585335*^9}, {3.6222869832274446`*^9, 3.622287015105731*^9}, {
   3.622287046511462*^9, 3.6222870473442497`*^9}, {3.623408965077396*^9, 
   3.623408987388012*^9}, {3.623569470978382*^9, 3.623569480753791*^9}, {
   3.6239969504771976`*^9, 3.62399704206315*^9}, {3.6243368845832863`*^9, 
   3.624336940209488*^9}, {3.624353401033977*^9, 3.624353428574497*^9}, {
   3.6259795049707403`*^9, 3.6259795167694483`*^9}, 3.6296415045240307`*^9, 
   3.629641858896873*^9, 3.630394635952959*^9, {3.6308364843878117`*^9, 
   3.630836513161783*^9}, {3.631511879920351*^9, 3.631511900893977*^9}, {
   3.6315124339022923`*^9, 3.631512611002482*^9}, {3.6315128351040993`*^9, 
   3.631512907483659*^9}, {3.631513108028307*^9, 3.631513251699018*^9}, {
   3.631605780690213*^9, 3.631605809470951*^9}, {3.6319645071742687`*^9, 
   3.631964571497651*^9}, {3.6326352337615623`*^9, 3.632635268148983*^9}, {
   3.635236137254403*^9, 3.635236138885149*^9}, 3.63523644411932*^9, {
   3.635847694146997*^9, 3.635847721471752*^9}, 3.63757235570019*^9, 
   3.673688586701894*^9, {3.680329068159937*^9, 3.680329074111002*^9}, 
   3.6803302908548813`*^9, {3.6803331123184433`*^9, 3.680333114647036*^9}, {
   3.707567244466579*^9, 
   3.707567245592423*^9}},ExpressionUUID->"bf73ff40-fef4-458c-bd3b-\
2d5d48a0e2b3"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Corrected bugs", "Subsubsection",
 CellChangeTimes->{
  3.623496482080543*^9},ExpressionUUID->"a65a86bd-ebf4-4245-9dd1-\
d557dcf541f1"],

Cell[TextData[{
 StyleBox["- UntangledBands now accept EigenstateObservable -> functionname",
  FontFamily->"Helvetica",
  FontSize->14,
  FontWeight->"Regular",
  FontColor->RGBColor[0., 0., 0.]],
 StyleBox["\n",
  FontFamily->"Helvetica",
  FontVariations->{"StrikeThrough"->True}],
 StyleBox["- Bloch phase in a system assumed that the first phase corresponds \
to the transport direction. That should be left to the building phase. ",
  FontFamily->"Helvetica",
  FontSize->14,
  FontWeight->"Regular",
  FontVariations->{"StrikeThrough"->True}],
 StyleBox["BuildScatteringSystem aligns all BravaisVectors with Central \
region, leaving the the transport direction as the first (missing in central \
region)\n- Scattering states of fully reflected channels (because there are \
no propagating modes on the outgoing lead) fails at the Transpose[..., \
{2,3,1}]\n- BuildScatteringSystem failed when symbolic hopping or onsite \
energy is specified.\n- Bloch Phases of a MQSystem did not truncate the \
embedded Lattice\n- ModifySystem did not work with multiorbital sites. \
(Regression fixed: Now it works with both multi and single orbitals)\n- sys[\
\[OpenCurlyDoubleQuote]H\[CloseCurlyDoubleQuote]] would fail for a 1D system \
N[sys]\n",
  FontFamily->"Helvetica",
  FontSize->14,
  FontWeight->"Regular"]
}], "Text",
 CellChangeTimes->{
  3.6222870304498*^9, {3.6234964565874434`*^9, 3.6234964569727592`*^9}, {
   3.623512369370838*^9, 3.623512418400778*^9}, {3.623512725090706*^9, 
   3.623512755064899*^9}, 3.6315972310673103`*^9, {3.6648241056589117`*^9, 
   3.664824132023724*^9}, {3.665903950850745*^9, 3.665903954234456*^9}, {
   3.666700675780395*^9, 3.666700675925425*^9}, {3.666700723986485*^9, 
   3.666700724201824*^9}, {3.6938135653536997`*^9, 3.693813593833424*^9}, {
   3.714367345328974*^9, 3.714367400447056*^9}, {3.780290718528618*^9, 
   3.7802907783333197`*^9}},ExpressionUUID->"c2b46c93-b88f-4d9d-8a91-\
65f90ff6cd12"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Bugs and known issues", "Subsubsection",
 CellChangeTimes->{{3.622287040056293*^9, 3.6222870500391817`*^9}, {
  3.65639988427925*^9, 
  3.656399886710767*^9}},ExpressionUUID->"7334bdbb-5c0c-45f4-b4b9-\
7986ecba4ed7"],

Cell[TextData[{
 "- Interlinks between central region and leads for periodic systems are \
missing at corners\n- Interlinks do not show the hoppings in both directions\n\
- If we want to modify the coupling between lead and central system for \
scattering using , the modified coupling gets encoded also in the lead system \
(HBloch)\n- GCaroli doesn\[CloseCurlyQuote]t complain if Nambu->True\n- If we \
abort a Sample or Bands, ",
 StyleBox["Mathematica",
  FontSlant->"Italic"],
 " crashes.\n- GNambu returns rubbish if there are no incoming modes (empty \
scattering matrix)\n- Mathematica 10.1 crashes in BuildSystem when lattice \
mixes floats and Integers/Symbols.\n- PlotLattice doesn\[CloseCurlyQuote]t \
properly plot lead-central hoppings in the most general case (E.g.",
 Cell[BoxData[
  GraphicsBox[RasterBox[CompressedData["
1:eJztnMFuUkEUhpu40MS6cKF7t9QYtW58DR+hG7Uu3IOL2hcgMfAUTVz0MdRl
NxRIA6VAAgkETBETgz9MO7nMXOgwd4bOLf8XenMzmXMOk3OYmQud/9ne53d7
97a2tl7g7wf+pvcTQgiZZ/jzqHbwsrK/jSvuU+efBAvSXXl/P/pyWwC+/ZOQ
mc4q89lHS4r8k5DBgqVkHy0p8k+CpQyyGSX7aHHlv91ux/rvdDquQpAAqdfr
pRmnx9+U7KMF7dVqNYn/0Wi03D9AH1fDIYHQ6/VK11xeXk60ZzpZGACTj0UI
aY4a1v2j5ezs7Kr2Tk/djo7cFiuVjV6EJqxUNkoRkvRSqVREKlda8uQCCpb3
xFZK9jRf8qIFj3o2f2PkVvj1/ejr21efnj7CFfdoubi4MKyQRWDvL8wxNekh
ohVit13HRBqtTH0IJASQiw+PH0Rfx8WrLXS/30/iWZYQHMaGEIWXBEyqsf5Z
YIGAD7uSmtzrnUaj4cp/t9uFQz2EK/9A949BOfRPrMFqoqQGLekKsYYhEDv0
ucv5B993iDUMgdih77ucb1p8h1jDEIg14oFr/8k2NjCe8gK3ud0dhPD0TCeH
8OXNc5ZWgCT5/sEE8e2ZP/+T2RBqtZrXEMQOVpfCYDAQvyPginuvVkkMT05O
isXi4eEhrrj3bWhnxeqKgvyW5jHJuJ1VEkPk92Aew4zbGVqHY3VFkb9+Sky+
+7WzSmKICURJN1r8GVqHu9vV9W9FSnH8vgk7q6hhs9lsXzMyACuUkm60xL4N
BTvDWKs/BogR4WY8HvtIfbqqS59MqtXqjUUifpla1SpqeH5+3piBXIwNKBQK
Srrz+bxJdaGbhaFuhTfw1wAxKHHvI/XpWhm573IbTgzKpKcd6aquCZ8ZnVqx
uog/WF3EH6wu4g9WF/GBOIBT/viwnM14OlM/PbyfzSCEV90J+K/kdigLEA5r
EG2g7sTGsgbRBupObCxrEG2g7sTGon/wsftKeGY/Sr1ej9WFcHVmH350/5y7
AkHftEjRhlarlcSzPJq9SBci+Zn9Rf657woHXbTB7sy+RNcH0EPIDnZn9hV9
AGoVpg7zM/tRzPUB7M7s2+kDkDBRzuwvwU4fQDmzv6Rncn0AEiB6WhXdhuFw
KDvY6QPIf3DC1Kf7RwtWQMMiJ2mk2+2K/C7ShUiuD7DcP5W77jyYOmJ0IXad
6UJg6ovVneAWa0OgLgTxB3UhiD+oC0G84lvrj1qCJHD+A77x9TE=
    "], {{0, 0}, {202, 
    46}}, {0, 255},
    ColorFunction->RGBColor],
   ImageSize->{202, 46},
   PlotRange->{{0, 202}, {0, 46}}]], "Input",ExpressionUUID->
  "cbe64a65-d4a0-40f1-a11d-2ed226d4bb31"],
 ")\n- Lots of warnings when there are no incoming modes at the requested \
energy for GNambu\n- If a matrix Hopping is provided in BuildSystem, there is \
a silent failure, because Onsite is assumed scalar\n- Keyword Region is used \
in Mathematica 9+\n- CriticalCurrent fails with a strange error"
}], "Text",
 CellChangeTimes->{{3.622287052527091*^9, 3.6222871041751966`*^9}, 
   3.623496454152906*^9, {3.6239970844933977`*^9, 3.623997087972554*^9}, {
   3.624353430848133*^9, 3.624353462268757*^9}, {3.6243562265422573`*^9, 
   3.6243562331479263`*^9}, {3.624358710792995*^9, 3.624358754540436*^9}, {
   3.624360997319639*^9, 3.6243610165413847`*^9}, {3.6303927452150087`*^9, 
   3.630392786579092*^9}, {3.6303944921773357`*^9, 3.630394559076703*^9}, {
   3.630395005561153*^9, 3.630395036581328*^9}, {3.631448745488861*^9, 
   3.631448761129689*^9}, {3.631513316585804*^9, 3.631513317031389*^9}, {
   3.634025038934379*^9, 3.6340250823306017`*^9}, {3.635236199758772*^9, 
   3.6352362081091537`*^9}, {3.643533525641513*^9, 3.6435335612208652`*^9}, {
   3.6495904690032578`*^9, 3.649590519672117*^9}, {3.649590555029969*^9, 
   3.649590564207803*^9}, {3.6563998884308157`*^9, 3.65639992054875*^9}, {
   3.665903456402669*^9, 3.6659034797200203`*^9}, 3.66590394734549*^9, {
   3.666700673987156*^9, 3.6667007192499657`*^9}, {3.673616028765126*^9, 
   3.673616079022888*^9}, {3.6860258779657297`*^9, 3.6860259205392733`*^9}, {
   3.6938136295201187`*^9, 3.693813629520267*^9}, {3.708087505897596*^9, 
   3.7080875203194723`*^9}, 3.708327740184141*^9, {3.7802906156470203`*^9, 
   3.780290648804036*^9}, {3.78029069987075*^9, 
   3.780290713322321*^9}},ExpressionUUID->"932c8bd3-ae05-4ba2-91a8-\
c4a8defc367e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["History", "Subsubsection",
 CellChangeTimes->{{3.611812142485811*^9, 
  3.6118121432135487`*^9}},ExpressionUUID->"46fdaf51-1cdb-4f34-af1f-\
499e93df54c4"],

Cell[TextData[{
 StyleBox["v0.5\n",
  FontWeight->"Bold"],
 "- All eigenstates v now have a fixed phase using the criterion \
Arg[Total[v]]==0",
 StyleBox["\n",
  FontWeight->"Bold"],
 "- Provide Tags option for BuildLattice\n- [bug] PlotLattice would not use \
SiteRadius reliably\n- PlotLattice can now draw bounding boxes for unit cells\
\n- Added Conductance function that calls GCaroli or GNambu, depending on the \
system\n- Change name PlotPoints to SamplePoints in Sample, UntangledBands \
and BerryMesh\n- Added generic JosephsonCurrent and CriticalCurrent functions\
\n- Renamed GProbe to GreensFunction\n- ModifySystem now works with \
multiorbital systems\n- Corrected a bug in TransformLattice that would make \
it fail for completely generic lattices\n- Added AlignPlot y ExpandPlot to \
ease construction of Grids of aligned panels\n- Fixed EffectiveHamiltonian to \
include self energy from the lead when ExcludeLeadStub -> True (now the \
default)\n- Small fix in PlotField to respect \
\[OpenCurlyDoubleQuote]MaskRegion\[CloseCurlyDoubleQuote] even for 3D \
lattices.\n",
 StyleBox["\nv0.4",
  FontWeight->"Bold"],
 ":\n- Added MQGradientMesh functionality for more general elasticty \
optimization problems (and other applications)\n- Added methods to MQSystem \
to produce ReciprocalVectors and Velocities\n- Hermitian warning at \
BuildSystem level\n- Make ",
 Cell[BoxData[
  FormBox[
   RowBox[{"HoppingRange", "->", 
    RowBox[{"1", "/", 
     SqrtBox["3"]}]}], TraditionalForm]],ExpressionUUID->
  "ea5ce020-56b7-468f-92e7-48cf695a9c73"],
 " work properly (no 1.01 necessary).\n",
 StyleBox["\nv0.3",
  FontWeight->"Bold"],
 ":\n- RelaxLattice now accepts PinnedSites option\n",
 StyleBox["- Change \[OpenCurlyDoubleQuote]HSelf\[CloseCurlyDoubleQuote] to \
\[OpenCurlyDoubleQuote]H\[CloseCurlyDoubleQuote]",
  FontFamily->"Helvetica"],
 "\n- Change TCaroli to GCaroli, and TNambu to GNambu. \n- Make Supercell->n \
mean n {{1,0},{0,1}}\n\n",
 StyleBox["v0.2:",
  FontWeight->"Bold"],
 " \n- PlotLattice can show tooltips\n\n",
 StyleBox["v0.1",
  FontWeight->"Bold"],
 "\n- First release"
}], "Text",
 CellChangeTimes->{{3.611812335917581*^9, 3.611812348613235*^9}, {
   3.624344201085156*^9, 3.624344234891192*^9}, 3.631597255057476*^9, {
   3.635236152146983*^9, 3.635236208123817*^9}, {3.635236445638657*^9, 
   3.635236446885242*^9}, {3.642315385309209*^9, 3.642315421145602*^9}, {
   3.65095405567003*^9, 3.650954058749361*^9}, {3.65684788717943*^9, 
   3.65684791577862*^9}, {3.665903425557885*^9, 3.665903444315928*^9}, {
   3.665904270803788*^9, 3.665904283546318*^9}, {3.680330231829138*^9, 
   3.680330263203909*^9}, {3.707567250006653*^9, 3.707567308821611*^9}, {
   3.708067055003758*^9, 3.7080670723536253`*^9}, {3.7080751377081347`*^9, 
   3.7080751541399307`*^9}, {3.708075742047233*^9, 3.708075751178499*^9}, {
   3.708087112358652*^9, 3.708087137725445*^9}, {3.7083275662829247`*^9, 
   3.7083275758891973`*^9}, {3.719554670331387*^9, 3.71955469857861*^9}, {
   3.740244075313957*^9, 3.74024415137817*^9}, {3.747739225524651*^9, 
   3.747739242876607*^9}, {3.7521508327837067`*^9, 
   3.7521508666090508`*^9}},ExpressionUUID->"2014de58-1d09-48f8-84c8-\
9925c462c056"]
}, Open  ]]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{

Cell["Code", "Section",
 CellChangeTimes->{{3.597391241143929*^9, 
  3.597391244621579*^9}},ExpressionUUID->"67b6cebb-1f95-4ed6-957f-\
9c5eb2473d9f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"SetDirectory", "[", 
     RowBox[{"NotebookDirectory", "[", "]"}], "]"}], ";"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"SetSystemOptions", "[", 
    RowBox[{"\"\<PackedArrayOptions\>\"", "\[Rule]", 
     RowBox[{"\"\<UnpackMessage\>\"", "\[Rule]", "False"}]}], "]"}], 
   "*)"}]}]], "Input",
 CellChangeTimes->{{3.598637580597703*^9, 3.598637591671928*^9}, 
   3.598768434875023*^9, {3.667119028997303*^9, 3.667119031137903*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"69c56072-bce5-438c-a276-ea1a9565578e"],

Cell[CellGroupData[{

Cell["Data structures and access methods", "Subsection",
 CellChangeTimes->{{3.5973990476087646`*^9, 3.597399057555292*^9}, 
   3.598340760497601*^9, {3.631345298534101*^9, 
   3.631345306716816*^9}},ExpressionUUID->"8f94a3c6-5afc-49e0-a98f-\
a0dcc07374ac"],

Cell["Lists of possible MQ objects and their different fields. ", "Text",
 CellChangeTimes->{{3.597398541981543*^9, 3.597398553303851*^9}, {
   3.597398691011436*^9, 3.597398704452346*^9}, {3.5973989008991137`*^9, 
   3.597398923998354*^9}, {3.597400862212956*^9, 3.597400862876445*^9}, {
   3.597402507742382*^9, 3.597402540045355*^9}, 3.598333860017476*^9, 
   3.629641520436571*^9},ExpressionUUID->"abbe5c14-6f6c-4f0e-b692-\
c0efa522825a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"MQStructures", "=", 
    RowBox[{"{", 
     RowBox[{
     "MQLattice", ",", "MQSystem", ",", "MQScatteringSystem", ",", 
      "MQLeadSolution", ",", "MQSystemSolution", ",", "MQScatteringStates", 
      ",", "MQSpringMesh", ",", " ", "MQGradientMesh", ",", 
      "MQBandstructure"}], 
     RowBox[{"(*", 
      RowBox[{",", "MQBandstructure"}], "*)"}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQFields", "[", "MQLattice", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<Sites\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Tags\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<EmbeddingDimensions\>\"", "\[Rule]", "_Integer"}]}], 
     "}"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQFields", "[", "MQSystem", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<HBloch\>\"", "\[Rule]", 
       RowBox[{"{", "___SparseArray", "}"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\"\<Nambu\>\"", "\[Rule]", "_Boole"}], ",", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
       RowBox[{"_MQLattice", "||", 
        RowBox[{"Missing", "[", "]"}]}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQFields", "[", "MQScatteringSystem", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<Central\>\"", "\[Rule]", "_MQSystem"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Leads\>\"", "\[Rule]", 
       RowBox[{"{", "__MQSystem", "}"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\"\<Couplings\>\"", "\[Rule]", 
       RowBox[{"{", "_SparseArray", "}"}]}], ",", " ", "\[IndentingNewLine]", 
      
      RowBox[{"\"\<SurfaceLeads\>\"", "\[Rule]", 
       RowBox[{"{", "__Integer", "}"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\"\<SurfacesCentral\>\"", "\[Rule]", 
       RowBox[{"{", "__Integer", "}"}]}], ",", " ", "\[IndentingNewLine]", 
      RowBox[{"\"\<Nambu\>\"", "\[Rule]", "_Boole"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
       RowBox[{"_MQLattice", "||", 
        RowBox[{"Missing", "[", "]"}]}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQFields", "[", "MQLeadSolution", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<r0\>\"", "\[Rule]", "_List"}], ",", "\[IndentingNewLine]", 
      
      RowBox[{"\"\<psiSurface\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<invphig\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<gSurface\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<invg\>\"", "->", "_List"}], ",", "\[IndentingNewLine]", 
      RowBox[{"\"\<Nambu\>\"", "\[Rule]", "_Boole"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<NambuSectors\>\"", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"_Integer", ",", "_Integer"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"_Integer", ",", "_Integer"}], "}"}]}], "}"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<ExtraData\>\"", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<\[Phi]InP\>\"", "\[Rule]", "_List"}], ",", 
         RowBox[{"\"\<\[Lambda]InP\>\"", "->", "_List"}], ",", 
         RowBox[{"\"\<\[Phi]Out\>\"", "\[Rule]", "_List"}], ",", 
         RowBox[{"\"\<\[Lambda]Out\>\"", "\[Rule]", "_List"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<r0Full\>\"", "\[Rule]", "_List"}], ",", 
         RowBox[{"\"\<invphigFull\>\"", "->", "_List"}]}], "}"}]}]}], "}"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQFields", "[", "MQSystemSolution", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<SiteDimensions\>\"", "\[Rule]", "_Integer"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Leads\>\"", "\[Rule]", 
       RowBox[{"{", "__MQLeadSolution", "}"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\"\<G\>\"", "\[Rule]", "_SparseArray"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<CouplingsSurface\>\"", "\[Rule]", 
       RowBox[{"{", "__SparseArray", "}"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\"\<Nambu\>\"", "\[Rule]", "_Boole"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<ExtraData\>\"", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{"\"\<Couplings\>\"", "->", "_List"}], "}"}]}]}], "}"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQFields", "[", "MQScatteringStates", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<CentralStates\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<ScatteredStates\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Nambu\>\"", "\[Rule]", "_Boole"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQFields", "[", "MQSpringMesh", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<SpringConstants\>\"", "\[Rule]", "_MGSystem"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<EquilibriumDistances\>\"", "\[Rule]", "_MGSystem"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<EmbeddingDimensions\>\"", "\[Rule]", "_Integer"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
       RowBox[{"_MQLattice", "||", 
        RowBox[{"Missing", "[", "]"}]}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQFields", "[", "MQGradientMesh", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<EvaluationMatrix\>\"", "\[Rule]", "SparseArray"}], ",", 
      " ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{"This", " ", "is", " ", "a", " ", "3"}], "-", 
         RowBox[{"index", " ", "tensor", " ", 
          SubscriptBox["H", 
           RowBox[{"j", ",", "n", ",", 
            RowBox[{
             RowBox[{"n", "'"}], "\.1d"}]}]], " ", "that", " ", "produces", 
          " ", 
          RowBox[{
           SubscriptBox["\[PartialD]", "j"], 
           SubscriptBox["u", "n"]}]}]}], "=", 
        RowBox[{
         SubscriptBox["H", 
          RowBox[{"jnn", "'"}]], 
         SubscriptBox["u", 
          RowBox[{"n", "'"}]]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"\"\<System\>\"", "\[Rule]", "_MQSystem"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Field\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Energy\>\"", "\[Rule]", 
       RowBox[{"_Real", "||", 
        RowBox[{"Missing", "[", "]"}]}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQFields", "[", "MQBandstructure", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<BandData\>\"", "\[Rule]", "_List"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<LatticeDimensions\>\"", "\[Rule]", "_Integer"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<NumberOfPoints\>\"", "\[Rule]", "_Integer"}], ",", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<UnitCellArea\>\"", "\[Rule]", "_Real"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<Lattice\>\"", "\[Rule]", "_MQLattice"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"MQFields", "[", "MQBandstructure", "]"}], "=", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\"\<Nodes\>\"", "\[Rule]", "_List"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<Links\>\"", "\[Rule]", "_List"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<Energies\>\"", "\[Rule]", "_List"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<States\>\"", "\[Rule]", "_List"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<Connections\>\"", "\[Rule]", "_List"}], ",", " ", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<Deltaz\>\"", "\[Rule]", "_Real"}]}], "}"}]}], ";"}], 
   "*)"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.5973985566461678`*^9, 3.597398559848609*^9}, {
   3.597398706163663*^9, 3.5973987813663893`*^9}, {3.597398819599621*^9, 
   3.5973988742535067`*^9}, {3.5974021236005583`*^9, 3.59740215545022*^9}, {
   3.597402493961124*^9, 3.597402494614605*^9}, {3.597572793389443*^9, 
   3.597572835277793*^9}, {3.597575807230627*^9, 3.597575827976447*^9}, {
   3.597632924354479*^9, 3.5976329249866133`*^9}, {3.597737334809061*^9, 
   3.597737411400749*^9}, {3.5977375211218*^9, 3.5977375217137527`*^9}, 
   3.597754739841099*^9, {3.59782783913056*^9, 3.59782785175449*^9}, {
   3.597827927766719*^9, 3.5978279424157343`*^9}, {3.5978434780661287`*^9, 
   3.5978434825367117`*^9}, {3.597867212660026*^9, 3.597867213307529*^9}, {
   3.597932625341085*^9, 3.597932686039672*^9}, {3.5979327428076267`*^9, 
   3.597932804038735*^9}, {3.598094017355768*^9, 3.598094037104967*^9}, {
   3.598161906555378*^9, 3.5981619380824614`*^9}, 3.598179429923849*^9, 
   3.598180117770112*^9, {3.59818063760061*^9, 3.598180671822728*^9}, {
   3.598180710892479*^9, 3.598180754086914*^9}, 3.598183790952938*^9, {
   3.598193823216164*^9, 3.598193853481283*^9}, {3.598194415632702*^9, 
   3.5981944164885674`*^9}, {3.5982536759186974`*^9, 
   3.5982537215840397`*^9}, {3.598257678654093*^9, 3.598257680077149*^9}, {
   3.598260790102373*^9, 3.598260804121365*^9}, {3.5983338498744183`*^9, 
   3.598333868655334*^9}, {3.5983343613110657`*^9, 3.5983343866595078`*^9}, {
   3.598334421937244*^9, 3.598334436088154*^9}, {3.598941708552061*^9, 
   3.5989417181555758`*^9}, {3.5991389923599167`*^9, 3.599139023485304*^9}, {
   3.599197684279354*^9, 3.599197685708683*^9}, {3.599198154947029*^9, 
   3.5991981567806273`*^9}, {3.603107536689745*^9, 3.6031075708749237`*^9}, {
   3.603176495059267*^9, 3.603176573598064*^9}, 3.6031787689244337`*^9, {
   3.603179411934205*^9, 3.6031794446331043`*^9}, 3.6031800481656857`*^9, {
   3.603180104992527*^9, 3.603180125462366*^9}, 3.603180513303586*^9, {
   3.603180560107292*^9, 3.60318056303792*^9}, {3.6031899410825367`*^9, 
   3.603189953415825*^9}, {3.60319269157098*^9, 3.603192731428337*^9}, {
   3.6031928101578074`*^9, 3.60319282398882*^9}, 3.603193045697072*^9, {
   3.603194142574109*^9, 3.603194142726307*^9}, {3.6147517285632763`*^9, 
   3.6147517337562237`*^9}, {3.629641521403853*^9, 3.629641535961968*^9}, {
   3.6309170454863253`*^9, 3.6309170865793657`*^9}, {3.630917648535873*^9, 
   3.630917662454234*^9}, {3.630920110354534*^9, 3.630920114457486*^9}, {
   3.635235804367763*^9, 3.635235805605898*^9}, {3.6352358377171803`*^9, 
   3.635235873081505*^9}, {3.635235909336472*^9, 3.635235913873158*^9}, {
   3.635240619615226*^9, 3.63524064348547*^9}, {3.635588209731505*^9, 
   3.635588211254334*^9}, {3.6363546566837254`*^9, 3.6363546615385733`*^9}, {
   3.6440421185818253`*^9, 3.64404221346058*^9}, {3.644042246741741*^9, 
   3.644042253612204*^9}, {3.644042925066463*^9, 3.6440429412557364`*^9}, {
   3.644046869586768*^9, 3.644046879611377*^9}, {3.644153906936635*^9, 
   3.644153916977867*^9}, {3.646545317683963*^9, 3.646545318157112*^9}, {
   3.656821845299677*^9, 3.656821853573084*^9}, {3.6568221277828503`*^9, 
   3.656822225160994*^9}, {3.65682253670441*^9, 3.656822549790555*^9}, {
   3.6568226577316523`*^9, 3.656822705025447*^9}, {3.6568331586186113`*^9, 
   3.656833163996187*^9}, {3.65684709566883*^9, 3.6568471089562902`*^9}, {
   3.656848211096755*^9, 3.656848222086995*^9}, {3.657014586226708*^9, 
   3.6570145880725317`*^9}, {3.6570160930144243`*^9, 
   3.6570161137812643`*^9}, {3.657017465580266*^9, 3.6570174794827023`*^9}, {
   3.657017755118424*^9, 3.657017755677801*^9}, {3.665912386820758*^9, 
   3.6659124167936573`*^9}, {3.665913211480171*^9, 3.665913222615447*^9}, {
   3.665917674889023*^9, 3.665917688328643*^9}, 3.665991205791531*^9, {
   3.6665973361014767`*^9, 3.666597345148191*^9}, {3.666790065645706*^9, 
   3.666790065648201*^9}, {3.666790145468254*^9, 3.666790173116003*^9}, 
   3.6667903412542963`*^9, {3.666792531006241*^9, 3.666792531336976*^9}, {
   3.666844173479395*^9, 3.666844179693864*^9}},
 CellLabel->"In[2]:=",ExpressionUUID->"f159e95b-38b0-4511-92f7-87a9d1a63a65"],

Cell["\<\
Definition of Field retrieval for each of the data structures in \
MQStructures, and additional methods which compute values from fields.\
\>", "Text",
 CellChangeTimes->{{3.597391204961741*^9, 3.597391221513369*^9}, {
   3.597400840780417*^9, 3.597400842519165*^9}, {3.597402467043331*^9, 
   3.597402480746932*^9}, {3.5977515652052794`*^9, 3.5977515691079187`*^9}, {
   3.59833448554323*^9, 3.598334490836226*^9}, 
   3.6296415368972483`*^9},ExpressionUUID->"5c5f998a-c21d-4469-9be3-\
bddeca6108ef"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"MQLattice", "::", "sitetag"}], "=", 
   "\"\<Site `1` does not exist. The lattice has `2` sites\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQSystem", "::", "dim"}], "=", 
   "\"\<Number of Bloch phases exceeds the dimensions of the lattice\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQScatteringSystem", "::", "dim"}], "=", 
   "\"\<Number of Bloch phases exceeds the dimensions of the central system\>\
\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.59775185074732*^9, 3.597751912398538*^9}, {
  3.598089112327859*^9, 3.5980891814444237`*^9}, {3.629641537569447*^9, 
  3.6296415384255543`*^9}},
 CellLabel->"In[12]:=",ExpressionUUID->"895e5d95-7ea1-4ea7-b0a4-7c9f1beaae8b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQLattice", "[", "data__", "]"}], "[", "\"\<NumberOfSites\>\"", 
    "]"}], ":=", 
   RowBox[{"Length", "@", 
    RowBox[{"Flatten", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"MQLattice", "[", "data", "]"}], "[", "\"\<Sites\>\"", "]"}], 
      ",", "1"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQLattice", "[", "data__", "]"}], "[", "\"\<TagSizes\>\"", "]"}],
    ":=", 
   RowBox[{"Length", "/@", 
    RowBox[{
     RowBox[{"MQLattice", "[", "data", "]"}], "[", "\"\<Sites\>\"", "]"}]}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQLattice", "[", "data__", "]"}], "[", "\"\<FlatSites\>\"", 
    "]"}], ":=", 
   RowBox[{"Flatten", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"MQLattice", "[", "data", "]"}], "[", "\"\<Sites\>\"", "]"}], 
     ",", "1"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQLattice", "[", "data__", "]"}], "[", 
    "\"\<LatticeDimensions\>\"", "]"}], ":=", 
   RowBox[{"Length", "[", 
    RowBox[{
     RowBox[{"MQLattice", "[", "data", "]"}], "[", "\"\<BravaisVectors\>\"", 
     "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQLattice", "[", "data__", "]"}], "[", "\"\<SiteTags\>\"", "]"}],
    ":=", 
   RowBox[{"MapThread", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Replace", "[", 
       RowBox[{"#1", ",", 
        RowBox[{"_", "\[Rule]", "#2"}], ",", 
        RowBox[{"{", "1", "}"}]}], "]"}], "&"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"MQLattice", "[", "data", "]"}], "[", "\"\<Sites\>\"", "]"}], 
       ",", 
       RowBox[{
        RowBox[{"MQLattice", "[", "data", "]"}], "[", "\"\<Tags\>\"", "]"}]}],
       "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQLattice", "[", "data__", "]"}], "[", "\"\<SiteIndices\>\"", 
    "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n", "=", "1"}], "}"}], ",", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"n", "++"}], "&"}], ",", 
       RowBox[{
        RowBox[{"MQLattice", "[", "data", "]"}], "[", "\"\<Sites\>\"", "]"}], 
       ",", 
       RowBox[{"{", "2", "}"}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"MQLattice", "[", "data__", "]"}], "[", 
     RowBox[{"\"\<Tags\>\"", "\[Rule]", 
      RowBox[{"{", "tags__", "}"}]}], "]"}], ":=", 
    RowBox[{
     RowBox[{"MQLattice", "[", "data", "]"}], "/.", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Rule", "[", 
        RowBox[{"\"\<Tags\>\"", ",", "_"}], "]"}], "->", 
       RowBox[{"Rule", "[", 
        RowBox[{"\"\<Tags\>\"", ",", 
         RowBox[{"PadRight", "[", 
          RowBox[{
           RowBox[{"{", "tags", "}"}], ",", 
           RowBox[{"Length", "@", 
            RowBox[{
             RowBox[{"MQLattice", "[", "data", "]"}], "[", "\"\<Sites\>\"", 
             "]"}]}], ",", 
           RowBox[{"{", "tags", "}"}]}], "]"}]}], "]"}]}], ")"}]}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "This", " ", "works", " ", "for", " ", "any", " ", "embedding", " ", 
    "dimensions"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"MQLattice", "[", "data__", "]"}], "[", "\"\<UnitCellArea\>\"", 
     "]"}], ":=", 
    RowBox[{"Times", "@@", 
     RowBox[{"SingularValueList", "@", 
      RowBox[{
       RowBox[{"MQLattice", "[", "data", "]"}], "[", "\"\<BravaisVectors\>\"",
        "]"}]}]}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "PseudoInverse", " ", "is", " ", "the", " ", "correct", " ", "operation", 
     " ", "when", " ", "LatticeDimensions"}], "<", "EmbeddingDimensions"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"MQLattice", "[", "data__", "]"}], "[", 
     "\"\<ReciprocalVectors\>\"", "]"}], ":=", 
    RowBox[{"2", "\[Pi]", " ", 
     RowBox[{"PseudoInverse", "@", 
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{"MQLattice", "[", "data", "]"}], "[", 
        "\"\<BravaisVectors\>\"", "]"}], "]"}]}]}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", 
    "\"\<LatticeDimensions\>\"", "]"}], ":=", 
   RowBox[{"Length", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<HBloch\>\"", "]"}], 
     "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQSystem", "[", "data__", "]"}], "[", "\"\<H\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{"ConstantArray", "[", 
    RowBox[{"0", ",", 
     RowBox[{
      RowBox[{"MQSystem", "[", "data", "]"}], "[", 
      "\"\<LatticeDimensions\>\"", "]"}]}], "]"}], "/.", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<HBloch\>\"", "]"}], "/.", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"i_Real", ",", "j___Real"}], "}"}], ":>", 
      RowBox[{"Round", "[", 
       RowBox[{"{", 
        RowBox[{"i", ",", "j"}], "}"}], "]"}]}]}], 
    ")"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", "\"\<NumberOfSites\>\"", 
    "]"}], ":=", 
   RowBox[{"First", "@", 
    RowBox[{"Dimensions", "@", 
     RowBox[{
      RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<H\>\"", "]"}]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", "\"\<SiteDimensions\>\"", 
    "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", "#"}], "\[Equal]", "2"}], ",", "1", ",", 
       RowBox[{"Last", "@", "#"}]}], "]"}], "&"}], "@", 
    RowBox[{"Dimensions", "@", 
     RowBox[{
      RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<H\>\"", "]"}]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", 
    "\"\<BlochBoundarySites\>\"", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "v", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"v", "=", 
       RowBox[{
        RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<HBloch\>\"", 
        "]"}]}], ";", 
      RowBox[{"v", "=", 
       RowBox[{"DeleteCases", "[", 
        RowBox[{"v", ",", 
         RowBox[{
          RowBox[{"ConstantArray", "[", 
           RowBox[{"0", ",", 
            RowBox[{
             RowBox[{"MQSystem", "[", "data", "]"}], "[", 
             "\"\<LatticeDimensions\>\"", "]"}]}], "]"}], "\[Rule]", "_"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Sort", "@", 
       RowBox[{"DeleteDuplicates", "@", 
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Most", "[", 
             RowBox[{"ArrayRules", "[", "#", "]"}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], "&"}], "/@", 
          RowBox[{"Last", "/@", "v"}]}], "]"}]}]}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", 
    "\"\<BlochBoundarySitesGrouped\>\"", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"lattice", "=", 
        RowBox[{
         RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<Lattice\>\"", 
         "]"}]}], ",", " ", "boundary", ",", " ", "groupedindices"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lattice", "===", 
         RowBox[{"Missing", "[", "]"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"boundary", "=", 
       RowBox[{
        RowBox[{"MQSystem", "[", "data", "]"}], "[", 
        "\"\<BlochBoundarySites\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"Intersection", "[", 
         RowBox[{"boundary", ",", "#"}], "]"}], "&"}], "/@", 
       RowBox[{"lattice", "[", "\"\<SiteIndices\>\"", "]"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", "\"\<Flat\>\"", "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<SiteDimensions\>\"", 
       "]"}], "\[Equal]", "1"}], ",", 
     RowBox[{"MQSystem", "[", "data", "]"}], ",", 
     RowBox[{
      RowBox[{"MQSystem", "[", "data", "]"}], "[", 
      RowBox[{"\"\<HBloch\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"MapAt", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"ArrayFlatten", "[", "#", "]"}], "&"}], ",", "#", ",", 
           RowBox[{"{", 
            RowBox[{"All", ",", "2"}], "}"}]}], "]"}], "&"}], ")"}]}], 
      "]"}]}], "]"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Bloch", " ", "sum"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", 
    RowBox[{"zBloch__", "?", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"!", 
         RowBox[{"StringQ", "[", "#", "]"}]}], "&&", 
        RowBox[{
         RowBox[{"Head", "[", "#", "]"}], "=!=", "Rule"}], "&&", 
        RowBox[{
         RowBox[{"Head", "[", "#", "]"}], "=!=", "List"}]}], "&"}], ")"}]}], 
    "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"z", ",", " ", "zcollapse", ",", 
       RowBox[{"dim", "=", 
        RowBox[{
         RowBox[{"MQSystem", "[", "data", "]"}], "[", 
         "\"\<LatticeDimensions\>\"", "]"}]}], ",", " ", "newH"}], "}"}], ",",
      "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"dim", "<", 
         RowBox[{"Length", "[", 
          RowBox[{"{", "zBloch", "}"}], "]"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"MQSystem", "::", "dim"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{
         "Which", " ", "Bravais", " ", "vectors", " ", "should", " ", "be", 
          " ", "Bloch"}], "-", 
         RowBox[{
          RowBox[{"summed", ".", " ", "Exclude"}], " ", "those", " ", "whose",
           " ", "phase", " ", "reads", " ", "None"}]}], ",", " ", 
        RowBox[{
        "and", " ", "those", " ", "not", " ", "specified", " ", "in", " ", 
         RowBox[{"zBloch", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"zcollapse", "=", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"#", "=!=", "None"}], "&"}], "/@", 
          RowBox[{"{", "zBloch", "}"}]}], ",", "dim", ",", "False"}], "]"}]}],
       ";", "\[IndentingNewLine]", 
      RowBox[{"z", "=", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", "zBloch", "}"}], "/.", 
          RowBox[{"None", "\[Rule]", "0"}]}], ",", "dim"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"newH", "=", 
       RowBox[{
        RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<HBloch\>\"", 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"newH", "=", 
       RowBox[{"newH", "/.", 
        RowBox[{
         RowBox[{"Rule", "[", 
          RowBox[{
           RowBox[{"{", "i__", "}"}], ",", "h_"}], "]"}], ":>", 
         RowBox[{"Rule", "[", 
          RowBox[{
           RowBox[{"Pick", "[", 
            RowBox[{
             RowBox[{"{", "i", "}"}], ",", 
             RowBox[{"Not", "/@", "zcollapse"}]}], "]"}], ",", 
           RowBox[{
            SuperscriptBox["\[ExponentialE]", 
             RowBox[{"\[ImaginaryI]", " ", 
              RowBox[{"z", ".", 
               RowBox[{"{", "i", "}"}]}]}]], "h"}]}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"newH", "=", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"#", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}], "\[Rule]", 
          RowBox[{"Total", "[", 
           RowBox[{"#", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "&"}], "/@", 
        RowBox[{"Gather", "[", 
         RowBox[{"newH", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"First", "[", "#1", "]"}], "\[Equal]", 
            RowBox[{"First", "[", "#2", "]"}]}], "&"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MQSystem", "@@", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"{", "data", "}"}], "/.", 
          RowBox[{
           RowBox[{"Rule", "[", 
            RowBox[{"\"\<HBloch\>\"", ",", "_"}], "]"}], "\[Rule]", 
           RowBox[{"Rule", "[", 
            RowBox[{"\"\<HBloch\>\"", ",", "newH"}], "]"}]}]}], "/.", 
         RowBox[{
          RowBox[{"Rule", "[", 
           RowBox[{"\"\<Lattice\>\"", ",", "lat_MQLattice"}], "]"}], "->", 
          RowBox[{"Rule", "[", 
           RowBox[{"\"\<Lattice\>\"", ",", 
            RowBox[{"lat", "[", 
             RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Pick", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{"Not", "/@", "zcollapse"}]}], "]"}], "&"}], ")"}]}],
              "]"}]}], "]"}]}]}], ")"}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "We", " ", "admit", " ", "also", " ", "a", " ", "vector", " ", "as", " ", 
    "Bravais", " ", "phases"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"MQSystem", "[", "data__", "]"}], "[", 
     RowBox[{"zBloch_", "?", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"VectorQ", "[", 
         RowBox[{"#", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"!", 
             RowBox[{"StringQ", "[", "#", "]"}]}], "&&", 
            RowBox[{
             RowBox[{"Head", "[", "#", "]"}], "=!=", "Rule"}], "&&", 
            RowBox[{
             RowBox[{"Head", "[", "#", "]"}], "=!=", "List"}]}], "&"}]}], 
         "]"}], "&"}], ")"}]}], "]"}], ":=", 
    RowBox[{
     RowBox[{"MQSystem", "[", "data", "]"}], "[", 
     RowBox[{"Sequence", "@@", "zBloch"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", "\"\<SiteNeighbors\>\"", 
    "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"HBloch", ",", "groups"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"HBloch", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<HBloch\>\"", "]"}],
         "/.", 
        RowBox[{
         RowBox[{"Rule", "[", 
          RowBox[{
           RowBox[{"z", ":", 
            RowBox[{"{", 
             RowBox[{"0", "..."}], "}"}]}], ",", "v_"}], "]"}], 
         "\[RuleDelayed]", 
         RowBox[{"Rule", "[", 
          RowBox[{"z", ",", 
           RowBox[{"Chop", "[", 
            RowBox[{"v", "-", 
             RowBox[{"DiagonalMatrix", "@", 
              RowBox[{"Diagonal", "@", "v"}]}]}], "]"}]}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"groups", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{
           RowBox[{"{", "rule", "}"}], ",", 
           RowBox[{"MapIndexed", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"#2", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], ",", 
                RowBox[{"Flatten", "@", 
                 RowBox[{
                  RowBox[{"Most", "[", 
                   RowBox[{"ArrayRules", "[", "#1", "]"}], "]"}], "[", 
                  RowBox[{"[", 
                   RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], "}"}], "&"}], 
             ",", 
             RowBox[{"rule", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], "]"}], ",", 
         "HBloch"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Flatten", "/@", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"DeleteCases", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", "}"}]}], "]"}], "&"}], "/@", 
         RowBox[{"Transpose", "[", 
          RowBox[{"groups", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "]"}]}], 
        ")"}]}]}]}], "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 

 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", 
    "\"\<SiteNeighborDistances\>\"", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"lattice", "=", 
        RowBox[{
         RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<Lattice\>\"", 
         "]"}]}], ",", "positions", ",", " ", "bravaisvectors", ",", " ", 
       "HBloch", ",", " ", "groups"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lattice", "===", 
         RowBox[{"Missing", "[", "]"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"positions", "=", 
       RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"bravaisvectors", "=", 
       RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"HBloch", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<HBloch\>\"", "]"}],
         "/.", 
        RowBox[{
         RowBox[{"Rule", "[", 
          RowBox[{
           RowBox[{"z", ":", 
            RowBox[{"{", 
             RowBox[{"0", "..."}], "}"}]}], ",", "v_"}], "]"}], 
         "\[RuleDelayed]", 
         RowBox[{"Rule", "[", 
          RowBox[{"z", ",", 
           RowBox[{"Chop", "[", 
            RowBox[{"v", "-", 
             RowBox[{"DiagonalMatrix", "@", 
              RowBox[{"Diagonal", "@", "v"}]}]}], "]"}]}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"groups", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{
           RowBox[{"{", "rule", "}"}], ",", 
           RowBox[{"MapIndexed", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"#2", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], ",", 
                RowBox[{
                 RowBox[{"rule", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "->", 
                 RowBox[{"Flatten", "@", 
                  RowBox[{
                   RowBox[{"Most", "[", 
                    RowBox[{"ArrayRules", "[", "#1", "]"}], "]"}], "[", 
                   RowBox[{"[", 
                    RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}]}], "}"}], 
              "&"}], ",", 
             RowBox[{"rule", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], "]"}], ",", 
         "HBloch"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"groups", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Range", "[", 
             RowBox[{"Length", "[", "#", "]"}], "]"}], ",", "#"}], "}"}], 
          "]"}], "&"}], "[", 
        RowBox[{
         RowBox[{
          RowBox[{"DeleteCases", "[", 
           RowBox[{"#", ",", 
            RowBox[{
             RowBox[{"{", "___", "}"}], "\[Rule]", 
             RowBox[{"{", "}"}]}]}], "]"}], "&"}], "/@", 
         RowBox[{"Transpose", "[", 
          RowBox[{"groups", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}], "]"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"groups", "/.", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i_Integer", ",", 
          RowBox[{"{", "rules___Rule", "}"}]}], "}"}], "\[RuleDelayed]", 
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Function", "[", 
            RowBox[{
             RowBox[{"{", "rule", "}"}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"positions", "[", 
                 RowBox[{"[", "#", "]"}], "]"}], "-", 
                RowBox[{
                 RowBox[{"rule", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], ".", "bravaisvectors"}], 
                "-", 
                RowBox[{"positions", "[", 
                 RowBox[{"[", "i", "]"}], "]"}]}], "&"}], "/@", 
              RowBox[{"rule", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}]}], "]"}], "/@", 
           RowBox[{"{", "rules", "}"}]}], ",", "1"}], "]"}]}]}]}]}], "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"MQSystem", "[", "data__", "]"}], "[", "\"\<Velocities\>\"", 
     "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"lat", "=", 
         RowBox[{
          RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<Lattice\>\"", 
          "]"}]}], ",", "A", ",", "newH", ",", " ", "unitvecs"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"lat", "===", 
          RowBox[{"Missing", "[", "]"}]}], ",", 
         RowBox[{
          RowBox[{"Message", "[", 
           RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ";", "Abort"}]}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"A", "=", 
        RowBox[{"lat", "[", "\"\<BravaisVectors\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"unitvecs", "=", 
        RowBox[{"IdentityMatrix", "[", 
         RowBox[{"lat", "[", "\"\<EmbeddingDimensions\>\"", "]"}], "]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"newH", "=", 
        RowBox[{
         RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<HBloch\>\"", 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "We", " ", "multiply", " ", "each", " ", "hopping", " ", "matrix", 
          " ", 
          SubscriptBox["V", "i"], " ", "with", " ", 
          RowBox[{
           SubscriptBox["A", "i"], "\[CenterDot]", 
           SubscriptBox["x", "j"]}]}], ",", " ", 
         RowBox[{
         "where", " ", "x", " ", "are", " ", "unitary", " ", "vectors"}]}], 
        " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"newH", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"newH", "/.", 
           RowBox[{
            RowBox[{"Rule", "[", 
             RowBox[{
              RowBox[{"{", "i__", "}"}], ",", "h_"}], "]"}], "\[RuleDelayed]", 
            RowBox[{"Rule", "[", 
             RowBox[{
              RowBox[{"{", "i", "}"}], ",", 
              RowBox[{"Chop", "[", 
               RowBox[{"\[ImaginaryI]", " ", 
                RowBox[{
                 RowBox[{"{", "i", "}"}], ".", "A", ".", "x"}], " ", "h"}], 
               "]"}]}], "]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"x", ",", "unitvecs"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"MQSystem", "[", "data", "]"}], "[", 
          RowBox[{"\"\<HBloch\>\"", "\[Rule]", 
           RowBox[{"(", 
            RowBox[{"h", "&"}], ")"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"h", ",", "newH"}], "}"}]}], "]"}]}]}], "]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystem", "[", "data__", "]"}], "[", "\"\<Velocities\>\"", 
    "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"lat", "=", 
        RowBox[{
         RowBox[{"MQSystem", "[", "data", "]"}], "[", "\"\<Lattice\>\"", 
         "]"}]}], ",", "sites", ",", "newH", ",", " ", "unitvecs"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lat", "===", 
         RowBox[{"Missing", "[", "]"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ";", "Abort"}]}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"unitvecs", "=", 
       RowBox[{"IdentityMatrix", "[", 
        RowBox[{"lat", "[", "\"\<EmbeddingDimensions\>\"", "]"}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{
         "We", " ", "change", " ", "hoppings", " ", "t_ij", " ", "to"}], " ", 
         "-", 
         RowBox[{"\[ImaginaryI]", " ", "t_ij", " ", 
          RowBox[{"(", 
           RowBox[{"r_i", "-", "r_j"}], ")"}]}]}], ",", " ", 
        RowBox[{
         RowBox[{"as", " ", "implied", " ", "by", " ", "current", " ", "j"}], 
         "=", 
         RowBox[{"\[ImaginaryI]", "[", 
          RowBox[{"N", ",", "H"}], "]"}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"ModifySystem", "[", 
         RowBox[{
          RowBox[{"MQSystem", "[", "data", "]"}], ",", 
          RowBox[{"Onsite", "\[Rule]", 
           RowBox[{"(", 
            RowBox[{"0", "&"}], ")"}]}], ",", 
          RowBox[{"Hopping", "\[Rule]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"-", "\[ImaginaryI]"}], " ", 
              RowBox[{"x", ".", 
               RowBox[{"(", 
                RowBox[{"#2", "-", "#1"}], ")"}]}]}], "&"}], ")"}]}], ",", 
          " ", 
          RowBox[{"Operation", "\[Rule]", "Times"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"x", ",", "unitvecs"}], "}"}]}], "]"}]}]}], "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQScatteringSystem", "[", "data__", "]"}], "[", 
    RowBox[{"zBloch__", "?", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"!", 
         RowBox[{"StringQ", "[", "#", "]"}]}], "&&", 
        RowBox[{
         RowBox[{"Head", "[", "#", "]"}], "=!=", "Rule"}], "&&", 
        RowBox[{
         RowBox[{"Head", "[", "#", "]"}], "=!=", "List"}]}], "&"}], ")"}]}], 
    "]"}], ":=", 
   RowBox[{
    RowBox[{"MQScatteringSystem", "[", "data", "]"}], "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<Central\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"#", "[", "zBloch", "]"}], "&"}], ")"}]}], ",", 
      RowBox[{"\"\<Leads\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"None", ",", "zBloch"}], "]"}], "&"}], "/@", "#"}], "&"}],
         ")"}]}], ",", 
      RowBox[{"\"\<Couplings\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"#", "[", "zBloch", "]"}], "&"}], "/@", "#"}], "&"}], 
        ")"}]}]}], "}"}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "Note", " ", "that", " ", "this", " ", "form", " ", "is", " ", "bound", 
    " ", "by", " ", "the", " ", "way", " ", "Bravais", " ", "vectors", " ", 
    "are", " ", "ordered", " ", "by", " ", "BuildScatteringSystem"}], "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQScatteringSystem", "[", "data__", "]"}], "[", 
   "\"\<NumberOfLeads\>\"", "]"}], ":=", 
  RowBox[{"Length", "@", 
   RowBox[{
    RowBox[{"MQScatteringSystem", "[", "data", "]"}], "[", "\"\<Leads\>\"", 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQScatteringSystem", "[", "data__", "]"}], "[", 
   "\"\<CentralSites\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"MQScatteringSystem", "[", "data", "]"}], "[", "\"\<Central\>\"", 
    "]"}], "[", "\"\<NumberOfSites\>\"", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQScatteringSystem", "[", "data__", "]"}], "[", 
   "\"\<SiteDimensions\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"MQScatteringSystem", "[", "data", "]"}], "[", "\"\<Central\>\"", 
    "]"}], "[", "\"\<SiteDimensions\>\"", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQScatteringSystem", "[", "data__", "]"}], "[", 
   "\"\<LeadSites\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"#", "[", "\"\<NumberOfSites\>\"", "]"}], "&"}], "/@", 
   RowBox[{
    RowBox[{"MQScatteringSystem", "[", "data", "]"}], "[", "\"\<Leads\>\"", 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQScatteringSystem", "[", "data__", "]"}], "[", 
    "\"\<Lattice\>\"", "]"}], ":=", 
   RowBox[{"Prepend", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"#", "[", "\"\<Lattice\>\"", "]"}], "&"}], "/@", 
      RowBox[{
       RowBox[{"MQScatteringSystem", "[", "data", "]"}], "[", "\"\<Leads\>\"",
        "]"}]}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"MQScatteringSystem", "[", "data", "]"}], "[", 
       "\"\<Central\>\"", "]"}], "[", "\"\<Lattice\>\"", "]"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQLeadSolution", "[", "data__", "]"}], "[", "\"\<PropModes\>\"", 
   "]"}], ":=", 
  RowBox[{"Length", "@", 
   RowBox[{
    RowBox[{"MQLeadSolution", "[", "data", "]"}], "[", "\"\<r0\>\"", 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQLeadSolution", "[", "data__", "]"}], "[", "\"\<SufaceSize\>\"",
     "]"}], ":=", 
   RowBox[{"Length", "@", 
    RowBox[{
     RowBox[{"MQLeadSolution", "[", "data", "]"}], "[", "\"\<gSurface\>\"", 
     "]"}]}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQSystemSolution", "[", "data__", "]"}], "[", 
   "\"\<CentralSize\>\"", "]"}], ":=", 
  RowBox[{"Length", "@", 
   RowBox[{
    RowBox[{"MQSystemSolution", "[", "data", "]"}], "[", "\"\<G\>\"", 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQSystemSolution", "[", "data__", "]"}], "[", "\"\<PropModes\>\"",
    "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"#", "[", "\"\<PropModes\>\"", "]"}], "&"}], "/@", 
   RowBox[{
    RowBox[{"MQSystemSolution", "[", "data", "]"}], "[", "\"\<Leads\>\"", 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSystemSolution", "[", "data__", "]"}], "[", 
    "\"\<NumberOfLeads\>\"", "]"}], ":=", 
   RowBox[{"Length", "@", 
    RowBox[{
     RowBox[{"MQSystemSolution", "[", "data", "]"}], "[", "\"\<Leads\>\"", 
     "]"}]}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQScatteringStates", "[", "data__", "]"}], "[", 
   "\"\<PropModes\>\"", "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{
     RowBox[{"First", "@", 
      RowBox[{"Dimensions", "[", "#", "]"}]}], "&"}], "/@", 
    RowBox[{
     RowBox[{"MQScatteringStates", "[", "data", "]"}], "[", 
     "\"\<CentralStates\>\"", "]"}]}], ")"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQScatteringStates", "[", "data__", "]"}], "[", 
    "\"\<NumberOfLeads\>\"", "]"}], ":=", 
   RowBox[{"Length", "@", 
    RowBox[{
     RowBox[{"MQScatteringStates", "[", "data", "]"}], "[", 
     "\"\<CentralStates\>\"", "]"}]}]}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"MQScatteringStates", "[", "data__", "]"}], "[", 
     "\"\<LeadCells\>\"", "]"}], ":=", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"#", "===", 
         RowBox[{"{", "}"}]}], ",", "None", ",", 
        RowBox[{
         RowBox[{"Dimensions", "[", "#", "]"}], "[", 
         RowBox[{"[", "3", "]"}], "]"}]}], "]"}], "&"}], "/@", 
     RowBox[{
      RowBox[{"MQScatteringStates", "[", "data", "]"}], "[", 
      "\"\<ScatteredStates\>\"", "]"}]}]}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQScatteringStates", "[", "data__", "]"}], "[", 
    "\"\<LeadCells\>\"", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"#", "===", 
        RowBox[{"{", "}"}]}], ",", "None", ",", 
       RowBox[{"Length", "/@", 
        RowBox[{"#", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "All"}], "]"}], "]"}]}]}], "]"}], "&"}], "/@", 
    RowBox[{
     RowBox[{"MQScatteringStates", "[", "data", "]"}], "[", 
     "\"\<ScatteredStates\>\"", "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQSpringMesh", "[", "data__", "]"}], "[", 
    "\"\<LatticeDimensions\>\"", "]"}], ":=", 
   RowBox[{"Length", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"MQSpringMesh", "[", "data", "]"}], "[", 
       "\"\<SpringConstants\>\"", "]"}], "[", "\"\<HBloch\>\"", "]"}], "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"MQSpringMesh", "[", "data__", "]"}], "[", 
     "\"\<NumberOfSites\>\"", "]"}], ":=", 
    RowBox[{"First", "@", 
     RowBox[{"Dimensions", "@", 
      RowBox[{
       RowBox[{
        RowBox[{"MQSpringMesh", "[", "data", "]"}], "[", 
        "\"\<SpringConstants\>\"", "]"}], "[", "\"\<H\>\"", "]"}]}]}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", 
    "\"\<LatticeDimensions\>\"", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", "\"\<System\>\"", 
      "]"}], "[", "\"\<Lattice\>\"", "]"}], "[", "\"\<LatticeDimensions\>\"", 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", 
   "\"\<NumberOfOuterSites\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{"Dimensions", "[", 
    RowBox[{
     RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", 
     "\"\<EvaluationMatrix\>\"", "]"}], "]"}], "[", 
   RowBox[{"[", "3", "]"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", 
   "\"\<NumberOfInnerSites\>\"", "]"}], ":=", 
  RowBox[{
   RowBox[{"Dimensions", "[", 
    RowBox[{
     RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", 
     "\"\<EvaluationMatrix\>\"", "]"}], "]"}], "[", 
   RowBox[{"[", "1", "]"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", 
    "\"\<EmbeddingDimensions\>\"", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", "\"\<System\>\"", 
      "]"}], "[", "\"\<Lattice\>\"", "]"}], "[", 
    "\"\<EmbeddingDimensions\>\"", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", 
    "\"\<GradientDimensions\>\"", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"Dimensions", "[", 
      RowBox[{
       RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", 
       "\"\<EvaluationMatrix\>\"", "]"}], "]"}], "[", 
     RowBox[{"[", "2", "]"}], "]"}], "+", "1"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", "\"\<InnerSites\>\"", 
   "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", "\"\<System\>\"", 
      "]"}], "[", "\"\<Lattice\>\"", "]"}], "[", "\"\<Sites\>\"", "]"}], "[", 
   
   RowBox[{"[", "1", "]"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", "\"\<OuterSites\>\"", 
   "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", "\"\<System\>\"", 
      "]"}], "[", "\"\<Lattice\>\"", "]"}], "[", "\"\<Sites\>\"", "]"}], "[", 
   
   RowBox[{"[", "2", "]"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", 
   "\"\<FieldDimensions\>\"", "]"}], ":=", 
  RowBox[{"Last", "@", 
   RowBox[{"Dimensions", "[", 
    RowBox[{
     RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", "\"\<Field\>\"", 
     "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", "\"\<FieldMatrix\>\"",
    "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", 
    "\"\<EvaluationMatrix\>\"", "]"}], "[", 
   RowBox[{"[", 
    RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MQGradientMesh", "[", "data__", "]"}], "[", 
    "\"\<GradientMatrix\>\"", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"MQGradientMesh", "[", "data", "]"}], "[", 
     "\"\<EvaluationMatrix\>\"", "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", 
      RowBox[{"2", ";;"}]}], "]"}], "]"}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"MQBandstructure", "[", "data__", "]"}], "[", 
     "\"\<NumberOfPoints\>\"", "]"}], ":=", 
    RowBox[{"Length", "@", 
     RowBox[{
      RowBox[{"MQBandstructure", "[", "data", "]"}], "[", "\"\<BandData\>\"", 
      "]"}]}]}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQBandstructure", "[", "data__", "]"}], "[", "\"\<Energies\>\"", 
   "]"}], ":=", 
  RowBox[{"Flatten", "@", 
   RowBox[{
    RowBox[{
     RowBox[{"MQBandstructure", "[", "data", "]"}], "[", "\"\<BandData\>\"", 
     "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MQBandstructure", "[", "data__", "]"}], "[", 
   "\"\<SiteDimensions\>\"", "]"}], ":=", 
  RowBox[{"Length", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"MQBandstructure", "[", "data", "]"}], "[", "\"\<BandData\>\"", 
     "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"1", ",", "3", ",", "1", ",", "1"}], "]"}], "]"}], 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.597634669184759*^9, 3.597634732325473*^9}, {
   3.597635064140338*^9, 3.597635067412614*^9}, {3.597669028856452*^9, 
   3.5976690484890547`*^9}, {3.5977387099612093`*^9, 3.597738842941285*^9}, {
   3.597738874045874*^9, 3.597738887942849*^9}, {3.5977389328960047`*^9, 
   3.5977390032632427`*^9}, {3.597739269201139*^9, 3.597739278299638*^9}, {
   3.597739308710738*^9, 3.5977393111933193`*^9}, {3.597739569250513*^9, 
   3.5977396739423227`*^9}, {3.597757340930146*^9, 3.597757364815166*^9}, {
   3.597765800339931*^9, 3.597765821187402*^9}, 3.597765854252985*^9, {
   3.597843502660433*^9, 3.597843562815116*^9}, {3.597843648643745*^9, 
   3.5978436697171926`*^9}, {3.597864310912405*^9, 3.597864350501925*^9}, {
   3.5978647126849613`*^9, 3.597864748095316*^9}, {3.5978650474941683`*^9, 
   3.5978650671843967`*^9}, 3.597865398483468*^9, 3.597865484691691*^9, {
   3.597942866387494*^9, 3.597943010741417*^9}, {3.598072669423594*^9, 
   3.598072768758068*^9}, {3.598072869122716*^9, 3.598072869824162*^9}, 
   3.598073007479456*^9, {3.598086844463759*^9, 3.598086892977591*^9}, {
   3.5980870198037777`*^9, 3.598087203033884*^9}, {3.598087253286007*^9, 
   3.598087345416363*^9}, {3.598087395680071*^9, 3.5980873974939547`*^9}, {
   3.598087466540112*^9, 3.598087484074692*^9}, {3.598087594837751*^9, 
   3.59808760037361*^9}, {3.598088414537951*^9, 3.598088451127553*^9}, {
   3.598088675495688*^9, 3.598088851704121*^9}, {3.5980889607447977`*^9, 
   3.5980889912083683`*^9}, {3.598089034390952*^9, 3.598089107190781*^9}, {
   3.598089144971362*^9, 3.598089200899681*^9}, {3.598089480209364*^9, 
   3.598089575544301*^9}, 3.5980897125804987`*^9, {3.598089776764285*^9, 
   3.598089821414069*^9}, {3.598090055439232*^9, 3.598090079854621*^9}, {
   3.59809016306463*^9, 3.598090296634432*^9}, 3.598090357777421*^9, {
   3.598090459548223*^9, 3.598090498031562*^9}, {3.5980905778729467`*^9, 
   3.598090594791265*^9}, {3.598092194510459*^9, 3.598092200086452*^9}, 
   3.598092243427655*^9, {3.598094405881181*^9, 3.5980944131160307`*^9}, {
   3.5981031747892933`*^9, 3.5981031819541693`*^9}, {3.598103396902286*^9, 
   3.5981034503141747`*^9}, {3.598103494366501*^9, 3.598103508980995*^9}, 
   3.598103625980246*^9, {3.5981037717546263`*^9, 3.598103791450554*^9}, {
   3.5981038314178457`*^9, 3.59810387263167*^9}, {3.598103944322551*^9, 
   3.598103996133773*^9}, {3.598104075706555*^9, 3.598104091513591*^9}, {
   3.5981041834350357`*^9, 3.598104212868082*^9}, {3.598104297756206*^9, 
   3.598104364870771*^9}, {3.598161943265552*^9, 3.598161950738886*^9}, {
   3.598162001472782*^9, 3.598162142057329*^9}, 3.5981621833652697`*^9, {
   3.5981622993724003`*^9, 3.598162350872835*^9}, {3.598162458267357*^9, 
   3.598162532388242*^9}, {3.5981633761426067`*^9, 3.598163433229639*^9}, {
   3.598163838603993*^9, 3.598163844199481*^9}, {3.5981638773603983`*^9, 
   3.598163883978339*^9}, {3.598163942984425*^9, 3.598163966754717*^9}, {
   3.5981819241084137`*^9, 3.598181928002453*^9}, {3.598194166092577*^9, 
   3.59819418501299*^9}, {3.5981943113580217`*^9, 3.598194358905254*^9}, {
   3.5981947349682817`*^9, 3.598194752332963*^9}, {3.598262181441971*^9, 
   3.598262216141004*^9}, {3.598269750518826*^9, 3.59826981247211*^9}, {
   3.598269895945861*^9, 3.59826993034155*^9}, {3.598269984986123*^9, 
   3.5982701647826366`*^9}, {3.598271091403678*^9, 3.5982710991090393`*^9}, {
   3.598352280706712*^9, 3.598352281265785*^9}, {3.598352427772315*^9, 
   3.598352457055784*^9}, {3.5987823016097107`*^9, 3.598782331287343*^9}, {
   3.59878238116674*^9, 3.598782381373495*^9}, {3.598782452531739*^9, 
   3.59878252286558*^9}, 3.5989417298241*^9, 3.599138994178215*^9, 
   3.599197696263035*^9, 3.599198169391981*^9, 3.599215337996254*^9, 
   3.603179414237262*^9, {3.6031928352459497`*^9, 3.60319287727346*^9}, {
   3.603192920731648*^9, 3.6031929397145042`*^9}, {3.603193370690073*^9, 
   3.603193461499305*^9}, {3.603193871512515*^9, 3.603193956000462*^9}, {
   3.6031941974479094`*^9, 3.603194227422003*^9}, {3.603194434462009*^9, 
   3.6031944399087677`*^9}, {3.6031944753636303`*^9, 3.603194499298683*^9}, {
   3.603534549199225*^9, 3.603534642284276*^9}, {3.6035346885868*^9, 
   3.603534705333988*^9}, {3.603534746622655*^9, 3.6035348152538652`*^9}, {
   3.603534845583791*^9, 3.603534868452951*^9}, {3.60353498724715*^9, 
   3.603535044417263*^9}, {3.603535699297655*^9, 3.603535700686215*^9}, {
   3.60353616979535*^9, 3.603536170302929*^9}, 3.603537916342855*^9, 
   3.603539143226602*^9, 3.60353924801789*^9, 3.614346195258279*^9, {
   3.622286421802252*^9, 3.6222864494178762`*^9}, {3.622286501310062*^9, 
   3.622286502671071*^9}, {3.62228653832806*^9, 3.6222865392144012`*^9}, 
   3.622286572205217*^9, {3.622286623271574*^9, 3.622286623743409*^9}, {
   3.622286943207492*^9, 3.622286961725658*^9}, {3.62228732073514*^9, 
   3.622287326812978*^9}, {3.6222873938111267`*^9, 3.622287394211258*^9}, {
   3.623483350873619*^9, 3.623483362704894*^9}, {3.623483531614814*^9, 
   3.623483549504567*^9}, {3.6234843328707027`*^9, 3.623484333716467*^9}, 
   3.6234848759986267`*^9, 3.623512085920726*^9, {3.6235127734593763`*^9, 
   3.623512803513998*^9}, {3.629641539061041*^9, 3.629641558171174*^9}, {
   3.629641750901411*^9, 3.62964175907638*^9}, {3.63091799690281*^9, 
   3.630918080643878*^9}, {3.6352360927465467`*^9, 3.635236092759802*^9}, {
   3.6358491943246107`*^9, 3.635849257863842*^9}, {3.636354448549806*^9, 
   3.6363544490520372`*^9}, {3.6363545140261087`*^9, 3.636354514699399*^9}, {
   3.6408525419860363`*^9, 3.640852572882516*^9}, {3.656822382213179*^9, 
   3.6568224343786173`*^9}, {3.656822467802526*^9, 3.656822565640493*^9}, {
   3.656822608165883*^9, 3.6568226516279984`*^9}, {3.656822764648198*^9, 
   3.6568228338215513`*^9}, {3.6568234585397587`*^9, 3.656823488444626*^9}, 
   3.6568237069649*^9, {3.6568277500116796`*^9, 3.656827766707588*^9}, {
   3.65682780124509*^9, 3.6568278234285393`*^9}, {3.656827896411787*^9, 
   3.6568278968022633`*^9}, {3.6568331047433767`*^9, 3.656833150492038*^9}, {
   3.656847041186593*^9, 3.656847055448781*^9}, 3.6568470880551033`*^9, {
   3.6569997677911673`*^9, 3.656999772403976*^9}, 3.656999803087255*^9, {
   3.656999837322543*^9, 3.656999890971992*^9}, {3.6569999295619164`*^9, 
   3.656999982264668*^9}, {3.657000013208881*^9, 3.657000062085823*^9}, {
   3.657002054909142*^9, 3.6570020804016457`*^9}, {3.657002114098241*^9, 
   3.657002140208947*^9}, {3.6570021840807667`*^9, 3.6570023093664227`*^9}, {
   3.657002350747643*^9, 3.657002393849677*^9}, {3.657014400019957*^9, 
   3.6570144703743877`*^9}, {3.6570146719981422`*^9, 3.657014705820438*^9}, {
   3.6570160577846737`*^9, 3.657016084664652*^9}, {3.657016499848097*^9, 
   3.6570165471934643`*^9}, {3.6570176138261423`*^9, 3.657017716788619*^9}, {
   3.6570177868061438`*^9, 3.657017841898521*^9}, 3.657017874605785*^9, 
   3.6592540813846188`*^9, {3.66590099298636*^9, 3.665901041515009*^9}, {
   3.665901535067478*^9, 3.665901632426568*^9}, {3.665902011592618*^9, 
   3.665902126065838*^9}, {3.665902740701079*^9, 3.665902783578874*^9}, {
   3.6659028625589333`*^9, 3.6659028635028753`*^9}, {3.665903042206555*^9, 
   3.6659030656677856`*^9}, {3.665903563700038*^9, 3.6659036037849894`*^9}, {
   3.665903648310791*^9, 3.665903783191231*^9}, {3.665903895547512*^9, 
   3.665903897011101*^9}, 3.665904008514859*^9, {3.665906628518804*^9, 
   3.665906677883059*^9}, {3.6659124293522253`*^9, 3.66591247685408*^9}, {
   3.6659128606306143`*^9, 3.665912945043342*^9}, {3.665912978130087*^9, 
   3.665912992894628*^9}, {3.665913184470414*^9, 3.665913207523675*^9}, {
   3.66591357945049*^9, 3.6659135809126587`*^9}, {3.665914677243404*^9, 
   3.665914713369667*^9}, {3.6659269535240593`*^9, 3.665926985595977*^9}, {
   3.6659272911437674`*^9, 3.665927388346719*^9}, {3.6659274412812443`*^9, 
   3.665927456455269*^9}, 3.665941243797098*^9, 3.665941275475832*^9, {
   3.665941430787373*^9, 3.665941462961583*^9}, {3.665941498697427*^9, 
   3.6659415013462973`*^9}, {3.665986930984273*^9, 3.6659869357878857`*^9}, {
   3.66598696714018*^9, 3.665986974801031*^9}, {3.665989562873081*^9, 
   3.665989571014565*^9}, {3.666006506233171*^9, 3.666006537549418*^9}, {
   3.6660065684696913`*^9, 3.666006573179839*^9}, {3.666596649080147*^9, 
   3.666596725004098*^9}, {3.66659753507276*^9, 3.666597543263831*^9}, {
   3.666598343723506*^9, 3.666598371361977*^9}, 3.6665986867644663`*^9, {
   3.666692380189486*^9, 3.666692413519359*^9}, {3.666790065666909*^9, 
   3.666790065679501*^9}, {3.666790341259609*^9, 3.666790341263698*^9}, {
   3.666847143345969*^9, 3.66684717216667*^9}, {3.667108828885325*^9, 
   3.6671088401315813`*^9}, {3.667109061559702*^9, 3.667109095585738*^9}, {
   3.714367314671152*^9, 3.7143673181901217`*^9}},
 CellLabel->"In[15]:=",ExpressionUUID->"39b9d71d-9652-40f2-a830-97087880be44"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"#", "::", "field"}], "=", "\[IndentingNewLine]", 
       RowBox[{"\"\<Unknown field `1`. \>\"", "~~", 
        RowBox[{"ToString", "[", "#", "]"}], "~~", "\"\< fields are \>\"", "~~", 
        RowBox[{"ToString", "@", 
         RowBox[{
          RowBox[{"MQFields", "[", "#", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}]}], ")"}], "&"}], "/@", 
    "MQStructures"}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"MQLattice", "::", "field"}], "=", "\[IndentingNewLine]", 
      RowBox[{"\"\<Unknown field `1`. MQLattice fields are \>\"", "~~", 
       RowBox[{"ToString", "@", 
        RowBox[{
         RowBox[{"MQFields", "[", "MQLattice", "]"}], "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}]}], ")"}], "~~", 
    "\"\<, plus {SiteNumber, FlatSites, Tags, LatticeDimensions} as \
additional methods.\>\""}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"(", 
    RowBox[{
     RowBox[{"MQSystem", "::", "field"}], "=", "\[IndentingNewLine]", 
     RowBox[{"\"\<Unknown field `1`. MQSystem fields are \>\"", "~~", 
      RowBox[{"ToString", "@", 
       RowBox[{
        RowBox[{"MQFields", "[", "MQSystem", "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}]}], ")"}], "~~", 
   "\"\<, plus {SiteDimensions, LatticeDimensions, SiteNumber} as additional \
methods.\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.5974022250286016`*^9, 3.597402290707677*^9}, {
   3.5974023306423483`*^9, 3.597402354853477*^9}, {3.597402395768174*^9, 
   3.597402397807403*^9}, {3.597402579733107*^9, 3.597402587471918*^9}, {
   3.597402908223627*^9, 3.597402914388503*^9}, {3.597579388404275*^9, 
   3.597579409749634*^9}, {3.597579462073608*^9, 3.5975794924778767`*^9}, {
   3.597634658393771*^9, 3.597634666057746*^9}, {3.5977374389803667`*^9, 
   3.597737531453368*^9}, {3.597738814820108*^9, 3.597738820648306*^9}, {
   3.597738896596465*^9, 3.597738926443849*^9}, {3.597739318607997*^9, 
   3.597739318762966*^9}, 3.597739394484729*^9, {3.597739608440353*^9, 
   3.597739613635985*^9}, {3.597739646131619*^9, 3.597739655009308*^9}, {
   3.5977396958831453`*^9, 3.597739699440715*^9}, {3.5977658725745907`*^9, 
   3.5977658752540627`*^9}, {3.5978280158216887`*^9, 3.597828028597267*^9}, 
   3.597865400485568*^9, 3.5978654936277122`*^9, {3.598333880801414*^9, 
   3.598333884657837*^9}, {3.614751742292953*^9, 3.6147517444519033`*^9}, {
   3.6296417595877647`*^9, 3.629641764811249*^9}},
 CellLabel->"In[64]:=",ExpressionUUID->"e84b6709-d5fa-4f77-a699-08f6ef79397f"],

Cell["General field read", "Text",
 CellChangeTimes->{{3.597828030700204*^9, 
  3.597828042620865*^9}},ExpressionUUID->"13fa215d-60c2-4633-bc2f-\
49050a3851a8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", "data__", "]"}], "[", "field_String", "]"}], ":=", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"MemberQ", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"MQFields", "[", "#", "]"}], "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", "field"}], "]"}], 
         ",", "\[IndentingNewLine]", 
         RowBox[{"field", "/.", 
          RowBox[{"{", "data", "}"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Message", "[", 
           RowBox[{
            RowBox[{"#", "::", "field"}], ",", "field"}], "]"}], ";", 
          RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}]}], ")"}], "&"}], 
    "/@", "MQStructures"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{"#", "[", "data__", "]"}], "[", 
       RowBox[{"{", "fields___String", "}"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"#", "[", "data", "]"}], "/@", 
       RowBox[{"{", "fields", "}"}]}]}], ")"}], "&"}], "/@", "MQStructures"}],
   ";"}]}], "Input",
 CellChangeTimes->{
  3.597828023320241*^9, {3.5978440668252277`*^9, 3.597844079881233*^9}, {
   3.597844246293075*^9, 3.5978442477236843`*^9}, {3.597849901632381*^9, 
   3.59784990622328*^9}, 3.5983339023998213`*^9, 3.614751745707753*^9, {
   3.629641765491803*^9, 3.629641766387342*^9}},
 CellLabel->"In[67]:=",ExpressionUUID->"33d7e375-cd5b-4ed3-aece-e4ef02c4a600"],

Cell["General field write", "Text",
 CellChangeTimes->{{3.597828051549758*^9, 
  3.597828055149892*^9}},ExpressionUUID->"2659125a-d7de-4605-8f61-\
fa147d957422"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{"#", "[", "data__", "]"}], "[", 
       RowBox[{"field_String", "->", "function_Function"}], "]"}], ":=", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"#", "[", "data", "]"}], "/.", 
       RowBox[{
        RowBox[{"Rule", "[", 
         RowBox[{"field", ",", "aux_"}], "]"}], "\[RuleDelayed]", 
        RowBox[{"Rule", "[", 
         RowBox[{"field", ",", 
          RowBox[{"function", "[", "aux", "]"}]}], "]"}]}]}]}], ")"}], "&"}], 
   "/@", "MQStructures"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", "data__", "]"}], "[", 
        RowBox[{"field_String", "\[Rule]", "value_"}], "]"}], ":=", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"#", "[", "data", "]"}], "/.", 
        RowBox[{
         RowBox[{"Rule", "[", 
          RowBox[{"field", ",", "aux_"}], "]"}], "\[RuleDelayed]", 
         RowBox[{"Rule", "[", 
          RowBox[{"field", ",", "value"}], "]"}]}]}]}], ")"}], "&"}], "/@", 
    "MQStructures"}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{"#", "[", "data__", "]"}], "[", 
       RowBox[{"{", "rules__Rule", "}"}], "]"}], ":=", "\[IndentingNewLine]", 
      
      RowBox[{
       RowBox[{"#", "[", "data", "]"}], "/.", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{
           RowBox[{"{", "rule", "}"}], ",", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Head", "@", 
               RowBox[{"Last", "@", "rule"}]}], "===", "Function"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Rule", "[", 
               RowBox[{
                RowBox[{"First", "@", "rule"}], ",", "aux_"}], "]"}], 
              "\[RuleDelayed]", 
              RowBox[{"Rule", "[", 
               RowBox[{
                RowBox[{"First", "@", "rule"}], ",", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Last", "@", "rule"}], ")"}], "[", "aux", "]"}]}], 
               "]"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Rule", "[", 
               RowBox[{
                RowBox[{"First", "@", "rule"}], ",", "_"}], "]"}], "->", 
              RowBox[{"Rule", "[", 
               RowBox[{
                RowBox[{"First", "@", "rule"}], ",", 
                RowBox[{"Last", "@", "rule"}]}], "]"}]}]}], "]"}]}], "]"}], "/@", 
         RowBox[{"{", "rules", "}"}]}], ")"}]}]}], ")"}], "&"}], "/@", 
   "MQStructures"}], ";"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.5978489853124943`*^9, 3.597849076935111*^9}, {
   3.59784932238406*^9, 3.5978493761564417`*^9}, {3.597849453154241*^9, 
   3.597849458281901*^9}, {3.597849529167323*^9, 3.597849571505026*^9}, {
   3.597849607283926*^9, 3.597849664599469*^9}, {3.59784976010247*^9, 
   3.597849826644553*^9}, {3.597866602438257*^9, 3.597866616763134*^9}, 
   3.5978666848945847`*^9, {3.597866804802566*^9, 3.5978668058731413`*^9}, {
   3.629641766915422*^9, 3.62964176788337*^9}},
 CellLabel->"In[69]:=",ExpressionUUID->"8d224c67-5561-40c7-9578-611e31830a81"],

Cell["Multiple address", "Text",
 CellChangeTimes->{{3.597844250315155*^9, 
  3.5978442523789873`*^9}},ExpressionUUID->"826f227b-c925-4e4b-bcf3-\
f164e73aa7e6"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{"#", "[", "data__", "]"}], "[", 
       RowBox[{"{", "fields___String", "}"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"#", "[", "data", "]"}], "/@", 
       RowBox[{"{", "fields", "}"}]}]}], ")"}], "&"}], "/@", "MQStructures"}],
   ";"}]], "Input",
 CellChangeTimes->{
  3.597844256285462*^9, {3.5978447832912083`*^9, 3.597844794235759*^9}, {
   3.5978489409515057`*^9, 3.597848942765209*^9}, 3.629641768387177*^9},
 CellLabel->"In[72]:=",ExpressionUUID->"d92dc094-b1e4-4ee3-b43f-d31edb8e25ad"],

Cell["Format specifications for data structures", "Text",
 CellChangeTimes->{{3.597391174139159*^9, 
  3.597391186243106*^9}},ExpressionUUID->"4c1fd15b-2847-444e-bea8-\
5233256cfd26"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Format", "[", "lattice_MQLattice", "]"}], ":=", 
   RowBox[{"\"\<MQLattice[<NumberOfSites=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"lattice", "[", "\"\<NumberOfSites\>\"", "]"}]}], "~~", 
    "\"\<, LatticeDimensions=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"lattice", "[", "\"\<LatticeDimensions\>\"", "]"}]}], "~~", 
    "\"\<, EmbeddingDimensions=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], "~~", 
    "\"\<>]\>\""}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Format", "[", "system_MQSystem", "]"}], ":=", 
   RowBox[{"\"\<MQSystem[<NumberOfSites=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"system", "[", "\"\<NumberOfSites\>\"", "]"}]}], "~~", 
    "\"\<, SiteDimensions=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"system", "[", "\"\<SiteDimensions\>\"", "]"}]}], "~~", 
    "\"\<, LatticeDimensions=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"system", "[", "\"\<LatticeDimensions\>\"", "]"}]}], "~~", 
    "\"\<>]\>\""}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Format", "[", "system_MQScatteringSystem", "]"}], ":=", 
   RowBox[{"\"\<MQScatteringSystem[<NumberOfLeads=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"system", "[", "\"\<NumberOfLeads\>\"", "]"}]}], "~~", 
    "\"\<, CentralSites=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"system", "[", "\"\<CentralSites\>\"", "]"}]}], "~~", 
    "\"\<, LeadSites=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"system", "[", "\"\<LeadSites\>\"", "]"}]}], "~~", 
    "\"\<, Nambu=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"system", "[", "\"\<Nambu\>\"", "]"}]}], "~~", "\"\<>]\>\""}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Format", "[", "solution_MQLeadSolution", "]"}], ":=", 
   RowBox[{"\"\<MQLeadSolution[<PropModes=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"solution", "[", "\"\<PropModes\>\"", "]"}]}], "~~", 
    "\"\<>]\>\""}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Format", "[", "solution_MQSystemSolution", "]"}], ":=", 
   RowBox[{"\"\<MQSystemSolution[<CentralSize=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"solution", "[", "\"\<CentralSize\>\"", "]"}]}], "~~", 
    "\"\<, PropModes=\>\"", "~~", 
    RowBox[{"ToString", "[", 
     RowBox[{"solution", "[", "\"\<PropModes\>\"", "]"}], "]"}], "~~", 
    "\"\<, Nambu=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"solution", "[", "\"\<Nambu\>\"", "]"}]}], "~~", 
    "\"\<>]\>\""}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Format", "[", "states_MQScatteringStates", "]"}], ":=", 
   RowBox[{"\"\<MQScatteringStates[<PropModes=\>\"", "~~", 
    RowBox[{"ToString", "[", 
     RowBox[{"states", "[", "\"\<PropModes\>\"", "]"}], "]"}], "~~", 
    "\"\<, NumberOfLeads=\>\"", "~~", 
    RowBox[{"ToString", "[", 
     RowBox[{"states", "[", "\"\<NumberOfLeads\>\"", "]"}], "]"}], "~~", 
    "\"\<, LeadCells=\>\"", "~~", 
    RowBox[{"ToString", "[", 
     RowBox[{"states", "[", "\"\<LeadCells\>\"", "]"}], "]"}], "~~", 
    "\"\<>]\>\""}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Format", "[", "mesh_MQSpringMesh", "]"}], ":=", 
   RowBox[{"\"\<MQSpringMesh[<NumberOfSites=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"mesh", "[", "\"\<NumberOfSites\>\"", "]"}]}], "~~", 
    "\"\<, MeshDimensions=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"mesh", "[", "\"\<LatticeDimensions\>\"", "]"}]}], "~~", 
    "\"\<>]\>\""}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Format", "[", "mesh_MQGradientMesh", "]"}], ":=", 
   RowBox[{"\"\<MQGradientMesh[<NumberOfInnerSites=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"mesh", "[", "\"\<NumberOfInnerSites\>\"", "]"}]}], "~~", 
    "\"\<, NumberOfOuterSites=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"mesh", "[", "\"\<NumberOfOuterSites\>\"", "]"}]}], "~~", 
    "\"\<, MeshDimensions=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"mesh", "[", "\"\<LatticeDimensions\>\"", "]"}]}], "~~", 
    "\"\<, GradientDimensions=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"mesh", "[", "\"\<GradientDimensions\>\"", "]"}]}], "~~", 
    "\"\<>]\>\""}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Format", "[", "bstruct_MQBandstructure", "]"}], ":=", 
   RowBox[{"\"\<MQBandstructure[<NumberOfPoints=\>\"", "~~", 
    RowBox[{"ToString", "@", 
     RowBox[{"bstruct", "[", "\"\<NumberOfPoints\>\"", "]"}]}], 
    RowBox[{"(*", 
     RowBox[{"~~", "\"\<, NumberOfOperators=\>\"", "~~", 
      RowBox[{"ToString", "@", 
       RowBox[{"bstruct", "[", "\"\<NumberOfOperators\>\"", "]"}]}]}], "*)"}],
     "~~", "\"\<>]\>\""}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Format", "[", "bandstr_MQBandstructure", "]"}], ":=", 
    RowBox[{"\"\<MGBandstructure[<NumberOfNodes=\>\"", "~~", 
     RowBox[{"ToString", "@", 
      RowBox[{"Length", "@", 
       RowBox[{"bandstr", "[", "\"\<Nodes\>\"", "]"}]}]}], "~~", 
     "\"\<>]\>\""}]}], "*)"}]}]}], "Input",
 CellChangeTimes->{{3.597389977612073*^9, 3.5973901158853407`*^9}, {
   3.597390155685006*^9, 3.5973901695647907`*^9}, {3.5973905089137983`*^9, 
   3.597390531059121*^9}, {3.597390673463419*^9, 3.597390674871435*^9}, {
   3.597390927380848*^9, 3.597390933868456*^9}, {3.5973910053340263`*^9, 
   3.597391027603641*^9}, {3.597398406362726*^9, 3.597398439009811*^9}, {
   3.597634934964575*^9, 3.597634940772463*^9}, 3.597634973254217*^9, {
   3.5977390487183037`*^9, 3.597739138410602*^9}, {3.597739170027072*^9, 
   3.5977392316420918`*^9}, {3.597739465399776*^9, 3.597739547708137*^9}, {
   3.597739661756138*^9, 3.597739670014914*^9}, {3.597739702614633*^9, 
   3.5977397037102213`*^9}, {3.597739858554669*^9, 3.597739864567767*^9}, 
   3.597757312208054*^9, {3.597943019804617*^9, 3.5979430610237827`*^9}, {
   3.598072871211564*^9, 3.5980728719131937`*^9}, {3.598072932135125*^9, 
   3.59807293696913*^9}, {3.598104268467901*^9, 3.598104291631957*^9}, {
   3.598104390627092*^9, 3.598104409149103*^9}, {3.598194141062882*^9, 
   3.598194145639249*^9}, {3.598194197970899*^9, 3.598194305736651*^9}, {
   3.598194349139676*^9, 3.5981943883683987`*^9}, 3.59819473289571*^9, {
   3.59878233903575*^9, 3.5987823487029037`*^9}, {3.598782424209415*^9, 
   3.598782429844298*^9}, {3.5987825384147882`*^9, 3.598782541868775*^9}, {
   3.603192750396861*^9, 3.603192757882567*^9}, {3.603194039189066*^9, 
   3.603194047125519*^9}, {3.603194083343025*^9, 3.603194098286024*^9}, {
   3.603194156676578*^9, 3.603194157876113*^9}, {3.603194235847378*^9, 
   3.6031943366926727`*^9}, {3.603194505517405*^9, 3.603194505804759*^9}, {
   3.629641768899935*^9, 3.629641773931157*^9}, {3.630917730147818*^9, 
   3.630917741746244*^9}, {3.630917787930575*^9, 3.6309178107052803`*^9}, {
   3.630917849973565*^9, 3.630917850788794*^9}, {3.630918119327829*^9, 
   3.6309181221748333`*^9}, {3.631514998311577*^9, 3.6315150096059847`*^9}, {
   3.644045178574408*^9, 3.6440452522201147`*^9}, 3.6568218494992857`*^9, {
   3.656822352917457*^9, 3.6568223585242987`*^9}, {3.656822864645481*^9, 
   3.656822901002475*^9}, 3.6568333182255163`*^9, {3.657014509780837*^9, 
   3.657014538963272*^9}, {3.665912344178916*^9, 3.665912374985406*^9}, {
   3.665912486404104*^9, 3.665912500834292*^9}, 3.6659127086370573`*^9, {
   3.665913605309355*^9, 3.665913610037578*^9}, {3.665917709803996*^9, 
   3.665917751676672*^9}, {3.665917925113311*^9, 3.665917925180655*^9}, 
   3.665941260470334*^9, {3.6659869935425253`*^9, 3.665987006184238*^9}, {
   3.6667900656876373`*^9, 3.66679006568993*^9}, {3.666790191757246*^9, 
   3.666790217812711*^9}, 3.666792549710869*^9},
 CellLabel->"In[73]:=",ExpressionUUID->"3fcf4910-a7e4-4fcb-a591-834618a46ba8"],

Cell["Messages", "Text",
 CellChangeTimes->{{3.637392827505251*^9, 
  3.637392828729451*^9}},ExpressionUUID->"949a1acf-3e2c-4d9f-aee1-\
e7bcd35a3745"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MQSystem", "::", "missinglat"}], "=", 
   "\"\<Lattice not embedded in MQSystem.\>\""}], ";"}]], "Input",
 CellLabel->"In[82]:=",ExpressionUUID->"3c46dbd2-5d8c-4e6f-9456-ae2d5d7822d1"]
}, Closed]],

Cell[CellGroupData[{

Cell["Auxiliary functions", "Subsection",
 CellChangeTimes->{{3.597634321866617*^9, 
  3.5976343298198147`*^9}},ExpressionUUID->"cadafcae-da97-4dae-a418-\
75e5f6390aa7"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"IsValidSitesQ", "[", 
    RowBox[{"{", "sites__", "}"}], "]"}], ":=", 
   RowBox[{"MatrixQ", "[", 
    RowBox[{
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{"{", "sites", "}"}], ",", "1"}], "]"}], ",", "NumericQ"}], 
    "]"}]}], ";"}]], "Input",
 CellLabel->"In[83]:=",ExpressionUUID->"927a4088-71c5-4999-8800-276edb84f787"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ExpandDimensions", "::", "dim"}], "=", 
   "\"\<New dimensions `1` smaller than original dimensions `2`\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandDimensions", "[", 
    RowBox[{"lattice_MQLattice", ",", " ", "newdim_Integer"}], "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{"newdim", "<", 
      RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"ExpandDimensions", "::", "dim"}], ",", "newdim", ",", " ", 
        RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], "]"}],
       ";", 
      RowBox[{"Return", "[", "lattice", "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{"lattice", "[", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"\"\<Sites\>\"", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"PadRight", "[", 
               RowBox[{"#", ",", "newdim"}], "]"}], "&"}], ",", "#", ",", 
             RowBox[{"{", "2", "}"}]}], "]"}], "&"}], ")"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"PadRight", "[", 
               RowBox[{"#", ",", "newdim"}], "]"}], "&"}], ",", "#"}], "]"}], 
           "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<EmbeddingDimensions\>\"", "->", "newdim"}]}], "}"}], 
      "]"}]}], "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MoveLattice", "::", "dim"}], " ", "=", " ", 
   "\"\<Displacement dimensions `1` different from embedding dimensions `2`\>\
\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MoveLattice", "[", 
    RowBox[{"lattice_MQLattice", ",", 
     RowBox[{"displacement_", "/;", 
      RowBox[{"VectorQ", "[", 
       RowBox[{"displacement", ",", "NumericQ"}], "]"}]}]}], "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Length", "[", "displacement", "]"}], "!=", 
      RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"MoveLattice", "::", "dim"}], ",", 
        RowBox[{"Length", "@", "displacement"}], ",", " ", 
        RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], "]"}],
       ";", 
      RowBox[{"Return", "[", "lattice", "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{"lattice", "[", 
      RowBox[{"\"\<Sites\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "+", "displacement"}], "&"}], ",", "#", ",", 
           RowBox[{"{", "2", "}"}]}], "]"}], "&"}], ")"}]}], "]"}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MoveLatticeBravais", "::", "dim"}], " ", "=", " ", 
   "\"\<Displacement dimensions `1` different from lattice dimensions \
`2`\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MoveLatticeBravais", "[", 
    RowBox[{"lattice_MQLattice", ",", 
     RowBox[{"displacement_", "/;", 
      RowBox[{"VectorQ", "[", 
       RowBox[{"displacement", ",", "NumericQ"}], "]"}]}]}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Length", "@", "displacement"}], "\[Equal]", 
      RowBox[{"Length", "@", 
       RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"MoveLattice", "[", 
      RowBox[{"lattice", ",", 
       RowBox[{"displacement", ".", 
        RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}]}], "]"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"MoveLatticeBravais", "::", "dim"}], ",", 
        RowBox[{"Length", "@", "displacement"}], ",", " ", 
        RowBox[{"Length", "@", 
         RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}]}], "]"}], 
      ";", 
      RowBox[{"Return", "[", "lattice", "]"}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"OrthogonalToAxis", "[", 
    RowBox[{"r_List", ",", "axis_List"}], "]"}], "=", 
   RowBox[{"r", "-", 
    RowBox[{"axis", 
     FractionBox[
      RowBox[{"r", ".", "axis"}], 
      RowBox[{"axis", ".", "axis"}]]}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.5976363556167507`*^9, 3.597636378121664*^9}, {
  3.59764456864704*^9, 3.59764462841735*^9}, {3.597646578419138*^9, 
  3.597646707673361*^9}, {3.597650829124133*^9, 3.597650913453018*^9}, {
  3.597650974593691*^9, 3.597651025443343*^9}, {3.597739722710681*^9, 
  3.597739760069035*^9}, {3.597774667389875*^9, 3.597774683418852*^9}, {
  3.5977748095377617`*^9, 3.597774810066863*^9}, {3.597844003737522*^9, 
  3.5978440099140244`*^9}, {3.5978499435104923`*^9, 3.597850052045732*^9}, {
  3.597850110931551*^9, 3.5978501310988007`*^9}, {3.597850383668524*^9, 
  3.5978504394716*^9}, {3.597850847027858*^9, 3.597850927489132*^9}, {
  3.629641774379925*^9, 3.62964177685982*^9}},
 CellLabel->"In[84]:=",ExpressionUUID->"0fa73d88-9b6b-4a6b-bfe7-a19306b47aec"],

Cell["If there are repeated tags, merge sublattices", "Text",
 CellChangeTimes->{{3.6035350635871687`*^9, 
  3.6035350720178547`*^9}},ExpressionUUID->"a687a2a7-05d0-4a9a-9e6a-\
04704ad8e12f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FlattenTags", "[", "lattice_MQLattice", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "oldtags", ",", "oldsublats", ",", "newsublats", ",", "newtags", ",", 
      " ", "aux", ",", " ", "newlat"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"oldtags", "=", 
      RowBox[{"lattice", "[", "\"\<Tags\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"oldsublats", "=", 
      RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"aux", "=", 
      RowBox[{"Gather", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"oldtags", ",", "oldsublats"}], "}"}], "\[Transpose]"}], 
        ",", 
        RowBox[{
         RowBox[{
          RowBox[{"#1", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
          RowBox[{"#2", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "&"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"newtags", "=", 
      RowBox[{"aux", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1", ",", "1"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"newsublats", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{"#", ",", "1"}], "]"}], "&"}], "/@", 
       RowBox[{"aux", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"newlat", "=", 
      RowBox[{"lattice", "[", 
       RowBox[{"\"\<Sites\>\"", "\[Rule]", "newsublats"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"newlat", "=", 
      RowBox[{"newlat", "[", 
       RowBox[{"\"\<Tags\>\"", "\[Rule]", "newtags"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "newlat"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.6035350737779837`*^9, 3.6035350787698917`*^9}, {
   3.603535135397995*^9, 3.603535232968093*^9}, {3.603535348912434*^9, 
   3.603535406196134*^9}, {3.603535478208246*^9, 3.6035356418131933`*^9}, {
   3.603535719456656*^9, 3.603535720572155*^9}, {3.6035362678128977`*^9, 
   3.603536384115157*^9}, 3.603536426058402*^9, 3.6296417774992657`*^9},
 CellLabel->"In[91]:=",ExpressionUUID->"c5eaeced-f0d1-4e2d-9a45-2a8b38ec7135"],

Cell["\<\
Routines for shell-fill of boolean regions, starting from a seed, in 1D, 2D \
and 3D\
\>", "Text",
 CellChangeTimes->{{3.5975655836629963`*^9, 
  3.5975656182570763`*^9}},ExpressionUUID->"35bd862e-d0ac-41b9-830a-\
878f5ce4090a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"$MaxShellFillIterations", "=", "3000"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ShellFill", "::", "iter"}], "=", 
   "\"\<Maximum number of iterations $MaxShellFillIterations = `1` exceeded\>\
\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ShellFill", "::", "seed"}], "=", 
   "\"\<Seed `1` is invalid. Try specifying a Seed->'position in space' \
explicitly in Builder option (Bounded or Reshape).\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ShellFill", "::", "out"}], "=", 
   "\"\<The provided seed corresponds to sites at positions `1`, non of them \
within the specified region.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ShellFill", "::", "notfound"}], "=", 
   "\"\<Could not find seed automatically.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ShellFill", "::", "nobravais"}], "=", 
    "\"\<Lattice has no Bravais vectors. Shell-filling is not \
possible.\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ShellFill", "[", 
   RowBox[{
   "latdim_Integer", ",", "fillregion_Function", ",", "unitcellsites_List", 
    ",", "brvectors_List", ",", "fillseed_"}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"sites", ",", "shell", ",", " ", "sitepositions", ",", 
      RowBox[{"n", "=", "0"}], ",", "nvars", ",", " ", "nv", ",", 
      "integerseed", ",", 
      RowBox[{"searchsites", "=", "8"}]}], "}"}], ",", "\[IndentingNewLine]", 
    
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"brvectors", "\[Equal]", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"ShellFill", "::", "nobravais"}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"fillseed", "===", "Automatic"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"nvars", "=", 
         RowBox[{
          RowBox[{
           SubscriptBox["nv", "#"], "&"}], "/@", 
          RowBox[{"Range", "[", "latdim", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "Find", " ", "a", " ", "unit", " ", "cell", " ", "with", " ", "at", 
          " ", "least", " ", "one", " ", "site", " ", "within", " ", 
          RowBox[{"fillregion", ".", " ", "Use"}], " ", "only", " ", "a", " ",
           "small", " ", "sample", " ", "of", " ", "sites"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"searchsites", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "@", "#"}], ">", "searchsites"}], ",", 
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"1", ";;", "searchsites"}], "]"}], "]"}], ",", "#"}], 
            "]"}], "&"}], "@", 
          RowBox[{"Flatten", "[", 
           RowBox[{"unitcellsites", ",", "1"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"integerseed", "=", 
         RowBox[{"FindInstance", "[", 
          RowBox[{
           RowBox[{"Or", "@@", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"fillregion", "[", 
                RowBox[{
                 RowBox[{"nvars", ".", "brvectors"}], "+", "#"}], "]"}], 
               "&"}], "/@", "searchsites"}], ")"}]}], ",", "nvars", ",", " ", 
           "Integers"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"integerseed", "===", 
           RowBox[{"{", "}"}]}], ",", " ", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{"ShellFill", "::", "notfound"}], "]"}], ";", 
           RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"integerseed", "=", 
         RowBox[{"nvars", "/.", 
          RowBox[{"First", "@", "integerseed"}]}]}]}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Find", " ", "an", " ", "integer", " ", "vector", " ", "that", " ", 
         "gives", " ", "a", " ", "seed", " ", "as", " ", "close", " ", "as", 
         " ", "possible", " ", "to", " ", "fillseed"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"integerseed", "=", 
         RowBox[{"Round", "[", 
          RowBox[{"fillseed", ".", 
           RowBox[{"PseudoInverse", "[", "brvectors", "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"seed", "=", 
           RowBox[{
            RowBox[{"Round", "[", 
             RowBox[{"fillseed", ".", 
              RowBox[{"PseudoInverse", "[", "brvectors", "]"}]}], "]"}], ".", 
            "brvectors"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"!", 
           RowBox[{"(", 
            RowBox[{"Or", "@@", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"fillregion", "[", 
                 RowBox[{
                  RowBox[{"integerseed", ".", "brvectors"}], "+", "#"}], 
                 "]"}], "&"}], "/@", 
               RowBox[{"Flatten", "[", 
                RowBox[{"unitcellsites", ",", "1"}], "]"}]}], ")"}]}], 
            ")"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{
             RowBox[{"ShellFill", "::", "out"}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"integerseed", ".", "brvectors"}], "+", "#"}], "&"}], 
              "/@", 
              RowBox[{"Flatten", "[", 
               RowBox[{"unitcellsites", ",", "1"}], "]"}]}]}], "]"}], ";", 
           RowBox[{"Abort", "[", "]"}]}]}], "]"}]}]}], "\[IndentingNewLine]", 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"VectorQ", "[", 
           RowBox[{"integerseed", ",", "IntegerQ"}], "]"}], "&&", 
          RowBox[{
           RowBox[{"Length", "@", "integerseed"}], "\[Equal]", "latdim"}]}], 
         ")"}]}], ",", 
       RowBox[{"Message", "[", 
        RowBox[{
         RowBox[{"ShellFill", "::", "seed"}], ",", "integerseed"}], "]"}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"shell", "[", "_", "]"}], "[", "0", "]"}], "=", 
      RowBox[{"{", "integerseed", "}"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"shell", "[", "1", "]"}], "[", "n_", "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"integerseed", "+", "#"}], "&"}], "/@", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"-", "n"}], "}"}], ",", 
         RowBox[{"{", "n", "}"}]}], "}"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"shell", "[", "2", "]"}], "[", "n_", "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"integerseed", "+", "#"}], "&"}], "/@", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"-", "n"}], ",", 
               RowBox[{"-", "#"}]}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"n", ",", "#"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"#", ",", 
               RowBox[{"-", "n"}]}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"-", "#"}], ",", "n"}], "}"}]}], "}"}], "&"}], "/@", 
          RowBox[{"Range", "[", 
           RowBox[{
            RowBox[{"-", "n"}], ",", 
            RowBox[{"n", "-", "1"}]}], "]"}]}], ",", "1"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"shell", "[", "3", "]"}], "[", "n_", "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"integerseed", "+", "#"}], "&"}], "/@", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", 
                   RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ",", "n"}], "}"}], ",", 
                 RowBox[{"-", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ",", "n"}], "}"}]}], ",", 
                 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"-", "n"}], ",", 
                   RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ",", 
                   RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "}"}], ",", 
                 RowBox[{"-", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"-", "n"}], ",", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ",", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}]}], "}"}], "&"}],
               "/@", 
              RowBox[{"Flatten", "[", 
               RowBox[{"#", ",", "1"}], "]"}]}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", "n", ",", 
                   RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", 
                 RowBox[{"-", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", "n", ",", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}]}], "}"}], "&"}],
               "/@", 
              RowBox[{"Flatten", "[", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{
                   RowBox[{"2", ";;"}], ",", 
                   RowBox[{"2", ";;", 
                    RowBox[{"-", "2"}]}]}], "]"}], "]"}], ",", "1"}], 
               "]"}]}]}], "}"}], "&"}], "@", 
          RowBox[{"Outer", "[", 
           RowBox[{"List", ",", 
            RowBox[{"Range", "[", 
             RowBox[{
              RowBox[{"-", "n"}], ",", 
              RowBox[{"n", "-", "1"}]}], "]"}], ",", 
            RowBox[{"Range", "[", 
             RowBox[{
              RowBox[{"-", "n"}], ",", "n"}], "]"}]}], "]"}]}], ",", "2"}], 
        "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Generate", " ", "groups"}], ",", " ", 
       RowBox[{"one", " ", "per", " ", "tag"}], ",", " ", 
       RowBox[{
       "with", " ", "positions", " ", "of", " ", "sites", " ", "at", " ", 
        "each", " ", "point", " ", "in", " ", "a", " ", "shell"}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"sitepositions", "[", "nv_", "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{"Outer", "[", 
           RowBox[{"Plus", ",", 
            RowBox[{"nv", ".", "brvectors"}], ",", "#", ",", "1"}], "]"}], 
          ",", "1"}], "]"}], "&"}], "/@", "unitcellsites"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Sow", " ", "all", " ", "groups", " ", "of", " ", "positions", " ", 
        "in", " ", "region"}], ",", " ", 
       RowBox[{
       "using", " ", "growing", " ", "shells", " ", "untill", " ", "max", " ",
         "shell", " ", "is", " ", "reached"}], ",", " ", 
       RowBox[{
       "or", " ", "no", " ", "position", " ", "in", " ", "region", " ", "is", 
        " ", 
        RowBox[{"found", ".", " ", "Untangle"}], " ", 
        RowBox[{"Reap", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"sites", "=", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Flatten", "[", 
           RowBox[{"#", ",", "1"}], "]"}], "&"}], "/@", 
         RowBox[{"Transpose", "[", 
          RowBox[{"Flatten", "[", 
           RowBox[{"#", ",", "1"}], "]"}], "]"}]}], "&"}], "@", 
       RowBox[{"Last", "@", 
        RowBox[{"Reap", "@", 
         RowBox[{"While", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Length", "@", 
               RowBox[{"Flatten", "@", 
                RowBox[{"Sow", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Select", "[", 
                    RowBox[{"#", ",", "fillregion"}], "]"}], "&"}], "/@", 
                  RowBox[{"sitepositions", "[", 
                   RowBox[{
                    RowBox[{"shell", "[", "latdim", "]"}], "[", "n", "]"}], 
                   "]"}]}], "]"}]}]}], "\[NotEqual]", "0"}], ")"}], " ", "&&", 
            RowBox[{"n", "<=", "$MaxShellFillIterations"}]}], ",", " ", 
           RowBox[{"n", "++"}]}], "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"n", ">", "$MaxShellFillIterations"}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"ShellFill", "::", "iter"}], ",", 
          "$MaxShellFillIterations"}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"Sort", "/@", "sites"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.597630994395503*^9, 3.597631030476788*^9}, {
   3.5976310737037*^9, 3.5976310973305063`*^9}, {3.5976314302094*^9, 
   3.597631433475127*^9}, {3.59763149475289*^9, 3.597631527287476*^9}, {
   3.597631672525063*^9, 3.597631685827302*^9}, {3.5976317306317472`*^9, 
   3.597631735192409*^9}, {3.59763178553013*^9, 3.597631793156069*^9}, {
   3.597631844414357*^9, 3.5976319010896997`*^9}, {3.5976319413006268`*^9, 
   3.597631957917099*^9}, {3.5976320287473087`*^9, 3.597632035515417*^9}, 
   3.597632070749814*^9, {3.59763210455978*^9, 3.597632119680584*^9}, 
   3.5976323337936993`*^9, {3.597632394616136*^9, 3.597632398833606*^9}, {
   3.597632443199562*^9, 3.597632653021793*^9}, {3.597641080458537*^9, 
   3.5976411017956047`*^9}, {3.597641141334963*^9, 3.597641142167796*^9}, {
   3.5976411784683523`*^9, 3.597641185321375*^9}, {3.597641245417169*^9, 
   3.597641279704835*^9}, 3.597641781434607*^9, {3.597649789155384*^9, 
   3.597649798564107*^9}, {3.597649957275485*^9, 3.597649993424738*^9}, {
   3.597650029996111*^9, 3.5976500305711727`*^9}, {3.597651554212863*^9, 
   3.5976516767982903`*^9}, {3.597651718449341*^9, 3.597651718607911*^9}, {
   3.597652656927841*^9, 3.5976526603217163`*^9}, {3.597653012858685*^9, 
   3.597653024713407*^9}, {3.5976531503141737`*^9, 3.597653153210182*^9}, {
   3.5976533920818043`*^9, 3.597653433765875*^9}, {3.597653529317173*^9, 
   3.5976535330603333`*^9}, {3.597653569315777*^9, 3.5976536059693003`*^9}, {
   3.597755214438346*^9, 3.597755306427177*^9}, {3.5977753511353817`*^9, 
   3.5977753523447113`*^9}, {3.5978510168938007`*^9, 3.597851123155348*^9}, {
   3.598177252676969*^9, 3.598177253618701*^9}, {3.598342404872643*^9, 
   3.598342420596401*^9}, {3.5983425616741657`*^9, 3.598342623037045*^9}, {
   3.598342660749221*^9, 3.5983427373153267`*^9}, {3.5983427937595797`*^9, 
   3.5983428278969584`*^9}, {3.598353031738448*^9, 3.5983530405946217`*^9}, 
   3.5983530748236322`*^9, {3.5983532531545486`*^9, 3.59835329945222*^9}, {
   3.5983534347665157`*^9, 3.598353485757661*^9}, {3.598353533037548*^9, 
   3.598353536811583*^9}, {3.598353615004277*^9, 3.598353661589983*^9}, {
   3.5983537134735622`*^9, 3.59835371536159*^9}, {3.602480237212926*^9, 
   3.602480241908143*^9}, {3.602480411275618*^9, 3.602480452440448*^9}, {
   3.602480493804372*^9, 3.6024804948960037`*^9}, {3.602480598693574*^9, 
   3.602480754099972*^9}, {3.6024807901517277`*^9, 3.6024808572707644`*^9}, 
   3.6024809142462063`*^9, {3.602480995178302*^9, 3.60248100663971*^9}, {
   3.60248106260501*^9, 3.602481102908536*^9}, {3.60248113483253*^9, 
   3.602481193220042*^9}, {3.602481309596717*^9, 3.602481311169694*^9}, {
   3.602481414708818*^9, 3.602481444366921*^9}, {3.602481489713067*^9, 
   3.602481517460802*^9}, {3.60776124543718*^9, 3.607761312948504*^9}, 
   3.6077613647076883`*^9, {3.6077614275864363`*^9, 3.607761559511499*^9}, {
   3.6077616158521633`*^9, 3.607761628291768*^9}, 3.615206868970133*^9, {
   3.624548164852478*^9, 3.624548169049542*^9}, {3.682075458985189*^9, 
   3.6820754993655357`*^9}},
 CellLabel->"In[92]:=",ExpressionUUID->"0f88713a-584d-4320-a469-4f0af8f4bdb7"],

Cell["\<\
Flattening array rules. A set of rules of the form {i,j}->_Matrix is first \
transfomed into {i,j}->ArrayRules[Matrix], and then, if the \
Arrayrules[Matrix] is not empty, this is transformed (by a MapAt[Join...]) \
into {i,j,k,l}->val, ready for ArrayFlatten
The second method is slightly faster.\
\>", "Text",
 CellChangeTimes->{{3.597672103612356*^9, 3.59767213382889*^9}, {
  3.597673803448762*^9, 3.597673899239244*^9}, {3.597676368546261*^9, 
  3.597676404765568*^9}},ExpressionUUID->"930df3c4-a4a5-49a7-95d7-\
142f7cf98b57"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"FlattenRules", "[", "rules_", "]"}], ":=", 
  RowBox[{"Flatten", "[", 
   RowBox[{
    RowBox[{"Function", "[", 
     RowBox[{
      RowBox[{"{", "rule", "}"}], ",", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", "=!=", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"MapAt", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Join", "[", 
              RowBox[{
               RowBox[{"First", "@", "rule"}], ",", "#"}], "]"}], "&"}], ",", 
            "#", ",", 
            RowBox[{"{", 
             RowBox[{"All", ",", "1"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", "}"}]}], "]"}], "&"}], "[", 
       RowBox[{"Most", "@", 
        RowBox[{"ArrayRules", "[", 
         RowBox[{"Last", "@", "rule"}], "]"}]}], "]"}]}], "]"}], "/@", 
    "rules"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FlattenRules", "[", "rules_", "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"rules", "\[NotEqual]", 
      RowBox[{"{", "}"}]}], "&&", 
     RowBox[{
      RowBox[{"Head", "[", 
       RowBox[{"rules", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}], "===", "List"}]}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"Flatten", "[", 
       RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"i", ",", "newrules"}], "}"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Join", "[", 
             RowBox[{"i", ",", 
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "\[Rule]", 
            RowBox[{"#", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], "&"}], "/@", "newrules"}]}], 
        "]"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"rules", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Most", "@", 
            RowBox[{"ArrayRules", "[", "#", "]"}]}], "&"}], "/@", 
          RowBox[{"rules", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "}"}]}], "]"}]}], 
    ",", "rules"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.597672120462681*^9, 3.5976721204641333`*^9}, {
   3.597673795043432*^9, 3.5976738015542994`*^9}, 3.597673906034869*^9, {
   3.597674121176848*^9, 3.5976741266737843`*^9}, 3.597676495285556*^9, {
   3.620453477339119*^9, 3.620453484396027*^9}, {3.620455561929793*^9, 
   3.620455575876892*^9}, {3.620455610131727*^9, 3.620455612515259*^9}},
 CellLabel->"In[99]:=",ExpressionUUID->"4e19fb14-b081-42d0-9b95-0f1108ffab65"],

Cell["\<\
Compute the reordering of the Bravias vectors of the lead by aligning them \
with the ones of the central system. The transport vector is set to be the \
first one. If any of the leads are not compatible with the central system, it \
aborts.\
\>", "Text",
 CellChangeTimes->{{3.597932849205723*^9, 3.597932892866304*^9}, {
  3.597932947327342*^9, 3.597932953941655*^9}, {3.597933116547009*^9, 
  3.5979331201604843`*^9}, {3.5979332622359*^9, 3.5979333504550743`*^9}, {
  3.597936139245846*^9, 
  3.597936198104672*^9}},ExpressionUUID->"67db5dde-49af-4db9-a5d0-\
3efd5f54f483"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"BravaisVectorOrdering", "::", "dim"}], "=", 
   "\"\<Dimensions of all leads should equal the dimensions of the system \
minus one.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BravaisVectorOrdering", "::", "incompatible"}], "=", 
   "\"\<Bravais vectors of one of the leads `1` incompatible with those of \
the central system `2`\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BravaisVectorOrdering", "[", 
    RowBox[{"central_MQLattice", ",", 
     RowBox[{"{", "leads__MQLattice", "}"}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"brcentral", "=", 
        RowBox[{"central", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"brleads", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"#", "[", "\"\<BravaisVectors\>\"", "]"}], "&"}], "/@", 
         RowBox[{"{", "leads", "}"}]}]}], ",", " ", "\[IndentingNewLine]", 
       "orders", ",", "reorderings", ",", " ", "equalvectorsQ"}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"Or", "@@", 
         RowBox[{"Thread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "@", "brcentral"}], "+", "1"}], "\[NotEqual]", 
           RowBox[{"Length", "/@", "brleads"}]}], "]"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"BravaisVectorOrdering", "::", "dim"}], "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "@", "brcentral"}], "\[Equal]", "0"}], ",", 
        RowBox[{"Return", "[", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{
           RowBox[{"{", "1", "}"}], ",", 
           RowBox[{"Length", "[", 
            RowBox[{"{", "leads", "}"}], "]"}]}], "]"}], "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"equalvectorsQ", "[", 
        RowBox[{"c_", ",", "l_"}], "]"}], ":=", 
       RowBox[{
        FractionBox[
         RowBox[{"Norm", "[", 
          RowBox[{"Flatten", "[", 
           RowBox[{"c", "-", 
            RowBox[{"Rest", "@", "l"}]}], "]"}], "]"}], 
         SqrtBox[
          RowBox[{
           RowBox[{"Norm", "[", "c", "]"}], 
           RowBox[{"Norm", "[", 
            RowBox[{"Rest", "@", "l"}], "]"}]}]]], "<", 
        SuperscriptBox["10", 
         RowBox[{"-", "6"}]]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"orders", "=", 
       RowBox[{"Permutations", "[", 
        RowBox[{"Range", "[", 
         RowBox[{
          RowBox[{"Length", "@", "brcentral"}], "+", "1"}], "]"}], "]"}]}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"reorderings", "=", 
       RowBox[{"First", "/@", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"#", "===", 
               RowBox[{"{", "}"}]}], ",", 
              RowBox[{
               RowBox[{"Message", "[", 
                RowBox[{
                 RowBox[{"BravaisVectorOrdering", "::", "incompatible"}], ",", 
                 RowBox[{"brleads", "[", 
                  RowBox[{"[", "i", "]"}], "]"}], ",", "brcentral"}], "]"}], 
               ";", 
               RowBox[{"Abort", "[", "]"}]}], ",", "#"}], "]"}], "&"}], "@", 
           RowBox[{"Select", "[", 
            RowBox[{"orders", ",", 
             RowBox[{
              RowBox[{"equalvectorsQ", "[", 
               RowBox[{"brcentral", ",", 
                RowBox[{"brleads", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "#"}], "]"}], "]"}]}], "]"}], "&"}], ",", 
             "1"}], "]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "@", "brleads"}]}], "}"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "reorderings"}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ReorderBravaisVectors", "::", "dim"}], "=", 
   "\"\<Ordering `1` is incompatible with lattice dimensions `2`.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ReorderBravaisVectors", "[", 
   RowBox[{"lat_MQLattice", ",", 
    RowBox[{"ordering_", "?", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"VectorQ", "[", 
        RowBox[{"#", ",", "IntegerQ"}], "]"}], "&"}], ")"}]}]}], "]"}], ":=", 
  
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"lat", "[", "\"\<LatticeDimensions\>\"", "]"}], "\[Equal]", 
     RowBox[{"Length", "@", "ordering"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"lat", "[", 
     RowBox[{"\"\<BravaisVectors\>\"", "->", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "ordering", "]"}], "]"}], "&"}], ")"}]}], "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"ReorderBravaisVectors", "::", "dim"}], ",", " ", "ordering", 
      ",", 
      RowBox[{"lat", "[", "\"\<LatticeDimensions\>\"", "]"}]}], "]"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->CompressedData["
1:eJxTTMoPSmViYGAQBWIQve+Ni0nzuVeOepdXWYDob4ZH3UD0E2F5bxBd5Gwd
A6IXaF6LBdEac/pSQbRHd2IBiD7FajwRRD/t+jgTRJuqxcW3AOlLOpOKQfS2
NeLVIPoZ65qJIJr9Xc1CEK31ZdliEL2iRnkliL5jU7oPRO+LvXqmDSSv030W
RCcxa18C0VzMuWA6g/3bYxBdLXL/FYi24dT7AKKZTgaA6dRHLl9AdN2Dk79A
9LWwk1fagXSV5WMwbRXn86QDSF9edBRMG6QafToOpH8FWP8A0Yf/+7GfANJX
pzySBdE/kh4YfgPSj9g/GYNoq3vHzUG0YJ+SI4iWU3dk+8f12tH6YTaYBgBQ
fMCR
  "],
 CellLabel->
  "In[101]:=",ExpressionUUID->"52f1116d-2f3e-4a74-9fae-6715ac669cb1"],

Cell["\<\
Flatten indices: it turns a list of indices of a tensor into the indices of \
ArrayFlatten[tensor]\
\>", "Text",
 CellChangeTimes->{{3.598184192899452*^9, 3.598184195129714*^9}, {
  3.598348604315647*^9, 
  3.598348625965076*^9}},ExpressionUUID->"a1720522-2568-4644-992e-\
d9d0a87a1e0b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FlattenIndices", "[", 
   RowBox[{"indices_", ",", " ", "sitedimensions_"}], "]"}], ":=", 
  RowBox[{"Flatten", "[", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"Range", "[", 
       RowBox[{
        RowBox[{"1", "-", "sitedimensions"}], ",", "0"}], "]"}], "+", 
      RowBox[{"sitedimensions", "#"}]}], "&"}], "/@", "indices"}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.598184198522438*^9, 3.5981842351106243`*^9}},
 CellLabel->
  "In[106]:=",ExpressionUUID->"49904088-6550-45b5-9e25-4af059d48204"],

Cell["Flatten an S-matrix", "Text",
 CellChangeTimes->{{3.598348630717442*^9, 
  3.598348639189958*^9}},ExpressionUUID->"c893b609-886f-4c41-ad0d-\
38d5b1126c7b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FlattenSmatrix", "[", "S_", "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Flatten", "[", "S", "]"}], "===", 
     RowBox[{"{", "}"}]}], ",", 
    RowBox[{"{", "}"}], ",", 
    RowBox[{
     RowBox[{"ArrayFlatten", "[", "S", "]"}], "//.", 
     RowBox[{
      RowBox[{"{", "}"}], "\[Rule]", 
      RowBox[{"Sequence", "[", "]"}]}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.598350544191989*^9, 3.598350613144014*^9}},
 CellLabel->
  "In[107]:=",ExpressionUUID->"b934363b-ef19-47a9-b334-de3705b7a1cd"],

Cell["Adaptive sampling of an object, in 1D and 2D", "Text",
 CellChangeTimes->{{3.5983805464401007`*^9, 3.598380554239843*^9}, {
  3.598380635702037*^9, 
  3.598380638789926*^9}},ExpressionUUID->"90c5b0c5-0380-498f-926d-\
06393adf4d77"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SamplingFunction", "::", "usage"}], "=", 
   "\"\<Option for Sample that specifies what function of the spectrum should \
be used to determine how to adapt the sampling.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MonitorSampling", "::", "usage"}], "=", 
   "\"\<Option for Sample that specifies whether to do real-time monitoring \
of the sampling.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SamplePoints", "::", "usage"}], "=", 
    "\"\<Option for Sample, UntangledBands, BerryMesh, etc. that specifies \
how many points to take in the sample window.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "Sample", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"SamplingFunction", "\[Rule]", 
      RowBox[{"(", 
       RowBox[{"#", "&"}], ")"}]}], ",", 
     RowBox[{"MonitorSampling", "\[Rule]", "True"}], ",", " ", 
     RowBox[{"MaxRecursion", "\[Rule]", "0"}], ",", " ", 
     RowBox[{"SamplePoints", "\[Rule]", "51"}], ",", " ", 
     RowBox[{"PerformanceGoal", "->", "\"\<Speed\>\""}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"Sample", ",", "HoldAll"}], "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Sample", "[", 
    RowBox[{"objecttosample_", ",", 
     RowBox[{"{", 
      RowBox[{"z_", ",", "zmin_", ",", "zmax_"}], "}"}], ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"aux", ",", " ", 
       RowBox[{"func", "=", 
        RowBox[{"OptionValue", "[", "SamplingFunction", "]"}]}]}], "}"}], ",",
      "\[IndentingNewLine]", 
     RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Sort", "[", "\[IndentingNewLine]", 
        RowBox[{"First", "@", 
         RowBox[{"Last", "@", 
          RowBox[{"Reap", "@", 
           RowBox[{"Plot", "[", 
            RowBox[{
             RowBox[{"func", "[", 
              RowBox[{"aux", "=", "objecttosample"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"z", ",", "zmin", ",", "zmax"}], "}"}], ",", " ", 
             RowBox[{"EvaluationMonitor", "\[RuleDelayed]", 
              RowBox[{"Sow", "[", 
               RowBox[{"{", 
                RowBox[{"z", ",", "aux"}], "}"}], "]"}]}], ",", " ", 
             RowBox[{"PerformanceGoal", "\[RuleDelayed]", 
              RowBox[{"OptionValue", "[", "PerformanceGoal", "]"}]}], ",", 
             " ", 
             RowBox[{"MaxRecursion", "\[Rule]", 
              RowBox[{"OptionValue", "[", "MaxRecursion", "]"}]}], ",", 
             RowBox[{"PlotPoints", "\[Rule]", 
              RowBox[{"OptionValue", "[", "SamplePoints", "]"}]}]}], 
            "]"}]}]}]}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "MonitorSampling", "]"}], ",", "z", ",", 
         "\"\<\>\""}], "]"}]}], "\[IndentingNewLine]", "]"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Sample", "[", 
   RowBox[{"objecttosample_", ",", 
    RowBox[{"{", 
     RowBox[{"x_", ",", "xmin_", ",", "xmax_"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"y_", ",", "ymin_", ",", "ymax_"}], "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"aux", ",", " ", 
      RowBox[{"func", "=", 
       RowBox[{"OptionValue", "[", "SamplingFunction", "]"}]}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Monitor", "[", 
     RowBox[{
      RowBox[{"Sort", "@", 
       RowBox[{"First", "@", 
        RowBox[{"Last", "@", 
         RowBox[{"Reap", "@", 
          RowBox[{"Plot3D", "[", 
           RowBox[{
            RowBox[{"func", "[", 
             RowBox[{"aux", "=", "objecttosample"}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"x", ",", "xmin", ",", "xmax"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"y", ",", "ymin", ",", "ymax"}], "}"}], ",", 
            RowBox[{"EvaluationMonitor", "\[RuleDelayed]", 
             RowBox[{"Sow", "[", 
              RowBox[{"{", 
               RowBox[{"x", ",", "y", ",", "aux"}], "}"}], "]"}]}], ",", " ", 
            
            RowBox[{"NormalsFunction", "\[Rule]", "None"}], ",", 
            RowBox[{"PerformanceGoal", "\[RuleDelayed]", 
             RowBox[{"OptionValue", "[", "PerformanceGoal", "]"}]}], ",", " ", 
            RowBox[{"MaxRecursion", "\[Rule]", 
             RowBox[{"OptionValue", "[", "MaxRecursion", "]"}]}], ",", 
            RowBox[{"PlotPoints", "\[Rule]", 
             RowBox[{"OptionValue", "[", "SamplePoints", "]"}]}]}], 
           "]"}]}]}]}]}], ",", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"OptionValue", "[", "MonitorSampling", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"x", ",", "y"}], "}"}], ",", "\"\<\>\""}], "]"}]}], "]"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.598380328234152*^9, 3.598380330137719*^9}, {
   3.598380523576872*^9, 3.5983805246326523`*^9}, {3.5983806284165897`*^9, 
   3.598380632777082*^9}, {3.598380707568437*^9, 3.598380710170657*^9}, {
   3.59863435842831*^9, 3.598634380869985*^9}, {3.61391534348783*^9, 
   3.613915406908463*^9}, {3.613915471354854*^9, 3.613915499697031*^9}, {
   3.614346218718013*^9, 3.614346238070175*^9}, 3.614409669936479*^9, {
   3.6145077724604073`*^9, 3.614507773334917*^9}, {3.614507838413828*^9, 
   3.614507841210958*^9}, {3.614611675160715*^9, 3.6146116973414917`*^9}, {
   3.614612124925334*^9, 3.6146121743636312`*^9}, {3.614612206177485*^9, 
   3.6146123154280977`*^9}, {3.614612387909668*^9, 3.614612391259142*^9}, {
   3.623147253159856*^9, 3.623147253303582*^9}, 3.623392553044839*^9, {
   3.6234129765284243`*^9, 3.62341297753647*^9}, 3.635831315969211*^9, {
   3.666949478543837*^9, 3.666949668028276*^9}, {3.6669498839849586`*^9, 
   3.666949967978668*^9}, {3.666950002615324*^9, 3.6669500352436657`*^9}, {
   3.6669501799814653`*^9, 3.6669501823436317`*^9}, {3.708075541904018*^9, 
   3.708075611469777*^9}, {3.708075765582234*^9, 3.708075782515276*^9}, 
   3.708075817012178*^9},
 CellLabel->
  "In[108]:=",ExpressionUUID->"7434fad4-5035-4287-8d6c-2cc8d9440e94"],

Cell["GetExtrema routines", "Text",
 CellChangeTimes->{{3.5986321129356203`*^9, 
  3.598632116843552*^9}},ExpressionUUID->"96d21d9c-8700-4d5e-b3c9-\
c6132da04ee3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"GetMinimum", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"x1_", ",", "y1_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"x2_", ",", "y2_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"x3_", ",", "y3_"}], "}"}]}], "}"}], "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ">", 
        RowBox[{"#", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "&&", 
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "<", 
        RowBox[{"#", "[", 
         RowBox[{"[", "3", "]"}], "]"}]}]}], "&"}], "[", 
     RowBox[{
      RowBox[{"Sort", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"x1", ",", "y1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"x2", ",", "y2"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"x3", ",", "y3"}], "}"}]}], "}"}], "]"}], "[", 
      RowBox[{"[", 
       RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{
      FractionBox[
       RowBox[{
        RowBox[{
         SuperscriptBox["x3", "2"], " ", 
         RowBox[{"(", 
          RowBox[{"y1", "-", "y2"}], ")"}]}], "+", 
        RowBox[{
         SuperscriptBox["x1", "2"], " ", 
         RowBox[{"(", 
          RowBox[{"y2", "-", "y3"}], ")"}]}], "+", 
        RowBox[{
         SuperscriptBox["x2", "2"], " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"-", "y1"}], "+", "y3"}], ")"}]}]}], 
       RowBox[{"2", " ", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"x3", " ", 
           RowBox[{"(", 
            RowBox[{"y1", "-", "y2"}], ")"}]}], "+", 
          RowBox[{"x1", " ", 
           RowBox[{"(", 
            RowBox[{"y2", "-", "y3"}], ")"}]}], "+", 
          RowBox[{"x2", " ", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"-", "y1"}], "+", "y3"}], ")"}]}]}], ")"}]}]], ",", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         SuperscriptBox[
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{"x2", "-", "x3"}], ")"}], "2"], " ", "y1"}], "-", 
            RowBox[{
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{"x1", "-", "x3"}], ")"}], "2"], " ", "y2"}]}], ")"}], 
          "2"], "-", 
         RowBox[{"2", " ", 
          SuperscriptBox[
           RowBox[{"(", 
            RowBox[{"x1", "-", "x2"}], ")"}], "2"], " ", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{"x2", "-", "x3"}], ")"}], "2"], " ", "y1"}], "+", 
            RowBox[{
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{"x1", "-", "x3"}], ")"}], "2"], " ", "y2"}]}], ")"}], 
          " ", "y3"}], "+", 
         RowBox[{
          SuperscriptBox[
           RowBox[{"(", 
            RowBox[{"x1", "-", "x2"}], ")"}], "4"], " ", 
          SuperscriptBox["y3", "2"]}]}], ")"}], "/", 
       RowBox[{"(", 
        RowBox[{"4", " ", 
         RowBox[{"(", 
          RowBox[{"x1", "-", "x2"}], ")"}], " ", 
         RowBox[{"(", 
          RowBox[{"x1", "-", "x3"}], ")"}], " ", 
         RowBox[{"(", 
          RowBox[{"x2", "-", "x3"}], ")"}], " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"x3", " ", 
            RowBox[{"(", 
             RowBox[{"y1", "-", "y2"}], ")"}]}], "+", 
           RowBox[{"x1", " ", 
            RowBox[{"(", 
             RowBox[{"y2", "-", "y3"}], ")"}]}], "+", 
           RowBox[{"x2", " ", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"-", "y1"}], "+", "y3"}], ")"}]}]}], ")"}]}], ")"}]}]}],
      "}"}], ",", "Null"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GetMinima", "[", "L0_List", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "L", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", 
         RowBox[{"Dimensions", "@", "L0"}]}], "\[Equal]", "1"}], ",", 
       RowBox[{"L", "=", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Range", "[", 
            RowBox[{"Length", "@", "L0"}], "]"}], ",", "L0"}], "}"}], 
         "\[Transpose]"}]}], ",", 
       RowBox[{"L", "=", "L0"}]}], "]"}], ";", 
     RowBox[{"DeleteCases", "[", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"GetMinimum", "[", 
          RowBox[{"L", "[", 
           RowBox[{"[", 
            RowBox[{"j", ";;", 
             RowBox[{"j", "+", "2"}]}], "]"}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", 
           RowBox[{
            RowBox[{"Length", "[", "L", "]"}], "-", "2"}]}], "}"}]}], "]"}], 
       ",", "Null"}], "]"}]}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetMaxima", "[", "L0_List", "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Length", "@", 
       RowBox[{"Dimensions", "@", "L0"}]}], "\[Equal]", "1"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1", ",", 
          RowBox[{"-", "1"}]}], "}"}], "#"}], "&"}], "/@", 
      RowBox[{"GetMinima", "[", 
       RowBox[{"-", "L0"}], "]"}]}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1", ",", 
          RowBox[{"-", "1"}]}], "}"}], "#"}], "&"}], "/@", 
      RowBox[{"GetMinima", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"#", 
          RowBox[{"{", 
           RowBox[{"1", ",", 
            RowBox[{"-", "1"}]}], "}"}]}], "&"}], "/@", "L0"}], "]"}]}]}], 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GetExtrema", "[", "list_", "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{"Join", "[", 
   RowBox[{
    RowBox[{"GetMinima", "[", 
     RowBox[{"Append", "[", 
      RowBox[{"list", ",", 
       RowBox[{"First", "@", "list"}]}], "]"}], "]"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", 
        RowBox[{"-", 
         RowBox[{"#", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], "&"}], "/@", 
     RowBox[{"GetMinima", "[", 
      RowBox[{"-", 
       RowBox[{"Append", "[", 
        RowBox[{"list", ",", 
         RowBox[{"First", "@", "list"}]}], "]"}]}], "]"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{
  3.575351588110305*^9, {3.578210528935912*^9, 3.57821061781012*^9}, {
   3.578211039117032*^9, 3.578211044413579*^9}, {3.598632140811795*^9, 
   3.5986321460992727`*^9}},
 CellLabel->
  "In[115]:=",ExpressionUUID->"5bf97291-b845-4ce3-8671-acbc26514ecb"],

Cell["\<\
Ragged partition \
(http://mathematica.stackexchange.com/questions/7511/partitioning-with-\
varying-partition-size)\
\>", "Text",
 CellChangeTimes->{{3.599136791358717*^9, 
  3.599136804143627*^9}},ExpressionUUID->"1c02f269-a4a4-4089-a7c3-\
4b76b2cabe43"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"DPcore", "[", 
    RowBox[{"L_", ",", 
     RowBox[{"p", ":", 
      RowBox[{"{", 
       RowBox[{"q___", ",", "_"}], "}"}]}]}], "]"}], ":=", 
   RowBox[{"Inner", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"L", "[", 
       RowBox[{"[", 
        RowBox[{"#", ";;", "#2"}], "]"}], "]"}], "&"}], ",", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0", ",", "q"}], "}"}], "+", "1"}], ",", "p", ",", 
     RowBox[{"Head", "@", "L"}]}], "]"}]}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DPcore", "[", 
    RowBox[{"L_", ",", "p_", ",", "All"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"DPcore", "[", 
     RowBox[{"L", ",", "p"}], "]"}], "~", "Append", "~", 
    RowBox[{"Drop", "[", 
     RowBox[{"L", ",", 
      RowBox[{"Last", "@", "p"}]}], "]"}]}]}], "\[IndentingNewLine]"}], "\n", 

 RowBox[{
  RowBox[{
   RowBox[{"DPcore", "[", 
    RowBox[{"L_", ",", "p_", ",", "n__"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"DPcore", "[", 
     RowBox[{"L", ",", "p"}], "]"}], "~", "Join", "~", 
    RowBox[{"Partition", "[", 
     RowBox[{
      RowBox[{"L", "~", "Drop", "~", 
       RowBox[{"Last", "@", "p"}]}], ",", "n"}], "]"}]}]}], 
  "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"DynamicPartition", "[", 
   RowBox[{"L_", ",", 
    RowBox[{"p", ":", 
     RowBox[{"{", "__Integer", "}"}]}], ",", "x___"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"DPcore", "[", 
    RowBox[{"L", ",", 
     RowBox[{"Accumulate", "@", "p"}], ",", "x"}], "]"}], "/;", 
   RowBox[{
    RowBox[{"!", 
     RowBox[{"Negative", "@", 
      RowBox[{"Min", "@", "p"}]}]}], "&&", 
    RowBox[{
     RowBox[{"Length", "@", "L"}], "\[GreaterEqual]", 
     RowBox[{"Tr", "@", "p"}]}]}]}]}]}], "Input",
 CellChangeTimes->{{3.5991367943222647`*^9, 3.599136794324085*^9}, {
  3.599136887222754*^9, 3.5991369003138123`*^9}},
 CellLabel->
  "In[119]:=",ExpressionUUID->"85880098-e953-4496-9f89-255f578da65b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"Returns", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"xmin", ",", "xmax"}], "}"}], ",", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"ymin", ",", "ymax"}], "}"}], "..."}]}], "}"}], " ", "for", 
    " ", "a", " ", "given", " ", "lattice"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"LatticeBoundingBox", "[", "lat_MQLattice", "]"}], ":=", 
   RowBox[{"MinMax", "/@", 
    RowBox[{"Transpose", "[", 
     RowBox[{"lat", "[", "\"\<FlatSites\>\"", "]"}], "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.650358838166897*^9, 3.6503589021423683`*^9}, 
   3.680361455890375*^9, {3.72802393540066*^9, 3.728023941335514*^9}},
 CellLabel->
  "In[123]:=",ExpressionUUID->"cb3c7b3c-af8a-4225-a029-b0b9d9d699a5"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"EigensystemFixedPhase", "[", "m__", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"esys", "=", 
       RowBox[{"Eigensystem", "[", "m", "]"}]}], ",", " ", "evals", ",", " ", 
      "evecs"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"evals", ",", "evecs"}], "}"}], "=", "esys"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"evecs", "=", 
      FractionBox["evecs", 
       SuperscriptBox["\[ExponentialE]", 
        RowBox[{"\[ImaginaryI]", " ", 
         RowBox[{"Arg", "[", 
          RowBox[{"Total", "/@", "evecs"}], "]"}]}]]]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Return", "[", 
      RowBox[{"{", 
       RowBox[{"evals", ",", "evecs"}], "}"}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"EigenvectorsFixedPhase", "[", "m__", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"evecs", "=", 
       RowBox[{"Eigenvectors", "[", "m", "]"}]}], ",", " ", "evecsfixed"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"evecsfixed", "=", 
      FractionBox["evecs", 
       SuperscriptBox["\[ExponentialE]", 
        RowBox[{"\[ImaginaryI]", " ", 
         RowBox[{"Arg", "[", 
          RowBox[{"Total", "/@", "evecs"}], "]"}]}]]]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Return", "[", "evecsfixed", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.752150302257331*^9, 3.7521503730168257`*^9}, {
  3.7521504105190496`*^9, 3.752150551129512*^9}, {3.752150932592389*^9, 
  3.752150956022821*^9}},
 CellLabel->
  "In[124]:=",ExpressionUUID->"a23d7914-4f62-462e-8619-3feeb8763d1b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Assign", "::", "usage"}], "=", 
   "\"\<Assign[system, {row, col}, value] (or Assign[system, {{row1, col1}, \
...}, {value1, ...}], Assign[system, {{row1, col1}, ...}, value]) assigns \
`value` to the matrix element at (row, col) of the system's \
Hamiltonian\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CellDistance", "::", "usage"}], " ", "=", " ", 
   "\"\<Option for Assign to specify the integer cell distance for a hopping \
assignment (e.g. CellDistance->{0,0} selects the intracell \
Hamiltonian).\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"AddAdjoint", "::", "usage"}], "=", 
   "\"\<Option for Assign, True by default, that automatically adds also the \
adjoint of the supplied elements (only for hoppings, not onsite assignments).\
\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"Assign", ",", "HoldFirst"}], "]"}], ";"}], "\[IndentingNewLine]", 

 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "Assign", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"CellDistance", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{"0", "___"}], "}"}]}], ",", " ", 
      RowBox[{"AddAdjoint", "\[Rule]", "True"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Assign", "[", 
    RowBox[{"sys_", ",", " ", 
     RowBox[{"{", 
      RowBox[{"row_Integer", ",", " ", "col_Integer"}], "}"}], ",", " ", 
     "el_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"i", "=", 
        RowBox[{"Position", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"sys", "[", "\"\<HBloch\>\"", "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"OptionValue", "[", "CellDistance", "]"}]}], "]"}]}], ",", 
       " ", 
       RowBox[{"ic", " ", "=", 
        RowBox[{"Position", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"sys", "[", "\"\<HBloch\>\"", "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"-", 
           RowBox[{"OptionValue", "[", "CellDistance", "]"}]}]}], "]"}]}]}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"sys", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2", ",", 
           RowBox[{"First", "@", "i"}], ",", "2"}], "]"}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"row", ",", "col"}], "]"}], "]"}], "=", "el"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "AddAdjoint", "]"}], "&&", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"row", "\[NotEqual]", "col"}], " ", "||", 
           RowBox[{
            RowBox[{"Norm", "[", 
             RowBox[{"OptionValue", "[", "CellDistance", "]"}], "]"}], 
            "\[NotEqual]", "0"}]}], ")"}]}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"sys", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "2", ",", 
             RowBox[{"First", "@", "ic"}], ",", "2"}], "]"}], "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"col", ",", "row"}], "]"}], "]"}], "=", 
         RowBox[{"el", "\[Conjugate]"}]}]}], "]"}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Assign", "[", 
    RowBox[{"sys_", ",", " ", 
     RowBox[{"{", "rowcol__List", "}"}], ",", " ", "el_List", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", 
   RowBox[{"MapThread", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Assign", "[", 
       RowBox[{"sys", ",", "#1", ",", "#2", ",", " ", "opts"}], "]"}], "&"}], 
     ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "rowcol", "}"}], ",", " ", "el"}], "}"}]}], " ", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Assign", "[", 
   RowBox[{"sys_", ",", " ", 
    RowBox[{"{", "rowcol__List", "}"}], ",", " ", "el_", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", " ", 
  RowBox[{"Assign", "[", 
   RowBox[{"sys", ",", " ", 
    RowBox[{"{", "rowcol", "}"}], ",", " ", 
    RowBox[{"ConstantArray", "[", 
     RowBox[{"el", ",", " ", 
      RowBox[{"Length", "@", 
       RowBox[{"{", "rowcol", "}"}]}]}], "]"}], ",", " ", "opts"}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.781449260789851*^9, 3.781449501553834*^9}, 
   3.781449860676907*^9, {3.781449962943614*^9, 3.781450041762611*^9}, {
   3.781450072183189*^9, 3.781450074941441*^9}, {3.78151185464736*^9, 
   3.7815118595523*^9}, {3.781520833807456*^9, 3.78152121068537*^9}, {
   3.781521270087981*^9, 3.7815212738081703`*^9}, {3.781521369810069*^9, 
   3.781521389838722*^9}, {3.781521485136449*^9, 3.78152148659042*^9}, {
   3.781527973917108*^9, 3.781527981186438*^9}, {3.781528014570451*^9, 
   3.781528014896796*^9}},
 CellLabel->
  "In[126]:=",ExpressionUUID->"03fd85dc-7635-4bee-bfc3-e44ba6826b1e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Visualization", "Subsection",
 CellChangeTimes->{{3.597739936633292*^9, 3.597739941496951*^9}, {
  3.598340748600721*^9, 3.598340749937085*^9}, {3.5983632855674963`*^9, 
  3.598363287191039*^9}},ExpressionUUID->"395e8849-ec81-4b72-8b5a-\
f1313d3c946a"],

Cell["PlotLattice", "Text",
 CellChangeTimes->{{3.614750477163436*^9, 3.61475048031551*^9}, 
   3.614750689596919*^9, {3.6147511034048843`*^9, 
   3.614751105521237*^9}},ExpressionUUID->"9a045385-8700-4d28-9583-\
3bec5a6553d3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"PlotDefaults", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"PlotTheme", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
       "\"\<Detailed\>\"", ",", "\"\<LargeLabels\>\"", ",", "\"\<ZMesh\>\"", 
        ",", " ", "\"\<BoldColor\>\""}], "}"}]}], ",", 
     RowBox[{"PlotRangePadding", "\[Rule]", "None"}]}], "}"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.5983632204680967`*^9, 3.598363265343594*^9}, {
  3.598363343204166*^9, 3.598363350677209*^9}, {3.598363556061718*^9, 
  3.5983635597078*^9}, {3.6147506862757607`*^9, 3.614750694667139*^9}, {
  3.614750776119898*^9, 3.614750928426*^9}, {3.614750990593033*^9, 
  3.614750991111472*^9}, {3.614751033573916*^9, 3.614751036604643*^9}, {
  3.6147510730706463`*^9, 3.6147510932924023`*^9}},
 CellLabel->
  "In[134]:=",ExpressionUUID->"8443fd08-9637-47dd-9532-c181e8b7635e"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Labels", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice denoting how to represent each site. Valid \
values are {Numbers, Tags, None}.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SiteColors", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice. It denotes the colors to use for sites with \
different tags. It can be a list of colors, an integer (denoting a discrete \
color scheme) or Automatic.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LinkColor", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice denoting the color to use for links between \
sites.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotBravais", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice denoting whether or not to plot adjacent unit \
cells in a Bravais lattice.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"UnitCells", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice denoting the number of Bravais unit cells to \
plot.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotDirectives", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice containing any primitive directive to \
implement in the plot.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SublatDirectives", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice containing a list of primitive directives to \
implement for each sublattice.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SiteDirectives", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice containing a matrix of primitive directives to \
implement for each site.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SiteRadius", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice to plot sites as spheres of a given radius. It \
can be a number, or a list of numbers, one per sublattice.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LinkRadius", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice to plot links as tubes of a given \
radius.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ShowSites", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice that specifies whether sites should be plotted\
\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SiteTooltips", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice that enables tooltips on sites when the system \
is provided.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LinkTooltips", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice that enables tooltips on links when the system \
is provided.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BackwardInterlink", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice that specifies inter-unitcells links to be \
drawn backwards\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DimFraction", "::", "usage"}], "=", 
   "\"\<Option for PlotLattice that specifies how much to dim neighboring \
unit cells\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CellBox", "::", "usage"}], " ", "=", " ", 
   "\"\<Option for PlotLattice that specifies whether to draw a bounding box \
around unit cells.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CellBoxCentered", "::", "usage"}], " ", "=", " ", 
   "\"\<Option for PlotLattice that specifies whether to draw a bounding box \
around unit cells with its center (instead of its vertex) at the \
orgin.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CellBoxStyle", "::", "usage"}], " ", "=", " ", 
   "\"\<Option for PlotLattice that specifies the line style of the cell \
bounding boxes.\>\""}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "PlotLattice", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Labels", "\[Rule]", "None"}], ",", " ", "\[IndentingNewLine]", 
      
      RowBox[{"SiteColors", "\[Rule]", "Automatic"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"LinkColor", "\[Rule]", 
       RowBox[{"GrayLevel", "[", ".7", "]"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"PlotDirectives", "\[Rule]", 
       RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"PlotBravais", "\[Rule]", "True"}], ",", "\[IndentingNewLine]", 
      
      RowBox[{"UnitCells", "\[Rule]", "2"}], ",", "\[IndentingNewLine]", 
      RowBox[{"SiteRadius", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
      RowBox[{"LinkRadius", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
      RowBox[{"SiteDirectives", "\[Rule]", "None"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"SublatDirectives", "\[Rule]", "None"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ShowSites", "\[Rule]", "True"}], ",", "\[IndentingNewLine]", 
      RowBox[{"SiteTooltips", "\[Rule]", "False"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"LinkTooltips", "\[Rule]", "False"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"BackwardInterlink", "\[Rule]", "True"}], ",", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"VertexColors", "\[Rule]", "Automatic"}], ",", " ", 
      RowBox[{"DimFraction", "\[Rule]", "0.7"}], ",", "\[IndentingNewLine]", 
      RowBox[{"CellBox", "\[Rule]", "True"}], ",", 
      RowBox[{"CellBoxStyle", "->", 
       RowBox[{"GrayLevel", "[", ".3", "]"}]}], ",", " ", 
      RowBox[{"CellBoxCentered", "\[Rule]", "True"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Sequence", "@@", 
       RowBox[{"Options", "[", "Graphics", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Sequence", "@@", 
       RowBox[{"Options", "[", "Graphics3D", "]"}]}], ","}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"PlotLattice", "::", "dim"}], "=", 
    "\"\<Invalid dimensions `1`.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotLattice", "[", 
   RowBox[{"lattice_MQLattice", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"PlotLattice", "[", 
   RowBox[{"lattice", ",", 
    RowBox[{"MQSystem", "[", "None", "]"}], ",", "opts"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotLattice", "[", 
   RowBox[{"lattice_MQLattice", ",", "mesh_MQSpringMesh", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"PlotLattice", "[", 
   RowBox[{"lattice", ",", 
    RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], ",", "opts"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotLattice", "[", 
   RowBox[{"lattice_MQLattice", ",", "system_MQSystem", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"labels", "=", 
       RowBox[{"OptionValue", "[", "Labels", "]"}]}], ",", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"sitecolors", "=", 
       RowBox[{"OptionValue", "[", "SiteColors", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"sitedirectives", "=", 
       RowBox[{"OptionValue", "[", "SiteDirectives", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"sublatdirectives", "=", 
       RowBox[{"OptionValue", "[", "SublatDirectives", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"brvectors", "=", 
       RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"unitcells", "=", 
       RowBox[{"OptionValue", "[", "UnitCells", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"vertexcolors", "=", 
       RowBox[{"OptionValue", "[", "VertexColors", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"boxed", "=", 
       RowBox[{"OptionValue", "[", "CellBox", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"boxshift", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "CellBoxCentered", "]"}], ",", "1", ",", 
         "0"}], "]"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"boxstyle", "=", 
       RowBox[{"OptionValue", "[", "CellBoxStyle", "]"}]}], ",", 
      "\[IndentingNewLine]", "siteradii", ",", "index", ",", 
      "\[IndentingNewLine]", "links", ",", "interlinks", ",", "Hinterlinks", 
      ",", "\[Phi]", ",", "interlines", ",", "interindices", ",", 
      "\[IndentingNewLine]", 
      RowBox[{"lighterfraction", "=", 
       RowBox[{"OptionValue", "[", "DimFraction", "]"}]}], ",", "sites", ",", 
      "groups", ",", "groupsizes", ",", "embdim", ",", " ", "primitives", ",",
       " ", "aux", ",", "\[IndentingNewLine]", "linkTT", ",", " ", "siteTT", 
      ",", "applytooltip", ",", "Hsys", ",", " ", "obj"}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"system", "=!=", 
        RowBox[{"MQSystem", "[", "None", "]"}]}], ",", "\[IndentingNewLine]", 
       
       RowBox[{
        RowBox[{"Hsys", "=", 
         RowBox[{"system", "[", "\"\<H\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"OptionValue", "[", "SiteTooltips", "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"applytooltip", "[", 
            RowBox[{"obj_", ",", "index_Integer"}], "]"}], ":=", 
           RowBox[{"Tooltip", "[", 
            RowBox[{"obj", ",", 
             RowBox[{"MatrixForm", "[", 
              RowBox[{"Hsys", "[", 
               RowBox[{"[", 
                RowBox[{"index", ",", "index"}], "]"}], "]"}], "]"}]}], 
            "]"}]}], ",", 
          RowBox[{
           RowBox[{"applytooltip", "[", 
            RowBox[{"obj_", ",", "index_Integer"}], "]"}], "=", "obj"}]}], 
         "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"OptionValue", "[", "LinkTooltips", "]"}], ",", 
          RowBox[{
           RowBox[{"applytooltip", "[", 
            RowBox[{"obj_", ",", 
             RowBox[{"{", 
              RowBox[{"i1_Integer", ",", "i2_Integer"}], "}"}]}], "]"}], ":=", 
           RowBox[{"Tooltip", "[", 
            RowBox[{"obj", ",", 
             RowBox[{"Column", "@", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"MatrixForm", "[", 
                 RowBox[{"Hsys", "[", 
                  RowBox[{"[", 
                   RowBox[{"i1", ",", "i2"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"MatrixForm", "[", 
                 RowBox[{"Hsys", "[", 
                  RowBox[{"[", 
                   RowBox[{"i2", ",", "i1"}], "]"}], "]"}], "]"}]}], 
               "}"}]}]}], "]"}]}], ",", 
          RowBox[{
           RowBox[{"applytooltip", "[", 
            RowBox[{"obj_", ",", 
             RowBox[{"{", 
              RowBox[{"i1_Integer", ",", "i2_Integer"}], "}"}]}], "]"}], "=", 
           "obj"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"applytooltip", "[", 
         RowBox[{"obj_", ",", "_"}], "]"}], "=", "obj"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"groups", "=", 
      RowBox[{"Length", "@", 
       RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"groupsizes", "=", 
      RowBox[{"Length", "/@", 
       RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"sites", "=", 
      RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"embdim", "=", 
      RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"embdim", "\[Equal]", "1"}], ",", 
       RowBox[{
        RowBox[{"sites", "=", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"PadRight", "[", 
             RowBox[{"#", ",", "2"}], "]"}], "&"}], ",", "sites", ",", 
           RowBox[{"{", "2", "}"}]}], "]"}]}], ";", 
        RowBox[{"brvectors", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"PadRight", "[", 
            RowBox[{"#", ",", "2"}], "]"}], "&"}], "/@", "brvectors"}]}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "[", "ShowSites", "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Switch", "[", 
         RowBox[{
         "labels", ",", "\[IndentingNewLine]", "\"\<Numbers\>\"", ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Build", " ", "a", " ", "GraphicsComplex", " ", "with", " ", 
            "site", " ", "indices", " ", "at", " ", "site", " ", "positions", 
            " ", "in", " ", "each", " ", "site", " ", "group"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"primitives", "=", 
           RowBox[{"MapThread", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Function", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"poslist", ",", "indlist"}], "}"}], ",", 
               RowBox[{"GraphicsComplex", "[", 
                RowBox[{"poslist", ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"applytooltip", "[", 
                    RowBox[{
                    RowBox[{"Style", "[", 
                    RowBox[{
                    RowBox[{"Text", "[", 
                    RowBox[{
                    RowBox[{"indlist", "[", 
                    RowBox[{"[", "#", "]"}], "]"}], ",", "#"}], "]"}], ",", 
                    RowBox[{"FontFamily", "\[Rule]", "\"\<Helvetica\>\""}]}], 
                    "]"}], ",", 
                    RowBox[{"indlist", "[", 
                    RowBox[{"[", "#", "]"}], "]"}]}], "]"}], "&"}], "/@", 
                  RowBox[{"Range", "[", 
                   RowBox[{"Length", "[", "poslist", "]"}], "]"}]}]}], 
                "]"}]}], "]"}], ",", "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{"sites", ",", 
               RowBox[{"lattice", "[", "\"\<SiteIndices\>\"", "]"}]}], 
              "}"}]}], "]"}]}], ",", "\[IndentingNewLine]", "\"\<Tags\>\"", 
          ",", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Build", " ", "a", " ", "GraphicsComplex", " ", "with", " ", 
            "site", " ", "tags", " ", "at", " ", "site", " ", "positions", 
            " ", "in", " ", "each", " ", "site", " ", "group"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"primitives", "=", 
           RowBox[{"MapThread", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Function", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"poslist", ",", "taglist", ",", " ", "indlist"}], 
                "}"}], ",", 
               RowBox[{"GraphicsComplex", "[", 
                RowBox[{"poslist", ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"applytooltip", "[", 
                    RowBox[{
                    RowBox[{"Style", "[", 
                    RowBox[{
                    RowBox[{"Text", "[", 
                    RowBox[{
                    RowBox[{"taglist", "[", 
                    RowBox[{"[", "#", "]"}], "]"}], ",", "#"}], "]"}], ",", 
                    RowBox[{"FontFamily", "\[Rule]", "\"\<Helvetica\>\""}]}], 
                    "]"}], ",", 
                    RowBox[{"indlist", "[", 
                    RowBox[{"[", "#", "]"}], "]"}]}], "]"}], "&"}], "/@", 
                  RowBox[{"Range", "[", 
                   RowBox[{"Length", "[", "poslist", "]"}], "]"}]}]}], 
                "]"}]}], "]"}], ",", "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{"sites", ",", 
               RowBox[{"lattice", "[", "\"\<SiteTags\>\"", "]"}], ",", 
               RowBox[{"lattice", "[", "\"\<SiteIndices\>\"", "]"}]}], 
              "}"}]}], "]"}]}], ",", "\[IndentingNewLine]", "_", ",", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "/@", "sitedirectives"}], "===", 
             RowBox[{"Length", "/@", "sites"}]}], ",", "\[IndentingNewLine]", 
            
            RowBox[{"(*", 
             RowBox[{"This", " ", "line", " ", "is", " ", 
              RowBox[{"tricky", ":", " ", 
               RowBox[{
               "it", " ", "just", " ", "pairs", " ", "sites", " ", "and", " ",
                 "indices", " ", "to", " ", "depth", " ", "2", " ", 
                RowBox[{"(", "sublattices", ")"}]}]}]}], "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"primitives", "=", 
              RowBox[{
               RowBox[{
                RowBox[{"MapThread", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"applytooltip", "[", 
                    RowBox[{
                    RowBox[{"Point", "[", "#1", "]"}], ",", "#2"}], "]"}], 
                   "&"}], ",", "#"}], "]"}], "&"}], "/@", 
               RowBox[{"Transpose", "[", 
                RowBox[{"{", 
                 RowBox[{"sites", ",", 
                  RowBox[{"lattice", "[", "\"\<SiteIndices\>\"", "]"}]}], 
                 "}"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"primitives", "=", 
              RowBox[{"MapThread", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Riffle", "[", 
                  RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", 
                RowBox[{"{", 
                 RowBox[{"sitedirectives", ",", "primitives"}], "}"}]}], 
               "]"}]}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"OptionValue", "[", "SiteTooltips", "]"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{"This", " ", "line", " ", "is", " ", 
                RowBox[{"tricky", ":", " ", 
                 RowBox[{
                 "it", " ", "just", " ", "pairs", " ", "sites", " ", "and", 
                  " ", "indices", " ", "to", " ", "depth", " ", "2", " ", 
                  RowBox[{"(", "sublattices", ")"}]}]}]}], "*)"}], 
              "\[IndentingNewLine]", 
              RowBox[{"primitives", "=", 
               RowBox[{
                RowBox[{
                 RowBox[{"MapThread", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"applytooltip", "[", 
                    RowBox[{
                    RowBox[{"Point", "[", "#1", "]"}], ",", "#2"}], "]"}], 
                    "&"}], ",", "#"}], "]"}], "&"}], "/@", 
                RowBox[{"Transpose", "[", 
                 RowBox[{"{", 
                  RowBox[{"sites", ",", 
                   RowBox[{"lattice", "[", "\"\<SiteIndices\>\"", "]"}]}], 
                  "}"}], "]"}]}]}], ",", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{
                "If", " ", "no", " ", "tooltips", " ", "are", " ", 
                 "requested"}], ",", " ", 
                RowBox[{
                "we", " ", "optimize", " ", "by", " ", "lumping", " ", "all", 
                 " ", "points", " ", "with", " ", "equal", " ", "appearance", 
                 " ", "into", " ", "one"}]}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"primitives", "=", 
               RowBox[{"Point", "/@", "sites"}]}]}], "]"}]}], 
           "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"sitecolors", "\[Equal]", "Automatic"}], ",", 
          RowBox[{"sitecolors", "=", 
           RowBox[{"ColorData", "[", 
            RowBox[{"22", ",", "\"\<ColorList\>\""}], "]"}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"IntegerQ", "[", "sitecolors", "]"}], ",", 
          RowBox[{"sitecolors", "=", 
           RowBox[{"ColorData", "[", 
            RowBox[{"sitecolors", ",", "\"\<ColorList\>\""}], "]"}]}]}], 
         "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"sitecolors", " ", "=", " ", 
         RowBox[{"PadRight", "[", 
          RowBox[{"sitecolors", ",", 
           RowBox[{"Length", "[", "primitives", "]"}], ",", "sitecolors"}], 
          "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"sublatdirectives", "\[Equal]", "None"}], ",", 
          RowBox[{"sublatdirectives", "=", 
           RowBox[{"Directive", "[", 
            RowBox[{"{", "}"}], "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"sublatdirectives", "=", 
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "sublatdirectives", "}"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"sublatdirectives", " ", "=", " ", 
         RowBox[{"PadRight", "[", 
          RowBox[{"sublatdirectives", ",", 
           RowBox[{"Length", "[", "primitives", "]"}], ",", 
           "sublatdirectives"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"sublatdirectives", "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"sublatdirectives", ",", "sitecolors"}], "}"}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"primitives", "=", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Sequence", "@@", "#1"}], ",", "#2"}], "}"}], "&"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"sublatdirectives", ",", " ", "primitives"}], "}"}]}], 
          "]"}]}]}], "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"primitives", "=", 
         RowBox[{"{", "}"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"system", "=!=", 
        RowBox[{"MQSystem", "[", "None", "]"}]}], ",", "\[IndentingNewLine]", 
       
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "Extract", " ", "intracell", " ", "links", " ", "from", " ", "HSelf",
           " ", "matrix"}], ",", " ", 
         RowBox[{"in", " ", "the", " ", "form", " ", 
          RowBox[{"{", 
           RowBox[{"i", ",", "j"}], "}"}]}]}], "*)"}], "\[IndentingNewLine]", 
       
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"links", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"DeleteCases", "[", 
             RowBox[{"#", ",", 
              RowBox[{"{", 
               RowBox[{"i_", ",", "i_"}], "}"}]}], "]"}], "&"}], "@", 
           RowBox[{"DeleteDuplicates", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Most", "[", 
               RowBox[{"ArrayRules", "[", 
                RowBox[{"UpperTriangularize", "[", 
                 RowBox[{"Hsys", ",", "1"}], "]"}], "]"}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1", ",", 
                RowBox[{"{", 
                 RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "]"}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"Sort", "[", "#1", "]"}], "===", 
               RowBox[{"Sort", "[", "#2", "]"}]}], "&"}]}], "]"}]}]}], ";"}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"links", "=", 
         RowBox[{
          RowBox[{"Most", "[", 
           RowBox[{"ArrayRules", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"SquareMatrixQ", "[", "#", "]"}], ",", 
                RowBox[{"Chop", "@", 
                 RowBox[{"UpperTriangularize", "[", 
                  RowBox[{"#", ",", "1"}], "]"}]}], ",", "#"}], "]"}], "&"}], 
             "@", "Hsys"}], "]"}], "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1", ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"OptionValue", "[", "LinkTooltips", "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"primitives", "=", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"OptionValue", "[", "LinkColor", "]"}], ",", 
               RowBox[{"GraphicsComplex", "[", 
                RowBox[{
                 RowBox[{"Flatten", "[", 
                  RowBox[{"sites", ",", "1"}], "]"}], ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"applytooltip", "[", 
                    RowBox[{
                    RowBox[{"Line", "[", "#", "]"}], ",", "#"}], "]"}], "&"}],
                   "/@", "links"}]}], "]"}]}], "}"}], ",", "primitives"}], 
            "}"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "If", " ", "no", " ", "tooltips", " ", "are", " ", "requested"}], 
            ",", " ", 
            RowBox[{
            "we", " ", "optimize", " ", "by", " ", "lumping", " ", "all", " ",
              "links", " ", "into", " ", "one"}]}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"primitives", "=", 
           RowBox[{"{", 
            RowBox[{"primitives", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"OptionValue", "[", "LinkColor", "]"}], ",", 
               RowBox[{"GraphicsComplex", "[", 
                RowBox[{
                 RowBox[{"Flatten", "[", 
                  RowBox[{"sites", ",", "1"}], "]"}], ",", 
                 RowBox[{"Line", "[", "links", "]"}]}], "]"}]}], "}"}]}], 
            "}"}]}]}], "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"boxed", "&&", 
          RowBox[{"embdim", "\[Equal]", "1"}], "&&", 
          RowBox[{
           RowBox[{"Length", "@", "brvectors"}], ">", "0"}]}], ",", " ", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"vec", "=", 
             RowBox[{"brvectors", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "}"}], ",", 
           RowBox[{"AppendTo", "[", 
            RowBox[{"primitives", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"FaceForm", "[", "None", "]"}], ",", 
               RowBox[{"EdgeForm", "[", "Gray", "]"}], ",", 
               RowBox[{"Parallelogram", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"0", "*", 
                   RowBox[{"vec", "/", "2"}]}], "-", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"0", ",", "0.01"}], "}"}], 
                   RowBox[{"Norm", "[", "vec", "]"}]}]}], ",", 
                 RowBox[{"{", 
                  RowBox[{"vec", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0.02"}], "}"}], 
                    RowBox[{"Norm", "[", "vec", "]"}]}]}], "}"}]}], "]"}]}], 
              "}"}]}], "]"}]}], "]"}]}], "]"}], ";"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"boxed", "&&", 
        RowBox[{"embdim", "\[Equal]", "2"}], "&&", 
        RowBox[{
         RowBox[{"Length", "@", "brvectors"}], ">", "0"}]}], ",", " ", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"vecs", "=", 
           RowBox[{"PadRight", "[", 
            RowBox[{"brvectors", ",", "2", ",", 
             RowBox[{"{", 
              RowBox[{"{", 
               RowBox[{"0", ",", "0"}], "}"}], "}"}]}], "]"}]}], "}"}], ",", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"primitives", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"FaceForm", "[", "None", "]"}], ",", 
             RowBox[{"EdgeForm", "[", "boxstyle", "]"}], ",", 
             RowBox[{"Parallelogram", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"-", "boxshift"}], " ", 
                RowBox[{
                 RowBox[{"Total", "[", "vecs", "]"}], "/", "2"}]}], ",", 
               "vecs"}], "]"}]}], "}"}]}], "]"}]}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"boxed", "&&", 
        RowBox[{"embdim", "\[Equal]", "3"}], "&&", 
        RowBox[{
         RowBox[{"Length", "@", "brvectors"}], ">", "0"}]}], ",", " ", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"vecs", "=", 
           RowBox[{"PadRight", "[", 
            RowBox[{"brvectors", ",", "3", ",", 
             RowBox[{"{", 
              RowBox[{"{", 
               RowBox[{"0", ",", "0", ",", "0"}], "}"}], "}"}]}], "]"}]}], 
          "}"}], ",", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"primitives", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"FaceForm", "[", "None", "]"}], ",", 
             RowBox[{"EdgeForm", "[", "boxstyle", "]"}], ",", 
             RowBox[{"Parallelepiped", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"-", "boxshift"}], " ", 
                RowBox[{
                 RowBox[{"Total", "[", "vecs", "]"}], "/", "2"}]}], ",", 
               "vecs"}], "]"}]}], "}"}]}], "]"}]}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"siteradii", "=", 
      RowBox[{"OptionValue", "[", "SiteRadius", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"NumericQ", "[", "siteradii", "]"}], ",", 
       RowBox[{"siteradii", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"siteradii", ",", 
          RowBox[{"Length", "@", 
           RowBox[{"lattice", "[", "\"\<Tags\>\"", "]"}]}]}], "]"}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"embdim", "\[Equal]", "3"}], "&&", 
        RowBox[{"VectorQ", "[", 
         RowBox[{"siteradii", ",", "NumericQ"}], "]"}]}], ",", " ", 
       RowBox[{
        RowBox[{"index", "=", "1"}], ";", 
        RowBox[{"primitives", "=", 
         RowBox[{"primitives", "/.", 
          RowBox[{
           RowBox[{"Point", "[", "aux_", "]"}], ":>", 
           RowBox[{"Sphere", "[", 
            RowBox[{"aux", ",", 
             RowBox[{"siteradii", "[", 
              RowBox[{"[", 
               RowBox[{"index", "++"}], "]"}], "]"}]}], "]"}]}]}]}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "PlotBravais", "]"}], "&&", 
        RowBox[{
         RowBox[{"Length", "@", "brvectors"}], "\[NotEqual]", "0"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"system", "=!=", 
           RowBox[{"MQSystem", "[", "None", "]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Consider", " ", "links", " ", "from", " ", "cell", " ", "zero", 
            " ", "to", " ", "half", " ", "its", " ", "neighbors"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"interindices", "=", 
            RowBox[{"Sort", "@", 
             RowBox[{"Rest", "@", 
              RowBox[{"Tuples", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"0", ",", "1", ",", 
                  RowBox[{"-", "1"}]}], "}"}], ",", 
                RowBox[{"Length", "@", "brvectors"}]}], "]"}]}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"!", 
              RowBox[{"OptionValue", "[", "BackwardInterlink", "]"}]}], ",", 
             RowBox[{"interindices", "=", 
              RowBox[{
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{"Length", "@", "#"}], "/", "2"}], "+", "1"}], 
                   ";;"}], "]"}], "]"}], "&"}], "@", "interindices"}]}]}], 
            "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "Extract", " ", "intercell", " ", "links", " ", "from", " ", 
              "HBloch", " ", "matrices"}], ",", " ", 
             RowBox[{"in", " ", "the", " ", "form", " ", 
              RowBox[{"{", 
               RowBox[{"i", ",", "j"}], "}"}]}]}], "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"Hinterlinks", "=", 
            RowBox[{"interindices", "/.", 
             RowBox[{"system", "[", "\"\<HBloch\>\"", "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"interlinks", "=", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{"(*", 
                RowBox[{
                 RowBox[{
                  RowBox[{"DeleteCases", "[", 
                   RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"i_", ",", "i_"}], "}"}]}], "]"}], "&"}], "@"}], 
                "*)"}], 
               RowBox[{"DeleteDuplicates", "[", 
                RowBox[{
                 RowBox[{"Most", "[", 
                  RowBox[{"ArrayRules", "[", "#", "]"}], "]"}], "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "1", ",", 
                   RowBox[{"{", 
                    RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "]"}], "]"}], 
               ")"}], "&"}], "/@", "Hinterlinks"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "Keep", " ", "only", " ", "matrix", " ", "elements", " ", "of", 
             " ", "interlinks"}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"Hinterlinks", "=", 
            RowBox[{"MapThread", "[", 
             RowBox[{
              RowBox[{"Function", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"HBloch", ",", "links"}], "}"}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"HBloch", "[", 
                   RowBox[{"[", 
                    RowBox[{"Sequence", "@@", "#"}], "]"}], "]"}], "&"}], "/@",
                  "links"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"Hinterlinks", ",", " ", "interlinks"}], "}"}]}], 
             "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{"Find", " ", "position", " ", "of", " ", "linked", " ", 
             RowBox[{"sites", "."}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"flatsites", "=", 
               RowBox[{"Flatten", "[", 
                RowBox[{"sites", ",", " ", "1"}], "]"}]}], "}"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"interlines", "=", 
              RowBox[{"MapThread", "[", 
               RowBox[{
                RowBox[{"Function", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"links", ",", " ", "shiftindex"}], "}"}], ",", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"flatsites", "[", 
                    RowBox[{"[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"shiftindex", ".", "brvectors"}], " ", "+", 
                    RowBox[{"flatsites", "[", 
                    RowBox[{"[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}]}]}], "}"}], 
                    "&"}], "/@", "links"}]}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"interlinks", ",", "interindices"}], "}"}]}], 
               "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"OptionValue", "@", "LinkTooltips"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"primitives", "=", 
              RowBox[{"Prepend", "[", 
               RowBox[{"primitives", ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"OptionValue", "[", "LinkColor", "]"}], ",", 
                  RowBox[{"Lighter", "[", 
                   RowBox[{
                    RowBox[{"OptionValue", "[", "LinkColor", "]"}], ",", 
                    "lighterfraction"}], "]"}], ",", 
                  RowBox[{"MapThread", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Tooltip", "[", 
                    RowBox[{
                    RowBox[{"Line", "[", "#1", "]"}], ",", 
                    RowBox[{"MatrixForm", "[", "#2", "]"}]}], "]"}], "&"}], 
                    ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Flatten", "[", 
                    RowBox[{"interlines", ",", "1"}], "]"}], ",", 
                    RowBox[{"Flatten", "[", 
                    RowBox[{"Hinterlinks", ",", "1"}], "]"}]}], "}"}]}], 
                   "]"}]}], "}"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"primitives", "=", 
              RowBox[{"Prepend", "[", 
               RowBox[{"primitives", ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"OptionValue", "[", "LinkColor", "]"}], ",", 
                  RowBox[{"Lighter", "[", 
                   RowBox[{
                    RowBox[{"OptionValue", "[", "LinkColor", "]"}], ",", 
                    "lighterfraction"}], "]"}], ",", 
                  RowBox[{"Line", "[", 
                   RowBox[{"Flatten", "[", 
                    RowBox[{"interlines", ",", "1"}], "]"}], "]"}]}], "}"}]}],
                "]"}]}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
         "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Dim", " ", "and", " ", "shift", " ", "unit", " ", "cells"}],
          "*)"}], "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"unitcells", ">", "1"}], ",", "\[IndentingNewLine]", 
          RowBox[{"primitives", "=", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Sequence", "@@", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"Translate", "[", 
                   RowBox[{"primitives", ",", "#"}], "]"}], "&"}], "/@", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"Rest", "@", 
                    RowBox[{"Tuples", "[", 
                    RowBox[{
                    RowBox[{"Range", "[", 
                    RowBox[{"0", ",", 
                    RowBox[{"unitcells", "-", "1"}]}], "]"}], ",", 
                    RowBox[{"Length", "@", "brvectors"}]}], "]"}]}], ".", 
                   "brvectors"}], ")"}]}], "/.", 
                RowBox[{"{", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"RGBColor", "[", "a__", "]"}], ":>", 
                   RowBox[{"Lighter", "[", 
                    RowBox[{
                    RowBox[{"RGBColor", "[", "a", "]"}], ",", 
                    "lighterfraction"}], "]"}]}], ",", "\[IndentingNewLine]", 
                  
                  RowBox[{
                   RowBox[{"CMYKColor", "[", "a__", "]"}], ":>", 
                   RowBox[{"Lighter", "[", 
                    RowBox[{
                    RowBox[{"CMYKColor", "[", "a", "]"}], ",", 
                    "lighterfraction"}], "]"}]}], ",", "\[IndentingNewLine]", 
                  
                  RowBox[{
                   RowBox[{"Hue", "[", "a_", "]"}], ":>", 
                   RowBox[{"Lighter", "[", 
                    RowBox[{
                    RowBox[{"Hue", "[", "a", "]"}], ",", "lighterfraction"}], 
                    "]"}]}], ",", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"GrayLevel", "[", "a_", "]"}], ":>", 
                   RowBox[{"Lighter", "[", 
                    RowBox[{
                    RowBox[{"GrayLevel", "[", "a", "]"}], ",", 
                    "lighterfraction"}], "]"}]}]}], "}"}]}], ")"}]}], ",", 
             "\[IndentingNewLine]", "primitives"}], "}"}]}]}], 
         "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"primitives", "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"PointSize", "[", "Large", "]"}], ",", 
        RowBox[{"Sequence", "@@", 
         RowBox[{"Flatten", "[", 
          RowBox[{"{", 
           RowBox[{"OptionValue", "[", "PlotDirectives", "]"}], "}"}], 
          "]"}]}], ",", "primitives"}], "}"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"embdim", "\[Equal]", "3"}], "&&", 
        RowBox[{"NumericQ", "[", 
         RowBox[{"OptionValue", "[", "LinkRadius", "]"}], "]"}]}], ",", " ", 
       RowBox[{"primitives", "=", 
        RowBox[{"primitives", "/.", 
         RowBox[{
          RowBox[{"Line", "[", "aux_", "]"}], "->", 
          RowBox[{"Tube", "[", 
           RowBox[{"aux", ",", 
            RowBox[{"OptionValue", "[", "LinkRadius", "]"}]}], "]"}]}]}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "@", "vertexcolors"}], "===", "Function"}], ",", 
       RowBox[{"vertexcolors", "=", 
        RowBox[{"vertexcolors", "/@", 
         RowBox[{"Flatten", "[", 
          RowBox[{"sites", ",", "1"}], "]"}]}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"ListQ", "[", "vertexcolors", "]"}], ",", " ", 
       RowBox[{
        RowBox[{"primitives", "=", 
         RowBox[{"primitives", "/.", 
          RowBox[{
           RowBox[{"Line", "[", 
            RowBox[{"aux_", "?", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"MatrixQ", "[", 
                RowBox[{"#", ",", "IntegerQ"}], "]"}], "&"}], ")"}]}], "]"}], 
           "\[RuleDelayed]", 
           RowBox[{"(", 
            RowBox[{"Line", "[", 
             RowBox[{"aux", ",", 
              RowBox[{"VertexColors", "->", 
               RowBox[{"Map", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"vertexcolors", "[", 
                   RowBox[{"[", "#", "]"}], "]"}], "&"}], ",", "aux", ",", 
                 RowBox[{"{", "2", "}"}]}], "]"}]}]}], "]"}], ")"}]}]}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"primitives", "=", 
         RowBox[{"primitives", "/.", 
          RowBox[{
           RowBox[{"Tube", "[", 
            RowBox[{
             RowBox[{"pts_", "?", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"MatrixQ", "[", 
                 RowBox[{"#", ",", "IntegerQ"}], "]"}], "&"}], ")"}]}], ",", 
             " ", "radius_"}], "]"}], "\[RuleDelayed]", 
           RowBox[{"Tube", "[", 
            RowBox[{"pts", ",", "radius", ",", 
             RowBox[{"VertexColors", "->", 
              RowBox[{"Map", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"vertexcolors", "[", 
                  RowBox[{"[", "#", "]"}], "]"}], "&"}], ",", "pts", ",", 
                RowBox[{"{", "2", "}"}]}], "]"}]}]}], "]"}]}]}]}]}]}], "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Switch", "[", 
      RowBox[{"embdim", ",", "\[IndentingNewLine]", "3", ",", 
       RowBox[{"Return", "[", 
        RowBox[{"Graphics3D", "[", 
         RowBox[{"primitives", ",", " ", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", 
            RowBox[{"Options", "[", "Graphics3D", "]"}]}], "]"}], ",", 
          RowBox[{"Lighting", "\[Rule]", "\"\<Neutral\>\""}], ",", 
          RowBox[{"Boxed", "\[Rule]", "False"}]}], "]"}], "]"}], ",", 
       "\[IndentingNewLine]", "2", ",", 
       RowBox[{"Return", "[", 
        RowBox[{"Graphics", "[", 
         RowBox[{"primitives", ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", 
            RowBox[{"Options", "[", "Graphics", "]"}]}], "]"}]}], "]"}], 
        "]"}], ",", "\[IndentingNewLine]", "1", ",", 
       RowBox[{"Return", "[", 
        RowBox[{"Graphics", "[", 
         RowBox[{"primitives", ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", 
            RowBox[{"Options", "[", "Graphics", "]"}]}], "]"}]}], "]"}], 
        "]"}], ",", "\[IndentingNewLine]", "_", ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"PlotLattice", "::", "dim"}], ",", "embdim"}], "]"}], ";", 
        RowBox[{"Return", "[", "$Failed", "]"}]}]}], "\[IndentingNewLine]", 
      "]"}]}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.597739945900278*^9, 3.59773999821329*^9}, {
   3.597740184070058*^9, 3.5977405537670918`*^9}, {3.59774066257753*^9, 
   3.597740667391852*^9}, {3.597740697736176*^9, 3.597740733277729*^9}, {
   3.597740764191167*^9, 3.5977409102230253`*^9}, {3.597740950780052*^9, 
   3.597741179847508*^9}, {3.597741237085285*^9, 3.597741287105259*^9}, 
   3.597741499663904*^9, {3.597742460023376*^9, 3.597742485478051*^9}, {
   3.597742545283328*^9, 3.597742582464641*^9}, {3.597742666670236*^9, 
   3.597742677920848*^9}, {3.5977427581933126`*^9, 3.5977427905278788`*^9}, {
   3.597742828749881*^9, 3.597742863362919*^9}, {3.597742900915057*^9, 
   3.597742982697514*^9}, {3.5977430154573803`*^9, 3.59774301561637*^9}, {
   3.59774645344343*^9, 3.597746456220495*^9}, {3.597746858863566*^9, 
   3.597747047744404*^9}, {3.5977471007582483`*^9, 3.597747208340727*^9}, {
   3.5977472599104843`*^9, 3.5977474886442413`*^9}, {3.597747622018354*^9, 
   3.5977476509291058`*^9}, {3.597747795274311*^9, 3.597747807240093*^9}, 
   3.597747929792294*^9, {3.597747971721328*^9, 3.597747976332365*^9}, {
   3.597748108173403*^9, 3.59774812370864*^9}, {3.597748170150991*^9, 
   3.597748176867311*^9}, {3.597751201375729*^9, 3.5977512379660873`*^9}, {
   3.597751301667211*^9, 3.5977513138135777`*^9}, {3.59775137437193*^9, 
   3.597751377700247*^9}, {3.597752017244862*^9, 3.597752034819851*^9}, {
   3.597752078602339*^9, 3.597752121710284*^9}, {3.5977522072043753`*^9, 
   3.5977522440193644`*^9}, {3.597752316708395*^9, 3.597752568505034*^9}, {
   3.597752610410177*^9, 3.597752757637186*^9}, {3.597752802108652*^9, 
   3.597752904495076*^9}, {3.597756172609714*^9, 3.597756194146915*^9}, {
   3.5977562926292887`*^9, 3.597756393195757*^9}, {3.597756443658709*^9, 
   3.5977565859018*^9}, {3.597757020474349*^9, 3.597757083309824*^9}, {
   3.597757159945653*^9, 3.597757167159387*^9}, {3.597757743027801*^9, 
   3.5977577512159653`*^9}, {3.597757786117798*^9, 3.5977578769447927`*^9}, {
   3.5977579317573223`*^9, 3.59775805300666*^9}, {3.5977581174979067`*^9, 
   3.5977582159932823`*^9}, {3.597758255904139*^9, 3.597758256302081*^9}, {
   3.597758432034577*^9, 3.5977585533553953`*^9}, {3.597758587001471*^9, 
   3.597758588664427*^9}, {3.5977586308557262`*^9, 3.5977588930783873`*^9}, {
   3.597758951750498*^9, 3.597759102271422*^9}, {3.5977592975614347`*^9, 
   3.597759524918977*^9}, {3.597759637618328*^9, 3.597759751921885*^9}, {
   3.597766103509592*^9, 3.597766104989923*^9}, {3.597766396951148*^9, 
   3.597766415765195*^9}, {3.59776726668731*^9, 3.597767555633988*^9}, {
   3.597767628205634*^9, 3.597767648658016*^9}, {3.5977754988918056`*^9, 
   3.597775506171276*^9}, {3.5977756064050913`*^9, 3.597775610828487*^9}, {
   3.597775665000207*^9, 3.597775665639683*^9}, {3.597775707379669*^9, 
   3.597775797824976*^9}, {3.597775837198365*^9, 3.597775875960037*^9}, {
   3.59777590877489*^9, 3.597775915160358*^9}, 3.597776097789877*^9, 
   3.59777745539788*^9, 3.597777525280076*^9, {3.5977833833252783`*^9, 
   3.5977833912285337`*^9}, {3.597851316732986*^9, 3.5978513626248837`*^9}, {
   3.59785145672815*^9, 3.597851470183527*^9}, {3.597851535834483*^9, 
   3.5978515411794233`*^9}, {3.597864026950725*^9, 3.597864027293885*^9}, {
   3.597865116778113*^9, 3.597865159267045*^9}, {3.597943235686315*^9, 
   3.597943236908448*^9}, {3.5982483860379257`*^9, 3.598248386516176*^9}, {
   3.5983519756464043`*^9, 3.598352030980228*^9}, 3.6034482890312347`*^9, {
   3.6034483523699703`*^9, 3.603448352979611*^9}, {3.61475024680024*^9, 
   3.614750288398096*^9}, {3.614751306536523*^9, 3.614751307022333*^9}, {
   3.6147513809867077`*^9, 3.6147514914534807`*^9}, {3.619874667167635*^9, 
   3.6198747146304607`*^9}, {3.6198747533169823`*^9, 3.61987477240275*^9}, {
   3.619874843396719*^9, 3.619874852427182*^9}, {3.619875474020698*^9, 
   3.6198754944191437`*^9}, {3.6198762993536577`*^9, 3.619876493992096*^9}, {
   3.619876572763371*^9, 3.619876672493425*^9}, {3.619876742669566*^9, 
   3.619876821696333*^9}, {3.619876901399192*^9, 3.619876902996377*^9}, {
   3.6198784003729563`*^9, 3.619878578680769*^9}, {3.619878646946351*^9, 
   3.619878782567709*^9}, {3.61988133352943*^9, 3.619881334544526*^9}, {
   3.620299293939597*^9, 3.620299294066752*^9}, {3.620299367808378*^9, 
   3.6202994034049463`*^9}, 3.620300413236883*^9, {3.62158654398245*^9, 
   3.6215866085151567`*^9}, {3.6215866435133944`*^9, 3.621586671040312*^9}, {
   3.6215867129573383`*^9, 3.621586762420525*^9}, {3.624336979829081*^9, 
   3.624337022000206*^9}, {3.6243371044443703`*^9, 3.624337114484138*^9}, {
   3.624337224678308*^9, 3.624337249388509*^9}, {3.6243372996108522`*^9, 
   3.6243373287599583`*^9}, {3.624337361305903*^9, 3.624337371119445*^9}, {
   3.624337421188177*^9, 3.624337444306336*^9}, 3.624337537241261*^9, {
   3.624337571315467*^9, 3.624337623041772*^9}, {3.624341630778143*^9, 
   3.6243417328169813`*^9}, {3.624342004011835*^9, 3.624342004746435*^9}, {
   3.624342109726242*^9, 3.6243421401559277`*^9}, {3.6243421912603493`*^9, 
   3.62434232423647*^9}, {3.624342426160226*^9, 3.6243424313507137`*^9}, {
   3.6243424637421513`*^9, 3.624342484826543*^9}, {3.624342519664476*^9, 
   3.624342531296823*^9}, {3.6243426786164217`*^9, 3.624342708687098*^9}, {
   3.624342893542363*^9, 3.62434290531669*^9}, {3.6243429604279222`*^9, 
   3.624342981515284*^9}, {3.624343018735867*^9, 3.624343067611834*^9}, {
   3.624343106010756*^9, 3.62434311321717*^9}, {3.6243434594645557`*^9, 
   3.624343488470421*^9}, {3.624343550906732*^9, 3.624343607096818*^9}, {
   3.624343671919365*^9, 3.624343805062008*^9}, {3.6243438354862833`*^9, 
   3.624343843917899*^9}, {3.6243439872079782`*^9, 3.624344033938074*^9}, {
   3.62434406802494*^9, 3.6243441484049263`*^9}, {3.624344261022881*^9, 
   3.624344265879051*^9}, {3.624344377954116*^9, 3.6243444344081182`*^9}, {
   3.624344481430954*^9, 3.624344543336445*^9}, {3.624344850977374*^9, 
   3.624344975906802*^9}, {3.6243451449297457`*^9, 3.624345155760297*^9}, {
   3.6243452934043913`*^9, 3.6243453144247713`*^9}, {3.6243454207166147`*^9, 
   3.624345689982094*^9}, {3.624345733387397*^9, 3.624345741802087*^9}, {
   3.6243457846109743`*^9, 3.6243458447980623`*^9}, {3.624346174780304*^9, 
   3.6243462475352163`*^9}, {3.624346293726555*^9, 3.6243463373559313`*^9}, {
   3.624346519018147*^9, 3.624346548327581*^9}, {3.624346667514557*^9, 
   3.6243466888889723`*^9}, {3.624346819291911*^9, 3.62434684724149*^9}, {
   3.624346895687923*^9, 3.6243468983347063`*^9}, {3.624346953549411*^9, 
   3.6243470376064*^9}, {3.62434707918862*^9, 3.624347093236149*^9}, {
   3.6243471306736717`*^9, 3.624347153034375*^9}, {3.624347895265587*^9, 
   3.624347897784992*^9}, {3.624347983654784*^9, 3.6243480394657927`*^9}, {
   3.624348181203001*^9, 3.624348264340073*^9}, {3.624348339138954*^9, 
   3.624348426485737*^9}, {3.624348477844185*^9, 3.6243485928311863`*^9}, {
   3.624348671961293*^9, 3.6243487459971857`*^9}, {3.6243487956351013`*^9, 
   3.624348812498831*^9}, {3.624348855167968*^9, 3.62434907906077*^9}, {
   3.624349139659388*^9, 3.624349298522087*^9}, {3.624349343952095*^9, 
   3.624349398884058*^9}, {3.62434947055376*^9, 3.624349522381968*^9}, {
   3.62434955504606*^9, 3.624349635795081*^9}, {3.624349921928474*^9, 
   3.624350012107692*^9}, 3.624350121220708*^9, {3.624350177739401*^9, 
   3.624350273984586*^9}, {3.624350304288555*^9, 3.624350523740387*^9}, {
   3.62435058103146*^9, 3.624350630579982*^9}, {3.624352992571989*^9, 
   3.6243530026266203`*^9}, {3.62435303468854*^9, 3.624353047167906*^9}, 
   3.62435308784153*^9, {3.624353124451881*^9, 3.624353209448484*^9}, {
   3.624353540898138*^9, 3.6243535621100817`*^9}, {3.624353743608799*^9, 
   3.624353813704434*^9}, {3.6243538585460052`*^9, 3.624353859687859*^9}, {
   3.624353902165962*^9, 3.624353969265174*^9}, {3.6243541672491713`*^9, 
   3.6243542131343527`*^9}, {3.624354519465554*^9, 3.6243545356809063`*^9}, {
   3.624354655849287*^9, 3.624354671970052*^9}, {3.624355044301209*^9, 
   3.624355045101555*^9}, {3.624355133336368*^9, 3.624355168560273*^9}, {
   3.624355210629846*^9, 3.6243552341971693`*^9}, {3.6243560621348553`*^9, 
   3.6243560845694847`*^9}, {3.6243561230486927`*^9, 3.624356125911621*^9}, {
   3.62435616265347*^9, 3.624356162871458*^9}, 3.624356193900837*^9, {
   3.62435629057062*^9, 3.624356290848466*^9}, {3.624356378565604*^9, 
   3.6243565594033337`*^9}, {3.624356618868174*^9, 3.624356662149527*^9}, {
   3.624357544731461*^9, 3.6243575802338057`*^9}, {3.624357611866544*^9, 
   3.624357620959777*^9}, {3.624357732388399*^9, 3.624357796215868*^9}, {
   3.6243579374656897`*^9, 3.624357949968306*^9}, {3.624358016575931*^9, 
   3.624358171383753*^9}, {3.624358203028594*^9, 3.6243582063809443`*^9}, {
   3.6243583894857903`*^9, 3.6243584064191303`*^9}, 3.6243584587374773`*^9, 
   3.624358491935618*^9, {3.624358621098674*^9, 3.6243586216217337`*^9}, 
   3.624358658552959*^9, {3.624359140657666*^9, 3.624359189231063*^9}, {
   3.625485004136282*^9, 3.625485010024024*^9}, {3.629641780128089*^9, 
   3.629641783695938*^9}, {3.630926048642983*^9, 3.630926075992861*^9}, 
   3.635236092808476*^9, {3.635240695535404*^9, 3.635240791810055*^9}, {
   3.635240920269607*^9, 3.635240984386608*^9}, {3.635241014817174*^9, 
   3.635241029742895*^9}, {3.6352415917396107`*^9, 3.635241622600535*^9}, {
   3.6352436597650757`*^9, 3.635243693674564*^9}, {3.635244072200528*^9, 
   3.635244118461038*^9}, {3.635589270018414*^9, 3.635589282955861*^9}, {
   3.635589467482524*^9, 3.635589486499586*^9}, {3.63566213805917*^9, 
   3.635662141571309*^9}, {3.6356630194243917`*^9, 3.635663249635487*^9}, {
   3.635663602635227*^9, 3.635663603564465*^9}, {3.635664288370338*^9, 
   3.6356642906809893`*^9}, 3.6356644033577557`*^9, {3.635664550622488*^9, 
   3.6356645512936993`*^9}, {3.6363582932378397`*^9, 3.636358301789733*^9}, {
   3.63661517553614*^9, 3.636615314598527*^9}, {3.6366153504368668`*^9, 
   3.636615352092252*^9}, {3.636615384494183*^9, 3.636615555197569*^9}, {
   3.6366157212086563`*^9, 3.636615726894021*^9}, {3.636615769103876*^9, 
   3.6366158411481524`*^9}, 3.63739272794267*^9, {3.637392811182863*^9, 
   3.6373928136890097`*^9}, {3.639819682262381*^9, 3.63981968279725*^9}, {
   3.6592599790654507`*^9, 3.659260017375065*^9}, {3.6593327448910637`*^9, 
   3.659332745625229*^9}, {3.659332829752158*^9, 3.6593328573900537`*^9}, 
   3.65933292220759*^9, 3.6593329809163094`*^9, {3.6593330424779882`*^9, 
   3.659333076645155*^9}, {3.659333192998217*^9, 3.65933319319842*^9}, {
   3.659333554908752*^9, 3.659333555051758*^9}, {3.659334842246986*^9, 
   3.659334846285952*^9}, {3.659335134296329*^9, 3.659335249704588*^9}, {
   3.659335301630831*^9, 3.6593353798049507`*^9}, {3.659349002496879*^9, 
   3.6593490032154713`*^9}, {3.65934992513194*^9, 3.659350017359519*^9}, {
   3.659350981471846*^9, 3.659351092154237*^9}, {3.659435207670993*^9, 
   3.659435257636195*^9}, 3.6671970249546003`*^9, {3.667293868741808*^9, 
   3.667293934939492*^9}, {3.667294075364876*^9, 3.667294134218811*^9}, {
   3.6672941689921083`*^9, 3.6672942459251757`*^9}, {3.674016122394991*^9, 
   3.674016140643462*^9}, {3.6740162258736277`*^9, 3.67401631000797*^9}, {
   3.6740164704237747`*^9, 3.674016585897297*^9}, {3.674016621663372*^9, 
   3.674016626454762*^9}, {3.674016756647979*^9, 3.674016772622773*^9}, {
   3.674016810951565*^9, 3.674016812403117*^9}, {3.674017542350608*^9, 
   3.6740175657284613`*^9}, {3.674017622453898*^9, 3.6740176857652473`*^9}, {
   3.674017720460023*^9, 3.674017757203816*^9}, {3.67401792517134*^9, 
   3.6740179330645027`*^9}, {3.6741971429319077`*^9, 3.674197144012629*^9}, {
   3.679817791468697*^9, 3.679817836457807*^9}, {3.679818042123856*^9, 
   3.6798181036189404`*^9}, {3.679818154932239*^9, 3.679818227647563*^9}, {
   3.68457783751292*^9, 3.684577845100462*^9}, {3.6845778799217997`*^9, 
   3.6845779123698587`*^9}, 3.684577958403243*^9, {3.6846614446529837`*^9, 
   3.684661525301009*^9}, {3.684661620614011*^9, 3.684661621405299*^9}, {
   3.684661685562643*^9, 3.684661711184363*^9}, 3.684661763222722*^9, {
   3.68466204911983*^9, 3.68466207989782*^9}, {3.684662122717824*^9, 
   3.684662217664811*^9}, {3.684664688397709*^9, 3.684664723638644*^9}, {
   3.707565539342204*^9, 3.707565543633699*^9}, {3.707565617766841*^9, 
   3.707565626774639*^9}, {3.707565718774147*^9, 3.7075657197326317`*^9}, {
   3.707566683855566*^9, 3.707566691757032*^9}, {3.707566740068618*^9, 
   3.707566749675592*^9}, {3.707566787479154*^9, 3.707566805683957*^9}, {
   3.70772639630471*^9, 3.7077264092119207`*^9}, {3.707726514829813*^9, 
   3.70772653471471*^9}, 3.707726564811256*^9, {3.707726604863163*^9, 
   3.707726605053348*^9}, {3.708064274349002*^9, 3.7080645256335487`*^9}, {
   3.708064568088497*^9, 3.708064571375658*^9}, {3.7080646028163443`*^9, 
   3.708064627254902*^9}, {3.708064670790923*^9, 3.708064691743434*^9}, 
   3.708064725746047*^9, {3.7080647794623404`*^9, 3.7080648002369204`*^9}, {
   3.70806484476875*^9, 3.708064859790339*^9}, {3.708065199638652*^9, 
   3.7080652256153383`*^9}, {3.70806530929396*^9, 3.708065445731413*^9}, {
   3.708065486043495*^9, 3.70806554813513*^9}, {3.708065580010866*^9, 
   3.708065623103249*^9}, {3.708065653151436*^9, 3.7080656536784897`*^9}, 
   3.708065762363023*^9, {3.7080658083329067`*^9, 3.70806582190092*^9}, {
   3.708065899660534*^9, 3.708065918573247*^9}, {3.708065999035193*^9, 
   3.7080661021405153`*^9}, {3.7080662103289967`*^9, 3.708066211037875*^9}, {
   3.7080662584621363`*^9, 3.70806627568821*^9}, {3.708066666520589*^9, 
   3.708066706841055*^9}, {3.708066762142968*^9, 3.708066821824422*^9}, {
   3.708067488322629*^9, 3.7080675021237803`*^9}, {3.7135264852538424`*^9, 
   3.713526487867766*^9}, {3.713594061634094*^9, 3.713594081936082*^9}, 
   3.713594516758533*^9, {3.719042186590034*^9, 3.719042206629827*^9}, {
   3.745305512487331*^9, 3.745305551260478*^9}, {3.745305933227848*^9, 
   3.74530595514072*^9}, {3.745306187319615*^9, 3.745306192636709*^9}, {
   3.7453062966497602`*^9, 3.7453065522895327`*^9}, {3.7453067969790783`*^9, 
   3.745306871968009*^9}, {3.745306907692253*^9, 3.745306910405642*^9}, {
   3.745306943332847*^9, 3.745306943602854*^9}, {3.745307004887789*^9, 
   3.74530708754668*^9}, {3.7453071882005568`*^9, 3.745307253867937*^9}, {
   3.74530728811779*^9, 3.745307289740116*^9}, {3.745307327943438*^9, 
   3.745307418377903*^9}, {3.745307458118883*^9, 3.745307463460389*^9}, {
   3.74530753129543*^9, 3.7453075336393127`*^9}, {3.7453095192341022`*^9, 
   3.745309625823222*^9}},
 CellLabel->
  "In[135]:=",ExpressionUUID->"f37536ec-0aed-4cbb-9be1-8883fef5d0f4"],

Cell[BoxData["\<\"Option for PlotLattice that specifies the line style of the \
cell bounding boxes.\"\>"], "Output",
 CellChangeTimes->{
  3.708066823279109*^9, 3.70806750510211*^9, 3.708075326120408*^9, 
   3.708075788671843*^9, 3.7080758947868357`*^9, {3.708082984908485*^9, 
   3.7080830022855587`*^9}, 3.708322255791037*^9, 3.708323102741085*^9, 
   3.708323182822081*^9, 3.713594102695718*^9, 3.713594528270351*^9, 
   3.719042213692822*^9, 3.745306874234088*^9, 3.7453069108920193`*^9, 
   3.745306953291586*^9, {3.7453070414354753`*^9, 3.7453070640098333`*^9}, 
   3.7453070941305227`*^9, {3.745307236343471*^9, 3.745307291799375*^9}, {
   3.745307356181484*^9, 3.7453073637562847`*^9}, 3.745307405479972*^9, 
   3.745307464617697*^9, 3.745307553176955*^9, {3.7453095262080097`*^9, 
   3.745309554504578*^9}, {3.745309609259594*^9, 3.74530962682966*^9}, 
   3.760356003580821*^9, 3.784528377334044*^9, 3.784530211319593*^9},
 CellLabel->
  "Out[152]=",ExpressionUUID->"103dc98c-4374-4dfb-ba68-0a48f20d8aea"]
}, Open  ]],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"PlotLattice", "[", 
    RowBox[{
     RowBox[{"{", "lattices__MQLattice", "}"}], ",", 
     RowBox[{"{", "systems___MQSystem", "}"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"numlattices", "=", 
        RowBox[{"Length", "[", 
         RowBox[{"{", "lattices", "}"}], "]"}]}], ",", "options", ",", " ", 
       "aux"}], "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Define", " ", "colors", " ", "for", " ", "each", " ", "lattice"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"MatrixQ", "[", 
          RowBox[{"OptionValue", "[", "SiteColors", "]"}], "]"}], "&&", 
         RowBox[{
          RowBox[{"Length", "[", 
           RowBox[{"OptionValue", "[", "SiteColors", "]"}], "]"}], "\[Equal]",
           "numlattices"}]}], ",", " ", 
        RowBox[{"options", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"{", "opts", "}"}], "/.", 
            RowBox[{
             RowBox[{"Rule", "[", 
              RowBox[{"SiteColors", ",", "aux_"}], "]"}], ":>", 
             RowBox[{"Rule", "[", 
              RowBox[{"SiteColors", ",", 
               RowBox[{"aux", "[", 
                RowBox[{"[", "i", "]"}], "]"}]}], "]"}]}]}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "1", ",", " ", "numlattices"}], "}"}]}], 
          "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "SiteColors", "]"}], "===", 
           "Automatic"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"aux", "=", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"MemberQ", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", 
                RowBox[{"Rule", "[", 
                 RowBox[{"SiteColors", ",", "_"}], "]"}]}], "]"}], ",", 
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"opts", ",", 
                RowBox[{"SiteColors", "\[Rule]", "Automatic"}]}], "}"}]}], 
             "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"options", "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"aux", "/.", 
               RowBox[{
                RowBox[{"Rule", "[", 
                 RowBox[{"SiteColors", ",", "_"}], "]"}], "\[Rule]", 
                RowBox[{"Rule", "[", 
                 RowBox[{"SiteColors", ",", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"i", "\[Equal]", "1"}], ",", "Automatic", ",", 
                    "47"}], "]"}]}], "]"}]}]}], ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", "1", ",", " ", "numlattices"}], "}"}]}], 
             "]"}]}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"options", "=", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", "numlattices"}], "]"}]}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "@", 
          RowBox[{"{", "systems", "}"}]}], "==", 
         RowBox[{"Length", "@", 
          RowBox[{"{", "lattices", "}"}]}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"Show", "[", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"PlotLattice", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"{", "lattices", "}"}], "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", 
             RowBox[{
              RowBox[{"{", "systems", "}"}], "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", 
             RowBox[{"options", "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "1", ",", "numlattices"}], "}"}]}], "]"}], 
         "]"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Show", "[", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"PlotLattice", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"{", "lattices", "}"}], "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", 
             RowBox[{"options", "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "1", ",", "numlattices"}], "}"}]}], "]"}], 
         "]"}]}], "]"}]}]}], "]"}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotLattice", "[", 
   RowBox[{
    RowBox[{"{", "lattices__MQLattice", "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"PlotLattice", "[", 
   RowBox[{
    RowBox[{"{", "lattices", "}"}], ",", 
    RowBox[{"{", "}"}], ",", "opts"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotLattice", "[", 
    RowBox[{
     RowBox[{"{", "lattices__MQLattice", "}"}], ",", 
     "scatsys_MQScatteringSystem", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"PlotLattice", "[", 
    RowBox[{
     RowBox[{"{", "lattices", "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"scatsys", "[", "\"\<Central\>\"", "]"}], ",", 
       RowBox[{"Sequence", "@@", 
        RowBox[{"scatsys", "[", "\"\<Leads\>\"", "]"}]}]}], "}"}], ",", 
     "opts"}], "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotLattice", "[", 
   RowBox[{
    RowBox[{"system_MQSystem", "|", "system_MQSpringMesh"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"lattice", "=", 
      RowBox[{"system", "[", "\"\<Lattice\>\"", "]"}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"lattice", "===", 
       RowBox[{"Missing", "[", "]"}]}], ",", 
      RowBox[{"Message", "[", 
       RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ",", 
      RowBox[{"PlotLattice", "[", 
       RowBox[{"lattice", ",", "system", ",", " ", "opts"}], "]"}]}], "]"}]}],
    "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotLattice", "[", 
    RowBox[{"systems__MQSystem", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"lattices", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"#", "[", "\"\<Lattice\>\"", "]"}], "&"}], "/@", 
        RowBox[{"{", "systems", "}"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
     
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"MemberQ", "[", 
        RowBox[{"lattices", ",", 
         RowBox[{"Missing", "[", "]"}]}], "]"}], ",", 
       RowBox[{"Message", "[", 
        RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ",", 
       RowBox[{"PlotLattice", "[", 
        RowBox[{"lattices", ",", 
         RowBox[{"{", "systems", "}"}], ",", " ", "opts"}], "]"}]}], "]"}]}], 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotLattice", "[", 
   RowBox[{"mesh_MQGradientMesh", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"PlotLattice", "[", 
   RowBox[{
    RowBox[{"mesh", "[", "\"\<System\>\"", "]"}], ",", " ", "opts"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotLattice", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"systems__MQSystem", "|", "systems__MQSpringMesh"}], "}"}], ",", 
    
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"lattices", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", "\"\<Lattice\>\"", "]"}], "&"}], "/@", 
       RowBox[{"{", "systems", "}"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"Or", "@@", 
       RowBox[{"Thread", "[", 
        RowBox[{"lattices", "===", 
         RowBox[{"Missing", "[", "]"}]}], "]"}]}], ",", 
      RowBox[{"Message", "[", 
       RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ",", 
      RowBox[{"PlotLattice", "[", 
       RowBox[{"lattices", ",", 
        RowBox[{"{", "systems", "}"}], ",", " ", "opts"}], "]"}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotLattice", "[", 
   RowBox[{"scatsys_MQScatteringSystem", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"lattices", ",", 
      RowBox[{"systems", "=", 
       RowBox[{"Prepend", "[", 
        RowBox[{
         RowBox[{"scatsys", "[", "\"\<Leads\>\"", "]"}], ",", 
         RowBox[{"scatsys", "[", "\"\<Central\>\"", "]"}]}], "]"}]}]}], "}"}],
     ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"lattices", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", "\"\<Lattice\>\"", "]"}], "&"}], "/@", 
       "systems"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Or", "@@", 
        RowBox[{"Thread", "[", 
         RowBox[{"lattices", "===", 
          RowBox[{"Missing", "[", "]"}]}], "]"}]}], ",", 
       RowBox[{"Message", "[", 
        RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ",", 
       RowBox[{"PlotLattice", "[", 
        RowBox[{
         RowBox[{"Flatten", "@", "lattices"}], ",", "systems", ",", " ", 
         "opts"}], "]"}]}], "]"}]}]}], 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.597943498839855*^9, 3.5979435599945803`*^9}, {
   3.5979436198608522`*^9, 3.5979439786909113`*^9}, {3.597944137885582*^9, 
   3.5979441409008427`*^9}, {3.5979441875845547`*^9, 3.597944204698989*^9}, {
   3.598248073202116*^9, 3.598248074434062*^9}, {3.598248121849807*^9, 
   3.598248168378522*^9}, {3.598248201203307*^9, 3.598248309137815*^9}, {
   3.598249132112811*^9, 3.598249137477695*^9}, {3.598249176531708*^9, 
   3.5982491779651327`*^9}, {3.598249227995035*^9, 3.598249232480516*^9}, {
   3.598249289666266*^9, 3.59824929028938*^9}, {3.598249375991289*^9, 
   3.598249442985323*^9}, {3.598249507213665*^9, 3.598249509828147*^9}, {
   3.598249588829702*^9, 3.598249589396475*^9}, {3.598249654284855*^9, 
   3.598249654571859*^9}, {3.619945889316193*^9, 3.619945890353839*^9}, {
   3.6199459609733057`*^9, 3.6199460253540163`*^9}, {3.619946109059132*^9, 
   3.619946167126813*^9}, 3.6243481584902573`*^9, {3.624358277406165*^9, 
   3.624358303876288*^9}, {3.6243586842997847`*^9, 3.6243586850019503`*^9}, {
   3.629641784395756*^9, 3.6296417867706747`*^9}, {3.635663612909596*^9, 
   3.635663613392868*^9}, {3.635663643732913*^9, 3.635663784022435*^9}, {
   3.635663852743113*^9, 3.635663898073386*^9}, {3.635663932278824*^9, 
   3.635663962457234*^9}, {3.637392742735751*^9, 3.6373927863437033`*^9}, 
   3.6465451214881363`*^9, {3.64654520536657*^9, 3.646545273246669*^9}, {
   3.656848105290663*^9, 3.656848134753602*^9}, {3.65684863414189*^9, 
   3.656848643699348*^9}, {3.656848674227165*^9, 3.656848723921652*^9}, {
   3.6570211564839354`*^9, 3.657021166088298*^9}, {3.6596934483592377`*^9, 
   3.6596935529431973`*^9}, {3.659693616278101*^9, 3.659693668371333*^9}, {
   3.6596937004821863`*^9, 3.659693741718238*^9}, {3.6596939434134083`*^9, 
   3.659693944468091*^9}},
 CellLabel->
  "In[158]:=",ExpressionUUID->"9b924cc7-0dbe-4345-a47b-b8037d3993c4"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"PlotField", "::", "usage"}], "=", 
   "\"\<Plots a field, in the form of a list of numerical vectors, one per \
site in lattice.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotFunction", "::", "usage"}], "=", 
   "\"\<Option for PlotField that specifies a function to be applied to the \
data at each site prior to plotting.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SelectSites", "::", "usage"}], "=", 
   "\"\<Option for PlotField that specifies a boolean function of (position, \
tag) which discriminates which sites to include in the plot. It may also be a \
list of boolean values corresponding to each site.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BubblePlot", "::", "usage"}], "=", 
   "\"\<Option for PlotField that specifies a fattened site plot \
style.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MaskRegion", "::", "usage"}], "=", 
   "\"\<Option for PlotField that specifies a boolean function that should be \
used to mask the output. Points which evaluate to false will be \
hidden.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MaskStyle", "::", "usage"}], "=", 
   "\"\<Option for PlotField that specifies the style of the masked region, \
defined by MaskRegion.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MaskBoundaryStyle", "::", "usage"}], "=", 
    "\"\<Option for PlotField that specifies the style of the mask \
boundary.\>\""}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "PlotField", "]"}], "=", 
    RowBox[{"DeleteDuplicates", "@", 
     RowBox[{"Flatten", "@", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Options", "[", "ListDensityPlot", "]"}], ",", 
        RowBox[{"Options", "[", "ListPlot", "]"}], ",", 
        RowBox[{"Options", "[", "PlotLattice", "]"}], ",", 
        RowBox[{"PlotFunction", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox[
            RowBox[{"Norm", "[", "#", "]"}], "2"], "&"}], ")"}]}], ",", " ", 
        "\[IndentingNewLine]", 
        RowBox[{"SelectSites", "\[Rule]", "All"}], ",", "\[IndentingNewLine]", 
        RowBox[{"BubblePlot", "\[Rule]", "False"}], ",", 
        RowBox[{"MaskRegion", "\[Rule]", "None"}], ",", 
        RowBox[{"MaskStyle", "\[Rule]", "White"}], ",", 
        RowBox[{"MaskBoundaryStyle", "\[Rule]", 
         RowBox[{"Directive", "[", 
          RowBox[{"Thick", ",", "Black"}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"Overlay", "\[Rule]", "False"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Options", "[", "BubbleChart", "]"}], ",", 
        RowBox[{"Options", "[", "RegionPlot", "]"}]}], "}"}]}]}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "We", " ", "need", " ", "to", " ", "use", " ", "Module", " ", "here", " ", 
    "to", " ", "avoid", " ", "conflict", " ", "with", " ", "function", " ", 
    "names", " ", "in", " ", "MaskRegion"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "fieldraw", " ", "is", " ", "a", " ", "list", " ", "of", " ", "dimensions",
     " ", 
    RowBox[{"{", 
     RowBox[{"numberofSites", ",", " ", "Sitedimensions"}], "}"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotField", "[", 
   RowBox[{"lattice_MQLattice", ",", 
    RowBox[{"fieldraw_List", "|", "fieldraw_SparseArray"}], ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"selectsites", "=", 
       RowBox[{"OptionValue", "[", "SelectSites", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"unitcells", "=", 
       RowBox[{"OptionValue", "[", "UnitCells", "]"}]}], ",", 
      "\[IndentingNewLine]", "included", ",", " ", "sites", ",", "tags", ",", 
      " ", "data", ",", "shifts", ",", " ", "field", ",", "gr", ",", "graux", 
      ",", "plat", ",", "adjustedplotrange", ",", "pad", ",", " ", "x", ",", 
      "y"}], "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"field", "=", 
      RowBox[{
       RowBox[{"OptionValue", "[", "PlotFunction", "]"}], "/@", 
       "fieldraw"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"sites", "=", 
      RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"tags", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"lattice", "[", "\"\<SiteTags\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"selectsites", "=!=", "All"}], ",", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"ListQ", "[", "selectsites", "]"}], ",", 
         RowBox[{"included", "=", "selectsites"}], ",", 
         RowBox[{"included", "=", 
          RowBox[{"MapThread", "[", 
           RowBox[{"selectsites", ",", 
            RowBox[{"{", 
             RowBox[{"sites", ",", "tags"}], "}"}]}], "]"}]}]}], "]"}], ",", 
       " ", 
       RowBox[{"included", "=", 
        RowBox[{
         RowBox[{"True", "&"}], "/@", "sites"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}], ">", 
        "2"}], ",", 
       RowBox[{"sites", "=", 
        RowBox[{"sites", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}], 
        "\[Equal]", "1"}], ",", " ", "\[IndentingNewLine]", 
       RowBox[{"gr", "=", 
        RowBox[{"ListLinePlot", "[", 
         RowBox[{
          RowBox[{"Sort", "@", 
           RowBox[{"Pick", "[", 
            RowBox[{
             RowBox[{"Flatten", "/@", 
              RowBox[{"Transpose", "@", 
               RowBox[{"{", 
                RowBox[{"sites", ",", "field"}], "}"}]}]}], ",", "included"}],
             "]"}]}], ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", 
            RowBox[{"Options", "[", "ListPlot", "]"}]}], "]"}], ",", 
          RowBox[{"AspectRatio", "\[Rule]", ".5"}], ",", " ", 
          RowBox[{"ImageSize", "\[Rule]", "250"}], ",", 
          RowBox[{"FrameLabel", "\[Rule]", 
           RowBox[{"{", 
            RowBox[{"\"\<x\>\"", ",", 
             RowBox[{"ToString", "[", "\"\<\[CapitalPsi]\>\"", "]"}]}], 
            "}"}]}], ",", "PlotDefaults"}], "]"}]}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"IntegerQ", "@", "unitcells"}], ",", "\[IndentingNewLine]", 
          
          RowBox[{
           RowBox[{"shifts", "=", 
            RowBox[{
             RowBox[{"Tuples", "[", 
              RowBox[{
               RowBox[{"Range", "[", 
                RowBox[{"0", ",", 
                 RowBox[{"unitcells", "-", "1"}]}], "]"}], ",", 
               RowBox[{"Length", "@", 
                RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}]}], 
              "]"}], ".", 
             RowBox[{
              RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", 
                RowBox[{"{", 
                 RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"sites", "=", 
            RowBox[{
             RowBox[{
              RowBox[{"Flatten", "[", 
               RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{"Map", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "+", 
                   RowBox[{"shifts", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], "&"}], ",", "sites"}], 
                "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"i", ",", "1", ",", 
                 RowBox[{"Length", "@", "shifts"}]}], "}"}]}], "]"}]}]}], ";",
            "\[IndentingNewLine]", 
           RowBox[{"included", "=", 
            RowBox[{
             RowBox[{
              RowBox[{"Flatten", "[", 
               RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
             RowBox[{"Array", "[", 
              RowBox[{
               RowBox[{"included", "&"}], ",", 
               RowBox[{"{", 
                RowBox[{"Length", "@", "shifts"}], "}"}]}], "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"field", "=", 
            RowBox[{
             RowBox[{
              RowBox[{"Flatten", "[", 
               RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
             RowBox[{"Array", "[", 
              RowBox[{
               RowBox[{"field", "&"}], ",", 
               RowBox[{"{", 
                RowBox[{"Length", "@", "shifts"}], "}"}]}], "]"}]}]}]}]}], 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"OptionValue", "[", "BubblePlot", "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"data", "=", 
            RowBox[{"(", 
             RowBox[{"Flatten", "/@", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"sites", ",", "field"}], "}"}], "\[Transpose]"}], 
               ")"}]}], ")"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"gr", "=", 
            RowBox[{"BubbleChart", "[", 
             RowBox[{"data", ",", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", 
                RowBox[{"Options", "[", "BubbleChart", "]"}]}], "]"}], ",", 
              RowBox[{"PerformanceGoal", "\[Rule]", "\"\<Speed\>\""}], ",", 
              RowBox[{"BubbleSizes", "\[Rule]", "Medium"}], ",", 
              RowBox[{"AspectRatio", "\[Rule]", "Automatic"}], ",", 
              RowBox[{"ColorFunction", "\[Rule]", "\"\<TemperatureMap\>\""}], 
              ",", 
              RowBox[{"ColorFunctionScaling", "\[Rule]", "True"}], ",", 
              RowBox[{"FrameLabel", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{"\"\<x\>\"", ",", "\"\<y\>\""}], "}"}]}], ",", 
              RowBox[{"ImageSize", "\[Rule]", "250"}], ",", "PlotDefaults"}], 
             "]"}]}], ";"}], " ", "\[IndentingNewLine]", ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"MatrixQ", "[", "#", "]"}], "||", 
                RowBox[{"MemberQ", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{"List", "[", "__", "]"}]}], "]"}]}], "&"}], "[", 
              RowBox[{"PlotRange", "/.", 
               RowBox[{"Flatten", "@", 
                RowBox[{"{", "opts", "}"}]}]}], "]"}], ",", " ", 
             RowBox[{"adjustedplotrange", "=", 
              RowBox[{"PlotRange", "/.", 
               RowBox[{"Flatten", "@", 
                RowBox[{"{", "opts", "}"}]}]}]}], ",", "\[IndentingNewLine]", 
             
             RowBox[{"adjustedplotrange", "=", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"1.00001", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"Min", "[", 
                    RowBox[{"sites", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}], ",", 
                   RowBox[{"Max", "[", 
                    RowBox[{"sites", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}], "}"}]}],
                 ",", 
                RowBox[{"1.00001", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"Min", "[", 
                    RowBox[{"sites", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], ",", 
                   RowBox[{"Max", "[", 
                    RowBox[{"sites", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "}"}]}],
                 ",", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"MatrixQ", "[", "#", "]"}], ",", 
                    RowBox[{"Last", "@", "#"}], ",", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"#", "===", "PlotRange"}], ",", "Automatic", ",", 
                    "#"}], "]"}]}], "]"}], "&"}], "[", 
                 RowBox[{"PlotRange", "/.", 
                  RowBox[{"Flatten", "@", 
                   RowBox[{"{", "opts", "}"}]}]}], "]"}]}], "}"}]}]}], "]"}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "This", " ", "avoids", " ", "a", " ", "bug", " ", "in", " ", 
              "ListDensityPlot"}], ",", " ", 
             RowBox[{
              RowBox[{
              "while", " ", "retaining", " ", "the", " ", "possibility", " ", 
               "to", " ", "adjust", " ", "z"}], "-", "Plotrange"}]}], "*)"}], 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"gr", "=", 
            RowBox[{"ListDensityPlot", "[", 
             RowBox[{
              RowBox[{"Pick", "[", 
               RowBox[{
                RowBox[{"Flatten", "/@", 
                 RowBox[{"Transpose", "@", 
                  RowBox[{"{", 
                   RowBox[{"sites", ",", "field"}], "}"}]}]}], ",", 
                "included"}], "]"}], ",", 
              RowBox[{"PlotRange", "\[Rule]", "adjustedplotrange"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", 
                RowBox[{"Options", "[", "ListDensityPlot", "]"}]}], "]"}], 
              ",", 
              RowBox[{"AspectRatio", "\[Rule]", "Automatic"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"InterpolationOrder", "\[Rule]", "0"}], ",", 
              RowBox[{"ColorFunction", "\[Rule]", "\"\<TemperatureMap\>\""}], 
              ",", 
              RowBox[{"ClippingStyle", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"ColorData", "[", "\"\<TemperatureMap\>\"", "]"}], 
                  "[", "0", "]"}], ",", 
                 RowBox[{
                  RowBox[{"ColorData", "[", "\"\<TemperatureMap\>\"", "]"}], 
                  "[", "1", "]"}]}], "}"}]}], ",", 
              RowBox[{"ColorFunctionScaling", "\[Rule]", "True"}], ",", 
              RowBox[{"FrameLabel", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{"\"\<x\>\"", ",", "\"\<y\>\""}], "}"}]}], ",", 
              RowBox[{"ImageSize", "\[Rule]", "250"}], ",", "PlotDefaults"}], 
             "]"}]}]}]}], "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "Overlay", "]"}], "&&", 
        RowBox[{
         RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}], ">", 
         "1"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}], 
           "\[Equal]", "2"}], ",", 
          RowBox[{"plat", "=", 
           RowBox[{"FlattenTags", "@", "lattice"}]}], ",", 
          RowBox[{"plat", "=", 
           RowBox[{"FlattenTags", "@", 
            RowBox[{
             RowBox[{"lattice", "[", 
              RowBox[{"\"\<Sites\>\"", "\[Rule]", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"Map", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ";;", "2"}], "]"}], "]"}], "&"}], ",", "#", 
                   ",", 
                   RowBox[{"{", "2", "}"}]}], "]"}], "&"}], ")"}]}], "]"}], 
             "[", 
             RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"[", 
                    RowBox[{"1", ";;", "2"}], "]"}], "]"}], "&"}], "/@", 
                 "#"}], "&"}], ")"}]}], "]"}]}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "Projects", " ", "the", " ", "3", "D", " ", "lattice", " ", "onto", 
          " ", "2", "D"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"graux", "=", 
         RowBox[{"PlotLattice", "[", 
          RowBox[{"plat", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", 
             RowBox[{"Options", "[", "PlotLattice", "]"}]}], "]"}], ",", 
           RowBox[{"PlotBravais", "\[Rule]", "False"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"gr", "=", 
         RowBox[{"Show", "[", 
          RowBox[{"gr", ",", "graux", ",", 
           RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}]}]}], "]"}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "@", 
         RowBox[{"OptionValue", "[", "MaskRegion", "]"}]}], "===", 
        "Function"}], 
       RowBox[{"(*", 
        RowBox[{"&&", 
         RowBox[{
          RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}], 
          "\[Equal]", "2"}]}], "*)"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"adjustedplotrange", "=", 
         RowBox[{"PlotRange", "/.", 
          RowBox[{"First", "@", 
           RowBox[{"AbsoluteOptions", "[", 
            RowBox[{
             RowBox[{"Show", "[", 
              RowBox[{"gr", ",", " ", 
               RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}], ",", 
             "PlotRange"}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"pad", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"Abs", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "-", 
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], ")"}], ".02"}], "]"}], 
           "&"}], "/@", "adjustedplotrange"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"graux", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"RegionPlot", "[", 
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"!", 
               RowBox[{
                RowBox[{"OptionValue", "[", "MaskRegion", "]"}], "[", 
                RowBox[{"{", 
                 RowBox[{"x", ",", "y"}], "}"}], "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"x", ",", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "1"}], "]"}], "]"}], "-", 
                RowBox[{"pad", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], ",", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "2"}], "]"}], "]"}], "+", 
                RowBox[{"pad", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}]}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"y", ",", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "1"}], "]"}], "]"}], "-", 
                RowBox[{"pad", "[", 
                 RowBox[{"[", "2", "]"}], "]"}]}], ",", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "2"}], "]"}], "]"}], "+", 
                RowBox[{"pad", "[", 
                 RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], ",", 
             RowBox[{"PlotStyle", "\[Rule]", 
              RowBox[{"OptionValue", "[", "MaskStyle", "]"}]}], ",", 
             RowBox[{"BoundaryStyle", "\[Rule]", 
              RowBox[{"OptionValue", "[", "MaskBoundaryStyle", "]"}]}], ",", 
             RowBox[{"Evaluate", "@", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", 
                RowBox[{"Options", "[", "RegionPlot", "]"}]}], "]"}]}], ",", 
             " ", 
             RowBox[{"PlotPoints", "\[Rule]", "50"}]}], "]"}], "&"}], "@", 
          "adjustedplotrange"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"gr", "=", 
         RowBox[{"Show", "[", 
          RowBox[{"gr", ",", "graux", ",", " ", 
           RowBox[{"AbsoluteOptions", "[", 
            RowBox[{"gr", ",", "PlotRange"}], "]"}]}], "]"}]}]}]}], "]"}], 
     ";", "\[IndentingNewLine]", "gr"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.602928013780295*^9, 3.6029280391841497`*^9}, {
   3.6029281725361156`*^9, 3.602928284695015*^9}, {3.602928422285977*^9, 
   3.602928498444275*^9}, {3.6029287874227257`*^9, 3.602928825283004*^9}, {
   3.602929901867495*^9, 3.602930127932539*^9}, {3.6029304308643827`*^9, 
   3.602930543920804*^9}, {3.602930595549852*^9, 3.6029306902840433`*^9}, {
   3.602930761723428*^9, 3.602930854979177*^9}, {3.6029308895948067`*^9, 
   3.602930925262423*^9}, {3.6029311332891197`*^9, 3.6029311347170897`*^9}, {
   3.602931178183885*^9, 3.602931233650731*^9}, {3.60293128060738*^9, 
   3.602931475353619*^9}, {3.602931546141658*^9, 3.602931597699416*^9}, {
   3.602931648559392*^9, 3.602931785708687*^9}, {3.602931947714864*^9, 
   3.602931958072872*^9}, {3.602932053148884*^9, 3.6029321179595013`*^9}, {
   3.6029326938972397`*^9, 3.602932745940342*^9}, {3.602932791714891*^9, 
   3.602932825119727*^9}, {3.603004418535976*^9, 3.603004425253203*^9}, {
   3.6030995119205017`*^9, 3.603099515055963*^9}, {3.603106826674137*^9, 
   3.6031068316411667`*^9}, {3.603106866420671*^9, 3.603106892741736*^9}, {
   3.6031083233900213`*^9, 3.60310834721317*^9}, {3.6031085482631693`*^9, 
   3.6031085629248047`*^9}, {3.6031086236015263`*^9, 3.603108758620792*^9}, {
   3.60353805298228*^9, 3.603538058332657*^9}, {3.60353811647712*^9, 
   3.603538151054452*^9}, {3.603540308973957*^9, 3.603540310277791*^9}, {
   3.6035403458332167`*^9, 3.603540477371812*^9}, {3.603541158462269*^9, 
   3.603541163483787*^9}, {3.603541763802565*^9, 3.6035417647035923`*^9}, {
   3.603626159698504*^9, 3.603626166028534*^9}, {3.603626228509222*^9, 
   3.603626394469226*^9}, {3.603627332627705*^9, 3.6036273815748253`*^9}, {
   3.603627420157063*^9, 3.603627445718643*^9}, {3.603627553781268*^9, 
   3.6036276424575567`*^9}, {3.6036276745258408`*^9, 3.603627685340005*^9}, {
   3.603627741217092*^9, 3.6036277668936377`*^9}, {3.603628189619502*^9, 
   3.603628194695695*^9}, {3.6036454510192537`*^9, 3.603645496153694*^9}, {
   3.603645551871237*^9, 3.6036455528381767`*^9}, {3.603645701939282*^9, 
   3.603645704864931*^9}, {3.603645750642387*^9, 3.603645846223736*^9}, {
   3.603645961341427*^9, 3.603645998309388*^9}, {3.6036460299780827`*^9, 
   3.603646097434181*^9}, 3.603646147045994*^9, {3.603646316075184*^9, 
   3.6036463527559843`*^9}, {3.603646397264632*^9, 3.603646474318632*^9}, {
   3.60364654241299*^9, 3.603646851204419*^9}, {3.6036470155938683`*^9, 
   3.603647026400776*^9}, {3.603647145924981*^9, 3.6036471488773623`*^9}, {
   3.6036472406673183`*^9, 3.603647240825993*^9}, {3.6036954127194366`*^9, 
   3.6036954148860207`*^9}, {3.6040540678493233`*^9, 3.6040540684087*^9}, {
   3.604054156903428*^9, 3.604054183090205*^9}, {3.604054284066049*^9, 
   3.604054284562285*^9}, {3.604054808032035*^9, 3.604054819532774*^9}, {
   3.604054897728552*^9, 3.6040548980713263`*^9}, {3.6040549355736732`*^9, 
   3.604054955508412*^9}, {3.604057894231435*^9, 3.604057931883016*^9}, {
   3.604058355695448*^9, 3.604058452776091*^9}, {3.604058517787133*^9, 
   3.604058568471994*^9}, {3.604059044386015*^9, 3.6040590712006607`*^9}, {
   3.6118371388756113`*^9, 3.611837162689289*^9}, {3.6132978362298822`*^9, 
   3.613297836372385*^9}, {3.616485231303903*^9, 3.616485231573669*^9}, {
   3.6164853615693617`*^9, 3.616485362640527*^9}, {3.6164854041280127`*^9, 
   3.61648540455171*^9}, {3.619874439954742*^9, 3.619874440280944*^9}, {
   3.619877439562879*^9, 3.619877504160984*^9}, {3.619877542006928*^9, 
   3.6198777072717457`*^9}, {3.61987799930711*^9, 3.6198781393222647`*^9}, {
   3.6198781989754744`*^9, 3.6198782062499743`*^9}, {3.619878279060182*^9, 
   3.619878307707922*^9}, {3.619878344129335*^9, 3.619878347731339*^9}, {
   3.619878814988484*^9, 3.619878893716419*^9}, {3.619878926376535*^9, 
   3.619878951864572*^9}, {3.619878999153801*^9, 3.619879078300824*^9}, {
   3.619879109103178*^9, 3.6198791664020367`*^9}, 3.619879197941774*^9, {
   3.61987982437177*^9, 3.61987987952689*^9}, {3.619879925629868*^9, 
   3.619880041174225*^9}, {3.619880143184115*^9, 3.619880359505868*^9}, {
   3.6198803913920603`*^9, 3.619880398567842*^9}, {3.6198804306039457`*^9, 
   3.619880559270714*^9}, {3.619880730536113*^9, 3.6198809012755136`*^9}, {
   3.619880940377565*^9, 3.619881009552476*^9}, {3.619881041428458*^9, 
   3.619881207254261*^9}, {3.619881391011917*^9, 3.619881397758463*^9}, {
   3.619881517925549*^9, 3.619881540831802*^9}, {3.619881778753236*^9, 
   3.61988179430135*^9}, {3.619881830244226*^9, 3.619881833850882*^9}, {
   3.619884044794553*^9, 3.61988406500851*^9}, {3.6198841400765553`*^9, 
   3.619884187706669*^9}, {3.619884230467333*^9, 3.619884235162767*^9}, {
   3.619931256110908*^9, 3.619931270294174*^9}, {3.619950985839768*^9, 
   3.619951013726696*^9}, {3.61996060004459*^9, 3.619960729360075*^9}, {
   3.619960770431632*^9, 3.619960914008553*^9}, {3.619960955006713*^9, 
   3.619960960567087*^9}, {3.61996101454803*^9, 3.619961090052326*^9}, {
   3.619961178882758*^9, 3.619961210053287*^9}, {3.6199612511232758`*^9, 
   3.6199612795749283`*^9}, {3.6199613153056726`*^9, 
   3.6199613360643167`*^9}, {3.619961434252522*^9, 3.619961445502165*^9}, {
   3.6199615154541407`*^9, 3.619961523401576*^9}, {3.6199616034883347`*^9, 
   3.619961617584738*^9}, {3.6199618391334953`*^9, 3.619961915118698*^9}, {
   3.619964706689291*^9, 3.61996471189291*^9}, {3.620193008713545*^9, 
   3.620193076407729*^9}, {3.620193107974161*^9, 3.6201931531429996`*^9}, {
   3.6201932622524633`*^9, 3.620193316988853*^9}, {3.620193474701283*^9, 
   3.6201934832145567`*^9}, {3.620193532904524*^9, 3.620193537353764*^9}, {
   3.620194592698991*^9, 3.620194641987152*^9}, {3.620194748464404*^9, 
   3.620194772384967*^9}, {3.620194886671666*^9, 3.620194897195073*^9}, {
   3.620194953111946*^9, 3.620194961240926*^9}, {3.620195006888761*^9, 
   3.62019500948162*^9}, {3.6201952081982594`*^9, 3.620195346461376*^9}, {
   3.620195376911525*^9, 3.620195412364749*^9}, {3.620195456481628*^9, 
   3.620195457147203*^9}, {3.6201955021788883`*^9, 3.620195522553651*^9}, {
   3.6201955691933393`*^9, 3.620195579180938*^9}, {3.620195614553157*^9, 
   3.620195623939282*^9}, {3.620195669251615*^9, 3.620195678693939*^9}, {
   3.620195847072687*^9, 3.6201958521053133`*^9}, {3.620195918432241*^9, 
   3.620195921338819*^9}, {3.6201963467954903`*^9, 3.6201963517958193`*^9}, {
   3.620196383639984*^9, 3.6201964472928343`*^9}, {3.6201964944306927`*^9, 
   3.620196523257166*^9}, {3.6201965693162813`*^9, 3.620196569550877*^9}, {
   3.620196606524539*^9, 3.620196616319027*^9}, {3.620196660926671*^9, 
   3.620196685943946*^9}, {3.6201967775280123`*^9, 3.620196781357012*^9}, {
   3.6201968206932383`*^9, 3.6201968253899508`*^9}, {3.6201968664371367`*^9, 
   3.620196892525119*^9}, {3.6201969278423643`*^9, 3.620197002795825*^9}, {
   3.62019707456496*^9, 3.620197081622705*^9}, {3.620197179121052*^9, 
   3.620197190691518*^9}, {3.620299303845207*^9, 3.620299303995943*^9}, {
   3.621235256015738*^9, 3.6212352608780727`*^9}, {3.621236638869376*^9, 
   3.621236642746977*^9}, 3.6212366937710447`*^9, {3.6212496448877363`*^9, 
   3.62124964735079*^9}, {3.621582412337768*^9, 3.621582532658944*^9}, {
   3.621586159764325*^9, 3.621586165642461*^9}, {3.621587016504929*^9, 
   3.621587116078821*^9}, {3.621587179592649*^9, 3.621587223280119*^9}, {
   3.6215878867823772`*^9, 3.621587940564444*^9}, {3.621588249142468*^9, 
   3.621588254404377*^9}, {3.6215883588889627`*^9, 3.621588362279511*^9}, {
   3.621588521400877*^9, 3.621588524687109*^9}, {3.62158856657248*^9, 
   3.621588577788012*^9}, {3.6215886189611*^9, 3.621588645114716*^9}, {
   3.621588693110442*^9, 3.6215887131691837`*^9}, {3.6215888068976393`*^9, 
   3.621588840325441*^9}, {3.6215888888634453`*^9, 3.621588931050956*^9}, {
   3.621590792632023*^9, 3.6215907988143463`*^9}, {3.621593725360694*^9, 
   3.621593726490005*^9}, {3.625486608533146*^9, 3.6254866635124807`*^9}, 
   3.629641787477703*^9, {3.631619520711318*^9, 3.631619608260667*^9}, {
   3.633162506423663*^9, 3.633162542579657*^9}, {3.63316259085814*^9, 
   3.633162591409021*^9}, {3.6358509381882887`*^9, 3.635850952449151*^9}, {
   3.6358510161123457`*^9, 3.635851016287095*^9}, {3.639734213974113*^9, 
   3.6397342332529573`*^9}, {3.639734293651146*^9, 3.63973430326502*^9}, {
   3.639734628312076*^9, 3.639734669303994*^9}, 3.639734761781889*^9, {
   3.6567399816318274`*^9, 3.656740043871337*^9}, {3.664895278377301*^9, 
   3.664895299596092*^9}, {3.666851015059454*^9, 3.666851018313734*^9}, {
   3.707830518399559*^9, 3.7078305608697166`*^9}, 3.707831159883759*^9, {
   3.707831202694063*^9, 3.707831205281109*^9}, {3.707831245621737*^9, 
   3.7078312467003613`*^9}, {3.7078312915555162`*^9, 
   3.7078313046753397`*^9}, {3.7078313364591913`*^9, 3.707831377632329*^9}, {
   3.707831436688743*^9, 3.7078314785187197`*^9}, {3.707831521791168*^9, 
   3.707831571652226*^9}, 3.7078316367477407`*^9, 3.707831712600924*^9, 
   3.747738901523608*^9},
 CellLabel->
  "In[166]:=",ExpressionUUID->"355267a4-b31c-4b0b-b18a-b19652ecbe01"]
}, Open  ]],

Cell[CellGroupData[{

Cell["BuildLattice", "Subsection",
 CellChangeTimes->{{3.5974068059201937`*^9, 3.597406819464735*^9}, 
   3.59818295924641*^9, {3.5983407217191887`*^9, 
   3.5983407235509577`*^9}},ExpressionUUID->"69886058-1f12-4527-92a7-\
a681b640421d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"GetEmbeddingDimensions", "::", "sites"}], "=", 
   "\"\<Invalid site list\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GetEmbeddingDimensions", "[", 
   RowBox[{"sites_", "?", "IsValidSitesQ"}], "]"}], ":=", 
  RowBox[{"Last", "@", 
   RowBox[{"Dimensions", "@", 
    RowBox[{"First", "@", "sites"}]}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetEmbeddingDimensions", "[", "_", "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"Message", "[", 
      RowBox[{"GetEmbeddingDimensions", "::", "sites"}], "]"}], ";", 
     "$Failed"}], ")"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BuildLattice", "[", 
    RowBox[{"specs_", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"BuildLattice", "[", 
    RowBox[{
     RowBox[{"BuildLattice", "[", "specs", "]"}], ",", "opts"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BuildLattice", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"vectors_", "?", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"MatrixQ", "[", "#", "]"}], "||", 
          RowBox[{"#", "===", 
           RowBox[{"{", "}"}]}]}], "&"}], ")"}]}], ",", 
      RowBox[{"taggedsites", ":", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Rule", "[", 
          RowBox[{"_String", ",", 
           RowBox[{"_", "?", "MatrixQ"}]}], "]"}], ".."}], "}"}]}]}], "}"}], 
    "]"}], ":=", 
   RowBox[{"MQLattice", "[", 
    RowBox[{
     RowBox[{"\"\<Sites\>\"", "\[Rule]", 
      RowBox[{"N", "@", 
       RowBox[{"taggedsites", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ",", 
     RowBox[{"\"\<Tags\>\"", "\[Rule]", 
      RowBox[{"taggedsites", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", " ", 
     RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
      RowBox[{"N", "@", "vectors"}]}], ",", 
     RowBox[{"\"\<EmbeddingDimensions\>\"", "\[Rule]", 
      RowBox[{"GetEmbeddingDimensions", "[", 
       RowBox[{"N", "@", 
        RowBox[{"taggedsites", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"BuildLattice", "[", 
   RowBox[{"sites_", "?", "IsValidSitesQ"}], "]"}], ":=", 
  RowBox[{"MQLattice", "[", 
   RowBox[{
    RowBox[{"\"\<Sites\>\"", "\[Rule]", "sites"}], ",", 
    RowBox[{"\"\<Tags\>\"", "\[Rule]", 
     RowBox[{"ToString", "/@", 
      RowBox[{"Range", "[", 
       RowBox[{"Length", "@", "sites"}], "]"}]}]}], ",", " ", 
    RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
     RowBox[{"{", "}"}]}], ",", 
    RowBox[{"\"\<EmbeddingDimensions\>\"", "\[Rule]", 
     RowBox[{"GetEmbeddingDimensions", "[", "sites", "]"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.635240068145809*^9, 3.635240068786172*^9}, {
  3.635246394927739*^9, 3.635246457379539*^9}, {3.635674300746546*^9, 
  3.6356743147286167`*^9}, {3.716719065953055*^9, 3.716719080480033*^9}, {
  3.7167191179763193`*^9, 3.716719118087455*^9}, {3.716719149399913*^9, 
  3.7167191495670967`*^9}},
 CellLabel->
  "In[175]:=",ExpressionUUID->"579c9606-a1f1-4b9b-a445-289f117b59c3"],

Cell["\<\
BuildLattice may change dimensions, expand supercell, bound certain \
directions, and make one direction semibounded.\
\>", "Text",
 CellChangeTimes->{{3.597636851814386*^9, 
  3.597636886024695*^9}},ExpressionUUID->"bc4d7fcf-2165-4250-84f7-\
ac4c28cb57e8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"EmbeddingDimensions", "::", "usage"}], "=", 
   "\"\<BuildLattice option that specifies the dimensions of the space in \
which the lattice is embedded.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LatticeConstant", "::", "usage"}], "=", 
   "\"\<BuildLattice option that specifies the lattice constant to \
use.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Transform", "::", "usage"}], "=", 
   "\"\<BuildLattice option of the form of a function of space to be applied \
to the lattice sites and Bravais vectors.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Supercell", "::", "usage"}], "=", 
   "\"\<BuildLattice option of the form \!\(\*SubscriptBox[\(n\), \(ij\)]\) \
that specifies a unit cell whose i-th Bravais vector is \
\!\(\*SubscriptBox[\(A\), \(i\)]\)=\[Sum]\!\(\*SubscriptBox[\(n\), \
\(ij\)]\)\!\(\*SubscriptBox[\(a\), \(j\)]\), where \!\(\*SubscriptBox[\(a\), \
\(j\)]\)are the original Bravais vectors. Alternatively, a form \
\!\(\*SubscriptBox[\(n\), \(j\)]\) is assumed to be \!\(\*SubscriptBox[\(\
\[Delta]\), \(ij\)]\)\!\(\*SubscriptBox[\(n\), \(j\)]\)\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Bounded", "::", "usage"}], "=", 
   "\"\<BuildLattice option of the form {Axes->{__Integer}, \
Region->_Function, Seed->_List} that closes the lattice in the direction of \
the Bravais vectors specified by Axes, and makes it bounded to Region, \
starting with Seed.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Reshape", "::", "usage"}], "=", 
   "\"\<BuildLattice option of the form {Axis->_Integer, Region->_Function, \
Seed->_List} that changes the shape of the unit cell along a given Bravais \
axis.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Tags", "::", "usage"}], " ", "=", " ", 
    "\"\<BuildLattice option of the form {\\\"\!\(\*SubscriptBox[\(tag\), \(1\
\)]\)\\\", ...} that assigns tags (names) to each sublattice.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BuildLattice", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"EmbeddingDimensions", "\[Rule]", "Automatic"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"LatticeConstant", "\[Rule]", "Automatic"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Transform", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Supercell", "\[Rule]", "Automatic"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Bounded", "\[Rule]", "False"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Reshape", "\[Rule]", "False"}], ",", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"Tags", "\[Rule]", "Automatic"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"BuildLattice", "[", 
   RowBox[{"lattice_MQLattice", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"newlattice", "=", "lattice"}], ",", "\[IndentingNewLine]", 
      RowBox[{"embdim", "=", 
       RowBox[{"OptionValue", "[", "EmbeddingDimensions", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"latconst", "=", 
       RowBox[{"OptionValue", "[", "LatticeConstant", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"transform", "=", 
       RowBox[{"OptionValue", "[", "Transform", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"supercell", "=", 
       RowBox[{"OptionValue", "[", "Supercell", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"boundedspecs", "=", 
       RowBox[{"OptionValue", "[", "Bounded", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"reshapespecs", "=", 
       RowBox[{"OptionValue", "[", "Reshape", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"tags", "=", 
       RowBox[{"OptionValue", "[", "Tags", "]"}]}]}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"StringQ", "[", "tags", "]"}], ",", 
       RowBox[{"tags", "=", 
        RowBox[{"{", "tags", "}"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"VectorQ", "[", 
        RowBox[{"tags", ",", "StringQ"}], "]"}], ",", " ", 
       RowBox[{"newlattice", " ", "=", " ", 
        RowBox[{"newlattice", "[", 
         RowBox[{"\"\<Tags\>\"", "\[Rule]", "tags"}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"NumericQ", "[", "embdim", "]"}], "&&", 
        RowBox[{"embdim", ">", 
         RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}]}], 
       ",", 
       RowBox[{"newlattice", "=", 
        RowBox[{"ExpandDimensions", "[", 
         RowBox[{"newlattice", ",", "embdim"}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"VectorQ", "[", "supercell", "]"}], ",", 
       RowBox[{"supercell", "=", 
        RowBox[{"DiagonalMatrix", "[", "supercell", "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"supercell", "=!=", "Automatic"}], ",", 
       RowBox[{"newlattice", "=", " ", 
        RowBox[{"ExpandUnitCell", "[", 
         RowBox[{"newlattice", ",", "supercell"}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"latconst", "=!=", "Automatic"}], ",", 
       RowBox[{"newlattice", "=", " ", 
        RowBox[{"TransformLattice", "[", 
         RowBox[{"newlattice", ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"latconst", "#"}], "&"}], ")"}]}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"boundedspecs", "=!=", "False"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "If", " ", "a", " ", "list", " ", "of", " ", "specifications", " ", 
          "is", " ", "provided"}], ",", " ", 
         RowBox[{"apply", " ", "them", " ", "sequentially"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"And", "@@", 
          RowBox[{"VectorQ", "/@", "boundedspecs"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"newlattice", "=", " ", 
             RowBox[{"MakeBounded", "[", 
              RowBox[{"newlattice", ",", "#"}], "]"}]}], ")"}], "&"}], "/@", 
          "boundedspecs"}], ",", "\[IndentingNewLine]", 
         RowBox[{"newlattice", "=", " ", 
          RowBox[{"MakeBounded", "[", 
           RowBox[{"newlattice", ",", "boundedspecs"}], "]"}]}]}], "]"}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"reshapespecs", "=!=", "False"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "If", " ", "a", " ", "list", " ", "of", " ", "specifications", " ", 
          "is", " ", "provided"}], ",", " ", 
         RowBox[{"apply", " ", "them", " ", "sequentially"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"And", "@@", 
          RowBox[{"VectorQ", "/@", "reshapespecs"}]}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"newlattice", "=", " ", 
             RowBox[{"ReshapeAxis", "[", 
              RowBox[{"newlattice", ",", "#"}], "]"}]}], ")"}], "&"}], "/@", 
          "reshapespecs"}], ",", 
         RowBox[{"newlattice", "=", " ", 
          RowBox[{"ReshapeAxis", "[", 
           RowBox[{"newlattice", ",", "reshapespecs"}], "]"}]}]}], "]"}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"transform", "=!=", "None"}], ",", 
       RowBox[{"newlattice", "=", " ", 
        RowBox[{"TransformLattice", "[", 
         RowBox[{"newlattice", ",", "transform"}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "newlattice"}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.597635233874861*^9, 3.597635235218445*^9}, {
   3.5976352841512814`*^9, 3.597635334394244*^9}, {3.5976353717559*^9, 
   3.5976357182856197`*^9}, {3.597635753720553*^9, 3.597635754623785*^9}, {
   3.59763585708747*^9, 3.597635859711872*^9}, {3.597635890874529*^9, 
   3.597636124354145*^9}, {3.597636500349415*^9, 3.597636571229258*^9}, {
   3.597636611020425*^9, 3.5976368372662888`*^9}, {3.597739768847457*^9, 
   3.5977397770932217`*^9}, {3.597753122339856*^9, 3.597753253017694*^9}, {
   3.597753287411433*^9, 3.597753293242649*^9}, {3.597753338788568*^9, 
   3.59775353557316*^9}, {3.597754469647201*^9, 3.597754543070787*^9}, {
   3.597754647206716*^9, 3.597754678943659*^9}, {3.597755881406641*^9, 
   3.597755901593339*^9}, {3.597778562560319*^9, 3.5977787113888693`*^9}, {
   3.597783224315316*^9, 3.5977832248583517`*^9}, 3.597783255611863*^9, {
   3.597870486901787*^9, 3.597870542128942*^9}, {3.5983396273728437`*^9, 
   3.5983397120128927`*^9}, {3.598339930779271*^9, 3.598339938514914*^9}, {
   3.59834002295228*^9, 3.5983400248642178`*^9}, {3.598340464620595*^9, 
   3.598340542071946*^9}, {3.5983528850941563`*^9, 3.5983529068808203`*^9}, {
   3.598600907470729*^9, 3.598601051212872*^9}, {3.598601395762527*^9, 
   3.598601396016699*^9}, {3.5986114971640453`*^9, 3.598611554856454*^9}, {
   3.603000060795683*^9, 3.603000066300651*^9}, {3.629641792803639*^9, 
   3.629641793642852*^9}, {3.635239093860498*^9, 3.6352390949072323`*^9}, {
   3.6352402899275303`*^9, 3.635240342667966*^9}, {3.635240373725326*^9, 
   3.635240389546514*^9}, {3.656401293437448*^9, 3.656401316906866*^9}, 
   3.702275841952427*^9, {3.707562771220961*^9, 3.7075629119211187`*^9}, {
   3.707562965281397*^9, 3.707562979344142*^9}, {3.708082241161934*^9, 
   3.708082273056856*^9}, {3.708082323144458*^9, 3.708082338302545*^9}},
 CellLabel->
  "In[181]:=",ExpressionUUID->"130f8484-1162-49c9-8266-3bb545959e95"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ExpandUnitCell", "::", "supercell"}], "=", 
   "\"\<Specified supercell `1` is not a rank-2 integer matrix.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandUnitCell", "::", "dim"}], "=", 
   "\"\<Dimensions of supercell `1` does not match the number of Bravais \
vectors `2`.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandUnitCell", "::", "sing"}], "=", 
   "\"\<Supercell `1` is singular.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandUnitCell", "[", 
    RowBox[{"lattice_MQLattice", ",", "supercellInput_"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"brvectors", "=", 
        RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", " ", 
       "\[IndentingNewLine]", 
       RowBox[{"sites", "=", 
        RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"supercell", "=", "supercellInput"}], ",", 
       "\[IndentingNewLine]", "latdim", ",", "invsupercell", ",", "cells", 
       ",", " ", "supercellvertices", ",", " ", "ranges"}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"IntegerQ", "[", "supercell", "]"}], ",", 
        RowBox[{"supercell", "=", 
         RowBox[{"supercell", " ", 
          RowBox[{"IdentityMatrix", "[", 
           RowBox[{"lattice", "[", "\"\<LatticeDimensions\>\"", "]"}], 
           "]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"MatrixQ", "[", 
          RowBox[{"supercell", ",", "IntegerQ"}], "]"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"ExpandUnitCell", "::", "supercell"}], ",", " ", 
           "supercell"}], "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Dimensions", "@", "supercell"}], "=!=", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Length", "@", "brvectors"}], ",", 
           RowBox[{"Length", "@", "brvectors"}]}], "}"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"ExpandUnitCell", "::", "dim"}], ",", " ", 
           RowBox[{"Dimensions", "@", "supercell"}], ",", 
           RowBox[{"Length", "@", "brvectors"}]}], "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Det", "@", "supercell"}], "\[Equal]", "0"}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"ExpandUnitCell", "::", "sing"}], ",", " ", "supercell"}], 
          "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "We", " ", "consider", " ", "all", " ", "points", " ", "in", " ", 
        "the", " ", "original", " ", "lattice", " ", "bounded", " ", "by", 
        " ", "a", " ", "cuboid", " ", "that", " ", "contains", " ", "the", 
        " ", "parallelogram", " ", "defined", " ", "by", " ", "the", " ", 
        "supercell", " ", 
        RowBox[{
         RowBox[{"(", "supercellvertices", ")"}], ".", " ", "Then"}], " ", 
        "we", " ", "select", " ", "only", " ", "those", " ", "points", " ", 
        "inside", " ", "the", " ", 
        RowBox[{"parallelogram", "."}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"latdim", "=", 
       RowBox[{"Length", "@", "brvectors"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"invsupercell", "=", 
       RowBox[{"Inverse", "[", "supercell", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"supercellvertices", "=", 
       RowBox[{
        RowBox[{"Tuples", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"0", ",", "1"}], "}"}], ",", "latdim"}], "]"}], ".", 
        "supercell"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ranges", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Min", "[", "#", "]"}], ",", 
           RowBox[{"Max", "[", "#", "]"}]}], "}"}], "&"}], "/@", 
        RowBox[{"Transpose", "[", "supercellvertices", "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"cells", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"Outer", "[", 
          RowBox[{"List", ",", 
           RowBox[{"Sequence", "@@", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"Range", "@@", "#"}], "&"}], "/@", "ranges"}], 
             ")"}]}]}], "]"}], ",", 
         RowBox[{"latdim", "-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"cells", "=", 
       RowBox[{"Select", "[", 
        RowBox[{"cells", ",", 
         RowBox[{
          RowBox[{"And", "@@", 
           RowBox[{"Thread", "[", 
            RowBox[{"0", "<=", 
             RowBox[{"#", ".", "invsupercell"}], "<", "1"}], "]"}]}], "&"}]}],
         "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "We", " ", "build", " ", "all", " ", "unit", " ", "cells", " ", 
        "using", " ", "the", " ", "computed", " ", "cells"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"sites", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"Outer", "[", 
            RowBox[{"Plus", ",", 
             RowBox[{"cells", ".", "brvectors"}], ",", "#", ",", "1"}], "]"}],
            ",", "1"}], "]"}], "&"}], "/@", "sites"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"lattice", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<Sites\>\"", "\[Rule]", "sites"}], ",", 
         RowBox[{"\"\<BravaisVectors\>\"", "->", 
          RowBox[{"supercell", ".", "brvectors"}]}]}], "}"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.5976369062114353`*^9, 3.5976373009124947`*^9}, {
   3.597638242940381*^9, 3.597638381490037*^9}, {3.5976384329989567`*^9, 
   3.597638643489724*^9}, {3.5976388064884644`*^9, 3.597638815689602*^9}, {
   3.597638932860792*^9, 3.597638962013382*^9}, {3.5976403940301037`*^9, 
   3.597640426971624*^9}, {3.597640557018134*^9, 3.5976406012930803`*^9}, {
   3.597640678497512*^9, 3.597640720104897*^9}, {3.59764081814854*^9, 
   3.597640818339446*^9}, {3.5976408778398113`*^9, 3.597640942031884*^9}, {
   3.59764097831936*^9, 3.5976410548354683`*^9}, {3.597641344784977*^9, 
   3.597641358017152*^9}, 3.59764177535002*^9, {3.597642117064178*^9, 
   3.597642129181971*^9}, {3.597642166983941*^9, 3.597642185210526*^9}, {
   3.5976423985473347`*^9, 3.5976424278772306`*^9}, {3.5976424660475063`*^9, 
   3.5976424789979887`*^9}, {3.597642602351358*^9, 3.5976427927513113`*^9}, {
   3.5976428264552097`*^9, 3.597642936167447*^9}, {3.597643191884021*^9, 
   3.597643278247984*^9}, {3.597643310203896*^9, 3.597643515584957*^9}, {
   3.597643562252915*^9, 3.597643562941074*^9}, {3.597643691309215*^9, 
   3.5976438498120203`*^9}, {3.59764391627001*^9, 3.59764391803792*^9}, {
   3.597644051248691*^9, 3.597644078048764*^9}, {3.597669097729064*^9, 
   3.5976691610692253`*^9}, {3.597669206528681*^9, 3.597669215272789*^9}, {
   3.597669306159782*^9, 3.597669306351125*^9}, 3.597670678510784*^9, {
   3.597670894486636*^9, 3.597670929313176*^9}, {3.597670994597506*^9, 
   3.597671001429145*^9}, {3.5976710498652067`*^9, 3.5976711177905273`*^9}, {
   3.597671292138298*^9, 3.5976713294685373`*^9}, {3.597671366630076*^9, 
   3.5976713679738817`*^9}, 3.59776515888868*^9, 3.597765888547044*^9, {
   3.5978511673474503`*^9, 3.597851242647191*^9}, {3.602568430420207*^9, 
   3.602568447090396*^9}, 3.6296417942192383`*^9, {3.6352362883105507`*^9, 
   3.635236356402924*^9}, 3.635236402866933*^9},
 CellLabel->
  "In[190]:=",ExpressionUUID->"cf3ef84b-c9cd-49bc-ae54-8d1da841527e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"TransformLattice", "::", "dim"}], "=", 
   "\"\<Dimension of transform function `1` is different from embedding \
dimension `2`.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TransformLattice", "[", 
   RowBox[{"lattice_MQLattice", ",", "transform_Function"}], "]"}], ":=", 
  RowBox[{"Block", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"embdim", "=", 
       RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"sites", "=", 
       RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"sitetags", "=", 
       RowBox[{"lattice", "[", "\"\<SiteTags\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"brvectors", "=", 
       RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", "newlattice", ",", " ", "aux"}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"embdim", "\[NotEqual]", 
        RowBox[{"Length", "[", 
         RowBox[{"transform", "[", 
          RowBox[{
           RowBox[{"sites", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
           RowBox[{"sitetags", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}]}], "]"}], "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"TransformLattice", "::", "dim"}], ",", 
          RowBox[{"Dimensions", "[", 
           RowBox[{"transform", "[", 
            RowBox[{
             RowBox[{"sites", "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
             RowBox[{"sitetags", "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "1"}], "]"}], "]"}]}], "]"}], "]"}], ",", 
          "embdim"}], "]"}], ";", 
        RowBox[{"Return", "[", "lattice", "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"newlattice", "=", 
        RowBox[{"lattice", "[", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"\"\<Sites\>\"", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"(", "\[IndentingNewLine]", 
               RowBox[{"(*", 
                RowBox[{"MapThread", "[", 
                 RowBox[{"transform", ",", 
                  RowBox[{"{", 
                   RowBox[{"#", ",", "sitetags"}], "}"}], ",", "2"}], "]"}], 
                "*)"}], "\[IndentingNewLine]", 
               RowBox[{"Map", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"transform", "@@", "#"}], "&"}], ",", 
                 RowBox[{"Map", "[", 
                  RowBox[{"Thread", ",", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"#", ",", "sitetags"}], "}"}], "\[Transpose]"}]}],
                   "]"}], ",", 
                 RowBox[{"{", "2", "}"}]}], "]"}], "\[IndentingNewLine]", 
               ")"}], "&"}], ")"}]}], ",", 
           RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Map", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"transform", "[", 
                   RowBox[{"#", ",", 
                    RowBox[{"sitetags", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}]}], "]"}], "-", 
                  RowBox[{"transform", "[", 
                   RowBox[{
                    RowBox[{"ConstantArray", "[", 
                    RowBox[{"0", ",", "embdim"}], "]"}], ",", 
                    RowBox[{"sitetags", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}]}], "]"}]}], "&"}], 
                ",", "#"}], "]"}], "&"}], ")"}]}]}], "}"}], "]"}]}]}], "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "newlattice"}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.597778724768112*^9, 3.5977791491928587`*^9}, {
   3.597783129633779*^9, 3.597783131586013*^9}, {3.597865305500298*^9, 
   3.597865318818673*^9}, {3.597865409255868*^9, 3.5978654238300343`*^9}, 
   3.597865498306261*^9, {3.597865540499145*^9, 3.597865706398593*^9}, {
   3.597865795126918*^9, 3.597865804412125*^9}, 3.6296417953068123`*^9, {
   3.7076407585233393`*^9, 3.707640762769705*^9}, {3.707641118421172*^9, 
   3.7076411255480824`*^9}, {3.707641230034276*^9, 3.707641249978114*^9}, {
   3.707641746322937*^9, 3.707641770537891*^9}, {3.707642205644154*^9, 
   3.7076422319172153`*^9}, {3.719410893668198*^9, 3.719410901825253*^9}, {
   3.719411010394731*^9, 3.719411013408396*^9}, {3.7194110682700977`*^9, 
   3.719411078068912*^9}, {3.719411144349029*^9, 3.719411148444406*^9}, {
   3.719411378143499*^9, 3.719411378414692*^9}, {3.71941153203062*^9, 
   3.719411548362092*^9}, {3.71941160456831*^9, 3.719411765959054*^9}, {
   3.719411809164369*^9, 3.719411813115745*^9}, {3.719411897859318*^9, 
   3.719411948998337*^9}, {3.719412010486771*^9, 3.71941203417459*^9}, {
   3.719412124814478*^9, 3.7194121272774982`*^9}, {3.719412199703164*^9, 
   3.719412205581411*^9}, {3.719412255447667*^9, 3.719412258388866*^9}, {
   3.7453108922268877`*^9, 3.745310893832583*^9}},
 CellLabel->
  "In[194]:=",ExpressionUUID->"8b443192-b90e-4374-a91d-2a8b956f6c55"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "MakeBounded", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Axes", "\[Rule]", "All"}], ",", 
      RowBox[{"Region", "\[Rule]", "None"}], ",", " ", 
      RowBox[{"Seed", "\[Rule]", "Automatic"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Region", "::", "usage"}], "=", 
   "\"\<Option for a number of builders denoting a boolean function that \
defines a region in space.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Seed", "::", "usage"}], "=", 
    "\"\<Option for a number of builders denoting a point in space to use as \
seed to fill a region with a lattice.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MakeBounded", "::", "dim"}], "=", 
   "\"\<To build a bounded lattice, the number of bounded directions should \
be 1, 2 or 3. However, the original lattice has `1` Bravais vectors.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MakeBounded", "::", "axes"}], "=", 
   "\"\<The bound axes `1` is not a list of indices between 1 and the number \
of Bravais vectors in the lattice, which is `2`.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MakeBounded", "[", 
   RowBox[{"lattice_MQLattice", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"axes", "=", 
       RowBox[{"OptionValue", "[", "Axes", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"region", "=", 
       RowBox[{"OptionValue", "[", "Region", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"seed", "=", 
       RowBox[{"OptionValue", "[", "Seed", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"sites", "=", 
       RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"brvectors", "=", 
       RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", "bounddim", ",", "newsites", ",", " ", 
      "newlattice"}], "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"axes", "===", "All"}], ",", 
       RowBox[{"axes", "=", 
        RowBox[{"Range", "[", 
         RowBox[{"Length", "@", "brvectors"}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"axes", "\[NotEqual]", 
         RowBox[{"{", "}"}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"VectorQ", "[", 
            RowBox[{"axes", ",", "IntegerQ"}], "]"}], "&&", 
           RowBox[{"And", "@@", 
            RowBox[{"Thread", "[", 
             RowBox[{"1", "\[LessEqual]", "axes", "\[LessEqual]", 
              RowBox[{"Length", "@", "brvectors"}]}], "]"}]}]}], ")"}]}]}], 
       ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"MakeBounded", "::", "axes"}], ",", " ", "axes", ",", 
          RowBox[{"Length", "@", "brvectors"}]}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"region", "===", "None"}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"lattice", "[", 
         RowBox[{"{", 
          RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"Delete", "[", 
              RowBox[{"#", ",", 
               RowBox[{"List", "/@", "axes"}]}], "]"}], "&"}], ")"}]}], "}"}],
          "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"bounddim", "=", 
      RowBox[{"Length", "@", "axes"}]}], ";", " ", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"bounddim", "\[Equal]", "0"}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"lattice", "[", 
         RowBox[{"{", 
          RowBox[{"\"\<Sites\>\"", "\[Rule]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"Select", "[", 
                RowBox[{"#", ",", "region"}], "]"}], "&"}], "/@", "#"}], 
             "&"}], ")"}]}], "}"}], "]"}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"1", "\[LessEqual]", "bounddim", "\[LessEqual]", "3"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"newsites", "=", 
         RowBox[{"ShellFill", "[", 
          RowBox[{
           RowBox[{"Length", "@", "axes"}], ",", "region", ",", "sites", ",", 
           
           RowBox[{"brvectors", "[", 
            RowBox[{"[", "axes", "]"}], "]"}], ",", "seed"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"newlattice", "=", 
         RowBox[{"lattice", "[", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\"\<Sites\>\"", "\[Rule]", "newsites"}], ",", 
            RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Delete", "[", 
                RowBox[{"#", ",", 
                 RowBox[{"List", "/@", "axes"}]}], "]"}], "&"}], ")"}]}]}], 
           "}"}], "]"}]}]}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"MakeBounded", "::", "dim"}], ",", " ", "bounddim"}], "]"}],
         ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "newlattice"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.597646546373519*^9, 3.597646569127303*^9}, {
   3.597646744078133*^9, 3.597646846914662*^9}, {3.597646892897003*^9, 
   3.5976470732051373`*^9}, {3.5976471074632597`*^9, 
   3.5976471129395533`*^9}, {3.597647145986471*^9, 3.597647610090413*^9}, {
   3.597647724514563*^9, 3.597647729491315*^9}, {3.5976483019049807`*^9, 
   3.597648365590722*^9}, {3.597648737294407*^9, 3.597648742878798*^9}, 
   3.597653679233261*^9, {3.5976710351207*^9, 3.597671043001302*^9}, {
   3.5978658213679657`*^9, 3.597865887388298*^9}, {3.5983397579647627`*^9, 
   3.598339812633667*^9}, {3.598340327649024*^9, 3.598340346730049*^9}, {
   3.5986112148475237`*^9, 3.5986112326150017`*^9}, {3.598611262712944*^9, 
   3.598611324328986*^9}, {3.598611358448805*^9, 3.5986113628099327`*^9}, {
   3.59861144066404*^9, 3.5986114502345877`*^9}, {3.5986116131535463`*^9, 
   3.598611626209159*^9}, {3.59861165702877*^9, 3.598611712726749*^9}, {
   3.60776117388335*^9, 3.6077612010179663`*^9}, 3.629641795939333*^9},
 CellLabel->
  "In[196]:=",ExpressionUUID->"c4929cc9-0125-490e-b0c7-a645aad1e181"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "ReshapeAxis", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Axis", "\[Rule]", "1"}], ",", 
      RowBox[{"Region", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"Total", "[", 
           SuperscriptBox["#", "2"], "]"}], "<", 
          SuperscriptBox["10", "2"]}], "&"}], ")"}]}], ",", " ", 
      RowBox[{"Seed", "\[Rule]", "Automatic"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ReshapeAxis", "::", "axis"}], "=", 
   "\"\<The reshape axis `1` is not an integer between 1 and the number of \
Bravais vectors in the lattice, which is `2`.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ReshapeAxis", "[", 
   RowBox[{"lattice_MQLattice", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"axis", "=", 
       RowBox[{"OptionValue", "[", "Axis", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"region", "=", 
       RowBox[{"OptionValue", "[", "Region", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"seed", "=", 
       RowBox[{"OptionValue", "[", "Seed", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"sites", "=", 
       RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"brvectors", "=", 
       RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", "newsites", ",", " ", "newlattice", ",", " ", 
      "pos"}], "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"IntegerQ", "[", "axis", "]"}], "&&", 
          RowBox[{"1", "\[LessEqual]", "axis", "\[LessEqual]", 
           RowBox[{"Length", "@", "brvectors"}]}]}], ")"}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"ReshapeAxis", "::", "axis"}], ",", " ", "axis", ",", 
          RowBox[{"Length", "@", "brvectors"}]}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"newsites", "=", 
      RowBox[{"ShellFill", "[", 
       RowBox[{"1", ",", 
        RowBox[{
         RowBox[{
          RowBox[{"region", "[", "#", "]"}], "&&", 
          RowBox[{"!", 
           RowBox[{"region", "[", 
            RowBox[{"#", "-", 
             RowBox[{"brvectors", "[", 
              RowBox[{"[", "axis", "]"}], "]"}]}], "]"}]}]}], "&"}], ",", 
        "sites", ",", 
        RowBox[{"brvectors", "[", 
         RowBox[{"[", 
          RowBox[{"{", "axis", "}"}], "]"}], "]"}], ",", "seed"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"newlattice", "=", 
      RowBox[{"lattice", "[", 
       RowBox[{"\"\<Sites\>\"", "\[Rule]", "newsites"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "newlattice"}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.5976482569616528`*^9, 3.5976482923372087`*^9}, {
   3.597648666857894*^9, 3.59764873223776*^9}, {3.597648775384848*^9, 
   3.5976489605169563`*^9}, 3.597650399039877*^9, {3.597651384027626*^9, 
   3.597651401452824*^9}, {3.597651904735078*^9, 3.597651925314086*^9}, {
   3.597653677264114*^9, 3.597653690440611*^9}, {3.597753546457596*^9, 
   3.597753755212552*^9}, 3.597753825489173*^9, {3.597754208022382*^9, 
   3.59775424831003*^9}, {3.597754279220934*^9, 3.59775430341179*^9}, 
   3.597754446474347*^9, {3.5977547137935038`*^9, 3.597754714160491*^9}, {
   3.597755114407763*^9, 3.597755126956736*^9}, {3.5977553319022512`*^9, 
   3.5977553323576717`*^9}, {3.5977554131443367`*^9, 3.597755483084*^9}, {
   3.5977555158322077`*^9, 3.5977555196144943`*^9}, 3.59775559383496*^9, {
   3.597865924511877*^9, 3.5978659387744703`*^9}, {3.597866539817478*^9, 
   3.597866542358905*^9}, 3.597866629311763*^9, {3.598352959198894*^9, 
   3.598353006082975*^9}, {3.619944778340742*^9, 3.619944813545145*^9}, {
   3.6199448811173964`*^9, 3.619944881957562*^9}, 3.6296417964270563`*^9},
 CellLabel->
  "In[202]:=",ExpressionUUID->"c0983397-f859-443b-a648-eca7729830e6"],

Cell["\<\
CombineLattices will combine two lattices if their Bravais vectors are the \
same (modulo reordering)\
\>", "Text",
 CellChangeTimes->{{3.59860167203327*^9, 
  3.598601700969808*^9}},ExpressionUUID->"d0ed749f-0b97-4eb6-9ab8-\
c3dbdbdd97ab"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"CombineLattices", "::", "bravais"}], "=", 
   "\"\<Lattices are not compatible, since their Bravais vectors are not the \
same.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"CombineLattices", "[", "lattices__MQLattice", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "brvectors", ",", "newlattice", ",", " ", "sites", ",", " ", "tags", ",",
       " ", "lattice"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"brvectors", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", "\"\<BravaisVectors\>\"", "]"}], "&"}], "/@", 
       RowBox[{"{", "lattices", "}"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"Equal", "@@", 
         RowBox[{"SetPrecision", "[", 
          RowBox[{
           RowBox[{"Chop", "[", 
            RowBox[{"Sort", "/@", "brvectors"}], "]"}], ",", "8"}], "]"}]}]}],
        ",", " ", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"CombineLattices", "::", "bravais"}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"sites", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", "\"\<Sites\>\"", "]"}], "&"}], "/@", 
       RowBox[{"{", "lattices", "}"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"tags", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", "\"\<Tags\>\"", "]"}], "&"}], "/@", 
       RowBox[{"{", "lattices", "}"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"lattice", "=", 
      RowBox[{
       RowBox[{"First", "[", 
        RowBox[{"{", "lattices", "}"}], "]"}], "[", 
       RowBox[{"\"\<Sites\>\"", "\[Rule]", 
        RowBox[{"Join", "@@", "sites"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"lattice", "[", 
      RowBox[{"\"\<Tags\>\"", "\[Rule]", 
       RowBox[{"Join", "@@", "tags"}]}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.598601702057617*^9, 3.5986020043414803`*^9}, {
   3.598618427044924*^9, 3.598618438942923*^9}, {3.598688145370165*^9, 
   3.598688151870525*^9}, {3.598701957675606*^9, 3.598702056218253*^9}, {
   3.602922194623146*^9, 3.602922203365365*^9}, {3.603535938211553*^9, 
   3.6035359818542347`*^9}, {3.603536109015583*^9, 3.603536114173705*^9}, {
   3.6035361455965643`*^9, 3.6035361460513887`*^9}, {3.603536193833172*^9, 
   3.603536196374288*^9}, 3.629641797002735*^9},
 CellLabel->
  "In[205]:=",ExpressionUUID->"e658e0fc-1be1-44a4-b8e1-a7aa25c4939d"],

Cell["Remove sites in the lattice unit cell in a selected region", "Text",
 CellChangeTimes->{{3.611668696880238*^9, 
  3.6116687150386333`*^9}},ExpressionUUID->"74a329e5-832e-4f2a-8196-\
69f33af8d367"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"RemoveSites", "::", "usage"}], "=", 
   "\"\<Removes certain sites or sites in selected region\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"RemoveSites", "[", 
   RowBox[{"lattice_MQLattice", ",", "Exclusion_Function"}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"excluded", "=", 
      RowBox[{"Exclusion", "@@@", 
       RowBox[{"Transpose", "@", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}], ",", 
          RowBox[{"Flatten", "@", 
           RowBox[{"lattice", "[", "\"\<SiteTags\>\"", "]"}]}]}], "}"}]}]}]}],
      "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"sites", "=", 
        RowBox[{"Flatten", "@", 
         RowBox[{"Position", "[", 
          RowBox[{"excluded", ",", "True"}], "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"sites", "=!=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"RemoveSites", "[", 
         RowBox[{"lattice", ",", "sites"}], "]"}], ",", "lattice"}], "]"}]}], 
     "]"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"RemoveSites", "[", 
   RowBox[{"lattice_MQLattice", ",", "sitelist_List"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "nonflatindices", ",", " ", "taggroupsizes", ",", " ", 
      "startinggroupindices"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"taggroupsizes", "=", 
      RowBox[{"Length", "/@", 
       RowBox[{"lattice", "[", "\"\<SiteIndices\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"startinggroupindices", "=", 
      RowBox[{"1", "+", 
       RowBox[{"Prepend", "[", 
        RowBox[{
         RowBox[{"Accumulate", "[", "taggroupsizes", "]"}], ",", "0"}], 
        "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "We", " ", "Use", " ", "BinList", " ", "to", " ", "classify", " ", 
        "sitelist", " ", "into", " ", "different", " ", "tag", " ", 
        "groups"}], ",", " ", 
       RowBox[{
        RowBox[{
        "and", " ", "prepend", " ", "to", " ", "the", " ", "offset", " ", 
         "within", " ", "the", " ", "group", " ", "an", " ", "integer", " ", 
         "denoting", " ", "the", " ", 
         RowBox[{"group", ".", " ", "Then"}], " ", "we", " ", "use", " ", 
         "rank"}], "-", 
        RowBox[{
        "2", " ", "Delete", " ", "to", " ", "remove", " ", "those", " ", 
         "sites"}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"nonflatindices", "=", 
      RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Thread", "/@", 
           RowBox[{"Transpose", "[", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Range", "[", 
               RowBox[{"Length", "@", "#"}], "]"}], ",", "#"}], "}"}], 
            "]"}]}], "&"}], "@", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#1", "-", "#2", "+", "1"}], "&"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"BinLists", "[", 
              RowBox[{"sitelist", ",", 
               RowBox[{"{", "startinggroupindices", "}"}]}], "]"}], ",", 
             RowBox[{"Most", "@", "startinggroupindices"}]}], "}"}]}], 
          "]"}]}], ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"lattice", "[", 
       RowBox[{"\"\<Sites\>\"", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Delete", "[", 
           RowBox[{"#", ",", "nonflatindices"}], "]"}], "&"}], ")"}]}], "]"}],
       "[", 
      RowBox[{"\"\<Sites\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"DeleteCases", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", "}"}]}], "]"}], "&"}], ")"}]}], "]"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{
  3.624274061582418*^9, 3.6296417974910192`*^9, {3.6392054517677*^9, 
   3.639205479876631*^9}, {3.639205510372723*^9, 3.639205512413352*^9}, {
   3.639206788182666*^9, 3.6392070480820627`*^9}, {3.639207402257951*^9, 
   3.6392074119688177`*^9}, {3.6392074526306953`*^9, 
   3.6392074569695807`*^9}, {3.639207492797797*^9, 3.6392075336217203`*^9}, {
   3.674016887592057*^9, 3.674016916295026*^9}, {3.6740169810467777`*^9, 
   3.6740170070627537`*^9}, {3.674017101734785*^9, 3.674017164069516*^9}, {
   3.674017208166155*^9, 3.674017208940955*^9}, {3.674017301285926*^9, 
   3.674017324923277*^9}, {3.674017394155888*^9, 3.674017428531005*^9}, {
   3.674017603632472*^9, 3.674017603799795*^9}, {3.6902648729981403`*^9, 
   3.690264925962984*^9}},
 CellLabel->
  "In[207]:=",ExpressionUUID->"ff8ee831-a1e4-4354-969b-21aeb517e15a"]
}, Closed]],

Cell[CellGroupData[{

Cell["BuildSystem and BuildScatteringSystem", "Subsection",
 CellChangeTimes->{{3.5976537423541183`*^9, 3.5976537453603907`*^9}, {
   3.597668468668816*^9, 3.597668470374036*^9}, {3.5976687729176893`*^9, 
   3.5976687735633717`*^9}, 3.5981829604190397`*^9, {3.598340725968041*^9, 
   3.5983407342318068`*^9}, {3.598593795134614*^9, 3.5985937962203903`*^9}, {
   3.6355186086758347`*^9, 
   3.63551861292999*^9}},ExpressionUUID->"9c36287a-e846-42f4-ad1f-\
70984e180b8d"],

Cell["Build a simple system", "Text",
 CellChangeTimes->{{3.598074127854286*^9, 
  3.598074136862556*^9}},ExpressionUUID->"4e7ae57f-dc92-49f3-be20-\
cafcf451030e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Onsite", "::", "usage"}], "=", 
   "\"\<Option for BuildSystem that specifies the onsite Hamiltonian to use, \
in the form of a function H[r_List, tag_] of a single spatial point (the \
position of the site).\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Hopping", "::", "usage"}], "=", 
   "\"\<Option for BuildSystem that specifies the hopping Hamiltonian to use, \
in the form of a function V[r1_List, r2_List, tag1_,tag2_] of a two spatial \
points (the position r1 of the end site and r2 of the end site).\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"HoppingRange", "::", "usage"}], " ", "=", " ", 
   "\"\<Option for BuildSystem that specifies the maximum (Euclidian) \
distance to consider when computing which sites are linked by hopping \
terms.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MaxNeighbors", "::", "usage"}], "=", 
   "\"\<Option for BuildSystem that specifies the maximum number of neighbor \
to each site\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MakeHermitian", "::", "usage"}], "=", 
   "\"\<Option for BuildSystem that forces the Hamiltonian to be \
Hermitian\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExtraBonds", "::", "usage"}], "=", 
   "\"\<Option for BuildSystem in the form of list of index pairs that forces \
corresponding sites to be linked.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RemoveBonds", "::", "usage"}], "=", 
   "\"\<Option for BuildSystem in the form of list of index pairs that forces \
corresponding sites to not be linked.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"EmbedLattice", "::", "usage"}], "=", 
    "\"\<Indicates whether the lattice used to build the system should be \
embedded within the MQSystem object.\>\""}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BuildSystem", "::", "dim"}], "=", 
   "\"\<Incompatible dimensions of Onsite and Hopping Hamiltonians.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BuildSystem", "::", "range"}], "=", 
   "\"\<Warning: Hopping range exceeds the size of the unit cell. Try using a \
larger supercell, or decreasing HoppingRange\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BuildSystem", "::", "nonhermitian"}], "=", 
    "\"\<Warning: Your system Hamiltonian is not Hermitian.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BuildSystem", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"HoppingRange", "\[Rule]", "1.01"}], ",", "\[IndentingNewLine]", 
      RowBox[{"MaxNeighbors", "\[Rule]", "All"}], ",", "\[IndentingNewLine]", 
      
      RowBox[{"ExtraBonds", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
      RowBox[{"RemoveBonds", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
      
      RowBox[{"Onsite", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{"0.", "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"Hopping", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{"1.", "&"}], ")"}]}], ",", " ", "\[IndentingNewLine]", 
      RowBox[{"Nambu", "\[Rule]", "False"}], ",", "\[IndentingNewLine]", 
      RowBox[{"MakeHermitian", "\[Rule]", "False"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"EmbedLattice", "\[Rule]", "True"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"BuildSystem", "[", 
     RowBox[{"preset_String", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"BuildSystem", "[", 
     RowBox[{
      RowBox[{"MQLattice", "[", "preset", "]"}], ",", "opts"}], "]"}]}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"BuildSystem", "[", 
     RowBox[{
      RowBox[{"sites_", "?", "IsValidSitesQ"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"BuildSystem", "[", 
     RowBox[{
      RowBox[{"MQLattice", "[", "sites", "]"}], ",", "opts"}], "]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"BuildSystem", "[", 
   RowBox[{"lattice_MQLattice", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"H", "=", 
       RowBox[{"OptionValue", "[", "Onsite", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"V", "=", 
       RowBox[{"OptionValue", "[", "Hopping", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"hoprange", "=", 
       RowBox[{"1.00000001", 
        RowBox[{"OptionValue", "[", "HoppingRange", "]"}]}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"maxneighbors", "=", 
       RowBox[{"OptionValue", "[", "MaxNeighbors", "]"}]}], ",", 
      "\[IndentingNewLine]", "numberofneighbors", ",", "\[IndentingNewLine]", 
      
      RowBox[{"extrabonds", "=", 
       RowBox[{"OptionValue", "[", "ExtraBonds", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"removebonds", "=", 
       RowBox[{"OptionValue", "[", "RemoveBonds", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"brvectors", "=", 
       RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"flatsitetags", "=", 
       RowBox[{"Flatten", "@", 
        RowBox[{"lattice", "[", "\"\<SiteTags\>\"", "]"}]}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"flatsites", "=", 
       RowBox[{"N", "@", 
        RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}]}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"numbersites", "=", 
       RowBox[{"lattice", "[", "\"\<NumberOfSites\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", "sitedimensions", ",", " ", "nearestfunction", 
      ",", "HBloch", ",", "computeHSelf", ",", "computeHBloch", ",", 
      "\[IndentingNewLine]", "system"}], "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"hoprange", ">", 
         RowBox[{"Min", "[", 
          RowBox[{"Norm", "/@", 
           RowBox[{"(", 
            RowBox[{"2", 
             RowBox[{
              RowBox[{"Tuples", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
                RowBox[{"Length", "@", "brvectors"}]}], "]"}], ".", 
              "brvectors"}]}], ")"}]}], "]"}]}], ",", " ", 
        RowBox[{"Message", "[", 
         RowBox[{"BuildSystem", "::", "range"}], "]"}]}], "]"}], ";"}], 
     "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"This", " ", "fails", " ", "when", " ", "H", " ", "is", " ", 
       RowBox[{"symbolic", ":", " ", 
        RowBox[{"Dimensions", "[", 
         RowBox[{"2", "t"}], "]"}]}]}], "=", 
      RowBox[{"{", "2", "}"}]}], "*)"}], "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Dimensions", "@", 
          RowBox[{"H", "[", 
           RowBox[{
            RowBox[{"First", "@", "flatsites"}], ",", " ", 
            RowBox[{"First", "@", "flatsitetags"}]}], "]"}]}], "==", 
         RowBox[{"Dimensions", "@", 
          RowBox[{"V", "[", 
           RowBox[{
            RowBox[{"First", "@", "flatsites"}], ",", 
            RowBox[{"Last", "@", "flatsites"}], ",", " ", 
            RowBox[{"First", "@", "flatsitetags"}], ",", " ", 
            RowBox[{"Last", "@", "flatsitetags"}]}], "]"}]}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"sitedimensions", "=", 
         RowBox[{"Dimensions", "@", 
          RowBox[{"H", "[", 
           RowBox[{
            RowBox[{"First", "@", "flatsites"}], ",", 
            RowBox[{"First", "@", "flatsitetags"}]}], "]"}]}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"BuildSystem", "::", "dim"}], "]"}], ";", " ", 
         RowBox[{"Abort", "[", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
      ";"}], "*)"}], " ", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"sitedimensions", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"MatrixQ", "[", 
         RowBox[{"H", "[", 
          RowBox[{
           RowBox[{"First", "@", "flatsites"}], ",", " ", 
           RowBox[{"First", "@", "flatsitetags"}]}], "]"}], "]"}], ",", 
        RowBox[{"sitedimensions", "=", 
         RowBox[{"Dimensions", "@", 
          RowBox[{"H", "[", 
           RowBox[{
            RowBox[{"First", "@", "flatsites"}], ",", " ", 
            RowBox[{"First", "@", "flatsitetags"}]}], "]"}]}]}], ",", 
        RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"nearestfunction", "=", 
      RowBox[{"Nearest", "[", 
       RowBox[{"flatsites", "\[Rule]", "Automatic"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "This", " ", "avoids", " ", "a", " ", "crash", " ", "for", " ", "very",
         " ", "large", " ", 
        RowBox[{"lattices", ".", " ", "UPDATE"}]}], " ", "-", " ", 
       RowBox[{"The", " ", "fix", " ", "was", " ", 
        RowBox[{"wrong", ":", " ", 
         RowBox[{
         "hoppings", " ", "can", " ", "exceeds", " ", "the", " ", "ones", " ",
           "intracell"}]}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"IntegerQ", "[", "maxneighbors", "]"}], ",", 
       RowBox[{"numberofneighbors", "=", 
        RowBox[{"maxneighbors", "+", "1"}]}], ",", 
       RowBox[{"numberofneighbors", "=", 
        RowBox[{"(*", 
         RowBox[{"lattice", "[", "\"\<NumberOfSites\>\"", "]"}], "*)"}], 
        "All"}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"computeHSelf", "[", "]"}], ":=", 
      RowBox[{"Block", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"neighbors", ",", " ", "rules"}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"neighbors", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"Flatten", "[", 
             RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
           RowBox[{"MapIndexed", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Thread", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"#2", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], ",", 
                 RowBox[{"Rest", "@", 
                  RowBox[{"nearestfunction", "[", 
                   RowBox[{"#1", ",", 
                    RowBox[{"{", 
                    RowBox[{"numberofneighbors", ",", 
                    RowBox[{"N", "@", "hoprange"}]}], "}"}]}], "]"}]}]}], 
                "}"}], "]"}], "&"}], ",", "flatsites"}], "]"}]}]}], ";", " ", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"MatrixQ", "[", 
            RowBox[{"extrabonds", ",", "IntegerQ"}], "]"}], ",", 
           RowBox[{"neighbors", "=", 
            RowBox[{"DeleteDuplicates", "[", 
             RowBox[{"Join", "[", 
              RowBox[{"neighbors", ",", "extrabonds", ",", " ", 
               RowBox[{"Reverse", "/@", "extrabonds"}]}], "]"}], "]"}]}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"MatrixQ", "[", 
            RowBox[{"removebonds", ",", "IntegerQ"}], "]"}], ",", 
           RowBox[{"neighbors", "=", 
            RowBox[{"Complement", "[", 
             RowBox[{"neighbors", ",", "removebonds", ",", " ", 
              RowBox[{"Reverse", "/@", "removebonds"}]}], "]"}]}]}], "]"}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
           "Build", " ", "all", " ", "pairs", " ", "without", " ", "self"}], 
           "-", "hoppings"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"rules", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "\[Rule]", 
             RowBox[{"(*", 
              RowBox[{"N", "@"}], "*)"}], 
             RowBox[{"V", "[", 
              RowBox[{
               RowBox[{"flatsites", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}], ",", 
               RowBox[{"flatsites", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}], ",", 
               RowBox[{"flatsitetags", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}], ",", 
               RowBox[{"flatsitetags", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}]}], "]"}]}], 
            "&"}], "/@", "neighbors"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"rules", "=", 
          RowBox[{"Join", "[", 
           RowBox[{"rules", ",", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{"#", ",", "#"}], "}"}], "\[Rule]", 
               RowBox[{"(*", 
                RowBox[{"N", "@"}], "*)"}], 
               RowBox[{"H", "[", 
                RowBox[{
                 RowBox[{"flatsites", "[", 
                  RowBox[{"[", "#", "]"}], "]"}], ",", 
                 RowBox[{"flatsitetags", "[", 
                  RowBox[{"[", "#", "]"}], "]"}]}], "]"}]}], "&"}], "/@", 
             RowBox[{"Range", "[", "numbersites", "]"}]}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"sitedimensions", "\[Equal]", 
            RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"SparseArray", "[", 
            RowBox[{"rules", ",", 
             RowBox[{"{", 
              RowBox[{"numbersites", ",", "numbersites"}], "}"}]}], "]"}], 
           ",", "\[IndentingNewLine]", 
           RowBox[{"SparseArray", "[", 
            RowBox[{
             RowBox[{"FlattenRules", "[", "rules", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"numbersites", ",", "numbersites", ",", 
               RowBox[{"Sequence", "@@", "sitedimensions"}]}], "}"}]}], 
            "]"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"computeHBloch", "[", "shiftedflatsites_", "]"}], ":=", 
      RowBox[{"Block", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"neighbors", ",", " ", "rules"}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"neighbors", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"Flatten", "[", 
             RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
           RowBox[{"MapIndexed", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Thread", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"#2", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], ",", 
                 RowBox[{"nearestfunction", "[", 
                  RowBox[{"#1", ",", 
                   RowBox[{"{", 
                    RowBox[{"numberofneighbors", ",", 
                    RowBox[{"N", "@", "hoprange"}]}], "}"}]}], "]"}]}], "}"}],
                "]"}], "&"}], ",", "shiftedflatsites"}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"rules", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "\[Rule]", 
             RowBox[{"(*", 
              RowBox[{"N", "@"}], "*)"}], 
             RowBox[{"V", "[", 
              RowBox[{
               RowBox[{"flatsites", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}], ",", 
               RowBox[{"shiftedflatsites", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}], ",", 
               RowBox[{"flatsitetags", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}], ",", 
               RowBox[{"flatsitetags", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}]}], "]"}]}], 
            "&"}], "/@", "neighbors"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"sitedimensions", "\[Equal]", 
            RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"SparseArray", "[", 
            RowBox[{"rules", ",", 
             RowBox[{"{", 
              RowBox[{"numbersites", ",", "numbersites"}], "}"}]}], "]"}], 
           ",", "\[IndentingNewLine]", 
           RowBox[{"SparseArray", "[", 
            RowBox[{
             RowBox[{"FlattenRules", "[", "rules", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"numbersites", ",", "numbersites", ",", 
               RowBox[{"Sequence", "@@", "sitedimensions"}]}], "}"}]}], 
            "]"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"HBloch", "=", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "@", "brvectors"}], "\[Equal]", "0"}], ",", 
         RowBox[{"{", 
          RowBox[{"{", "0", "}"}], "}"}], ",", 
         RowBox[{"Tuples", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"0", ",", 
             RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
           RowBox[{"Length", "@", "brvectors"}]}], "]"}]}], "]"}], "/.", 
       RowBox[{
        RowBox[{"{", "i__Integer", "}"}], "\[RuleDelayed]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"And", "@@", 
           RowBox[{"Thread", "[", 
            RowBox[{"0", "\[Equal]", 
             RowBox[{"{", "i", "}"}]}], "]"}]}], ",", 
          RowBox[{
           RowBox[{"{", "i", "}"}], "->", 
           RowBox[{"computeHSelf", "[", "]"}]}], ",", 
          RowBox[{
           RowBox[{"{", "i", "}"}], "->", 
           RowBox[{"computeHBloch", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "+", 
               RowBox[{
                RowBox[{"{", "i", "}"}], ".", "brvectors"}]}], "&"}], "/@", 
             "flatsites"}], "]"}]}]}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "@", "MakeHermitian"}], ",", 
       RowBox[{"HBloch", "=", 
        RowBox[{"HBloch", "/.", 
         RowBox[{
          RowBox[{"Rule", "[", 
           RowBox[{"a_", ",", "h_"}], "]"}], "\[RuleDelayed]", 
          RowBox[{"Rule", "[", 
           RowBox[{"a", ",", 
            RowBox[{
             FractionBox["1", "2"], 
             RowBox[{"(", 
              RowBox[{"h", "+", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "a"}], "/.", "HBloch"}], ")"}], 
                "\[HermitianConjugate]"}]}], ")"}]}]}], "]"}]}]}]}]}], "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"For", " ", "a", " ", "bounded", " ", "system"}], ",", " ", 
       RowBox[{
       "HBloch", " ", "should", " ", "not", " ", "have", " ", "Bloch", " ", 
        "indices"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", "brvectors"}], "\[Equal]", "0"}], ",", 
       RowBox[{"HBloch", "=", 
        RowBox[{"HBloch", "/.", 
         RowBox[{
          RowBox[{"{", "0", "}"}], "\[Rule]", 
          RowBox[{"{", "}"}]}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "@", "EmbedLattice"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"system", "=", 
        RowBox[{"MQSystem", "[", 
         RowBox[{
          RowBox[{"\"\<HBloch\>\"", "\[Rule]", "HBloch"}], ",", " ", 
          RowBox[{"\"\<Nambu\>\"", "\[Rule]", 
           RowBox[{"OptionValue", "[", "Nambu", "]"}]}], ",", " ", 
          RowBox[{"\"\<Lattice\>\"", "\[Rule]", "lattice"}]}], "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"system", "=", 
        RowBox[{"MQSystem", "[", 
         RowBox[{
          RowBox[{"\"\<HBloch\>\"", "\[Rule]", "HBloch"}], ",", " ", 
          RowBox[{"\"\<Nambu\>\"", "\[Rule]", 
           RowBox[{"OptionValue", "[", "Nambu", "]"}]}], ",", 
          RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
           RowBox[{"Missing", "[", "]"}]}]}], "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"system", "=", 
        RowBox[{"MQSystem", "[", 
         RowBox[{
          RowBox[{"\"\<HBloch\>\"", "\[Rule]", "HBloch"}], ",", " ", 
          RowBox[{"\"\<Nambu\>\"", "\[Rule]", 
           RowBox[{"OptionValue", "[", "Nambu", "]"}]}], ",", " ", 
          RowBox[{"\"\<Lattice\>\"", "\[Rule]", "lattice"}]}], "]"}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"HermitianSystemQ", "[", "system", "]"}]}], ",", 
       RowBox[{"Message", "[", 
        RowBox[{"BuildSystem", "::", "nonhermitian"}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Return", "[", "system", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.59766849150178*^9, 3.597668499467346*^9}, {
   3.597668578978745*^9, 3.59766858256321*^9}, {3.597668787576057*^9, 
   3.597668811878972*^9}, {3.597668851780249*^9, 3.597668887142755*^9}, {
   3.5976693515454817`*^9, 3.5976693728248672`*^9}, {3.597669468887236*^9, 
   3.597669535731599*^9}, {3.597669574951082*^9, 3.597669633482828*^9}, {
   3.5976700250310173`*^9, 3.597670107228706*^9}, {3.597670143815413*^9, 
   3.597670192731003*^9}, 3.597670250823339*^9, {3.597670305867029*^9, 
   3.597670335534132*^9}, {3.597670502906528*^9, 3.597670518282467*^9}, {
   3.597670979456793*^9, 3.597670980462399*^9}, {3.597671377558155*^9, 
   3.597671380582019*^9}, {3.5976714418967*^9, 3.597671446064942*^9}, {
   3.597671488733713*^9, 3.597671503509547*^9}, {3.597671614740588*^9, 
   3.597671615924624*^9}, {3.597671677193716*^9, 3.597671727252741*^9}, {
   3.5976718290117483`*^9, 3.597671977318327*^9}, {3.597676465055151*^9, 
   3.59767650813135*^9}, {3.5976765505297527`*^9, 3.597676605389658*^9}, {
   3.597676639560433*^9, 3.597676929773611*^9}, {3.5976771237082977`*^9, 
   3.597677329121098*^9}, {3.597677379912916*^9, 3.59767738556564*^9}, {
   3.597677440001793*^9, 3.5976774955964813`*^9}, 3.597677610166725*^9, {
   3.597677695835539*^9, 3.597677820395226*^9}, {3.5976778850176992`*^9, 
   3.597678364457838*^9}, {3.597678404275242*^9, 3.597678483706595*^9}, {
   3.5976785867215242`*^9, 3.597678684016769*^9}, {3.597678850417203*^9, 
   3.59767903653434*^9}, {3.597679078727583*^9, 3.597679109554435*^9}, {
   3.597679164321411*^9, 3.59767922535503*^9}, {3.5976793830871897`*^9, 
   3.5976794482646*^9}, {3.5976794850068607`*^9, 3.597679541110113*^9}, {
   3.597737724009612*^9, 3.597737726015334*^9}, {3.597737793587596*^9, 
   3.597737962500308*^9}, {3.59773801018191*^9, 3.597738012347127*^9}, {
   3.5977380518885803`*^9, 3.5977384160986547`*^9}, {3.597738469358554*^9, 
   3.5977385412075233`*^9}, {3.597738599077986*^9, 3.597738643637041*^9}, {
   3.597739788049177*^9, 3.597739799495385*^9}, 3.597765886902534*^9, {
   3.597766147098113*^9, 3.597766223199555*^9}, {3.597766574032917*^9, 
   3.597766588920456*^9}, {3.597766915064623*^9, 3.597766931970037*^9}, 
   3.597865425051889*^9, {3.59786551041369*^9, 3.597865522227147*^9}, {
   3.5978659702421293`*^9, 3.5978659876942797`*^9}, {3.59786605135212*^9, 
   3.5978662172326317`*^9}, {3.597866250052355*^9, 3.597866316375329*^9}, {
   3.5978668818765163`*^9, 3.597866904162359*^9}, {3.597867092797367*^9, 
   3.597867130415861*^9}, {3.597867204646174*^9, 3.59786720489254*^9}, {
   3.5979419515501623`*^9, 3.59794195514937*^9}, {3.598071743949403*^9, 
   3.598071904567711*^9}, {3.598071987711336*^9, 3.5980721481765137`*^9}, {
   3.598072196835833*^9, 3.598072270720497*^9}, {3.59807233997295*^9, 
   3.5980723834168863`*^9}, 3.5980724339046288`*^9, {3.5980724665178843`*^9, 
   3.598072529529848*^9}, 3.598072875754486*^9, {3.5980732015404778`*^9, 
   3.598073208825777*^9}, {3.5980732580447283`*^9, 3.598073429925837*^9}, {
   3.5980735204520273`*^9, 3.598073598293318*^9}, 3.5980741243039417`*^9, 
   3.5980844378904047`*^9, {3.598084518556081*^9, 3.5980845186993933`*^9}, {
   3.598084728813642*^9, 3.598084733391514*^9}, {3.598085116321067*^9, 
   3.598085154603587*^9}, {3.59808523796189*^9, 3.598085239063595*^9}, {
   3.598085484509574*^9, 3.5980854858770113`*^9}, {3.598085524898053*^9, 
   3.598085526520977*^9}, {3.5980859218620234`*^9, 3.598085963452401*^9}, {
   3.598086108607233*^9, 3.598086155031488*^9}, {3.598086512013475*^9, 
   3.598086514308408*^9}, {3.598106192065542*^9, 3.598106202586252*^9}, {
   3.598257688568522*^9, 3.598257727744042*^9}, 3.5983523827790003`*^9, {
   3.598352635921586*^9, 3.5983526775637817`*^9}, {3.598352763760254*^9, 
   3.598352764449973*^9}, {3.598352806834962*^9, 3.5983528542380447`*^9}, {
   3.5985938071695147`*^9, 3.598593949892001*^9}, 3.59859417561703*^9, {
   3.598614975058337*^9, 3.5986150473912573`*^9}, {3.6077646075563507`*^9, 
   3.607764716632483*^9}, {3.6077648101894417`*^9, 3.6077648126222267`*^9}, {
   3.607764843230151*^9, 3.6077648521088753`*^9}, 3.607764928491859*^9, {
   3.6077653788549337`*^9, 3.6077653927416553`*^9}, {3.607765465492235*^9, 
   3.607765483197309*^9}, 3.607766303421687*^9, {3.610096213424876*^9, 
   3.610096216088813*^9}, 3.610096252522029*^9, {3.61167223511523*^9, 
   3.6116723628216143`*^9}, {3.611672402365093*^9, 3.611672423730936*^9}, {
   3.611672509672806*^9, 3.611672509815757*^9}, {3.622281474954501*^9, 
   3.6222814851557407`*^9}, 3.622281517207246*^9, {3.62228156455276*^9, 
   3.622281619101741*^9}, {3.622281806061521*^9, 3.6222818069412603`*^9}, {
   3.6243593527794113`*^9, 3.6243594378475437`*^9}, {3.6243594776871758`*^9, 
   3.624359608625318*^9}, {3.624359685766313*^9, 3.624359691147998*^9}, {
   3.624360002976121*^9, 3.624360003398365*^9}, {3.624360105837737*^9, 
   3.624360109578549*^9}, {3.624362985349378*^9, 3.6243630748355637`*^9}, {
   3.6243631172987757`*^9, 3.624363181270575*^9}, {3.6271999390881033`*^9, 
   3.627199952822207*^9}, {3.6296417983569393`*^9, 3.629641800229617*^9}, 
   3.6314494731913033`*^9, {3.631515043319145*^9, 3.631515056437764*^9}, {
   3.631515161985083*^9, 3.631515190602907*^9}, {3.6315152344535513`*^9, 
   3.63151524696384*^9}, {3.6315153208592253`*^9, 3.631515359119632*^9}, {
   3.631515404212749*^9, 3.631515407004581*^9}, {3.631515465116125*^9, 
   3.631515523897423*^9}, {3.6315157381711483`*^9, 3.631515751565048*^9}, {
   3.63151616233013*^9, 3.631516229476266*^9}, {3.631518131705359*^9, 
   3.631518140800284*^9}, 3.6315181748001127`*^9, {3.631518227292761*^9, 
   3.631518315936479*^9}, {3.631518353441494*^9, 3.6315183820771713`*^9}, {
   3.631518443845409*^9, 3.631518444233646*^9}, {3.631518491098805*^9, 
   3.631518513198614*^9}, {3.631518548657528*^9, 3.631518567908484*^9}, {
   3.635239217664484*^9, 3.635239224835176*^9}, {3.635240382949038*^9, 
   3.63524052934126*^9}, {3.635240590961954*^9, 3.635240596985896*^9}, {
   3.635241129448653*^9, 3.635241251273816*^9}, 3.635241513613638*^9, {
   3.635673638444673*^9, 3.6356736399001627`*^9}, {3.6356737321170063`*^9, 
   3.635673934289618*^9}, {3.6356740312233133`*^9, 3.635674112168055*^9}, {
   3.6356742414713917`*^9, 3.635674247758753*^9}, {3.635674340091764*^9, 
   3.63567436519352*^9}, {3.636353072936949*^9, 3.63635307965786*^9}, {
   3.6363531307226152`*^9, 3.636353245868684*^9}, {3.636353304915032*^9, 
   3.6363533344496527`*^9}, {3.636353419030957*^9, 3.636353419422234*^9}, {
   3.640852697484429*^9, 3.640852700602675*^9}, {3.6642726571943398`*^9, 
   3.664272659706677*^9}, {3.664272733727232*^9, 3.664272774468996*^9}, {
   3.664272858155313*^9, 3.6642728583935633`*^9}, {3.66482357703936*^9, 
   3.664823582176465*^9}, 3.664823682158452*^9, {3.664823720925753*^9, 
   3.664823733569536*^9}, {3.677386017240793*^9, 3.677386018934993*^9}, {
   3.6803290211544447`*^9, 3.680329022777491*^9}, {3.680329151592626*^9, 
   3.680329178119287*^9}, {3.680329916240528*^9, 3.680329925666554*^9}, {
   3.6803299806340237`*^9, 3.6803300103777018`*^9}, {3.680330040874402*^9, 
   3.680330054020952*^9}, {3.680330094525977*^9, 3.680330156500635*^9}, {
   3.682072797723309*^9, 3.682072807054706*^9}, {3.702275812195139*^9, 
   3.702275813035056*^9}, 3.740239424028841*^9},
 CellLabel->
  "In[210]:=",ExpressionUUID->"cfb2676c-bc79-4a9c-be3a-1cdcabcd1fb7"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"HermitianSystemQ", "[", "sys_MQSystem", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"foldedsys", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"sys", "[", "\"\<LatticeDimensions\>\"", "]"}], "\[Equal]", 
          "0"}], ",", "sys", ",", 
         RowBox[{"sys", "[", 
          RowBox[{"RandomReal", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"0", ",", 
              RowBox[{"2", "\[Pi]"}]}], "}"}], ",", 
            RowBox[{"sys", "[", "\"\<LatticeDimensions\>\"", "]"}]}], "]"}], 
          "]"}]}], "]"}]}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"Max", "[", 
         RowBox[{"Abs", "[", 
          RowBox[{"Chop", "[", 
           RowBox[{"#", "-", 
            RowBox[{"#", "\[HermitianConjugate]"}]}], "]"}], "]"}], "]"}], 
        "\[Equal]", "0"}], "&"}], "@", 
      RowBox[{
       RowBox[{"foldedsys", "[", "\"\<Flat\>\"", "]"}], "[", "\"\<H\>\"", 
       "]"}]}]}], "]"}]}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "Using", " ", "HermitianMatrixQ", " ", "here", " ", "results", " ", "in", 
    " ", "false", " ", "negatives"}], "*)"}], 
  "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.680329196643326*^9, 3.680329221956613*^9}, 
   3.680329329387773*^9, {3.680329396954596*^9, 3.6803294416355543`*^9}, {
   3.680329576719076*^9, 3.6803295788230047`*^9}, {3.6803296694578257`*^9, 
   3.680329689920586*^9}, {3.680329745002453*^9, 3.6803297513057404`*^9}, {
   3.680329803090918*^9, 3.680329852275765*^9}, 3.68207287811497*^9, {
   3.6820746848851347`*^9, 3.682074759880513*^9}},
 CellLabel->
  "In[223]:=",ExpressionUUID->"a6cf1c80-4f41-45aa-b23b-96f36b13504d"],

Cell["\<\
Modify an existing system without recomputing lattice neighbors\
\>", "Text",
 CellChangeTimes->{{3.598599027004746*^9, 3.598599041308218*^9}, {
   3.6563999371421347`*^9, 3.656399947893341*^9}, 
   3.666691465330079*^9},ExpressionUUID->"e4e06a40-1cc3-499f-b901-\
5638ba2524a9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Operation", "::", "usage"}], "=", 
    "\"\<Option for ModifySystem that specifies what operation (F[hop, \
oldhop] or F[onsite, oldonsite]) to perform on the system Hamiltonian to \
implement the modification.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "ModifySystem", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Operation", "\[Rule]", 
      RowBox[{"(", 
       RowBox[{"#1", "&"}], ")"}]}], ",", 
     RowBox[{"Onsite", "\[Rule]", "None"}], ",", " ", 
     RowBox[{"Hopping", "\[Rule]", "None"}]}], " ", "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ModifySystem", "[", 
   RowBox[{"system_MQSystem", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"lattice", "=", 
      RowBox[{"system", "[", "\"\<Lattice\>\"", "]"}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"lattice", "===", 
       RowBox[{"Missing", "[", "]"}]}], ",", 
      RowBox[{"Message", "[", 
       RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ",", 
      RowBox[{"ModifySystem", "[", 
       RowBox[{"lattice", ",", "system", ",", " ", "opts"}], "]"}]}], "]"}]}],
    "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ModifySystem", "[", 
   RowBox[{"lattice_MQLattice", ",", "system_MQSystem", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{"HBloch", ",", "\[IndentingNewLine]", 
      RowBox[{"latdim", "=", 
       RowBox[{"lattice", "[", "\"\<LatticeDimensions\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"flatsites", "=", 
       RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"flatsitetags", "=", 
       RowBox[{"Flatten", "@", 
        RowBox[{"lattice", "[", "\"\<SiteTags\>\"", "]"}]}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"brv", "=", 
       RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"operation", "=", 
       RowBox[{"OptionValue", "[", "Operation", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"onsite", "=", 
       RowBox[{"OptionValue", "[", "Onsite", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"hopping", "=", 
       RowBox[{"OptionValue", "[", "Hopping", "]"}]}], ",", 
      "\[IndentingNewLine]", "parser", ",", " ", "apply", ",", " ", 
      "applyonsites", ",", " ", "applyhoppings"}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"HBloch", "=", 
      RowBox[{"system", "[", "\"\<HBloch\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"applyonsites", "[", 
       RowBox[{"a_", ",", "h_SparseArray"}], "]"}], ":=", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"parser", "=", "\[IndentingNewLine]", 
          RowBox[{"Function", "[", 
           RowBox[{
            RowBox[{"{", "i", "}"}], ",", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"i", ",", "i"}], "}"}], "->", 
             RowBox[{"onsite", "[", 
              RowBox[{
               RowBox[{"flatsites", "[", 
                RowBox[{"[", "i", "]"}], "]"}], ",", 
               RowBox[{"flatsitetags", "[", 
                RowBox[{"[", "i", "]"}], "]"}]}], "]"}]}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"parser", "/@", 
          RowBox[{"Range", "[", 
           RowBox[{"1", ",", 
            RowBox[{"Length", "[", "h", "]"}]}], "]"}]}]}]}], 
       "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"applyhoppings", "[", 
       RowBox[{"a_", ",", "h_SparseArray"}], "]"}], ":=", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"shift", "=", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"a", "\[Equal]", 
              RowBox[{"{", "}"}]}], ",", " ", "0", ",", " ", 
             RowBox[{"a", ".", "brv"}]}], "]"}]}], ",", "\[IndentingNewLine]",
           " ", 
          RowBox[{"indices", "=", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"system", "[", "\"\<SiteDimensions\>\"", "]"}], 
              "\[Equal]", "1"}], ",", 
             RowBox[{"Most", "[", 
              RowBox[{"ArrayRules", "[", "h", "]"}], "]"}], ",", 
             RowBox[{"DeleteDuplicates", "[", 
              RowBox[{
               RowBox[{"Most", "[", 
                RowBox[{"ArrayRules", "[", "h", "]"}], "]"}], "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "1", ",", 
                 RowBox[{"{", 
                  RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "]"}], "]"}]}], 
            "]"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"parser", "=", "\[IndentingNewLine]", 
          RowBox[{"Function", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"i", ",", "j"}], "}"}], ",", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"i", "!=", "j"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"i", ",", "j"}], "}"}], "->", 
               RowBox[{"hopping", "[", 
                RowBox[{
                 RowBox[{"flatsites", "[", 
                  RowBox[{"[", "j", "]"}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"flatsites", "[", 
                   RowBox[{"[", "i", "]"}], "]"}], "+", "shift"}], ",", 
                 RowBox[{"flatsitetags", "[", 
                  RowBox[{"[", "j", "]"}], "]"}], ",", 
                 RowBox[{"flatsitetags", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]}], "]"}]}], ",", " ", 
              "Nothing"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"parser", "@@@", "indices"}]}]}], "\[IndentingNewLine]", 
       "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"apply", "[", 
       RowBox[{"a_", ",", "h_SparseArray"}], "]"}], ":=", 
      RowBox[{"Block", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"rules", "=", 
          RowBox[{"{", "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"onsite", "=!=", "None"}], ",", 
           RowBox[{"rules", "=", 
            RowBox[{"FlattenRules", "[", 
             RowBox[{"applyonsites", "[", 
              RowBox[{"a", ",", "h"}], "]"}], "]"}]}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"hopping", "=!=", "None"}], ",", 
           RowBox[{"rules", "=", 
            RowBox[{"Join", "[", 
             RowBox[{"rules", ",", 
              RowBox[{"FlattenRules", "[", 
               RowBox[{"applyhoppings", "[", 
                RowBox[{"a", ",", "h"}], "]"}], "]"}]}], "]"}]}]}], "]"}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"operation", "[", 
          RowBox[{
           RowBox[{"SparseArray", "[", 
            RowBox[{"rules", ",", " ", 
             RowBox[{"Dimensions", "@", "h"}]}], "]"}], ",", "h"}], "]"}]}]}],
        "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"HBloch", "=", 
      RowBox[{"HBloch", "/.", 
       RowBox[{
        RowBox[{"Rule", "[", 
         RowBox[{"a_", ",", "h_"}], "]"}], ":>", 
        RowBox[{"Rule", "[", 
         RowBox[{"a", ",", 
          RowBox[{"apply", "[", 
           RowBox[{"a", ",", "h"}], "]"}]}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"system", "[", 
      RowBox[{"\"\<HBloch\>\"", "\[Rule]", "HBloch"}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.598593973391058*^9, 3.598594108353506*^9}, {
   3.5985941508602867`*^9, 3.5985941544346037`*^9}, {3.5985941978047667`*^9, 
   3.598594411816935*^9}, {3.598594444393951*^9, 3.598594803672019*^9}, {
   3.598594840070019*^9, 3.598595035177485*^9}, {3.598597712582871*^9, 
   3.598597827556519*^9}, {3.598597989994536*^9, 3.5985980129702063`*^9}, {
   3.59859814347134*^9, 3.598598246545905*^9}, {3.598598289421644*^9, 
   3.598598323928056*^9}, {3.5985984421538258`*^9, 3.598598457352536*^9}, {
   3.598598892048078*^9, 3.598598944514111*^9}, 3.598599155948791*^9, {
   3.598599190322006*^9, 3.598599208256024*^9}, {3.624359329268894*^9, 
   3.624359334420755*^9}, {3.629641800931875*^9, 3.6296418015554857`*^9}, 
   3.6315121212142887`*^9, {3.631512192842388*^9, 3.631512215409006*^9}, {
   3.6315179013073273`*^9, 3.631517934345196*^9}, {3.631605710695869*^9, 
   3.631605711373743*^9}, {3.6563991827795753`*^9, 3.656399206257464*^9}, {
   3.65639925745677*^9, 3.6563992764575357`*^9}, {3.656399341447356*^9, 
   3.6563993447432327`*^9}, {3.656399542746872*^9, 3.656399550369142*^9}, {
   3.656399645479184*^9, 3.656399696742744*^9}, {3.656399741213066*^9, 
   3.656399758892812*^9}, {3.65639998658256*^9, 3.656399988054061*^9}, {
   3.6564009348624783`*^9, 3.656400938933622*^9}, {3.666691396472641*^9, 
   3.6666914307491627`*^9}, {3.667108940554969*^9, 3.66710894182689*^9}, {
   3.667109019886846*^9, 3.667109034968165*^9}, {3.667109292887493*^9, 
   3.6671093284886913`*^9}, {3.6741963637242126`*^9, 3.674196426507184*^9}, {
   3.67419672054261*^9, 3.674196741796425*^9}, {3.674204767323268*^9, 
   3.674204939538864*^9}, {3.674204969915145*^9, 3.674205282738119*^9}, {
   3.6742053196024714`*^9, 3.6742053225132227`*^9}, {3.6742053746884127`*^9, 
   3.674205380845376*^9}, {3.674205417916773*^9, 3.674205423951234*^9}, {
   3.693813545665744*^9, 3.6938135467105007`*^9}, {3.708322432543626*^9, 
   3.708322508349153*^9}, 3.708322544741805*^9, {3.708322940134431*^9, 
   3.708322973209717*^9}, {3.7083231299787397`*^9, 3.708323130145954*^9}, {
   3.7083235225639267`*^9, 3.708323528283148*^9}, {3.708323732056724*^9, 
   3.708323762463674*^9}, {3.7083238486469603`*^9, 3.708323870725775*^9}, {
   3.7083239269903316`*^9, 3.708324059507617*^9}, {3.708324092339355*^9, 
   3.708324330207444*^9}, {3.7083243766542883`*^9, 3.708324386846236*^9}, {
   3.7083244302696133`*^9, 3.708324506035575*^9}, {3.708324590715332*^9, 
   3.708324628094061*^9}, {3.708324659736664*^9, 3.7083246620990543`*^9}, {
   3.708324760457219*^9, 3.708324903534855*^9}, 3.7083249414870787`*^9, {
   3.7083250579013853`*^9, 3.7083253581076937`*^9}, {3.708325439623536*^9, 
   3.708325464645596*^9}, {3.708325592817499*^9, 3.708325689354526*^9}, {
   3.708325727361618*^9, 3.708325831416994*^9}, {3.708325870833303*^9, 
   3.708326051141501*^9}, {3.708326090909151*^9, 3.70832613048381*^9}, {
   3.708326188508911*^9, 3.708326222972131*^9}, {3.708326263012501*^9, 
   3.7083262926147346`*^9}, {3.708326324625297*^9, 3.708326327776133*^9}, {
   3.708326418528893*^9, 3.708326422703527*^9}, {3.708326662726398*^9, 
   3.708326761913054*^9}, {3.7083268971191893`*^9, 3.708326941694642*^9}, {
   3.708326994031856*^9, 3.708327047274517*^9}, {3.708327079257584*^9, 
   3.70832726573066*^9}, {3.7083273030834227`*^9, 3.708327371558961*^9}, {
   3.708327472864509*^9, 3.708327483395885*^9}, {3.708327847365407*^9, 
   3.7083278730297403`*^9}, 3.7083279216223173`*^9, {3.708327972373786*^9, 
   3.7083280324136868`*^9}, {3.708328139723592*^9, 3.708328189042646*^9}, 
   3.708328242537071*^9, 3.708328296952331*^9, {3.708328332821884*^9, 
   3.708328434743194*^9}, {3.708328501502214*^9, 3.708328502492293*^9}},
 CellLabel->
  "In[224]:=",ExpressionUUID->"f6149651-1254-4c7d-8fe1-4df6f075bb04"],

Cell["\<\
Modify a portion of  a system (onsite energies and hoppings *within* the unit \
cell)\
\>", "Text",
 CellChangeTimes->{{3.6563999897957993`*^9, 3.656399993027961*^9}, {
  3.656400023322936*^9, 3.656400025298835*^9}, {3.656402004458035*^9, 
  3.656402007704625*^9}, {3.66297132309682*^9, 3.662971329224574*^9}, {
  3.662971406437737*^9, 
  3.662971435731792*^9}},ExpressionUUID->"de0a3df1-5f0a-47d8-9d4d-\
830bc4343217"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"ModifySystemSites", "::", "usage"}], "=", 
  "\"\<Modify a given portion of  a system (onsite energies [SiteTransform \
option] and/or hoppings [BlockTransform option] *within* the unit \
cell)\>\""}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SiteIndices", "::", "usage"}], "=", 
   "\"\<Option for ModifySystemSites: a list of site indices to be modified\>\
\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SiteSelector", "::", "usage"}], "=", 
   "\"\<Option for ModifySystemSites: a boolean function of site position \
that selects sites to be modified\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SiteTransform", "::", "usage"}], "=", 
   "\"\<Option for ModifySystemSites: a function f[h, r] to be applied to the \
*onsite* Hamiltonian h of a given site at position r\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BlockTransform", "::", "usage"}], "=", 
   "\"\<Option for ModifySystemSites: a function f[h] to be applied to the \
Hamiltonian *block* h of of the collection of sites indicated by SiteSelector \
or SiteIndices.\>\""}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ModifySystemSites", "[", 
   RowBox[{"system_MQSystem", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"SiteSelector", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{"False", "&"}], ")"}]}], ",", " ", 
        RowBox[{"SiteIndices", "\[Rule]", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"SiteTransform", "\[Rule]", "None"}], ",", " ", 
        RowBox[{"BlockTransform", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{"#", "&"}], ")"}]}]}], "}"}], "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"lattice", "=", 
       RowBox[{"system", "[", "\"\<Lattice\>\"", "]"}]}], ",", 
      RowBox[{"selector", "=", 
       RowBox[{"OptionValue", "@", "SiteSelector"}]}], ",", "sitepositions", 
      ",", " ", "sites", ",", " ", "H0", ",", "Honsite", ",", " ", 
      "operation"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"lattice", "===", 
        RowBox[{"Missing", "[", "]"}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ";", 
        RowBox[{"Return", "[", "system", "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"sitepositions", "=", 
      RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"selector", "===", 
        RowBox[{"(", 
         RowBox[{"False", "&"}], ")"}]}], ",", 
       RowBox[{"sites", "=", 
        RowBox[{"OptionValue", "@", "SiteIndices"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"sites", "=", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"OptionValue", "@", "SiteIndices"}], ",", 
          RowBox[{"Flatten", "[", 
           RowBox[{"Position", "[", 
            RowBox[{
             RowBox[{"selector", "/@", "sitepositions"}], ",", "True"}], 
            "]"}], "]"}]}], "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"sites", "\[Equal]", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"Return", "[", "system", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"H0", "=", 
      RowBox[{"system", "[", "\"\<H\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"operation", "=", 
      RowBox[{"OptionValue", "@", "SiteTransform"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"operation", "=!=", "None"}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"H0", "[", 
            RowBox[{"[", 
             RowBox[{"#", ",", "#"}], "]"}], "]"}], "=", 
           RowBox[{"operation", "[", 
            RowBox[{
             RowBox[{"H0", "[", 
              RowBox[{"[", 
               RowBox[{"#", ",", "#"}], "]"}], "]"}], ",", 
             RowBox[{"sitepositions", "[", 
              RowBox[{"[", "#", "]"}], "]"}]}], "]"}]}], ")"}], "&"}], "/@", 
        "sites"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"operation", "=", 
      RowBox[{"OptionValue", "@", "BlockTransform"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"operation", "=!=", "None"}], ",", 
       RowBox[{
        RowBox[{"H0", "[", 
         RowBox[{"[", 
          RowBox[{"sites", ",", "sites"}], "]"}], "]"}], "=", 
        RowBox[{"operation", "[", 
         RowBox[{"H0", "[", 
          RowBox[{"[", 
           RowBox[{"sites", ",", "sites"}], "]"}], "]"}], "]"}]}]}], "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"system", "[", 
      RowBox[{"\"\<HBloch\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"system", "[", "\"\<HBloch\>\"", "]"}], "/.", 
         RowBox[{
          RowBox[{"Rule", "[", 
           RowBox[{
            RowBox[{"i", ":", 
             RowBox[{"{", 
              RowBox[{"0", "..."}], "}"}]}], ",", "h_"}], "]"}], ":>", 
          RowBox[{"Rule", "[", 
           RowBox[{"i", ",", "H0"}], "]"}]}]}], ")"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->CompressedData["
1:eJwd0E0ogwEAxvHRGLuIos022zArhSjr3Q6YUmONUuxdbZOPuchIuDAclq8W
bzMXF81XptRoH620EuXgMElWcsG2Wq8wh5ED9ryHp9/xqb90YKzbks1isQSZ
QbZORHGaaPVzhN6Hrst+L5ROEgGo8UTDcKhg/QamtpufYFIRf4Hco8gb5FPB
D0g6JGlIiH8Y75Q8bl5G03JPMYx95ovhhUorgXabXwYPlBV1sIXWE3A0PtsG
iaL5PihPbg1ClaFzBAZMSis8NconoHBBNgetfJcd1lpCK9CYzN2E5oSQkT3F
2mF+Q7uMvVqbF+oSayewpH7RD0XXiiB8NZDncIn2MGZ960upDlpdfbVXBt0P
q43wkUoT8JBKtcPwl7ML1nD4JNQ0tBrg/bjSDPXGGSsky495seFMv0KnACrc
0UoofD+rgjm+6cifg1b7fjdu4T99NMHy
  "],
 CellLabel->
  "In[228]:=",ExpressionUUID->"b81e9328-d0ac-49ad-980d-ab00d630c1a1"],

Cell[BoxData["\<\"Modify a given portion of  a system (onsite energies \
[SiteTransform option] and/or hoppings [BlockTransform option] *within* the \
unit cell)\"\>"], "Output",
 CellChangeTimes->{
  3.662971768538636*^9, 3.664823886294384*^9, 3.6659415504691277`*^9, 
   3.665989577429022*^9, 3.6659912097844687`*^9, 3.666106365168517*^9, {
   3.666598689862582*^9, 3.666598710114517*^9}, 3.6667919668645363`*^9, 
   3.6667930707271013`*^9, 3.666794090193692*^9, 3.667108983434353*^9, 
   3.667110092806325*^9, 3.673881132443948*^9, 3.674196873096538*^9, 
   3.680329452793838*^9, 3.697802902836377*^9, 3.698412959813322*^9, 
   3.70807532649349*^9, 3.708075788958146*^9, 3.7080758950667763`*^9, {
   3.708082985419977*^9, 3.7080830026283712`*^9}, 3.708322256107765*^9, 
   3.7083231034666157`*^9, 3.7083231841487303`*^9, 3.719042213986823*^9, 
   3.7603560038206244`*^9, 3.784528377575676*^9, 3.7845302115082073`*^9},
 CellLabel->
  "Out[228]=",ExpressionUUID->"24f39c8f-40a2-4206-b3fd-d07fff8b17a9"],

Cell[BoxData["\<\"Option for ModifySystemSites: a function f[h] to be applied \
to the Hamiltonian *block* h of of the collection of sites indicated by \
SiteSelector or SiteIndices.\"\>"], "Output",
 CellChangeTimes->{
  3.662971768538636*^9, 3.664823886294384*^9, 3.6659415504691277`*^9, 
   3.665989577429022*^9, 3.6659912097844687`*^9, 3.666106365168517*^9, {
   3.666598689862582*^9, 3.666598710114517*^9}, 3.6667919668645363`*^9, 
   3.6667930707271013`*^9, 3.666794090193692*^9, 3.667108983434353*^9, 
   3.667110092806325*^9, 3.673881132443948*^9, 3.674196873096538*^9, 
   3.680329452793838*^9, 3.697802902836377*^9, 3.698412959813322*^9, 
   3.70807532649349*^9, 3.708075788958146*^9, 3.7080758950667763`*^9, {
   3.708082985419977*^9, 3.7080830026283712`*^9}, 3.708322256107765*^9, 
   3.7083231034666157`*^9, 3.7083231841487303`*^9, 3.719042213986823*^9, 
   3.7603560038206244`*^9, 3.784528377575676*^9, 3.784530211508659*^9},
 CellLabel->
  "Out[232]=",ExpressionUUID->"f40e36a0-018c-4674-b5b1-3949448cdb73"]
}, Open  ]],

Cell["\<\
Build a scattering system out of a central lattice and a set of lead lattices\
\
\>", "Text",
 CellChangeTimes->{{3.598074143903306*^9, 
  3.5980741626405363`*^9}},ExpressionUUID->"c9a60adf-b69c-4ba2-b28a-\
f90cf3ddf324"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Nambu", "::", "usage"}], "=", 
   "\"\<Option for BuildScatteringSystem that specifies whether the \
Hamiltonian is written in Nambu space, which is relevant when computing \
transport observables\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CouplingFactor", "::", "usage"}], "=", 
    "\"\<Option for BuildScatteringSystem that specifies a scaling factor to \
be applied to the coupling between leads and system. It may be a number or a \
list of numbers (one per lead).\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BuildScatteringSystem", "::", "nambu"}], "=", 
    "\"\<Nambu is set as True, but the dimensions of the Hamiltonian is odd\>\
\""}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "BuildScatteringSystem", "]"}], "=", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"HoppingRange", "\[Rule]", "1.01"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Onsite", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{"1", "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"Hopping", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{"1", "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"Nambu", "\[Rule]", "False"}]}], "\[IndentingNewLine]", 
      "}"}]}], ";"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BuildScatteringSystem", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Options", "[", "BuildSystem", "]"}], ",", " ", 
       RowBox[{"CouplingFactor", "\[Rule]", "1"}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"BuildScatteringSystem", "[", 
   RowBox[{"central_MQLattice", ",", 
    RowBox[{"{", "leads__MQLattice", "}"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"hopranges", "=", 
       RowBox[{"OptionValue", "[", "HoppingRange", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"maxneighbors", "=", 
       RowBox[{"OptionValue", "[", "MaxNeighbors", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"extrabonds", "=", 
       RowBox[{"OptionValue", "[", "ExtraBonds", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"removebonds", "=", 
       RowBox[{"OptionValue", "[", "RemoveBonds", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"H", "=", 
       RowBox[{"OptionValue", "[", "Onsite", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"V", "=", 
       RowBox[{"OptionValue", "[", "Hopping", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"nambu", "=", 
       RowBox[{"OptionValue", "[", "Nambu", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"couplingfactor", "=", 
       RowBox[{"OptionValue", "[", "CouplingFactor", "]"}]}], ",", 
      "\[IndentingNewLine]", "reorderedleads", ",", "\[IndentingNewLine]", 
      "reorderings", ",", "numleads", ",", " ", "syscentral", ",", " ", 
      "sysleads", ",", "\[IndentingNewLine]", "couplings", ",", 
      "nearestfunction", ",", "computeCoupling", ",", " ", "centralflatsites",
       ",", "centralflattags", ",", " ", "sitedimensions", ",", " ", 
      "leadsurfaces", ",", " ", "centralsurfaces"}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"Reorders", " ", "lead", " ", "lattices"}], ",", " ", 
      RowBox[{
      "so", " ", "that", " ", "their", " ", "first", " ", "Bravais", " ", 
       "vector", " ", "corresponds", " ", "to", " ", "the", " ", "transport", 
       " ", "direction"}], ",", " ", 
      RowBox[{"and", " ", "the", " ", "rest", " ", 
       RowBox[{"(", 
        RowBox[{"if", " ", "any"}], ")"}], " ", "are", " ", "ordered", " ", 
       "like", " ", "for", " ", "the", " ", "central", " ", "system"}]}], 
     "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numleads", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"{", "leads", "}"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"reorderings", "=", 
      RowBox[{"BravaisVectorOrdering", "[", 
       RowBox[{"central", ",", 
        RowBox[{"{", "leads", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"reorderedleads", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"ReorderBravaisVectors", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"{", "leads", "}"}], "[", 
           RowBox[{"[", "i", "]"}], "]"}], ",", " ", 
          RowBox[{"reorderings", "[", 
           RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "numleads"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Set", " ", "hopranges", " ", "and", " ", "MaxNeighbors", " ", "for", 
       " ", "all", " ", "parts", " ", "to", " ", "be", " ", "the", " ", 
       "same", " ", "if", " ", "only", " ", "one", " ", "value", " ", "is", 
       " ", "specified"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"VectorQ", "[", "hopranges", "]"}]}], ",", 
       RowBox[{"hopranges", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"hopranges", ",", 
          RowBox[{
           RowBox[{"Length", "@", 
            RowBox[{"{", "leads", "}"}]}], "+", "1"}]}], "]"}]}]}], "]"}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"VectorQ", "[", "maxneighbors", "]"}]}], ",", 
       RowBox[{"maxneighbors", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"maxneighbors", ",", 
          RowBox[{
           RowBox[{"Length", "@", 
            RowBox[{"{", "leads", "}"}]}], "+", "1"}]}], "]"}]}]}], "]"}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "ExtraBonds", " ", "and", " ", "removebonds", " ", "should", " ", "be", 
       " ", "specified", " ", "for", " ", "each", " ", "part", " ", 
       RowBox[{"explicitly", ".", " ", "Otherwise"}], " ", "it", " ", "is", 
       " ", "set", " ", "to", " ", "None"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", "extrabonds"}], "!=", 
        RowBox[{
         RowBox[{"Length", "@", 
          RowBox[{"{", "leads", "}"}]}], "+", "1"}]}], ",", 
       RowBox[{"extrabonds", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"None", ",", 
          RowBox[{
           RowBox[{"Length", "@", 
            RowBox[{"{", "leads", "}"}]}], "+", "1"}]}], "]"}]}]}], "]"}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", "removebonds"}], "!=", 
        RowBox[{
         RowBox[{"Length", "@", 
          RowBox[{"{", "leads", "}"}]}], "+", "1"}]}], ",", 
       RowBox[{"removebonds", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"None", ",", 
          RowBox[{
           RowBox[{"Length", "@", 
            RowBox[{"{", "leads", "}"}]}], "+", "1"}]}], "]"}]}]}], "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"syscentral", "=", 
      RowBox[{"BuildSystem", "[", 
       RowBox[{"central", ",", 
        RowBox[{"Onsite", "\[Rule]", "H"}], ",", " ", 
        RowBox[{"Hopping", "\[Rule]", "V"}], ",", 
        RowBox[{"HoppingRange", "\[Rule]", 
         RowBox[{"hopranges", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], ",", 
        RowBox[{"MaxNeighbors", "\[Rule]", 
         RowBox[{"maxneighbors", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], ",", 
        RowBox[{"ExtraBonds", "\[Rule]", 
         RowBox[{"extrabonds", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], ",", 
        RowBox[{"RemoveBonds", "\[Rule]", 
         RowBox[{"removebonds", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], ",", 
        RowBox[{"Nambu", "\[Rule]", "nambu"}], ",", " ", 
        RowBox[{"EmbedLattice", "\[Rule]", 
         RowBox[{"OptionValue", "@", "EmbedLattice"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"sysleads", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"BuildSystem", "[", 
         RowBox[{
          RowBox[{"reorderedleads", "[", 
           RowBox[{"[", "i", "]"}], "]"}], ",", 
          RowBox[{"Onsite", "\[Rule]", "H"}], ",", " ", 
          RowBox[{"Hopping", "\[Rule]", "V"}], ",", 
          RowBox[{"HoppingRange", "\[Rule]", 
           RowBox[{"hopranges", "[", 
            RowBox[{"[", 
             RowBox[{"i", "+", "1"}], "]"}], "]"}]}], ",", 
          RowBox[{"MaxNeighbors", "\[Rule]", 
           RowBox[{"maxneighbors", "[", 
            RowBox[{"[", 
             RowBox[{"i", "+", "1"}], "]"}], "]"}]}], ",", 
          RowBox[{"ExtraBonds", "\[Rule]", 
           RowBox[{"extrabonds", "[", 
            RowBox[{"[", 
             RowBox[{"i", "+", "1"}], "]"}], "]"}]}], ",", 
          RowBox[{"RemoveBonds", "\[Rule]", 
           RowBox[{"removebonds", "[", 
            RowBox[{"[", 
             RowBox[{"i", "+", "1"}], "]"}], "]"}]}], ",", 
          RowBox[{"Nambu", "\[Rule]", "nambu"}], ",", 
          RowBox[{"EmbedLattice", "\[Rule]", 
           RowBox[{"OptionValue", "@", "EmbedLattice"}]}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", " ", "numleads"}], "}"}]}], "]"}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Compute", " ", "the", " ", "couplings", " ", "between", " ", "system", 
       " ", "and", " ", "each", " ", "of", " ", "the", " ", "leads"}], "*)"}],
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"centralflatsites", "=", 
      RowBox[{"central", "[", "\"\<FlatSites\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"centralflattags", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"central", "[", "\"\<SiteTags\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"sitedimensions", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"MatrixQ", "[", 
         RowBox[{"H", "[", 
          RowBox[{
           RowBox[{"First", "@", "centralflatsites"}], ",", 
           RowBox[{"First", "@", "centralflattags"}]}], "]"}], "]"}], ",", 
        RowBox[{"Dimensions", "@", 
         RowBox[{"H", "[", 
          RowBox[{
           RowBox[{"First", "@", "centralflatsites"}], ",", 
           RowBox[{"First", "@", "centralflattags"}]}], "]"}]}], ",", 
        RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"nambu", "&&", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"OddQ", "[", "sitedimensions", "]"}], "||", 
          RowBox[{"sitedimensions", "===", 
           RowBox[{"{", "}"}]}]}], ")"}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"BuildScatteringSystem", "::", "nambu"}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"nearestfunction", "=", 
      RowBox[{"Nearest", "[", 
       RowBox[{"centralflatsites", "\[Rule]", "Automatic"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"computeCoupling", "[", "lead_", "]"}], ":=", 
      RowBox[{"Block", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"computeshifted", ",", 
          RowBox[{"brvectors", "=", 
           RowBox[{"lead", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", " ", 
          RowBox[{"flatleadsites", "=", 
           RowBox[{"lead", "[", "\"\<FlatSites\>\"", "]"}]}], ",", 
          RowBox[{"leadflattags", "=", 
           RowBox[{"Flatten", "@", 
            RowBox[{"lead", "[", "\"\<SiteTags\>\"", "]"}]}]}]}], "}"}], ",", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"computeshifted", "[", "shiftIntegers_", "]"}], ":=", 
          RowBox[{"Block", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
             "neighbors", ",", " ", "rules", ",", " ", "sitepositions"}], 
             "}"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"sitepositions", "=", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"shiftIntegers", ".", 
                  RowBox[{"Rest", "[", "brvectors", "]"}]}], "+", "#"}], 
                "&"}], "/@", "flatleadsites"}]}], ";", "\[IndentingNewLine]", 
             
             RowBox[{"neighbors", "=", 
              RowBox[{
               RowBox[{
                RowBox[{"Flatten", "[", 
                 RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
               RowBox[{"MapIndexed", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Thread", "[", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"#2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", 
                    RowBox[{"nearestfunction", "[", 
                    RowBox[{"#1", ",", 
                    RowBox[{"{", 
                    RowBox[{"\[Infinity]", ",", 
                    RowBox[{"N", "@", 
                    RowBox[{"hopranges", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}]}], "}"}]}], "]"}]}], 
                    "}"}], "]"}], "&"}], ",", "sitepositions"}], "]"}]}]}], 
             ";", "\[IndentingNewLine]", 
             RowBox[{"rules", "=", 
              RowBox[{
               RowBox[{
                RowBox[{"#", "->", 
                 RowBox[{"V", "[", 
                  RowBox[{
                   RowBox[{"centralflatsites", "[", 
                    RowBox[{"[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}], ",", 
                   RowBox[{"sitepositions", "[", 
                    RowBox[{"[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}], ",", 
                   RowBox[{"centralflattags", "[", 
                    RowBox[{"[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}], ",", 
                   RowBox[{"leadflattags", "[", 
                    RowBox[{"[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}]}], "]"}]}], 
                "&"}], "/@", "neighbors"}]}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"shiftIntegers", "->", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"sitedimensions", "\[Equal]", 
                 RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
                RowBox[{"SparseArray", "[", 
                 RowBox[{"rules", ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Length", "@", "flatleadsites"}], ",", 
                    RowBox[{"central", "[", "\"\<NumberOfSites\>\"", "]"}]}], 
                   "}"}]}], "]"}], ",", "\[IndentingNewLine]", 
                RowBox[{"SparseArray", "[", 
                 RowBox[{
                  RowBox[{"FlattenRules", "[", "rules", "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Length", "@", "flatleadsites"}], ",", 
                    RowBox[{"central", "[", "\"\<NumberOfSites\>\"", "]"}], 
                    ",", 
                    RowBox[{"Sequence", "@@", "sitedimensions"}]}], "}"}]}], 
                 "]"}]}], "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"computeshifted", "/@", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "@", "brvectors"}], "<=", "1"}], ",", 
            RowBox[{"{", 
             RowBox[{"{", "}"}], "}"}], ",", 
            RowBox[{"Tuples", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"0", ",", 
                RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
              RowBox[{
               RowBox[{"Length", "@", "brvectors"}], "-", "1"}]}], "]"}]}], 
           "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"couplings", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"MQSystem", "[", 
         RowBox[{"\"\<HBloch\>\"", "->", 
          RowBox[{"computeCoupling", "[", 
           RowBox[{"reorderedleads", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "numleads"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"We", " ", "rescale", " ", "the", " ", "lead"}], "-", 
       RowBox[{
       "system", " ", "couplings", " ", "by", " ", "couplingfactor"}]}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"VectorQ", "@", "couplingfactor"}]}], ",", 
       RowBox[{"couplingfactor", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"couplingfactor", ",", "numleads"}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"couplings", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"couplings", "[", 
          RowBox[{"[", "i", "]"}], "]"}], "[", 
         RowBox[{"\"\<HBloch\>\"", "\[Rule]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"MapAt", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"couplingfactor", "[", 
                 RowBox[{"[", "i", "]"}], "]"}], "#"}], "&"}], ",", "#", ",", 
              
              RowBox[{"{", 
               RowBox[{"All", ",", "2"}], "}"}]}], "]"}], "&"}], ")"}]}], 
         "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "numleads"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Computes", " ", "the", " ", "indices", " ", "of", " ", "all", " ", 
       "sites", " ", "in", " ", "the", " ", "leads", " ", "that", " ", "are", 
       " ", "coupled", " ", "to", " ", "the", " ", 
       RowBox[{"system", "."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"For", " ", "each", " ", "coupling"}], ",", " ", 
       RowBox[{
        RowBox[{"we", " ", "extract", " ", "all", " ", "pairs", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"j", ".."}]}], "}"}]}], "\[Rule]", "SparseArray"}], ",", 
       " ", 
       RowBox[{
       "then", " ", "we", " ", "Union", " ", "the", " ", "target", " ", 
        "indices", " ", "of", " ", "all", " ", "these", " ", 
        RowBox[{"SparseArray", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"leadsurfaces", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Union", "@@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Most", "[", 
              RowBox[{"ArrayRules", "[", "#", "]"}], "]"}], "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1", ",", "1"}], "]"}], "]"}], "&"}], "/@", 
           
           RowBox[{"#", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "2", ",", "All", ",", "2"}], "]"}], "]"}]}], 
          ")"}]}], "&"}], "/@", "couplings"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Computes", " ", "the", " ", "indices", " ", "of", " ", "all", " ", 
       "sites", " ", "in", " ", "the", " ", "system", " ", "that", " ", "are",
        " ", "coupled", " ", "to", " ", "the", " ", "leads"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "The", " ", "same", " ", "procedure", " ", "as", " ", "above"}], ",", 
       " ", 
       RowBox[{
       "but", " ", "with", " ", "the", " ", "origin", " ", "indices"}]}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"centralsurfaces", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Union", "@@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Most", "[", 
              RowBox[{"ArrayRules", "[", "#", "]"}], "]"}], "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1", ",", "2"}], "]"}], "]"}], "&"}], "/@", 
           
           RowBox[{"#", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "2", ",", "All", ",", "2"}], "]"}], "]"}]}], 
          ")"}]}], "&"}], "/@", "couplings"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"MQScatteringSystem", "[", 
      RowBox[{
       RowBox[{"\"\<Central\>\"", "\[Rule]", "syscentral"}], ",", 
       RowBox[{"\"\<Leads\>\"", "\[Rule]", "sysleads"}], ",", 
       RowBox[{"\"\<Couplings\>\"", "\[Rule]", "couplings"}], ",", " ", 
       RowBox[{"\"\<SurfaceLeads\>\"", "\[Rule]", "leadsurfaces"}], ",", 
       RowBox[{"\"\<SurfacesCentral\>\"", "\[Rule]", "centralsurfaces"}], ",", 
       RowBox[{"\"\<Nambu\>\"", "\[Rule]", 
        RowBox[{"OptionValue", "[", "Nambu", "]"}]}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.597940796111766*^9, 3.5979409612421427`*^9}, {
   3.597941087221456*^9, 3.597941126439933*^9}, {3.5979411655787086`*^9, 
   3.5979414410062027`*^9}, {3.5979415587759953`*^9, 3.597941575972601*^9}, {
   3.597941667437593*^9, 3.5979417227291718`*^9}, {3.597941756068306*^9, 
   3.597941767799529*^9}, {3.5979418011692142`*^9, 3.597941930033986*^9}, {
   3.597941962283839*^9, 3.597941991781056*^9}, {3.59794204312855*^9, 
   3.597942058289991*^9}, {3.597942088516395*^9, 3.597942193550906*^9}, {
   3.597942234923626*^9, 3.5979422915272512`*^9}, {3.597942402862809*^9, 
   3.5979424221185617`*^9}, {3.597942468772895*^9, 3.5979424860902348`*^9}, {
   3.597942518646291*^9, 3.5979425873463297`*^9}, {3.597942668597932*^9, 
   3.5979427684273453`*^9}, {3.5979428114068537`*^9, 
   3.5979428267506104`*^9}, {3.59794428486164*^9, 3.5979443819490147`*^9}, {
   3.597944433072934*^9, 3.597944451416416*^9}, {3.597944520529023*^9, 
   3.5979445340245523`*^9}, {3.5979448247706003`*^9, 
   3.5979448648508177`*^9}, {3.597945696512127*^9, 3.59794571785702*^9}, {
   3.597945754675321*^9, 3.597945850002788*^9}, {3.598072863721582*^9, 
   3.598072865660398*^9}, {3.598073671592553*^9, 3.598073719611953*^9}, {
   3.598074169674864*^9, 3.598074273778201*^9}, {3.5980743199742107`*^9, 
   3.598074345206626*^9}, 3.598081504887618*^9, {3.598081692384903*^9, 
   3.598081760664341*^9}, {3.598081798940139*^9, 3.598081847075289*^9}, 
   3.598081885260124*^9, {3.598082652299903*^9, 3.5980826656723146`*^9}, {
   3.598082722740045*^9, 3.598082954547667*^9}, {3.5980829965318813`*^9, 
   3.598083190708144*^9}, {3.598083278103365*^9, 3.598083299420032*^9}, {
   3.598083384513712*^9, 3.598083794877366*^9}, {3.5980838302948637`*^9, 
   3.598083840085565*^9}, {3.598084795056261*^9, 3.598084923952861*^9}, {
   3.598085244325448*^9, 3.598085259165269*^9}, {3.5980852999329863`*^9, 
   3.598085348966157*^9}, {3.5980854693682623`*^9, 3.598085471925416*^9}, {
   3.5980857094071693`*^9, 3.59808577116811*^9}, {3.59808582259778*^9, 
   3.5980858641352997`*^9}, {3.598085978006015*^9, 3.598085981062961*^9}, {
   3.598086178339477*^9, 3.598086223630151*^9}, {3.598086516258789*^9, 
   3.5980865165337477`*^9}, {3.598090781462974*^9, 3.598090816387322*^9}, {
   3.5980908495563173`*^9, 3.598090851002358*^9}, {3.598090958806383*^9, 
   3.598091013621972*^9}, {3.598092295991495*^9, 3.598092320629571*^9}, {
   3.5980923762715282`*^9, 3.598092388592167*^9}, {3.598092476677129*^9, 
   3.5980924962991667`*^9}, {3.5980925294274607`*^9, 3.598092648382702*^9}, {
   3.598168707815156*^9, 3.5981687462857103`*^9}, 3.598168891082595*^9, 
   3.5981801178353243`*^9, 3.598183799044732*^9, {3.598246651812101*^9, 
   3.598246672895042*^9}, {3.5982620347561607`*^9, 3.5982620438635273`*^9}, {
   3.624274379323394*^9, 3.62427438782614*^9}, {3.624274451323412*^9, 
   3.6242744546560583`*^9}, {3.624358779539756*^9, 3.624358794915701*^9}, {
   3.62435883750003*^9, 3.6243589077644787`*^9}, {3.624358956758099*^9, 
   3.624359011467978*^9}, {3.6243597619615297`*^9, 3.624359764288025*^9}, {
   3.624359817867783*^9, 3.624359973607025*^9}, {3.624363208158317*^9, 
   3.6243633004898252`*^9}, {3.62964180211134*^9, 3.6296418036543627`*^9}, {
   3.6355186526072073`*^9, 3.6355187273367033`*^9}, {3.635663363622014*^9, 
   3.635663421348282*^9}, {3.635833614742833*^9, 3.6358337528720007`*^9}, {
   3.635833784086537*^9, 3.635833875073542*^9}, {3.635834006322384*^9, 
   3.635834007290344*^9}, {3.635834051514196*^9, 3.635834225927664*^9}, {
   3.6358342717124662`*^9, 3.635834274151457*^9}, {3.6358345229798613`*^9, 
   3.635834578679599*^9}, {3.6358347117967663`*^9, 3.6358347891273003`*^9}, {
   3.635834847091969*^9, 3.635834856218676*^9}, 3.635834893724831*^9, {
   3.635834970016234*^9, 3.635834973723534*^9}, 3.635835049905941*^9, {
   3.664823747782425*^9, 3.6648237761464043`*^9}, {3.664823824733306*^9, 
   3.664823843588572*^9}, {3.6648238950877647`*^9, 3.664824083745186*^9}, {
   3.753785306342238*^9, 3.753785453328958*^9}, {3.7537854966521606`*^9, 
   3.753785497362*^9}, 3.753785531314453*^9},
 CellLabel->
  "In[234]:=",ExpressionUUID->"83f99a0d-1984-4da2-9682-9834e57c3fd1"]
}, Closed]],

Cell[CellGroupData[{

Cell["SolveLead", "Subsection",
 CellChangeTimes->{{3.59794473204463*^9, 3.59794473454773*^9}, {
   3.59834070824047*^9, 3.598340709430262*^9}, 
   3.635076589951996*^9},ExpressionUUID->"75f1a45f-f919-4b02-b1e4-\
836612a90154"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SolveLead", "::", "usage"}], "=", 
   "\"\<Computes different quantities for a semiinfinite lead, to be used for \
a number of transport and spectroscopy observables\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SolveLead", "::", "dim"}], "=", 
   "\"\<The lead should be a 1D system, but it has `1` dimensions. Try \
folding in specific Bloch phases, e.g. lead[\!\(\*SubscriptBox[\(\[Phi]\), \
\(1\)]\),\!\(\*SubscriptBox[\(\[Phi]\), \(2\)]\),..] for higher-dimensional \
leads.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SolveLead", "::", "vel"}], "=", 
   "\"\<Velocities are not real. `1`. Probably a non-hermitian hopping in \
space. \>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SolveLead", "::", "sol"}], "=", 
   "\"\<The number `1` of retarded solutions found does not match the number \
of advanced solutions `2`. The frequency is \[Omega]=`3`. Are you sure your \
lead Bloch Hamiltonian is Hermitian?\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SolveLead", "::", "sym"}], "=", 
    "\"\<Warning: outgoing velocities are not equal to incoming velocities. \
The maximum difference is `1`\>\""}], ";"}], " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ProjectOutBulk", "::", "usage"}], "=", 
    "\"\<Option for SolveLead and SolveScatteringSystem, meant to increase \
performance in some cases, that specifies whether the sites in the lead that \
are not directly coupled to the central system or to other unit cells should \
be integrated out before solving the lead.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"IncludeExtraData", "::", "usage"}], "=", 
    "\"\<Option for SolveLead and SolveScatteringSystem that enables \
returning additional information necessary to find scattering states in the \
leads.\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ReturnPropagatingModes", "::", "usage"}], "=", 
    "\"\<Instead of the scattering information, return the propagating \
eigenmodes of a given energy, normalized to their \!\(\*SqrtBox[\(velocity\)]\
\).\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ReturnAllModes", "::", "usage"}], "=", 
    "\"\<Instead of the scattering information, return all the eigenmodes of \
a given energy, including evanescents.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "SolveLead", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"IncludeExtraData", "\[Rule]", "False"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ProjectOutBulk", "\[Rule]", "True"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ReturnPropagatingModes", "\[Rule]", "False"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ReturnAllModes", "\[Rule]", "False"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SolveLead", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "scatsys_MQScatteringSystem",
     ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"MapThread", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"SolveLead", "[", 
      RowBox[{"\[Omega]", ",", "#1", ",", "#2", ",", "opts"}], "]"}], "&"}], 
    ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"scatsys", "[", "\"\<Leads\>\"", "]"}], ",", 
      RowBox[{"scatsys", "[", "\"\<SurfaceLeads\>\"", "]"}]}], "}"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SolveLead", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "lead_MQSystem", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"SolveLead", "[", 
   RowBox[{"\[Omega]", ",", "lead", ",", 
    RowBox[{"Range", "[", 
     RowBox[{"lead", "[", "\"\<NumberOfSites\>\"", "]"}], "]"}], ",", 
    "opts"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SolveLead", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "lead_MQSystem", ",", " ", 
    RowBox[{"leadsurface_", "/;", 
     RowBox[{"VectorQ", "[", 
      RowBox[{"leadsurface", ",", " ", "IntegerQ"}], "]"}]}], ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Nambu", "=", 
       RowBox[{"lead", "[", "\"\<Nambu\>\"", "]"}]}], ",", "NambuSectors", 
      ",", "\[IndentingNewLine]", "flatlead", ",", "flatleadsurface", ",", 
      "\[IndentingNewLine]", "dim", ",", "minimalsites", ",", "othersites", 
      ",", "\[IndentingNewLine]", "v", ",", "vd", ",", "ig0", ",", "gv", ",", 
      "invg", ",", "gr", ",", "psi", ",", "invphiOut", ",", "invphig", ",", 
      "propOut", ",", "propIn", ",", "psurface", ",", "r0", ",", 
      "\[IndentingNewLine]", "\[Lambda]", ",", "\[Phi]", ",", "vOut", ",", 
      " ", "\[Lambda]Out", ",", " ", "\[Phi]Out", ",", "vIn", ",", 
      "\[Lambda]In", ",", "\[Phi]In", ",", "id", ",", " ", "zero", ",", " ", 
      "eigensolution", ",", "velocities", ",", "\[IndentingNewLine]", 
      "retardedlist", ",", "advancedlist", ",", 
      RowBox[{"propmargin", "=", 
       SuperscriptBox["10", 
        RowBox[{"-", "7"}]]}], ",", 
      RowBox[{"velocitychop", "=", 
       SuperscriptBox["10", 
        RowBox[{"-", "7"}]]}], ",", "originalorder"}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"lead", "[", "\"\<LatticeDimensions\>\"", "]"}], 
        "\[NotEqual]", "1"}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"SolveLead", "::", "dim"}], ",", 
          RowBox[{"lead", "[", "\"\<LatticeDimensions\>\"", "]"}]}], "]"}], 
        ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Flatten", " ", "orbitals", " ", "in", " ", "each", " ", "site"}], ",",
        " ", 
       RowBox[{
       "and", " ", "compute", " ", "the", " ", "new", " ", "surface", " ", 
        "indices"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"lead", "[", "\"\<SiteDimensions\>\"", "]"}], "\[Equal]", 
        "1"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"flatlead", "=", "lead"}], ";", 
        RowBox[{"flatleadsurface", "=", "leadsurface"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"flatlead", "=", 
         RowBox[{"lead", "[", "\"\<Flat\>\"", "]"}]}], ";", 
        RowBox[{"flatleadsurface", "=", 
         RowBox[{"FlattenIndices", "[", 
          RowBox[{"leadsurface", ",", 
           RowBox[{"lead", "[", "\"\<SiteDimensions\>\"", "]"}]}], "]"}]}], 
        ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"dim", "=", 
      RowBox[{"flatlead", "[", "\"\<NumberOfSites\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Create", " ", "a", " ", "site", " ", "ordering", " ", "such", " ", 
        "that", " ", "the", " ", "flat", " ", "lead", " ", "surface", " ", 
        "are", " ", "the", " ", "first", " ", "sites", " ", 
        RowBox[{"(", 
         RowBox[{
         "to", " ", "be", " ", "extracted", " ", "at", " ", "the", " ", "end",
           " ", "through", " ", "projector", " ", "psurface"}], ")"}]}], ",", 
       " ", 
       RowBox[{
       "and", " ", "the", " ", "rest", " ", "may", " ", "or", " ", "may", " ",
         "not", " ", 
        RowBox[{"(", 
         RowBox[{"depending", " ", "on", " ", "ProjectOutBulk"}], ")"}], " ", 
        "include", " ", "sites", " ", "decoupled", " ", "from", " ", "other", 
        " ", "unit", " ", "cells"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "[", "ProjectOutBulk", "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"minimalsites", "=", 
         RowBox[{"Join", "[", 
          RowBox[{"flatleadsurface", ",", " ", 
           RowBox[{"Complement", "[", 
            RowBox[{
             RowBox[{"flatlead", "[", "\"\<BlochBoundarySites\>\"", "]"}], 
             ",", "flatleadsurface"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"othersites", "=", 
         RowBox[{"Complement", "[", 
          RowBox[{
           RowBox[{"Range", "[", "dim", "]"}], ",", "minimalsites"}], 
          "]"}]}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"minimalsites", "=", 
        RowBox[{"Join", "[", 
         RowBox[{"flatleadsurface", ",", " ", 
          RowBox[{"Complement", "[", 
           RowBox[{
            RowBox[{"Range", "[", "dim", "]"}], ",", "flatleadsurface"}], 
           "]"}]}], "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"v", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"{", "1", "}"}], "/.", 
         RowBox[{"flatlead", "[", "\"\<HBloch\>\"", "]"}]}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"minimalsites", ",", "minimalsites"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"vd", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"-", "1"}], "}"}], "/.", 
         RowBox[{"flatlead", "[", "\"\<HBloch\>\"", "]"}]}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"minimalsites", ",", "minimalsites"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"id", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
        RowBox[{"{", 
         RowBox[{"dim", ",", "dim"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "ProjectOutBulk", "]"}], "&&", 
        RowBox[{
         RowBox[{"Length", "[", "othersites", "]"}], ">", "0"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"ig0", "=", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Omega]", " ", "id"}], "-", 
           RowBox[{"flatlead", "[", "\"\<H\>\"", "]"}]}], ")"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ig0", "=", 
         RowBox[{
          RowBox[{"ig0", "[", 
           RowBox[{"[", 
            RowBox[{"minimalsites", ",", "minimalsites"}], "]"}], "]"}], "-", 
          
          RowBox[{
           RowBox[{"ig0", "[", 
            RowBox[{"[", 
             RowBox[{"minimalsites", ",", "othersites"}], "]"}], "]"}], ".", 
           RowBox[{"Inverse", "[", 
            RowBox[{"ig0", "[", 
             RowBox[{"[", 
              RowBox[{"othersites", ",", "othersites"}], "]"}], "]"}], "]"}], 
           ".", 
           RowBox[{"ig0", "[", 
            RowBox[{"[", 
             RowBox[{"othersites", ",", "minimalsites"}], "]"}], "]"}]}]}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"dim", "=", 
         RowBox[{"Length", "@", "minimalsites"}]}], ";", 
        RowBox[{"id", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
           RowBox[{"{", 
            RowBox[{"dim", ",", "dim"}], "}"}]}], "]"}]}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"ig0", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Omega]", " ", "id"}], "-", 
           RowBox[{"flatlead", "[", "\"\<H\>\"", "]"}]}], ")"}], "[", 
         RowBox[{"[", 
          RowBox[{"minimalsites", ",", "minimalsites"}], "]"}], "]"}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"zero", "=", 
      RowBox[{"0", "id"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Solve", " ", "the", " ", "set", " ", "of", " ", "\[Lambda]"}],
        ",", " ", 
       RowBox[{"\[Phi]", " ", "and", " ", 
        RowBox[{"\[Lambda]\[Phi]", ".", " ", "Chop"}], " ", "is", " ", 
        "necessary", " ", "to", " ", "force", " ", "ArrayFlatten", " ", "to", 
        " ", "return", " ", "a", " ", "SparseArray"}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"eigensolution", "=", 
      RowBox[{"Transpose", "@", 
       RowBox[{"EigensystemFixedPhase", "[", 
        RowBox[{"SparseArray", "/@", 
         RowBox[{"N", "@", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"ArrayFlatten", "[", 
             RowBox[{"Chop", "@", 
              RowBox[{"(", GridBox[{
                 {"zero", "id"},
                 {
                  RowBox[{"-", "v"}], "ig0"}
                }], ")"}]}], "]"}], ",", 
            RowBox[{"ArrayFlatten", "[", 
             RowBox[{"Chop", "@", 
              RowBox[{"(", GridBox[{
                 {"id", "zero"},
                 {"zero", "vd"}
                }], ")"}]}], "]"}]}], "}"}]}]}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Fix", " ", "origin", " ", "of", " ", "phases"}], " ", ",", 
       " ", 
       RowBox[{
       "works", " ", "unless", " ", "eigenfunctions", " ", "vanish", " ", 
        "at", " ", "site", " ", "1", " ", "of", " ", 
        RowBox[{"leads", ".", 
         StyleBox[" ", "TI"], 
         StyleBox["Not", "TI"]}], 
        StyleBox[" ", "TI"], 
        StyleBox["necessary", "TI"], 
        StyleBox[" ", "TI"], 
        StyleBox["any", "TI"], 
        StyleBox[" ", "TI"], 
        StyleBox["more", "TI"]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"eigensolution", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", 
            RowBox[{
             SuperscriptBox["\[ExponentialE]", 
              RowBox[{
               RowBox[{"-", "\[ImaginaryI]"}], " ", 
               RowBox[{"Arg", "[", 
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "1"}], "]"}], "]"}], "]"}]}]], 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], "&"}], "/@", 
         "eigensolution"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Extract", " ", 
       RowBox[{"\[Lambda]", "'"}], "s", " ", "and", " ", 
       RowBox[{"\[Phi]", "'"}], "s", " ", "from", " ", 
       RowBox[{"eigensolution", ".", " ", "The"}], " ", "\[Infinity]", " ", 
       "fix", " ", "allows", " ", "comparison", " ", "in", " ", "velocities", 
       " ", "call"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]", "=", 
      RowBox[{
       RowBox[{"eigensolution", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}], "/.", 
       RowBox[{"ComplexInfinity", "\[Rule]", "\[Infinity]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Phi]", "=", 
      RowBox[{"eigensolution", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2", ",", 
         RowBox[{"1", ";;", "dim"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Compute", " ", "group", " ", "velocities", " ", "of", " ", "each", " ", 
       RowBox[{"mode", ".", " ", "Evanescents"}], " ", "give", " ", "zero", 
       " ", 
       RowBox[{"velocity", "."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"velocities", "=", 
      RowBox[{"Chop", "[", 
       RowBox[{
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"#1", "===", "\[Infinity]"}], ",", "0", ",", 
             RowBox[{"\[ImaginaryI]", 
              FractionBox[
               RowBox[{
                RowBox[{"#2", "\[Conjugate]"}], ".", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"vd", " ", "#1"}], "-", 
                  RowBox[{"v", " ", 
                   RowBox[{"#1", "\[Conjugate]"}]}]}], ")"}], ".", "#2"}], 
               RowBox[{
                RowBox[{"#2", "\[Conjugate]"}], ".", "#2"}]]}]}], "]"}], 
           "&"}], ",", 
          RowBox[{"{", 
           RowBox[{"\[Lambda]", ",", "\[Phi]"}], "}"}]}], "]"}], ",", 
        "velocitychop"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Or", "@@", 
        RowBox[{"Thread", "[", 
         RowBox[{
          RowBox[{"Im", "[", "velocities", "]"}], "\[NotEqual]", "0"}], 
         "]"}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"SolveLead", "::", "vel"}], ",", "velocities"}], "]"}], ";", 
        RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Stop", " ", "here", " ", "if", " ", 
       RowBox[{"ComputeOnlyModes", " ", "[", 
        RowBox[{"used", " ", "for", " ", "LDOS", " ", "computations"}], 
        "]"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "@", "ReturnAllModes"}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"{", 
         RowBox[{"velocities", ",", " ", "\[Lambda]", ",", "\[Phi]"}], "}"}], 
        "]"}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "@", "ReturnPropagatingModes"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"velocities", ",", " ", "\[Lambda]", ",", "\[Phi]"}], "}"}],
          "=", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"#", "===", 
              RowBox[{"{", "}"}]}], ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", "}"}], ",", 
               RowBox[{"{", "}"}], ",", 
               RowBox[{"{", "}"}]}], "}"}], ",", 
             RowBox[{"Transpose", "@", "#"}]}], "]"}], "&"}], "@", 
          RowBox[{"Sort", "[", 
           RowBox[{"Pick", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Abs", "@", "velocities"}], ",", " ", "\[Lambda]", 
                ",", "\[Phi]"}], "}"}], "\[Transpose]"}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "\[NotEqual]", "0"}], "&&", 
                 RowBox[{
                  RowBox[{"Chop", "@", 
                   RowBox[{"Re", "@", 
                    RowBox[{"Log", "@", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}]}]}], "==", "0"}]}], 
                ")"}], "&"}], "/@", 
              RowBox[{"Transpose", "[", 
               RowBox[{"{", 
                RowBox[{"velocities", ",", "\[Lambda]"}], "}"}], "]"}]}]}], 
            "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Return", "[", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            FractionBox["1", 
             RowBox[{"2", "\[Pi]", " ", "\[ImaginaryI]"}]], 
            RowBox[{"Log", "[", "\[Lambda]", "]"}]}], ",", 
           FractionBox["\[Phi]", 
            SqrtBox["velocities"]]}], "}"}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Define", " ", "which", " ", "solutions", " ", "are", " ", "retarded", 
       " ", "and", " ", "advanced", " ", "through", " ", "two", " ", 
       "boolean", " ", "lists"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"retardedlist", "=", 
      RowBox[{"Thread", "[", 
       RowBox[{
        RowBox[{"Thread", "[", 
         RowBox[{"velocities", ">=", "0"}], "]"}], "&&", 
        RowBox[{"Thread", "[", 
         RowBox[{
          RowBox[{"Abs", "[", "\[Lambda]", "]"}], "\[LessEqual]", 
          RowBox[{"1", "+", "propmargin"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"advancedlist", "=", 
      RowBox[{"Not", "/@", "retardedlist"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "The", " ", "number", " ", "of", " ", "advanced", " ", "should", " ", 
       "equal", " ", "the", " ", "number", " ", "of", " ", "retarded", " ", 
       "modes"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", 
         RowBox[{"Cases", "[", 
          RowBox[{"advancedlist", ",", "True"}], "]"}]}], "\[NotEqual]", 
        RowBox[{"Length", "@", 
         RowBox[{"Cases", "[", 
          RowBox[{"retardedlist", ",", "True"}], "]"}]}]}], ",", " ", 
       RowBox[{"Message", "[", 
        RowBox[{
         RowBox[{"SolveLead", "::", "sol"}], ",", " ", 
         RowBox[{"Length", "@", 
          RowBox[{"Cases", "[", 
           RowBox[{"advancedlist", ",", "True"}], "]"}]}], ",", 
         RowBox[{"Length", "@", 
          RowBox[{"Cases", "[", 
           RowBox[{"retardedlist", ",", "True"}], "]"}]}], ",", "\[Omega]"}], 
        "]"}]}], 
      RowBox[{"(*", 
       RowBox[{";", 
        RowBox[{"Abort", "[", "]"}]}], "*)"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Select", " ", "retarded", " ", 
       RowBox[{"(", 
        RowBox[{"outward", "-", "going"}], ")"}], " ", "solutions"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"vOut", ",", "\[Lambda]Out", ",", "\[Phi]Out"}], "}"}], "=", 
      RowBox[{"Transpose", "@", 
       RowBox[{"Pick", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"velocities", ",", "\[Lambda]", ",", "\[Phi]"}], "}"}], 
          "\[Transpose]"}], ",", "retardedlist"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Select", " ", "advanced", " ", 
       RowBox[{"(", "incoming", ")"}], " ", "solutions"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"vIn", ",", "\[Lambda]In", ",", "\[Phi]In"}], "}"}], "=", 
      RowBox[{"Transpose", "@", 
       RowBox[{"Pick", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"velocities", ",", "\[Lambda]", ",", "\[Phi]"}], "}"}], 
          "\[Transpose]"}], ",", "advancedlist"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Reorder", " ", "modes", " ", "according", " ", "to", " ", "their", " ", 
       RowBox[{"velocities", "."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"vOut", ",", "\[Lambda]Out", ",", "\[Phi]Out"}], "}"}], "=", 
      RowBox[{"Transpose", "@", 
       RowBox[{"Sort", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"vOut", ",", "\[Lambda]Out", ",", "\[Phi]Out"}], "}"}], 
         "\[Transpose]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"vIn", ",", "\[Lambda]In", ",", "\[Phi]In"}], "}"}], "=", 
      RowBox[{"Transpose", "@", 
       RowBox[{"Reverse", "@", 
        RowBox[{"Sort", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"vIn", ",", "\[Lambda]In", ",", "\[Phi]In"}], "}"}], 
          "\[Transpose]"}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Normalize", " ", "the", " ", "propagating", " ", "modes", " ", "to", 
       " ", "unit", " ", 
       RowBox[{"flux", "."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Phi]Out", "=", 
      RowBox[{
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"#", "\[Equal]", "0"}], ",", "1", ",", 
            SuperscriptBox[
             RowBox[{"Abs", "[", "#", "]"}], 
             RowBox[{
              RowBox[{"-", "1"}], "/", "2"}]]}], "]"}], "&"}], "/@", "vOut"}],
         "]"}], ".", "\[Phi]Out"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Phi]In", "=", 
      RowBox[{
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"#", "\[Equal]", "0"}], ",", "1", ",", 
            SuperscriptBox[
             RowBox[{"Abs", "[", "#", "]"}], 
             RowBox[{
              RowBox[{"-", "1"}], "/", "2"}]]}], "]"}], "&"}], "/@", "vIn"}], 
        "]"}], ".", "\[Phi]In"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Turn", " ", "modes", " ", "into", " ", "column", " ", "vectors"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Phi]Out", "=", 
      RowBox[{"\[Phi]Out", "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Phi]In", "=", 
      RowBox[{"\[Phi]In", "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Compute", " ", "spatial", " ", "projector", " ", "onto", " ", 
       "outgoing", " ", "eigenstates"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"invphiOut", "=", 
      RowBox[{"PseudoInverse", "[", "\[Phi]Out", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Compute", " ", 
        RowBox[{"gr", ".", "v"}]}], ",", " ", 
       RowBox[{"invg", " ", "and", " ", "gr"}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"gv", "=", 
      RowBox[{"\[Phi]Out", ".", 
       RowBox[{"DiagonalMatrix", "[", "\[Lambda]Out", "]"}], ".", 
       "invphiOut"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"invg", "=", 
      RowBox[{"ig0", "-", 
       RowBox[{"vd", ".", "gv"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"gr", "=", 
      RowBox[{"Inverse", "[", "invg", "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
        RowBox[{"Define", " ", "mode"}], "-", 
        RowBox[{
        "space", " ", "projector", " ", "onto", " ", "the", " ", 
         "propagating", " ", "sector"}]}], ",", " ", 
       RowBox[{"for", " ", "incoming", " ", "and", " ", "outgoing", " ", 
        RowBox[{"modes", ".", "Apply"}], " ", "reordering", " ", "to", " ", 
        "velocities", " ", "first"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"propIn", "=", 
      RowBox[{"Normal", "@", 
       RowBox[{"Pick", "[", 
        RowBox[{"id", ",", 
         RowBox[{"Thread", "[", 
          RowBox[{"vIn", "\[NotEqual]", "0"}], "]"}]}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"propOut", "=", 
      RowBox[{"Normal", "@", 
       RowBox[{"Pick", "[", 
        RowBox[{"id", ",", 
         RowBox[{"Thread", "[", 
          RowBox[{"vOut", "\[NotEqual]", "0"}], "]"}]}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
        RowBox[{"If", " ", "Nambu"}], "\[Equal]", "True"}], ",", " ", 
       RowBox[{
       "compute", " ", "which", " ", "propagating", " ", "modes", " ", "have",
         " ", "pure", " ", "electron", " ", "or", " ", "hole", " ", 
        "character"}], ",", " ", 
       RowBox[{"both", " ", "for", " ", "incoming", " ", "and", " ", 
        RowBox[{"outgoing", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{"Nambu", ",", "\[IndentingNewLine]", 
       RowBox[{"NambuSectors", "=", 
        RowBox[{"{", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "propIn", "]"}], "\[Equal]", "0"}], ",", 
            RowBox[{"{", "}"}], ",", 
            RowBox[{"ComputeNambuSectors", "[", 
             RowBox[{
              RowBox[{"\[Phi]In", ".", 
               RowBox[{"propIn", "\[Transpose]"}]}], ",", 
              RowBox[{"lead", "[", "\"\<SiteDimensions\>\"", "]"}]}], "]"}]}],
            "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "propOut", "]"}], "\[Equal]", "0"}], ",", 
            
            RowBox[{"{", "}"}], ",", 
            RowBox[{"ComputeNambuSectors", "[", 
             RowBox[{
              RowBox[{"\[Phi]Out", ".", 
               RowBox[{"propOut", "\[Transpose]"}]}], ",", 
              RowBox[{"lead", "[", "\"\<SiteDimensions\>\"", "]"}]}], "]"}]}],
            "]"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"NambuSectors", "=", "None"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Define", " ", "a", " ", "projector", " ", "from", " ", "minimalsites", 
       " ", "onto", " ", "leadsurface", " ", "sites"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"psurface", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Length", "@", "flatleadsurface"}], ",", 
          RowBox[{"Length", "@", "minimalsites"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "If", " ", "no", " ", "propagating", " ", "modes", " ", "in", " ", 
        "our", " ", "out", " ", "in", " ", "the", " ", "lead"}], ",", " ", 
       RowBox[{"we", " ", "must", " ", "finish", " ", "differently"}]}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"propOut", "===", 
         RowBox[{"{", "}"}]}], "||", 
        RowBox[{"propIn", "===", 
         RowBox[{"{", "}"}]}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"project", " ", "g", " ", "onto", " ", "surface"}], ",", " ", 
         RowBox[{"and", " ", "compute", " ", "the", " ", "effective", " ", 
          SuperscriptBox["g", 
           RowBox[{"-", "1"}]], " ", "in", " ", "that", " ", "subspace"}]}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"invg", "=", 
         RowBox[{"Inverse", "[", 
          RowBox[{"psurface", ".", "gr", ".", 
           RowBox[{"psurface", "\[Transpose]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"Return", "[", 
         RowBox[{"MQLeadSolution", "[", 
          RowBox[{
           RowBox[{"\"\<r0\>\"", "\[Rule]", 
            RowBox[{"{", "}"}]}], ",", 
           RowBox[{"\"\<psiSurface\>\"", "\[Rule]", 
            RowBox[{"{", "}"}]}], ",", 
           RowBox[{"\"\<invphig\>\"", "\[Rule]", 
            RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"\"\<gSurface\>\"", "\[Rule]", 
            RowBox[{"psurface", ".", "gr", ".", 
             RowBox[{"psurface", "\[Transpose]"}]}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"\"\<invg\>\"", "\[Rule]", "invg"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"\"\<Nambu\>\"", "\[Rule]", "Nambu"}], ",", " ", 
           "\[IndentingNewLine]", 
           RowBox[{"\"\<NambuSectors\>\"", "->", "NambuSectors"}], ",", " ", 
           "\[IndentingNewLine]", 
           RowBox[{"\"\<ExtraData\>\"", "\[Rule]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"OptionValue", "[", "IncludeExtraData", "]"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"originalorder", "=", 
                RowBox[{
                 RowBox[{"SparseArray", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Length", "@", "minimalsites"}], ",", 
                    RowBox[{"Length", "@", "minimalsites"}]}], "}"}]}], "]"}],
                  "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "minimalsites"}], "]"}], "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"r0", "=", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"propIn", "===", 
                   RowBox[{"{", "}"}]}], ",", 
                  RowBox[{"{", "}"}], ",", 
                  RowBox[{"-", 
                   RowBox[{
                    RowBox[{"DiagonalMatrix", "[", "\[Lambda]Out", "]"}], ".",
                     "invphiOut", ".", "\[Phi]In", ".", 
                    RowBox[{"DiagonalMatrix", "[", 
                    RowBox[{"1", "/", "\[Lambda]In"}], "]"}], ".", 
                    RowBox[{"propIn", "\[Transpose]"}]}]}]}], "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{"#", "===", 
                    RowBox[{"{", "}"}]}], ",", 
                   RowBox[{"{", "}"}], ",", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"#", ".", 
                    RowBox[{"#", "\[HermitianConjugate]"}]}], "&"}], "/@", 
                    RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"lead", "[", "\"\<SiteDimensions\>\"", "]"}]}], 
                    "]"}]}], ")"}]}], "]"}], "&"}], "/@", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"propOut", "===", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{"originalorder", ".", "\[Phi]Out", ".", 
                    RowBox[{"propOut", "\[Transpose]"}]}]}], "]"}], ",", 
                  "\[IndentingNewLine]", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"propIn", "===", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{"originalorder", ".", "\[Phi]In", ".", 
                    RowBox[{"propIn", "\[Transpose]"}]}]}], "]"}]}], "}"}]}], 
               ";", "\[IndentingNewLine]", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"\"\<\[Phi]InP\>\"", "\[Rule]", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"propIn", "===", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{"originalorder", ".", "\[Phi]In", ".", 
                    RowBox[{"propIn", "\[Transpose]"}]}]}], "]"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"\"\<\[Lambda]InP\>\"", "->", 
                  RowBox[{"Pick", "[", 
                   RowBox[{"\[Lambda]In", ",", 
                    RowBox[{"Thread", "[", 
                    RowBox[{"vIn", "\[NotEqual]", "0"}], "]"}]}], "]"}]}], 
                 ",", "\[IndentingNewLine]", 
                 RowBox[{"\"\<\[Phi]Out\>\"", "\[Rule]", 
                  RowBox[{"originalorder", ".", "\[Phi]Out"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"\"\<\[Lambda]Out\>\"", "\[Rule]", "\[Lambda]Out"}], 
                 ",", "\[IndentingNewLine]", 
                 RowBox[{"\"\<r0Full\>\"", "\[Rule]", "r0"}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"\"\<invphigFull\>\"", "->", 
                  RowBox[{"invphiOut", ".", "gr", ".", 
                   RowBox[{"psurface", "\[Transpose]"}]}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"\"\<ldos\>\"", "\[Rule]", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Total", "[", 
                    RowBox[{"DeleteCases", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", "}"}]}], "]"}], "]"}], "&"}], "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"#", "===", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"#", ".", 
                    RowBox[{"#", "\[HermitianConjugate]"}]}], "&"}], "/@", 
                    RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"lead", "[", "\"\<SiteDimensions\>\"", "]"}]}], 
                    "]"}]}], ")"}]}], "]"}], "&"}], "/@", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"propOut", "===", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{"originalorder", ".", "\[Phi]Out", ".", 
                    RowBox[{"propOut", "\[Transpose]"}]}]}], "]"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"propIn", "===", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{"originalorder", ".", "\[Phi]In", ".", 
                    RowBox[{"propIn", "\[Transpose]"}]}]}], "]"}]}], "}"}]}], 
                    "]"}], ")"}]}]}], "}"}]}], ",", "\[IndentingNewLine]", 
              RowBox[{"{", "}"}]}], "]"}]}]}], "]"}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
        RowBox[{"Note", " ", "that", " ", "infinite"}], "-", 
        RowBox[{
        "lead", " ", "ldos", " ", "is", " ", "written", " ", "as", " ", "the",
          " ", "sum", " ", 
         SubscriptBox["\[CapitalSigma]", "k"], 
         RowBox[{"\[LeftAngleBracket]", 
          RowBox[{"r", "|", 
           SubscriptBox["\[Psi]", 
            RowBox[{"k\[Sigma]", "'"}]]}], "\[RightAngleBracket]"}], 
         RowBox[{"\[LeftAngleBracket]", 
          RowBox[{
           SubscriptBox["\[Psi]", "k\[Sigma]"], "|", "r"}], 
          "\[RightAngleBracket]"}]}]}], ",", " ", 
       RowBox[{
       "where", " ", "k", " ", "are", " ", "both", " ", "incoming", " ", 
        "and", " ", "outgoing", " ", "scattering", " ", "states", " ", 
        RowBox[{"(", 
         RowBox[{"if", " ", "they", " ", "exist"}], ")"}]}]}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
        RowBox[{
        "Define", " ", "the", " ", "reflection", " ", "matrix", " ", "from", 
         " ", "prop"}], "-", 
        RowBox[{"in", " ", "to", " ", "all"}], "-", "out"}], ",", 
       RowBox[{
        RowBox[{
        "with", " ", "that", " ", "define", " ", "the", " ", "amplitude", " ",
          "psi", " ", "of", " ", "all", " ", "eigenmode", " ", "of", " ", 
         "the", " ", "semi"}], "-", 
        RowBox[{
        "infinite", " ", "wire", " ", "at", " ", "the", " ", "edge", " ", 
         RowBox[{"(", 
          RowBox[{"one", " ", "per", " ", "outgoing", " ", "eigenmode"}], 
          ")"}]}]}], ",", " ", 
       RowBox[{
        RowBox[{
        "then", " ", "project", " ", "r0", " ", "to", " ", "only", " ", 
         "prop"}], "-", "out"}], ",", " ", 
       RowBox[{
        RowBox[{
        "and", " ", "finally", " ", "define", " ", "the", " ", "spatial", " ",
          "projector", " ", "onto", " ", "prop"}], "-", "out"}]}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"r0", "=", 
      RowBox[{"-", 
       RowBox[{
        RowBox[{"DiagonalMatrix", "[", "\[Lambda]Out", "]"}], ".", 
        "invphiOut", ".", "\[Phi]In", ".", 
        RowBox[{"DiagonalMatrix", "[", 
         RowBox[{"1", "/", "\[Lambda]In"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"psi", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"\[Phi]In", "+", 
         RowBox[{"\[Phi]Out", ".", "r0"}]}], ")"}], ".", 
       RowBox[{"propIn", "\[Transpose]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"r0", "=", 
      RowBox[{"r0", ".", 
       RowBox[{"propIn", "\[Transpose]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"invphig", "=", 
      RowBox[{"invphiOut", ".", "gr", ".", 
       RowBox[{"psurface", "\[Transpose]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"invg", "=", 
      RowBox[{"Inverse", "[", 
       RowBox[{"psurface", ".", "gr", ".", 
        RowBox[{"psurface", "\[Transpose]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Return", "[", 
      RowBox[{"MQLeadSolution", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\"\<r0\>\"", "\[Rule]", 
         RowBox[{"propOut", ".", "r0"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<psiSurface\>\"", "\[Rule]", 
         RowBox[{"psurface", ".", "psi"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<invphig\>\"", "\[Rule]", 
         RowBox[{"propOut", ".", "invphig"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<gSurface\>\"", "\[Rule]", 
         RowBox[{"psurface", ".", "gr", ".", 
          RowBox[{"psurface", "\[Transpose]"}]}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<invg\>\"", "\[Rule]", "invg"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<Nambu\>\"", "\[Rule]", "Nambu"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<NambuSectors\>\"", "->", "NambuSectors"}], ",", " ", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<ExtraData\>\"", "\[Rule]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"OptionValue", "[", "IncludeExtraData", "]"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"originalorder", "=", 
             RowBox[{
              RowBox[{"SparseArray", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"Length", "@", "minimalsites"}], ",", 
                  RowBox[{"Length", "@", "minimalsites"}]}], "}"}]}], "]"}], 
              "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "minimalsites"}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\"\<\[Phi]InP\>\"", "->", 
               RowBox[{"originalorder", ".", "\[Phi]In", ".", 
                RowBox[{"propIn", "\[Transpose]"}]}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"\"\<\[Lambda]InP\>\"", "->", 
               RowBox[{"Pick", "[", 
                RowBox[{"\[Lambda]In", ",", 
                 RowBox[{"Thread", "[", 
                  RowBox[{"vIn", "\[NotEqual]", "0"}], "]"}]}], "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"\"\<\[Phi]Out\>\"", "\[Rule]", 
               RowBox[{"originalorder", ".", "\[Phi]Out"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"\"\<\[Lambda]Out\>\"", "\[Rule]", "\[Lambda]Out"}], 
              ",", "\[IndentingNewLine]", 
              RowBox[{"\"\<r0Full\>\"", "\[Rule]", "r0"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"\"\<invphigFull\>\"", "->", "invphig"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"\"\<ldos\>\"", "\[Rule]", 
               RowBox[{"(*", 
                RowBox[{
                 RowBox[{
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"#", "\[Equal]", "0"}], ",", 
                    RowBox[{"ConstantArray", "[", 
                    RowBox[{"0", ",", "dim"}], "]"}], ",", "#"}], "]"}], 
                  "&"}], "@"}], "*)"}], 
               RowBox[{"Total", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"#", ".", 
                    RowBox[{"#", "\[HermitianConjugate]"}]}], "&"}], "/@", 
                    RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"lead", "[", "\"\<SiteDimensions\>\"", "]"}]}], 
                    "]"}]}], ")"}], "&"}], "/@", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"originalorder", ".", "\[Phi]Out", ".", 
                    RowBox[{"propOut", "\[Transpose]"}]}], ",", 
                   RowBox[{"originalorder", ".", "\[Phi]In", ".", 
                    RowBox[{"propIn", "\[Transpose]"}]}]}], "}"}]}], 
                "]"}]}]}], "}"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"{", "}"}]}], "]"}]}]}], "]"}], "]"}], ";"}]}], 
   "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.5979447360616693`*^9, 3.5979447987124777`*^9}, {
   3.597944887542884*^9, 3.5979449194332047`*^9}, {3.597944967119108*^9, 
   3.5979452071739798`*^9}, {3.5979452480657053`*^9, 
   3.5979453095903807`*^9}, {3.597946038083503*^9, 3.597946072595924*^9}, {
   3.597946131575213*^9, 3.5979461912768927`*^9}, {3.5979462516646*^9, 
   3.597946295379198*^9}, {3.597946397153393*^9, 3.597946540136833*^9}, {
   3.597946585369257*^9, 3.5979466778709173`*^9}, {3.59794671391276*^9, 
   3.597946920158903*^9}, 3.5980728673643923`*^9, {3.5980927629873734`*^9, 
   3.598093020795279*^9}, {3.598093057830885*^9, 3.598093075557253*^9}, {
   3.598093207314831*^9, 3.598093352955276*^9}, {3.598093438610972*^9, 
   3.5980934400711393`*^9}, {3.598093621854513*^9, 3.598093941889762*^9}, {
   3.598094061539159*^9, 3.598094231565384*^9}, {3.598094360101583*^9, 
   3.59809437161522*^9}, {3.598094462458582*^9, 3.5980946222586603`*^9}, {
   3.59809465336337*^9, 3.59809465413033*^9}, {3.5980946906080914`*^9, 
   3.5980947823852873`*^9}, {3.598094827268359*^9, 3.598094830105958*^9}, {
   3.5980948680087023`*^9, 3.5980952761075907`*^9}, {3.598095306892997*^9, 
   3.5980955898362722`*^9}, {3.598095651750764*^9, 3.598095687099568*^9}, {
   3.5980957805891943`*^9, 3.5980958799473457`*^9}, {3.5980959199287443`*^9, 
   3.598096061224162*^9}, {3.5980961318660192`*^9, 3.598096181180608*^9}, {
   3.5980962114349947`*^9, 3.5980964783830547`*^9}, {3.598096519458103*^9, 
   3.598096773071225*^9}, {3.5980968110536327`*^9, 3.5980968178012457`*^9}, {
   3.59809684817207*^9, 3.598096908023415*^9}, {3.5980969504795103`*^9, 
   3.598096963791976*^9}, {3.5980969953534822`*^9, 3.5980971345625362`*^9}, {
   3.598097261211183*^9, 3.598097305164775*^9}, {3.598097436733356*^9, 
   3.598097528533865*^9}, {3.598097709636099*^9, 3.598097784837751*^9}, {
   3.598097816551762*^9, 3.5980978880543003`*^9}, {3.598097958940382*^9, 
   3.5980979959288177`*^9}, {3.5980980912419357`*^9, 3.5980981326541853`*^9}, 
   3.5980981686225357`*^9, {3.598098216407568*^9, 3.5980982220995493`*^9}, {
   3.598098258721449*^9, 3.598098261411064*^9}, {3.598098389041422*^9, 
   3.5980984014823227`*^9}, {3.598098475374193*^9, 3.5980984924808483`*^9}, {
   3.5980985470839376`*^9, 3.59809856841291*^9}, {3.598098605723157*^9, 
   3.598098635564879*^9}, {3.598098703802785*^9, 3.598098732830843*^9}, {
   3.598098787553692*^9, 3.5980988622423058`*^9}, {3.598098950100984*^9, 
   3.598098967844007*^9}, {3.598098998893461*^9, 3.598099018893289*^9}, 
   3.5980993847775173`*^9, {3.598099429217214*^9, 3.5980994542679443`*^9}, 
   3.598099575128757*^9, {3.598099607727319*^9, 3.598099624620863*^9}, {
   3.598099827518711*^9, 3.5980998706884336`*^9}, {3.598099945349554*^9, 
   3.598099952527945*^9}, {3.598100021021319*^9, 3.5981000416918097`*^9}, {
   3.598100125659*^9, 3.5981001704836893`*^9}, {3.598100306553931*^9, 
   3.598100419935494*^9}, {3.598100475700109*^9, 3.598100614070531*^9}, {
   3.598100723642035*^9, 3.598100776772265*^9}, {3.5981011051402407`*^9, 
   3.5981011508747187`*^9}, {3.59810121389834*^9, 3.598101310320484*^9}, {
   3.598101351088407*^9, 3.598101960078082*^9}, {3.598102000403377*^9, 
   3.5981020188102427`*^9}, {3.598102073153968*^9, 3.598102127119308*^9}, {
   3.598102261601556*^9, 3.598102294566949*^9}, {3.598102456384843*^9, 
   3.59810254607365*^9}, {3.5981026452092876`*^9, 3.598102728531808*^9}, {
   3.59810277013272*^9, 3.5981028327284117`*^9}, {3.598102873583173*^9, 
   3.598102890789401*^9}, {3.5981029721744747`*^9, 3.598102974337833*^9}, {
   3.5981030110191307`*^9, 3.598103011684779*^9}, {3.598103051686061*^9, 
   3.598103057412932*^9}, {3.59810460943442*^9, 3.598104610433346*^9}, {
   3.598104718588243*^9, 3.598104810458268*^9}, {3.598104841910581*^9, 
   3.598104845982016*^9}, {3.598104986399382*^9, 3.598104988513505*^9}, {
   3.598105048998006*^9, 3.598105049774404*^9}, {3.598105103146409*^9, 
   3.598105146017211*^9}, {3.598105208407366*^9, 3.598105258405364*^9}, {
   3.598105290502893*^9, 3.598105299605649*^9}, {3.598105344707959*^9, 
   3.598105371148628*^9}, {3.598105455155661*^9, 3.598105500636039*^9}, {
   3.5981056167465076`*^9, 3.598105636551874*^9}, {3.598105904466755*^9, 
   3.598105906848439*^9}, {3.598105976143474*^9, 3.598105976334848*^9}, 
   3.598106013141356*^9, {3.598106052465904*^9, 3.5981061021996603`*^9}, 
   3.598106139721196*^9, {3.5981062623866653`*^9, 3.598106281535071*^9}, 
   3.5981063371706448`*^9, {3.598106368227345*^9, 3.59810637062904*^9}, {
   3.5981064543626204`*^9, 3.5981065070766783`*^9}, {3.598106546841448*^9, 
   3.598106575376433*^9}, {3.598106608930418*^9, 3.598106837039124*^9}, {
   3.598106929097189*^9, 3.598106933957347*^9}, {3.59810701720461*^9, 
   3.598107037730648*^9}, {3.59810716094319*^9, 3.5981071729621267`*^9}, {
   3.598109701508771*^9, 3.598109706859931*^9}, {3.598109744966694*^9, 
   3.598109783969503*^9}, {3.598109831821673*^9, 3.5981098888075666`*^9}, {
   3.598109973262291*^9, 3.598109975781489*^9}, {3.59811001268795*^9, 
   3.598110061917275*^9}, {3.5981101396725073`*^9, 3.598110140144498*^9}, {
   3.598162713194107*^9, 3.598162734309001*^9}, {3.59816289081238*^9, 
   3.59816290181221*^9}, {3.598162944061645*^9, 3.598162949777294*^9}, {
   3.5981631212927523`*^9, 3.5981632690182247`*^9}, {3.5981633366243067`*^9, 
   3.598163355658578*^9}, {3.5981637943867273`*^9, 3.59816380725124*^9}, {
   3.5981640543547573`*^9, 3.598164059061133*^9}, {3.598164340242691*^9, 
   3.5981643414250193`*^9}, {3.598164768706901*^9, 3.598164867134021*^9}, {
   3.598164922151174*^9, 3.5981649836637506`*^9}, 3.598165166932866*^9, {
   3.598165197493248*^9, 3.598165236117935*^9}, {3.598165289039266*^9, 
   3.598165289417457*^9}, {3.5981653619627666`*^9, 3.598165428307118*^9}, {
   3.598165478761896*^9, 3.5981655426327267`*^9}, {3.5981656122463713`*^9, 
   3.59816567683782*^9}, {3.598165713163559*^9, 3.598165713747013*^9}, {
   3.598165777851295*^9, 3.598165811378479*^9}, {3.598165914286749*^9, 
   3.598165915467815*^9}, {3.5981659669891863`*^9, 3.5981660263903713`*^9}, {
   3.59816612287866*^9, 3.598166130927312*^9}, {3.598166240302381*^9, 
   3.5981662480716667`*^9}, {3.5981664254725018`*^9, 
   3.5981664757971897`*^9}, {3.598166618535007*^9, 3.598166628144561*^9}, {
   3.598166823751731*^9, 3.598166851537277*^9}, {3.598166884888345*^9, 
   3.598166956313417*^9}, {3.5981672589664793`*^9, 3.5981672633165493`*^9}, {
   3.598167301797447*^9, 3.598167304322707*^9}, {3.5981673814013653`*^9, 
   3.5981673865483017`*^9}, {3.598167419126297*^9, 3.5981674217698927`*^9}, {
   3.598167452768312*^9, 3.598167481786029*^9}, {3.5981675457970037`*^9, 
   3.598167547159115*^9}, {3.5981676333962307`*^9, 3.598167716362855*^9}, {
   3.5981678503205967`*^9, 3.598167892594016*^9}, {3.5981679715060368`*^9, 
   3.598168015067721*^9}, 3.598168104544051*^9, {3.598168193264221*^9, 
   3.598168195919236*^9}, {3.5981691200273533`*^9, 3.598169129472076*^9}, {
   3.598169853940555*^9, 3.598169861548517*^9}, {3.59817013126309*^9, 
   3.598170200646249*^9}, {3.598170297747322*^9, 3.598170297835389*^9}, {
   3.5981703896239777`*^9, 3.5981703923676987`*^9}, 3.598170437698963*^9, {
   3.598170495251934*^9, 3.598170498285015*^9}, {3.598173296029707*^9, 
   3.598173359186872*^9}, 3.598173395483224*^9, {3.598174615728547*^9, 
   3.598174722730064*^9}, 3.598174829045125*^9, {3.598174929719173*^9, 
   3.5981749333352337`*^9}, 3.598176272675886*^9, {3.59817631600506*^9, 
   3.598176324753159*^9}, {3.598176381028945*^9, 3.5981764026410227`*^9}, {
   3.598177585721347*^9, 3.598177590975999*^9}, {3.598177858353284*^9, 
   3.598177891148304*^9}, {3.598177923166576*^9, 3.5981779671704807`*^9}, {
   3.5981779983584146`*^9, 3.598178017400003*^9}, 3.598178062302742*^9, {
   3.5981781321138372`*^9, 3.598178168420438*^9}, {3.59817822906392*^9, 
   3.598178243598288*^9}, {3.598178404429393*^9, 3.598178446925344*^9}, {
   3.5981784878190737`*^9, 3.598178621514249*^9}, {3.5981786577459927`*^9, 
   3.5981787644112587`*^9}, {3.5981788063037663`*^9, 3.59817882897056*^9}, {
   3.598178893770136*^9, 3.598178919566033*^9}, {3.598179382495257*^9, 
   3.5981793946965923`*^9}, {3.598179518639613*^9, 3.59817952589454*^9}, {
   3.598179622294818*^9, 3.5981796771152487`*^9}, {3.59817980242197*^9, 
   3.598179945208927*^9}, {3.598179984487397*^9, 3.598180046968088*^9}, {
   3.598180198872725*^9, 3.598180199242524*^9}, {3.598181445618766*^9, 
   3.5981815131982317`*^9}, {3.598183273265049*^9, 3.598183275977852*^9}, {
   3.5981833188926277`*^9, 3.598183332061606*^9}, {3.598184253842799*^9, 
   3.598184271841907*^9}, {3.598199420757218*^9, 3.5981994672869473`*^9}, {
   3.59819951231404*^9, 3.5981995553171463`*^9}, {3.598247020325224*^9, 
   3.5982470667464123`*^9}, {3.598250179106579*^9, 3.5982501982032146`*^9}, {
   3.598250230735601*^9, 3.598250233765214*^9}, {3.598250272210636*^9, 
   3.5982503498071527`*^9}, {3.5982508984448423`*^9, 3.598250900220161*^9}, 
   3.598250954116899*^9, {3.598251113835187*^9, 3.598251142685924*^9}, {
   3.598251232623571*^9, 3.598251237973896*^9}, {3.598257753777828*^9, 
   3.598257764051111*^9}, {3.5982578122309103`*^9, 3.5982578274307127`*^9}, {
   3.5982594069649277`*^9, 3.598259572813805*^9}, {3.5982597277132807`*^9, 
   3.5982597716664667`*^9}, {3.5982598120714006`*^9, 3.598259837824239*^9}, {
   3.598260389707735*^9, 3.5982606659644003`*^9}, {3.598260733355966*^9, 
   3.59826077269901*^9}, {3.59826109416651*^9, 3.598261147375266*^9}, {
   3.59826117877122*^9, 3.598261209019786*^9}, {3.598261239347883*^9, 
   3.598261252646023*^9}, {3.598261723650825*^9, 3.5982617252671337`*^9}, {
   3.5982617604780416`*^9, 3.598261923767025*^9}, {3.598262261109453*^9, 
   3.5982622962020693`*^9}, {3.598262392870767*^9, 3.598262442865834*^9}, {
   3.598262505395372*^9, 3.5982625594049377`*^9}, {3.598262650749668*^9, 
   3.5982626868816557`*^9}, {3.59826279038967*^9, 3.5982628686247396`*^9}, {
   3.598263027316502*^9, 3.5982630301629267`*^9}, {3.598263139004753*^9, 
   3.598263141482685*^9}, {3.5982631873525*^9, 3.5982631974741573`*^9}, {
   3.5982632902656507`*^9, 3.5982633108397007`*^9}, {3.598263524452858*^9, 
   3.5982636175239887`*^9}, {3.5982636562616663`*^9, 
   3.5982638802030277`*^9}, {3.598263955683812*^9, 3.598263985241897*^9}, {
   3.598264105770418*^9, 3.598264147942062*^9}, {3.598264247278604*^9, 
   3.598264290206583*^9}, {3.598264408163966*^9, 3.598264424362938*^9}, {
   3.598264477744588*^9, 3.598264508674321*^9}, {3.598264564198924*^9, 
   3.598264620827898*^9}, {3.598264664371202*^9, 3.598264682139703*^9}, {
   3.598264741770344*^9, 3.598264746335516*^9}, {3.598264795075886*^9, 
   3.598264854220736*^9}, {3.598264917067227*^9, 3.598264928012908*^9}, {
   3.598265040107711*^9, 3.59826509227285*^9}, {3.598265197740209*^9, 
   3.598265274341762*^9}, {3.598265518099537*^9, 3.598265536348793*^9}, {
   3.598265690265168*^9, 3.598265860408661*^9}, {3.5982658949144573`*^9, 
   3.598265897144596*^9}, {3.598265932898823*^9, 3.598265936078817*^9}, {
   3.5982659867541113`*^9, 3.598266004001733*^9}, {3.598266112603343*^9, 
   3.5982661128345633`*^9}, {3.598266511583961*^9, 3.598266534695512*^9}, {
   3.5982668802052727`*^9, 3.598266960247991*^9}, {3.598267309713971*^9, 
   3.59826737392*^9}, {3.59826741013385*^9, 3.598267464530717*^9}, {
   3.59826760595052*^9, 3.59826760748387*^9}, {3.598267923046756*^9, 
   3.598267997168385*^9}, {3.5982680981113453`*^9, 3.598268129353805*^9}, {
   3.5982682895052357`*^9, 3.598268324333181*^9}, {3.59826838401782*^9, 
   3.598268427154152*^9}, {3.598268611813772*^9, 3.598268615479663*^9}, 
   3.5982686877775507`*^9, {3.5982689849721003`*^9, 3.598269012438456*^9}, {
   3.59826943011661*^9, 3.598269431482463*^9}, {3.598269534735791*^9, 
   3.598269536119424*^9}, {3.5982712250748587`*^9, 3.598271249614439*^9}, {
   3.598333987759369*^9, 3.5983340411472588`*^9}, {3.59833408742761*^9, 
   3.598334352157194*^9}, {3.598334508918357*^9, 3.598334541253076*^9}, {
   3.598340786041141*^9, 3.5983407917511177`*^9}, {3.5983408417986517`*^9, 
   3.598340907391451*^9}, {3.598340978101074*^9, 3.598341076538162*^9}, {
   3.598341979244954*^9, 3.5983420220176973`*^9}, {3.598342057388206*^9, 
   3.598342065956562*^9}, {3.598343621485437*^9, 3.598343624068562*^9}, {
   3.5983437244598722`*^9, 3.59834372649166*^9}, {3.5983437990385933`*^9, 
   3.598343799829813*^9}, {3.598343915783351*^9, 3.598343944231189*^9}, {
   3.598343974460239*^9, 3.598343977747518*^9}, {3.598344048761413*^9, 
   3.598344097935093*^9}, {3.598344309717464*^9, 3.598344316765313*^9}, {
   3.598344356408497*^9, 3.59834435719143*^9}, {3.5983450907979603`*^9, 
   3.598345122269685*^9}, {3.5983454365772552`*^9, 3.598345454842722*^9}, {
   3.5983457510182867`*^9, 3.598345870777171*^9}, {3.598345901642661*^9, 
   3.598345970362718*^9}, {3.598346881374022*^9, 3.5983468925094557`*^9}, {
   3.598346973355364*^9, 3.5983469774762506`*^9}, 3.598347385105496*^9, {
   3.598347429819458*^9, 3.59834745541229*^9}, {3.5983485476688547`*^9, 
   3.5983485557464867`*^9}, {3.5988699140722427`*^9, 3.598869919519025*^9}, {
   3.598890256335122*^9, 3.598890261246541*^9}, {3.5989412734005327`*^9, 
   3.598941280068515*^9}, {3.598941326200876*^9, 3.598941359623086*^9}, {
   3.598941421573762*^9, 3.598941422492296*^9}, {3.598941635564296*^9, 
   3.598941685672679*^9}, {3.5989417339368353`*^9, 3.598941735655733*^9}, {
   3.598941774117721*^9, 3.5989418902970552`*^9}, {3.598941925316204*^9, 
   3.598941947612747*^9}, {3.598942007012104*^9, 3.59894201327454*^9}, {
   3.5989421980495243`*^9, 3.598942224170272*^9}, {3.598942307269723*^9, 
   3.5989423254888763`*^9}, {3.598942464100518*^9, 3.5989424652672777`*^9}, {
   3.598942507317629*^9, 3.598942532929343*^9}, 3.598942566512492*^9, {
   3.598942688428175*^9, 3.598942692296195*^9}, {3.598942849075365*^9, 
   3.598942910547202*^9}, {3.598943273576107*^9, 3.5989433154729557`*^9}, {
   3.5989436641624928`*^9, 3.5989436675602617`*^9}, {3.598943717108541*^9, 
   3.598943732856495*^9}, {3.598943780377411*^9, 3.5989439308131104`*^9}, {
   3.59894397260909*^9, 3.5989440283330584`*^9}, {3.598954491730239*^9, 
   3.5989545424259987`*^9}, {3.598954623129307*^9, 3.598954649442672*^9}, {
   3.598954706146392*^9, 3.598954716001376*^9}, {3.5989547602526073`*^9, 
   3.59895483416635*^9}, {3.598954885749591*^9, 3.598954886764923*^9}, {
   3.598954927752977*^9, 3.598954938643517*^9}, {3.5989549800066233`*^9, 
   3.598954980181343*^9}, {3.598955234239094*^9, 3.598955251675166*^9}, {
   3.598955326563702*^9, 3.598955401235018*^9}, {3.5989689056576*^9, 
   3.5989689215498047`*^9}, {3.598968954276452*^9, 3.598969091019511*^9}, {
   3.598969149186817*^9, 3.598969168763064*^9}, {3.5989692031533957`*^9, 
   3.598969234405748*^9}, {3.598969288066629*^9, 3.598969291804882*^9}, {
   3.598969331799122*^9, 3.598969336142358*^9}, {3.598969466742138*^9, 
   3.5989694743988743`*^9}, {3.598986651529977*^9, 3.5989866544804363`*^9}, {
   3.5989866959667377`*^9, 3.598986702277478*^9}, {3.59898679381931*^9, 
   3.598986837575835*^9}, {3.598986957778637*^9, 3.5989869603339*^9}, {
   3.599020515565988*^9, 3.599020590859527*^9}, {3.599020636208349*^9, 
   3.599020648546938*^9}, {3.599020709499604*^9, 3.599020733064672*^9}, {
   3.599020780341564*^9, 3.599020819860837*^9}, {3.599021492993127*^9, 
   3.599021510145446*^9}, {3.599198171193431*^9, 3.59919817218226*^9}, {
   3.599213802378367*^9, 3.59921381905056*^9}, {3.602483642302299*^9, 
   3.602483658252802*^9}, {3.602483750742222*^9, 3.602483810225667*^9}, {
   3.602483882369404*^9, 3.602483980274393*^9}, 3.60248403811732*^9, {
   3.6024840695065203`*^9, 3.6024841158657007`*^9}, {3.602484464934215*^9, 
   3.6024844660531797`*^9}, {3.603176007608872*^9, 3.603176102608796*^9}, {
   3.603176417044485*^9, 3.603176468303422*^9}, {3.603176594239567*^9, 
   3.6031766177499437`*^9}, {3.6031771888973846`*^9, 3.603177203059833*^9}, {
   3.603177236213879*^9, 3.603177278968759*^9}, {3.603178762114998*^9, 
   3.6031787633300943`*^9}, {3.603179264499445*^9, 3.603179306302043*^9}, {
   3.6031794161854277`*^9, 3.6031794260033407`*^9}, {3.6031797395717773`*^9, 
   3.6031797482602787`*^9}, {3.603180515602563*^9, 3.603180541034301*^9}, {
   3.603181950062354*^9, 3.603181971946418*^9}, {3.603182190885476*^9, 
   3.603182198461199*^9}, {3.603185122937353*^9, 3.6031851767931833`*^9}, {
   3.603185216834496*^9, 3.6031852742870693`*^9}, {3.603185461751746*^9, 
   3.603185477590602*^9}, {3.6031855423062162`*^9, 3.603185551392116*^9}, {
   3.603185603665255*^9, 3.603185681281849*^9}, {3.603185728854805*^9, 
   3.603185749530032*^9}, 3.603185794613011*^9, {3.6031858575854673`*^9, 
   3.603185874197728*^9}, {3.603185906301095*^9, 3.603186038857449*^9}, {
   3.60318612891656*^9, 3.603186141478437*^9}, {3.603186289554441*^9, 
   3.603186320699115*^9}, {3.603186509267095*^9, 3.603186583312619*^9}, {
   3.603186648323346*^9, 3.6031866730146627`*^9}, {3.6031867083898697`*^9, 
   3.603186759121792*^9}, {3.6031868111428347`*^9, 3.603186813517536*^9}, {
   3.603186843722713*^9, 3.60318684755264*^9}, {3.603186907874646*^9, 
   3.603187026527619*^9}, {3.603187088227516*^9, 3.6031871262365522`*^9}, {
   3.603187184079699*^9, 3.603187188188917*^9}, 3.603187222348187*^9, {
   3.603187269895404*^9, 3.6031873064234753`*^9}, {3.603187356117041*^9, 
   3.6031873565123863`*^9}, {3.603187491351857*^9, 3.603187497122801*^9}, {
   3.603188531027198*^9, 3.60318862797148*^9}, {3.6031898682574663`*^9, 
   3.603189926246347*^9}, {3.603192423964973*^9, 3.603192454208931*^9}, {
   3.603622291625993*^9, 3.603622313024208*^9}, {3.603622349732847*^9, 
   3.6036224281432457`*^9}, {3.603622460640892*^9, 3.6036224768682327`*^9}, {
   3.603622635279354*^9, 3.603622647128044*^9}, {3.603622767546089*^9, 
   3.603622774976317*^9}, {3.603625424639763*^9, 3.603625425257146*^9}, {
   3.603625499201926*^9, 3.603625504318129*^9}, {3.603625630517289*^9, 
   3.603625663159371*^9}, {3.6036257415912027`*^9, 3.6036257564206247`*^9}, {
   3.603625826584421*^9, 3.6036258514987288`*^9}, {3.603625907780547*^9, 
   3.6036259314271107`*^9}, {3.6036284409848337`*^9, 3.603628456998342*^9}, {
   3.611491403506783*^9, 3.6114914234308767`*^9}, {3.61149145347208*^9, 
   3.611491472165865*^9}, {3.614411241237804*^9, 3.614411258523182*^9}, 
   3.614411309356764*^9, 3.614411434452961*^9, {3.620449463926388*^9, 
   3.620449616593878*^9}, {3.620449648540258*^9, 3.6204496528231163`*^9}, {
   3.62044973107307*^9, 3.6204498198232822`*^9}, {3.620449877118103*^9, 
   3.620449902649143*^9}, {3.6204499569611053`*^9, 3.620450002289221*^9}, {
   3.620450081022131*^9, 3.62045008236901*^9}, {3.620450330563985*^9, 
   3.620450404957274*^9}, {3.620450442035236*^9, 3.620450459669894*^9}, {
   3.620450502351252*^9, 3.620450556828698*^9}, {3.6204517845410624`*^9, 
   3.6204517997463007`*^9}, {3.621581016191463*^9, 3.621581041917912*^9}, {
   3.621581129698118*^9, 3.6215811310179653`*^9}, {3.6215813440069113`*^9, 
   3.621581447113007*^9}, {3.621581812338664*^9, 3.621581828417239*^9}, {
   3.621581869246414*^9, 3.621581877198189*^9}, {3.621582057396606*^9, 
   3.621582065517007*^9}, {3.6215881933773518`*^9, 3.62158821177376*^9}, {
   3.621589482195299*^9, 3.6215895513633547`*^9}, {3.621590231965968*^9, 
   3.621590319368739*^9}, {3.6215903601444273`*^9, 3.621590477184651*^9}, {
   3.6215905187026567`*^9, 3.621590613284637*^9}, {3.6215920769709*^9, 
   3.621592078062215*^9}, {3.62159305737774*^9, 3.621593058458335*^9}, {
   3.621593149974452*^9, 3.621593171085105*^9}, {3.6215932062670927`*^9, 
   3.621593208659157*^9}, {3.621593256347807*^9, 3.6215932829559937`*^9}, {
   3.6215933247563467`*^9, 3.6215934216919403`*^9}, {3.621594306722095*^9, 
   3.6215943180540943`*^9}, 3.623479052285659*^9, 3.6234791166867*^9, {
   3.62347932405368*^9, 3.623479400236005*^9}, {3.62347945017865*^9, 
   3.62347950515133*^9}, {3.623479586890874*^9, 3.623479655770335*^9}, {
   3.623479696049573*^9, 3.623479729216165*^9}, {3.623479762230455*^9, 
   3.6234797752693453`*^9}, {3.62347984025427*^9, 3.623479845059478*^9}, {
   3.623479878091785*^9, 3.623479927561499*^9}, {3.623479966744746*^9, 
   3.623480034624281*^9}, {3.623480072216145*^9, 3.623480088674555*^9}, {
   3.623480161179449*^9, 3.623480312967795*^9}, {3.62348057915236*^9, 
   3.623480604051771*^9}, {3.623480647558488*^9, 3.623480667973843*^9}, {
   3.623480711204994*^9, 3.623480917654558*^9}, {3.623480949206829*^9, 
   3.6234809677985077`*^9}, {3.623481003263584*^9, 3.623481076930229*^9}, {
   3.6234811214507647`*^9, 3.623481178039818*^9}, {3.6234812282562943`*^9, 
   3.623481273436236*^9}, {3.6234813089079847`*^9, 3.623481333363493*^9}, {
   3.623486289030796*^9, 3.623486343464611*^9}, {3.623486375972638*^9, 
   3.623486444734129*^9}, {3.6234867307098618`*^9, 3.623486783261393*^9}, {
   3.623486831005175*^9, 3.6234868333472843`*^9}, 3.623511590838294*^9, {
   3.623511624548004*^9, 3.623511659989687*^9}, 3.623569816366012*^9, {
   3.6235698539711437`*^9, 3.623569887960043*^9}, 3.623570039914124*^9, {
   3.629641804512905*^9, 3.629641806760675*^9}, {3.635076639037683*^9, 
   3.635076648782094*^9}, {3.635236092889422*^9, 3.635236092897707*^9}, {
   3.635680212358728*^9, 3.635680223140826*^9}, {3.635680285020043*^9, 
   3.635680348434848*^9}, {3.635964329769527*^9, 3.635964332815269*^9}, {
   3.63596436924686*^9, 3.6359644331915703`*^9}, {3.6359644685565367`*^9, 
   3.6359645436282883`*^9}, {3.635964712915242*^9, 3.63596471552087*^9}, {
   3.635965314646845*^9, 3.635965315862084*^9}, {3.6359653599076*^9, 
   3.635965439746825*^9}, {3.635966272730605*^9, 3.6359663207106133`*^9}, {
   3.635966363376905*^9, 3.635966366114171*^9}, {3.6359664202854643`*^9, 
   3.635966475855823*^9}, {3.636004802679398*^9, 3.636004807441099*^9}, 
   3.636004852846627*^9, {3.636004909624611*^9, 3.636004941461753*^9}, {
   3.636005049220578*^9, 3.6360050530424957`*^9}, {3.6360050960855722`*^9, 
   3.6360051390647182`*^9}, {3.636092970210843*^9, 3.6360930904734507`*^9}, {
   3.636093173272398*^9, 3.6360933198277893`*^9}, {3.6360933734991617`*^9, 
   3.6360933833560743`*^9}, {3.636093453908352*^9, 3.6360934819861927`*^9}, {
   3.636093532064179*^9, 3.636093549015318*^9}, 3.63609367717171*^9, {
   3.6360937503663683`*^9, 3.636093760878168*^9}, {3.636095583259712*^9, 
   3.636095597890748*^9}, {3.636105492903924*^9, 3.6361055178357897`*^9}, {
   3.636220490192264*^9, 3.636220490366148*^9}, {3.6362271034155912`*^9, 
   3.636227153796897*^9}, {3.6362272072942867`*^9, 3.636227207418532*^9}, {
   3.637572355729941*^9, 3.637572355738894*^9}, {3.656823673281822*^9, 
   3.656823697494135*^9}, {3.697803028140296*^9, 3.6978030337935553`*^9}, {
   3.752150565340096*^9, 3.752150587092894*^9}, {3.759062135021101*^9, 
   3.759062149392994*^9}, {3.784528266842957*^9, 3.784528282941865*^9}, {
   3.784528434473548*^9, 3.7845284711043253`*^9}, {3.784528521175789*^9, 
   3.784528525104177*^9}, {3.784528557023137*^9, 3.7845285978530197`*^9}, {
   3.784528790175482*^9, 3.784528939848844*^9}, {3.784528970050333*^9, 
   3.784528972490252*^9}},
 CellLabel->
  "In[239]:=",ExpressionUUID->"ffb8e7eb-e270-45cf-bdac-22996b5761a2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ComputeNambuSectors", "[", 
   RowBox[{"\[Phi]col_", ",", " ", "sitedimensions_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"indices", ",", " ", "echaracter", ",", "hcharacter", ",", " ", 
      RowBox[{"nmodes", "=", 
       RowBox[{"Last", "@", 
        RowBox[{"Dimensions", "@", "\[Phi]col"}]}]}], ",", " ", 
      "reordermatrix"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{
      "Compute", " ", "which", " ", "of", " ", "the", " ", "modes", " ", 
       "have", " ", "at", " ", "least", " ", "one", " ", "electron", " ", 
       "component"}], ",", " ", 
      RowBox[{
      "and", " ", "which", " ", "at", " ", "least", " ", "one", " ", "hole", 
       " ", "component"}]}], "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"echaracter", "=", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Or", "@@", 
           RowBox[{"Thread", "[", 
            RowBox[{"#", "\[NotEqual]", "0"}], "]"}]}], "&"}], "[", 
         RowBox[{"Chop", "[", 
          SuperscriptBox[
           RowBox[{"Abs", "[", 
            RowBox[{"Flatten", "[", 
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{"#", ",", 
                FractionBox["sitedimensions", "2"]}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ";;", ";;", "2"}], "]"}], "]"}], "]"}], "]"}], 
           "2"], "]"}], "]"}], "&"}], "/@", 
       RowBox[{"Transpose", "[", "\[Phi]col", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"hcharacter", "=", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Or", "@@", 
           RowBox[{"Thread", "[", 
            RowBox[{"#", "\[NotEqual]", "0"}], "]"}]}], "&"}], "[", 
         RowBox[{"Chop", "[", 
          SuperscriptBox[
           RowBox[{"Abs", "[", 
            RowBox[{"Flatten", "[", 
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{"#", ",", 
                FractionBox["sitedimensions", "2"]}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"2", ";;", ";;", "2"}], "]"}], "]"}], "]"}], "]"}], 
           "2"], "]"}], "]"}], "&"}], "/@", 
       RowBox[{"Transpose", "[", "\[Phi]col", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "If", " ", "the", " ", "two", " ", "sets", " ", "are", " ", 
        "complementary"}], ",", " ", 
       RowBox[{
       "they", " ", "are", " ", "purely", " ", "electronic", " ", "and", " ", 
        "purely", " ", "hole", " ", "in", " ", "character"}], ",", " ", 
       RowBox[{"Return", " ", 
        RowBox[{"them", ".", " ", "Otherwise"}]}], ",", " ", 
       RowBox[{"return", " ", 
        RowBox[{"None", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"echaracter", "==", 
        RowBox[{"Not", "/@", "hcharacter"}]}], ",", " ", 
       RowBox[{"Return", "[", 
        RowBox[{"{", 
         RowBox[{"echaracter", ",", " ", "hcharacter"}], "}"}], "]"}], ",", 
       RowBox[{"Return", "[", "None", "]"}]}], "]"}], ";"}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.598334536329463*^9, 3.598334549766995*^9}, {
   3.5983345837416677`*^9, 3.598334716561946*^9}, {3.598334852930966*^9, 
   3.598335033559306*^9}, {3.6234864681924553`*^9, 3.6234864782340727`*^9}, {
   3.623486572141102*^9, 3.623486574532757*^9}, {3.623486605949502*^9, 
   3.623486607293447*^9}, {3.623486836268317*^9, 3.623486836694168*^9}, {
   3.623490914266629*^9, 3.6234909284654922`*^9}, {3.6234909654492283`*^9, 
   3.623491186074725*^9}, 3.6234912532645607`*^9, {3.6234913853065853`*^9, 
   3.623491396051909*^9}, {3.623491466058071*^9, 3.623491468819127*^9}, {
   3.6234915032411623`*^9, 3.623491508975408*^9}, {3.623491544054995*^9, 
   3.623491548208181*^9}, {3.623491585926322*^9, 3.623491589725835*^9}, {
   3.623491659366637*^9, 3.623491665663683*^9}, {3.623491729825982*^9, 
   3.6234917328816423`*^9}, 3.6234917665575647`*^9, {3.623491834495284*^9, 
   3.6234919085254374`*^9}, {3.6234928364909563`*^9, 
   3.6234928755502357`*^9}, {3.62349290818399*^9, 3.623492909057063*^9}, {
   3.6350766733981457`*^9, 3.635076677741308*^9}, {3.635076731948104*^9, 
   3.635076732300061*^9}},
 CellLabel->
  "In[252]:=",ExpressionUUID->"ba8a16dd-33f7-403d-b707-f9fa1f3604a8"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.6215815108024893`*^9, 3.621581587942762*^9}, {
   3.621582076983382*^9, 3.621582077744697*^9}, {3.6215822251761093`*^9, 
   3.621582232135126*^9}, {3.6215822692052803`*^9, 3.621582331642846*^9}, {
   3.6215862730757217`*^9, 3.6215862764820967`*^9}, {3.6215873902510023`*^9, 
   3.621587420585464*^9}, {3.62158802734123*^9, 3.621588043418915*^9}, {
   3.621590620053122*^9, 3.621590661066156*^9}, {3.621590710569325*^9, 
   3.6215907127992897`*^9}, 3.621591761230687*^9},
 CellLabel->
  "In[253]:=",ExpressionUUID->"efa64da9-744c-4d73-893b-c7b27984937f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["SolveScatteringSystem", "Subsection",
 CellChangeTimes->{{3.598180570137664*^9, 3.598180572030218*^9}, {
   3.598180766701329*^9, 3.598180767236497*^9}, {3.59834071205519*^9, 
   3.598340713494505*^9}, 
   3.637572355754084*^9},ExpressionUUID->"f3f9d1cc-3e2c-4825-a0d7-\
29b4585b1124"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SolveScatteringSystem", "::", "usage"}], "=", 
   "\"\<Computes the system's dressed Green's function (between surface and \
bulk), plus different quantities from the leads necessary to compute \
transport and spectroscopy.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"OnlyInverseG", "::", "usage"}], "=", 
   "\"\<Option for SolveScatteringSystem that limits the computation to the \
inverse of G in the scattering region, for the purpose of obtaining an \
effective Hamiltonian\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExcludeLeadStub", "::", "usage"}], "=", 
   "\"\<Option for SolveScatteringSystem that excludes the first lead unit \
cells when returning G with OnlyInverseG\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Probes", "::", "usage"}], "=", 
    "\"\<Option for SolveScatteringSystem that denotes a set of sites in the \
scattering region, in addition to those coupled to the leads, for which to \
compute the Green's function.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "SolveScatteringSystem", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Options", "[", "SolveLead", "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"OnlyInverseG", "\[Rule]", "False"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"ExcludeLeadStub", "\[Rule]", "True"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Probes", "\[Rule]", "None"}]}], "\[IndentingNewLine]", 
      "}"}]}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SolveScatteringSystem", "[", 
    RowBox[{
     RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", 
     "scatsys_MQScatteringSystem", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
      "leadsolutions", ",", "centralsurfaces", ",", "flatcentral", ",", 
       "flatleadsurfaces", ",", "flatcentralsurface", ",", "dimcentral", ",", 
       " ", "dimsurfcentral", ",", "dimsurfleads", ",", "sourceindices", ",", 
       " ", "numleads", ",", "W", ",", "id", ",", " ", "iG0", ",", " ", "ig0",
        ",", " ", "iG", ",", "B", ",", "G", ",", " ", "projector"}], "}"}], 
     ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Build", " ", "the", " ", "linear", " ", "algebra", " ", "system", " ", 
       "of", " ", "equations", " ", "for", " ", 
       RowBox[{"G", ":", 
        RowBox[{
         RowBox[{
          RowBox[{"(", GridBox[{
             {
              RowBox[{"\[Omega]", "-", 
               SubscriptBox["H", "S"]}], 
              RowBox[{"-", 
               SubsuperscriptBox["W", "1", "\[HermitianConjugate]"]}], 
              RowBox[{"-", 
               SubsuperscriptBox["W", "2", "\[HermitianConjugate]"]}]},
             {
              RowBox[{"-", 
               SubscriptBox["W", "1"]}], 
              SubsuperscriptBox["g", 
               RowBox[{"0", ",", "1"}], 
               RowBox[{"-", "1"}]], "0"},
             {
              RowBox[{"-", 
               SubscriptBox["W", "2"]}], "0", 
              SubsuperscriptBox["g", 
               RowBox[{"0", ",", "2"}], 
               RowBox[{"-", "1"}]]}
            }], ")"}], ".", "G"}], " ", "\[Equal]", " ", "1"}]}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Note", " ", "that", " ", 
       SubsuperscriptBox["g", "0", 
        RowBox[{"-", "1"}]], " ", "are", " ", "obtained", " ", "from", " ", 
       "SolveLeads", " ", "only", " ", "on", " ", "the", " ", "surface", " ", 
       "of", " ", "the", " ", 
       RowBox[{"leads", ".", " ", "W"}], " ", "have", " ", "to", " ", "be", 
       " ", "projected", " ", "onto", " ", "said", " ", 
       RowBox[{"surface", "."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Only", " ", 
        SubscriptBox["G", 
         RowBox[{"n", ",", "m"}]]}], ",", " ", 
       RowBox[{
       "with", " ", "m", " ", "contained", " ", "within", " ", 
        "CentralSurfaces", " ", "will", " ", "be", " ", "considered", " ", 
        "in", " ", "this", " ", 
        RowBox[{"method", ".", " ", "This"}], " ", "is", " ", "enough", " ", 
        "to", " ", "compute", " ", "transport"}], ",", " ", 
       RowBox[{"although", " ", "not", " ", "LDOS"}]}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Compute", " ", "solutions", " ", "for", " ", "each", " ", "lead"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"leadsolutions", "=", 
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"SolveLead", "[", 
           RowBox[{"\[Omega]", ",", "#1", ",", "#2", ",", " ", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "[", "SolveLead", "]"}]}], "]"}]}], "]"}], 
          "&"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"scatsys", "[", "\"\<Leads\>\"", "]"}], ",", 
           RowBox[{"scatsys", "[", "\"\<SurfaceLeads\>\"", "]"}]}], "}"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"numleads", "=", 
       RowBox[{"Length", "@", "leadsolutions"}]}], ";", "\[IndentingNewLine]",
       "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "Compute", " ", "the", " ", "indices", " ", "of", " ", "the", " ", 
         "surfaces", " ", "of", " ", "each", " ", "lead"}], ",", " ", 
        RowBox[{"after", " ", "flattening"}], ",", " ", 
        RowBox[{
        "and", " ", "of", " ", "the", " ", "central", " ", "system", " ", 
         RowBox[{"(", 
          RowBox[{
          "adding", " ", "also", " ", "those", " ", "from", " ", "Probes"}], 
          ")"}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"flatleadsurfaces", "=", 
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"FlattenIndices", "[", 
           RowBox[{"#1", ",", 
            RowBox[{"#2", "[", "\"\<SiteDimensions\>\"", "]"}]}], "]"}], 
          "&"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"scatsys", "[", "\"\<SurfaceLeads\>\"", "]"}], ",", 
           RowBox[{"scatsys", "[", "\"\<Leads\>\"", "]"}]}], "}"}]}], "]"}]}],
       ";", "\[IndentingNewLine]", 
      RowBox[{"centralsurfaces", "=", 
       RowBox[{"scatsys", "[", "\"\<SurfacesCentral\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"VectorQ", "[", 
         RowBox[{
          RowBox[{"OptionValue", "[", "Probes", "]"}], ",", "IntegerQ"}], 
         "]"}], ",", 
        RowBox[{"AppendTo", "[", 
         RowBox[{"centralsurfaces", ",", 
          RowBox[{"OptionValue", "[", "Probes", "]"}]}], "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"flatcentralsurface", "=", 
       RowBox[{"FlattenIndices", "[", 
        RowBox[{
         RowBox[{"Union", "@@", "centralsurfaces"}], ",", 
         RowBox[{
          RowBox[{"scatsys", "[", "\"\<Central\>\"", "]"}], "[", 
          "\"\<SiteDimensions\>\"", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dimsurfleads", "=", 
       RowBox[{"Length", "/@", "flatleadsurfaces"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Flatten", " ", "central", " ", "system"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"flatcentral", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"scatsys", "[", "\"\<Central\>\"", "]"}], "[", 
         "\"\<Flat\>\"", "]"}], "[", "\"\<H\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dimcentral", "=", 
       RowBox[{"Length", "[", "flatcentral", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dimsurfcentral", "=", 
       RowBox[{"Length", "[", "flatcentralsurface", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "Extract", " ", "the", " ", "coupling", " ", "from", " ", "the", " ", 
         "system", " ", "to", " ", "each", " ", "lead"}], ",", " ", 
        RowBox[{
        "and", " ", "project", " ", "it", " ", "onto", " ", "the", " ", 
         RowBox[{"lead", "'"}], "s", " ", "surface", " ", "sites"}]}], "*)"}],
       "\[IndentingNewLine]", 
      RowBox[{"W", "=", 
       RowBox[{"Chop", "@", 
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"#1", "[", "\"\<Flat\>\"", "]"}], "[", "\"\<H\>\"", 
             "]"}], "[", 
            RowBox[{"[", "#2", "]"}], "]"}], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"scatsys", "[", "\"\<Couplings\>\"", "]"}], ",", 
            "flatleadsurfaces"}], "}"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"id", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1."}], ",", 
         RowBox[{"{", 
          RowBox[{"dimcentral", ",", "dimcentral"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"iG0", "=", 
       RowBox[{
        RowBox[{"\[Omega]", " ", "id"}], "-", "flatcentral"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"ig0", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"SparseArray", "@", 
          RowBox[{"#", "[", "\"\<invg\>\"", "]"}]}], "&"}], "/@", 
        "leadsolutions"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"iG", "=", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"0.", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"numleads", "+", "1"}], ",", 
           RowBox[{"numleads", "+", "1"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"iG", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "=", "iG0"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"iG", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", 
          RowBox[{"2", ";;"}]}], "]"}], "]"}], "=", 
       RowBox[{"-", 
        RowBox[{"ConjugateTranspose", "/@", "W"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"iG", "[", 
        RowBox[{"[", 
         RowBox[{
          RowBox[{"2", ";;"}], ",", "1"}], "]"}], "]"}], "=", 
       RowBox[{"-", "W"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"iG", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"i", "+", "1"}], ",", 
            RowBox[{"i", "+", "1"}]}], "]"}], "]"}], "=", 
         RowBox[{"ig0", "[", 
          RowBox[{"[", "i", "]"}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "numleads"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"OptionValue", "[", "OnlyInverseG", "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"OptionValue", "@", "ExcludeLeadStub"}], ",", " ", 
          RowBox[{"(*", 
           RowBox[{"Add", " ", "selfenergies"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"iG", "[", 
             RowBox[{"[", 
              RowBox[{"1", ",", "1"}], "]"}], "]"}], "-=", 
            RowBox[{"Total", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"#", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "\[HermitianConjugate]"}], 
                ".", 
                RowBox[{"Inverse", "[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "2", "]"}], "]"}], "]"}], ".", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "&"}], "/@", 
              RowBox[{"Transpose", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"iG", "[", 
                  RowBox[{"[", 
                   RowBox[{
                    RowBox[{"2", ";;"}], ",", "1"}], "]"}], "]"}], ",", " ", 
                 RowBox[{"Rest", "@", 
                  RowBox[{"Diagonal", "[", "iG", "]"}]}]}], "}"}], "]"}]}], 
             "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"Return", "[", 
            RowBox[{"SparseArray", "[", 
             RowBox[{"Chop", "[", 
              RowBox[{"iG", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], "]"}], "]"}]}], 
          ",", "\[IndentingNewLine]", 
          RowBox[{"Return", "[", 
           RowBox[{"SparseArray", "@", 
            RowBox[{"ArrayFlatten", "[", 
             RowBox[{"Chop", "@", "iG"}], "]"}]}], "]"}]}], "]"}]}], "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"iG", "=", 
       RowBox[{"SparseArray", "@", 
        RowBox[{"ArrayFlatten", "[", 
         RowBox[{"Chop", "@", "iG"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"B", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"flatcentralsurface", "[", 
               RowBox[{"[", "#", "]"}], "]"}], ",", "#"}], "}"}], "\[Rule]", 
            "1."}], "&"}], "/@", 
          RowBox[{"Range", "[", "dimsurfcentral", "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Length", "@", "iG"}], ",", " ", "dimsurfcentral"}], 
          "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "From", " ", "B", " ", "we", " ", "compute", " ", "a", " ", 
        "projector", " ", "between", " ", "central", " ", "surface", " ", 
        "space", " ", "and", " ", "full", " ", "central", " ", "space"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"projector", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{"B", ",", 
         RowBox[{"{", 
          RowBox[{"dimcentral", ",", "dimsurfcentral"}], "}"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"We", " ", "solve", " ", "G"}], ",", " ", 
        RowBox[{
        "and", " ", "reconstruct", " ", "the", " ", "sparsematrix", " ", 
         "Gcc", " ", "in", " ", "the", " ", "original", " ", "central", " ", 
         "space"}]}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"G", "=", 
       RowBox[{"LinearSolve", "[", 
        RowBox[{"iG", ",", "B"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"G", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"SparseArray", "[", 
           RowBox[{"G", "[", 
            RowBox[{"[", 
             RowBox[{";;", "dimcentral"}], "]"}], "]"}], "]"}], ".", 
          RowBox[{"projector", "\[Transpose]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"dimcentral", ",", "dimcentral"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MQSystemSolution", "[", 
       RowBox[{
        RowBox[{"\"\<SiteDimensions\>\"", "\[Rule]", 
         RowBox[{"scatsys", "[", "\"\<SiteDimensions\>\"", "]"}]}], ",", 
        RowBox[{"\"\<G\>\"", "\[Rule]", "G"}], ",", 
        RowBox[{"\"\<Leads\>\"", "\[Rule]", "leadsolutions"}], ",", 
        RowBox[{"\"\<CouplingsSurface\>\"", "\[Rule]", "W"}], ",", 
        RowBox[{"\"\<Nambu\>\"", "\[Rule]", 
         RowBox[{"scatsys", "[", "\"\<Nambu\>\"", "]"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "GreensFunctionSurface", "]"}], "=", 
   RowBox[{"Options", "[", "SolveScatteringSystem", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GreensFunctionSurface", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "scatsys_MQScatteringSystem",
     ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{"SolveScatteringSystem", "[", 
    RowBox[{"\[Omega]", ",", "scatsys", ",", "opts"}], "]"}], "[", 
   "\"\<G\>\"", "]"}]}]}], "Input",
 CellChangeTimes->{{3.598872548475903*^9, 3.598872563660565*^9}, {
   3.5988726632099237`*^9, 3.598872663832575*^9}, {3.598873018417653*^9, 
   3.5988730189663553`*^9}, {3.598941958657178*^9, 3.598941959136455*^9}, {
   3.599128846427709*^9, 3.59912889614482*^9}, {3.59913238300069*^9, 
   3.5991323846386967`*^9}, {3.5991324235304947`*^9, 
   3.5991325358732567`*^9}, {3.599132580142717*^9, 3.599132646291521*^9}, {
   3.599132740294837*^9, 3.599133020690277*^9}, {3.5991331208346977`*^9, 
   3.599133124010252*^9}, {3.5991332228439217`*^9, 3.599133256691834*^9}, {
   3.5991333078368893`*^9, 3.599133381556119*^9}, {3.5991334554295893`*^9, 
   3.599133458029619*^9}, {3.599133499168728*^9, 3.5991335146892023`*^9}, {
   3.5991335766120234`*^9, 3.599133771439275*^9}, {3.599133826236663*^9, 
   3.599134006815172*^9}, {3.599134039024756*^9, 3.5991341156427097`*^9}, {
   3.599134184591761*^9, 3.599134192048081*^9}, {3.5991342558973837`*^9, 
   3.599134335065001*^9}, {3.599134397611968*^9, 3.5991344774715147`*^9}, {
   3.5991345086282177`*^9, 3.5991345672042513`*^9}, {3.5991346020081577`*^9, 
   3.5991346624016523`*^9}, {3.599134741694974*^9, 3.5991349434987297`*^9}, {
   3.5991356075856047`*^9, 3.599135634725801*^9}, {3.599135702163331*^9, 
   3.5991357965718412`*^9}, {3.599135829690123*^9, 3.599135873571044*^9}, 
   3.599135904752264*^9, {3.599135994804556*^9, 3.599136075098694*^9}, {
   3.5991365077632227`*^9, 3.599136517314536*^9}, 3.599136877042354*^9, {
   3.5991369080110273`*^9, 3.599137111791039*^9}, 3.599137156988613*^9, {
   3.59913780301853*^9, 3.599137825914613*^9}, {3.5991378752404823`*^9, 
   3.599137876733577*^9}, {3.599137938026424*^9, 3.599138014699925*^9}, {
   3.599138065335188*^9, 3.599138068095265*^9}, {3.599138166822633*^9, 
   3.5991382638228903`*^9}, {3.5991383640212383`*^9, 3.59913841883212*^9}, {
   3.599138450443758*^9, 3.5991384946525593`*^9}, {3.599138525263238*^9, 
   3.5991386437806787`*^9}, {3.5991386823602467`*^9, 3.599138752477001*^9}, {
   3.599138792727203*^9, 3.599138796990445*^9}, {3.599138923625064*^9, 
   3.599138961330901*^9}, {3.599139002984934*^9, 3.599139004447937*^9}, {
   3.599197698569209*^9, 3.599197699186614*^9}, {3.599197762495097*^9, 
   3.599197813353773*^9}, {3.599215909473001*^9, 3.5992159107816877`*^9}, {
   3.6031075929067097`*^9, 3.603107599249137*^9}, {3.603107631738257*^9, 
   3.603107634832905*^9}, {3.6031798912854652`*^9, 3.603179989209518*^9}, 
   3.6031800860286093`*^9, {3.603180154274427*^9, 3.603180166968321*^9}, {
   3.603180213640786*^9, 3.6031802275739098`*^9}, {3.603185391174539*^9, 
   3.6031853923448677`*^9}, {3.603192552554611*^9, 3.603192553386414*^9}, {
   3.614752328796795*^9, 3.614752443670977*^9}, {3.614752479014957*^9, 
   3.614752527917777*^9}, {3.614753256631214*^9, 3.614753274605926*^9}, {
   3.614753349090704*^9, 3.614753396064994*^9}, {3.614753550474725*^9, 
   3.614753580321328*^9}, {3.614753767898554*^9, 3.6147537911532927`*^9}, {
   3.614754205961442*^9, 3.6147543576340857`*^9}, {3.614755475630522*^9, 
   3.6147555398103027`*^9}, 3.614755600170388*^9, {3.620411907404969*^9, 
   3.620411915948619*^9}, {3.62041213763962*^9, 3.62041214023739*^9}, {
   3.6204124051201*^9, 3.620412441230287*^9}, {3.620412509955666*^9, 
   3.620412788024413*^9}, {3.6204133993192*^9, 3.620413430657775*^9}, {
   3.6204446241489*^9, 3.620444626882642*^9}, {3.620444688720358*^9, 
   3.620444729841466*^9}, {3.620445408635508*^9, 3.62044547949247*^9}, {
   3.6204459396291513`*^9, 3.620445942786736*^9}, {3.6204460332801*^9, 
   3.620446036142075*^9}, {3.620446145582684*^9, 3.6204461481267557`*^9}, 
   3.620446808081171*^9, {3.620446949212524*^9, 3.6204469538923273`*^9}, 
   3.620446988807962*^9, {3.6204470465639153`*^9, 3.6204471066271753`*^9}, 
   3.620448001202238*^9, {3.6204487256654053`*^9, 3.6204487696493797`*^9}, {
   3.620448808462126*^9, 3.6204488214921227`*^9}, {3.620448863942377*^9, 
   3.620448906685066*^9}, {3.620448987713214*^9, 3.620449021434258*^9}, {
   3.6204490772675447`*^9, 3.620449125520318*^9}, {3.620449168200588*^9, 
   3.62044920756394*^9}, {3.620449317453409*^9, 3.620449324019659*^9}, {
   3.620449356657872*^9, 3.620449413815041*^9}, {3.620449664216168*^9, 
   3.620449678852413*^9}, {3.620450923075646*^9, 3.620451018768959*^9}, 
   3.620451757371687*^9, {3.6296418076126823`*^9, 3.629641808180889*^9}, {
   3.6352360929144793`*^9, 3.635236092918688*^9}, {3.6375723557653847`*^9, 
   3.637572355787755*^9}, {3.64100709337486*^9, 3.641007150657825*^9}, {
   3.645869285487514*^9, 3.645869384807548*^9}, {3.645869435922607*^9, 
   3.645869446838745*^9}, {3.645869624299202*^9, 3.645869711070889*^9}, {
   3.645869745067657*^9, 3.645869758207656*^9}, {3.6458698755475397`*^9, 
   3.6458699049078693`*^9}, {3.674968158594184*^9, 3.6749681609388247`*^9}, {
   3.708085532815884*^9, 3.708085536433185*^9}, 3.740208059344631*^9, {
   3.7402081696133747`*^9, 3.740208455373706*^9}, {3.740208524727064*^9, 
   3.7402085273552933`*^9}, {3.740208904113798*^9, 3.740208904930832*^9}, {
   3.740244133068981*^9, 3.740244133641452*^9}},
 CellLabel->
  "In[254]:=",ExpressionUUID->"723b05ae-81dd-4f5a-82d0-608322a0564a"],

Cell["\<\
Code to compute the dressed Green function in the leads, starting from the \
dressed G in the system\
\>", "Text",
 CellChangeTimes->{{3.613989232190757*^9, 3.6139892567407303`*^9}, {
  3.61475527735413*^9, 
  3.61475527949708*^9}},ExpressionUUID->"fb884284-ac2f-41d0-aacc-\
f95580f7e033"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"GLeads", "::", "usage"}], "=", 
    "\"\<Computes the dressed Green function in each of the leads, starting \
from the dressed G in the system\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "GLeads", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{"Options", "[", "SolveLead", "]"}], "\[IndentingNewLine]", 
     "}"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GLeads", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "scatsys_MQScatteringSystem",
     ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"sol", ",", " ", "G", ",", " ", "W", ",", "g"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"sol", "=", 
      RowBox[{"SolveScatteringSystem", "[", 
       RowBox[{"\[Omega]", ",", "scatsys", ",", " ", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "@", "SolveScatteringSystem"}]}], "]"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"G", "=", 
      RowBox[{"sol", "[", "\"\<G\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"W", "=", 
      RowBox[{"sol", "[", "\"\<CouplingsSurface\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"g", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", "\"\<gSurface\>\"", "]"}], "&"}], "/@", 
       RowBox[{"sol", "[", "\"\<Leads\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"#1", "+", 
         RowBox[{"#2", ".", "G", ".", 
          RowBox[{"#2", "\[HermitianConjugate]"}]}]}], "&"}], ",", 
       RowBox[{"{", 
        RowBox[{"g", ",", "W"}], "}"}]}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.61398926283936*^9, 3.6139892763503*^9}, {
   3.614494081541789*^9, 3.6144941081075497`*^9}, {3.6147556418757563`*^9, 
   3.614755659659568*^9}, 3.629641808810688*^9, {3.637572355794095*^9, 
   3.63757235579817*^9}, {3.664894158495762*^9, 3.6648941616429653`*^9}},
 CellLabel->
  "In[262]:=",ExpressionUUID->"11e2c631-ca90-4f72-b10c-321eebe439ae"],

Cell["\<\
Code to compute the dressed Green function in at a set of probe sites in the \
scattering region\
\>", "Text",
 CellChangeTimes->{{3.613989232190757*^9, 3.6139892567407303`*^9}, {
  3.61475527735413*^9, 
  3.614755355622036*^9}},ExpressionUUID->"952a44df-be4c-4f7f-90d6-\
5a89c0548c30"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"GreensFunction", "::", "usage"}], "=", 
    "\"\<Computes the (flattened) Green's function in the system at a set of \
sites\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "GreensFunction", "]"}], "=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{"Options", "[", "SolveLead", "]"}], "\[IndentingNewLine]", 
    "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GreensFunction", "[", 
    RowBox[{
     RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", 
     "scatsys_MQScatteringSystem", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"GreensFunction", "[", 
    RowBox[{"\[Omega]", ",", "scatsys", ",", " ", "All", ",", " ", "opts"}], 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GreensFunction", "[", 
    RowBox[{
     RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", 
     "scatsys_MQScatteringSystem", ",", " ", "All", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"GreensFunction", "[", 
    RowBox[{"\[Omega]", ",", "scatsys", ",", " ", 
     RowBox[{"Range", "[", 
      RowBox[{"1", ",", 
       RowBox[{"Length", "[", 
        RowBox[{
         RowBox[{"scatsys", "[", "\"\<Central\>\"", "]"}], "[", "\"\<H\>\"", 
         "]"}], "]"}]}], "]"}], ",", "opts"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GreensFunction", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "scatsys_MQScatteringSystem",
     ",", " ", "probes_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"G", ",", " ", "indices"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"G", "=", 
      RowBox[{
       RowBox[{"SolveScatteringSystem", "[", 
        RowBox[{"\[Omega]", ",", "scatsys", ",", 
         RowBox[{"Sequence", "@@", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Probes", "\[Rule]", "probes"}], ",", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "@", "SolveScatteringSystem"}]}], "]"}]}], 
           "}"}]}]}], "]"}], "[", "\"\<G\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"indices", "=", 
      RowBox[{"FlattenIndices", "[", 
       RowBox[{"probes", ",", 
        RowBox[{
         RowBox[{"scatsys", "[", "\"\<Central\>\"", "]"}], "[", 
         "\"\<SiteDimensions\>\"", "]"}]}], "]"}]}], ";", " ", 
     "\[IndentingNewLine]", 
     RowBox[{"G", "[", 
      RowBox[{"[", 
       RowBox[{"indices", ",", "indices"}], "]"}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.61398926283936*^9, 3.6139892763503*^9}, {
   3.614494081541789*^9, 3.6144941081075497`*^9}, {3.614755341217845*^9, 
   3.614755444444001*^9}, {3.6147555468079348`*^9, 3.614755553078792*^9}, {
   3.614755606397668*^9, 3.6147556366601753`*^9}, {3.6147556674582033`*^9, 
   3.61475570258566*^9}, {3.6147557340083942`*^9, 3.614755764944606*^9}, {
   3.614755804557836*^9, 3.614755860059868*^9}, 3.6296418093621187`*^9, {
   3.6375723558043957`*^9, 3.637572355808445*^9}, {3.638876570493017*^9, 
   3.638876583961425*^9}, {3.664895079525104*^9, 3.664895105308763*^9}, {
   3.6648951913465557`*^9, 3.664895191719757*^9}, {3.708085546103756*^9, 
   3.708085601420781*^9}, {3.708085803755731*^9, 3.7080858063539143`*^9}},
 CellLabel->
  "In[265]:=",ExpressionUUID->"b49dfcdc-6087-406c-90d1-f16dd0b9f6f4"],

Cell[TextData[{
 "Effective Hamiltonian ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["H", "eff"], "=", 
    RowBox[{"\[Omega]", "-", 
     SuperscriptBox["G", 
      RowBox[{"-", "1"}]]}]}], TraditionalForm]],ExpressionUUID->
  "8e47127c-ee9f-47e0-98d3-e02794e22555"]
}], "Text",
 CellChangeTimes->{{3.6259104739195013`*^9, 
  3.625910483908534*^9}},ExpressionUUID->"3ba059ba-06f4-4174-a033-\
90e5fbcb331d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "EffectiveHamiltonian", "]"}], "=", 
   RowBox[{"Options", "[", "SolveScatteringSystem", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"EffectiveHamiltonian", "[", 
   RowBox[{"\[Omega]_", ",", "scatsys_MQScatteringSystem", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"\[Omega]", " ", 
      RowBox[{"SparseArray", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
        RowBox[{"Dimensions", "@", "#"}]}], "]"}]}], "-", "#"}], "&"}], "@", 
   RowBox[{"SolveScatteringSystem", "[", 
    RowBox[{"\[Omega]", ",", "scatsys", ",", 
     RowBox[{"OnlyInverseG", "\[Rule]", "True"}], ",", " ", "opts"}], 
    "]"}]}]}]}], "Input",
 CellChangeTimes->{
  3.629641809898004*^9, {3.637572205235983*^9, 3.637572229538982*^9}, 
   3.6375723555153227`*^9, {3.6458694915686493`*^9, 3.6458695175529947`*^9}, {
   3.6458696006928053`*^9, 3.6458696013580713`*^9}, {3.64586992138057*^9, 
   3.645869921984893*^9}},
 CellLabel->
  "In[270]:=",ExpressionUUID->"a858eade-84f4-4cd8-a216-d2d8cea4c6b0"],

Cell[TextData[{
 "Code to find possible states confined to the central region around a \
certain frequency. It is based on the effective ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["H", "eff"], "=", 
    RowBox[{"\[Omega]", "-", 
     SuperscriptBox["G", 
      RowBox[{"-", "1"}]]}]}], TraditionalForm]],ExpressionUUID->
  "89192edb-0f68-40f1-bb3a-e05446315363"]
}], "Text",
 CellChangeTimes->{{3.59887273586959*^9, 3.598872769155703*^9}, {
  3.598941975384005*^9, 
  3.598941999072885*^9}},ExpressionUUID->"76c4fdc0-e0b2-4bd0-8ae9-\
3dda9ed91817"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"NumberOfStates", "::", "usage"}], "=", 
   "\"\<Option for FindBoundStateCandidates that specifies how many bound \
states to look for.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FindBoundStateCandidates", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{"NumberOfStates", "\[Rule]", "1"}], "\[IndentingNewLine]", 
     "}"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FindBoundStateCandidates", "[", 
    RowBox[{
     RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", 
     "scatsys_MQScatteringSystem", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "Heff", ",", "dHeff", ",", " ", "id", ",", " ", "\[Omega]shift", ",", 
       RowBox[{"n", "=", 
        RowBox[{"OptionValue", "[", "NumberOfStates", "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
        RowBox[{
        "The", " ", "idea", " ", "is", " ", "that", " ", "bound", " ", 
         "states", " ", "of", " ", "energy", " ", "\[Omega]", " ", 
         "correspond", " ", "to", " ", "singular", " ", "invG", 
         RowBox[{"(", "\[Omega]", ")"}]}], "=", 
        RowBox[{"\[Omega]", "-", 
         RowBox[{"Heff", 
          RowBox[{
           RowBox[{"(", "\[Omega]", ")"}], ".", " ", "If"}], " ", "we", " ", 
          "evaluate", " ", "Heff", 
          RowBox[{"(", "\[Omega]", ")"}], " ", "at", " ", "an", " ", 
          "estimate", " ", "solution", " ", "\[Omega]0"}]}]}], ",", " ", 
       RowBox[{
        RowBox[{"these", " ", 
         RowBox[{"\[Omega]", "'"}], "s", " ", "are", " ", "solutions", " ", 
         "of", " ", "Heff", 
         RowBox[{"(", "\[Omega]0", ")"}], "\[Psi]"}], "=", 
        RowBox[{"\[Omega]", " ", "\[Psi]"}]}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Heff", "=", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"SparseArray", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"{", 
               RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
             RowBox[{"Dimensions", "@", "#"}]}], "]"}], " ", "\[Omega]"}], 
          "-", "#"}], "&"}], "@", 
        RowBox[{"SolveScatteringSystem", "[", 
         RowBox[{"\[Omega]", ",", "scatsys", ",", 
          RowBox[{"OnlyInverseG", "\[Rule]", "True"}], ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", 
            RowBox[{"Options", "[", "SolveScatteringSystem", "]"}]}], "]"}]}],
          "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"id", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
         RowBox[{"Dimensions", "@", "Heff"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"We", " ", "shift", " ", "Heff", " ", "by", " ", "\[Omega]", 
         RowBox[{"(", 
          RowBox[{"id", "-", "dHeff"}], ")"}]}], ",", " ", 
        RowBox[{
        "so", " ", "that", " ", "eigenvalues", " ", "close", " ", "to", " ", 
         "\[Omega]"}], ",", " ", 
        RowBox[{"are", " ", "now", " ", "close", " ", "to", " ", 
         RowBox[{"zero", ".", " ", "We"}], " ", "select", " ", "the", " ", 
         "one", " ", "closest", " ", "to", " ", "zero"}], ",", " ", 
        RowBox[{
        "and", " ", "shift", " ", "it", " ", "back", " ", "up", " ", "by", 
         " ", "\[Omega]"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"\[Omega]shift", "=", "\[Omega]"}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"\[Omega]shift", "+", 
       RowBox[{"Sort", "[", 
        RowBox[{
         RowBox[{"Eigenvalues", "[", 
          RowBox[{
           RowBox[{"Heff", " ", "-", " ", 
            RowBox[{"id", " ", "\[Omega]shift"}]}], ",", 
           RowBox[{"-", "n"}]}], "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Abs", "[", "#1", "]"}], "<", 
           RowBox[{"Abs", "[", "#2", "]"}]}], "&"}]}], "]"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FindBoundStates", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Options", "[", "FindBoundStateCandidates", "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"MaxIterations", "\[Rule]", "15"}]}], "\[IndentingNewLine]", 
     "}"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FindBoundStates", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "scatsys_MQScatteringSystem",
     ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"NestWhile", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"FindBoundStateCandidates", "[", 
      RowBox[{
       RowBox[{"First", "@", 
        RowBox[{"Re", "@", "#"}]}], ",", "scatsys", ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "[", "FindBoundStateCandidates", "]"}]}], "]"}]}],
       "]"}], "&"}], ",", 
    RowBox[{"{", "\[Omega]", "}"}], ",", 
    RowBox[{
     RowBox[{"!", 
      RowBox[{
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"First", "[", "#1", "]"}], "-", 
         RowBox[{"First", "[", "#2", "]"}]}], "]"}], "\[Equal]", "0"}]}], 
     "&"}], ",", "2", ",", 
    RowBox[{"OptionValue", "[", "MaxIterations", "]"}]}], 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.598872776911848*^9, 3.598873013944124*^9}, {
   3.598873086340983*^9, 3.598873186831067*^9}, {3.598873251419694*^9, 
   3.598873445563114*^9}, {3.598873500391695*^9, 3.598873600199882*^9}, {
   3.598873662393003*^9, 3.5988736956218443`*^9}, {3.598873726615637*^9, 
   3.598873730325313*^9}, {3.5988738150837*^9, 3.5988738928367453`*^9}, 
   3.598873941852519*^9, {3.598874055539115*^9, 3.598874063526883*^9}, {
   3.5988740948556843`*^9, 3.5988741179476557`*^9}, {3.598874205711755*^9, 
   3.5988742154582*^9}, {3.598874277888071*^9, 3.59887432980982*^9}, {
   3.598874403446018*^9, 3.598874445863922*^9}, {3.598874655761149*^9, 
   3.5988746582061234`*^9}, {3.59887470535957*^9, 3.5988747483059998`*^9}, 
   3.598874789669443*^9, {3.598874905139885*^9, 3.598874914061708*^9}, {
   3.5988753076101418`*^9, 3.598875475630767*^9}, 3.5988756370391903`*^9, {
   3.598875699446739*^9, 3.59887573359662*^9}, 3.598875897475176*^9, {
   3.598875936846064*^9, 3.598875939735364*^9}, {3.598875980448921*^9, 
   3.598875995758327*^9}, {3.5988760804635*^9, 3.598876082046053*^9}, {
   3.598942023096806*^9, 3.598942045038068*^9}, 3.5989421731296053`*^9, {
   3.598973915923712*^9, 3.598973916426403*^9}, {3.598973995160651*^9, 
   3.5989739972700644`*^9}, {3.5989740917758007`*^9, 
   3.5989741786668663`*^9}, {3.598974344897072*^9, 3.598974556513159*^9}, 
   3.598974595058288*^9, {3.599138244132503*^9, 3.599138244479309*^9}, 
   3.5991977399586287`*^9, {3.5992195414751263`*^9, 3.599219543201323*^9}, {
   3.614752554020339*^9, 3.614752646853054*^9}, {3.614752691813216*^9, 
   3.6147526998529997`*^9}, {3.615188056540401*^9, 3.615188056788026*^9}, {
   3.629641810610962*^9, 3.629641811170513*^9}, {3.6375723555218267`*^9, 
   3.637572355528639*^9}, 3.740207694932766*^9},
 CellLabel->
  "In[272]:=",ExpressionUUID->"e9966499-d622-4d1a-b78d-82aad736f544"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spectral observables", "Subsection",
 CellChangeTimes->{{3.5983510928154984`*^9, 
  3.598351099238624*^9}},ExpressionUUID->"761434bf-e162-4044-89ac-\
59519a9762cf"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "LeadLDOS", "]"}], "=", 
   RowBox[{"Options", "[", "SolveLead", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LeadLDOS", "[", 
    RowBox[{
     RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "lead_MQSystem", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"sol", "=", 
       RowBox[{"SolveLead", "[", 
        RowBox[{"\[Omega]", ",", "lead", ",", 
         RowBox[{"IncludeExtraData", "\[Rule]", "True"}], ",", " ", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", 
           RowBox[{"Options", "[", "LeadLDOS", "]"}]}], "]"}]}], "]"}]}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"sol", "[", "\"\<ExtraData\>\"", "]"}], "===", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{"{", "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"lead", "[", "\"\<NumberOfSites\>\"", "]"}], ",", 
           RowBox[{"lead", "[", "\"\<SiteDimensions\>\"", "]"}]}], "}"}]}], 
        "]"}], ",", 
       RowBox[{"\"\<ldos\>\"", "/.", 
        RowBox[{"sol", "[", "\"\<ExtraData\>\"", "]"}]}]}], "]"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "PlotLeadLDOS", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Options", "[", "PlotField", "]"}], ",", 
      RowBox[{"Options", "[", "LeadLDOS", "]"}]}], "}"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotLeadLDOS", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "lattice_MQLattice", ",", 
    "lead_MQSystem", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"PlotField", "[", 
   RowBox[{"lattice", ",", 
    RowBox[{"Normal", "@", 
     RowBox[{"LeadLDOS", "[", 
      RowBox[{"\[Omega]", ",", "lead", ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "[", "LeadLDOS", "]"}]}], "]"}]}], "]"}]}], ",", 
    " ", 
    RowBox[{"FilterRules", "[", 
     RowBox[{
      RowBox[{"{", "opts", "}"}], ",", 
      RowBox[{"Options", "[", "PlotField", "]"}]}], "]"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.621591811684787*^9, 3.621591822443542*^9}, {
  3.621591855745723*^9, 3.621591874255129*^9}, {3.621592908724722*^9, 
  3.621592909117981*^9}, {3.6215936938224173`*^9, 3.621593709733582*^9}, {
  3.629641811666679*^9, 3.629641812714376*^9}},
 CellLabel->
  "In[277]:=",ExpressionUUID->"5b4245f3-403e-430a-b864-95b9e3df7234"],

Cell[BoxData[
 RowBox[{"Clear", "[", "Spectrum", "]"}]], "Input",
 CellChangeTimes->{{3.5983600707538157`*^9, 3.598360071762353*^9}},
 CellLabel->
  "In[281]:=",ExpressionUUID->"cfce9658-5cb8-4e6c-855c-2f38619f91b2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Spectrum", "::", "numeric"}], "=", 
   "\"\<By default, only the spectrum of numeric systems are computed. Use \
option OnlyNumeric->False to attempt an analytical soliution.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"OnlyNumeric", "::", "usage"}], "=", 
   "\"\<Option for Spectrum that disables symbolic evaluation of the \
spectrum, True by default.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Levels", "::", "usage"}], "=", 
   "\"\<Option for Spectrum that specifies the number of levels to compute, \
counting from the ones closest to zero.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"EnergyOrigin", "::", "usage"}], "=", 
   "\"\<Option for Spectrum that specifies the energy around which the \
requested levels will be computed\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PrintEigenvalues", "::", "usage"}], "=", 
   "\"\<Option for Eigenstates that specifies whether Eigenvalues should be \
reported.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ReturnEigenvalues", "::", "usage"}], "=", 
   "\"\<Option for Eigenstates that specifies whether Eigenvalues should be \
returned (like in Eigensystem).\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FlattenEigenstates", "::", "usage"}], "=", 
   "\"\<Option for Eigenstates that specifies whether to return each \
eigenstate as a flat list, or preserve orbital structure\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"OrbitalFunction", "::", "usage"}], "=", 
   "\"\<Option for Eigenstates that specifies a function to be applied to \
each orbital subspace of each site\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SiteDimensions", "::", "usage"}], "=", 
    "\"\<Option for Eigenstates that specifies the number of orbitals per \
site\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Spectrum", "::", "levels"}], "=", 
   "\"\<Warning: you asked for `1` levels, and the maximum is `2`. Truncating \
to `2` levels.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Eigenstates", "::", "levels"}], "=", 
    "\"\<Warning: you asked for `1` levels, and the maximum is `2`. \
Truncating to `2` levels.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "Spectrum", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"OnlyNumeric", "\[Rule]", "True"}], ",", " ", 
     RowBox[{"Levels", "\[Rule]", "All"}], ",", 
     RowBox[{"EnergyOrigin", "\[Rule]", "0"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Spectrum", "[", 
   RowBox[{"system_MQSystem", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Spectrum", "[", 
   RowBox[{
    RowBox[{"system", "[", "\"\<H\>\"", "]"}], ",", "opts"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Spectrum", "[", 
    RowBox[{
     RowBox[{"H_", "?", "ArrayQ"}], ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"levels", "=", 
        RowBox[{"OptionValue", "[", "Levels", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"origin", "=", 
        RowBox[{"OptionValue", "[", "EnergyOrigin", "]"}]}], ",", 
       "\[IndentingNewLine]", "h"}], "}"}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "@", 
          RowBox[{"Dimensions", "@", "H"}]}], ">", "2"}], ",", 
        RowBox[{"h", "=", 
         RowBox[{"ArrayFlatten", "[", "H", "]"}]}], ",", " ", 
        RowBox[{"h", "=", "H"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"levels", ">", 
         RowBox[{"Length", "@", "h"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"Spectrum", "::", "levels"}], ",", "levels", ",", 
           RowBox[{"Length", "[", "h", "]"}]}], "]"}], ";", 
         RowBox[{"levels", "=", 
          RowBox[{
           RowBox[{"Sign", "[", "levels", "]"}], 
           RowBox[{"Min", "[", 
            RowBox[{
             RowBox[{"Abs", "[", "levels", "]"}], ",", 
             RowBox[{"Length", "[", "h", "]"}]}], "]"}]}]}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "OnlyNumeric", "]"}], "&&", 
         RowBox[{"!", 
          RowBox[{"MatrixQ", "[", 
           RowBox[{"h", ",", " ", "NumericQ"}], "]"}]}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"Spectrum", "::", "numeric"}], "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"levels", "===", "All"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Sort", "@", 
         RowBox[{"Chop", "@", 
          RowBox[{"Quiet", "@", 
           RowBox[{"Eigenvalues", "[", "h", "]"}]}]}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"origin", "+", 
         RowBox[{"Sort", "@", 
          RowBox[{"Chop", "@", 
           RowBox[{"Eigenvalues", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"#", "-", 
                RowBox[{"origin", " ", 
                 RowBox[{"SparseArray", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
                   RowBox[{"Dimensions", "@", "#"}]}], "]"}]}]}], "&"}], "@", 
              "h"}], ",", 
             RowBox[{"-", "levels"}]}], "]"}]}]}]}]}], "]"}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "Eigenstates", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"OnlyNumeric", "\[Rule]", "True"}], ",", " ", 
     RowBox[{"Levels", "\[Rule]", "1"}], ",", 
     RowBox[{"EnergyOrigin", "\[Rule]", "0"}], ",", " ", 
     RowBox[{"PrintEigenvalues", "\[Rule]", "False"}], ",", " ", 
     RowBox[{"ReturnEigenvalues", "\[Rule]", "False"}], ",", " ", 
     RowBox[{"FlattenEigenstates", "\[Rule]", "False"}], ",", " ", 
     RowBox[{"OrbitalFunction", "\[Rule]", 
      RowBox[{"(", 
       RowBox[{"#", "&"}], ")"}]}], ",", " ", 
     RowBox[{"SiteDimensions", "\[Rule]", "Automatic"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Eigenstates", "[", 
   RowBox[{"system_MQSystem", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Eigenstates", "[", 
   RowBox[{
    RowBox[{"system", "[", "\"\<H\>\"", "]"}], ",", 
    RowBox[{"SiteDimensions", "->", 
     RowBox[{"system", "[", "\"\<SiteDimensions\>\"", "]"}]}], ",", "opts"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Eigenstates", "[", 
   RowBox[{
    RowBox[{"H_", "?", "ArrayQ"}], ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"levels", "=", 
       RowBox[{"OptionValue", "[", "Levels", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"origin", "=", 
       RowBox[{"OptionValue", "[", "EnergyOrigin", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"orbfunction", "=", 
       RowBox[{"OptionValue", "@", "OrbitalFunction"}]}], ",", 
      "\[IndentingNewLine]", "dimsites", ",", "\[IndentingNewLine]", "h", ",",
       "esys"}], "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "SiteDimensions", "]"}], "===", 
        "Automatic"}], ",", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "@", 
           RowBox[{"Dimensions", "@", "H"}]}], "\[Equal]", "4"}], ",", 
         RowBox[{"dimsites", "=", 
          RowBox[{"Last", "@", 
           RowBox[{"Dimensions", "@", "H"}]}]}], ",", 
         RowBox[{"dimsites", "=", "1"}]}], "]"}], ",", 
       RowBox[{"dimsites", "=", 
        RowBox[{"OptionValue", "[", "SiteDimensions", "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"dimsites", ">", "1"}], ",", 
       RowBox[{"h", "=", 
        RowBox[{"ArrayFlatten", "[", "H", "]"}]}], ",", 
       RowBox[{"h", "=", "H"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"levels", ">", 
        RowBox[{"Length", "@", "h"}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"Eigenstates", "::", "levels"}], ",", "levels", ",", 
          RowBox[{"Length", "[", "h", "]"}]}], "]"}], ";", 
        RowBox[{"levels", "=", 
         RowBox[{
          RowBox[{"Sign", "[", "levels", "]"}], 
          RowBox[{"Min", "[", 
           RowBox[{
            RowBox[{"Abs", "[", "levels", "]"}], ",", 
            RowBox[{"Length", "[", "h", "]"}]}], "]"}]}]}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "[", "OnlyNumeric", "]"}], "&&", 
        RowBox[{"!", 
         RowBox[{"MatrixQ", "[", 
          RowBox[{"h", ",", " ", "NumericQ"}], "]"}]}]}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"Spectrum", "::", "numeric"}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"esys", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"levels", "===", "All"}], ",", 
        RowBox[{"Transpose", "@", 
         RowBox[{"Sort", "@", 
          RowBox[{"Transpose", "@", 
           RowBox[{"Quiet", "@", 
            RowBox[{"EigensystemFixedPhase", "[", "h", "]"}]}]}]}]}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "+", "origin"}], ",", 
            RowBox[{"#", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], "}"}], "&"}], "@", 
         RowBox[{"Transpose", "@", 
          RowBox[{"Sort", "@", 
           RowBox[{"Transpose", "@", 
            RowBox[{"EigensystemFixedPhase", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"#", "-", 
                 RowBox[{"origin", " ", 
                  RowBox[{"SparseArray", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], ",", 
                    RowBox[{"Dimensions", "@", "#"}]}], "]"}]}]}], "&"}], "@",
                "h"}], ",", 
              RowBox[{"-", "levels"}]}], "]"}]}]}]}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "[", "PrintEigenvalues", "]"}], ",", 
       RowBox[{"Print", "[", 
        RowBox[{"First", "@", "esys"}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"OptionValue", "[", "FlattenEigenstates", "]"}]}], ",", 
       RowBox[{"esys", "=", 
        RowBox[{"MapAt", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"#", ",", "dimsites"}], "]"}], "&"}], ",", "esys", ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "All"}], "}"}]}], "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"esys", "=", 
      RowBox[{"MapAt", "[", 
       RowBox[{"orbfunction", ",", "esys", ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "All", ",", "All"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"OptionValue", "@", "ReturnEigenvalues"}]}], ",", 
       RowBox[{"esys", "=", 
        RowBox[{"Last", "@", "esys"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "esys"}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.598351102773266*^9, 3.598351425119252*^9}, {
   3.598351509941736*^9, 3.598351593027761*^9}, {3.598359624206558*^9, 
   3.598359969536838*^9}, {3.598360117363336*^9, 3.598360119122519*^9}, {
   3.5983601970804253`*^9, 3.598360226840773*^9}, {3.598360293285269*^9, 
   3.598360293940798*^9}, {3.598360456119278*^9, 3.598360550420046*^9}, {
   3.5983782125843678`*^9, 3.59837840703179*^9}, 3.5983785801880493`*^9, {
   3.598379900197135*^9, 3.59837994244528*^9}, {3.5983799749224977`*^9, 
   3.5983799774501123`*^9}, {3.598380313928391*^9, 3.598380323064006*^9}, {
   3.5985993383138037`*^9, 3.5985993718164053`*^9}, {3.598599462147675*^9, 
   3.59859949791265*^9}, {3.598599548378654*^9, 3.5985995510955553`*^9}, {
   3.5985995850008574`*^9, 3.5985996371921988`*^9}, {3.598599887543707*^9, 
   3.598599948170287*^9}, {3.598600264590405*^9, 3.598600266641315*^9}, {
   3.598600317737389*^9, 3.5986003596728086`*^9}, {3.598618717054491*^9, 
   3.5986187187373734`*^9}, {3.598618751612953*^9, 3.59861875183615*^9}, {
   3.598618805738331*^9, 3.598618809116825*^9}, {3.598618855633582*^9, 
   3.5986188582944193`*^9}, {3.598711357207602*^9, 3.5987113617405777`*^9}, {
   3.60258406031147*^9, 3.6025842155324917`*^9}, {3.602927833810145*^9, 
   3.60292792819807*^9}, {3.6029279679874763`*^9, 3.6029280062508793`*^9}, {
   3.602928353878708*^9, 3.602928406767951*^9}, {3.6029302586299543`*^9, 
   3.602930279211115*^9}, 3.602930319387396*^9, {3.602930351071332*^9, 
   3.6029303519741793`*^9}, {3.6029303962288523`*^9, 3.602930396475377*^9}, {
   3.603108515049087*^9, 3.603108536826025*^9}, {3.612595019672592*^9, 
   3.612595096643331*^9}, {3.620018502147303*^9, 3.620018541240518*^9}, {
   3.6200189706122913`*^9, 3.620019102691596*^9}, {3.62019492842705*^9, 
   3.620194930051021*^9}, 3.6231477871090097`*^9, {3.623148199632469*^9, 
   3.623148374551888*^9}, {3.6272002166307297`*^9, 3.627200220731003*^9}, {
   3.629641813203002*^9, 3.629641814274684*^9}, {3.635236092936171*^9, 
   3.635236092939308*^9}, {3.635753928383109*^9, 3.6357540881901493`*^9}, {
   3.637575107199951*^9, 3.6375751219538507`*^9}, {3.637575158728654*^9, 
   3.637575238187799*^9}, {3.6375752721078568`*^9, 3.637575390668462*^9}, {
   3.637575446084743*^9, 3.637575494335637*^9}, {3.637575586341696*^9, 
   3.6375756384104567`*^9}, {3.637575669799653*^9, 3.637575704460615*^9}, {
   3.6375760099825172`*^9, 3.637576099743909*^9}, {3.639824772926175*^9, 
   3.6398247960374804`*^9}, {3.639824848954973*^9, 3.6398248855767717`*^9}, {
   3.639824918006707*^9, 3.6398249929624968`*^9}, {3.639825342409204*^9, 
   3.639825345584106*^9}, 3.639825384422442*^9, {3.639825417470037*^9, 
   3.63982551669599*^9}, {3.665907308343631*^9, 3.6659076541824713`*^9}, {
   3.66590770318353*^9, 3.66590775004611*^9}, {3.66590779036898*^9, 
   3.665907794746616*^9}, {3.665907826660256*^9, 3.665907847289153*^9}, {
   3.6659079423932257`*^9, 3.6659079858585167`*^9}, {3.667107022872797*^9, 
   3.667107026534449*^9}, {3.667127814980303*^9, 3.6671278229929113`*^9}, {
   3.752150632211171*^9, 3.752150640539886*^9}},
 CellLabel->
  "In[282]:=",ExpressionUUID->"bbce31dc-94dc-42d9-a4aa-db39772575ad"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "Bands", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Options", "[", "Spectrum", "]"}], ",", 
      RowBox[{"Options", "[", "Sample", "]"}]}], "}"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Attributes", "[", "Bands", "]"}], "=", 
    RowBox[{"{", "HoldAll", "}"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"This", " ", "commented"}], "-", 
     RowBox[{"out", " ", "version", " ", "is", " ", "faster"}]}], ",", " ", 
    RowBox[{
    "but", " ", "collapses", " ", "for", " ", "large", " ", "systems"}], ",", 
    " ", 
    RowBox[{"as", " ", "it", " ", "preevaluates", " ", 
     RowBox[{"sys", "[", "z", "]"}], " ", "symbolically", " ", "for", " ", 
     "arbitrary", " ", "Bloch", " ", "phase"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Bands", "[", 
     RowBox[{"system_", ",", "interval__List", ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"sys", "=", "system"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{"Thread", "/@", "#"}], "]"}], "&"}], "@", 
       RowBox[{"Sample", "[", 
        RowBox[{
         RowBox[{"Spectrum", "[", 
          RowBox[{"sys", ",", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", 
             RowBox[{"Options", "[", "Spectrum", "]"}]}], "]"}]}], "]"}], ",",
          "interval", ",", 
         RowBox[{"Evaluate", "@", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"SamplingFunction", "\[Rule]", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Total", "[", 
                RowBox[{"Abs", "[", "#", "]"}], "]"}], "&"}], ")"}]}], ",", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "[", "Sample", "]"}]}], "]"}]}], "}"}]}]}], 
        "]"}]}]}], "]"}]}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Bands", "[", 
    RowBox[{"system_", ",", "interval__List", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"Transpose", "[", 
      RowBox[{"Thread", "/@", "#"}], "]"}], "&"}], "@", 
    RowBox[{"Sample", "[", 
     RowBox[{
      RowBox[{"Spectrum", "[", 
       RowBox[{"system", ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "[", "Spectrum", "]"}]}], "]"}]}], "]"}], ",", 
      "interval", ",", 
      RowBox[{"Evaluate", "@", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"SamplingFunction", "\[Rule]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Total", "[", 
             RowBox[{"Abs", "[", "#", "]"}], "]"}], "&"}], ")"}]}], ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", 
           RowBox[{"Options", "[", "Sample", "]"}]}], "]"}]}], "}"}]}]}], 
     "]"}]}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "PlotBands", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{"Options", "[", "ListLinePlot", "]"}], "}"}]}], ";", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"PlotBands", "[", 
      RowBox[{"spectrum_List", ",", 
       RowBox[{"opts", ":", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
     RowBox[{"ListLinePlot", "[", 
      RowBox[{"spectrum", ",", " ", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", 
         RowBox[{"Options", "[", "ListLinePlot", "]"}]}], "]"}], ",", 
       "PlotDefaults"}], "]"}]}]}], "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ObservableToStyle", "::", "usage"}], "=", 
   "\"\<Option for PlotBands that specifies a function mapping an observable \
of an eigenstate (produced optionally by Bands or UntangledBands for each \
point in the spectrum with option EigenstateObervable) to a plotting style \
directive, such as a color or thickness.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "PlotBands", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ObservableToStyle", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{"Automatic", "&"}], ")"}]}], ",", 
      RowBox[{"Options", "[", "ListLinePlot", "]"}], ",", " ", 
      RowBox[{"Options", "[", "ListPlot3D", "]"}]}], "}"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotBands", "[", 
   RowBox[{"spectrum_List", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"And", "@@", 
     RowBox[{"MatrixQ", "/@", "spectrum"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{
      "If", " ", "spectrum", " ", "has", " ", "a", " ", "third", " ", 
       "component", " ", "to", " ", "each", " ", "entry"}], ",", " ", 
      RowBox[{
      "it", " ", "is", " ", "an", " ", "EigenstateObservable", " ", 
       "produced", " ", "by", " ", "UntangledBands", " ", "or", " ", 
       RowBox[{"Bands", ".", " ", "Use"}], " ", "it", " ", "for", " ", 
       "coloring"}]}], "*)"}], "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Last", "@", 
        RowBox[{"Dimensions", "[", "spectrum", "]"}]}], "\[Equal]", "3"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{"ListPlot3D", "[", 
       RowBox[{"spectrum", ",", " ", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "ListPlot3D", "]"}]}], "]"}], ",", 
        "PlotDefaults"}], "]"}], ",", "\[IndentingNewLine]", 
      RowBox[{"ListLinePlot", "[", 
       RowBox[{"spectrum", ",", " ", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", 
          RowBox[{"Options", "[", "ListLinePlot", "]"}]}], "]"}], ",", 
        "PlotDefaults"}], "]"}]}], "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"data", "=", 
         RowBox[{"Select", "[", 
          RowBox[{
           RowBox[{"MapAt", "[", 
            RowBox[{"First", ",", "spectrum", ",", 
             RowBox[{"{", 
              RowBox[{"All", ",", "All", ",", "2"}], "}"}]}], "]"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "@", "#"}], ">", "1"}], "&"}]}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"obs", "=", 
         RowBox[{"Select", "[", 
          RowBox[{
           RowBox[{"MapAt", "[", 
            RowBox[{"Last", ",", "spectrum", ",", 
             RowBox[{"{", 
              RowBox[{"All", ",", "All", ",", "2"}], "}"}]}], "]"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "@", "#"}], ">", "1"}], "&"}]}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"obstostyle", "=", 
         RowBox[{"OptionValue", "@", "ObservableToStyle"}]}], ",", 
        "\[IndentingNewLine]", "obsint", ",", " ", "plts", ",", " ", "oi"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"obsint", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"Interpolation", "[", 
           RowBox[{"#", ",", 
            RowBox[{"InterpolationOrder", "\[Rule]", "1"}]}], "]"}], "&"}], "/@",
          "obs"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"oi", "[", 
         RowBox[{"x_If", ",", "y_If"}], "]"}], ":=", 
        RowBox[{"oi", "[", 
         RowBox[{
          RowBox[{"x", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", 
          RowBox[{"y", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", " ", 
       RowBox[{"(*", 
        RowBox[{"Work", " ", "around", " ", "bug", " ", "in", " ", "Mma"}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"plts", "=", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"oi", "[", 
             RowBox[{"x_", ",", "y_"}], "]"}], ":=", 
            RowBox[{"obstostyle", "[", 
             RowBox[{
              RowBox[{"obsint", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "[", "x", "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"ListLinePlot", "[", 
            RowBox[{
             RowBox[{"data", "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", 
             RowBox[{"ColorFunction", "\[Rule]", "oi"}], ",", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", "opts", "}"}], ",", " ", 
               RowBox[{"Options", "[", "ListLinePlot", "]"}]}], "]"}], ",", 
             RowBox[{"ColorFunctionScaling", "\[Rule]", "None"}], ",", 
             "PlotDefaults"}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", " ", 
            RowBox[{"Length", "[", "data", "]"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Show", "[", "plts", "]"}]}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"It", "'"}], "s", " ", "not", " ", "possible", " ", "to", " ", 
    "use", " ", "multiple", " ", "ColorFunction", " ", "options", " ", 
    "within", " ", "one", " ", "ListLinePlot", " ", 
    RowBox[{"call", ".", " ", "We"}], " ", "must", " ", "combine", " ", 
    RowBox[{"plots", "."}]}], "*)"}]}]}], "Input",
 CellChangeTimes->{{3.604644828811564*^9, 3.604644845450151*^9}, 
   3.619966059405566*^9, {3.633086379508731*^9, 3.633086505018907*^9}, {
   3.633086556393902*^9, 3.63308656601772*^9}, {3.633086887640587*^9, 
   3.633086901847048*^9}, {3.633087053750692*^9, 3.633087108833411*^9}, {
   3.633087225587738*^9, 3.633087307051306*^9}, {3.633087658404614*^9, 
   3.633087659313895*^9}, {3.63308773069352*^9, 3.633087861920635*^9}, 
   3.63308838892548*^9, {3.633088491602029*^9, 3.6330885005302353`*^9}, {
   3.633088660768919*^9, 3.633088679434018*^9}, {3.633088785299438*^9, 
   3.6330887925622377`*^9}, {3.633088831787315*^9, 3.633088987456346*^9}, {
   3.633089745396254*^9, 3.633089803649399*^9}, {3.633089842011759*^9, 
   3.633089894421246*^9}, {3.633090197030195*^9, 3.63309027054235*^9}, {
   3.6330903294248447`*^9, 3.633090391699915*^9}, {3.6330904260451117`*^9, 
   3.633090531909442*^9}, {3.6331706537713633`*^9, 3.6331706618808413`*^9}, {
   3.6664266213652897`*^9, 3.666426621608111*^9}, 3.666949224306428*^9, {
   3.666949424694495*^9, 3.666949443354895*^9}, {3.6669501911920147`*^9, 
   3.66695024166784*^9}, {3.667121138711142*^9, 3.667121167986115*^9}, {
   3.6671257760663137`*^9, 3.667125786234708*^9}, {3.667130935261169*^9, 
   3.667130945029381*^9}, {3.667131404109981*^9, 3.667131442881938*^9}, {
   3.707835155350885*^9, 3.707835155723302*^9}, {3.7078352044034023`*^9, 
   3.707835208122127*^9}, {3.707835239970347*^9, 3.707835344606853*^9}, {
   3.713607885250043*^9, 3.713607921122555*^9}, 3.713678283673978*^9, {
   3.800946418703639*^9, 3.8009464764060287`*^9}, {3.8009465433611097`*^9, 
   3.800946547168442*^9}, {3.8009466549846897`*^9, 3.8009466709151506`*^9}, {
   3.800946714853827*^9, 3.800946735569579*^9}, {3.8009467827006807`*^9, 
   3.80094678488286*^9}, {3.800946932139119*^9, 3.800946952499082*^9}, {
   3.800947013091968*^9, 3.800947107836375*^9}, {3.8009471416586323`*^9, 
   3.800947186409835*^9}, {3.800947247220213*^9, 3.800947477656362*^9}, {
   3.8009475573619013`*^9, 3.80094763790695*^9}, {3.800947682600197*^9, 
   3.800947869993778*^9}, {3.80094790088976*^9, 3.8009479015787573`*^9}, {
   3.800947945547665*^9, 3.800947954675501*^9}, {3.800947994333954*^9, 
   3.800948086241949*^9}, {3.800948124203466*^9, 3.800948157186988*^9}},
 CellLabel->"In[59]:=",ExpressionUUID->"ed7548de-bc38-4ba5-8b33-a83e0693409e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Shift", "::", "usage"}], "=", 
   "\"\<Parameter for UntangledBands that shifts the sampling domain by a \
small amount to avoid high-symmetry points and band degeneracies.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"UntangledBands", "::", "usage"}], "=", 
    "\"\<Samples the bands of a Hamiltonian and generates continuous curves \
for subbads by comparing eigenstates at adjacent sampling points.\>\""}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"EigenstateObservable", "::", "usage"}], "=", 
   "\"\<If a fuction is provided, UntangledBands or Bands will return a list \
of three numbers instead of two, of the form {sampling parameter value, \
eigenvalue, EigenstateObservable[eigenstate]}\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Attributes", "[", "UntangledBands", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"(*", "HoldFirst", "*)"}], "}"}]}], ";"}], "\[IndentingNewLine]", 

 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "UntangledBands", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Levels", "\[Rule]", "All"}], ",", 
       RowBox[{"Options", "[", "Eigenstates", "]"}], ",", 
       RowBox[{"Shift", "\[Rule]", "0.0"}], 
       RowBox[{"(*", ".000001", "*)"}], ",", 
       RowBox[{"SamplePoints", "\[Rule]", "51"}], ",", " ", 
       RowBox[{"Threshold", "\[Rule]", ".3"}], ",", "\[IndentingNewLine]", 
       RowBox[{"EigenstateObservable", "\[Rule]", "None"}]}], "}"}]}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"UntangledBands", "[", 
     RowBox[{"sys_MQSystem", ",", 
      RowBox[{"{", 
       RowBox[{"z_", ",", "zmin_", ",", "zmax_"}], "}"}], ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"prevevecs", "=", 
         RowBox[{"{", "}"}]}], ",", " ", "Reorder", ",", " ", "bands", ",", 
        "\[IndentingNewLine]", 
        RowBox[{"origin", "=", 
         RowBox[{"OptionValue", "@", "EnergyOrigin"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"shift", "=", 
         RowBox[{"OptionValue", "@", "Shift"}]}], ",", "\[IndentingNewLine]", 
        
        RowBox[{"points", "=", 
         RowBox[{"OptionValue", "@", "PlotPoints"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"threshold", "=", 
         RowBox[{"OptionValue", "@", "Threshold"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"includeobs", "=", 
         RowBox[{"OptionValue", "@", "IncludeEigenstateObservable"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"obs", "=", 
         RowBox[{"OptionValue", "@", "EigenstateObservable"}]}]}], "}"}], ",",
       "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"Reorder", "[", 
         RowBox[{"{", 
          RowBox[{"evals_", ",", "evecs_"}], "}"}], "]"}], ":=", 
        RowBox[{"Block", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
           "M", ",", "M0", ",", "r0", ",", "r1", ",", "U", ",", " ", "cuts", 
            ",", "revals", ",", "revecs"}], "}"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"prevevecs", "===", 
              RowBox[{"{", "}"}]}], ",", 
             RowBox[{
              RowBox[{"prevevecs", "=", "evecs"}], ";", 
              RowBox[{"Return", "[", "evals", "]"}]}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "Compute", " ", "overlap", " ", "of", " ", "old", " ", "and", " ",
              "new", " ", "eigenvectors"}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"M", "=", 
            RowBox[{"Abs", "[", 
             RowBox[{"evecs", ".", 
              RowBox[{"prevevecs", "\[HermitianConjugate]"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Min", "@", 
                 RowBox[{"(", 
                  RowBox[{"Max", "/@", "M"}], ")"}]}], "<", ".3"}], ",", 
               RowBox[{
                RowBox[{"Print", "[", "\"\<Cut\>\"", "]"}], ";", 
                RowBox[{"Print", "[", 
                 RowBox[{"MatrixForm", "[", 
                  RowBox[{"Chop", "[", 
                   RowBox[{"M", ",", ".3"}], "]"}], "]"}], "]"}]}], ",", 
               RowBox[{"Print", "[", "\"\<Pass\>\"", "]"}]}], "]"}], ";"}], 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{"Sort", " ", "new", " ", "eigenvectors", " ", 
             RowBox[{"(", 
              RowBox[{"and", " ", "eigenvalues"}], ")"}], " ", "with", " ", 
             "descending", " ", "maximum", " ", "overlap", " ", "with", " ", 
             "some", " ", "previous", " ", "eigenvector"}], "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"r0", ",", "M"}], "}"}], "=", 
            RowBox[{"Transpose", "@", 
             RowBox[{"Sort", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"Range", "[", 
                   RowBox[{"Length", "@", "M"}], "]"}], ",", "M"}], "}"}], 
                "\[Transpose]"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"Max", "@", 
                  RowBox[{"#1", "[", 
                   RowBox[{"[", "2", "]"}], "]"}]}], ">", 
                 RowBox[{"Max", "@", 
                  RowBox[{"#2", "[", 
                   RowBox[{"[", "2", "]"}], "]"}]}]}], "&"}]}], "]"}]}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"revals", "=", 
            RowBox[{"evals", "[", 
             RowBox[{"[", "r0", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"revecs", "=", 
            RowBox[{"evecs", "[", 
             RowBox[{"[", "r0", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "Now", " ", "match", " ", "new", " ", "eigenvectors", " ", 
              "with", " ", "previous", " ", "ones"}], ",", " ", 
             RowBox[{"starting", " ", "from", " ", "the", " ", "top"}], ",", 
             " ", 
             RowBox[{
             "while", " ", "excluding", " ", "all", " ", "previous", " ", 
              "matches"}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "Cuts", " ", "of", " ", "subbands", " ", "are", " ", "detected", 
             " ", "by", " ", "an", " ", "overlap", " ", "below", " ", 
             RowBox[{"Threshold", ".", " ", "They"}], " ", "are", " ", 
             "sowed", " ", "and", " ", "are", " ", "later", " ", "encoded", 
             " ", "into", " ", "U"}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"r1", ",", "cuts"}], "}"}], "=", 
            RowBox[{"Reap", "@", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Max", "[", 
                    RowBox[{"M", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "]"}], "<", "threshold"}],
                     ",", 
                    RowBox[{"Sow", "[", "i", "]"}]}], "]"}], ";", 
                   RowBox[{
                    RowBox[{"M", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "#"}], "]"}], "]"}], "*=", "0"}], ";",
                    "#"}], ")"}], "&"}], "@", 
                RowBox[{"Last", "@", 
                 RowBox[{"Ordering", "[", 
                  RowBox[{
                   RowBox[{"M", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ",", 
                   RowBox[{"-", "1"}]}], "]"}]}]}], ",", 
               RowBox[{"{", 
                RowBox[{"i", ",", "1", ",", 
                 RowBox[{"Length", "@", "M"}]}], "}"}]}], "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "This", " ", "r1", " ", "says", " ", "to", " ", "what", " ", 
              "position", " ", "should", " ", "each", " ", "eigenvalue", " ", 
              
              RowBox[{"go", ".", " ", "We"}], " ", "build", " ", "a", " ", 
              "U", " ", "that", " ", "reorders", " ", "revecs"}], "\[Rule]", 
             RowBox[{"U", ".", "revecs"}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"U", "=", 
            RowBox[{"SparseArray", "[", 
             RowBox[{"Thread", "[", 
              RowBox[{
               RowBox[{"Thread", "[", 
                RowBox[{"{", 
                 RowBox[{"r1", ",", 
                  RowBox[{"Range", "[", 
                   RowBox[{"Length", "@", "r1"}], "]"}]}], "}"}], "]"}], 
               "\[Rule]", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "Update", " ", "previous", " ", "eigenvectors", " ", "with", " ",
               "the", " ", "new", " ", "reordered", " ", "set"}], ",", " ", 
             RowBox[{
             "and", " ", "return", " ", "the", " ", "reordered", " ", "new", 
              " ", "eigenvalues"}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"prevevecs", "=", 
            RowBox[{"U", ".", "revecs"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "Encode", " ", "cuts", " ", "in", " ", "U", " ", "by", " ", 
             "\"\<multiplying\>\"", " ", "U", " ", "columns", " ", "by", " ", 
             "\"\<C\>\""}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"U", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", 
               RowBox[{"Flatten", "[", "cuts", "]"}]}], "]"}], "]"}], "*=", 
            "\"\<C\>\""}], ";", "\[IndentingNewLine]", 
           RowBox[{"Return", "[", 
            RowBox[{"U", ".", "revals"}], "]"}], ";"}]}], 
         "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"bands", "=", 
        RowBox[{"Transpose", "@", 
         RowBox[{"Monitor", "[", 
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Thread", "[", 
              RowBox[{"{", 
               RowBox[{"z", ",", 
                RowBox[{"Reorder", "@", 
                 RowBox[{"Eigenstates", "[", 
                  RowBox[{"sys", ",", 
                   RowBox[{"ReturnEigenvalues", "\[Rule]", "True"}], ",", " ", 
                   RowBox[{"FlattenEigenstates", "\[Rule]", "True"}], ",", 
                   RowBox[{"FilterRules", "[", 
                    RowBox[{
                    RowBox[{"{", "opts", "}"}], ",", 
                    RowBox[{"Options", "@", "Eigenstates"}]}], "]"}], ",", 
                   " ", 
                   RowBox[{"Levels", "\[Rule]", "All"}]}], "]"}]}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"z", ",", 
               RowBox[{"zmin", "+", "shift"}], ",", 
               RowBox[{"zmax", "+", "shift"}], ",", " ", 
               FractionBox[
                RowBox[{"zmax", "-", "zmin"}], 
                RowBox[{"points", "-", "1"}]]}], "}"}]}], "]"}], ",", "z"}], 
          "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Implement", " ", "the", " ", "cuts", " ", "by", " ", "processing", 
         " ", "the", " ", "\"\<C\>\"", "s", " ", "that", " ", "come", " ", 
         "from", " ", "the", " ", "U", " ", "ordering"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"bands", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"Split", "[", 
           RowBox[{"#", ",", 
            RowBox[{
             RowBox[{"!", 
              RowBox[{"MemberQ", "[", 
               RowBox[{
                RowBox[{"#2", "[", 
                 RowBox[{"[", "2", "]"}], "]"}], ",", "\"\<C\>\""}], "]"}]}], 
             "&"}]}], "]"}], "&"}], "/@", "bands"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"bands", "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Flatten", "[", 
            RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", "bands"}], "/.", 
         RowBox[{"\"\<C\>\"", "\[Rule]", "1"}]}]}], ";", 
       "\[IndentingNewLine]", "bands"}]}], "\[IndentingNewLine]", "]"}]}], 
   "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"UntangledBands", "[", 
    RowBox[{"sys_MQSystem", ",", 
     RowBox[{"{", 
      RowBox[{"z_", ",", "zmin_", ",", "zmax_"}], "}"}], ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"prevevecs", "=", 
        RowBox[{"{", "}"}]}], ",", " ", "Reorder", ",", " ", "bands", ",", 
       "\[IndentingNewLine]", 
       RowBox[{"origin", "=", 
        RowBox[{"OptionValue", "@", "EnergyOrigin"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"shift", "=", 
        RowBox[{"OptionValue", "@", "Shift"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"points", "=", 
        RowBox[{"OptionValue", "@", "SamplePoints"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"threshold", "=", 
        RowBox[{"OptionValue", "@", "Threshold"}]}], ",", 
       "\[IndentingNewLine]", "includeobs", ",", "obs"}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"obs", "=", 
       RowBox[{"OptionValue", "@", "EigenstateObservable"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"obs", "\[Equal]", "None"}], ",", 
        RowBox[{"includeobs", "=", "False"}], ",", 
        RowBox[{"includeobs", "=", "True"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Reorder", "[", 
        RowBox[{"{", 
         RowBox[{"evals_", ",", "evecs0_"}], "}"}], "]"}], ":=", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
          "M", ",", "M0", ",", "r0", ",", "r1", ",", "U", ",", " ", "cuts", 
           ",", "revals", ",", "revecs", ",", " ", 
           RowBox[{"evecs", "=", 
            RowBox[{"Flatten", "/@", "evecs0"}]}], ",", " ", "obsevecs"}], 
          "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"prevevecs", "===", 
             RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"prevevecs", "=", "evecs"}], ";", "\[IndentingNewLine]", 
             
             RowBox[{"If", "[", 
              RowBox[{"includeobs", ",", 
               RowBox[{"Return", "[", 
                RowBox[{"Flatten", "/@", 
                 RowBox[{"Transpose", "[", 
                  RowBox[{"{", 
                   RowBox[{"evals", ",", 
                    RowBox[{"obs", "/@", "evecs0"}]}], "}"}], "]"}]}], "]"}], 
               ",", 
               RowBox[{"Return", "[", "evals", "]"}]}], "]"}]}]}], "]"}], ";",
           "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Compute", " ", "overlap", " ", "of", " ", "old", " ", "and", " ", 
            "new", " ", "eigenvectors"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"M", "=", 
           RowBox[{"Abs", "[", 
            RowBox[{"evecs", ".", 
             RowBox[{"prevevecs", "\[HermitianConjugate]"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Min", "@", 
                RowBox[{"(", 
                 RowBox[{"Max", "/@", "M"}], ")"}]}], "<", ".3"}], ",", 
              RowBox[{
               RowBox[{"Print", "[", "\"\<Cut\>\"", "]"}], ";", 
               RowBox[{"Print", "[", 
                RowBox[{"MatrixForm", "[", 
                 RowBox[{"Chop", "[", 
                  RowBox[{"M", ",", ".3"}], "]"}], "]"}], "]"}]}], ",", 
              RowBox[{"Print", "[", "\"\<Pass\>\"", "]"}]}], "]"}], ";"}], 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{"Sort", " ", "new", " ", "eigenvectors", " ", 
            RowBox[{"(", 
             RowBox[{"and", " ", "eigenvalues"}], ")"}], " ", "with", " ", 
            "descending", " ", "maximum", " ", "overlap", " ", "with", " ", 
            "some", " ", "previous", " ", "eigenvector"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"r0", ",", "M"}], "}"}], "=", 
           RowBox[{"Transpose", "@", 
            RowBox[{"Sort", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"Range", "[", 
                  RowBox[{"Length", "@", "M"}], "]"}], ",", "M"}], "}"}], 
               "\[Transpose]"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"Max", "@", 
                 RowBox[{"#1", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}], ">", 
                RowBox[{"Max", "@", 
                 RowBox[{"#2", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}]}], "&"}]}], "]"}]}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{"revals", "=", 
           RowBox[{"evals", "[", 
            RowBox[{"[", "r0", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"revecs", "=", 
           RowBox[{"evecs", "[", 
            RowBox[{"[", "r0", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "Now", " ", "match", " ", "new", " ", "eigenvectors", " ", "with",
              " ", "previous", " ", "ones"}], ",", " ", 
            RowBox[{"starting", " ", "from", " ", "the", " ", "top"}], ",", 
            " ", 
            RowBox[{
            "while", " ", "excluding", " ", "all", " ", "previous", " ", 
             "matches"}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Cuts", " ", "of", " ", "subbands", " ", "are", " ", "detected", 
            " ", "by", " ", "an", " ", "overlap", " ", "below", " ", 
            RowBox[{"Threshold", ".", " ", "They"}], " ", "are", " ", "sowed",
             " ", "and", " ", "are", " ", "later", " ", "encoded", " ", 
            "into", " ", "U"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"r1", ",", "cuts"}], "}"}], "=", 
           RowBox[{"Reap", "@", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Max", "[", 
                    RowBox[{"M", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "]"}], "<", "threshold"}],
                     ",", 
                    RowBox[{"Sow", "[", "i", "]"}]}], "]"}], ";", 
                  RowBox[{
                   RowBox[{"M", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "#"}], "]"}], "]"}], "*=", "0"}], ";",
                   "#"}], ")"}], "&"}], "@", 
               RowBox[{"Last", "@", 
                RowBox[{"Ordering", "[", 
                 RowBox[{
                  RowBox[{"M", "[", 
                   RowBox[{"[", "i", "]"}], "]"}], ",", 
                  RowBox[{"-", "1"}]}], "]"}]}]}], ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", "1", ",", 
                RowBox[{"Length", "@", "M"}]}], "}"}]}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "This", " ", "r1", " ", "says", " ", "to", " ", "what", " ", 
             "position", " ", "should", " ", "each", " ", "eigenvalue", " ", 
             RowBox[{"go", ".", " ", "We"}], " ", "build", " ", "a", " ", "U",
              " ", "that", " ", "reorders", " ", "revecs"}], "\[Rule]", 
            RowBox[{"U", ".", "revecs"}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"U", "=", 
           RowBox[{"SparseArray", "[", 
            RowBox[{"Thread", "[", 
             RowBox[{
              RowBox[{"Thread", "[", 
               RowBox[{"{", 
                RowBox[{"r1", ",", 
                 RowBox[{"Range", "[", 
                  RowBox[{"Length", "@", "r1"}], "]"}]}], "}"}], "]"}], 
              "\[Rule]", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "Update", " ", "previous", " ", "eigenvectors", " ", "with", " ", 
             "the", " ", "new", " ", "reordered", " ", "set"}], ",", " ", 
            RowBox[{
            "and", " ", "return", " ", "the", " ", "reordered", " ", "new", 
             " ", "eigenvalues"}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"prevevecs", "=", 
           RowBox[{"U", ".", "revecs"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Encode", " ", "cuts", " ", "in", " ", "U", " ", "by", " ", 
            "\"\<multiplying\>\"", " ", "U", " ", "columns", " ", "by", " ", 
            "\"\<C\>\""}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"U", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", 
              RowBox[{"Flatten", "[", "cuts", "]"}]}], "]"}], "]"}], "*=", 
           "\"\<C\>\""}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"includeobs", ",", 
            RowBox[{"Return", "[", 
             RowBox[{"Flatten", "/@", 
              RowBox[{"Transpose", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"U", ".", "revals"}], ",", 
                 RowBox[{"U", ".", 
                  RowBox[{"(", 
                   RowBox[{"obs", "/@", 
                    RowBox[{"evecs0", "[", 
                    RowBox[{"[", "r0", "]"}], "]"}]}], ")"}]}]}], "}"}], 
               "]"}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"Return", "[", 
           RowBox[{"U", ".", "revals"}], "]"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"bands", "=", 
       RowBox[{"Transpose", "@", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"Thread", "[", 
             RowBox[{"{", 
              RowBox[{"z", ",", 
               RowBox[{"Reorder", "@", 
                RowBox[{"Eigenstates", "[", 
                 RowBox[{"sys", ",", 
                  RowBox[{"ReturnEigenvalues", "\[Rule]", "True"}], ",", 
                  RowBox[{"FilterRules", "[", 
                   RowBox[{
                    RowBox[{"{", "opts", "}"}], ",", 
                    RowBox[{"Options", "@", "Eigenstates"}]}], "]"}], ",", 
                  " ", 
                  RowBox[{"Levels", "\[Rule]", "All"}]}], "]"}]}]}], "}"}], 
             "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"z", ",", 
              RowBox[{"zmin", "+", "shift"}], ",", 
              RowBox[{"zmax", "+", "shift"}], ",", " ", 
              FractionBox[
               RowBox[{"zmax", "-", "zmin"}], 
               RowBox[{"points", "-", "1"}]]}], "}"}]}], "]"}], ",", "z"}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Implement", " ", "the", " ", "cuts", " ", "by", " ", "processing", 
        " ", "the", " ", "\"\<C\>\"", "s", " ", "that", " ", "come", " ", 
        "from", " ", "the", " ", "U", " ", "ordering"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"bands", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Split", "[", 
          RowBox[{"#", ",", 
           RowBox[{
            RowBox[{"FreeQ", "[", 
             RowBox[{
              RowBox[{"#2", "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", "\"\<C\>\""}], "]"}], 
            "&"}]}], "]"}], "&"}], "/@", "bands"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"bands", "=", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Flatten", "[", 
           RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", "bands"}], "/.", 
        RowBox[{"\"\<C\>\"", "\[Rule]", "1"}]}]}], ";", "\[IndentingNewLine]",
       "bands"}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "PlotUntangledBands", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"Options", "[", "ListLinePlot", "]"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotUntangledBands", "[", 
   RowBox[{"untangledspectrum_List", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"ListLinePlot", "[", 
   RowBox[{"untangledspectrum", ",", " ", 
    RowBox[{"FilterRules", "[", 
     RowBox[{
      RowBox[{"{", "opts", "}"}], ",", " ", 
      RowBox[{"Options", "[", "ListLinePlot", "]"}]}], "]"}], ",", 
    "PlotDefaults"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.604303533624865*^9, 3.604303577172715*^9}, {
   3.6043037567725477`*^9, 3.604303794568286*^9}, {3.604310342015383*^9, 
   3.6043104754121227`*^9}, 3.604644823643547*^9, {3.6077679447087317`*^9, 
   3.607767946149292*^9}, 3.6077680098487988`*^9, {3.607768040705481*^9, 
   3.607768043213806*^9}, {3.607769003768972*^9, 3.6077690347528543`*^9}, {
   3.615284873144401*^9, 3.6152849298459873`*^9}, {3.615284982429223*^9, 
   3.6152849966420918`*^9}, 3.615285059261416*^9, {3.616492212357923*^9, 
   3.616492222563847*^9}, 3.6169974873713903`*^9, {3.617006997625042*^9, 
   3.617007078558869*^9}, {3.617007119637047*^9, 3.617007120795393*^9}, {
   3.617007166937234*^9, 3.617007173802471*^9}, {3.623147656045657*^9, 
   3.6231476617075768`*^9}, {3.6231477253356953`*^9, 3.623147762240973*^9}, 
   3.6231479076958923`*^9, {3.623147959573039*^9, 3.6231480584017*^9}, {
   3.623148156941381*^9, 3.6231481589649*^9}, {3.623148397465221*^9, 
   3.623148399848916*^9}, 3.623148479627368*^9, {3.629641814892227*^9, 
   3.629641815500379*^9}, {3.629648719455908*^9, 3.629648724927146*^9}, {
   3.629648797493567*^9, 3.629648847084214*^9}, {3.63308410844582*^9, 
   3.633084192097129*^9}, 3.633084320361466*^9, {3.633084490983035*^9, 
   3.6330845210552683`*^9}, {3.633084619709544*^9, 3.6330847004536247`*^9}, {
   3.63308477417021*^9, 3.633084816832101*^9}, {3.633084855733927*^9, 
   3.6330848566153183`*^9}, {3.633084911203417*^9, 3.633085013247985*^9}, {
   3.633085045046825*^9, 3.633085053940466*^9}, {3.6330851289951468`*^9, 
   3.633085130945903*^9}, {3.633085163521226*^9, 3.633085233125224*^9}, {
   3.633085297354384*^9, 3.633085377077373*^9}, {3.633085505680336*^9, 
   3.6330855253903227`*^9}, {3.633087313877925*^9, 3.633087402608667*^9}, {
   3.6330897082904387`*^9, 3.633089711288109*^9}, 3.635830860250946*^9, {
   3.638595870738139*^9, 3.638595879759262*^9}, 3.666431493723401*^9, 
   3.666431586594687*^9, 3.666431630817531*^9, {3.666431730422037*^9, 
   3.666431755966795*^9}, 3.666431794821228*^9, {3.666431831602025*^9, 
   3.666431848259997*^9}, {3.6664318941847153`*^9, 3.666431974322537*^9}, {
   3.666432008503708*^9, 3.66643208166116*^9}, {3.666432151481401*^9, 
   3.666432222892016*^9}, {3.666432283819655*^9, 3.6664323828556337`*^9}, {
   3.666432456098836*^9, 3.6664325647798567`*^9}, {3.666432608570204*^9, 
   3.6664327791206627`*^9}, {3.66643281663157*^9, 3.66643283559372*^9}, {
   3.666433608552063*^9, 3.666433650955619*^9}, 3.66643381676497*^9, {
   3.667128022976268*^9, 3.667128024493187*^9}, {3.667128157444363*^9, 
   3.667128157863658*^9}, {3.708075698008424*^9, 3.708075717968955*^9}, {
   3.713453518504888*^9, 3.713453612893862*^9}, 3.7134538438257732`*^9, {
   3.713453933752358*^9, 3.713453938959423*^9}, 3.713454078283435*^9, {
   3.713454160447401*^9, 3.713454166299209*^9}, {3.713454204575493*^9, 
   3.7134542064296103`*^9}, {3.713454243362461*^9, 3.713454247537949*^9}, {
   3.713527565987411*^9, 3.713527566056979*^9}, {3.713527663172839*^9, 
   3.713527666427541*^9}, 3.713678388296492*^9, 3.7603559823185596`*^9, 
   3.760420554563643*^9, {3.780290397113854*^9, 3.780290444317655*^9}, {
   3.780290583474285*^9, 3.780290599634252*^9}},
 CellLabel->
  "In[305]:=",ExpressionUUID->"a0138c57-c216-45c1-b608-b6981c4d095d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "PlotEigenstates", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Options", "[", "PlotField", "]"}], ",", 
      RowBox[{"Options", "[", "Eigenstates", "]"}]}], "}"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotEigenstates", "[", 
    RowBox[{"system_MQSystem", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Head", "@", 
       RowBox[{"system", "[", "\"\<Lattice\>\"", "]"}]}], "=!=", "Missing"}], 
     ",", 
     RowBox[{"PlotEigenstates", "[", 
      RowBox[{
       RowBox[{"system", "[", "\"\<Lattice\>\"", "]"}], ",", "system", ",", 
       "opts"}], "]"}], ",", 
     RowBox[{"Message", "[", 
      RowBox[{"MQSystem", "::", "missinglat"}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"PlotEigenstates", "[", 
     RowBox[{"lattice_MQLattice", ",", "system_MQSystem", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{
     RowBox[{
      RowBox[{"PlotField", "[", 
       RowBox[{"lattice", ",", "#", ",", " ", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "[", "PlotField", "]"}]}], "]"}], ",", " ", 
        RowBox[{"PlotLegends", "\[Rule]", "False"}], ",", " ", 
        RowBox[{"FrameTicks", "\[Rule]", "None"}], ",", " ", 
        RowBox[{"FrameLabel", "\[Rule]", "None"}]}], "]"}], "&"}], "/@", 
     RowBox[{"Eigenstates", "[", 
      RowBox[{"system", ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "[", "Eigenstates", "]"}]}], "]"}]}], "]"}]}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotEigenstates", "[", 
    RowBox[{"lattice_MQLattice", ",", 
     RowBox[{"H_", "?", "ArrayQ"}], ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"PlotField", "[", 
      RowBox[{"lattice", ",", "#", ",", " ", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "[", "PlotField", "]"}]}], "]"}], ",", " ", 
       RowBox[{"PlotLegends", "\[Rule]", "False"}], ",", " ", 
       RowBox[{"FrameTicks", "\[Rule]", "None"}], ",", " ", 
       RowBox[{"FrameLabel", "\[Rule]", "None"}]}], "]"}], "&"}], "/@", 
    RowBox[{"Eigenstates", "[", 
     RowBox[{"H", ",", 
      RowBox[{"FilterRules", "[", 
       RowBox[{
        RowBox[{"{", "opts", "}"}], ",", 
        RowBox[{"Options", "[", "Eigenstates", "]"}]}], "]"}]}], "]"}]}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{
  3.621587567317522*^9, {3.621588740036419*^9, 3.621588743264772*^9}, {
   3.629641816282464*^9, 3.629641821969968*^9}, {3.635850985870401*^9, 
   3.6358509909408207`*^9}, {3.6358510331702423`*^9, 3.635851083279469*^9}, {
   3.637392642104289*^9, 3.6373927047763033`*^9}, 3.637392798606104*^9, {
   3.637397964667016*^9, 3.637397982474148*^9}, {3.6379078503223667`*^9, 
   3.63790786677538*^9}, {3.707831658485766*^9, 3.707831668660262*^9}},
 CellLabel->
  "In[313]:=",ExpressionUUID->"8773a2c9-c433-4cbd-b487-9f4df092d4ef"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"PiSymmetric", "::", "usage"}], "=", 
    "\"\<Option for JosephsonSpectrum that specifies whether the system \
should be assumed to have a spectrum that is symmetric respect to inversion \
at \[Phi]=\[Pi].\>\""}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"JosephsonSpectrum", "::", "periodicity"}], "=", 
    "\"\<Warning: the system is not 2\[Pi]-periodic. The difference from 0 to \
2\[Pi] is `1`.\>\""}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "JosephsonSpectrum", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Options", "[", "Bands", "]"}], ",", " ", 
      RowBox[{"PiSymmetric", "\[Rule]", "False"}]}], "}"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"JosephsonSpectrum", "[", 
    RowBox[{"systemfunction_Function", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "[", "PiSymmetric", "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{"#", ",", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"2", "\[Pi]"}], "-", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], ",", 
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], "}"}], "&"}], "/@", 
            RowBox[{"Reverse", "@", 
             RowBox[{"Most", "@", "#"}]}]}]}], "]"}], "&"}], "@", 
        RowBox[{"Bands", "[", 
         RowBox[{
          RowBox[{"systemfunction", "[", "\[Phi]", "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"\[Phi]", ",", "0", ",", "\[Pi]"}], "}"}], ",", " ", 
          RowBox[{"Evaluate", "@", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"SamplingFunction", "\[Rule]", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Total", "[", 
                 RowBox[{"Abs", "[", "#", "]"}], "]"}], "&"}], ")"}]}], ",", 
             " ", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", "opts", "}"}], ",", 
               RowBox[{"Options", "[", "Bands", "]"}]}], "]"}]}], "}"}]}]}], 
         "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"Bands", "[", 
        RowBox[{
         RowBox[{"systemfunction", "[", "\[Phi]", "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Phi]", ",", "0", ",", 
           RowBox[{"2", "\[Pi]"}]}], "}"}], ",", " ", 
         RowBox[{"Evaluate", "@", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"SamplingFunction", "\[Rule]", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Total", "[", 
                RowBox[{"Abs", "[", "#", "]"}], "]"}], "&"}], ")"}]}], ",", 
            " ", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "[", "Bands", "]"}]}], "]"}]}], "}"}]}]}], 
        "]"}]}], "]"}]}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.598360563052383*^9, 3.598360830959342*^9}, {
   3.5983608819149637`*^9, 3.598360882619692*^9}, {3.598360915460783*^9, 
   3.598360917949356*^9}, 3.5983609526711817`*^9, {3.5983609887539673`*^9, 
   3.598361196984626*^9}, {3.598361286154407*^9, 3.5983613005686283`*^9}, {
   3.5983613363252363`*^9, 3.598361337547358*^9}, {3.5983615739112873`*^9, 
   3.598361586900424*^9}, {3.598361629762578*^9, 3.598361663971685*^9}, {
   3.598361699795216*^9, 3.5983619713518133`*^9}, {3.598362043311521*^9, 
   3.598362081795581*^9}, {3.5983621239654827`*^9, 3.598362137275754*^9}, {
   3.598362213738617*^9, 3.598362215891822*^9}, {3.598362328419245*^9, 
   3.59836232928203*^9}, {3.598362427964707*^9, 3.598362428480303*^9}, {
   3.5983624789981737`*^9, 3.5983625708577003`*^9}, {3.598362637967968*^9, 
   3.598362791368793*^9}, {3.598362865365118*^9, 3.598363018871908*^9}, 
   3.598363090258257*^9, {3.598363132931617*^9, 3.59836313749004*^9}, {
   3.5983631833671103`*^9, 3.5983631880871973`*^9}, {3.598363303854992*^9, 
   3.598363318159668*^9}, {3.598363378191128*^9, 3.598363381727296*^9}, {
   3.598363577453347*^9, 3.5983636376942244`*^9}, {3.598363860502472*^9, 
   3.598363861406871*^9}, {3.598378421464992*^9, 3.598378453510107*^9}, {
   3.598380003685322*^9, 3.598380091252614*^9}, 3.598380376657857*^9, {
   3.5983804324451017`*^9, 3.598380435474485*^9}, {3.598380476296109*^9, 
   3.598380479199892*^9}, {3.598380945699288*^9, 3.598380995187704*^9}, {
   3.598381051983385*^9, 3.5983810682938766`*^9}, {3.598381395589345*^9, 
   3.598381417205377*^9}, {3.598382924219543*^9, 3.598382992317525*^9}, {
   3.598599673103389*^9, 3.598599862408235*^9}, {3.5985999549622717`*^9, 
   3.59860003604609*^9}, {3.598600079445053*^9, 3.5986001168033752`*^9}, {
   3.59860018434265*^9, 3.598600190362514*^9}, {3.598600236093609*^9, 
   3.598600237119615*^9}, {3.5986004403901854`*^9, 3.598600586030272*^9}, {
   3.598600645416525*^9, 3.598600655090309*^9}, {3.598600754328703*^9, 
   3.598600756539639*^9}, {3.598616055052257*^9, 3.598616060586136*^9}, {
   3.5986269137455263`*^9, 3.598626927044622*^9}, {3.598630565262537*^9, 
   3.598630575750883*^9}, {3.5986306693325453`*^9, 3.598630730216371*^9}, 
   3.598632361447671*^9, {3.5992195290631847`*^9, 3.599219532922876*^9}},
 CellLabel->
  "In[317]:=",ExpressionUUID->"f851b8f7-e2c2-4af4-a8be-c6fe61843513"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Transport observables", "Subsection",
 CellChangeTimes->{{3.59819445996882*^9, 3.598194463567781*^9}, {
   3.598348568177273*^9, 3.598348572401187*^9}, 
   3.5986305536152353`*^9},ExpressionUUID->"4ac6f23e-8948-4365-8039-\
1d4306ca47c2"],

Cell["Scattering amplitudes and transmissions", "Text",
 CellChangeTimes->{{3.60309946890348*^9, 3.6030994788053007`*^9}, {
  3.613457610911717*^9, 
  3.61345761323855*^9}},ExpressionUUID->"97553782-9080-4992-b89d-\
5a2875f07bea"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "Conductance", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"Options", "[", "SolveScatteringSystem", "]"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Conductance", "[", 
    RowBox[{"\[Omega]_", ",", "scatsys_MQScatteringSystem", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{"scatsys", "[", "\"\<Nambu\>\"", "]"}], ",", " ", 
     RowBox[{"GNambu", "[", 
      RowBox[{"1", ",", "\[Omega]", ",", "scatsys", ",", "opts"}], "]"}], ",",
      "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"scatsys", "[", "\"\<NumberOfLeads\>\"", "]"}], "\[Equal]", 
        "1"}], ",", "0", ",", 
       RowBox[{"GCaroli", "[", 
        RowBox[{"2", ",", "1", ",", "\[Omega]", ",", "scatsys", ",", "opts"}],
         "]"}]}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Conductance", "[", 
   RowBox[{
   "i_Integer", ",", "j___Integer", ",", "\[Omega]_", ",", 
    "scatsys_MQScatteringSystem", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"scatsys", "[", "\"\<Nambu\>\"", "]"}], ",", " ", 
    RowBox[{"GNambu", "[", 
     RowBox[{"i", ",", "\[Omega]", ",", "scatsys", ",", "opts"}], "]"}], ",", 
    
    RowBox[{"GCaroli", "[", 
     RowBox[{"i", ",", "j", ",", "\[Omega]", ",", "scatsys", ",", "opts"}], 
     "]"}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.708074755329475*^9, 3.708074780363451*^9}, {
   3.7080748156575413`*^9, 3.708074884075963*^9}, {3.708074991422928*^9, 
   3.7080750332456293`*^9}, {3.708075109653407*^9, 3.708075127364567*^9}, {
   3.7080824908710546`*^9, 3.708082507867239*^9}, {3.7080825737151737`*^9, 
   3.708082614450674*^9}, {3.7080828979756927`*^9, 3.708082899181666*^9}, 
   3.7080834010147257`*^9, {3.7080834788075113`*^9, 3.708083478980465*^9}},
 CellLabel->
  "In[320]:=",ExpressionUUID->"1d996ae2-3bf4-413a-be82-6463abd79b52"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "GCaroli", "]"}], "=", 
    RowBox[{"Options", "[", "Conductance", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GCaroli", "[", 
   RowBox[{
   "i_Integer", ",", "j_Integer", ",", "\[Omega]_", ",", 
    "scatsys_MQScatteringSystem", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"GCaroli", "[", 
   RowBox[{"i", ",", "j", ",", 
    RowBox[{"SolveScatteringSystem", "[", 
     RowBox[{"\[Omega]", ",", "scatsys", ",", " ", 
      RowBox[{"FilterRules", "[", 
       RowBox[{
        RowBox[{"{", "opts", "}"}], ",", " ", "SolveScatteringSystem"}], 
       "]"}]}], "]"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GCaroli", "[", 
    RowBox[{"\[Omega]_", ",", "scatsys_MQScatteringSystem", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"GCaroli", "[", 
    RowBox[{
    "2", ",", "1", ",", "\[Omega]", ",", "scatsys", ",", " ", "opts"}], 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"GCaroli", "[", "solution_MQSystemSolution", "]"}], ":=", 
    RowBox[{"GCaroli", "[", 
     RowBox[{"2", ",", "1", ",", "solution"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GCaroli", "[", 
   RowBox[{"i_Integer", ",", "j_Integer", ",", "solution_MQSystemSolution"}], 
   "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"\[CapitalGamma]", ",", "G", ",", "W", ",", "WGW", ",", "ig"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{
      "Optimization", " ", "of", " ", "general", " ", "formula", " ", 
       RowBox[{"Chop", "[", 
        RowBox[{"Tr", "[", 
         RowBox[{
          RowBox[{"\[CapitalGamma]", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ".", "G", ".", 
          RowBox[{"\[CapitalGamma]", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ".", 
          RowBox[{"G", "\[HermitianConjugate]"}]}], "]"}], "]"}]}], ",", " ", 
      
      RowBox[{
       RowBox[{"where", " ", 
        SubscriptBox["\[CapitalGamma]", "i"]}], "=", 
       RowBox[{
        RowBox[{
         SubscriptBox["w", "i"], "\[HermitianConjugate]"}], ".", 
        FractionBox[
         RowBox[{
          SubscriptBox["g", "i"], "-", 
          RowBox[{
           SubscriptBox["g", "i"], "\[HermitianConjugate]"}]}], 
         "\[ImaginaryI]"], ".", 
        SubscriptBox["w", "i"]}]}]}], "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"ig", "=", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          FractionBox[
           RowBox[{"#", "-", 
            RowBox[{"#", "\[HermitianConjugate]"}]}], "\[ImaginaryI]"], "&"}],
          "@", 
         RowBox[{"#", "[", "\"\<gSurface\>\"", "]"}]}], "&"}], "/@", 
       RowBox[{
        RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}], "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"G", "=", 
      RowBox[{"solution", "[", "\"\<G\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"W", "=", 
      RowBox[{
       RowBox[{"solution", "[", "\"\<CouplingsSurface\>\"", "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"{", 
         RowBox[{"i", ",", "j"}], "}"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"WGW", "=", 
      RowBox[{
       RowBox[{"W", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ".", "G", ".", 
       RowBox[{
        RowBox[{"W", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "\[HermitianConjugate]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Chop", "[", 
      RowBox[{"Tr", "[", 
       RowBox[{
        RowBox[{"ig", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ".", "WGW", ".", 
        RowBox[{"ig", "[", 
         RowBox[{"[", "2", "]"}], "]"}], ".", 
        RowBox[{"WGW", "\[HermitianConjugate]"}]}], "]"}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.598348652739942*^9, 3.5983491293544607`*^9}, {
   3.59834917723948*^9, 3.598349285726535*^9}, {3.5983494076005087`*^9, 
   3.598349421351986*^9}, {3.598349472707795*^9, 3.598349510244946*^9}, {
   3.598349585412546*^9, 3.598349589419784*^9}, {3.598350241377348*^9, 
   3.598350283354244*^9}, 3.598630553617269*^9, {3.598788888254342*^9, 
   3.598788919910143*^9}, 3.598941738130557*^9, 3.599138989467216*^9, 
   3.599197700926607*^9, 3.599198176054812*^9, 3.603179402547546*^9, 
   3.6031800313271313`*^9, {3.603704905954254*^9, 3.6037049143043737`*^9}, {
   3.603704956062253*^9, 3.603705069455172*^9}, {3.6037051126517973`*^9, 
   3.603705143513098*^9}, {3.603705392505024*^9, 3.6037054041114073`*^9}, {
   3.60370589619769*^9, 3.6037058997887363`*^9}, {3.613449767002614*^9, 
   3.6134497928156843`*^9}, {3.613458732477046*^9, 3.61345876420459*^9}, {
   3.629641824850337*^9, 3.629641826298306*^9}, {3.635236199783493*^9, 
   3.635236199806437*^9}, {3.637572355537999*^9, 3.6375723555469303`*^9}, {
   3.650954073550519*^9, 3.650954093805421*^9}, {3.708074784796053*^9, 
   3.708074814145516*^9}},
 CellLabel->
  "In[323]:=",ExpressionUUID->"f46644c7-81fd-4951-886d-fc430793c2c1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Smatrix", "::", "dim"}], "=", 
   "\"\<There are only `1` leads, but scattering between `2` and `3` was \
requested.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BTK", "::", "usage"}], "=", 
    "\"\<Option for Smatrix that specifies whether each (incoming/outgoing) \
lead should be decomposed in electron and hole sectors\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "Smatrix", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Options", "[", "SolveScatteringSystem", "]"}], ",", " ", 
      RowBox[{"BTK", "\[Rule]", "False"}]}], "}"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Smatrix", "[", 
   RowBox[{
   "i_Integer", ",", "i_Integer", ",", "solution_MQSystemSolution", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"leadsol", ",", "S"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"1", "<=", "i", "\[LessEqual]", 
         RowBox[{"solution", "[", "\"\<NumberOfLeads\>\"", "]"}]}]}], ",", 
       " ", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"Smatrix", "::", "dim"}], ",", 
          RowBox[{"solution", "[", "\"\<NumberOfLeads\>\"", "]"}], ",", "i", 
          ",", "i"}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"leadsol", "=", 
      RowBox[{
       RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}], "[", 
       RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"leadsol", "[", "\"\<r0\>\"", "]"}], "===", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"{", "}"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"S", "=", 
      RowBox[{"Chop", "[", 
       RowBox[{
        RowBox[{"leadsol", "[", "\"\<r0\>\"", "]"}], "+", 
        RowBox[{
         RowBox[{"leadsol", "[", "\"\<invphig\>\"", "]"}], ".", 
         RowBox[{
          RowBox[{"solution", "[", "\"\<CouplingsSurface\>\"", "]"}], "[", 
          RowBox[{"[", "i", "]"}], "]"}], ".", 
         RowBox[{"solution", "[", "\"\<G\>\"", "]"}], ".", 
         RowBox[{
          RowBox[{
           RowBox[{"solution", "[", "\"\<CouplingsSurface\>\"", "]"}], "[", 
           RowBox[{"[", "i", "]"}], "]"}], "\[HermitianConjugate]"}], ".", 
         RowBox[{"leadsol", "[", "\"\<psiSurface\>\"", "]"}]}]}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "[", "BTK", "]"}], ",", 
       RowBox[{"S", "=", 
        RowBox[{"DecomposeBTK", "[", 
         RowBox[{"S", ",", 
          RowBox[{"leadsol", "[", "\"\<NambuSectors\>\"", "]"}]}], "]"}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", "S"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Smatrix", "[", 
   RowBox[{
   "j_Integer", ",", "i_Integer", ",", "solution_MQSystemSolution", ",", " ", 
    
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"leadsol1", ",", " ", "leadsol2", ",", " ", "S"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"!", 
         RowBox[{"1", "<=", "i", "\[LessEqual]", 
          RowBox[{"solution", "[", "\"\<NumberOfLeads\>\"", "]"}]}]}], "||", 
        RowBox[{"!", 
         RowBox[{"1", "\[LessEqual]", "j", "\[LessEqual]", 
          RowBox[{"solution", "[", "\"\<NumberOfLeads\>\"", "]"}]}]}]}], ",", 
       " ", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"Smatrix", "::", "dim"}], ",", 
          RowBox[{"solution", "[", "\"\<NumberOfLeads\>\"", "]"}], ",", "i", 
          ",", "j"}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"leadsol1", "=", 
      RowBox[{
       RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}], "[", 
       RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"leadsol2", "=", 
      RowBox[{
       RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}], "[", 
       RowBox[{"[", "j", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"leadsol1", "[", "\"\<r0\>\"", "]"}], "===", 
         RowBox[{"{", "}"}]}], "||", 
        RowBox[{
         RowBox[{"leadsol2", "[", "\"\<r0\>\"", "]"}], "===", 
         RowBox[{"{", "}"}]}]}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"{", "}"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"S", "=", 
      RowBox[{"Chop", "[", 
       RowBox[{
        RowBox[{"leadsol2", "[", "\"\<invphig\>\"", "]"}], ".", 
        RowBox[{
         RowBox[{"solution", "[", "\"\<CouplingsSurface\>\"", "]"}], "[", 
         RowBox[{"[", "j", "]"}], "]"}], ".", 
        RowBox[{"solution", "[", "\"\<G\>\"", "]"}], ".", 
        RowBox[{
         RowBox[{
          RowBox[{"solution", "[", "\"\<CouplingsSurface\>\"", "]"}], "[", 
          RowBox[{"[", "i", "]"}], "]"}], "\[HermitianConjugate]"}], ".", 
        RowBox[{"leadsol1", "[", "\"\<psiSurface\>\"", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "[", "BTK", "]"}], ",", 
       RowBox[{"S", "=", 
        RowBox[{"DecomposeBTK", "[", 
         RowBox[{"S", ",", 
          RowBox[{"leadsol2", "[", "\"\<NambuSectors\>\"", "]"}], ",", 
          RowBox[{"leadsol1", "[", "\"\<NambuSectors\>\"", "]"}]}], "]"}]}]}],
       "]"}], ";", "\[IndentingNewLine]", "S"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Smatrix", "[", 
    RowBox[{"solution_MQSystemSolution", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Smatrix", "[", 
      RowBox[{"i", ",", "j", ",", "solution", ",", " ", "opts"}], "]"}], ",", 
     
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", 
       RowBox[{"solution", "[", "\"\<NumberOfLeads\>\"", "]"}]}], "}"}], ",", 
     
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", 
       RowBox[{"solution", "[", "\"\<NumberOfLeads\>\"", "]"}]}], "}"}]}], 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Smatrix", "[", 
    RowBox[{
    "i_Integer", ",", "j_Integer", ",", "\[Omega]_", ",", 
     "scatsys_MQScatteringSystem", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Smatrix", "[", 
    RowBox[{"i", ",", "j", ",", 
     RowBox[{"SolveScatteringSystem", "[", 
      RowBox[{"\[Omega]", ",", "scatsys", ",", " ", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", " ", "SolveScatteringSystem"}], 
        "]"}]}], "]"}], ",", " ", "opts"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Smatrix", "[", 
     RowBox[{"\[Omega]_", ",", "scatsys_MQScatteringSystem", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Smatrix", "[", 
     RowBox[{
      RowBox[{"SolveScatteringSystem", "[", 
       RowBox[{"\[Omega]", ",", "scatsys", ",", " ", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", " ", "SolveScatteringSystem"}], 
         "]"}]}], "]"}], ",", " ", "opts"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "Function", " ", "DecomposeBTK", " ", "decomposes", " ", "an", " ", "S", 
     " ", "matrix", " ", "block", " ", "into", " ", "electron", " ", "and", 
     " ", "hole", " ", "sectors"}], ",", " ", 
    RowBox[{"if", " ", "possible"}]}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DecomposeBTK", "[", 
    RowBox[{"S_", ",", "nambusectors_"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "ein", ",", " ", "eout", ",", " ", "hin", ",", " ", "hout", ",", " ", 
       "sectorsIn", ",", "sectorsOut"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "Nambu", " ", "sectors", " ", "take", " ", "the", " ", "form", " ", 
        RowBox[{"{", 
         RowBox[{"sectorsIn", ",", " ", "sectorsOut"}], "}"}]}], ",", " ", 
       RowBox[{
        RowBox[{"and", " ", 
         RowBox[{"sectorsIn", "/", "Out"}]}], "=", 
        RowBox[{"{", 
         RowBox[{"echaracter_List", ",", " ", "hcharacter_List"}], "}"}]}], 
       ",", " ", 
       RowBox[{
       "where", " ", "the", " ", "List", " ", "spans", " ", "propagating", 
        " ", "modes"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"sectorsIn", ",", "sectorsOut"}], "}"}], "=", 
       "nambusectors"}], ";", "\[IndentingNewLine]", 
      RowBox[{"ein", "=", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Position", "[", 
         RowBox[{
          RowBox[{"sectorsIn", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", "True"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"hin", "=", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Position", "[", 
         RowBox[{
          RowBox[{"sectorsIn", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", "True"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"eout", "=", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Position", "[", 
         RowBox[{
          RowBox[{"sectorsOut", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", "True"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"hout", "=", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Position", "[", 
         RowBox[{
          RowBox[{"sectorsOut", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", "True"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(", GridBox[{
         {
          RowBox[{"S", "[", 
           RowBox[{"[", 
            RowBox[{"eout", ",", "ein"}], "]"}], "]"}], 
          RowBox[{"S", "[", 
           RowBox[{"[", 
            RowBox[{"eout", ",", "hin"}], "]"}], "]"}]},
         {
          RowBox[{"S", "[", 
           RowBox[{"[", 
            RowBox[{"hout", ",", "ein"}], "]"}], "]"}], 
          RowBox[{"S", "[", 
           RowBox[{"[", 
            RowBox[{"hout", ",", "hin"}], "]"}], "]"}]}
        }], ")"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"DecomposeBTK", "[", 
   RowBox[{"S_", ",", "nambusectors2_", ",", " ", "nambusectors1_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "ein", ",", " ", "eout", ",", " ", "hin", ",", " ", "hout", ",", " ", 
      "sectorsIn", ",", "sectorsOut"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{
      "Nambu", " ", "sectors", " ", "take", " ", "the", " ", "form", " ", 
       RowBox[{"{", 
        RowBox[{"sectorsIn", ",", " ", "sectorsOut"}], "}"}]}], ",", " ", 
      RowBox[{
       RowBox[{"and", " ", 
        RowBox[{"sectorsIn", "/", "Out"}]}], "=", 
       RowBox[{"{", 
        RowBox[{"echaracter_List", ",", " ", "hcharacter_List"}], "}"}]}], 
      ",", " ", 
      RowBox[{
      "where", " ", "the", " ", "List", " ", "spans", " ", "propagating", " ",
        "modes"}]}], "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"sectorsIn", "=", 
      RowBox[{"First", "[", "nambusectors1", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"sectorsOut", "=", 
      RowBox[{"Last", "[", "nambusectors2", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"ein", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"Position", "[", 
        RowBox[{"sectorsIn", ",", "True"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"hin", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"Position", "[", 
        RowBox[{"sectorsIn", ",", "False"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"eout", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"Position", "[", 
        RowBox[{"sectorsOut", ",", "True"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"hout", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"Position", "[", 
        RowBox[{"sectorsOut", ",", "False"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(", GridBox[{
        {
         RowBox[{"S", "[", 
          RowBox[{"[", 
           RowBox[{"eout", ",", "ein"}], "]"}], "]"}], 
         RowBox[{"S", "[", 
          RowBox[{"[", 
           RowBox[{"eout", ",", "hin"}], "]"}], "]"}]},
        {
         RowBox[{"S", "[", 
          RowBox[{"[", 
           RowBox[{"hout", ",", "ein"}], "]"}], "]"}], 
         RowBox[{"S", "[", 
          RowBox[{"[", 
           RowBox[{"hout", ",", "hin"}], "]"}], "]"}]}
       }], ")"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.598194464547583*^9, 3.5981945430152187`*^9}, {
   3.598194620509551*^9, 3.598194693593541*^9}, {3.598194764311071*^9, 
   3.5981949341393957`*^9}, {3.59819498038983*^9, 3.5981951502750673`*^9}, {
   3.598199573768485*^9, 3.5981996449429817`*^9}, {3.598199701901145*^9, 
   3.598199703843484*^9}, {3.598246115020195*^9, 3.598246146187859*^9}, {
   3.598246780178731*^9, 3.598246885437562*^9}, {3.5982486482132187`*^9, 
   3.598248705312524*^9}, {3.598248800561047*^9, 3.5982488240365753`*^9}, 
   3.598248865257678*^9, {3.598251286221423*^9, 3.598251444326209*^9}, {
   3.598251530190065*^9, 3.598251540327456*^9}, {3.5982519106547813`*^9, 
   3.598251990486463*^9}, 3.598252294248844*^9, {3.598252329444284*^9, 
   3.598252331196136*^9}, {3.598253422945277*^9, 3.598253444494138*^9}, {
   3.598253849275717*^9, 3.59825389726048*^9}, {3.598256364395967*^9, 
   3.598256370361713*^9}, {3.59826631468082*^9, 3.5982663437149487`*^9}, {
   3.598266567601437*^9, 3.598266581739963*^9}, {3.598266716585198*^9, 
   3.598266732368548*^9}, {3.5982667994212017`*^9, 3.5982668130625*^9}, {
   3.5983350923258257`*^9, 3.598335112356346*^9}, {3.598341271003647*^9, 
   3.59834130908501*^9}, {3.598348581076412*^9, 3.598348587155492*^9}, 
   3.598630553616227*^9, {3.5991389859207373`*^9, 3.599138987928824*^9}, {
   3.599197699721683*^9, 3.599197700401576*^9}, {3.603180023055986*^9, 
   3.603180028837328*^9}, {3.603180501503955*^9, 3.6031805039756927`*^9}, {
   3.613457313523568*^9, 3.6134573552256203`*^9}, {3.61345740499921*^9, 
   3.613457586297488*^9}, {3.613457664587007*^9, 3.613457755807682*^9}, {
   3.613457793572998*^9, 3.613457991820055*^9}, {3.613458041347663*^9, 
   3.61345816290989*^9}, {3.61345822625119*^9, 3.613458459750042*^9}, {
   3.613458549170712*^9, 3.613458580356471*^9}, {3.62349252477284*^9, 
   3.623492539250202*^9}, {3.629641826859746*^9, 3.629641829250744*^9}, {
   3.637572355560684*^9, 3.6375723555810013`*^9}},
 CellLabel->
  "In[328]:=",ExpressionUUID->"f6149bd6-f663-4f54-a7fd-709c72552da6"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "GNambu", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"Options", "[", "Conductance", "]"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GNambu", "[", 
   RowBox[{
   "i_Integer", ",", "\[Omega]_", ",", "scatsys_MQScatteringSystem", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"GNambu", "[", 
   RowBox[{"i", ",", 
    RowBox[{"SolveScatteringSystem", "[", 
     RowBox[{"\[Omega]", ",", "scatsys", ",", " ", 
      RowBox[{"FilterRules", "[", 
       RowBox[{
        RowBox[{"{", "opts", "}"}], ",", " ", "SolveScatteringSystem"}], 
       "]"}]}], "]"}], ",", " ", "opts"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GNambu", "[", 
    RowBox[{"\[Omega]_", ",", "scatsys_MQScatteringSystem", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"GNambu", "[", 
    RowBox[{"1", ",", "\[Omega]", ",", "scatsys", ",", " ", "opts"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"GNambu", "[", "solution_MQSystemSolution", "]"}], ":=", 
    RowBox[{"GNambu", "[", 
     RowBox[{"1", ",", "solution"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GNambu", "[", 
    RowBox[{"i_Integer", ",", "solution_MQSystemSolution"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"ree", ",", " ", "rhe", ",", " ", "R"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"ree", ",", " ", "rhe"}], "}"}], "=", 
       RowBox[{"First", "@", 
        RowBox[{"Smatrix", "[", 
         RowBox[{"i", ",", "i", ",", "solution", ",", " ", 
          RowBox[{"BTK", "\[Rule]", "True"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"R", "[", 
        RowBox[{"list_", "/;", 
         RowBox[{
          RowBox[{"Flatten", "[", "list", "]"}], "===", 
          RowBox[{"{", "}"}]}]}], "]"}], "=", "0"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"R", "[", "r_", "]"}], ":=", 
       RowBox[{"Tr", "[", 
        RowBox[{
         RowBox[{"r", "\[HermitianConjugate]"}], ".", "r"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Length", "[", "ree", "]"}], "+", 
       RowBox[{"R", "[", "rhe", "]"}], "-", 
       RowBox[{"R", "[", "ree", "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.6134498006097918`*^9, 3.613449984869892*^9}, {
   3.613450071801964*^9, 3.613450081625168*^9}, {3.613453651239367*^9, 
   3.613453718019525*^9}, {3.613453754002075*^9, 3.6134539341138897`*^9}, {
   3.61345400523986*^9, 3.613454007285933*^9}, {3.61345403818045*^9, 
   3.6134540386375*^9}, {3.61345430600173*^9, 3.6134543196608343`*^9}, {
   3.613455895912607*^9, 3.613456030897183*^9}, {3.6134561849151287`*^9, 
   3.613456252958313*^9}, {3.613456308172735*^9, 3.6134563711924667`*^9}, {
   3.613457185497766*^9, 3.613457294482621*^9}, {3.613458475400749*^9, 
   3.613458536112409*^9}, {3.61345859537088*^9, 3.613458705566345*^9}, {
   3.6278309407613487`*^9, 3.627830955951329*^9}, {3.627830996721221*^9, 
   3.627830999463459*^9}, {3.629641829905836*^9, 3.629641831745791*^9}, {
   3.6352362080775537`*^9, 3.63523620808908*^9}, {3.637572355589068*^9, 
   3.637572355596776*^9}, 3.708075061736693*^9},
 CellLabel->
  "In[338]:=",ExpressionUUID->"585fdc2b-29dc-4191-a8bc-37fe0b7c3076"],

Cell["Scattering states", "Text",
 CellChangeTimes->{{3.603099485172962*^9, 
  3.603099490228487*^9}},ExpressionUUID->"31868ee5-77ab-4533-9c72-\
3e00623f4c1a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"LeadCells", "::", "usage"}], "=", 
   "\"\<Option for ScatteringStates that specifies the number of unit cells \
in each lead to include in the calculation of scattered states\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ScatteringStates", "::", "usage"}], "=", 
    "\"\<Returns scatterins states both in the central region and in the \
leads. Indices of central states are \!\(\*SubscriptBox[\(C\), \(leain - in, \
mode, site, orbital\)]\), and for lead states \!\(\*SubscriptBox[\(L\), \
\(lead - in, \\\ mode, lead - out, leadout - cell, \\\ \\\ site, \\\ \
orbital\)]\).\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "ScatteringStates", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"LeadCells", "\[Rule]", "1"}], ",", 
       RowBox[{"Options", "[", "SolveScatteringSystem", "]"}]}], "}"}]}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ScatteringStates", "[", 
    RowBox[{
     RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", 
     "scatsys_MQScatteringSystem", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"ScatteringStates", "[", 
    RowBox[{"\[Omega]", ",", 
     RowBox[{"SolveScatteringSystem", "[", 
      RowBox[{"\[Omega]", ",", "scatsys", ",", "\[IndentingNewLine]", 
       RowBox[{"ProjectOutBulk", "\[Rule]", "False"}], ",", 
       RowBox[{"IncludeExtraData", "->", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"IntegerQ", "@", 
            RowBox[{"OptionValue", "[", "LeadCells", "]"}]}], "&&", 
           RowBox[{
            RowBox[{"OptionValue", "[", "LeadCells", "]"}], ">", "0"}]}], ",",
           "True", ",", " ", "False"}], "]"}]}], ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "[", "SolveScatteringSystem", "]"}]}], "]"}]}], 
      "]"}], ",", " ", "opts"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ScatteringStates", "[", 
    RowBox[{
     RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "solution_MQSystemSolution",
      ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "WS", ",", " ", "psi", ",", "G", ",", " ", "WGWc", ",", "leadsol", ",", 
       "\[Phi]InP", ",", "\[Lambda]InP", ",", "\[Phi]Out", ",", 
       "\[Lambda]Out", ",", "r0Full", ",", "invphigFull", ",", "numleads", 
       ",", " ", "centralstates", ",", 
       RowBox[{"scatteredstates", "=", 
        RowBox[{"{", "}"}]}], ",", " ", "dimsites", ",", " ", 
       RowBox[{"leadcells", "=", 
        RowBox[{"OptionValue", "[", "LeadCells", "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dimsites", "=", 
       RowBox[{"solution", "[", "\"\<SiteDimensions\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"WS", "=", 
       RowBox[{"solution", "[", "\"\<CouplingsSurface\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"G", "=", 
       RowBox[{"solution", "[", "\"\<G\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"psi", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"#", "[", "\"\<psiSurface\>\"", "]"}], "&"}], "/@", 
        RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"WGWc", "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{"WS", ".", "G", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"WS", "\[Conjugate]"}], ",", 
              RowBox[{"{", 
               RowBox[{"3", ",", "2", ",", "1"}], "}"}]}], "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}]}], 
        ";"}], "*)"}], " ", 
      RowBox[{"(*", 
       RowBox[{
       "This", " ", "fails", " ", "when", " ", "different", " ", "lead", " ", 
        "surface", " ", "have", " ", "different", " ", "sizes"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"WGWc", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"WS", "[", 
           RowBox[{"[", "lp", "]"}], "]"}], ".", "G", ".", 
          RowBox[{
           RowBox[{"WS", "[", 
            RowBox[{"[", "l", "]"}], "]"}], "\[HermitianConjugate]"}]}], ",", 
         
         RowBox[{"{", 
          RowBox[{"lp", ",", "1", ",", 
           RowBox[{"Length", "@", "WS"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"l", ",", "1", ",", 
           RowBox[{"Length", "@", "WS"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Precomputing", " ", "this", " ", 
         SubscriptBox["WGWc", 
          RowBox[{
           RowBox[{"l", "'"}], "l"}]]}], "=", 
        RowBox[{
         RowBox[{
          SubscriptBox["W", 
           RowBox[{
            RowBox[{"l", "'"}], ",", "ij"}]], ".", 
          SubscriptBox["G", "jk"], ".", 
          SubscriptBox[
           RowBox[{"(", 
            RowBox[{"W", "\[Conjugate]"}], ")"}], 
           RowBox[{"km", ",", "l"}]]}], " ", "accelerates", " ", "by", " ", 
         "around", " ", "a", " ", "factor", " ", "4"}]}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"centralstates", "=", 
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"#2", "===", 
             RowBox[{"{", "}"}]}], ",", 
            RowBox[{"{", "}"}], ",", 
            RowBox[{"Transpose", "[", 
             RowBox[{"G", ".", 
              RowBox[{"#1", "\[HermitianConjugate]"}], ".", "#2"}], "]"}]}], 
           "]"}], "&"}], ",", 
         RowBox[{"{", 
          RowBox[{"WS", ",", "psi"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"centralstates", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", "dimsites"}], "]"}], "&"}], ",", "centralstates",
          ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"IntegerQ", "@", "leadcells"}], "&&", 
         RowBox[{"leadcells", ">", "0"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"numleads", "=", 
          RowBox[{"solution", "[", "\"\<NumberOfLeads\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Phi]InP", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"\"\<\[Phi]InP\>\"", "/.", 
             RowBox[{"#", "[", "\"\<ExtraData\>\"", "]"}]}], "&"}], "/@", 
           RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Lambda]InP", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"\"\<\[Lambda]InP\>\"", "/.", 
             RowBox[{"#", "[", "\"\<ExtraData\>\"", "]"}]}], "&"}], "/@", 
           RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Phi]Out", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"\"\<\[Phi]Out\>\"", "/.", 
             RowBox[{"#", "[", "\"\<ExtraData\>\"", "]"}]}], "&"}], "/@", 
           RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Lambda]Out", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"\"\<\[Lambda]Out\>\"", "/.", 
             RowBox[{"#", "[", "\"\<ExtraData\>\"", "]"}]}], "&"}], "/@", 
           RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"r0Full", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"\"\<r0Full\>\"", "/.", 
             RowBox[{"#", "[", "\"\<ExtraData\>\"", "]"}]}], "&"}], "/@", 
           RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"invphigFull", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"\"\<invphigFull\>\"", "/.", 
             RowBox[{"#", "[", "\"\<ExtraData\>\"", "]"}]}], "&"}], "/@", 
           RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         
         RowBox[{"scatteredstates", "=", "\[IndentingNewLine]", 
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"psi", "[", 
                  RowBox[{"[", "leadIn", "]"}], "]"}], "===", 
                 RowBox[{"{", "}"}]}], ",", 
                RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
                RowBox[{"Transpose", "/@", 
                 RowBox[{"Join", "[", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"leadIn", "\[Equal]", "leadOut"}], ",", 
                    RowBox[{
                    RowBox[{"\[Phi]InP", "[", 
                    RowBox[{"[", "leadOut", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"\[Phi]Out", "[", 
                    RowBox[{"[", "leadOut", "]"}], "]"}], ".", 
                    RowBox[{"r0Full", "[", 
                    RowBox[{"[", "leadIn", "]"}], "]"}]}]}], ",", "0"}], 
                    "]"}], "+", 
                    RowBox[{
                    RowBox[{"\[Phi]Out", "[", 
                    RowBox[{"[", "leadOut", "]"}], "]"}], ".", 
                    RowBox[{"invphigFull", "[", 
                    RowBox[{"[", "leadOut", "]"}], "]"}], ".", 
                    RowBox[{"WGWc", "[", 
                    RowBox[{"[", 
                    RowBox[{"leadOut", ",", " ", "leadIn"}], "]"}], "]"}], 
                    ".", 
                    RowBox[{"psi", "[", 
                    RowBox[{"[", "leadIn", "]"}], "]"}]}]}], "}"}], ",", 
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"leadIn", "\[Equal]", "leadOut"}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"\[Phi]InP", "[", 
                    RowBox[{"[", "leadIn", "]"}], "]"}], ".", 
                    RowBox[{"DiagonalMatrix", "[", 
                    SuperscriptBox[
                    RowBox[{"\[Lambda]InP", "[", 
                    RowBox[{"[", "leadIn", "]"}], "]"}], 
                    RowBox[{"#", "-", "1"}]], "]"}]}], "+", 
                    RowBox[{
                    RowBox[{"\[Phi]Out", "[", 
                    RowBox[{"[", "leadIn", "]"}], "]"}], ".", 
                    RowBox[{"DiagonalMatrix", "[", 
                    SuperscriptBox[
                    RowBox[{"\[Lambda]Out", "[", 
                    RowBox[{"[", "leadIn", "]"}], "]"}], 
                    RowBox[{"#", "-", "1"}]], "]"}], ".", 
                    RowBox[{"r0Full", "[", 
                    RowBox[{"[", "leadIn", "]"}], "]"}]}]}], ",", "0"}], 
                    "]"}], "+", 
                    RowBox[{
                    RowBox[{"\[Phi]Out", "[", 
                    RowBox[{"[", "leadOut", "]"}], "]"}], ".", 
                    RowBox[{"DiagonalMatrix", "[", 
                    SuperscriptBox[
                    RowBox[{"\[Lambda]Out", "[", 
                    RowBox[{"[", "leadOut", "]"}], "]"}], 
                    RowBox[{"#", "-", "1"}]], "]"}], ".", 
                    RowBox[{"invphigFull", "[", 
                    RowBox[{"[", "leadOut", "]"}], "]"}], ".", 
                    RowBox[{"WGWc", "[", 
                    RowBox[{"[", 
                    RowBox[{"leadOut", ",", " ", "leadIn"}], "]"}], "]"}], 
                    ".", 
                    RowBox[{"psi", "[", 
                    RowBox[{"[", "leadIn", "]"}], "]"}]}]}], "&"}], "/@", 
                    RowBox[{"Range", "[", 
                    RowBox[{"2", ",", "leadcells"}], "]"}]}]}], "]"}]}]}], 
               "]"}], ",", "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{"leadOut", ",", "1", ",", "numleads"}], "}"}]}], "]"}],
             ",", "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"leadIn", ",", "1", ",", "numleads"}], "}"}]}], "]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"scatteredstates", "=", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Partition", "[", 
              RowBox[{"#", ",", "dimsites"}], "]"}], "&"}], ",", 
            "scatteredstates", ",", 
            RowBox[{"{", "4", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"scatteredstates", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Flatten", "[", "#", "]"}], "===", 
               RowBox[{"{", "}"}]}], ",", 
              RowBox[{"{", "}"}], ",", 
              RowBox[{"Transpose", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"2", ",", "3", ",", "1"}], "}"}]}], "]"}]}], "]"}], 
            "&"}], "/@", "scatteredstates"}]}]}]}], "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"This", " ", "changes", " ", 
          SubscriptBox["L", 
           RowBox[{
            RowBox[{"lead", "-", "in"}], ",", 
            RowBox[{"lead", "-", "out"}], ",", 
            RowBox[{"leadout", "-", "repetition"}], ",", "mode", ",", "site", 
            ",", "orbital"}]], " ", "into", " ", 
          SubscriptBox["L", 
           RowBox[{
            RowBox[{"lead", "-", "in"}], ",", " ", "mode", ",", 
            RowBox[{"lead", "-", "out"}], ",", 
            RowBox[{"leadout", "-", "repetition"}], ",", "site", ",", 
            "orbital"}]]}], ",", " ", 
         RowBox[{
          RowBox[{
          "unless", " ", "there", " ", "is", " ", "no", " ", "incoming", " ", 
           "mode", " ", "in", " ", "lead"}], "-", "in"}]}], "*)"}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"MQScatteringStates", "[", 
       RowBox[{
        RowBox[{"\"\<CentralStates\>\"", "->", "centralstates"}], ",", 
        RowBox[{"\"\<ScatteredStates\>\"", "->", "scatteredstates"}], ",", 
        " ", 
        RowBox[{"\"\<Nambu\>\"", "\[Rule]", 
         RowBox[{"solution", "[", "\"\<Nambu\>\"", "]"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Lead", "::", "usage"}], "=", 
   "\"\<Option for PlotScatteringStates that specifies the incoming lead for \
scattering states to plot.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Modes", "::", "usage"}], "=", 
    "\"\<Option for PlotScatteringStates that specifies which scattering \
states to plot.\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "PlotScatteringStates", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Lead", "\[Rule]", "1"}], ",", 
       RowBox[{"Modes", "\[Rule]", "All"}], ",", " ", 
       RowBox[{"Options", "[", "PlotField", "]"}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotScatteringStates", "[", 
    RowBox[{
    "scatsys_MQScatteringSystem", ",", "states_MQScatteringStates", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"PlotScatteringStates", "[", 
    RowBox[{
     RowBox[{"scatsys", "[", "\"\<Lattice\>\"", "]"}], ",", "states", ",", 
     " ", "opts"}], "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotScatteringStates", "[", 
    RowBox[{"centrallattice_MQLattice", ",", "states_MQScatteringStates", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"PlotField", "[", 
      RowBox[{"centrallattice", ",", "#", ",", " ", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "[", "PlotEigenstates", "]"}]}], "]"}]}], "]"}], 
     "&"}], "/@", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"states", "[", "\"\<CentralStates\>\"", "]"}], "[", 
     RowBox[{"[", 
      RowBox[{
       RowBox[{"OptionValue", "[", "Lead", "]"}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"#", "===", "All"}], ",", "All", ",", 
           RowBox[{"Flatten", "@", 
            RowBox[{"{", "#", "}"}]}]}], "]"}], "&"}], "@", 
        RowBox[{"OptionValue", "[", "Modes", "]"}]}]}], "]"}], "]"}]}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "We", " ", "need", " ", "to", " ", "use", " ", "Module", " ", "here", " ", 
    "to", " ", "avoid", " ", "conflict", " ", "with", " ", "function", " ", 
    "names", " ", "in", " ", "MaskRegion"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotScatteringStates", "[", 
   RowBox[{
    RowBox[{"{", "lattices__MQLattice", "}"}], ",", 
    "states_MQScatteringStates", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "leadcells", ",", "central", ",", " ", "leads", ",", " ", "scatstates", 
      ",", "centralstates", ",", " ", "expandedleads", ",", "expandedlattice",
       ",", " ", "expandedeigenstate", ",", " ", "gr"}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
     "Build", " ", "states", " ", "in", " ", "expanded", " ", "lattice"}], 
     "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"scatstates", "=", 
      RowBox[{
       RowBox[{"states", "[", "\"\<ScatteredStates\>\"", "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"OptionValue", "[", "Lead", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"scatstates", "===", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"{", "}"}], "]"}]}], "]"}], ";", 
     RowBox[{"(*", 
      RowBox[{
      "No", " ", "incoming", " ", "states", " ", "in", " ", "selected", " ", 
       "lead"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"scatstates", "=", 
      RowBox[{"scatstates", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"#", "===", "All"}], ",", "All", ",", 
             RowBox[{"Flatten", "@", 
              RowBox[{"{", "#", "}"}]}]}], "]"}], "&"}], "@", 
          RowBox[{"OptionValue", "[", "Modes", "]"}]}]}], "]"}], "]"}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"centralstates", "=", 
      RowBox[{
       RowBox[{"states", "[", "\"\<CentralStates\>\"", "]"}], "[", 
       RowBox[{"[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "Lead", "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"#", "===", "All"}], ",", "All", ",", 
             RowBox[{"Flatten", "@", 
              RowBox[{"{", "#", "}"}]}]}], "]"}], "&"}], "@", 
          RowBox[{"OptionValue", "[", "Modes", "]"}]}]}], "]"}], "]"}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"scatstates", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{"#", ",", "2"}], "]"}], "&"}], "/@", "scatstates"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "This", " ", "merges", " ", "the", " ", "sites", " ", "of", " ", "all", 
       " ", "leadout", " ", "and", " ", "their", " ", "repetitions"}], "*)"}],
      "\[IndentingNewLine]", 
     RowBox[{"expandedeigenstate", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{"Join", ",", 
        RowBox[{"{", 
         RowBox[{"centralstates", ",", "scatstates"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Build", " ", "expanded", " ", "lattice"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"leadcells", "=", 
      RowBox[{
       RowBox[{"states", "[", "\"\<LeadCells\>\"", "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"OptionValue", "[", "Lead", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"central", "=", 
      RowBox[{"First", "@", 
       RowBox[{"{", "lattices", "}"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"leads", "=", 
      RowBox[{"Rest", "@", 
       RowBox[{"{", "lattices", "}"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"expandedleads", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"lat", ",", " ", "rep"}], "}"}], ",", 
          RowBox[{"CombineLattices", "@@", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"TransformLattice", "[", 
              RowBox[{"lat", ",", 
               RowBox[{
                RowBox[{"#", "+", 
                 RowBox[{"n", " ", 
                  RowBox[{"First", "@", 
                   RowBox[{"lat", "[", "\"\<BravaisVectors\>\"", "]"}]}]}]}], 
                "&"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"n", ",", "0", ",", 
               RowBox[{"rep", "-", "1"}]}], "}"}]}], "]"}]}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"leads", ",", "leadcells"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"expandedleads", "=", 
      RowBox[{"(*", 
       RowBox[{"FlattenTags", "@"}], "*)"}], 
      RowBox[{
       RowBox[{
        RowBox[{"BuildLattice", "[", 
         RowBox[{"#", ",", 
          RowBox[{"Bounded", "\[Rule]", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Axes", "\[Rule]", "All"}], ",", 
             RowBox[{"Region", "\[Rule]", "None"}]}], "}"}]}]}], "]"}], "&"}],
        "/@", "expandedleads"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"FlattenTags", " ", "should", " ", "be", " ", 
        RowBox[{"avoided", ":", " ", 
         RowBox[{"it", " ", "reorders", " ", "sites"}]}]}], ",", " ", 
       RowBox[{
       "which", " ", "spoils", " ", "the", " ", "correspondence", " ", "with",
         " ", "scatstates"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"expandedlattice", "=", 
      RowBox[{"CombineLattices", "@@", 
       RowBox[{"Flatten", "[", 
        RowBox[{"{", 
         RowBox[{"central", ",", "expandedleads"}], "}"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"PlotField", "[", 
        RowBox[{"expandedlattice", ",", "#", ",", " ", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", 
           RowBox[{"Options", "[", "PlotField", "]"}]}], "]"}], ",", " ", 
         RowBox[{"Overlay", "\[Rule]", "False"}]}], "]"}], "&"}], "/@", 
      "expandedeigenstate"}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.603099627158285*^9, 3.603099737797558*^9}, {
   3.603099968511957*^9, 3.603100055811348*^9}, {3.603100144490649*^9, 
   3.60310027224946*^9}, {3.6031005757902937`*^9, 3.6031006207465887`*^9}, {
   3.603101121306492*^9, 3.603101132405924*^9}, {3.603101281846202*^9, 
   3.6031012967047853`*^9}, {3.603106467527647*^9, 3.603106662594871*^9}, {
   3.60310672406448*^9, 3.6031068064753227`*^9}, {3.603106920931587*^9, 
   3.6031069522086487`*^9}, {3.6031069865990963`*^9, 3.60310706432769*^9}, {
   3.603107138676483*^9, 3.6031071669699383`*^9}, {3.603107262164192*^9, 
   3.603107280206574*^9}, {3.603107317344705*^9, 3.6031073475700703`*^9}, {
   3.603107746805155*^9, 3.603107760642166*^9}, {3.603107827877503*^9, 
   3.603107864619988*^9}, {3.6031079404312677`*^9, 3.6031079767565517`*^9}, {
   3.603108011046916*^9, 3.603108012564362*^9}, {3.603108075589654*^9, 
   3.60310808279652*^9}, {3.6031081338576813`*^9, 3.6031082043333483`*^9}, {
   3.6031737464394827`*^9, 3.603173751193059*^9}, {3.603174057863874*^9, 
   3.603174082274743*^9}, {3.603174128836933*^9, 3.60317417350504*^9}, 
   3.603176437089459*^9, {3.603177725027795*^9, 3.603177808676298*^9}, {
   3.60317787429802*^9, 3.603177923125772*^9}, {3.603178524484919*^9, 
   3.6031785883963737`*^9}, {3.603178641765136*^9, 3.603178739214428*^9}, {
   3.603178777453107*^9, 3.603178786595284*^9}, {3.603178816688547*^9, 
   3.603178827968574*^9}, {3.603178864173661*^9, 3.6031789084438*^9}, {
   3.60317900858086*^9, 3.603179017419853*^9}, {3.603179083015996*^9, 
   3.6031791325324717`*^9}, {3.603179175185931*^9, 3.60317917851298*^9}, 
   3.603179404762004*^9, {3.603179464344256*^9, 3.603179472615509*^9}, {
   3.6031795042047243`*^9, 3.6031795058356247`*^9}, 3.6031800331234837`*^9, {
   3.603180264249208*^9, 3.6031802970749207`*^9}, 3.6031804107929363`*^9, {
   3.603180506792351*^9, 3.6031805112065268`*^9}, {3.6031806031709948`*^9, 
   3.60318064048326*^9}, {3.603180833692198*^9, 3.6031809079408484`*^9}, {
   3.603181134029908*^9, 3.603181136190386*^9}, {3.603181723543879*^9, 
   3.6031817312693768`*^9}, {3.60319003544706*^9, 3.603190172272276*^9}, 
   3.603190217868181*^9, {3.603190531687148*^9, 3.603190532605818*^9}, {
   3.60319076688561*^9, 3.603190856759486*^9}, {3.6031908915810833`*^9, 
   3.6031910240273333`*^9}, {3.6031910618994703`*^9, 3.60319107670827*^9}, {
   3.6031911276079273`*^9, 3.6031911790731077`*^9}, {3.6031912142073174`*^9, 
   3.603191313497477*^9}, {3.60319135476705*^9, 3.603191438737733*^9}, {
   3.603191473551526*^9, 3.603191685217152*^9}, {3.603191764152067*^9, 
   3.6031917654857807`*^9}, {3.603191838487495*^9, 3.6031918457907887`*^9}, {
   3.6031918871898527`*^9, 3.603191902485324*^9}, 3.603191934617549*^9, {
   3.603192012636096*^9, 3.603192081804902*^9}, {3.603192125781497*^9, 
   3.603192131850909*^9}, 3.603192170483487*^9, {3.603192214494356*^9, 
   3.603192221077845*^9}, {3.6031924988198767`*^9, 3.603192539607254*^9}, {
   3.60319300457754*^9, 3.603193036237362*^9}, {3.6031932079702787`*^9, 
   3.603193241663842*^9}, {3.603193276014206*^9, 3.603193351352928*^9}, {
   3.60319377689965*^9, 3.6031938327282143`*^9}, {3.6031945244670563`*^9, 
   3.6031945748142347`*^9}, {3.60319461866825*^9, 3.60319473898775*^9}, {
   3.603194795456801*^9, 3.603194816238392*^9}, {3.603194927432363*^9, 
   3.603195007058975*^9}, {3.6031950493906393`*^9, 3.603195052396315*^9}, {
   3.603195108482966*^9, 3.603195135560454*^9}, {3.6031951681897306`*^9, 
   3.603195222754924*^9}, {3.603195280599679*^9, 3.603195293857767*^9}, {
   3.603195428836547*^9, 3.603195635133504*^9}, {3.603195707128161*^9, 
   3.603195769374208*^9}, {3.603195887981511*^9, 3.603195915105582*^9}, {
   3.603195975022781*^9, 3.603196161617284*^9}, {3.6031962189585457`*^9, 
   3.603196272894011*^9}, {3.60319631786475*^9, 3.603196376437701*^9}, 
   3.603533460188272*^9, {3.6035336741456947`*^9, 3.603533761193693*^9}, {
   3.603533821227206*^9, 3.603533934825251*^9}, {3.603534042946588*^9, 
   3.6035341993947697`*^9}, {3.603534278756329*^9, 3.6035343149439096`*^9}, {
   3.603534456154175*^9, 3.603534476378639*^9}, 3.60353647931177*^9, {
   3.6035365619366207`*^9, 3.603536562810731*^9}, {3.603536618995947*^9, 
   3.603536649536736*^9}, {3.603536685120386*^9, 3.603536727092293*^9}, {
   3.603536766690143*^9, 3.603536816175025*^9}, {3.603536905433826*^9, 
   3.60353693217439*^9}, {3.603537000122966*^9, 3.603537000411283*^9}, {
   3.6035370351583443`*^9, 3.6035370499605303`*^9}, {3.603537148929603*^9, 
   3.6035371877172832`*^9}, {3.603537406649015*^9, 3.603537474610427*^9}, {
   3.603537536721444*^9, 3.603537600296851*^9}, {3.6035376378936453`*^9, 
   3.6035376982292957`*^9}, {3.603537751694828*^9, 3.603537816111535*^9}, {
   3.603537859728601*^9, 3.603537866182974*^9}, {3.603537975367757*^9, 
   3.603537995742919*^9}, {3.603538159684743*^9, 3.6035381599881277`*^9}, {
   3.603538741607916*^9, 3.603538748325466*^9}, {3.603538782749218*^9, 
   3.603538850127223*^9}, {3.603538923402281*^9, 3.603539055693863*^9}, {
   3.6035392185349503`*^9, 3.603539226558907*^9}, {3.603539286274479*^9, 
   3.6035393142983713`*^9}, {3.603539997778941*^9, 3.6035399995542316`*^9}, {
   3.6035400694615593`*^9, 3.603540070405779*^9}, {3.6035401165047894`*^9, 
   3.60354012068569*^9}, {3.603540158453506*^9, 3.60354015928498*^9}, {
   3.6035412541337957`*^9, 3.603541258804556*^9}, 3.603541692656781*^9, {
   3.603541739155347*^9, 3.6035417478861732`*^9}, {3.603541973775052*^9, 
   3.603541975781054*^9}, {3.603542019579208*^9, 3.603542020577896*^9}, {
   3.6035421700386353`*^9, 3.603542170865717*^9}, {3.6036231518852873`*^9, 
   3.6036231589552507`*^9}, {3.603623208961287*^9, 3.603623222047441*^9}, {
   3.603623380322291*^9, 3.60362338417015*^9}, {3.603623446977951*^9, 
   3.603623448431513*^9}, {3.6036235262035713`*^9, 3.6036235423849287`*^9}, 
   3.603623584063896*^9, {3.6036251540781097`*^9, 3.603625198051251*^9}, {
   3.603625241455462*^9, 3.6036252436302357`*^9}, {3.60362607856674*^9, 
   3.603626108043233*^9}, {3.603626595890621*^9, 3.603626622289691*^9}, {
   3.60362811337311*^9, 3.6036281575482492`*^9}, 3.603628233953986*^9, 
   3.603644370183342*^9, {3.603644433783486*^9, 3.603644472459395*^9}, {
   3.603644755475758*^9, 3.60364475860363*^9}, {3.603706053996304*^9, 
   3.603706090197302*^9}, {3.603706148462666*^9, 3.603706346575938*^9}, {
   3.6037063918781757`*^9, 3.603706400437766*^9}, {3.603706560411942*^9, 
   3.603706575497814*^9}, {3.603706622184319*^9, 3.603706753566061*^9}, {
   3.60370680306811*^9, 3.603706828018873*^9}, {3.603706943323037*^9, 
   3.6037069937421503`*^9}, {3.603707029892495*^9, 3.603707051595059*^9}, {
   3.603707121406331*^9, 3.603707124204627*^9}, {3.6037072769628153`*^9, 
   3.603707316856057*^9}, {3.603707352974614*^9, 3.603707368748106*^9}, {
   3.603707417177387*^9, 3.6037074451652613`*^9}, {3.603707539120343*^9, 
   3.6037076396744843`*^9}, {3.603707980540477*^9, 3.603708085649601*^9}, 
   3.614752083591959*^9, {3.61995051695105*^9, 3.619950525723898*^9}, {
   3.619950575419178*^9, 3.619950576505279*^9}, {3.619961372285451*^9, 
   3.619961402261634*^9}, {3.619963351617599*^9, 3.619963374897066*^9}, {
   3.619963858520563*^9, 3.619963918795788*^9}, {3.6199639602511044`*^9, 
   3.619964032546905*^9}, {3.619964099738388*^9, 3.6199641760054626`*^9}, {
   3.62019453470265*^9, 3.6201945353021803`*^9}, 3.6215910592279987`*^9, {
   3.621591158542595*^9, 3.621591176875575*^9}, {3.62159123705847*^9, 
   3.621591249816345*^9}, {3.622284983626628*^9, 3.62228501097682*^9}, {
   3.6222867313332853`*^9, 3.622286766531246*^9}, 3.622286848802662*^9, {
   3.623478491101177*^9, 3.623478542570694*^9}, 3.623478615145095*^9, {
   3.623481444758522*^9, 3.623481453069862*^9}, 3.6234815163265543`*^9, {
   3.623482028781048*^9, 3.623482127618073*^9}, {3.623482158136786*^9, 
   3.623482160785816*^9}, {3.623482268139001*^9, 3.623482281597719*^9}, {
   3.62348231333249*^9, 3.623482363522808*^9}, {3.6234824458642673`*^9, 
   3.623482494031994*^9}, {3.6234825914048347`*^9, 3.6234826245055933`*^9}, {
   3.623482677048925*^9, 3.623482705424312*^9}, {3.6234827546235228`*^9, 
   3.623482754830406*^9}, {3.623482898178121*^9, 3.6234830489178667`*^9}, {
   3.623483107668144*^9, 3.623483126667815*^9}, {3.623483205968916*^9, 
   3.623483243039637*^9}, {3.623483302478565*^9, 3.6234833211169853`*^9}, {
   3.623483413154895*^9, 3.6234834314814034`*^9}, {3.623483732895879*^9, 
   3.623483736112767*^9}, {3.6234844173375597`*^9, 3.623484519589574*^9}, {
   3.6234845864156713`*^9, 3.62348459589332*^9}, {3.623484636566346*^9, 
   3.623484801790203*^9}, {3.629641832316925*^9, 3.629641855546596*^9}, {
   3.637572355614861*^9, 3.637572355629579*^9}, {3.649995944261649*^9, 
   3.649995961568421*^9}, {3.649995998550329*^9, 3.649996018364455*^9}, 
   3.649996054022046*^9},
 CellLabel->
  "In[343]:=",ExpressionUUID->"37a4c006-937c-4841-96cc-9f349e9a8851"],

Cell["Supercurrents", "Text",
 CellChangeTimes->{{3.603099481637151*^9, 
  3.6030994834609423`*^9}},ExpressionUUID->"59cb92fd-9644-4180-a2fe-\
d1eba58b6ea3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "This", " ", "should", " ", "be", " ", "fed", " ", "a", " ", "spectrum", 
     " ", "as", " ", "obtained", " ", "from", " ", 
     RowBox[{"Sample", "[", 
      RowBox[{
       RowBox[{"Spectrum", "[", 
        RowBox[{"system", "[", "\[Phi]", "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"\[Phi]", ",", "0", ",", 
         RowBox[{"2", "\[Pi]"}]}], "}"}], ",", " ", 
       RowBox[{"SamplingFunction", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{"1", "&"}], ")"}]}], ",", 
       RowBox[{"MaxRecursion", "\[Rule]", "0"}]}], "]"}]}], ";"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "Note", " ", "that", " ", "the", " ", "current", " ", "units", " ", "is", 
     " ", 
     RowBox[{"e", "/", "\[HBar]"}]}], ",", " ", 
    RowBox[{
     RowBox[{"times", " ", "the", " ", "energy", " ", 
      RowBox[{"units", ".", "\[IndentingNewLine]", "IJosephson"}]}], "=", 
     RowBox[{
      RowBox[{"-", 
       RowBox[{"(", 
        RowBox[{"e", "/", "\[HBar]"}], ")"}]}], " ", 
      RowBox[{"d\[Epsilon]", "/", "d\[Phi]"}]}]}], ",", " ", 
    RowBox[{"summed", " ", "over", " ", "positive", " ", "\[Epsilon]", " ", 
     RowBox[{"only", ".", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Eq", " ", 
         RowBox[{"(", "7", ")"}], " ", "in", " ", 
         RowBox[{"T", ".", "Yokoyama"}]}], ",", 
        RowBox[{"M", ".", "Eto"}], ",", 
        RowBox[{"and", " ", 
         RowBox[{
         "Y", ".", "V", ".", "Nazarov", ".", " ", "Phys", ".", "Rev", ".", 
          "B"}], " ", "89"}], ",", 
        RowBox[{"195407", " ", 
         RowBox[{"(", "2014", ")"}]}]}], ")"}]}], "\[IndentingNewLine]", " ", 
     "The", " ", "sum", " ", "is", " ", "performed", " ", "here", " ", "over",
      " ", "all", " ", "the", " ", "spectrum"}], ",", " ", 
    RowBox[{"hence", " ", "the", " ", "extra", " ", 
     RowBox[{"1", "/", "2"}], " ", 
     RowBox[{"resp", ".", " ", "the"}], " ", "paper", " ", "above"}]}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"kBT", "::", "usage"}], " ", "=", " ", 
     "\"\<Temperature time Boltzman constant. An option in a number of \
routines.\>\""}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "JosephsonCurrent", "]"}], "=", 
     RowBox[{"Flatten", "@", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Options", "[", "Spectrum", "]"}], ",", 
        RowBox[{"Options", "[", "Sample", "]"}], ",", " ", 
        RowBox[{"kBT", "\[Rule]", "0"}]}], "}"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"JosephsonCurrent", "[", 
     RowBox[{"system_MQSystem", ",", "\[Phi]_Symbol", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"kBT", "=", 
         RowBox[{"OptionValue", "[", "kBT", "]"}]}], ",", 
        RowBox[{"spec", "=", 
         RowBox[{"Sample", "[", 
          RowBox[{
           RowBox[{"Spectrum", "[", 
            RowBox[{"system", ",", " ", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", "opts", "}"}], ",", " ", 
               RowBox[{"Options", "[", "Spectrum", "]"}]}], "]"}]}], "]"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"\[Phi]", ",", "0", ",", 
             RowBox[{"2", "\[Pi]"}]}], "}"}], ",", " ", 
           RowBox[{"SamplingFunction", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{"1", "&"}], ")"}]}], ",", 
           RowBox[{"MaxRecursion", "\[Rule]", "0"}], ",", 
           RowBox[{"Evaluate", "@", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", " ", 
              RowBox[{"Options", "[", "Sample", "]"}]}], "]"}]}]}], "]"}]}]}],
        "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"JosephsonCurrentS", "[", 
       RowBox[{"spec", ",", "kBT"}], "]"}]}], "]"}]}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"JosephsonCurrentS", "[", "spectrum_List", "]"}], ":=", 
    RowBox[{"JosephsonCurrentS", "[", 
     RowBox[{"spectrum", ",", "0"}], "]"}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"JosephsonCurrentS", "[", 
     RowBox[{"spectrum_List", ",", "0."}], "]"}], ":=", 
    RowBox[{"JosephsonCurrentS", "[", 
     RowBox[{"spectrum", ",", "0"}], "]"}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"JosephsonCurrentS", "[", 
     RowBox[{"spectrum_List", ",", "0"}], "]"}], ":=", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"MovingAverage", "[", 
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}], ",", 
         
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "/", 
            RowBox[{"#", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], "&"}], "/@", 
          RowBox[{"Differences", "[", "#", "]"}]}]}], "}"}], "\[Transpose]"}],
       "&"}], "@", 
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"#1", ",", 
          RowBox[{"Total", "[", 
           RowBox[{
            FractionBox[
             RowBox[{"-", "1"}], "2"], 
            RowBox[{"Abs", "[", "#2", "]"}]}], "]"}]}], "}"}], "&"}], ",", 
       RowBox[{"spectrum", "\[Transpose]"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"JosephsonCurrentS", "[", 
     RowBox[{"spectrum_List", ",", 
      RowBox[{"kBT_", "?", "NumericQ"}]}], "]"}], ":=", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"MovingAverage", "[", 
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}], ",", 
         
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "/", 
            RowBox[{"#", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], "&"}], "/@", 
          RowBox[{"Differences", "[", "#", "]"}]}]}], "}"}], "\[Transpose]"}],
       "&"}], "@", 
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"#1", ",", 
          RowBox[{"Total", "[", 
           RowBox[{
            RowBox[{"-", "kBT"}], " ", 
            RowBox[{"Log", "[", 
             RowBox[{"Cosh", "[", 
              FractionBox["#2", 
               RowBox[{"2", "kBT"}]], "]"}], "]"}]}], "]"}]}], "}"}], "&"}], 
       ",", 
       RowBox[{"spectrum", "\[Transpose]"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"CriticalCurrent", "[", 
      RowBox[{"current_", "?", "MatrixQ"}], "]"}], ":=", 
     RowBox[{"Max", "[", 
      RowBox[{
       RowBox[{"GetMaxima", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", 
            RowBox[{"Abs", "[", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "]"}]}], "}"}], "&"}], "/@", 
         "current"}], "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "CriticalCurrent", "]"}], "=", 
     RowBox[{"Options", "[", "JosephsonCurrent", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CriticalCurrent", "[", 
     RowBox[{"system_MQSystem", ",", "\[Phi]_Symbol", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"JosephsonCurrent", "[", 
     RowBox[{"system", ",", " ", "\[Phi]", ",", "opts"}], "]"}]}], 
   RowBox[{"(*", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"current", "=", 
        RowBox[{"JosephsonCurrent", "[", 
         RowBox[{"system", ",", " ", "\[Phi]", ",", "opts"}], "]"}]}], "}"}], 
      ",", 
      RowBox[{"Max", "[", 
       RowBox[{"Abs", "[", 
        RowBox[{"current", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], "]"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CriticalCurrentS", "[", 
     RowBox[{"current_", "?", "MatrixQ"}], "]"}], ":=", 
    RowBox[{"Max", "[", 
     RowBox[{"Abs", "[", 
      RowBox[{"current", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"CriticalCurrentS", "[", "spectrum_List", "]"}], ":=", 
     RowBox[{"CriticalCurrentS", "[", 
      RowBox[{"spectrum", ",", "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CriticalCurrentS", "[", 
     RowBox[{"spectrum_List", ",", 
      RowBox[{"kBT_", "?", "NumericQ"}]}], "]"}], ":=", 
    RowBox[{"CriticalCurrentS", "[", 
     RowBox[{"JosephsonCurrentS", "[", 
      RowBox[{"spectrum", ",", "kBT"}], "]"}], "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.598631736554744*^9, 3.598631785845993*^9}, {
   3.598631821448339*^9, 3.598631882492874*^9}, {3.598631976195775*^9, 
   3.598632078710392*^9}, {3.5986321633457947`*^9, 3.598632229103063*^9}, {
   3.59863227291535*^9, 3.598632283163377*^9}, {3.5986323199107733`*^9, 
   3.598632365777007*^9}, {3.598634157564886*^9, 3.598634167928362*^9}, {
   3.59863427264329*^9, 3.598634285952807*^9}, {3.599203695288866*^9, 
   3.599203713432397*^9}, {3.653127113772821*^9, 3.653127152357785*^9}, {
   3.653127311834312*^9, 3.653127314353168*^9}, {3.674536922911868*^9, 
   3.6745369320242643`*^9}, 3.6745369686506567`*^9, {3.674537134110771*^9, 
   3.674537145397525*^9}, {3.6745372465766*^9, 3.674537332756768*^9}, {
   3.682247428399336*^9, 3.68224743047764*^9}, {3.682249044231345*^9, 
   3.682249084325738*^9}, {3.682251716034627*^9, 3.682251775846704*^9}, {
   3.70808644413811*^9, 3.708086732708995*^9}, {3.708086768308105*^9, 
   3.708086950216505*^9}, {3.7080869866091537`*^9, 3.708086997168915*^9}, {
   3.708087058281323*^9, 3.708087087189787*^9}, {3.708087323356949*^9, 
   3.7080873790103283`*^9}, {3.70808741382841*^9, 3.708087418058775*^9}},
 CellLabel->
  "In[354]:=",ExpressionUUID->"03acef43-bbda-4252-8712-d0aa7afd4866"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"dId\[Omega]", "::", "acjosephson"}], "=", 
   "\"\<Current for a biased system with superconductors is not yet \
implemented.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "dId\[Omega]", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Bias", "\[Rule]", "0"}], ",", " ", 
     RowBox[{"kBT", "\[Rule]", "0"}], ",", " ", 
     RowBox[{"Options", "[", "SolveScatteringSystem", "]"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"dId\[Omega]", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "scatsys_MQScatteringSystem",
     ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
     "\[Sigma]zNambu", ",", " ", "f\[Omega]", ",", "solution", ",", "W", ",", 
      "gr", ",", "ga", ",", "Gr", ",", "\[CapitalSigma]l", ",", " ", "Gl", 
      ",", " ", "\[CapitalSigma]a", ",", "\[IndentingNewLine]", 
      RowBox[{"V", "=", 
       RowBox[{"OptionValue", "[", "Bias", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"T", "=", 
       RowBox[{"OptionValue", "[", "kBT", "]"}]}]}], " ", "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"scatsys", "[", "\"\<Nambu\>\"", "]"}], "&&", 
        RowBox[{"V", "\[NotEqual]", "0"}]}], ",", " ", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"dId\[Omega]", "::", "acjosephson"}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"scatsys", "[", "\"\<Nambu\>\"", "]"}], ",", 
       RowBox[{"\[Sigma]zNambu", "=", 
        RowBox[{"Flatten", "@", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Join", "[", 
              RowBox[{"#", ",", 
               RowBox[{"-", "#"}]}], "]"}], "&"}], "@", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"1", ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"scatsys", "[", "\"\<SiteDimensions\>\"", "]"}], "/", 
                "2"}], "}"}]}], "]"}]}], ",", 
           RowBox[{"scatsys", "[", "\"\<CentralSites\>\"", "]"}]}], "]"}]}]}],
        ",", "\[IndentingNewLine]", 
       RowBox[{"\[Sigma]zNambu", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"1", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"scatsys", "[", "\"\<SiteDimensions\>\"", "]"}], 
            RowBox[{"scatsys", "[", "\"\<CentralSites\>\"", "]"}]}], "}"}]}], 
         "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", "V"}], "==", 
        RowBox[{"Length", "@", "T"}], "\[Equal]", "0"}], ",", " ", 
       RowBox[{
        RowBox[{"V", "=", 
         RowBox[{"{", 
          RowBox[{"V", ",", "V"}], "}"}]}], ";", 
        RowBox[{"T", "=", 
         RowBox[{"{", 
          RowBox[{"T", ",", "T"}], "}"}]}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"solution", "=", 
      RowBox[{"SolveScatteringSystem", "[", 
       RowBox[{"\[Omega]", ",", "scatsys", ",", " ", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "[", "SolveScatteringSystem", "]"}]}], "]"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"f\[Omega]", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"#2", "\[Equal]", "0"}], ",", 
           RowBox[{"UnitStep", "[", 
            RowBox[{"#1", "-", 
             RowBox[{"Re", "@", "\[Omega]"}]}], "]"}], ",", 
           SuperscriptBox[
            RowBox[{"(", 
             RowBox[{
              SuperscriptBox["\[ExponentialE]", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"\[Omega]", "-", "#1"}], ")"}], "/", "#2"}]], "+", 
              "1"}], ")"}], 
            RowBox[{"-", "1"}]]}], "]"}], "&"}], ",", 
        RowBox[{"{", 
         RowBox[{"V", ",", "T"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"W", "=", 
      RowBox[{"solution", "[", "\"\<CouplingsSurface\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"gr", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", "\"\<gSurface\>\"", "]"}], "&"}], "/@", 
       RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"ga", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"#", "[", "\"\<ga\>\"", "]"}], "&"}], "/@", 
         RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], ";"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]l", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"f", ",", "w", ",", "g"}], "}"}], ",", 
          RowBox[{"\[ImaginaryI]", " ", "f", " ", 
           RowBox[{
            RowBox[{"w", "\[HermitianConjugate]"}], ".", 
            RowBox[{"(", 
             RowBox[{"\[ImaginaryI]", 
              RowBox[{"(", 
               RowBox[{"g", "-", 
                RowBox[{"g", "\[HermitianConjugate]"}]}], ")"}]}], ")"}], ".",
             "w"}]}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"f\[Omega]", ",", "W", ",", "gr"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]a", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"w", ",", "g"}], "}"}], ",", 
          RowBox[{
           RowBox[{"w", "\[HermitianConjugate]"}], ".", 
           RowBox[{"g", "\[HermitianConjugate]"}], ".", "w"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"W", ",", "gr"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Gr", "=", 
      RowBox[{"solution", "[", "\"\<G\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Gl", "=", 
      RowBox[{"Gr", ".", 
       RowBox[{"Total", "[", "\[CapitalSigma]l", "]"}], ".", 
       RowBox[{"Gr", "\[HermitianConjugate]"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"2", 
        RowBox[{"Tr", "[", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Gr", ".", 
             RowBox[{"\[CapitalSigma]l", "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], "+", 
            RowBox[{"Gl", ".", 
             RowBox[{"\[CapitalSigma]a", "[", 
              RowBox[{"[", "i", "]"}], "]"}]}]}], ")"}], "\[Sigma]zNambu"}], 
         "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", 
         RowBox[{"Length", "@", "\[CapitalSigma]l"}]}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.598770451765915*^9, 3.598770490865233*^9}, {
   3.598770521068131*^9, 3.598770580097591*^9}, {3.59877064486417*^9, 
   3.598770691922279*^9}, {3.598770724824889*^9, 3.598770767038188*^9}, {
   3.598770841101571*^9, 3.598771153011265*^9}, {3.598771228648246*^9, 
   3.598771308920199*^9}, {3.598780776049439*^9, 3.598780794417859*^9}, {
   3.59878119300103*^9, 3.598781339718954*^9}, {3.598781442611268*^9, 
   3.5987814731956863`*^9}, {3.598781509305955*^9, 3.598781586827046*^9}, {
   3.5987816381865473`*^9, 3.598781645382324*^9}, {3.598781768632462*^9, 
   3.598781837781839*^9}, {3.598781872901078*^9, 3.5987821591623917`*^9}, {
   3.598782768789915*^9, 3.598782806234651*^9}, {3.598782882369885*^9, 
   3.5987829356743317`*^9}, {3.598788229447967*^9, 3.598788276770502*^9}, {
   3.598788496525054*^9, 3.598788532307322*^9}, {3.598788744624456*^9, 
   3.598788759363304*^9}, {3.598788813871068*^9, 3.598788857049446*^9}, {
   3.598789040038855*^9, 3.598789147704297*^9}, {3.598789194712009*^9, 
   3.598789319047202*^9}, {3.598789350474588*^9, 3.5987893508651667`*^9}, {
   3.598857160955495*^9, 3.598857166209203*^9}, 3.598857615679398*^9, {
   3.598857673099094*^9, 3.598857675121482*^9}, {3.5988577120473537`*^9, 
   3.598857819217133*^9}, {3.598857874686543*^9, 3.5988578972740107`*^9}, {
   3.5988580813201723`*^9, 3.5988581119585857`*^9}, {3.598870652766279*^9, 
   3.598870667701809*^9}, {3.598871059403122*^9, 3.598871060976595*^9}, {
   3.5988711535303*^9, 3.598871218706253*^9}, {3.5988712503221684`*^9, 
   3.5988712793892384`*^9}, {3.598871333569776*^9, 3.598871360445537*^9}, {
   3.5988855047541943`*^9, 3.598885504944577*^9}, {3.598885688798318*^9, 
   3.5988857342737083`*^9}, {3.5988859543926573`*^9, 
   3.5988859563770742`*^9}, {3.598889894556579*^9, 3.598889896149746*^9}, {
   3.5988900480770483`*^9, 3.598890049221271*^9}, {3.5989388129957733`*^9, 
   3.5989388131699247`*^9}, {3.598941457616438*^9, 3.598941461438539*^9}, {
   3.598941511311664*^9, 3.598941529013568*^9}, {3.598941566267252*^9, 
   3.59894157683759*^9}, 3.598941740028211*^9, {3.59894207083924*^9, 
   3.598942162376953*^9}, {3.598942239994747*^9, 3.598942259321087*^9}, {
   3.59894239369415*^9, 3.598942402331959*^9}, {3.598972998187188*^9, 
   3.5989730068550034`*^9}, 3.599021518492146*^9, 3.599138990370195*^9, 
   3.599197701553939*^9, 3.599198178155075*^9, 3.6031794069832993`*^9, 
   3.603180035181901*^9, 3.6296418559540453`*^9, {3.6375723556404953`*^9, 
   3.637572355649974*^9}},
 CellLabel->
  "In[366]:=",ExpressionUUID->"42cff266-af35-490b-b6b3-c05cd2cc75f2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "dId\[Omega]Eq", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"kBT", "\[Rule]", "0"}], ",", " ", 
     RowBox[{"Options", "[", "SolveScatteringSystem", "]"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"dId\[Omega]Eq", "[", 
   RowBox[{
    RowBox[{"\[Omega]_", "?", "NumericQ"}], ",", "scatsys_MQScatteringSystem",
     ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
     "\[Sigma]zNambu", ",", " ", "f\[Omega]", ",", "solution", ",", "WgW", 
      ",", "G", ",", "\[IndentingNewLine]", 
      RowBox[{"T", "=", 
       RowBox[{"OptionValue", "[", "kBT", "]"}]}]}], " ", "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"scatsys", "[", "\"\<Nambu\>\"", "]"}], ",", 
       RowBox[{"\[Sigma]zNambu", "=", 
        RowBox[{"Flatten", "@", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Join", "[", 
              RowBox[{"#", ",", 
               RowBox[{"-", "#"}]}], "]"}], "&"}], "@", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"1", ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"scatsys", "[", "\"\<SiteDimensions\>\"", "]"}], "/", 
                "2"}], "}"}]}], "]"}]}], ",", 
           RowBox[{"scatsys", "[", "\"\<CentralSites\>\"", "]"}]}], "]"}]}]}],
        ",", "\[IndentingNewLine]", 
       RowBox[{"\[Sigma]zNambu", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"1", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"scatsys", "[", "\"\<SiteDimensions\>\"", "]"}], 
            RowBox[{"scatsys", "[", "\"\<CentralSites\>\"", "]"}]}], "}"}]}], 
         "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"T", "\[Equal]", "0"}], ",", 
       RowBox[{"f\[Omega]", "=", 
        RowBox[{"UnitStep", "[", 
         RowBox[{"-", 
          RowBox[{"Re", "@", "\[Omega]"}]}], "]"}]}], ",", 
       RowBox[{"f\[Omega]", "=", 
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["\[ExponentialE]", 
            RowBox[{"\[Omega]", "/", "T"}]], "+", "1"}], ")"}], 
         RowBox[{"-", "1"}]]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"solution", "=", 
      RowBox[{"SolveScatteringSystem", "[", 
       RowBox[{"\[Omega]", ",", "scatsys", ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "[", "SolveScatteringSystem", "]"}]}], "]"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"G", "=", 
      RowBox[{"solution", "[", "\"\<G\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"WgW", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"#1", "\[HermitianConjugate]"}], ".", "#2", ".", "#1"}], 
         "&"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"solution", "[", "\"\<CouplingsSurface\>\"", "]"}], ",", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", "\"\<gSurface\>\"", "]"}], "&"}], "/@", 
           RowBox[{"solution", "[", "\"\<Leads\>\"", "]"}]}]}], "}"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"-", "2"}], "f\[Omega]", " ", 
        RowBox[{"Tr", "[", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"G", ".", "#"}], "-", 
            RowBox[{"#", ".", "G"}]}], ")"}], "\[Sigma]zNambu"}], "]"}]}], 
       "&"}], "/@", "WgW"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.599139204043901*^9, 3.59913926721382*^9}, {
   3.599142176739415*^9, 3.5991421823402987`*^9}, {3.5991422207185917`*^9, 
   3.599142397111999*^9}, 3.599142428754324*^9, {3.5991425071108313`*^9, 
   3.5991425131741858`*^9}, {3.599197832476962*^9, 3.599197891782262*^9}, {
   3.599197989142125*^9, 3.599198135364553*^9}, {3.599198297180399*^9, 
   3.599198317626803*^9}, {3.5991983484510937`*^9, 3.599198355654653*^9}, {
   3.599215925106193*^9, 3.5992159262970877`*^9}, {3.599220488079727*^9, 
   3.5992204885827427`*^9}, {3.5992205498816853`*^9, 3.599220553066324*^9}, 
   3.603179409450185*^9, 3.60318003927845*^9, 3.629641856369429*^9, {
   3.637572355659348*^9, 3.6375723556680717`*^9}},
 CellLabel->
  "In[369]:=",ExpressionUUID->"65436743-875f-4818-84b1-89c9f84454db"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"LowerBound", "::", "usage"}], "=", 
   "\"\<Option for JosephsonCurrentG that specifies the minimum energy \
(negative) from which to integrate.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"IntegrationPath", "::", "usage"}], "=", 
    "\"\<Option for JosephsonCurrentG that specifies a function I[\[Tau]], \
with \[Tau]\[Element][-1,0] (at zero temperature), such that the integration \
path reads \[Omega] + \[ImaginaryI] I[\[Omega]/|LowerBound|]\>\""}], ";"}], 
  " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"PhiMin", "::", "usage"}], "=", 
    "\"\<Option for JosephsonCurrentG that specifies the Bloch phase to \
assume for band bottom\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "JosephsonCurrentG", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Options", "[", "dId\[Omega]Eq", "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Options", "[", "NIntegrate", "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"LowerBound", "\[Rule]", "Automatic"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"PhiMin", "\[Rule]", "\[Pi]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"IntegrationPath", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Abs", "[", 
           RowBox[{"Sin", "[", 
            RowBox[{"\[Pi]", " ", "#1"}], "]"}], "]"}], "&"}], ")"}]}]}], 
      "}"}]}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"JosephsonCurrentG", "::", "bound"}], "=", 
   "\"\<Energy `1` is not a lower bound for the spectrum. The dI/d\[Omega] at \
this energy is `2`.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"JosephsonCurrentG", "[", 
   RowBox[{"scatsys_MQScatteringSystem", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"JosephsonCurrentG", "[", 
   RowBox[{"scatsys", ",", "0", ",", " ", "opts"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"JosephsonCurrentG", "[", 
    RowBox[{"scatsys_MQScatteringSystem", ",", 
     RowBox[{"kBT_", "?", "NumericQ"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{"dId\[Omega]", ",", "dipath", ",", "\[IndentingNewLine]", 
       RowBox[{"ipath", "=", 
        RowBox[{"OptionValue", "[", "IntegrationPath", "]"}]}], ",", 
       "\[IndentingNewLine]", " ", 
       RowBox[{"lowerbound", "=", 
        RowBox[{"OptionValue", "[", "LowerBound", "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lowerbound", "===", "Automatic"}], ",", 
        RowBox[{"lowerbound", "=", 
         RowBox[{"1.1", 
          RowBox[{"Min", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Chop", "@", 
              RowBox[{"Eigenvalues", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"OptionValue", "[", "PhiMin", "]"}], "]"}], "[", 
                  "\"\<Flat\>\"", "]"}], "[", "\"\<H\>\"", "]"}], ",", "2"}], 
               "]"}]}], "&"}], "/@", 
            RowBox[{"scatsys", "[", "\"\<Leads\>\"", "]"}]}], "]"}]}]}]}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Chop", "[", 
          RowBox[{"Max", "@", 
           RowBox[{"Re", "@", 
            RowBox[{"dId\[Omega]Eq", "[", 
             RowBox[{"lowerbound", ",", "scatsys"}], "]"}]}]}], "]"}], 
         "\[NotEqual]", "0"}], ",", 
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"JosephsonCurrentG", "::", "bound"}], ",", "lowerbound", 
          ",", 
          RowBox[{"Re", "@", 
           RowBox[{"dId\[Omega]Eq", "[", 
            RowBox[{"lowerbound", ",", "scatsys"}], "]"}]}]}], "]"}]}], "]"}],
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"dipath", "[", "\[Omega]_", "]"}], "=", 
       RowBox[{
        RowBox[{"D", "[", 
         RowBox[{
          RowBox[{"\[Omega]", "+", 
           RowBox[{"\[ImaginaryI]", " ", 
            RowBox[{"ipath", "[", 
             FractionBox["\[Omega]", 
              RowBox[{"Abs", "[", "lowerbound", "]"}]], "]"}]}]}], ",", 
          "\[Omega]"}], "]"}], "/.", 
        RowBox[{
         RowBox[{
          RowBox[{"Abs", "'"}], "[", "a_", "]"}], ":>", 
         RowBox[{"Sign", "[", "a", "]"}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"dId\[Omega]", "[", 
        RowBox[{"\[Omega]_", "?", "NumericQ"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"dipath", "[", "\[Omega]", "]"}], 
        RowBox[{"First", "@", 
         RowBox[{"dId\[Omega]Eq", "[", 
          RowBox[{
           RowBox[{"\[Omega]", "+", 
            RowBox[{"\[ImaginaryI]", " ", 
             RowBox[{"ipath", "[", 
              FractionBox["\[Omega]", 
               RowBox[{"Abs", "[", "lowerbound", "]"}]], "]"}]}]}], ",", 
           "scatsys", ",", " ", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", 
             RowBox[{"Options", "[", "dId\[Omega]Eq", "]"}]}], "]"}]}], 
          "]"}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{"{", 
          RowBox[{"lowerbound", ",", 
           RowBox[{"dId\[Omega]", "[", "lowerbound", "]"}], ",", 
           RowBox[{"lowerbound", "+", 
            RowBox[{"\[ImaginaryI]", " ", 
             RowBox[{"ipath", "[", 
              FractionBox["lowerbound", 
               RowBox[{"Abs", "[", "lowerbound", "]"}]], "]"}]}]}]}], "}"}], 
         "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Print", "@", 
         RowBox[{"Plot", "[", 
          RowBox[{
           RowBox[{"Re", "@", 
            RowBox[{"dId\[Omega]", "[", "\[Omega]", "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"\[Omega]", ",", "lowerbound", ",", 
             RowBox[{"4", "kBT"}]}], "}"}]}], "]"}]}], ";"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Re", "@", 
       RowBox[{"NIntegrate", "[", 
        RowBox[{
         RowBox[{"dId\[Omega]", "[", "\[Omega]", "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Omega]", ",", "lowerbound", ",", 
           RowBox[{"4", " ", "kBT"}]}], "}"}], ",", 
         RowBox[{"Evaluate", "@", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", 
            RowBox[{"Options", "[", "NIntegrate", "]"}]}], "]"}]}], ",", " ", 
         
         RowBox[{"PrecisionGoal", "\[Rule]", "3"}], ",", " ", 
         RowBox[{"AccuracyGoal", "\[Rule]", "3"}]}], "]"}]}]}]}], "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "CriticalCurrentG", "]"}], "=", 
     RowBox[{"Flatten", "@", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Options", "[", "JosephsonCurrentG", "]"}], ",", 
        RowBox[{"Options", "[", "FindMaximum", "]"}], ",", 
        RowBox[{"PiSymmetric", "\[Rule]", "False"}]}], "}"}]}]}], ";"}], 
   "*)"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "CriticalCurrentG", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Options", "[", "JosephsonCurrentG", "]"}], ",", 
       RowBox[{"Options", "[", "Sample", "]"}], ",", 
       RowBox[{"PiSymmetric", "\[Rule]", "False"}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CriticalCurrentG", "[", 
     RowBox[{"scatsys\[Phi]_Function", ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"CriticalCurrentG", "[", 
     RowBox[{"scatsys\[Phi]", ",", "0", ",", "opts"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"CriticalCurrentG", "[", 
     RowBox[{"scatsys\[Phi]_Function", ",", 
      RowBox[{"kBT_", "?", "NumericQ"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "I\[Phi]", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"I\[Phi]", "[", 
         RowBox[{"\[Phi]_", "?", "NumericQ"}], "]"}], ":=", 
        RowBox[{"JosephsonCurrentG", "[", 
         RowBox[{
          RowBox[{"scatsys\[Phi]", "[", "\[Phi]", "]"}], ",", "kBT", ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", 
            RowBox[{"Options", "[", "JosephsonCurrentG", "]"}]}], "]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"NumericQ", "@", 
            RowBox[{"First", "@", "#"}]}], ",", 
           RowBox[{"First", "@", "#"}], ",", "#"}], "]"}], "&"}], "@", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"FindMaximum", "[", 
           RowBox[{
            RowBox[{"I\[Phi]", "[", "\[Phi]", "]"}], ",", 
            RowBox[{"Evaluate", "@", 
             RowBox[{"{", 
              RowBox[{"\[Phi]", ",", "0", ",", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"OptionValue", "[", "PiSymmetric", "]"}], ",", 
                 "\[Pi]", ",", 
                 RowBox[{"2", "\[Pi]"}]}], "]"}]}], "}"}]}], ",", 
            RowBox[{"Evaluate", "@", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"FilterRules", "[", 
                RowBox[{
                 RowBox[{"{", "opts", "}"}], ",", 
                 RowBox[{"Options", "[", "FindMaximum", "]"}]}], "]"}], ",", 
               " ", 
               RowBox[{"PrecisionGoal", "\[Rule]", "3"}], ",", " ", 
               RowBox[{"AccuracyGoal", "\[Rule]", "3"}]}], "}"}]}]}], "]"}], 
          ",", 
          RowBox[{"\"\<\[Phi]=\>\"", "~~", 
           RowBox[{"ToString", "[", "\[Phi]", "]"}]}]}], "]"}]}]}]}], "]"}]}],
    "*)"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"CriticalCurrentG", "[", 
   RowBox[{"scatsys\[Phi]_Function", ",", 
    RowBox[{"kBT_", "?", "NumericQ"}], ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "I\[Phi]", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"I\[Phi]", "[", 
       RowBox[{"\[Phi]_", "?", "NumericQ"}], "]"}], ":=", 
      RowBox[{"JosephsonCurrentG", "[", 
       RowBox[{
        RowBox[{"scatsys\[Phi]", "[", "\[Phi]", "]"}], ",", "kBT", ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "[", "JosephsonCurrentG", "]"}]}], "]"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"Max", "[", 
        RowBox[{"Abs", "[", 
         RowBox[{"#", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], "]"}], "&"}], "@", 
      
      RowBox[{"Monitor", "[", 
       RowBox[{
        RowBox[{"Sample", "[", 
         RowBox[{
          RowBox[{"I\[Phi]", "[", "\[Phi]", "]"}], ",", 
          RowBox[{"Evaluate", "@", 
           RowBox[{"{", 
            RowBox[{"\[Phi]", ",", "0", ",", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"OptionValue", "[", "PiSymmetric", "]"}], ",", "\[Pi]",
                ",", 
               RowBox[{"2", "\[Pi]"}]}], "]"}]}], "}"}]}], ",", 
          RowBox[{"Evaluate", "@", 
           RowBox[{"{", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "[", "Sample", "]"}]}], "]"}], "}"}]}]}], 
         "]"}], ",", 
        RowBox[{"\"\<\[Phi]=\>\"", "~~", 
         RowBox[{"ToString", "[", "\[Phi]", "]"}]}]}], "]"}]}]}]}], 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.5992037275415382`*^9, 3.59920374816364*^9}, {
   3.599203876043696*^9, 3.5992039361165457`*^9}, {3.599203982564687*^9, 
   3.599204093230679*^9}, {3.599212150010854*^9, 3.599212168422364*^9}, {
   3.599212216702876*^9, 3.5992122282690487`*^9}, {3.599212353028232*^9, 
   3.599212384091083*^9}, 3.5992124514364767`*^9, {3.599212511747406*^9, 
   3.599212523165501*^9}, {3.599212570656288*^9, 3.5992130112757397`*^9}, {
   3.599213044123073*^9, 3.599213060819889*^9}, {3.599213125898185*^9, 
   3.599213181750216*^9}, 3.5992132210831203`*^9, {3.599213447916209*^9, 
   3.599213581141384*^9}, {3.5992136474632463`*^9, 3.599213733842478*^9}, {
   3.5992138564064617`*^9, 3.5992139040617657`*^9}, {3.599213944339148*^9, 
   3.599214091407527*^9}, {3.599214197130474*^9, 3.599214285276946*^9}, {
   3.5992145294846277`*^9, 3.599214778837682*^9}, 3.599214839615259*^9, {
   3.599214877481604*^9, 3.599214943176385*^9}, {3.59921511158211*^9, 
   3.5992151245092382`*^9}, {3.5992165810075808`*^9, 3.599216746810755*^9}, {
   3.599216925459124*^9, 3.599216953215332*^9}, {3.59921699163313*^9, 
   3.599216992716145*^9}, {3.599217045687571*^9, 3.5992170581021137`*^9}, {
   3.599217656029484*^9, 3.599217676777933*^9}, {3.5992177116814213`*^9, 
   3.599217715310444*^9}, {3.599217745976102*^9, 3.599217748149074*^9}, {
   3.599217862669858*^9, 3.599217862996395*^9}, {3.599220258642384*^9, 
   3.599220276233036*^9}, {3.599220306879216*^9, 3.599220307238845*^9}, {
   3.5992205355248823`*^9, 3.599220562574306*^9}, {3.5992205973817673`*^9, 
   3.599220610788755*^9}, 3.59922064538179*^9, {3.599220687896707*^9, 
   3.5992207523730097`*^9}, {3.599220962558874*^9, 3.599221206740222*^9}, {
   3.599221248360264*^9, 3.599221262568644*^9}, {3.599221294634698*^9, 
   3.5992214088075247`*^9}, {3.599221450468381*^9, 3.599221545004599*^9}, {
   3.599288242441383*^9, 3.599288244528064*^9}, {3.599488557230253*^9, 
   3.599488652965825*^9}, {3.599489043905992*^9, 3.599489044065095*^9}, {
   3.629641856714506*^9, 3.629641857058092*^9}, 3.6352360929879017`*^9},
 CellLabel->
  "In[371]:=",ExpressionUUID->"33986280-e55a-4ed4-8d08-4f6018f6c626"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.599212453786071*^9, 3.599212475468541*^9}, 
   3.599212509730606*^9},
 CellLabel->
  "In[381]:=",ExpressionUUID->"e3369c4c-ba83-4fe2-9457-fd4c4e003be8"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{"CriticalCurrentG", "[", 
    RowBox[{"scatsys\[Phi]_Function", ",", 
     RowBox[{"kBT_", "?", "NumericQ"}], ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "I\[Phi]", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"I\[Phi]", "[", 
        RowBox[{"\[Phi]_", "?", "NumericQ"}], "]"}], ":=", 
       RowBox[{"JosephsonCurrentG", "[", 
        RowBox[{
         RowBox[{"scatsys\[Phi]", "[", "\[Phi]", "]"}], ",", "kBT", ",", 
         RowBox[{"FilterRules", "[", 
          RowBox[{
           RowBox[{"{", "opts", "}"}], ",", 
           RowBox[{"Options", "[", "JosephsonCurrentG", "]"}]}], "]"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"NumericQ", "@", 
           RowBox[{"First", "@", "#"}]}], ",", 
          RowBox[{"First", "@", "#"}], ",", "#"}], "]"}], "&"}], "@", 
       RowBox[{"Monitor", "[", 
        RowBox[{
         RowBox[{"FindMaximum", "[", 
          RowBox[{
           RowBox[{"I\[Phi]", "[", "\[Phi]", "]"}], ",", "\[Phi]", ",", 
           RowBox[{"Method", "\[Rule]", "\"\<PrincipalAxis\>\""}], ",", 
           RowBox[{"Evaluate", "@", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", 
                RowBox[{"Options", "[", "FindMaximum", "]"}]}], "]"}], ",", 
              " ", 
              RowBox[{"PrecisionGoal", "\[Rule]", "3"}], ",", " ", 
              RowBox[{"AccuracyGoal", "\[Rule]", "3"}]}], "}"}]}]}], "]"}], 
         ",", 
         RowBox[{"\"\<\[Phi]=\>\"", "~~", 
          RowBox[{"ToString", "[", "\[Phi]", "]"}]}]}], "]"}]}]}]}], "]"}]}], 
  "*)"}]], "Input",
 CellChangeTimes->{{3.5992751523074083`*^9, 3.5992751664491587`*^9}, {
  3.599488168012073*^9, 3.5994881707719803`*^9}},
 CellLabel->
  "In[382]:=",ExpressionUUID->"6bea3851-f1c7-4b2a-974e-dcef60362ffd"]
}, Closed]],

Cell[CellGroupData[{

Cell["SpringMesh", "Subsection",
 CellChangeTimes->{{3.656821711169853*^9, 
  3.6568217151128893`*^9}},ExpressionUUID->"1227a11e-e469-4b58-b926-\
62d5603e33af"],

Cell[CellGroupData[{

Cell["BuildSpringMesh", "Subsubsection",
 CellChangeTimes->{{3.611812444506138*^9, 3.611812448465026*^9}, 
   3.611832696758905*^9, {3.630918185315957*^9, 3.630918214153409*^9}, 
   3.6312705574233*^9},ExpressionUUID->"d20dc228-a008-47af-b694-418c372839cf"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"EquilibriumDistance", "::", "usage"}], "=", 
   "\"\<Option for BuildSpringMesh that specifies the equilibrium lengths of \
springs, as a function of site coordinates.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SpringConstant", "::", "usage"}], "=", 
   "\"\<Option for BuildSpringMesh that specifies the spring constants as a \
function of site pair coordinates.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"HubConstant", "::", "usage"}], "=", 
    "\"\<Option for BuildSpringMesh that specifies the coefficient \
\!\(\*SubscriptBox[\(\[Alpha]\), \(i\)]\) (bending rigidity) of site i \
contributing to the total elastic energy as \!\(\*SubscriptBox[\(\[Alpha]\), \
\(i\)]\)\!\(\*SubscriptBox[\(\[Sum]\), \(j, \
j'\)]\)(\!\(\*SubscriptBox[OverscriptBox[\(r\), \(^\)], \(ij\)]\)\[CenterDot]\
\!\(\*SubscriptBox[OverscriptBox[\(r\), \(^\)], \(ij'\)]\)) for all sites j, \
j' spring-coupled to site i.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BuildSpringMesh", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"HubConstant", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{"0", "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"SpringConstant", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{"0", "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"EquilibriumDistance", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Norm", "[", 
           RowBox[{"#1", "-", "#2"}], "]"}], "&"}], ")"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Options", "@", "BuildSystem"}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"BuildSpringMesh", "[", 
     RowBox[{"preset_String", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"BuildSpringMesh", "[", 
     RowBox[{
      RowBox[{"MQLattice", "[", "preset", "]"}], ",", "opts"}], "]"}]}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"BuildSpringMesh", "[", 
     RowBox[{
      RowBox[{"sites_", "?", "IsValidSitesQ"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"BuildSpringMesh", "[", 
     RowBox[{
      RowBox[{"MQLattice", "[", "sites", "]"}], ",", "opts"}], "]"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"BuildSpringMesh", "[", 
   RowBox[{"lattice_MQLattice", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"MQSpringMesh", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\"\<SpringConstants\>\"", "->", 
     RowBox[{"BuildSystem", "[", 
      RowBox[{"lattice", ",", " ", 
       RowBox[{"Onsite", "\[Rule]", 
        RowBox[{"OptionValue", "[", "HubConstant", "]"}]}], ",", 
       RowBox[{"Hopping", "\[Rule]", 
        RowBox[{"OptionValue", "[", "SpringConstant", "]"}]}], ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "@", "BuildSystem"}]}], "]"}]}], "]"}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"\"\<EquilibriumDistances\>\"", "\[Rule]", 
     RowBox[{"BuildSystem", "[", 
      RowBox[{"lattice", ",", " ", 
       RowBox[{"Onsite", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{"0", "&"}], ")"}]}], ",", 
       RowBox[{"Hopping", "\[Rule]", 
        RowBox[{"OptionValue", "[", "EquilibriumDistance", "]"}]}], ",", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "@", "BuildSystem"}]}], "]"}]}], "]"}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
     RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"\"\<EmbeddingDimensions\>\"", "\[Rule]", 
     RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], ",", " ",
     "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"OptionValue", "@", "EmbedLattice"}], "===", "True"}], ",", 
      RowBox[{"\"\<Lattice\>\"", "\[Rule]", "lattice"}], ",", 
      RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
       RowBox[{"Missing", "[", "]"}]}]}], "]"}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.630918384570612*^9, 3.6309184366631603`*^9}, {
   3.630918663749218*^9, 3.63091869804224*^9}, {3.630918806022451*^9, 
   3.630918857027665*^9}, {3.630918889042774*^9, 3.630919060105496*^9}, {
   3.6309191005425587`*^9, 3.630919102053385*^9}, 3.630919136871401*^9, {
   3.630920081724209*^9, 3.63092009757847*^9}, 3.630920128712955*^9, {
   3.630930009929512*^9, 3.630930205642067*^9}, {3.630930733180822*^9, 
   3.6309307344962587`*^9}, 3.630997845072344*^9, {3.630999506949432*^9, 
   3.630999510809211*^9}, {3.635239232076272*^9, 3.635239235913806*^9}, {
   3.6363545926375303`*^9, 3.636354608684853*^9}, {3.636359945096335*^9, 
   3.63635999026237*^9}, {3.6465450243904047`*^9, 3.6465450737198153`*^9}, {
   3.646545154995016*^9, 3.646545166437323*^9}, {3.653558191514296*^9, 
   3.6535581992721243`*^9}, {3.653558513600053*^9, 3.653558514645548*^9}, 
   3.653712792170326*^9, {3.6537130935179253`*^9, 3.653713165410343*^9}, {
   3.6568230124090967`*^9, 3.656823012714232*^9}},
 CellLabel->
  "In[383]:=",ExpressionUUID->"ef3bd829-a967-4b35-ae72-4c692dc1016e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
Elastic energy [non-normalized hubs, deprecated for induced lattice tension. \
It\[CloseCurlyQuote]s also not faster]\
\>", "Subsubsection",
 CellChangeTimes->{{3.6312705638390636`*^9, 3.631270583302957*^9}, {
  3.631271487155444*^9, 3.631271488091165*^9}, {3.631272396782641*^9, 
  3.631272407534544*^9}, {3.6312725819937363`*^9, 
  3.6312725885020247`*^9}},ExpressionUUID->"49253782-1fbe-4b98-837e-\
e02761ed66df"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{"DistortionMatrix", "::", "usage"}], "=", 
    "\"\<Option for ElasticEnergy that specifies matrix M, such that mesh \
coordinates \!\(\*SubscriptBox[\(r\), \(i\)]\) should be transformed into \
(1+M).\!\(\*SubscriptBox[\(r\), \(i\)]\)\>\""}], ";", "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Options", "[", "ElasticEnergy", "]"}], ":=", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"DistortionMatrix", "\[Rule]", "None"}], "}"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"ElasticEnergy", "[", 
       RowBox[{"lattice_MQLattice", ",", "mesh_MQSpringMesh", ",", " ", 
        RowBox[{"opts", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}]}], ":=", 
     RowBox[{
      RowBox[{"ElasticEnergy", "[", 
       RowBox[{"mesh", ",", " ", "opts"}], "]"}], "[", 
      RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}], "]"}]}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"ElasticEnergy", "[", 
     RowBox[{"mesh_MQSpringMesh", ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{
     RowBox[{
      RowBox[{"Block", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "springconstants", ",", "hubs", ",", "distances", ",", " ", 
          "distortionmatrix", ",", " ", "pairs", ",", "pairsofpairs", ",", 
          " ", "bravaisindices", ",", " ", "nonredundant"}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"distortionmatrix", "=", 
          RowBox[{
           RowBox[{"N", "@", 
            RowBox[{"IdentityMatrix", "[", 
             RowBox[{"mesh", "[", "\"\<LatticeDimensions\>\"", "]"}], "]"}]}],
            "+", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"MatrixQ", "[", 
              RowBox[{"OptionValue", "[", "DistortionMatrix", "]"}], "]"}], 
             ",", 
             RowBox[{"OptionValue", "[", "DistortionMatrix", "]"}], ",", 
             "0"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"This", " ", "has", " ", "a", " ", "structure", " ", 
           RowBox[{"{", 
            SubscriptBox["h", "i"], "}"}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"hubs", "=", 
          RowBox[{"Normal", "@", 
           RowBox[{"Diagonal", "@", 
            RowBox[{
             RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], "[", 
             "\"\<H\>\"", "]"}]}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
            RowBox[{"This", " ", "has", " ", "a", " ", "structure", " ", 
             RowBox[{"{", "BravaisIndices", "}"}]}], "\[Rule]", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"i", ",", "j"}], "}"}], "\[Rule]", 
              RowBox[{
               RowBox[{
                SubscriptBox["t", "ij"], " ", 
                RowBox[{"(", 
                 RowBox[{"or", " ", 
                  SubscriptBox["r0", "ij"]}], ")"}]}], "..."}]}], "}"}]}], 
           ",", " ", 
           RowBox[{
           "where", " ", "i", " ", "is", " ", "shifted", " ", "by", " ", 
            "Bravais", " ", "indices"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"removing", " ", "onsite", " ", "i"}], "\[Equal]", 
             RowBox[{"j", " ", "terms", " ", "for", " ", "BravaisIndices"}]}],
             "=", 
            RowBox[{"{", 
             RowBox[{"0", ".."}], "}"}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"springconstants", "=", 
          RowBox[{"DeleteCases", "[", 
           RowBox[{
            RowBox[{"MapAt", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Sort", "@", 
                RowBox[{"Most", "@", 
                 RowBox[{"ArrayRules", "[", "#", "]"}]}]}], "&"}], ",", 
              RowBox[{
               RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], "[", 
               "\"\<HBloch\>\"", "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"All", ",", "2"}], "}"}]}], "]"}], ",", 
            RowBox[{"Rule", "[", 
             RowBox[{"_", ",", 
              RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"springconstants", "=", 
          RowBox[{"springconstants", "/.", 
           RowBox[{
            RowBox[{"Rule", "[", 
             RowBox[{
              RowBox[{"x", ":", 
               RowBox[{"{", 
                RowBox[{"0", ".."}], "}"}]}], ",", "A_"}], "]"}], 
            "\[RuleDelayed]", 
            RowBox[{"Rule", "[", 
             RowBox[{"x", ",", 
              RowBox[{"DeleteCases", "[", 
               RowBox[{"A", ",", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "_"}]}], 
               "]"}]}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"distances", "=", 
          RowBox[{"DeleteCases", "[", 
           RowBox[{
            RowBox[{"MapAt", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Sort", "@", 
                RowBox[{"Most", "@", 
                 RowBox[{"ArrayRules", "[", "#", "]"}]}]}], "&"}], ",", 
              RowBox[{
               RowBox[{"mesh", "[", "\"\<EquilibriumDistances\>\"", "]"}], 
               "[", "\"\<HBloch\>\"", "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"All", ",", "2"}], "}"}]}], "]"}], ",", 
            RowBox[{"Rule", "[", 
             RowBox[{"_", ",", 
              RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"distances", "=", 
          RowBox[{"distances", "/.", 
           RowBox[{
            RowBox[{"Rule", "[", 
             RowBox[{
              RowBox[{"x", ":", 
               RowBox[{"{", 
                RowBox[{"0", ".."}], "}"}]}], ",", "A_"}], "]"}], 
            "\[RuleDelayed]", 
            RowBox[{"Rule", "[", 
             RowBox[{"x", ",", 
              RowBox[{"DeleteCases", "[", 
               RowBox[{"A", ",", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "_"}]}], 
               "]"}]}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"Linked", " ", "pairs"}], ",", " ", 
           RowBox[{"including", " ", "redundant", " ", 
            RowBox[{"(", 
             RowBox[{"both", " ", 
              RowBox[{"{", 
               RowBox[{"i", ",", "j"}], "}"}], " ", "and", " ", 
              RowBox[{"{", 
               RowBox[{"j", ",", "i"}], "}"}]}], ")"}]}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"pairs", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"Flatten", "[", 
             RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
           RowBox[{"springconstants", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "2", ",", "All", ",", "1"}], "]"}], 
            "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
           "A", " ", "list", " ", "of", " ", "the", " ", "form", " ", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"pairindex1", ",", " ", "pairindex2"}], "}"}], 
               "..."}], "}"}], ".", " ", "This"}], " ", "computes", " ", 
            "the", " ", "indices", " ", "of", " ", "all", " ", "possible", 
            " ", "pairs", " ", "of", " ", "pairs", " ", "in", " ", "a", " ", 
            "listofpairs", " ", "that", " ", "share", " ", "the", " ", "*", 
            "last", "*", " ", "element", " ", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"i", ".", "e", ".", " ", "the"}], " ", "hub", " ", 
               "index"}], ")"}], ".", " ", "This"}], " ", "gives", " ", "all",
             " ", "pairs", " ", "of", " ", "spokes", " ", "from", " ", "the", 
            " ", "same", " ", 
            RowBox[{"hub", ".", " ", "We"}], " ", "pick", " ", "only", " ", 
            "those", " ", "for", " ", "which", " ", "a", " ", "non"}], "-", 
           RowBox[{"zero", " ", 
            RowBox[{"(", 
             RowBox[{"or", " ", "symbolic"}], ")"}], " ", "hub", " ", 
            "constant", " ", 
            RowBox[{"exists", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"pairsofpairs", "=", 
          RowBox[{
           RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"Pick", "[", 
                RowBox[{"#", ",", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"!", 
                    RowBox[{"NumericQ", "[", "#", "]"}]}], "||", 
                    RowBox[{
                    RowBox[{"N", "@", "#"}], "\[NotEqual]", "0."}]}], "&"}], 
                   ")"}], "/@", 
                  RowBox[{"hubs", "[", 
                   RowBox[{"[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "1", ",", "1", ",", "1"}], "]"}], 
                    "]"}], "]"}], "]"}]}]}], "]"}], "&"}], "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Subsets", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{"{", "2", "}"}]}], "]"}], "&"}], "/@", 
               RowBox[{"Sort", "@", 
                RowBox[{"Gather", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
                    RowBox[{"Range", "[", 
                    RowBox[{"Length", "[", "pairs", "]"}], "]"}]}], "}"}], 
                   "\[Transpose]"}], ",", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"#1", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
                    RowBox[{"#2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "&"}]}], "]"}]}]}], 
              "]"}], ",", "\[IndentingNewLine]", "1"}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
            RowBox[{"For", " ", "each", " ", "pair", " ", "j"}], "=", "1"}], 
           ",", "2", ",", "...", ",", " ", 
           RowBox[{
            RowBox[{"bravaisindices", "[", 
             RowBox[{"[", "j", "]"}], "]"}], " ", "gives", " ", "the", " ", 
            "corresponding", " ", "Bravais", " ", "indices", " ", "by", " ", 
            "which", " ", "the", " ", "first", " ", "site", " ", "of", " ", 
            "the", " ", "pair", " ", "is", " ", "shifted"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"bravaisindices", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"Flatten", "[", 
             RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
           RowBox[{"MapThread", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"ConstantArray", "[", 
               RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"springconstants", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
               RowBox[{"Length", "/@", 
                RowBox[{"springconstants", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "}"}]}], 
            "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{"Non", "-", 
            RowBox[{
            "redundant", " ", "pairs", " ", "and", " ", "Bravais", " ", 
             "indices"}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"temp4", "=", 
            RowBox[{"nonredundant", "=", 
             RowBox[{"Last", "@", 
              RowBox[{"Transpose", "@", 
               RowBox[{"DeleteDuplicates", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"pairs", ",", "bravaisindices", ",", " ", 
                    RowBox[{"Range", "@", 
                    RowBox[{"Length", "@", "pairs"}]}]}], "}"}], 
                  "\[Transpose]"}], ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"#1", "[", 
                    RowBox[{"[", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "2"}], "}"}], "]"}], "]"}], "\[Equal]", 
                   
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Reverse", "[", 
                    RowBox[{"#2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
                    RowBox[{"-", 
                    RowBox[{"#2", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}]}], "&"}]}], 
                "]"}]}]}]}]}], ";"}], "\[IndentingNewLine]", "*)"}], 
         "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"(*", 
             RowBox[{
             "Creates", " ", "flat", " ", "arrays", " ", "to", " ", "feed", 
              " ", "into", " ", "Compile"}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"$hubs", "=", "hubs"}], ",", "\[IndentingNewLine]", 
             RowBox[{"$matrix", "=", "distortionmatrix"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"$pairs", "=", "pairs"}], ",", "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{"A", " ", "spurious", " ", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "0"}], "}"}], " ", "element", " ", "is", 
                " ", "appended", " ", "to", " ", "pairsofpairs", " ", "to", 
                " ", "avoid", " ", "problems", " ", "in", " ", "Compile", " ",
                 "for", " ", "the", " ", "case", " ", "pairsofpairs"}], "=", 
               RowBox[{"{", "}"}]}], "*)"}], "\[IndentingNewLine]", 
             RowBox[{"$pairsofpairs", "=", 
              RowBox[{
               RowBox[{
                RowBox[{"Append", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{"{", 
                   RowBox[{"0", ",", "0"}], "}"}]}], "]"}], "&"}], "@", 
               "pairsofpairs"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"$springs", "=", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                 RowBox[{"N", "@", 
                  RowBox[{"Flatten", "[", 
                   RowBox[{"#", ",", "1"}], "]"}]}], "&"}], "@", 
                RowBox[{"springconstants", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2", ",", "All", ",", "2"}], "]"}], 
                 "]"}]}], ")"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"$dist", "=", 
              RowBox[{
               RowBox[{
                RowBox[{"N", "@", 
                 RowBox[{"Flatten", "[", 
                  RowBox[{"#", ",", "1"}], "]"}]}], "&"}], "@", 
               RowBox[{"distances", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2", ",", "All", ",", "2"}], "]"}], 
                "]"}]}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"$bravaisvectors", "=", 
              RowBox[{"mesh", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"$bravaisindices", "=", "bravaisindices"}]}], "}"}], ",",
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"pairs", "===", 
               RowBox[{"{", "}"}]}], ",", 
              RowBox[{"Return", "[", 
               RowBox[{"0", "&"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Or", "@@", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"!", 
                    RowBox[{"VectorQ", "[", 
                    RowBox[{"#", ",", "NumericQ"}], "]"}]}], "&"}], "/@", 
                    RowBox[{"{", 
                    RowBox[{"$hubs", ",", "$springs", ",", " ", "$dist"}], 
                    "}"}]}], ")"}]}], "||", 
                 RowBox[{"Or", "@@", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"!", 
                    RowBox[{"MatrixQ", "[", 
                    RowBox[{"#", ",", "NumericQ"}], "]"}]}], "&"}], "/@", 
                    RowBox[{"{", 
                    RowBox[{"$pairs", ",", "$pairsofpairs", ",", "$matrix"}], 
                    "}"}]}], ")"}]}]}], ",", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"Print", "[", "\"\<Symbolic processing\>\"", "]"}], 
                 ";", "#"}], ",", "\[IndentingNewLine]", 
                RowBox[{"Compile", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"{", 
                    RowBox[{"r", ",", "_Real", ",", "2"}], "}"}], "}"}], ",", 
                  
                  RowBox[{"#", "[", "r", "]"}]}], "]"}]}], "]"}], "&"}], "@", 
             "\[IndentingNewLine]", 
             RowBox[{"Function", "[", 
              RowBox[{"r", ",", 
               RowBox[{"Module", "[", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"e", "=", "0."}], ",", 
                   RowBox[{"i", "=", "0"}], ",", 
                   RowBox[{"j", "=", "0"}], ",", 
                   RowBox[{"k", "=", "0"}]}], "}"}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"(*", 
                  RowBox[{
                   RowBox[{"We", " ", "add", " ", "two"}], "-", 
                   RowBox[{"body", " ", "spring", " ", 
                    RowBox[{"energies", ".", " ", "Extra"}], " ", 
                    RowBox[{"1", "/", "2"}], " ", "for", " ", 
                    "redundancy"}]}], "*)"}], "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"Do", "[", "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"i", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"j", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"e", "+=", 
                    RowBox[{
                    FractionBox["1", "2"], 
                    FractionBox["1", "2"], 
                    RowBox[{"$springs", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], 
                    SuperscriptBox[
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Norm", "[", "#", "]"}], "-", 
                    RowBox[{"$dist", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ")"}], "2"]}]}], "&"}], 
                    "[", "\[IndentingNewLine]", 
                    RowBox[{"$matrix", ".", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ".", "$bravaisvectors"}], 
                    "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], ")"}]}], "]"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"{", 
                    RowBox[{"n", ",", "1", ",", 
                    RowBox[{"Length", "@", "$pairs"}]}], "}"}]}], "]"}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"(*", 
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    "We", " ", "now", " ", "add", " ", "the", " ", "three"}], 
                    "-", 
                    RowBox[{"body", " ", "hub", " ", 
                    RowBox[{"terms", ".", " ", "We"}], " ", "use"}]}], " ", 
                    "|", 
                    RowBox[{
                    SubscriptBox[
                    OverscriptBox["r", "^"], "ij"], "\[Cross]", 
                    SubscriptBox[
                    OverscriptBox["r", "^"], 
                    RowBox[{"ij", "'"}]]}], 
                    SuperscriptBox["|", "2"]}], "=", 
                    RowBox[{"1", "-", 
                    RowBox[{
                    RowBox[{
                    FractionBox[
                    SuperscriptBox[
                    RowBox[{"(", 
                    RowBox[{
                    SubscriptBox[
                    OverscriptBox["r", "\[RightVector]"], "ij"], ".", 
                    SubscriptBox[
                    OverscriptBox["r", "\[RightVector]"], 
                    RowBox[{"ij", "'"}]]}], ")"}], "2"], 
                    RowBox[{"|", 
                    SubscriptBox[
                    OverscriptBox["r", "\[RightVector]"], "ij"], 
                    SuperscriptBox["|", "2"], "|", 
                    SubscriptBox[
                    OverscriptBox["r", "\[RightVector]"], 
                    RowBox[{"ij", "'"}]], 
                    SuperscriptBox["|", "2"]}]], ".", " ", "Note"}], " ", 
                    "that", " ", "k", " ", "starts", " ", "at", " ", "2", " ",
                     "to", " ", "skip", " ", "the", " ", "spurious", " ", 
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0"}], "}"}], " ", "term"}]}]}], "*)"}],
                   "\[IndentingNewLine]", 
                  RowBox[{"Do", "[", "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"i", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{"j", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{"k", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"e", "+=", 
                    RowBox[{
                    FractionBox["1", "2"], 
                    RowBox[{"$hubs", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#1", "]"}], "2"], 
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#2", "]"}], "2"]}], "-", 
                    SuperscriptBox[
                    RowBox[{"(", 
                    RowBox[{"#1", ".", "#2"}], ")"}], "2"]}], ")"}]}]}], 
                    "&"}], "[", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"$matrix", ".", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", 
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], "]"}], "]"}], ".", 
                    "$bravaisvectors"}], "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ")"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"$matrix", ".", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", 
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}], "]"}], "]"}], ".", 
                    "$bravaisvectors"}], "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ")"}]}]}], "]"}]}], ",",
                     "\[IndentingNewLine]", 
                    RowBox[{"{", 
                    RowBox[{"n", ",", "1", ",", 
                    RowBox[{
                    RowBox[{"Length", "@", "$pairsofpairs"}], "-", "1"}]}], 
                    "}"}]}], "]"}], ";", "\[IndentingNewLine]", "e"}]}], 
                "]"}]}], "]"}]}]}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}],
       "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"ElasticForces", "[", 
       RowBox[{"lattice_MQLattice", ",", "mesh_MQSpringMesh"}], "]"}]}], ":=", 
     RowBox[{
      RowBox[{"ElasticForces", "[", "mesh", "]"}], "[", 
      RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}], "]"}]}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"ElasticForces", "[", "mesh_MQSpringMesh", "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "springconstants", ",", "distances", ",", " ", "hubs", ",", "pairs", 
        ",", "pairsofpairs", ",", " ", "bravaisindices"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"This", " ", "has", " ", "a", " ", "structure", " ", 
        RowBox[{"{", 
         SubscriptBox["h", "i"], "}"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"hubs", "=", 
        RowBox[{"Normal", "@", 
         RowBox[{"Diagonal", "@", 
          RowBox[{
           RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], "[", 
           "\"\<H\>\"", "]"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"This", " ", "has", " ", "a", " ", "structure", " ", 
           RowBox[{"{", "BravaisIndices", "}"}]}], "\[Rule]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"i", ",", "j"}], "}"}], "\[Rule]", 
            RowBox[{
             RowBox[{
              SubscriptBox["t", "ij"], " ", 
              RowBox[{"(", 
               RowBox[{"or", " ", 
                SubscriptBox["r0", "ij"]}], ")"}]}], "..."}]}], "}"}]}], ",", 
         " ", 
         RowBox[{
         "where", " ", "i", " ", "is", " ", "shifted", " ", "by", " ", 
          "Bravais", " ", "indices"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"removing", " ", "onsite", " ", "i"}], "\[Equal]", 
           RowBox[{"j", " ", "terms", " ", "for", " ", "BravaisIndices"}]}], 
          "=", 
          RowBox[{"{", 
           RowBox[{"0", ".."}], "}"}]}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"springconstants", "=", 
        RowBox[{"DeleteCases", "[", 
         RowBox[{
          RowBox[{"MapAt", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Sort", "@", 
              RowBox[{"Most", "@", 
               RowBox[{"ArrayRules", "[", "#", "]"}]}]}], "&"}], ",", 
            RowBox[{
             RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], "[", 
             "\"\<HBloch\>\"", "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"All", ",", "2"}], "}"}]}], "]"}], ",", 
          RowBox[{"Rule", "[", 
           RowBox[{"_", ",", 
            RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"springconstants", "=", 
        RowBox[{"springconstants", "/.", 
         RowBox[{
          RowBox[{"Rule", "[", 
           RowBox[{
            RowBox[{"x", ":", 
             RowBox[{"{", 
              RowBox[{"0", ".."}], "}"}]}], ",", "A_"}], "]"}], 
          "\[RuleDelayed]", 
          RowBox[{"Rule", "[", 
           RowBox[{"x", ",", 
            RowBox[{"DeleteCases", "[", 
             RowBox[{"A", ",", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "_"}]}], "]"}]}],
            "]"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"distances", "=", 
        RowBox[{"DeleteCases", "[", 
         RowBox[{
          RowBox[{"MapAt", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Sort", "@", 
              RowBox[{"Most", "@", 
               RowBox[{"ArrayRules", "[", "#", "]"}]}]}], "&"}], ",", 
            RowBox[{
             RowBox[{"mesh", "[", "\"\<EquilibriumDistances\>\"", "]"}], "[", 
             "\"\<HBloch\>\"", "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"All", ",", "2"}], "}"}]}], "]"}], ",", 
          RowBox[{"Rule", "[", 
           RowBox[{"_", ",", 
            RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"distances", "=", 
        RowBox[{"distances", "/.", 
         RowBox[{
          RowBox[{"Rule", "[", 
           RowBox[{
            RowBox[{"x", ":", 
             RowBox[{"{", 
              RowBox[{"0", ".."}], "}"}]}], ",", "A_"}], "]"}], 
          "\[RuleDelayed]", 
          RowBox[{"Rule", "[", 
           RowBox[{"x", ",", 
            RowBox[{"DeleteCases", "[", 
             RowBox[{"A", ",", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "_"}]}], "]"}]}],
            "]"}]}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Linked", " ", "pairs"}], ",", " ", 
         RowBox[{"including", " ", "redundant", " ", 
          RowBox[{"(", 
           RowBox[{"both", " ", 
            RowBox[{"{", 
             RowBox[{"i", ",", "j"}], "}"}], " ", "and", " ", 
            RowBox[{"{", 
             RowBox[{"j", ",", "i"}], "}"}]}], ")"}]}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"pairs", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"Flatten", "[", 
           RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
         RowBox[{"springconstants", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2", ",", "All", ",", "1"}], "]"}], "]"}]}]}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"A", " ", "list", " ", "of", " ", "the", " ", "form", " ", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"pairindex1", ",", " ", "pairindex2"}], "}"}], "..."}], 
            "}"}], ".", " ", "This"}], " ", "computes", " ", "the", " ", 
          "indices", " ", "of", " ", "all", " ", "possible", " ", "pairs", 
          " ", "of", " ", "pairs", " ", "in", " ", "a", " ", "listofpairs", 
          " ", "that", " ", "share", " ", "the", " ", "*", "last", "*", " ", 
          "element", " ", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"i", ".", "e", ".", " ", "the"}], " ", "hub", " ", 
             "index"}], ")"}], ".", " ", "This"}], " ", "gives", " ", "all", 
          " ", "pairs", " ", "of", " ", "spokes", " ", "from", " ", "the", 
          " ", "same", " ", 
          RowBox[{"hub", ".", " ", "We"}], " ", "pick", " ", "only", " ", 
          "those", " ", "for", " ", "which", " ", "a", " ", "non"}], "-", 
         RowBox[{"zero", " ", 
          RowBox[{"(", 
           RowBox[{"or", " ", "symbolic"}], ")"}], " ", "hub", " ", 
          "constant", " ", 
          RowBox[{"exists", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"pairsofpairs", "=", 
        RowBox[{
         RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Pick", "[", 
              RowBox[{"#", ",", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"!", 
                    RowBox[{"NumericQ", "[", "#", "]"}]}], "||", 
                   RowBox[{
                    RowBox[{"N", "@", "#"}], "\[NotEqual]", "0."}]}], "&"}], 
                 ")"}], "/@", 
                RowBox[{"hubs", "[", 
                 RowBox[{"[", 
                  RowBox[{"#", "[", 
                   RowBox[{"[", 
                    RowBox[{"All", ",", "1", ",", "1", ",", "1"}], "]"}], 
                   "]"}], "]"}], "]"}]}]}], "]"}], "&"}], "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Subsets", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", "2", "}"}]}], "]"}], "&"}], "/@", 
             RowBox[{"Sort", "@", 
              RowBox[{"Gather", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
                   RowBox[{"Range", "[", 
                    RowBox[{"Length", "[", "pairs", "]"}], "]"}]}], "}"}], 
                 "\[Transpose]"}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"#1", "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
                  RowBox[{"#2", "[", 
                   RowBox[{"[", "1", "]"}], "]"}]}], "&"}]}], "]"}]}]}], 
            "]"}], ",", "\[IndentingNewLine]", "1"}], "]"}], "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"For", " ", "each", " ", "pair", " ", "j"}], "=", "1"}], 
         ",", "2", ",", "...", ",", " ", 
         RowBox[{
          RowBox[{"bravaisindices", "[", 
           RowBox[{"[", "j", "]"}], "]"}], " ", "gives", " ", "the", " ", 
          "corresponding", " ", "Bravais", " ", "indices", " ", "by", " ", 
          "which", " ", "the", " ", "first", " ", "site", " ", "of", " ", 
          "the", " ", "pair", " ", "is", " ", "shifted"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"bravaisindices", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"Flatten", "[", 
           RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"ConstantArray", "[", 
             RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"springconstants", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
             RowBox[{"Length", "/@", 
              RowBox[{"springconstants", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "}"}]}], 
          "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"(*", 
           RowBox[{
           "Creates", " ", "flat", " ", "arrays", " ", "to", " ", "feed", " ",
             "into", " ", "Compile"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"$zeroes", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"0.", ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"mesh", "[", "\"\<NumberOfSites\>\"", "]"}], ",", 
                RowBox[{"mesh", "[", "\"\<LatticeDimensions\>\"", "]"}]}], 
               "}"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"$hubs", "=", "hubs"}], ",", "\[IndentingNewLine]", 
           RowBox[{"$pairs", "=", "pairs"}], ",", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"A", " ", "spurious", " ", 
              RowBox[{"{", 
               RowBox[{"0", ",", "0"}], "}"}], " ", "element", " ", "is", " ",
               "appended", " ", "to", " ", "pairsofpairs", " ", "to", " ", 
              "avoid", " ", "problems", " ", "in", " ", "Compile", " ", "for",
               " ", "the", " ", "case", " ", "pairsofpairs"}], "=", 
             RowBox[{"{", "}"}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"$pairsofpairs", "=", 
            RowBox[{
             RowBox[{
              RowBox[{"Append", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "0"}], "}"}]}], "]"}], "&"}], "@", 
             "pairsofpairs"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"$springs", "=", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"N", "@", 
                RowBox[{"Flatten", "[", 
                 RowBox[{"#", ",", "1"}], "]"}]}], "&"}], "@", 
              RowBox[{"springconstants", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "2", ",", "All", ",", "2"}], "]"}], 
               "]"}]}], ")"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"$dist", "=", 
            RowBox[{
             RowBox[{
              RowBox[{"N", "@", 
               RowBox[{"Flatten", "[", 
                RowBox[{"#", ",", "1"}], "]"}]}], "&"}], "@", 
             RowBox[{"distances", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "2", ",", "All", ",", "2"}], "]"}], 
              "]"}]}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"$bravaisvectors", "=", 
            RowBox[{"mesh", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"$bravaisindices", "=", "bravaisindices"}]}], "}"}], ",", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"pairs", "===", 
             RowBox[{"{", "}"}]}], ",", 
            RowBox[{"Return", "[", 
             RowBox[{"0", "&"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Or", "@@", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"!", 
                    RowBox[{"VectorQ", "[", 
                    RowBox[{"#", ",", "NumericQ"}], "]"}]}], "&"}], "/@", 
                  RowBox[{"{", 
                   RowBox[{"$hubs", ",", "$springs", ",", " ", "$dist"}], 
                   "}"}]}], ")"}]}], "||", 
               RowBox[{"Or", "@@", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"!", 
                    RowBox[{"MatrixQ", "[", 
                    RowBox[{"#", ",", "NumericQ"}], "]"}]}], "&"}], "/@", 
                  RowBox[{"{", 
                   RowBox[{"$pairs", ",", "$pairsofpairs"}], "}"}]}], 
                 ")"}]}]}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"Print", "[", "\"\<Symbolic processing\>\"", "]"}], 
               ";", "#"}], ",", "\[IndentingNewLine]", 
              RowBox[{"Compile", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"{", 
                  RowBox[{"r", ",", "_Real", ",", "2"}], "}"}], "}"}], ",", 
                RowBox[{"#", "[", "r", "]"}]}], "]"}]}], "]"}], "&"}], "@", 
           "\[IndentingNewLine]", 
           RowBox[{"Function", "[", 
            RowBox[{"r", ",", 
             RowBox[{"Module", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"f", "=", "$zeroes"}], ",", 
                 RowBox[{"i", "=", "0"}], ",", 
                 RowBox[{"j", "=", "0"}], ",", 
                 RowBox[{"k", "=", "0"}]}], "}"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"Do", "[", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"i", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"j", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"$springs", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], 
                    FractionBox[
                    RowBox[{"#", " "}], 
                    RowBox[{"Norm", "[", "#", "]"}]], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Norm", "[", "#", "]"}], "-", 
                    RowBox[{"$dist", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ")"}]}]}], ";"}], 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"springs", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], 
                    FractionBox[
                    RowBox[{"#", " "}], 
                    RowBox[{"Norm", "[", "#", "]"}]], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Norm", "[", "#", "]"}], "-", 
                    RowBox[{"dist", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ")"}]}]}], "*)"}], 
                    ")"}], "&"}], "@", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ".", "$bravaisvectors"}], 
                    "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], ")"}]}]}], ",", 
                  "\[IndentingNewLine]", 
                  RowBox[{"{", 
                   RowBox[{"n", ",", "1", ",", 
                    RowBox[{"Length", "@", "$springs"}]}], "}"}]}], "]"}], 
                ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{
                  "We", " ", "now", " ", "add", " ", "the", " ", "three"}], 
                  "-", 
                  RowBox[{"body", " ", "hub", " ", 
                   RowBox[{"terms", ".", " ", "Note"}], " ", "that", " ", "i",
                    " ", "starts", " ", "at", " ", "2", " ", "to", " ", 
                   "skip", " ", "the", " ", "spurious", " ", 
                   RowBox[{"{", 
                    RowBox[{"0", ",", "0"}], "}"}], " ", "term"}]}], "*)"}], 
                "\[IndentingNewLine]", 
                RowBox[{"Do", "[", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"i", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                   RowBox[{"j", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                   RowBox[{"k", "=", 
                    RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"$hubs", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#2", "]"}], "2"], "#1"}], "+", 
                    RowBox[{
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#1", "]"}], "2"], "#2"}], "-", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"#1", ".", "#2"}], ")"}], 
                    RowBox[{"(", 
                    RowBox[{"#1", "+", "#2"}], ")"}]}]}], ")"}]}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"$hubs", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"-", 
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#2", "]"}], "2"]}], "#1"}], "+", 
                    RowBox[{"#2", 
                    RowBox[{"(", 
                    RowBox[{"#1", ".", "#2"}], ")"}]}]}], ")"}]}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"$hubs", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"-", 
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#1", "]"}], "2"]}], "#2"}], "+", 
                    RowBox[{"#1", 
                    RowBox[{"(", 
                    RowBox[{"#1", ".", "#2"}], ")"}]}]}], ")"}]}]}], ";"}], 
                    ")"}], "&"}], "[", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", 
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], "]"}], "]"}], ".", 
                    "$bravaisvectors"}], "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", 
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}], "]"}], "]"}], ".", 
                    "$bravaisvectors"}], "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}]}], "]"}]}], ",", 
                  "\[IndentingNewLine]", 
                  RowBox[{"{", 
                   RowBox[{"n", ",", "1", ",", 
                    RowBox[{
                    RowBox[{"Length", "@", "$pairsofpairs"}], "-", "1"}]}], 
                   "}"}]}], "]"}], ";", "\[IndentingNewLine]", "f"}]}], 
              "]"}]}], "]"}]}]}]}], "\[IndentingNewLine]", 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "*)"}]], "Input",
 CellChangeTimes->{{3.6309193010370197`*^9, 3.630919325073204*^9}, {
   3.6309193897579193`*^9, 3.63091941005582*^9}, {3.630919449587296*^9, 
   3.63091952375149*^9}, {3.630919778116992*^9, 3.63091992247537*^9}, {
   3.63091995322577*^9, 3.6309200273530416`*^9}, {3.6309201399606867`*^9, 
   3.6309201467523527`*^9}, {3.630920194270729*^9, 3.6309205230857363`*^9}, {
   3.630920559444175*^9, 3.6309208652867603`*^9}, {3.630921065571209*^9, 
   3.630921254569552*^9}, {3.6309213338605213`*^9, 3.6309213671091557`*^9}, {
   3.630921496837274*^9, 3.630921540213586*^9}, {3.63092159478454*^9, 
   3.630921682156302*^9}, {3.630921774847472*^9, 3.6309218254545813`*^9}, {
   3.63092186718836*^9, 3.630921885376794*^9}, {3.6309219234550133`*^9, 
   3.630921928334446*^9}, {3.630922126205213*^9, 3.63092218578083*^9}, {
   3.6309222727819023`*^9, 3.630922503612417*^9}, 3.630922547832448*^9, {
   3.630922594096949*^9, 3.630922697043468*^9}, {3.630922734279202*^9, 
   3.6309227409899473`*^9}, {3.630922775406673*^9, 3.630922841961195*^9}, {
   3.630922888615735*^9, 3.6309229179888773`*^9}, {3.63092296635548*^9, 
   3.630923025655892*^9}, {3.630923074566073*^9, 3.6309232637889442`*^9}, {
   3.63092339198348*^9, 3.630923442164278*^9}, {3.630923483082436*^9, 
   3.63092364049753*^9}, {3.6309237233344393`*^9, 3.6309237876025047`*^9}, {
   3.630923838395052*^9, 3.630923852239296*^9}, {3.630924530174919*^9, 
   3.63092453899502*^9}, {3.63092457133121*^9, 3.630924576394932*^9}, {
   3.630924616775379*^9, 3.6309246202970123`*^9}, {3.630924756642914*^9, 
   3.630924773456244*^9}, {3.6309248506364517`*^9, 3.6309248521725683`*^9}, {
   3.630924960478999*^9, 3.6309250374380627`*^9}, {3.630925072576796*^9, 
   3.630925089127832*^9}, {3.6309251323984327`*^9, 3.630925190579365*^9}, 
   3.63092525969866*^9, {3.630929835901774*^9, 3.6309298389617167`*^9}, {
   3.630930282598175*^9, 3.630930335924121*^9}, {3.630930398236156*^9, 
   3.630930407319578*^9}, {3.630930438420117*^9, 3.63093050312641*^9}, {
   3.63093059188741*^9, 3.630930705792245*^9}, {3.630930755078561*^9, 
   3.6309307630457067`*^9}, {3.630930813732174*^9, 3.630930834179377*^9}, {
   3.6309309497784433`*^9, 3.6309309858783197`*^9}, {3.630931085553184*^9, 
   3.630931148478424*^9}, {3.630990257064806*^9, 3.630990262573716*^9}, {
   3.6309902964727907`*^9, 3.6309903111713753`*^9}, {3.630990428213726*^9, 
   3.630990480874913*^9}, 3.630990774364452*^9, {3.630992884781665*^9, 
   3.630992927726652*^9}, {3.630993001855914*^9, 3.6309930115236464`*^9}, {
   3.630993382758275*^9, 3.630993518164414*^9}, {3.630994158765933*^9, 
   3.630994191514854*^9}, {3.630994699305677*^9, 3.630995060943902*^9}, {
   3.630995257720728*^9, 3.63099526882157*^9}, {3.6309953003086042`*^9, 
   3.630995394375392*^9}, {3.630996328480689*^9, 3.630996487544077*^9}, 
   3.630996544519503*^9, {3.630996601459955*^9, 3.6309966409763327`*^9}, {
   3.630996682074317*^9, 3.630996740227653*^9}, {3.63099678199755*^9, 
   3.630996870942089*^9}, {3.630996995363329*^9, 3.630997236675865*^9}, {
   3.630997307064878*^9, 3.630997462944667*^9}, {3.630997497454095*^9, 
   3.630997584306614*^9}, {3.630997716835683*^9, 3.630997742678494*^9}, {
   3.6309977735641813`*^9, 3.630997805783823*^9}, 3.630997836524399*^9, {
   3.630997886987939*^9, 3.6309979214484367`*^9}, {3.6309979763335943`*^9, 
   3.630998036347896*^9}, {3.630998084548416*^9, 3.630998127177849*^9}, {
   3.6309981581331673`*^9, 3.630998207826366*^9}, 3.630998280202652*^9, {
   3.630998358236642*^9, 3.6309983584987698`*^9}, {3.630998508510564*^9, 
   3.630998523978994*^9}, {3.630998633463934*^9, 3.630998665931582*^9}, {
   3.63099894631853*^9, 3.630998963102333*^9}, {3.630999157022423*^9, 
   3.630999182491417*^9}, {3.630999220329793*^9, 3.63099924078465*^9}, {
   3.6309994388893423`*^9, 3.630999443020793*^9}, {3.630999573649487*^9, 
   3.630999636172605*^9}, {3.630999837290841*^9, 3.630999848409732*^9}, {
   3.631007442194697*^9, 3.631007579288207*^9}, {3.6310076481960917`*^9, 
   3.6310076484285088`*^9}, {3.631007684274383*^9, 3.631007829518847*^9}, {
   3.6310078854054832`*^9, 3.631007916313216*^9}, {3.6310079571993523`*^9, 
   3.6310080447631063`*^9}, {3.631008094673525*^9, 3.631008098305176*^9}, {
   3.631008301095837*^9, 3.631008433105544*^9}, {3.6310084701908617`*^9, 
   3.6310085802726088`*^9}, {3.6310086113115892`*^9, 3.631008611671257*^9}, {
   3.631008643670381*^9, 3.631008843020464*^9}, {3.631008905849433*^9, 
   3.631009056433755*^9}, {3.631009090705791*^9, 3.631009091392325*^9}, {
   3.6310091253364697`*^9, 3.631009127207663*^9}, {3.63100922958899*^9, 
   3.6310092711183653`*^9}, {3.6310093066641483`*^9, 3.631009389675878*^9}, {
   3.631009477511038*^9, 3.631009486740411*^9}, 3.6310096129490957`*^9, 
   3.631009715616776*^9, {3.63100988866094*^9, 3.631009915846689*^9}, {
   3.6310099640229807`*^9, 3.631009969499704*^9}, {3.6310100176276827`*^9, 
   3.6310100912529173`*^9}, {3.631010133932247*^9, 3.6310101418903837`*^9}, 
   3.631012043055511*^9, 3.631012086354486*^9, 3.631012484303556*^9, 
   3.631012816942981*^9, {3.63101405489675*^9, 3.631014061824768*^9}, {
   3.631014094019064*^9, 3.631014097899107*^9}, {3.631014349142488*^9, 
   3.6310144748424997`*^9}, {3.631015041318314*^9, 3.631015055597533*^9}, {
   3.631015094029242*^9, 3.6310151968407927`*^9}, {3.631015227107911*^9, 
   3.631015242395608*^9}, {3.6310153244690437`*^9, 3.631015393461279*^9}, {
   3.631015441085806*^9, 3.6310154920632257`*^9}, 3.631015772326062*^9, {
   3.631015838758647*^9, 3.631015875166643*^9}, {3.63101592794384*^9, 
   3.631016000692865*^9}, 3.631016089431366*^9, {3.631016145886911*^9, 
   3.631016192045609*^9}, {3.631016232535656*^9, 3.631016303659361*^9}, {
   3.631016349196949*^9, 3.631016350940433*^9}, {3.631016395540513*^9, 
   3.63101643234865*^9}, {3.631016471302939*^9, 3.631016562218589*^9}, {
   3.631016593537264*^9, 3.631016612683766*^9}, {3.6310174281690474`*^9, 
   3.631017429406975*^9}, {3.631017494071981*^9, 3.631017573298204*^9}, {
   3.631017620856072*^9, 3.631017626879431*^9}, {3.631017676108334*^9, 
   3.631017682946746*^9}, {3.631017782222698*^9, 3.631017797767149*^9}, {
   3.6310178659097958`*^9, 3.6310178697702217`*^9}, 3.631017951207736*^9, {
   3.6310180247001266`*^9, 3.6310180487018013`*^9}, {3.631018082752441*^9, 
   3.6310180868076143`*^9}, {3.6310183984455633`*^9, 3.631018400968884*^9}, {
   3.631018511285997*^9, 3.6310185893617153`*^9}, {3.631025378257938*^9, 
   3.631025400507201*^9}, {3.631025430917122*^9, 3.6310255149620237`*^9}, {
   3.6310255613602858`*^9, 3.631025598264305*^9}, {3.63102566300513*^9, 
   3.631025710926879*^9}, 3.631025749681938*^9, {3.6310257868762827`*^9, 
   3.631025830688904*^9}, {3.6310260382130003`*^9, 3.631026050773061*^9}, {
   3.63102608564857*^9, 3.631026139425902*^9}, {3.631026176628892*^9, 
   3.6310262599831343`*^9}, {3.631026363527863*^9, 3.631026447626684*^9}, {
   3.631026499990005*^9, 3.631026580845372*^9}, {3.6310266233271723`*^9, 
   3.6310267178682737`*^9}, {3.631026759198155*^9, 3.631026829482772*^9}, {
   3.631026860633197*^9, 3.631027020173052*^9}, {3.6310274020549707`*^9, 
   3.63102743088396*^9}, {3.631027670319418*^9, 3.631027682817896*^9}, {
   3.63102797878587*^9, 3.631028101406629*^9}, {3.63102817491641*^9, 
   3.631028184026147*^9}, {3.631028275536755*^9, 3.631028475971657*^9}, {
   3.631028542723081*^9, 3.631028575489538*^9}, {3.63102863202678*^9, 
   3.631028874707932*^9}, {3.631029014248273*^9, 3.631029033103806*^9}, {
   3.631029131103689*^9, 3.631029139445382*^9}, {3.6310292181353292`*^9, 
   3.631029244808547*^9}, {3.631029386127698*^9, 3.631029409213805*^9}, {
   3.6310294415532703`*^9, 3.631029533358193*^9}, 3.631029582500388*^9, {
   3.6310296132029552`*^9, 3.631029659877994*^9}, {3.6310297532927523`*^9, 
   3.631029784140555*^9}, {3.631029820877121*^9, 3.6310299797381372`*^9}, {
   3.631030031746394*^9, 3.631030068132683*^9}, {3.63103011486406*^9, 
   3.631030118399547*^9}, {3.631030166982397*^9, 3.631030169446281*^9}, {
   3.631030251364287*^9, 3.6310302942496643`*^9}, {3.631030469206221*^9, 
   3.63103047062101*^9}, 3.6310305116850433`*^9, {3.631030552530373*^9, 
   3.6310305642089252`*^9}, {3.631030595219084*^9, 3.6310305954021273`*^9}, {
   3.631030636016594*^9, 3.631030655646884*^9}, {3.631031187158512*^9, 
   3.6310312215078382`*^9}, 3.6310313665666323`*^9, {3.631031992281672*^9, 
   3.631032034030159*^9}, {3.631195137303999*^9, 3.631195152476172*^9}, {
   3.631195194235313*^9, 3.631195200732065*^9}, {3.6311954706937323`*^9, 
   3.631195489277069*^9}, {3.631195599058264*^9, 3.6311956767839823`*^9}, {
   3.63119573573558*^9, 3.631195790509362*^9}, {3.6311958417606297`*^9, 
   3.631195922211488*^9}, {3.631195970589918*^9, 3.631195978825136*^9}, 
   3.631196137222548*^9, {3.631196181710845*^9, 3.6311962668259068`*^9}, {
   3.631196383720441*^9, 3.631196385024242*^9}, {3.631196574091817*^9, 
   3.631196575195518*^9}, {3.631196667377493*^9, 3.6311967037436237`*^9}, {
   3.631196885188718*^9, 3.63119688617236*^9}, {3.631197193557078*^9, 
   3.6311971942682962`*^9}, {3.631197344793109*^9, 3.6311973729526587`*^9}, {
   3.631197409403523*^9, 3.6311975214569483`*^9}, {3.631197724416111*^9, 
   3.631197769864181*^9}, {3.6311978000234003`*^9, 3.631197806471034*^9}, {
   3.63119788943554*^9, 3.6311979366548223`*^9}, 3.631197973203986*^9, {
   3.631198025545341*^9, 3.631198040618228*^9}, {3.63119823500478*^9, 
   3.631198282689166*^9}, {3.631253966774722*^9, 3.6312539991180162`*^9}, {
   3.631269962525494*^9, 3.6312699658623734`*^9}, {3.631270200677253*^9, 
   3.631270313346004*^9}, {3.631270426992551*^9, 3.631270437212152*^9}, {
   3.635236093031986*^9, 3.635236093039255*^9}, 3.6391285458394423`*^9, 
   3.651811864807908*^9},
 CellLabel->
  "In[388]:=",ExpressionUUID->"0f2ea8e6-06df-45da-8312-20a24d3091b0"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Elastic energy [normalized hubs]", "Subsubsection",
 CellChangeTimes->{{3.6309192955790453`*^9, 3.6309192975223513`*^9}, {
  3.630922601707046*^9, 3.630922609825897*^9}, {3.630929848070549*^9, 
  3.630929848966837*^9}, {3.631270553248591*^9, 3.631270576951161*^9}, {
  3.63127147645254*^9, 
  3.631271477115543*^9}},ExpressionUUID->"cde515fd-aa2a-4e86-a634-\
f69ea6b86986"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DistortionMatrix", "::", "usage"}], "=", 
    "\"\<Option for ElasticEnergy that specifies matrix M, such that mesh \
coordinates \!\(\*SubscriptBox[\(r\), \(i\)]\) should be transformed into \
(1+M).\!\(\*SubscriptBox[\(r\), \(i\)]\)\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "ElasticEnergy", "]"}], ":=", 
   RowBox[{"{", 
    RowBox[{"DistortionMatrix", "\[Rule]", "None"}], "}"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ElasticEnergy", "[", 
    RowBox[{"lattice_MQLattice", ",", "mesh_MQSpringMesh", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{"ElasticEnergy", "[", 
     RowBox[{"mesh", ",", " ", "opts"}], "]"}], "[", 
    RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ElasticEnergy", "[", 
    RowBox[{"mesh_MQSpringMesh", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "springconstants", ",", "hubs", ",", "distances", ",", " ", 
       "distortionmatrix", ",", " ", "pairs", ",", "pairsofpairs", ",", " ", 
       "bravaisindices", ",", " ", "nonredundant"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"distortionmatrix", "=", 
       RowBox[{
        RowBox[{"N", "@", 
         RowBox[{"IdentityMatrix", "[", 
          RowBox[{"mesh", "[", "\"\<EmbeddingDimensions\>\"", "]"}], "]"}]}], 
        "+", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"MatrixQ", "[", 
           RowBox[{"OptionValue", "[", "DistortionMatrix", "]"}], "]"}], ",", 
          
          RowBox[{"OptionValue", "[", "DistortionMatrix", "]"}], ",", "0"}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"This", " ", "has", " ", "a", " ", "structure", " ", 
        RowBox[{"{", 
         SubscriptBox["h", "i"], "}"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"hubs", "=", 
       RowBox[{"Normal", "@", 
        RowBox[{"Diagonal", "@", 
         RowBox[{
          RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], "[", 
          "\"\<H\>\"", "]"}]}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{"This", " ", "has", " ", "a", " ", "structure", " ", 
          RowBox[{"{", "BravaisIndices", "}"}]}], "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i", ",", "j"}], "}"}], "\[Rule]", 
           RowBox[{
            RowBox[{
             SubscriptBox["t", "ij"], " ", 
             RowBox[{"(", 
              RowBox[{"or", " ", 
               SubscriptBox["r0", "ij"]}], ")"}]}], "..."}]}], "}"}]}], ",", 
        " ", 
        RowBox[{
        "where", " ", "i", " ", "is", " ", "shifted", " ", "by", " ", 
         "Bravais", " ", "indices"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"removing", " ", "onsite", " ", "i"}], "\[Equal]", 
          RowBox[{"j", " ", "terms", " ", "for", " ", "BravaisIndices"}]}], 
         "=", 
         RowBox[{"{", 
          RowBox[{"0", "..."}], "}"}]}], ",", " ", 
        RowBox[{"(", 
         RowBox[{"or", " ", 
          RowBox[{"{", "}"}], " ", "for", " ", "closed", " ", "systems"}], 
         ")"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"springconstants", "=", 
       RowBox[{"DeleteCases", "[", 
        RowBox[{
         RowBox[{"MapAt", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Sort", "@", 
             RowBox[{"Most", "@", 
              RowBox[{"ArrayRules", "[", "#", "]"}]}]}], "&"}], ",", 
           RowBox[{
            RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], "[", 
            "\"\<HBloch\>\"", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"All", ",", "2"}], "}"}]}], "]"}], ",", 
         RowBox[{"Rule", "[", 
          RowBox[{"_", ",", 
           RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"springconstants", "=", 
       RowBox[{"springconstants", "/.", 
        RowBox[{
         RowBox[{"Rule", "[", 
          RowBox[{
           RowBox[{"x", ":", 
            RowBox[{"{", 
             RowBox[{"0", "..."}], "}"}]}], ",", "A_"}], "]"}], 
         "\[RuleDelayed]", 
         RowBox[{"Rule", "[", 
          RowBox[{"x", ",", 
           RowBox[{"DeleteCases", "[", 
            RowBox[{"A", ",", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "_"}]}], "]"}]}], 
          "]"}]}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"distances", "=", 
       RowBox[{"DeleteCases", "[", 
        RowBox[{
         RowBox[{"MapAt", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Sort", "@", 
             RowBox[{"Most", "@", 
              RowBox[{"ArrayRules", "[", "#", "]"}]}]}], "&"}], ",", 
           RowBox[{
            RowBox[{"mesh", "[", "\"\<EquilibriumDistances\>\"", "]"}], "[", 
            "\"\<HBloch\>\"", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"All", ",", "2"}], "}"}]}], "]"}], ",", 
         RowBox[{"Rule", "[", 
          RowBox[{"_", ",", 
           RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"distances", "=", 
       RowBox[{"distances", "/.", 
        RowBox[{
         RowBox[{"Rule", "[", 
          RowBox[{
           RowBox[{"x", ":", 
            RowBox[{"{", 
             RowBox[{"0", "..."}], "}"}]}], ",", "A_"}], "]"}], 
         "\[RuleDelayed]", 
         RowBox[{"Rule", "[", 
          RowBox[{"x", ",", 
           RowBox[{"DeleteCases", "[", 
            RowBox[{"A", ",", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "_"}]}], "]"}]}], 
          "]"}]}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Linked", " ", "pairs"}], ",", " ", 
        RowBox[{"including", " ", "redundant", " ", 
         RowBox[{"(", 
          RowBox[{"both", " ", 
           RowBox[{"{", 
            RowBox[{"i", ",", "j"}], "}"}], " ", "and", " ", 
           RowBox[{"{", 
            RowBox[{"j", ",", "i"}], "}"}]}], ")"}]}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"pairs", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
        RowBox[{"springconstants", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2", ",", "All", ",", "1"}], "]"}], "]"}]}]}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"A", " ", "list", " ", "of", " ", "the", " ", "form", " ", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"pairindex1", ",", " ", "pairindex2"}], "}"}], "..."}], 
           "}"}], ".", " ", "This"}], " ", "computes", " ", "the", " ", 
         "indices", " ", "of", " ", "all", " ", "possible", " ", "pairs", " ",
          "of", " ", "pairs", " ", "in", " ", "a", " ", "listofpairs", " ", 
         "that", " ", "share", " ", "the", " ", "*", "last", "*", " ", 
         "element", " ", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"i", ".", "e", ".", " ", "the"}], " ", "hub", " ", 
            "index"}], ")"}], ".", " ", "We"}], " ", "take", " ", "care", " ",
          "to", " ", "remove", " ", "dangling", " ", "bonds", " ", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"the", " ", "DeleteCases"}], ")"}], ".", " ", "This"}], 
         " ", "gives", " ", "all", " ", "pairs", " ", "of", " ", "spokes", 
         " ", "from", " ", "the", " ", "same", " ", 
         RowBox[{"hub", ".", " ", "We"}], " ", "pick", " ", "only", " ", 
         "those", " ", "for", " ", "which", " ", "a", " ", "non"}], "-", 
        RowBox[{"zero", " ", 
         RowBox[{"(", 
          RowBox[{"or", " ", "symbolic"}], ")"}], " ", "hub", " ", "constant",
          " ", 
         RowBox[{"exists", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"pairsofpairs", "=", 
       RowBox[{
        RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Pick", "[", 
             RowBox[{"#", ",", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"!", 
                   RowBox[{"NumericQ", "[", "#", "]"}]}], "||", 
                  RowBox[{
                   RowBox[{"N", "@", "#"}], "\[NotEqual]", "0."}]}], "&"}], 
                ")"}], "/@", 
               RowBox[{"hubs", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", 
                   RowBox[{"All", ",", "1", ",", "1", ",", "1"}], "]"}], 
                  "]"}], "]"}], "]"}]}]}], "]"}], "&"}], "[", 
           RowBox[{
            RowBox[{
             RowBox[{"DeleteCases", "[", 
              RowBox[{"#", ",", 
               RowBox[{"{", "}"}]}], "]"}], "&"}], "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Subsets", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", "2", "}"}]}], "]"}], "&"}], "/@", 
             RowBox[{"Sort", "@", 
              RowBox[{"Gather", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
                   RowBox[{"Range", "[", 
                    RowBox[{"Length", "[", "pairs", "]"}], "]"}]}], "}"}], 
                 "\[Transpose]"}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"#1", "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
                  RowBox[{"#2", "[", 
                   RowBox[{"[", "1", "]"}], "]"}]}], "&"}]}], "]"}]}]}], 
            "]"}], "]"}], ",", "\[IndentingNewLine]", "1"}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{"For", " ", "each", " ", "pair", " ", "j"}], "=", "1"}], ",",
         "2", ",", "...", ",", " ", 
        RowBox[{
         RowBox[{"bravaisindices", "[", 
          RowBox[{"[", "j", "]"}], "]"}], " ", "gives", " ", "the", " ", 
         "corresponding", " ", "Bravais", " ", "indices", " ", "by", " ", 
         "which", " ", "the", " ", "first", " ", "site", " ", "of", " ", 
         "the", " ", "pair", " ", "is", " ", "shifted"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"bravaisindices", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ConstantArray", "[", 
            RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"springconstants", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
            RowBox[{"Length", "/@", 
             RowBox[{"springconstants", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "}"}]}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"(*", 
        RowBox[{"Non", "-", 
         RowBox[{
         "redundant", " ", "pairs", " ", "and", " ", "Bravais", " ", 
          "indices"}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"temp4", "=", 
         RowBox[{"nonredundant", "=", 
          RowBox[{"Last", "@", 
           RowBox[{"Transpose", "@", 
            RowBox[{"DeleteDuplicates", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{"pairs", ",", "bravaisindices", ",", " ", 
                 RowBox[{"Range", "@", 
                  RowBox[{"Length", "@", "pairs"}]}]}], "}"}], 
               "\[Transpose]"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"#1", "[", 
                 RowBox[{"[", 
                  RowBox[{"{", 
                   RowBox[{"1", ",", "2"}], "}"}], "]"}], "]"}], "\[Equal]", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"Reverse", "[", 
                   RowBox[{"#2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
                  RowBox[{"-", 
                   RowBox[{"#2", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}]}], "&"}]}], 
             "]"}]}]}]}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"(*", 
          RowBox[{
          "Creates", " ", "flat", " ", "arrays", " ", "to", " ", "feed", " ", 
           "into", " ", "Compile"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"$hubs", "=", "hubs"}], ",", "\[IndentingNewLine]", 
          RowBox[{"$matrix", "=", "distortionmatrix"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"$pairs", "=", "pairs"}], ",", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"A", " ", "spurious", " ", 
             RowBox[{"{", 
              RowBox[{"0", ",", "0"}], "}"}], " ", "element", " ", "is", " ", 
             "appended", " ", "to", " ", "pairsofpairs", " ", "to", " ", 
             "avoid", " ", "problems", " ", "in", " ", "Compile", " ", "for", 
             " ", "the", " ", "case", " ", "pairsofpairs"}], "=", 
            RowBox[{"{", "}"}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"$pairsofpairs", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"Append", "[", 
              RowBox[{"#", ",", 
               RowBox[{"{", 
                RowBox[{"0", ",", "0"}], "}"}]}], "]"}], "&"}], "@", 
            "pairsofpairs"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"$springs", "=", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"N", "@", 
               RowBox[{"Flatten", "[", 
                RowBox[{"#", ",", "1"}], "]"}]}], "&"}], "@", 
             RowBox[{"springconstants", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "2", ",", "All", ",", "2"}], "]"}], 
              "]"}]}], ")"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"$dist", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"N", "@", 
              RowBox[{"Flatten", "[", 
               RowBox[{"#", ",", "1"}], "]"}]}], "&"}], "@", 
            RowBox[{"distances", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2", ",", "All", ",", "2"}], "]"}], 
             "]"}]}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"$bravaisvectors", "=", 
           RowBox[{"mesh", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"$bravaisindices", "=", "bravaisindices"}]}], "}"}], ",", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"pairs", "===", 
            RowBox[{"{", "}"}]}], ",", 
           RowBox[{"Return", "[", 
            RowBox[{"0", "&"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Or", "@@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"!", 
                   RowBox[{"VectorQ", "[", 
                    RowBox[{"#", ",", "NumericQ"}], "]"}]}], "&"}], "/@", 
                 RowBox[{"{", 
                  RowBox[{"$hubs", ",", "$springs", ",", " ", "$dist"}], 
                  "}"}]}], ")"}]}], "||", 
              RowBox[{"Or", "@@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"!", 
                   RowBox[{"MatrixQ", "[", 
                    RowBox[{"#", ",", "NumericQ"}], "]"}]}], "&"}], "/@", 
                 RowBox[{"{", 
                  RowBox[{"$pairs", ",", "$pairsofpairs", ",", "$matrix"}], 
                  "}"}]}], ")"}]}]}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Print", "[", "\"\<Symbolic processing\>\"", "]"}], ";",
               "#"}], ",", "\[IndentingNewLine]", 
             RowBox[{"Compile", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"{", 
                 RowBox[{"r", ",", "_Real", ",", "2"}], "}"}], "}"}], ",", 
               RowBox[{"#", "[", "r", "]"}]}], "]"}]}], "]"}], "&"}], "@", 
          "\[IndentingNewLine]", 
          RowBox[{"Function", "[", 
           RowBox[{"r", ",", 
            RowBox[{"Module", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"e", "=", "0."}], ",", 
                RowBox[{"i", "=", "0"}], ",", 
                RowBox[{"j", "=", "0"}], ",", 
                RowBox[{"k", "=", "0"}]}], "}"}], ",", "\[IndentingNewLine]", 
              
              RowBox[{"(*", 
               RowBox[{
                RowBox[{"We", " ", "add", " ", "two"}], "-", 
                RowBox[{"body", " ", "spring", " ", 
                 RowBox[{"energies", ".", " ", "Extra"}], " ", 
                 RowBox[{"1", "/", "2"}], " ", "for", " ", "redundancy"}]}], 
               "*)"}], "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"Do", "[", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"i", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"j", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"e", "+=", 
                    RowBox[{
                    FractionBox["1", "2"], 
                    FractionBox["1", "2"], 
                    RowBox[{"$springs", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], 
                    SuperscriptBox[
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Norm", "[", "#", "]"}], "-", 
                    RowBox[{"$dist", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ")"}], "2"]}]}], "&"}], 
                   "[", "\[IndentingNewLine]", 
                   RowBox[{"$matrix", ".", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ".", "$bravaisvectors"}], 
                    "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], ")"}]}], "]"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"{", 
                  RowBox[{"n", ",", "1", ",", 
                   RowBox[{"Length", "@", "$pairs"}]}], "}"}]}], "]"}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"(*", 
                RowBox[{
                 RowBox[{
                 "We", " ", "now", " ", "add", " ", "the", " ", "three"}], 
                 "-", 
                 RowBox[{"body", " ", "hub", " ", 
                  RowBox[{"terms", ".", " ", "Note"}], " ", "that", " ", "k", 
                  " ", "starts", " ", "at", " ", "2", " ", "to", " ", "skip", 
                  " ", "the", " ", "spurious", " ", 
                  RowBox[{"{", 
                   RowBox[{"0", ",", "0"}], "}"}], " ", "term"}]}], "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{"Do", "[", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"i", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"j", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"k", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"e", "+=", 
                    RowBox[{
                    RowBox[{"$hubs", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], 
                    RowBox[{"(", 
                    FractionBox[
                    RowBox[{"(", 
                    RowBox[{"#1", ".", "#2"}], ")"}], 
                    RowBox[{
                    RowBox[{"Norm", "[", "#1", "]"}], 
                    RowBox[{"Norm", "[", "#2", "]"}]}]], ")"}]}]}], "&"}], 
                   "[", "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{"$matrix", ".", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", 
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], "]"}], "]"}], ".", 
                    "$bravaisvectors"}], "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ")"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"$matrix", ".", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", 
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}], "]"}], "]"}], ".", 
                    "$bravaisvectors"}], "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ")"}]}]}], "]"}]}], ",",
                  "\[IndentingNewLine]", 
                 RowBox[{"{", 
                  RowBox[{"n", ",", "1", ",", 
                   RowBox[{
                    RowBox[{"Length", "@", "$pairsofpairs"}], "-", "1"}]}], 
                  "}"}]}], "]"}], ";", "\[IndentingNewLine]", "e"}]}], 
             "]"}]}], "]"}]}]}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ElasticForces", "[", 
    RowBox[{"lattice_MQLattice", ",", "mesh_MQSpringMesh"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"ElasticForces", "[", "mesh", "]"}], "[", 
    RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ElasticForces", "[", "mesh_MQSpringMesh", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "springconstants", ",", "distances", ",", " ", "hubs", ",", "pairs", 
       ",", "pairsofpairs", ",", " ", "bravaisindices"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"This", " ", "has", " ", "a", " ", "structure", " ", 
       RowBox[{"{", 
        SubscriptBox["h", "i"], "}"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"hubs", "=", 
       RowBox[{"Normal", "@", 
        RowBox[{"Diagonal", "@", 
         RowBox[{
          RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], "[", 
          "\"\<H\>\"", "]"}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{"This", " ", "has", " ", "a", " ", "structure", " ", 
          RowBox[{"{", "BravaisIndices", "}"}]}], "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i", ",", "j"}], "}"}], "\[Rule]", 
           RowBox[{
            RowBox[{
             SubscriptBox["t", "ij"], " ", 
             RowBox[{"(", 
              RowBox[{"or", " ", 
               SubscriptBox["r0", "ij"]}], ")"}]}], "..."}]}], "}"}]}], ",", 
        " ", 
        RowBox[{
        "where", " ", "i", " ", "is", " ", "shifted", " ", "by", " ", 
         "Bravais", " ", "indices"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"removing", " ", "onsite", " ", "i"}], "\[Equal]", 
          RowBox[{"j", " ", "terms", " ", "for", " ", "BravaisIndices"}]}], 
         "=", 
         RowBox[{"{", 
          RowBox[{"0", "..."}], "}"}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"springconstants", "=", 
       RowBox[{"DeleteCases", "[", 
        RowBox[{
         RowBox[{"MapAt", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Sort", "@", 
             RowBox[{"Most", "@", 
              RowBox[{"ArrayRules", "[", "#", "]"}]}]}], "&"}], ",", 
           RowBox[{
            RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], "[", 
            "\"\<HBloch\>\"", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"All", ",", "2"}], "}"}]}], "]"}], ",", 
         RowBox[{"Rule", "[", 
          RowBox[{"_", ",", 
           RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"springconstants", "=", 
       RowBox[{"springconstants", "/.", 
        RowBox[{
         RowBox[{"Rule", "[", 
          RowBox[{
           RowBox[{"x", ":", 
            RowBox[{"{", 
             RowBox[{"0", "..."}], "}"}]}], ",", "A_"}], "]"}], 
         "\[RuleDelayed]", 
         RowBox[{"Rule", "[", 
          RowBox[{"x", ",", 
           RowBox[{"DeleteCases", "[", 
            RowBox[{"A", ",", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "_"}]}], "]"}]}], 
          "]"}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"distances", "=", 
       RowBox[{"DeleteCases", "[", 
        RowBox[{
         RowBox[{"MapAt", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Sort", "@", 
             RowBox[{"Most", "@", 
              RowBox[{"ArrayRules", "[", "#", "]"}]}]}], "&"}], ",", 
           RowBox[{
            RowBox[{"mesh", "[", "\"\<EquilibriumDistances\>\"", "]"}], "[", 
            "\"\<HBloch\>\"", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"All", ",", "2"}], "}"}]}], "]"}], ",", 
         RowBox[{"Rule", "[", 
          RowBox[{"_", ",", 
           RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"distances", "=", 
       RowBox[{"distances", "/.", 
        RowBox[{
         RowBox[{"Rule", "[", 
          RowBox[{
           RowBox[{"x", ":", 
            RowBox[{"{", 
             RowBox[{"0", "..."}], "}"}]}], ",", "A_"}], "]"}], 
         "\[RuleDelayed]", 
         RowBox[{"Rule", "[", 
          RowBox[{"x", ",", 
           RowBox[{"DeleteCases", "[", 
            RowBox[{"A", ",", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "_"}]}], "]"}]}], 
          "]"}]}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Linked", " ", "pairs"}], ",", " ", 
        RowBox[{"including", " ", "redundant", " ", 
         RowBox[{"(", 
          RowBox[{"both", " ", 
           RowBox[{"{", 
            RowBox[{"i", ",", "j"}], "}"}], " ", "and", " ", 
           RowBox[{"{", 
            RowBox[{"j", ",", "i"}], "}"}]}], ")"}]}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"pairs", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
        RowBox[{"springconstants", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2", ",", "All", ",", "1"}], "]"}], "]"}]}]}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"A", " ", "list", " ", "of", " ", "the", " ", "form", " ", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"pairindex1", ",", " ", "pairindex2"}], "}"}], "..."}], 
           "}"}], ".", " ", "This"}], " ", "computes", " ", "the", " ", 
         "indices", " ", "of", " ", "all", " ", "possible", " ", "pairs", " ",
          "of", " ", "pairs", " ", "in", " ", "a", " ", "listofpairs", " ", 
         "that", " ", "share", " ", "the", " ", "*", "last", "*", " ", 
         "element", " ", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"i", ".", "e", ".", " ", "the"}], " ", "hub", " ", 
            "index"}], ")"}], ".", " ", "We"}], " ", "take", " ", "care", " ",
          "to", " ", "remove", " ", "dangling", " ", "bonds", " ", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"the", " ", "DeleteCases"}], ")"}], ".", " ", "This"}], 
         " ", "gives", " ", "all", " ", "pairs", " ", "of", " ", "spokes", 
         " ", "from", " ", "the", " ", "same", " ", 
         RowBox[{"hub", ".", " ", "We"}], " ", "pick", " ", "only", " ", 
         "those", " ", "for", " ", "which", " ", "a", " ", "non"}], "-", 
        RowBox[{"zero", " ", 
         RowBox[{"(", 
          RowBox[{"or", " ", "symbolic"}], ")"}], " ", "hub", " ", "constant",
          " ", 
         RowBox[{"exists", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"pairsofpairs", "=", 
       RowBox[{
        RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Pick", "[", 
             RowBox[{"#", ",", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"!", 
                   RowBox[{"NumericQ", "[", "#", "]"}]}], "||", 
                  RowBox[{
                   RowBox[{"N", "@", "#"}], "\[NotEqual]", "0."}]}], "&"}], 
                ")"}], "/@", 
               RowBox[{"hubs", "[", 
                RowBox[{"[", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", 
                   RowBox[{"All", ",", "1", ",", "1", ",", "1"}], "]"}], 
                  "]"}], "]"}], "]"}]}]}], "]"}], "&"}], "[", 
           RowBox[{
            RowBox[{
             RowBox[{"DeleteCases", "[", 
              RowBox[{"#", ",", 
               RowBox[{"{", "}"}]}], "]"}], "&"}], "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Subsets", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", "2", "}"}]}], "]"}], "&"}], "/@", 
             RowBox[{"Sort", "@", 
              RowBox[{"Gather", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", 
                   RowBox[{"Range", "[", 
                    RowBox[{"Length", "[", "pairs", "]"}], "]"}]}], "}"}], 
                 "\[Transpose]"}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"#1", "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
                  RowBox[{"#2", "[", 
                   RowBox[{"[", "1", "]"}], "]"}]}], "&"}]}], "]"}]}]}], 
            "]"}], "]"}], ",", "\[IndentingNewLine]", "1"}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "All", ",", "2"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{"For", " ", "each", " ", "pair", " ", "j"}], "=", "1"}], ",",
         "2", ",", "...", ",", " ", 
        RowBox[{
         RowBox[{"bravaisindices", "[", 
          RowBox[{"[", "j", "]"}], "]"}], " ", "gives", " ", "the", " ", 
         "corresponding", " ", "Bravais", " ", "indices", " ", "by", " ", 
         "which", " ", "the", " ", "first", " ", "site", " ", "of", " ", 
         "the", " ", "pair", " ", "is", " ", "shifted"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"bravaisindices", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ConstantArray", "[", 
            RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"springconstants", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
            RowBox[{"Length", "/@", 
             RowBox[{"springconstants", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "}"}]}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"(*", 
          RowBox[{
          "Creates", " ", "flat", " ", "arrays", " ", "to", " ", "feed", " ", 
           "into", " ", "Compile"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"$zeroes", "=", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0.", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"mesh", "[", "\"\<NumberOfSites\>\"", "]"}], ",", 
               RowBox[{"mesh", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], 
              "}"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"$hubs", "=", "hubs"}], ",", "\[IndentingNewLine]", 
          RowBox[{"$pairs", "=", "pairs"}], ",", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"A", " ", "spurious", " ", 
             RowBox[{"{", 
              RowBox[{"0", ",", "0"}], "}"}], " ", "element", " ", "is", " ", 
             "appended", " ", "to", " ", "pairsofpairs", " ", "to", " ", 
             "avoid", " ", "problems", " ", "in", " ", "Compile", " ", "for", 
             " ", "the", " ", "case", " ", "pairsofpairs"}], "=", 
            RowBox[{"{", "}"}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"$pairsofpairs", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"Append", "[", 
              RowBox[{"#", ",", 
               RowBox[{"{", 
                RowBox[{"0", ",", "0"}], "}"}]}], "]"}], "&"}], "@", 
            "pairsofpairs"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"$springs", "=", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"N", "@", 
               RowBox[{"Flatten", "[", 
                RowBox[{"#", ",", "1"}], "]"}]}], "&"}], "@", 
             RowBox[{"springconstants", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "2", ",", "All", ",", "2"}], "]"}], 
              "]"}]}], ")"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"$dist", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"N", "@", 
              RowBox[{"Flatten", "[", 
               RowBox[{"#", ",", "1"}], "]"}]}], "&"}], "@", 
            RowBox[{"distances", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2", ",", "All", ",", "2"}], "]"}], 
             "]"}]}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"$bravaisvectors", "=", 
           RowBox[{"mesh", "[", "\"\<BravaisVectors\>\"", "]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"$bravaisindices", "=", "bravaisindices"}]}], "}"}], ",", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"Print", "[", 
           RowBox[{"Length", "/@", 
            RowBox[{"{", 
             RowBox[{"$pairs", ",", " ", "$springs"}], "}"}]}], "]"}], ";"}], 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"Print", "[", "$pairs", "]"}], ";"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"pairs", "===", 
            RowBox[{"{", "}"}]}], ",", 
           RowBox[{"Return", "[", 
            RowBox[{"0", "&"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Or", "@@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"!", 
                   RowBox[{"VectorQ", "[", 
                    RowBox[{"#", ",", "NumericQ"}], "]"}]}], "&"}], "/@", 
                 RowBox[{"{", 
                  RowBox[{"$hubs", ",", "$springs", ",", " ", "$dist"}], 
                  "}"}]}], ")"}]}], "||", 
              RowBox[{"Or", "@@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"!", 
                   RowBox[{"MatrixQ", "[", 
                    RowBox[{"#", ",", "NumericQ"}], "]"}]}], "&"}], "/@", 
                 RowBox[{"{", 
                  RowBox[{"$pairs", ",", "$pairsofpairs"}], "}"}]}], 
                ")"}]}]}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Print", "[", "\"\<Symbolic processing\>\"", "]"}], ";",
               "#"}], ",", "\[IndentingNewLine]", 
             RowBox[{"Compile", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"{", 
                 RowBox[{"r", ",", "_Real", ",", "2"}], "}"}], "}"}], ",", 
               RowBox[{"#", "[", "r", "]"}]}], "]"}]}], "]"}], "&"}], "@", 
          "\[IndentingNewLine]", 
          RowBox[{"Function", "[", 
           RowBox[{"r", ",", 
            RowBox[{"Module", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"f", "=", "$zeroes"}], ",", 
                RowBox[{"i", "=", "0"}], ",", 
                RowBox[{"j", "=", "0"}], ",", 
                RowBox[{"k", "=", "0"}]}], "}"}], ",", "\[IndentingNewLine]", 
              
              RowBox[{
               RowBox[{"Do", "[", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"i", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"j", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"$springs", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], 
                    FractionBox[
                    RowBox[{"#", " "}], 
                    RowBox[{"Norm", "[", "#", "]"}]], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Norm", "[", "#", "]"}], "-", 
                    RowBox[{"$dist", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ")"}]}]}], ";"}], 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"springs", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], 
                    FractionBox[
                    RowBox[{"#", " "}], 
                    RowBox[{"Norm", "[", "#", "]"}]], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Norm", "[", "#", "]"}], "-", 
                    RowBox[{"dist", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ")"}]}]}], "*)"}], 
                    ")"}], "&"}], "@", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ".", "$bravaisvectors"}], 
                    "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], ")"}]}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"{", 
                  RowBox[{"n", ",", "1", ",", 
                   RowBox[{"Length", "@", "$springs"}]}], "}"}]}], "]"}], ";",
                "\[IndentingNewLine]", "\[IndentingNewLine]", 
               RowBox[{"(*", 
                RowBox[{
                 RowBox[{
                 "We", " ", "now", " ", "add", " ", "the", " ", "three"}], 
                 "-", 
                 RowBox[{"body", " ", "hub", " ", 
                  RowBox[{"terms", ".", " ", "Note"}], " ", "that", " ", "i", 
                  " ", "starts", " ", "at", " ", "2", " ", "to", " ", "skip", 
                  " ", "the", " ", "spurious", " ", 
                  RowBox[{"{", 
                   RowBox[{"0", ",", "0"}], "}"}], " ", "term"}]}], "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{"Do", "[", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"i", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"j", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"k", "=", 
                   RowBox[{"$pairs", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"$hubs", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], 
                    FractionBox["1", 
                    RowBox[{
                    RowBox[{"Norm", "[", "#1", "]"}], 
                    RowBox[{"Norm", "[", "#2", "]"}]}]], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"#1", ".", "#2"}], ")"}], 
                    RowBox[{"(", 
                    RowBox[{
                    FractionBox["#1", 
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#1", "]"}], "2"]], "+", 
                    FractionBox["#2", 
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#2", "]"}], "2"]]}], ")"}]}], "-", 
                    "#1", "-", "#2"}], ")"}]}]}], ";", "\[IndentingNewLine]", 
                    
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"$hubs", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], 
                    FractionBox["1", 
                    RowBox[{
                    RowBox[{"Norm", "[", "#1", "]"}], 
                    RowBox[{"Norm", "[", "#2", "]"}]}]], 
                    RowBox[{"(", 
                    RowBox[{"#2", "-", 
                    RowBox[{
                    FractionBox[
                    RowBox[{"#1", ".", "#2"}], 
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#1", "]"}], "2"]], "#1"}]}], 
                    ")"}]}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"f", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "+=", 
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"$hubs", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], 
                    FractionBox["1", 
                    RowBox[{
                    RowBox[{"Norm", "[", "#1", "]"}], 
                    RowBox[{"Norm", "[", "#2", "]"}]}]], 
                    RowBox[{"(", 
                    RowBox[{"#1", "-", 
                    RowBox[{
                    FractionBox[
                    RowBox[{"#1", ".", "#2"}], 
                    SuperscriptBox[
                    RowBox[{"Norm", "[", "#2", "]"}], "2"]], "#2"}]}], 
                    ")"}]}]}], ";"}], ")"}], "&"}], "[", 
                   "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", 
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "1"}], "]"}], "]"}], "]"}], "]"}], ".", 
                    "$bravaisvectors"}], "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"r", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"$bravaisindices", "[", 
                    RowBox[{"[", 
                    RowBox[{"$pairsofpairs", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", ",", "2"}], "]"}], "]"}], "]"}], "]"}], ".", 
                    "$bravaisvectors"}], "-", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}]}], "]"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"{", 
                  RowBox[{"n", ",", "1", ",", 
                   RowBox[{
                    RowBox[{"Length", "@", "$pairsofpairs"}], "-", "1"}]}], 
                  "}"}]}], "]"}], ";", "\[IndentingNewLine]", "f"}]}], 
             "]"}]}], "]"}]}]}]}], "\[IndentingNewLine]", 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.6309193010370197`*^9, 3.630919325073204*^9}, {
   3.6309193897579193`*^9, 3.63091941005582*^9}, {3.630919449587296*^9, 
   3.63091952375149*^9}, {3.630919778116992*^9, 3.63091992247537*^9}, {
   3.63091995322577*^9, 3.6309200273530416`*^9}, {3.6309201399606867`*^9, 
   3.6309201467523527`*^9}, {3.630920194270729*^9, 3.6309205230857363`*^9}, {
   3.630920559444175*^9, 3.6309208652867603`*^9}, {3.630921065571209*^9, 
   3.630921254569552*^9}, {3.6309213338605213`*^9, 3.6309213671091557`*^9}, {
   3.630921496837274*^9, 3.630921540213586*^9}, {3.63092159478454*^9, 
   3.630921682156302*^9}, {3.630921774847472*^9, 3.6309218254545813`*^9}, {
   3.63092186718836*^9, 3.630921885376794*^9}, {3.6309219234550133`*^9, 
   3.630921928334446*^9}, {3.630922126205213*^9, 3.63092218578083*^9}, {
   3.6309222727819023`*^9, 3.630922503612417*^9}, 3.630922547832448*^9, {
   3.630922594096949*^9, 3.630922697043468*^9}, {3.630922734279202*^9, 
   3.6309227409899473`*^9}, {3.630922775406673*^9, 3.630922841961195*^9}, {
   3.630922888615735*^9, 3.6309229179888773`*^9}, {3.63092296635548*^9, 
   3.630923025655892*^9}, {3.630923074566073*^9, 3.6309232637889442`*^9}, {
   3.63092339198348*^9, 3.630923442164278*^9}, {3.630923483082436*^9, 
   3.63092364049753*^9}, {3.6309237233344393`*^9, 3.6309237876025047`*^9}, {
   3.630923838395052*^9, 3.630923852239296*^9}, {3.630924530174919*^9, 
   3.63092453899502*^9}, {3.63092457133121*^9, 3.630924576394932*^9}, {
   3.630924616775379*^9, 3.6309246202970123`*^9}, {3.630924756642914*^9, 
   3.630924773456244*^9}, {3.6309248506364517`*^9, 3.6309248521725683`*^9}, {
   3.630924960478999*^9, 3.6309250374380627`*^9}, {3.630925072576796*^9, 
   3.630925089127832*^9}, {3.6309251323984327`*^9, 3.630925190579365*^9}, 
   3.63092525969866*^9, {3.630929835901774*^9, 3.6309298389617167`*^9}, {
   3.630930282598175*^9, 3.630930335924121*^9}, {3.630930398236156*^9, 
   3.630930407319578*^9}, {3.630930438420117*^9, 3.63093050312641*^9}, {
   3.63093059188741*^9, 3.630930705792245*^9}, {3.630930755078561*^9, 
   3.6309307630457067`*^9}, {3.630930813732174*^9, 3.630930834179377*^9}, {
   3.6309309497784433`*^9, 3.6309309858783197`*^9}, {3.630931085553184*^9, 
   3.630931148478424*^9}, {3.630990257064806*^9, 3.630990262573716*^9}, {
   3.6309902964727907`*^9, 3.6309903111713753`*^9}, {3.630990428213726*^9, 
   3.630990480874913*^9}, 3.630990774364452*^9, {3.630992884781665*^9, 
   3.630992927726652*^9}, {3.630993001855914*^9, 3.6309930115236464`*^9}, {
   3.630993382758275*^9, 3.630993518164414*^9}, {3.630994158765933*^9, 
   3.630994191514854*^9}, {3.630994699305677*^9, 3.630995060943902*^9}, {
   3.630995257720728*^9, 3.63099526882157*^9}, {3.6309953003086042`*^9, 
   3.630995394375392*^9}, {3.630996328480689*^9, 3.630996487544077*^9}, 
   3.630996544519503*^9, {3.630996601459955*^9, 3.6309966409763327`*^9}, {
   3.630996682074317*^9, 3.630996740227653*^9}, {3.63099678199755*^9, 
   3.630996870942089*^9}, {3.630996995363329*^9, 3.630997236675865*^9}, {
   3.630997307064878*^9, 3.630997462944667*^9}, {3.630997497454095*^9, 
   3.630997584306614*^9}, {3.630997716835683*^9, 3.630997742678494*^9}, {
   3.6309977735641813`*^9, 3.630997805783823*^9}, 3.630997836524399*^9, {
   3.630997886987939*^9, 3.6309979214484367`*^9}, {3.6309979763335943`*^9, 
   3.630998036347896*^9}, {3.630998084548416*^9, 3.630998127177849*^9}, {
   3.6309981581331673`*^9, 3.630998207826366*^9}, 3.630998280202652*^9, {
   3.630998358236642*^9, 3.6309983584987698`*^9}, {3.630998508510564*^9, 
   3.630998523978994*^9}, {3.630998633463934*^9, 3.630998665931582*^9}, {
   3.63099894631853*^9, 3.630998963102333*^9}, {3.630999157022423*^9, 
   3.630999182491417*^9}, {3.630999220329793*^9, 3.63099924078465*^9}, {
   3.6309994388893423`*^9, 3.630999443020793*^9}, {3.630999573649487*^9, 
   3.630999636172605*^9}, {3.630999837290841*^9, 3.630999848409732*^9}, {
   3.631007442194697*^9, 3.631007579288207*^9}, {3.6310076481960917`*^9, 
   3.6310076484285088`*^9}, {3.631007684274383*^9, 3.631007829518847*^9}, {
   3.6310078854054832`*^9, 3.631007916313216*^9}, {3.6310079571993523`*^9, 
   3.6310080447631063`*^9}, {3.631008094673525*^9, 3.631008098305176*^9}, {
   3.631008301095837*^9, 3.631008433105544*^9}, {3.6310084701908617`*^9, 
   3.6310085802726088`*^9}, {3.6310086113115892`*^9, 3.631008611671257*^9}, {
   3.631008643670381*^9, 3.631008843020464*^9}, {3.631008905849433*^9, 
   3.631009056433755*^9}, {3.631009090705791*^9, 3.631009091392325*^9}, {
   3.6310091253364697`*^9, 3.631009127207663*^9}, {3.63100922958899*^9, 
   3.6310092711183653`*^9}, {3.6310093066641483`*^9, 3.631009389675878*^9}, {
   3.631009477511038*^9, 3.631009486740411*^9}, 3.6310096129490957`*^9, 
   3.631009715616776*^9, {3.63100988866094*^9, 3.631009915846689*^9}, {
   3.6310099640229807`*^9, 3.631009969499704*^9}, {3.6310100176276827`*^9, 
   3.6310100912529173`*^9}, {3.631010133932247*^9, 3.6310101418903837`*^9}, 
   3.631012043055511*^9, 3.631012086354486*^9, 3.631012484303556*^9, 
   3.631012816942981*^9, {3.63101405489675*^9, 3.631014061824768*^9}, {
   3.631014094019064*^9, 3.631014097899107*^9}, {3.631014349142488*^9, 
   3.6310144748424997`*^9}, {3.631015041318314*^9, 3.631015055597533*^9}, {
   3.631015094029242*^9, 3.6310151968407927`*^9}, {3.631015227107911*^9, 
   3.631015242395608*^9}, {3.6310153244690437`*^9, 3.631015393461279*^9}, {
   3.631015441085806*^9, 3.6310154920632257`*^9}, 3.631015772326062*^9, {
   3.631015838758647*^9, 3.631015875166643*^9}, {3.63101592794384*^9, 
   3.631016000692865*^9}, 3.631016089431366*^9, {3.631016145886911*^9, 
   3.631016192045609*^9}, {3.631016232535656*^9, 3.631016303659361*^9}, {
   3.631016349196949*^9, 3.631016350940433*^9}, {3.631016395540513*^9, 
   3.63101643234865*^9}, {3.631016471302939*^9, 3.631016562218589*^9}, {
   3.631016593537264*^9, 3.631016612683766*^9}, {3.6310174281690474`*^9, 
   3.631017429406975*^9}, {3.631017494071981*^9, 3.631017573298204*^9}, {
   3.631017620856072*^9, 3.631017626879431*^9}, {3.631017676108334*^9, 
   3.631017682946746*^9}, {3.631017782222698*^9, 3.631017797767149*^9}, {
   3.6310178659097958`*^9, 3.6310178697702217`*^9}, 3.631017951207736*^9, {
   3.6310180247001266`*^9, 3.6310180487018013`*^9}, {3.631018082752441*^9, 
   3.6310180868076143`*^9}, {3.6310183984455633`*^9, 3.631018400968884*^9}, {
   3.631018511285997*^9, 3.6310185893617153`*^9}, {3.631025378257938*^9, 
   3.631025400507201*^9}, {3.631025430917122*^9, 3.6310255149620237`*^9}, {
   3.6310255613602858`*^9, 3.631025598264305*^9}, {3.63102566300513*^9, 
   3.631025710926879*^9}, 3.631025749681938*^9, {3.6310257868762827`*^9, 
   3.631025830688904*^9}, {3.6310260382130003`*^9, 3.631026050773061*^9}, {
   3.63102608564857*^9, 3.631026139425902*^9}, {3.631026176628892*^9, 
   3.6310262599831343`*^9}, {3.631026363527863*^9, 3.631026447626684*^9}, {
   3.631026499990005*^9, 3.631026580845372*^9}, {3.6310266233271723`*^9, 
   3.6310267178682737`*^9}, {3.631026759198155*^9, 3.631026829482772*^9}, {
   3.631026860633197*^9, 3.631027020173052*^9}, {3.6310274020549707`*^9, 
   3.63102743088396*^9}, {3.631027670319418*^9, 3.631027682817896*^9}, {
   3.63102797878587*^9, 3.631028101406629*^9}, {3.63102817491641*^9, 
   3.631028184026147*^9}, {3.631028275536755*^9, 3.631028475971657*^9}, {
   3.631028542723081*^9, 3.631028575489538*^9}, {3.63102863202678*^9, 
   3.631028874707932*^9}, {3.631029014248273*^9, 3.631029033103806*^9}, {
   3.631029131103689*^9, 3.631029139445382*^9}, {3.6310292181353292`*^9, 
   3.631029244808547*^9}, {3.631029386127698*^9, 3.631029409213805*^9}, {
   3.6310294415532703`*^9, 3.631029533358193*^9}, 3.631029582500388*^9, {
   3.6310296132029552`*^9, 3.631029659877994*^9}, {3.6310297532927523`*^9, 
   3.631029784140555*^9}, {3.631029820877121*^9, 3.6310299797381372`*^9}, {
   3.631030031746394*^9, 3.631030068132683*^9}, {3.63103011486406*^9, 
   3.631030118399547*^9}, {3.631030166982397*^9, 3.631030169446281*^9}, {
   3.631030251364287*^9, 3.6310302942496643`*^9}, {3.631030469206221*^9, 
   3.63103047062101*^9}, 3.6310305116850433`*^9, {3.631030552530373*^9, 
   3.6310305642089252`*^9}, {3.631030595219084*^9, 3.6310305954021273`*^9}, {
   3.631030636016594*^9, 3.631030655646884*^9}, {3.631031187158512*^9, 
   3.6310312215078382`*^9}, 3.6310313665666323`*^9, {3.631031992281672*^9, 
   3.631032034030159*^9}, {3.631195137303999*^9, 3.631195152476172*^9}, {
   3.631195194235313*^9, 3.631195200732065*^9}, {3.6311954706937323`*^9, 
   3.631195489277069*^9}, {3.631195599058264*^9, 3.6311956767839823`*^9}, {
   3.63119573573558*^9, 3.631195790509362*^9}, {3.6311958417606297`*^9, 
   3.631195922211488*^9}, {3.631195970589918*^9, 3.631195978825136*^9}, 
   3.631196137222548*^9, {3.631196181710845*^9, 3.6311962668259068`*^9}, {
   3.631196383720441*^9, 3.631196385024242*^9}, {3.631196574091817*^9, 
   3.631196575195518*^9}, {3.631196667377493*^9, 3.6311967037436237`*^9}, {
   3.631196885188718*^9, 3.63119688617236*^9}, {3.631197193557078*^9, 
   3.6311971942682962`*^9}, {3.631197344793109*^9, 3.6311973729526587`*^9}, {
   3.631197409403523*^9, 3.6311975214569483`*^9}, {3.631197724416111*^9, 
   3.631197769864181*^9}, {3.6311978000234003`*^9, 3.631197806471034*^9}, {
   3.63119788943554*^9, 3.6311979366548223`*^9}, 3.631197973203986*^9, {
   3.631198025545341*^9, 3.631198040618228*^9}, {3.63119823500478*^9, 
   3.631198282689166*^9}, {3.631253966774722*^9, 3.6312539991180162`*^9}, {
   3.631272600326797*^9, 3.631272604455451*^9}, {3.635236093080841*^9, 
   3.635236093088008*^9}, 3.636354197925116*^9, {3.63635422970037*^9, 
   3.636354230969729*^9}, {3.636354703524828*^9, 3.636354705268243*^9}, {
   3.639126229553054*^9, 3.639126232646941*^9}, {3.639126285881978*^9, 
   3.639126324558485*^9}, {3.639126392153068*^9, 3.639126412959519*^9}, {
   3.63912644494324*^9, 3.639126582774893*^9}, {3.63912666059221*^9, 
   3.6391266637960377`*^9}, {3.63912678292139*^9, 3.639126786429845*^9}, {
   3.639126846162414*^9, 3.639127055393812*^9}, {3.639127410278596*^9, 
   3.639127478074649*^9}, {3.639127615998432*^9, 3.639127655978981*^9}, {
   3.639127703147624*^9, 3.6391277126805773`*^9}, {3.639127765120268*^9, 
   3.639127877742504*^9}, {3.639128020376347*^9, 3.6391280568882437`*^9}, {
   3.639128088249391*^9, 3.6391282595323772`*^9}, {3.6391282996059504`*^9, 
   3.639128350454385*^9}, {3.639128466450979*^9, 3.639128467503631*^9}, {
   3.6391293363703413`*^9, 3.639129339856035*^9}, {3.639129406656715*^9, 
   3.6391294117559557`*^9}, 3.642314487202442*^9, 3.6423152081688433`*^9, 
   3.6423152829960957`*^9, {3.642315320956112*^9, 3.642315337895049*^9}, {
   3.642401335758258*^9, 3.642401366286098*^9}, {3.6424015691668262`*^9, 
   3.642401574736953*^9}, {3.64240172645953*^9, 3.6424017379764557`*^9}, {
   3.642401841570224*^9, 3.642401878116836*^9}, {3.642401912009748*^9, 
   3.6424019186881657`*^9}, {3.642401975169984*^9, 3.6424019805512466`*^9}, {
   3.642402085704836*^9, 3.642402088338853*^9}, {3.642402143991497*^9, 
   3.642402203925438*^9}, 3.6424022373967257`*^9, {3.642402271753737*^9, 
   3.6424023750838957`*^9}, 3.64240270657717*^9, {3.6535581242587013`*^9, 
   3.6535581519594297`*^9}, {3.6537132015425787`*^9, 3.653713229656909*^9}, 
   3.653713268494755*^9, 3.653713306964715*^9, {3.653713784463522*^9, 
   3.653713790248694*^9}, {3.653713943285577*^9, 3.653714017109685*^9}, 
   3.653714132897121*^9, {3.65371478829568*^9, 3.653714789309762*^9}},
 CellLabel->
  "In[389]:=",ExpressionUUID->"b718fe83-eed9-4d0f-91eb-2b8be0de4905"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Elastic relaxation", "Subsubsection",
 CellChangeTimes->{{3.631271493105892*^9, 
  3.631271495218536*^9}},ExpressionUUID->"d68c2431-b8e4-4524-b8f1-\
0aee4b85e94d"],

Cell["Relax a Lattice based on a Spring Mesh", "Text",
 CellChangeTimes->{{3.611812491936244*^9, 3.611812522886025*^9}, {
   3.611812569548143*^9, 3.611812570940015*^9}, 3.611832696759066*^9, {
   3.630929816721912*^9, 
   3.6309298191441298`*^9}},ExpressionUUID->"9fc3668a-dcf4-4baf-8658-\
ca03564c51fc"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"RelaxLattice", "::", "usage"}], "=", 
   "\"\<Relax lattice positions, using a spring mesh built with \
BuildSpringMesh.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Potential", "::", "usage"}], "=", 
   "\"\<Option for RelaxLattice and RelaxField that specfies the potential \
function experienced by each atom\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PinnedSites", "::", "usage"}], "=", 
   "\"\<List of site indices of fixed sites in the unit cell for \
RelaxLattice. If \\\"Boundary\\\" is specified, they are computed \
automatically as those connected to other unit cells\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"PrintEnergy", "::", "usage"}], "=", 
    "\"\<Specifies whether the minimized energy should be reported by \
RelaxLattice\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "RelaxLattice", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"EquilibriumDistance", "\[Rule]", "1.0"}], ",", 
      RowBox[{"Potential", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{"0", "&"}], ")"}]}], ",", 
      RowBox[{"PinnedSites", "\[Rule]", "None"}], ",", 
      RowBox[{"Options", "[", "FindMinimum", "]"}], ",", " ", 
      RowBox[{"PrintEnergy", "\[Rule]", "True"}]}], "}"}]}]}], ";", 
  RowBox[{
   RowBox[{"RelaxLattice", "[", 
    RowBox[{"lattice_MQLattice", ",", " ", "mesh_MQSpringMesh", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"dim", "=", 
        RowBox[{"mesh", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"numsites", "=", 
        RowBox[{"mesh", "[", "\"\<NumberOfSites\>\"", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"flatsites", "=", 
        RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"potential", "=", 
        RowBox[{"OptionValue", "[", "Potential", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"pinnedsites", "=", 
        RowBox[{"OptionValue", "[", "PinnedSites", "]"}]}], ",", 
       "\[IndentingNewLine]", "freesites", ",", "seedpositions", ",", 
       "freevariables", ",", "\[IndentingNewLine]", "potentialhastags", ",", 
       "tags", ",", "sitetags", ",", "\[IndentingNewLine]", "potentialforce", 
       ",", " ", "energy", ",", " ", "forces", ",", "energyC", ",", "forcesC",
        ",", "variables", ",", "groupedvariables", ",", "x", ",", "k", ",", 
       " ", "E0", ",", 
       RowBox[{"emonitor", "=", "0"}], ",", "val", ",", " ", "solution"}], 
      "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"potentialhastags", "=", 
       RowBox[{"!", 
        RowBox[{"FreeQ", "[", 
         RowBox[{"potential", ",", 
          RowBox[{"Slot", "[", "2", "]"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"energyC", "=", 
       RowBox[{"ElasticEnergy", "[", "mesh", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"forcesC", "=", 
       RowBox[{"ElasticForces", "[", "mesh", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"E0", "=", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"energyC", "[", "#", "]"}], "+", 
          RowBox[{"Total", "[", 
           RowBox[{"potential", "/@", "#"}], "]"}]}], "&"}], "[", 
        RowBox[{"lattice", "[", "\"\<FlatSites\>\"", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"position", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            SubscriptBox["x", "k"], ",", 
            RowBox[{"{", 
             RowBox[{"k", ",", "1", ",", "dim"}], "}"}]}], "]"}]}], "}"}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{"potentialhastags", ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"sitetags", "=", 
            RowBox[{"Flatten", "@", 
             RowBox[{"lattice", "[", "\"\<SiteTags\>\"", "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"tags", "=", 
            RowBox[{"lattice", "[", "\"\<Tags\>\"", "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "This", " ", "cryptic", " ", "line", " ", "creates", " ", "a", 
              " ", "pure", " ", "function", " ", 
              RowBox[{"potentialforce", "[", 
               RowBox[{"pos_", ",", "tags_"}], "]"}]}], ",", " ", 
             RowBox[{
             "such", " ", "that", " ", "for", " ", "each", " ", "tag"}], ",", 
             " ", 
             RowBox[{
              RowBox[{
              "it", " ", "returns", " ", "the", " ", "gradient", " ", "of", 
               " ", "potential", " ", "at", " ", "position", " ", "pos"}], 
              "=", 
              RowBox[{"{", 
               RowBox[{"x", ",", "y", ",", ".."}], "}"}]}]}], "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"forcelist", "=", 
               RowBox[{
                RowBox[{"Table", "[", 
                 RowBox[{
                  RowBox[{"-", 
                   RowBox[{"Grad", "[", 
                    RowBox[{
                    RowBox[{"potential", "[", 
                    RowBox[{"position", ",", "tag"}], "]"}], ",", " ", 
                    "position"}], "]"}]}], ",", 
                  RowBox[{"{", 
                   RowBox[{"tag", ",", "tags"}], "}"}]}], "]"}], "/.", 
                RowBox[{
                 SubscriptBox["x", "k_"], "->", 
                 RowBox[{"Slot", "[", "k", "]"}]}]}]}], "}"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"potentialforce", "=", 
              RowBox[{"Function", "@@", 
               RowBox[{"{", 
                RowBox[{"ReleaseHold", "[", 
                 RowBox[{"Switch", "[", 
                  RowBox[{
                   RowBox[{"Slot", "[", "2", "]"}], ",", 
                   RowBox[{"Evaluate", "[", 
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Riffle", "[", 
                    RowBox[{"tags", ",", 
                    RowBox[{"Function", "/@", "forcelist"}]}], "]"}], "/.", 
                    RowBox[{
                    RowBox[{"Function", "[", "a_", "]"}], "\[RuleDelayed]", 
                    RowBox[{"Hold", "[", 
                    RowBox[{
                    RowBox[{"Function", "[", "a", "]"}], "@@", 
                    RowBox[{"Slot", "[", "1", "]"}]}], "]"}]}]}], ")"}]}], 
                    "]"}]}], "]"}], "]"}], "}"}]}]}]}], "]"}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"energy", "[", 
             RowBox[{"vars_", "?", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"MatrixQ", "[", 
                 RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], "]"}],
             ":=", 
            RowBox[{"emonitor", "=", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"energyC", "[", "vars", "]"}], "+", 
               RowBox[{"Total", "[", 
                RowBox[{"MapThread", "[", 
                 RowBox[{"potential", ",", 
                  RowBox[{"{", 
                   RowBox[{"vars", ",", " ", "sitetags"}], "}"}]}], "]"}], 
                "]"}], "-", "E0"}], ")"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"forces", "[", 
             RowBox[{"vars_", "?", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"MatrixQ", "[", 
                 RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], "]"}],
             ":=", 
            RowBox[{"Flatten", "[", 
             RowBox[{
              RowBox[{"forcesC", "[", "vars", "]"}], "+", 
              RowBox[{"MapThread", "[", 
               RowBox[{"potentialforce", ",", 
                RowBox[{"{", 
                 RowBox[{"vars", ",", " ", "sitetags"}], "}"}]}], "]"}]}], 
             "]"}]}], ";"}], "\[IndentingNewLine]", ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "This", " ", "cryptic", " ", "line", " ", "creates", " ", "a", 
             " ", "pure", " ", "function", " ", 
             RowBox[{"potentialforce", "[", "pos_", "]"}]}], ",", " ", 
            RowBox[{
             RowBox[{
             "that", " ", "returns", " ", "the", " ", "gradient", " ", "of", 
              " ", "potential", " ", "at", " ", "position", " ", "pos"}], "=", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y", ",", ".."}], "}"}]}]}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"forcelist", "=", 
               RowBox[{
                RowBox[{"-", 
                 RowBox[{"Grad", "[", 
                  RowBox[{
                   RowBox[{"potential", "[", "position", "]"}], ",", " ", 
                   "position"}], "]"}]}], "/.", 
                RowBox[{
                 SubscriptBox["x", "k_"], "->", 
                 RowBox[{"Slot", "[", "k", "]"}]}]}]}], "}"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"potentialforce", "=", 
              RowBox[{"ReleaseHold", "[", 
               RowBox[{"Function", "@@", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"Function", "@@", 
                   RowBox[{"{", "forcelist", "}"}]}], "/.", 
                  RowBox[{
                   RowBox[{"Function", "[", "a_", "]"}], "\[RuleDelayed]", 
                   RowBox[{"Hold", "[", 
                    RowBox[{
                    RowBox[{"Function", "[", "a", "]"}], "@@", 
                    RowBox[{"Slot", "[", "1", "]"}]}], "]"}]}]}], "}"}]}], 
               "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"energy", "[", 
             RowBox[{"vars_", "?", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"MatrixQ", "[", 
                 RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], "]"}],
             ":=", 
            RowBox[{"emonitor", "=", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"energyC", "[", "vars", "]"}], "+", 
               RowBox[{"Total", "[", 
                RowBox[{"potential", "/@", "vars"}], "]"}], "-", "E0"}], 
              ")"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"forces", "[", 
             RowBox[{"vars_", "?", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"MatrixQ", "[", 
                 RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], "]"}],
             ":=", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"forcesC", "[", "vars", "]"}], "+", 
              RowBox[{"potentialforce", "/@", "vars"}]}], ")"}]}], ";"}]}], 
         "\[IndentingNewLine]", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"variables", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         SubscriptBox["x", 
          RowBox[{"j", ",", "k"}]], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "numsites"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"k", ",", "1", ",", "dim"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"pinnedsites", "===", "\"\<Boundary\>\""}], ",", 
        RowBox[{"pinnedsites", "=", 
         RowBox[{"Sort", "@", 
          RowBox[{"DeleteDuplicates", "@", 
           RowBox[{"Flatten", "[", 
            RowBox[{
             RowBox[{"Flatten", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Most", "[", 
                 RowBox[{"ArrayRules", "[", "#", "]"}], "]"}], "&"}], "/@", 
               RowBox[{
                RowBox[{"DeleteCases", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"mesh", "[", "\"\<SpringConstants\>\"", "]"}], 
                   "[", "\"\<HBloch\>\"", "]"}], ",", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"0", "..."}], "}"}], "\[Rule]", "_"}]}], "]"}], 
                "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}], "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}]}]}]}], "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"VectorQ", "[", 
         RowBox[{"pinnedsites", ",", "IntegerQ"}], "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"freevariables", "=", 
          RowBox[{"Delete", "[", 
           RowBox[{"variables", ",", 
            RowBox[{"List", "/@", "pinnedsites"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"variables", "[", 
           RowBox[{"[", "pinnedsites", "]"}], "]"}], "=", 
          RowBox[{"flatsites", "[", 
           RowBox[{"[", "pinnedsites", "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"seedpositions", "=", 
          RowBox[{"Delete", "[", 
           RowBox[{"flatsites", ",", 
            RowBox[{"List", "/@", "pinnedsites"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"freesites", "=", 
          RowBox[{"Complement", "[", 
           RowBox[{
            RowBox[{"Range", "[", "numsites", "]"}], ",", "pinnedsites"}], 
           "]"}]}]}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"pinnedsites", "=", 
          RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"freevariables", "=", "variables"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"seedpositions", "=", "flatsites"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"freesites", "=", "All"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"solution", "=", 
       RowBox[{"Monitor", "[", 
        RowBox[{
         RowBox[{"FindMinimum", "[", 
          RowBox[{
           RowBox[{"energy", "[", "variables", "]"}], ",", 
           RowBox[{"Evaluate", "[", 
            RowBox[{"Transpose", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Flatten", "@", "freevariables"}], ",", 
               RowBox[{"Flatten", "@", "seedpositions"}]}], "}"}], "]"}], 
            "]"}], ",", 
           RowBox[{"Gradient", ":>", 
            RowBox[{"-", 
             RowBox[{"Flatten", "[", 
              RowBox[{
               RowBox[{"forces", "[", "variables", "]"}], "[", 
               RowBox[{"[", "freesites", "]"}], "]"}], "]"}]}]}], ",", " ", 
           RowBox[{"Evaluate", "@", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}]}], 
          "]"}], ",", "emonitor"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"VectorQ", "[", 
         RowBox[{"pinnedsites", ",", "IntegerQ"}], "]"}], ",", 
        RowBox[{
         RowBox[{"solution", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "=", 
         RowBox[{"Join", "[", 
          RowBox[{
           RowBox[{"solution", "[", 
            RowBox[{"[", "2", "]"}], "]"}], ",", 
           RowBox[{"Flatten", "@", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{
               SubscriptBox["x", 
                RowBox[{"j", ",", "k"}]], "\[Rule]", 
               RowBox[{"flatsites", "[", 
                RowBox[{"[", 
                 RowBox[{"j", ",", "k"}], "]"}], "]"}]}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "pinnedsites"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"k", ",", "1", ",", "dim"}], "}"}]}], "]"}]}]}], 
          "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"OptionValue", "@", "PrintEnergy"}], ",", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Energy = \>\"", ",", 
          RowBox[{"First", "@", "solution"}]}], "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"groupedvariables", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Table", "[", 
           RowBox[{
            SubscriptBox["x", 
             RowBox[{"#", ",", "k"}]], ",", 
            RowBox[{"{", 
             RowBox[{"k", ",", "1", ",", "dim"}], "}"}]}], "]"}], "&"}], ",", 
         
         RowBox[{"lattice", "[", "\"\<SiteIndices\>\"", "]"}], ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"lattice", "[", 
       RowBox[{"\"\<Sites\>\"", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{"groupedvariables", "/.", 
          RowBox[{"Last", "[", "solution", "]"}]}], ")"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.6309239908323917`*^9, 3.6309239950793533`*^9}, {
   3.630924028635116*^9, 3.630924085192404*^9}, {3.6309241617656593`*^9, 
   3.630924347227593*^9}, 3.630925472939486*^9, {3.630925504841666*^9, 
   3.630925647532342*^9}, {3.6309256790975122`*^9, 3.630925761454341*^9}, {
   3.630925814045576*^9, 3.630925940564436*^9}, {3.630925973948938*^9, 
   3.63092597481962*^9}, {3.6309262213125257`*^9, 3.630926245935793*^9}, {
   3.630929826669406*^9, 3.630929829105201*^9}, 3.6310024317843113`*^9, {
   3.631002558131845*^9, 3.631002565057848*^9}, {3.631009422210682*^9, 
   3.631009432129614*^9}, {3.63101328954291*^9, 3.63101329822127*^9}, {
   3.631013795359537*^9, 3.6310138340899153`*^9}, {3.6310138767480793`*^9, 
   3.631013885952026*^9}, {3.6310139600222473`*^9, 3.6310139607014847`*^9}, {
   3.6310297051611567`*^9, 3.631029727872085*^9}, {3.631271501413274*^9, 
   3.6312715336929073`*^9}, {3.631271629213645*^9, 3.631271630302422*^9}, {
   3.6312716676482*^9, 3.631271723857429*^9}, {3.631271759781982*^9, 
   3.6312718377650423`*^9}, {3.631271870089164*^9, 3.631271982208424*^9}, {
   3.631272122294869*^9, 3.6312722037882957`*^9}, {3.631345266707018*^9, 
   3.631345285225628*^9}, {3.631345327609996*^9, 3.6313454220340853`*^9}, {
   3.631345562106553*^9, 3.631345703556527*^9}, {3.631345760548979*^9, 
   3.631345778721406*^9}, {3.631345842468789*^9, 3.631345876980497*^9}, {
   3.6313459335123587`*^9, 3.631345942824033*^9}, {3.631347984277412*^9, 
   3.6313479863425093`*^9}, {3.631348018723016*^9, 3.6313480364296713`*^9}, {
   3.631348072737493*^9, 3.631348089943376*^9}, {3.6313481199669867`*^9, 
   3.63134825504366*^9}, {3.63134830854196*^9, 3.6313483365351973`*^9}, 
   3.631348496250184*^9, {3.6313485489306717`*^9, 3.631348558301544*^9}, {
   3.631348596336445*^9, 3.631348630470438*^9}, {3.6313486616532593`*^9, 
   3.6313486621572638`*^9}, {3.631353684857234*^9, 3.631353737842339*^9}, {
   3.631353787199564*^9, 3.631353907062628*^9}, {3.631354131655164*^9, 
   3.6313542995316353`*^9}, {3.631354338606488*^9, 3.631354547719565*^9}, {
   3.631354583007997*^9, 3.631354669898343*^9}, {3.631355005842115*^9, 
   3.631355008386292*^9}, {3.631355047379056*^9, 3.6313551224283047`*^9}, {
   3.631355167219253*^9, 3.63135535791317*^9}, {3.631355403265315*^9, 
   3.631355451163801*^9}, {3.631355541016549*^9, 3.631355646507173*^9}, {
   3.631355755371367*^9, 3.63135576312092*^9}, {3.631355794645056*^9, 
   3.631355811019883*^9}, {3.631355846761969*^9, 3.631355853466254*^9}, {
   3.631355895986863*^9, 3.6313559223503227`*^9}, {3.631355998147181*^9, 
   3.631356012977947*^9}, {3.631356060743848*^9, 3.631356082834626*^9}, {
   3.631356126988483*^9, 3.6313562020599833`*^9}, {3.6313562362471237`*^9, 
   3.63135661317977*^9}, {3.6313571985206947`*^9, 3.6313574794202013`*^9}, {
   3.631357521153327*^9, 3.631357891141273*^9}, {3.631357925903474*^9, 
   3.631357928340856*^9}, {3.631366527799048*^9, 3.63136655390691*^9}, 
   3.631366991956723*^9, {3.63142239765727*^9, 3.631422424647071*^9}, {
   3.631422519821368*^9, 3.63142252033139*^9}, {3.6314255704490757`*^9, 
   3.6314255944072657`*^9}, {3.631425631222509*^9, 3.631425639997389*^9}, {
   3.639127889988228*^9, 3.639127959948922*^9}, {3.639127997413445*^9, 
   3.639127997724566*^9}, {3.6391285928407803`*^9, 3.639128818571828*^9}, {
   3.6423101067510757`*^9, 3.642310222966902*^9}, {3.642310260254125*^9, 
   3.642310285605051*^9}, {3.6423105588234787`*^9, 3.642310589790594*^9}, {
   3.642310633996677*^9, 3.6423107285148973`*^9}, {3.642310798499221*^9, 
   3.6423109224859962`*^9}, {3.642310958444892*^9, 3.6423110380400476`*^9}, {
   3.642311270000139*^9, 3.6423112864282846`*^9}, {3.642311405499732*^9, 
   3.64231148287866*^9}, {3.6423115779999113`*^9, 3.64231159656603*^9}, {
   3.642311710648456*^9, 3.6423118015793533`*^9}, {3.6423118446218987`*^9, 
   3.64231193612512*^9}, {3.6423120613116713`*^9, 3.642312091877474*^9}, {
   3.642312181554488*^9, 3.64231257761609*^9}, {3.6423129115222397`*^9, 
   3.642312997772608*^9}, {3.642313435074478*^9, 3.6423134594246283`*^9}, {
   3.6423135163326597`*^9, 3.6423135256862392`*^9}, {3.642397607251329*^9, 
   3.642397643889206*^9}, {3.642397739880282*^9, 3.642397747262813*^9}, {
   3.642401010299459*^9, 3.6424010157861443`*^9}, {3.6424024523611526`*^9, 
   3.6424024525979223`*^9}, {3.64654828708344*^9, 3.6465482948742647`*^9}, {
   3.646548729504212*^9, 3.6465487376702414`*^9}, 3.646549073203208*^9, {
   3.6519158211749563`*^9, 3.651915825029011*^9}, {3.651915891259101*^9, 
   3.6519158918022413`*^9}, {3.653807306284605*^9, 3.653807310043483*^9}, {
   3.656847528026383*^9, 3.656847533057459*^9}},
 CellLabel->
  "In[395]:=",ExpressionUUID->"0e1ce72a-42f1-4629-9488-140b30af53ab"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["GradientMesh", "Subsection",
 CellChangeTimes->{{3.656821711169853*^9, 3.6568217151128893`*^9}, {
  3.6568229523213863`*^9, 
  3.656822953152412*^9}},ExpressionUUID->"058679d3-fdd2-4d3b-83e6-\
fc0cbe3c46fc"],

Cell[CellGroupData[{

Cell["BuildGradientMesh", "Subsubsection",
 CellChangeTimes->{{3.611812444506138*^9, 3.611812448465026*^9}, 
   3.611832696758905*^9, {3.630918185315957*^9, 3.630918214153409*^9}, 
   3.6312705574233*^9, {3.656822956656376*^9, 
   3.656822957504147*^9}},ExpressionUUID->"18ac942d-dfd0-4b1b-8679-\
d99cac28d600"],

Cell[TextData[{
 "A MQGradientMesh object contains two lattices, called InnerLattice and \
OuterLattice. A field ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["u", "k"], TraditionalForm]],ExpressionUUID->
  "991dcdda-320d-43cc-8817-59cad554cfb3"],
 " (k=1... FieldDimension) is defined on the OuterLattice, which allows one \
to obtain the value of the field gradient ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["\[PartialD]", "j"], 
    SubscriptBox["u", "k"]}], TraditionalForm]],ExpressionUUID->
  "61539942-73df-412a-84e1-dda3656e3feb"],
 " and the field itself ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["u", "k"], TraditionalForm]],ExpressionUUID->
  "3f3764fa-c004-4c36-bd43-f2fa81faea9e"],
 " on the InnerLattice. To do so, each site in the InnerLattice needs to have \
exactly D+1 neighbors within the OuterLattice, where D is the \
EmbeddingDimension.\nThe value of a field ",
 Cell[BoxData[
  FormBox[
   RowBox[{"u", "(", 
    SubscriptBox["r", "n"], ")"}], TraditionalForm]],ExpressionUUID->
  "5084210d-2603-4d75-a09b-0d97a79733bb"],
 " and its gradient ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["\[PartialD]", "j"], 
    RowBox[{"u", "(", 
     SubscriptBox["r", "n"], ")"}]}], TraditionalForm]],ExpressionUUID->
  "104a764a-b911-4434-84d1-d44f42f4cf4a"],
 " at a point ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["r", "n"], TraditionalForm]],ExpressionUUID->
  "e66956e6-e0ef-45ea-91d8-446efb81d2cb"],
 "in the InnerLattice is obtained by solving ",
 Cell[BoxData[
  FormBox[
   RowBox[{"u", "(", 
    SubscriptBox["R", "m"], ")"}], TraditionalForm]],ExpressionUUID->
  "20ed8489-ca7c-4ebe-97a1-ca7465a5a3da"],
 "=",
 Cell[BoxData[
  FormBox[
   RowBox[{"u", "(", 
    SubscriptBox["r", "n"], ")"}], TraditionalForm]],ExpressionUUID->
  "e67f0855-745f-49f4-96cf-4455aab6bb66"],
 "+ ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      SubsuperscriptBox["R", "m", "j"], "-", 
      SubsuperscriptBox["r", "n", "j"]}], ")"}], 
    RowBox[{
     SubscriptBox["\[PartialD]", "j"], 
     RowBox[{"u", "(", 
      SubscriptBox["r", "n"], ")"}]}]}], TraditionalForm]],ExpressionUUID->
  "0de1fcbe-d854-434f-84dd-fccadbc76ed7"],
 " for the D+1 neighbors ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["R", "m"], TraditionalForm]],ExpressionUUID->
  "f8af4a8f-6492-4833-9a8d-79b29b9094bd"],
 " of ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["r", "n"], TraditionalForm]],ExpressionUUID->
  "0a4d53d6-2ffd-40fd-91f4-a3d39e4d61bd"],
 " within the OuterLattice. The solution is  ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"u", "(", 
       SubscriptBox["r", "n"], ")"}], ",", 
      RowBox[{
       SubscriptBox["\[PartialD]", "j"], 
       RowBox[{"u", "(", 
        SubscriptBox["r", "n"], ")"}]}]}], "}"}], "=", 
    RowBox[{
     SubscriptBox[
      RowBox[{"(", 
       SubsuperscriptBox["R", "n", 
        RowBox[{"-", "1"}]], ")"}], 
      RowBox[{"\[Alpha]", ",", "m"}]], " ", 
     FormBox[
      RowBox[{"u", "(", 
       SubscriptBox["R", "m"], ")"}],
      TraditionalForm]}]}], TraditionalForm]],ExpressionUUID->
  "4fddbec7-c6cf-4a5d-9c28-f0b11c2c760f"],
 ", where ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["R", "n"], "=", 
    RowBox[{"(", GridBox[{
       {GridBox[{
          {"1"},
          {"..."},
          {"1"}
         }], 
        SubscriptBox[
         RowBox[{"(", 
          RowBox[{"R", "-", 
           SubscriptBox["r", "n"]}], ")"}], 
         RowBox[{"m", ",", "j"}]]}
      }], ")"}]}], TraditionalForm]],ExpressionUUID->
  "1a3477df-593f-4861-a8d0-89cf08f81b3c"],
 ".\n\nBuildGradientMesh builds the matrix ",
 Cell[BoxData[
  FormBox[
   SubsuperscriptBox["R", "n", 
    RowBox[{"-", "1"}]], TraditionalForm]],ExpressionUUID->
  "8b549381-93ff-4a60-a65a-1b526faddd27"],
 " for each n into an EvaluationMatrix ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["M", 
    RowBox[{"n", ",", "j", ",", "m"}]], TraditionalForm]],ExpressionUUID->
  "77656314-e20b-4e8f-9eb9-27f718a8c272"],
 "=",
 Cell[BoxData[
  FormBox[
   SubscriptBox[
    RowBox[{"(", 
     SubsuperscriptBox["R", "n", 
      RowBox[{"-", "1"}]], ")"}], 
    RowBox[{"j", ",", "m"}]], TraditionalForm]],ExpressionUUID->
  "ed59a0ab-be95-47db-8770-b8ad99efe142"],
 " (j=1...D+1), so that ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox[
     RowBox[{"(", GridBox[{
        {"u"},
        {
         RowBox[{"\[PartialD]", "u"}]}
       }], ")"}], "EL"], "=", 
    RowBox[{"M", ".", 
     SubscriptBox["u", "FL"]}]}], TraditionalForm]],ExpressionUUID->
  "bf7670b2-c29b-49f3-bba2-30f8c6917ee8"],
 ", where ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["u", "FL"], TraditionalForm]],ExpressionUUID->
  "2cec1e30-4481-4203-af1a-794767b913f5"],
 " are fields in the field lattice, and ",
 Cell[BoxData[
  FormBox[
   SubscriptBox[
    RowBox[{"(", GridBox[{
       {"u"},
       {
        RowBox[{"\[PartialD]", "u"}]}
      }], ")"}], "EL"], TraditionalForm]],ExpressionUUID->
  "9002f61d-c23e-488e-904c-4fd514198dfc"],
 "are the corresponding values on the EvaluationLattice"
}], "Text",
 CellChangeTimes->{{3.656828808044771*^9, 3.656829062345083*^9}, {
  3.656829100256936*^9, 3.6568291727699327`*^9}, {3.656831096210805*^9, 
  3.656831161507656*^9}, {3.656833834882309*^9, 3.656833834882339*^9}, {
  3.6569967962628517`*^9, 3.656997043085822*^9}, {3.656997334068055*^9, 
  3.656997749320546*^9}, {3.6569978124656563`*^9, 3.6569979073590517`*^9}, {
  3.656997948398818*^9, 3.656998007507275*^9}, {3.657009571859734*^9, 
  3.657009650825481*^9}, {3.657013391924694*^9, 
  3.657013397644519*^9}},ExpressionUUID->"fb9c06c7-f9f5-4597-a63b-\
c1a33aa45389"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Field", "::", "usage"}], "=", 
   "\"\<Option for BuildGradientMesh: values of the field on the \
OuterLattice, in the form of a matrix \!\(\*SubscriptBox[\(u\), \(n, k\)]\), \
where n=1... number of outer sites, and k=1... field dimensions. If \
Automatic, the field is set to zero with a dimension given by \
FieldDimensions. If it a real umax, it is set to a \
RandomReal[{-1,1}umax,{outersites,fieldimensions}].\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FieldDimensions", "::", "usage"}], "=", 
   "\"\<Option for BuildGradientMesh: sets the dimensions of the field \
\!\(\*SubscriptBox[\(u\), \(k\)]\). If not an integer, it is chosen as the \
Embedding dimensions.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BuildGradientMesh", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Field", "\[Rule]", "Automatic"}], ",", "\[IndentingNewLine]", 
       
       RowBox[{"FieldDimensions", "\[Rule]", "Automatic"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Transform", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
       RowBox[{"Options", "@", "BuildSystem"}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"BuildGradientMesh", "[", 
   RowBox[{"lattice_MQLattice", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "sys", ",", " ", "Rlist", ",", "distances", ",", "neighbors", ",", "M", 
      ",", " ", "embeddim", ",", " ", "numinnersites", ",", "numoutersites", 
      ",", "  ", "coordination", ",", " ", "innerLatticeIndices", ",", " ", 
      "field", ",", " ", "fielddimensions"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", 
         RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}], "\[NotEqual]", 
        "2"}], ",", " ", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"BuildGradientMesh", "::", "sublattice"}], "]"}], ";", 
        RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"embeddim", "=", 
      RowBox[{"lattice", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"numinnersites", ",", "numoutersites"}], "}"}], "=", 
      RowBox[{"Length", "/@", 
       RowBox[{"lattice", "[", "\"\<Sites\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"sys", "=", 
      RowBox[{"BuildSystem", "[", 
       RowBox[{"lattice", ",", 
        RowBox[{"Onsite", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{"0", "&"}], ")"}]}], ",", " ", 
        RowBox[{"Hopping", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"#3", "\[Equal]", "#4"}], ",", "0", ",", "1"}], "]"}], 
           "&"}], ")"}]}], ",", 
        RowBox[{"FilterRules", "[", 
         RowBox[{
          RowBox[{"{", "opts", "}"}], ",", 
          RowBox[{"Options", "@", "BuildSystem"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "@", 
         RowBox[{"OptionValue", "[", "Transform", "]"}]}], "===", 
        "Function"}], ",", " ", 
       RowBox[{"sys", "=", 
        RowBox[{"sys", "[", 
         RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"TransformLattice", "[", 
             RowBox[{"#", ",", 
              RowBox[{"OptionValue", "[", "Transform", "]"}]}], "]"}], "&"}], 
           ")"}]}], "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"innerLatticeIndices", "=", 
      RowBox[{"First", "@", 
       RowBox[{"lattice", "[", "\"\<SiteIndices\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"coordination", "=", 
      RowBox[{"Length", "/@", 
       RowBox[{"sys", "[", "\"\<SiteNeighbors\>\"", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Or", "@@", 
        RowBox[{"Thread", "[", 
         RowBox[{
          RowBox[{"coordination", "[", 
           RowBox[{"[", "innerLatticeIndices", "]"}], "]"}], "!=", 
          RowBox[{"embeddim", "+", "1"}]}], "]"}]}], ",", " ", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"BuildGradientMesh", "::", "sublattice"}], "]"}], ";", 
        RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"IntegerQ", "[", 
        RowBox[{"OptionValue", "@", "FieldDimensions"}], "]"}], ",", " ", 
       RowBox[{"fielddimensions", "=", 
        RowBox[{"OptionValue", "@", "FieldDimensions"}]}], ",", 
       RowBox[{"fielddimensions", "=", "embeddim"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"MatrixQ", "[", 
         RowBox[{"OptionValue", "@", "Field"}], "]"}], "&&", 
        RowBox[{
         RowBox[{"Length", "[", 
          RowBox[{"OptionValue", "@", "Field"}], "]"}], "\[Equal]", 
         "numoutersites"}]}], ",", 
       RowBox[{"field", "=", 
        RowBox[{"OptionValue", "@", "Field"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"NumericQ", "[", 
          RowBox[{"OptionValue", "@", "Field"}], "]"}], ",", 
         RowBox[{"field", "=", 
          RowBox[{"RandomReal", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"OptionValue", "@", "Field"}], 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"-", "1"}], ",", "1"}], "}"}]}], ",", 
            RowBox[{"{", 
             RowBox[{"numoutersites", ",", "fielddimensions"}], "}"}]}], 
           "]"}]}], ",", 
         RowBox[{"field", "=", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"0.", ",", 
            RowBox[{"{", 
             RowBox[{"numoutersites", ",", "fielddimensions"}], "}"}]}], 
           "]"}]}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"neighbors", "=", 
      RowBox[{
       RowBox[{"sys", "[", "\"\<SiteNeighbors\>\"", "]"}], "[", 
       RowBox[{"[", "innerLatticeIndices", "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"distances", "=", 
      RowBox[{
       RowBox[{"sys", "[", "\"\<SiteNeighborDistances\>\"", "]"}], "[", 
       RowBox[{"[", "innerLatticeIndices", "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"n", ",", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"m", " ", "\[Rule]", " ", "distance"}], ")"}], "..."}], 
           "}"}]}], "}"}], "..."}], "}"}], "*)"}], "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"Rlist", "=", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{
         RowBox[{"{", "R", "}"}], ",", 
         RowBox[{"Inverse", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Prepend", "[", 
             RowBox[{"#", ",", "1"}], "]"}], "&"}], "/@", "R"}], "]"}]}], 
        "]"}], "/@", "distances"}]}], ";", " ", 
     RowBox[{"(*", 
      RowBox[{
       SubscriptBox[
        RowBox[{"(", 
         SuperscriptBox["R", 
          RowBox[{"-", "1"}]], ")"}], "njm"], ",", " ", 
       RowBox[{"n", "=", "innersites"}], ",", " ", 
       RowBox[{"j", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"1", "..."}], " ", "embeddim"}], "+", "1"}]}], ",", " ", 
       RowBox[{"m", "=", "outersites"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"M", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{
        RowBox[{"{", "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"numinnersites", ",", 
          RowBox[{"embeddim", "+", "1"}], ",", "numoutersites"}], "}"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Return", "[", 
        RowBox[{"{", 
         RowBox[{"innerLatticeIndices", ",", 
          RowBox[{"neighbors", "-", "numinnersites"}], ",", "Rlist"}], "}"}], 
        "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"We", " ", "add", " ", 
       SuperscriptBox["R", 
        RowBox[{"-", "1"}]], " ", "blocks"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"M", "[", 
           RowBox[{"[", 
            RowBox[{"#1", ",", "All", ",", "#2"}], "]"}], "]"}], "=", "#3"}], 
         ")"}], "&"}], ",", 
       RowBox[{"{", 
        RowBox[{"innerLatticeIndices", ",", 
         RowBox[{"neighbors", "-", "numinnersites"}], ",", "Rlist"}], "}"}]}],
       "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Commented", " ", "this", " ", "out", " ", "after", " ", "the", " ", 
       RowBox[{"fact", ":", " ", 
        RowBox[{
        "remember", " ", "the", " ", "possibility", " ", "of", " ", "Chop", 
         " ", "breaking", " ", "PackedArrays"}]}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"M", "=", 
        RowBox[{"Chop", "@", "M"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"MQGradientMesh", "[", 
      RowBox[{
       RowBox[{"\"\<EvaluationMatrix\>\"", "\[Rule]", "M"}], ",", 
       RowBox[{"\"\<System\>\"", "\[Rule]", "sys"}], ",", 
       RowBox[{"\"\<Field\>\"", "\[Rule]", "field"}], ",", " ", 
       RowBox[{"\"\<Energy\>\"", "\[Rule]", 
        RowBox[{"Missing", "[", "]"}]}]}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.630918384570612*^9, 3.6309184366631603`*^9}, {
   3.630918663749218*^9, 3.63091869804224*^9}, {3.630918806022451*^9, 
   3.630918857027665*^9}, {3.630918889042774*^9, 3.630919060105496*^9}, {
   3.6309191005425587`*^9, 3.630919102053385*^9}, 3.630919136871401*^9, {
   3.630920081724209*^9, 3.63092009757847*^9}, 3.630920128712955*^9, {
   3.630930009929512*^9, 3.630930205642067*^9}, {3.630930733180822*^9, 
   3.6309307344962587`*^9}, 3.630997845072344*^9, {3.630999506949432*^9, 
   3.630999510809211*^9}, {3.635239232076272*^9, 3.635239235913806*^9}, {
   3.6363545926375303`*^9, 3.636354608684853*^9}, {3.636359945096335*^9, 
   3.63635999026237*^9}, {3.6465450243904047`*^9, 3.6465450737198153`*^9}, {
   3.646545154995016*^9, 3.646545166437323*^9}, {3.653558191514296*^9, 
   3.6535581992721243`*^9}, {3.653558513600053*^9, 3.653558514645548*^9}, 
   3.653712792170326*^9, {3.6537130935179253`*^9, 3.653713165410343*^9}, {
   3.656822965089326*^9, 3.656823039149832*^9}, {3.6568231453320293`*^9, 
   3.65682316344948*^9}, {3.656823199849368*^9, 3.6568233039088497`*^9}, 
   3.656823338284135*^9, 3.656825390484181*^9, 3.656825448476357*^9, {
   3.6568279211603193`*^9, 3.6568279590221653`*^9}, {3.6568285598321*^9, 
   3.656828560575222*^9}, {3.656828797397855*^9, 3.6568287983485727`*^9}, {
   3.656829187504118*^9, 3.656829299582871*^9}, {3.656829333398539*^9, 
   3.656829447582295*^9}, {3.656829967929084*^9, 3.656829980631351*^9}, {
   3.656830133517584*^9, 3.656830299804613*^9}, {3.6568303345633373`*^9, 
   3.656830342835616*^9}, {3.656830376610792*^9, 3.6568304085393553`*^9}, {
   3.656830537841962*^9, 3.6568305399937696`*^9}, {3.656830572345245*^9, 
   3.656830647983714*^9}, {3.6568306781273623`*^9, 3.65683069819166*^9}, {
   3.656830748191481*^9, 3.6568307545186453`*^9}, {3.6568308073843117`*^9, 
   3.65683081968578*^9}, {3.656830868335828*^9, 3.656831073826906*^9}, {
   3.656831231281994*^9, 3.65683126673927*^9}, {3.656831300513385*^9, 
   3.656831531741435*^9}, {3.6568315936932983`*^9, 3.656831639315619*^9}, {
   3.656831688692115*^9, 3.656831707218753*^9}, {3.6568320473657618`*^9, 
   3.656832130331663*^9}, {3.6568323223043957`*^9, 3.65683241237604*^9}, {
   3.656833046326573*^9, 3.656833049940638*^9}, {3.656833239250329*^9, 
   3.656833256338111*^9}, {3.656833582445094*^9, 3.656833583244155*^9}, {
   3.6568336446196003`*^9, 3.656833670026561*^9}, {3.656847131708441*^9, 
   3.656847147076417*^9}, {3.65684826979198*^9, 3.65684829651966*^9}, 
   3.656848416527194*^9, 3.65684845799905*^9, {3.656950209959673*^9, 
   3.656950250350321*^9}, {3.6569502989424*^9, 3.65695031954145*^9}, {
   3.656950381637385*^9, 3.656950381868713*^9}, {3.65699802321294*^9, 
   3.656998051900321*^9}, {3.656998113101014*^9, 3.656998183931237*^9}, {
   3.656998311763644*^9, 3.656998312698265*^9}, 3.656999465180387*^9, {
   3.6570001058281183`*^9, 3.6570001760008383`*^9}, 3.6570002418949347`*^9, {
   3.65700028421532*^9, 3.657000340085452*^9}, {3.657000409979541*^9, 
   3.6570004752975397`*^9}, {3.657002463376648*^9, 3.657002529462112*^9}, {
   3.657002564560299*^9, 3.657002564700306*^9}, {3.657002595243396*^9, 
   3.6570026005713787`*^9}, {3.65700263794661*^9, 3.657002676632807*^9}, {
   3.6570027314081717`*^9, 3.657002732031135*^9}, {3.6570029227253*^9, 
   3.657002964265773*^9}, {3.657003002641032*^9, 3.657003103917169*^9}, {
   3.6570032910573053`*^9, 3.657003334751251*^9}, 3.657003427245138*^9, {
   3.6570094362922907`*^9, 3.6570095343262033`*^9}, {3.657013130091914*^9, 
   3.6570131346509867`*^9}, {3.6570131935939817`*^9, 3.657013206719407*^9}, {
   3.6570132368575497`*^9, 3.657013241774068*^9}, {3.6570132790685253`*^9, 
   3.657013284691016*^9}, {3.657013348969143*^9, 3.657013417292494*^9}, {
   3.6570135159207087`*^9, 3.657013696070416*^9}, {3.6570137322293243`*^9, 
   3.657013735754949*^9}, {3.657013770851275*^9, 3.657013892948256*^9}, {
   3.657013950187961*^9, 3.657013984311817*^9}, {3.657014036262826*^9, 
   3.65701422451796*^9}, {3.657014260618346*^9, 3.657014359260867*^9}, {
   3.657014495998898*^9, 3.657014496469941*^9}, {3.657015312471023*^9, 
   3.657015494604941*^9}, {3.657015583744248*^9, 3.657015587072792*^9}, {
   3.657015653213564*^9, 3.657016037625927*^9}, {3.657017489219997*^9, 
   3.657017495699864*^9}, {3.657017892595566*^9, 3.6570178951596403`*^9}, {
   3.657633522947165*^9, 3.6576335887913103`*^9}, {3.657633637422599*^9, 
   3.657633668893001*^9}, {3.6576338673117437`*^9, 3.657633889781478*^9}, {
   3.657633927365223*^9, 3.657633937013205*^9}, {3.667105016341813*^9, 
   3.667105060441476*^9}},
 CellLabel->
  "In[400]:=",ExpressionUUID->"f51f6db9-d747-4850-8cd7-a23ce13b6503"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"BuildGradientMesh", "::", "sublattice"}], "=", 
   "\"\<Lattice must be composed of two sublattices.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BuildGradientMesh", "::", "coordination"}], "=", 
   "\"\<Coordination of all sites in EvaluationLattice (sublattice 1) should \
be EmbeddingDimensions+1.\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.656998073669024*^9, 3.656998103411222*^9}, {
  3.657000352668559*^9, 3.6570003932580023`*^9}},
 CellLabel->
  "In[404]:=",ExpressionUUID->"d6a43210-6fbf-4c1e-8f8a-a972716d66ae"]
}, Open  ]],

Cell[CellGroupData[{

Cell["RelaxField", "Subsubsection",
 CellChangeTimes->{{3.656833858502331*^9, 
  3.656833863446265*^9}},ExpressionUUID->"d4f0873d-8413-404e-abb6-\
7d2965b89fbe"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"FieldDimensions", "::", "usage"}], "=", 
     "\"\<Option for RelaxField: the dimension k of the field \
\!\(\*SubscriptBox[\(u\), \(k\)]\)(\!\(\*SubscriptBox[\(r\), \(n\)]\)) to be \
optimized\>\""}], ";", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Seed", "::", "usage"}], "=", 
     "\"\<Option for RelaxField: an initial value of the field \
\!\(\*SubscriptBox[\(u\), \(k\)]\)(\!\(\*SubscriptBox[\(r\), \(n\)]\)) to be \
optimized, in the form of a matrix \!\(\*SubscriptBox[\(u\), \(n, k\)]\). It \
overrides de \>\""}], ";"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"ReturnSeedEnergyOnly", "::", "usage"}], "=", 
     "\"\<Option for RelaxField: returns the energy of the field seed and \
does not optimize\>\""}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Potential", "::", "usage"}], "=", 
     "\"\<Option for RelaxLattice: the potential function V[r] experienced by \
each atom. Option for RelaxField: potential V[\!\(\*SubscriptBox[\(r\), \
\(k\)]\),\!\(\*SubscriptBox[\(u\), \
\(k\)]\),\!\(\*SubscriptBox[\(\[PartialD]\), \
\(j\)]\)\!\(\*SubscriptBox[\(u\), \(k\)]\)] [a funciton of a (vector, vector, \
matrix)] to be optimized. It may also be provided as a list of functions {Vu[\
\!\(\*SubscriptBox[\(r\), \(k\)]\),\!\(\*SubscriptBox[\(u\), \(k\)]\)],Vdu[\!\
\(\*SubscriptBox[\(r\), \(k\)]\),\!\(\*SubscriptBox[\(\[PartialD]\), \(j\)]\)\
\!\(\*SubscriptBox[\(u\), \(k\)]\)]}, so that the total energy is their sum \
V=Vu+Vdu.\>\""}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"DPotential", "::", "usage"}], "=", 
     "\"\<Option for RelaxField: derivative \
\!\(\*SubscriptBox[\(\[PartialD]\), SubscriptBox[\(u\), \
\(k\)]]\)V[\!\(\*SubscriptBox[\(r\), \(k\)]\),\!\(\*SubscriptBox[\(u\), \
\(k\)]\),\!\(\*SubscriptBox[\(\[PartialD]\), \
\(j\)]\)\!\(\*SubscriptBox[\(u\), \(k\)]\)] of the potential (a function that \
returns a vector). If Automatic, it is computed automatically from the \
expression of the option Potential\>\""}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"DDPotential", "::", "usage"}], "=", 
     "\"\<Option for RelaxField: derivative \
\!\(\*SubscriptBox[\(\[PartialD]\), \(\*SubscriptBox[\(\[PartialD]\), \
\(j\)]\*SubscriptBox[\(u\), \(k\)]\)]\)V[\!\(\*SubscriptBox[\(r\), \
\(k\)]\),\!\(\*SubscriptBox[\(u\), \
\(k\)]\),\!\(\*SubscriptBox[\(\[PartialD]\), \
\(j\)]\)\!\(\*SubscriptBox[\(u\), \(k\)]\)] of the potential (a function that \
returns a matrix).If Automatic, it is computed automatically from the \
expression of the option Potential\>\""}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "RelaxField", "]"}], "=", 
     RowBox[{"Flatten", "@", 
      RowBox[{"{", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"FieldDimensions", "\[Rule]", "Automatic"}], ",", 
         RowBox[{"FieldSeed", "\[Rule]", "Automatic"}], ","}], "*)"}], 
       RowBox[{
        RowBox[{"PinnedSites", "\[Rule]", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"Potential", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Function", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"r", ",", "u"}], "}"}], ",", 
             RowBox[{
              FractionBox["1", "2"], "K", " ", 
              RowBox[{"u", ".", "u"}]}]}], " ", "]"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"\[Lambda]", "=", "3.5"}], ",", 
               RowBox[{"\[Mu]", "=", "7.8"}], ",", 
               RowBox[{"detA", "=", 
                RowBox[{
                 FractionBox[
                  SqrtBox["3"], "2"], 
                 SuperscriptBox["2.46", "2"]}]}], ",", " ", 
               RowBox[{"K", "=", "1."}]}], "}"}], ",", 
             RowBox[{"Function", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"r", ",", "du"}], "}"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  FractionBox["detA", "2"], 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"2", "\[Mu]", " ", 
                    RowBox[{"Tr", "[", 
                    RowBox[{"#", ".", "#"}], "]"}]}], "+", 
                    RowBox[{"\[Lambda]", " ", 
                    SuperscriptBox[
                    RowBox[{"Tr", "[", "#", "]"}], "2"]}]}], ")"}]}], "&"}], 
                "@", 
                RowBox[{"(", GridBox[{
                   {
                    RowBox[{"du", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}], 
                    RowBox[{
                    FractionBox["1", "2"], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"du", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "2"}], "]"}], "]"}], "+", 
                    RowBox[{"du", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ")"}]}]},
                   {
                    RowBox[{
                    FractionBox["1", "2"], 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"du", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "2"}], "]"}], "]"}], "+", 
                    RowBox[{"du", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ")"}]}], 
                    RowBox[{"du", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "2"}], "]"}], "]"}]}
                  }], ")"}]}]}], "]"}]}], "]"}]}], "}"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"AddedNoise", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
        RowBox[{"ReturnSeedEnergyOnly", "\[Rule]", "False"}], ",", 
        RowBox[{"Options", "[", "FindMinimum", "]"}]}], "}"}]}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"RelaxField", "[", 
     RowBox[{"mesh_MQGradientMesh", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{
       "Mgrad", ",", "MgradT", ",", "Mfield", ",", "MfieldT", ",", "gradient",
         ",", " ", "energy", ",", " ", "fielddim", ",", " ", "embeddim", ",", 
        "numinnersites", ",", "numoutersites", ",", "innerpositions", ",", 
        "outerpositions", ",", " ", "potu", ",", " ", "potdu", ",", "dupot", 
        ",", "ddupot", ",", "\[IndentingNewLine]", " ", "rsym", ",", " ", 
        "usym", ",", " ", "dusym", ",", "uvars", ",", "uvarsfree", ",", 
        "useed", ",", "useedfree", ",", " ", "x", ",", "u", ",", "du", ",", 
        "pinnedsites", ",", "freesites", ",", "emonitor", ",", " ", 
        "solution", ",", " ", "counter"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"innerpositions", "=", 
        RowBox[{"mesh", "[", "\"\<InnerSites\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"outerpositions", "=", 
        RowBox[{"mesh", "[", "\"\<OuterSites\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Mgrad", "=", 
        RowBox[{"mesh", "[", "\"\<GradientMatrix\>\"", "]"}]}], ";", " ", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          SubscriptBox["\[PartialD]", "j"], 
          SubsuperscriptBox["u", "n", "k"]}], "=", 
         RowBox[{
          SubscriptBox["Mgrad", 
           RowBox[{"njm", "\.1d"}]], 
          SubsuperscriptBox["u", "m", "k"]}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"MgradT", "=", 
        RowBox[{"Transpose", "[", 
         RowBox[{"Mgrad", ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "2", ",", "1"}], "}"}]}], "]"}]}], ";", " ", 
       RowBox[{"(*", 
        RowBox[{
         SubscriptBox["MgradT", 
          RowBox[{"mjn", "\.1d"}]], "=", 
         SubscriptBox["Mgrad", "njm"]}], "*)"}], "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"numinnersites", ",", "numoutersites"}], "}"}], "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"mesh", "[", "\"\<NumberOfInnerSites\>\"", "]"}], ",", 
          RowBox[{"mesh", "[", "\"\<NumberOfOuterSites\>\"", "]"}]}], "}"}]}],
        ";", "\[IndentingNewLine]", 
       RowBox[{"embeddim", "=", 
        RowBox[{"mesh", "[", "\"\<EmbeddingDimensions\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"fielddim", "=", 
        RowBox[{"mesh", "[", "\"\<FieldDimensions\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"rsym", "=", 
        RowBox[{"Array", "[", 
         RowBox[{
          RowBox[{
           SubscriptBox["x", "#"], "&"}], ",", "embeddim"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"usym", "=", 
        RowBox[{"Array", "[", 
         RowBox[{
          RowBox[{
           SubscriptBox["u", "#"], "&"}], ",", "fielddim"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"dusym", "=", 
        RowBox[{"Array", "[", 
         RowBox[{
          RowBox[{
           SubscriptBox["du", 
            RowBox[{"#1", ",", "#2"}]], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{"embeddim", ",", "fielddim"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"MatchQ", "[", 
          RowBox[{
           RowBox[{"OptionValue", "[", "Potential", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"_Function", "|", "_CompiledFunction"}], ",", " ", 
             RowBox[{"_Function", "|", "_CompiledFunction"}], ",", 
             RowBox[{"_Function", "|", "_CompiledFunction"}], ",", 
             RowBox[{"_Function", "|", "_CompiledFunction"}]}], "}"}]}], 
          "]"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"Potentials", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Vu", "[", 
              RowBox[{
               SubscriptBox["r", "k"], ",", 
               SubscriptBox["u", "k"]}], "]"}], ",", 
             RowBox[{"Vdu", "[", 
              RowBox[{
               SubscriptBox["r", "k"], ",", 
               RowBox[{
                SubscriptBox["\[PartialD]", "j"], 
                SubscriptBox["u", "k"]}]}], "]"}], ",", " ", 
             RowBox[{
              SubscriptBox["\[PartialD]", "u"], 
              RowBox[{"Vu", "[", 
               RowBox[{
                SubscriptBox["r", "k"], ",", 
                SubscriptBox["u", "k"]}], "]"}]}], ",", 
             RowBox[{
              SubscriptBox["\[PartialD]", 
               RowBox[{"\[PartialD]", "u"}]], 
              RowBox[{"Vdu", "[", 
               RowBox[{
                SubscriptBox["r", "k"], ",", 
                RowBox[{
                 SubscriptBox["\[PartialD]", "j"], 
                 SubscriptBox["u", "k"]}]}], "]"}]}]}], "}"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "potu", ",", " ", "potdu", ",", " ", "dupot", ",", " ", 
             "ddupot"}], "}"}], "=", 
           RowBox[{"OptionValue", "[", "Potential", "]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"energy", "[", 
            RowBox[{"u_", "?", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"MatrixQ", "[", 
                RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], "]"}], 
           ":=", 
           RowBox[{"emonitor", "=", 
            RowBox[{"Re", "[", 
             RowBox[{
              RowBox[{"Total", "[", 
               RowBox[{"MapThread", "[", 
                RowBox[{"potu", ",", 
                 RowBox[{"{", 
                  RowBox[{"outerpositions", ",", "u"}], "}"}]}], "]"}], "]"}],
               "+", 
              RowBox[{"Total", "[", 
               RowBox[{"MapThread", "[", 
                RowBox[{"potdu", ",", 
                 RowBox[{"{", 
                  RowBox[{"innerpositions", ",", " ", 
                   RowBox[{"Mgrad", ".", "u"}]}], "}"}]}], "]"}], "]"}]}], 
             "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"gradient", "[", 
            RowBox[{"u_", "?", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"MatrixQ", "[", 
                RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], "]"}], 
           ":=", "\[IndentingNewLine]", 
           RowBox[{"Re", "[", 
            RowBox[{
             RowBox[{"MapThread", "[", 
              RowBox[{"dupot", ",", 
               RowBox[{"{", 
                RowBox[{"outerpositions", ",", "u"}], "}"}]}], "]"}], "+", 
             "\[IndentingNewLine]", 
             RowBox[{"TensorContract", "[", 
              RowBox[{
               RowBox[{"MgradT", ".", 
                RowBox[{"MapThread", "[", 
                 RowBox[{"ddupot", ",", 
                  RowBox[{"{", 
                   RowBox[{"innerpositions", ",", " ", 
                    RowBox[{"Mgrad", ".", "u"}]}], "}"}]}], "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"2", ",", "3"}], "}"}]}], "]"}]}], "]"}]}], ";"}], 
         " ", 
         RowBox[{"(*", 
          RowBox[{
           SubscriptBox["MgradT", "mjn"], 
           SubscriptBox["ddV", "njk"]}], "*)"}], ",", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"Potential", " ", 
           RowBox[{"V", "[", 
            RowBox[{
             SubscriptBox["r", "k"], ",", 
             SubscriptBox["u", "k"], ",", 
             RowBox[{
              SubscriptBox["\[PartialD]", "j"], 
              SubscriptBox["u", "k"]}]}], "]"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Mfield", "=", 
           RowBox[{"mesh", "[", "\"\<FieldMatrix\>\"", "]"}]}], ";", " ", 
          RowBox[{"(*", 
           RowBox[{
            SuperscriptBox["u", "k"], "=", 
            RowBox[{
             SubscriptBox["Mfield", 
              RowBox[{"nm", "\.1d"}]], 
             SubsuperscriptBox["u", "m", "k"]}]}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"MfieldT", "=", 
           RowBox[{"Transpose", "[", "Mfield", "]"}]}], ";", 
          RowBox[{"(*", 
           RowBox[{
            SubscriptBox["MfieldT", 
             RowBox[{"mn", "\.1d"}]], "=", 
            SubscriptBox["Mfield", "nm"]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"potu", "=", 
           RowBox[{"OptionValue", "[", "Potential", "]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"dupot", "=", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"D", "[", 
               RowBox[{
                RowBox[{"potu", "[", 
                 RowBox[{"rsym", ",", "usym", ",", "dusym"}], "]"}], ",", 
                "#"}], "]"}], "&"}], "/@", "usym"}], ")"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"dupot", "=", 
           RowBox[{"ReleaseHold", "@", 
            RowBox[{"Function", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"x", ",", "u", ",", "du"}], "}"}], ",", 
              RowBox[{"Evaluate", "[", 
               RowBox[{"dupot", "/.", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                   SubscriptBox["x", "j_"], "\[RuleDelayed]", 
                   RowBox[{"Hold", "[", 
                    RowBox[{"x", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "]"}]}], ",", 
                  RowBox[{
                   SubscriptBox["u", "j_"], "\[RuleDelayed]", 
                   RowBox[{"Hold", "[", 
                    RowBox[{"u", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "]"}]}], ",", 
                  RowBox[{
                   SubscriptBox["du", 
                    RowBox[{"j_", ",", "k_"}]], "\[RuleDelayed]", 
                   RowBox[{"Hold", "[", 
                    RowBox[{"du", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "k"}], "]"}], "]"}], "]"}]}]}], "}"}]}],
                "]"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"ddupot", "=", 
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"D", "[", 
               RowBox[{
                RowBox[{"potu", "[", 
                 RowBox[{"rsym", ",", "usym", ",", "dusym"}], "]"}], ",", 
                "#"}], "]"}], "&"}], ",", "dusym", ",", 
             RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"ddupot", "=", 
           RowBox[{"ReleaseHold", "@", 
            RowBox[{"Function", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"x", ",", "u", ",", "du"}], "}"}], ",", 
              RowBox[{"Evaluate", "[", 
               RowBox[{"ddupot", "/.", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                   SubscriptBox["x", "j_"], "\[RuleDelayed]", 
                   RowBox[{"Hold", "[", 
                    RowBox[{"x", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "]"}]}], ",", 
                  RowBox[{
                   SubscriptBox["u", "j_"], "\[RuleDelayed]", 
                   RowBox[{"Hold", "[", 
                    RowBox[{"u", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "]"}]}], ",", 
                  RowBox[{
                   SubscriptBox["du", 
                    RowBox[{"j_", ",", "k_"}]], "\[RuleDelayed]", 
                   RowBox[{"Hold", "[", 
                    RowBox[{"du", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "k"}], "]"}], "]"}], "]"}]}]}], "}"}]}],
                "]"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"energy", "[", 
            RowBox[{"u_", "?", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"MatrixQ", "[", 
                RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], "]"}], 
           ":=", 
           RowBox[{"emonitor", "=", 
            RowBox[{"Re", "@", 
             RowBox[{"Total", "[", 
              RowBox[{"MapThread", "[", 
               RowBox[{"potu", ",", 
                RowBox[{"{", 
                 RowBox[{"innerpositions", ",", " ", 
                  RowBox[{"Mfield", ".", "u"}], ",", " ", 
                  RowBox[{"Mgrad", ".", "u"}]}], "}"}]}], "]"}], "]"}]}]}]}], 
          ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"gradient", "[", 
            RowBox[{"u_", "?", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"MatrixQ", "[", 
                RowBox[{"#", ",", "NumericQ"}], "]"}], "&"}], ")"}]}], "]"}], 
           ":=", "\[IndentingNewLine]", 
           RowBox[{"Re", "[", 
            RowBox[{
             RowBox[{"MfieldT", ".", 
              RowBox[{"MapThread", "[", 
               RowBox[{"dupot", ",", 
                RowBox[{"{", 
                 RowBox[{"innerpositions", ",", " ", 
                  RowBox[{"Mfield", ".", "u"}], ",", " ", 
                  RowBox[{"Mgrad", ".", "u"}]}], "}"}]}], "]"}]}], "+", 
             RowBox[{"(*", 
              RowBox[{
               SubscriptBox["MfieldT", "mn"], 
               SubscriptBox["dV", "nk"]}], "*)"}], "\[IndentingNewLine]", 
             RowBox[{"TensorContract", "[", 
              RowBox[{
               RowBox[{"MgradT", ".", 
                RowBox[{"MapThread", "[", 
                 RowBox[{"ddupot", ",", 
                  RowBox[{"{", 
                   RowBox[{"innerpositions", ",", " ", 
                    RowBox[{"Mfield", ".", "u"}], ",", " ", 
                    RowBox[{"Mgrad", ".", "u"}]}], "}"}]}], "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"2", ",", "3"}], "}"}]}], "]"}]}], "]"}]}], ";"}]}], 
        " ", 
        RowBox[{"(*", 
         RowBox[{
          SubscriptBox["MgradT", "mjn"], 
          SubscriptBox["ddV", "njk"]}], "*)"}], "\[IndentingNewLine]", 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"useed", "=", 
        RowBox[{"mesh", "[", "\"\<Field\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"NumericQ", "[", 
          RowBox[{"OptionValue", "[", "AddedNoise", "]"}], "]"}], ",", 
         RowBox[{"useed", "+=", 
          RowBox[{"RandomReal", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"-", "1"}], ",", "1"}], "}"}], 
             RowBox[{"Abs", "@", 
              RowBox[{"OptionValue", "@", "AddedNoise"}]}]}], ",", 
            RowBox[{"Dimensions", "[", "useed", "]"}]}], "]"}]}]}], "]"}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"AbsoluteTiming", "[", 
             RowBox[{"energy", "[", "useed", "]"}], "]"}], ",", 
            RowBox[{"AbsoluteTiming", "[", 
             RowBox[{
              RowBox[{"gradient", "[", "useed", "]"}], ";"}], "]"}]}], "}"}], 
          "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"temp1", ",", "temp2"}], "}"}], "=", 
          RowBox[{"{", 
           RowBox[{"useed", ",", "useed"}], "}"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"temp1", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "+=", 
          RowBox[{".001", 
           RowBox[{"{", 
            RowBox[{"1", ",", "0"}], "}"}]}]}], ";", 
         RowBox[{
          RowBox[{"temp2", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "-=", 
          RowBox[{".001", 
           RowBox[{"{", 
            RowBox[{"1", ",", "0"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Print", "@", 
          RowBox[{"{", 
           RowBox[{
            FractionBox[
             RowBox[{
              RowBox[{"energy", "[", "temp1", "]"}], "-", 
              RowBox[{"energy", "[", "temp2", "]"}]}], 
             RowBox[{"2", " ", ".001"}]], ",", 
            RowBox[{
             RowBox[{"gradient", "[", "useed", "]"}], "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], ";"}], "*)"}], 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "@", "PinnedSites"}], "===", 
          "\"\<Boundary\>\""}], ",", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"mesh", "[", "\"\<System\>\"", "]"}], "[", 
              "\"\<Lattice\>\"", "]"}], "[", "\"\<LatticeDimensions\>\"", 
             "]"}], ">", "0"}], ",", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"For", " ", "periodic", " ", "systems"}], ",", " ", 
             RowBox[{
              RowBox[{
              "pin", " ", "all", " ", "sites", " ", "in", " ", "the", " ", 
               "outerlattice", " ", "that", " ", "is", " ", "a", " ", 
               "second"}], "-", "nearest", "-", 
              RowBox[{
              "neighbor", " ", "to", " ", "a", " ", "boundary", " ", 
               "element", " ", "in", " ", "outerlattice"}]}]}], "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"pinnedsites", "=", "\[IndentingNewLine]", 
            RowBox[{"With", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"outerboundary", "=", 
                RowBox[{"First", "@", 
                 RowBox[{
                  RowBox[{"mesh", "[", "\"\<System\>\"", "]"}], "[", 
                  "\"\<BlochBoundarySitesGrouped\>\"", "]"}]}]}], "}"}], ",", 
              
              RowBox[{
               RowBox[{"Select", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Transpose", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Range", "[", 
                    RowBox[{"Length", "[", "#", "]"}], "]"}], ",", "#"}], 
                    "}"}], "]"}], "&"}], "@", 
                  RowBox[{
                   RowBox[{"mesh", "[", "\"\<System\>\"", "]"}], "[", 
                   "\"\<SiteNeighbors\>\"", "]"}]}], ",", 
                 RowBox[{
                  RowBox[{"ContainsAny", "[", 
                   RowBox[{
                    RowBox[{"Last", "@", "#"}], ",", "outerboundary"}], "]"}],
                   "&"}]}], "]"}], "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}]}], ",", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "Otherwise", " ", "simply", " ", "pin", " ", "outerlattice", " ", 
             "sites", " ", "that", " ", "have", " ", "less", " ", "than", " ",
              "the", " ", "maximum", " ", "number", " ", "of", " ", 
             "outerlattice", " ", "neighbors"}], "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"neighbors", "=", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"Transpose", "[", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Range", "[", 
                    RowBox[{"Length", "[", "#", "]"}], "]"}], ",", "#"}], 
                    "}"}], "]"}], "&"}], "[", 
                 RowBox[{
                  RowBox[{"mesh", "[", "\"\<System\>\"", "]"}], "[", 
                  "\"\<SiteNeighbors\>\"", "]"}], "]"}], "[", 
                RowBox[{"[", 
                 RowBox[{"Last", "@", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"mesh", "[", "\"\<System\>\"", "]"}], "[", 
                    "\"\<Lattice\>\"", "]"}], "[", "\"\<SiteIndices\>\"", 
                   "]"}]}], "]"}], "]"}]}], "}"}], ",", "\[IndentingNewLine]", 
             RowBox[{"pinnedsites", "=", 
              RowBox[{
               RowBox[{"Select", "[", 
                RowBox[{"neighbors", ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "]"}], "<", 
                   RowBox[{"Max", "[", 
                    RowBox[{"Length", "/@", 
                    RowBox[{"neighbors", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], 
                  "&"}]}], "]"}], "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], "]"}]}], 
          "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{"pinnedsites", "=", 
          RowBox[{"OptionValue", "@", "PinnedSites"}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"pinnedsites", "===", "None"}], ",", 
         RowBox[{"pinnedsites", "=", 
          RowBox[{"{", "}"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"pinnedsites", "=", 
        RowBox[{"pinnedsites", "-", "numinnersites"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"useedfree", "=", 
        RowBox[{"Delete", "[", 
         RowBox[{"useed", ",", 
          RowBox[{"List", "/@", "pinnedsites"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"uvars", "=", 
        RowBox[{"Array", "[", 
         RowBox[{
          RowBox[{
           SubscriptBox["u", 
            RowBox[{"#1", ",", "#2"}]], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{"numoutersites", ",", "fielddim"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"uvars", "[", 
         RowBox[{"[", "pinnedsites", "]"}], "]"}], "=", 
        RowBox[{"useed", "[", 
         RowBox[{"[", "pinnedsites", "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"uvarsfree", "=", 
        RowBox[{"Delete", "[", 
         RowBox[{"uvars", ",", 
          RowBox[{"List", "/@", "pinnedsites"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"freesites", "=", 
        RowBox[{"Complement", "[", 
         RowBox[{
          RowBox[{"Range", "[", "numoutersites", "]"}], ",", "pinnedsites"}], 
         "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"OptionValue", "@", "ReturnSeedEnergyOnly"}], ",", 
         RowBox[{"Return", "[", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"energy", "[", "useed", "]"}], ",", 
            RowBox[{"Norm", "[", 
             RowBox[{
              RowBox[{"gradient", "[", "useed", "]"}], "[", 
              RowBox[{"[", "freesites", "]"}], "]"}], "]"}]}], "}"}], "]"}]}],
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"counter", "=", "0"}], ";", "\[IndentingNewLine]", 
       RowBox[{"solution", "=", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"FindMinimum", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"energy", "[", "uvars", "]"}], ",", 
            RowBox[{"Evaluate", "[", 
             RowBox[{"Transpose", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Flatten", "@", "uvarsfree"}], ",", " ", 
                RowBox[{"Flatten", "@", "useedfree"}]}], "}"}], "]"}], "]"}], 
            ",", 
            RowBox[{"Gradient", "\[RuleDelayed]", 
             RowBox[{"Flatten", "[", 
              RowBox[{
               RowBox[{"gradient", "[", "uvars", "]"}], "[", 
               RowBox[{"[", "freesites", "]"}], "]"}], "]"}]}], ",", 
            RowBox[{"Evaluate", "@", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", "opts", "}"}], ",", 
               RowBox[{"Options", "[", "FindMinimum", "]"}]}], "]"}]}]}], 
           "]"}], ",", "emonitor"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"mesh", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\"\<Energy\>\"", "\[Rule]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"First", "@", "solution"}], "&"}], ")"}]}], ",", 
          RowBox[{"\"\<Field\>\"", "\[Rule]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"uvars", "/.", 
              RowBox[{"Last", "@", "solution"}]}], "&"}], ")"}]}]}], "}"}], 
        "]"}]}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.656838028250559*^9, 3.656838113742876*^9}, {
   3.6568382010456743`*^9, 3.656838279026862*^9}, {3.656838567015098*^9, 
   3.6568385842138453`*^9}, {3.656838631168601*^9, 3.6568386384933233`*^9}, {
   3.6568387013754797`*^9, 3.656838729491331*^9}, {3.656841231021061*^9, 
   3.6568412592997026`*^9}, {3.656841456720743*^9, 3.656841590166204*^9}, {
   3.6568417025003777`*^9, 3.656841892193995*^9}, {3.656842044295576*^9, 
   3.656842090278708*^9}, {3.656842135898589*^9, 3.656842152837769*^9}, {
   3.6568422040215597`*^9, 3.656842204517706*^9}, {3.656842709149732*^9, 
   3.656842723549014*^9}, {3.6568427558921328`*^9, 3.6568428848747883`*^9}, 
   3.656843016985359*^9, {3.656843097284164*^9, 3.656843511866186*^9}, {
   3.6568435912179947`*^9, 3.656843600023929*^9}, {3.656843641430943*^9, 
   3.6568436841762257`*^9}, {3.656843715974411*^9, 3.656843797976939*^9}, {
   3.656843870804788*^9, 3.656843904627923*^9}, {3.65684394129788*^9, 
   3.656843960161175*^9}, {3.656843993265513*^9, 3.656844171768091*^9}, {
   3.6568442752786713`*^9, 3.656844278158716*^9}, {3.6568443166716127`*^9, 
   3.656844325334811*^9}, {3.656844359455245*^9, 3.656844381949877*^9}, {
   3.656844490701004*^9, 3.656844498486341*^9}, {3.656844539320423*^9, 
   3.656844553920735*^9}, {3.656844608623993*^9, 3.6568447470024767`*^9}, {
   3.6568448394418793`*^9, 3.656845098864605*^9}, {3.656845176016488*^9, 
   3.656845185295335*^9}, {3.6568452695434723`*^9, 3.6568452836626377`*^9}, {
   3.656845373950551*^9, 3.656845395374002*^9}, {3.6568457214839897`*^9, 
   3.656846042511426*^9}, {3.656846073535337*^9, 3.6568465064043837`*^9}, {
   3.656846625508841*^9, 3.65684664913103*^9}, {3.656846713954815*^9, 
   3.6568467907781553`*^9}, {3.65684686865718*^9, 3.656846881856635*^9}, {
   3.6568469294888372`*^9, 3.6568469349372*^9}, {3.656847155259952*^9, 
   3.656847188558069*^9}, {3.656847243008089*^9, 3.6568475084903183`*^9}, {
   3.656847552412215*^9, 3.656847608736679*^9}, {3.656847667168144*^9, 
   3.656847852301961*^9}, {3.656848482813262*^9, 3.656848488557472*^9}, 
   3.6568541157182283`*^9, 3.656854904832645*^9, {3.6569229980752563`*^9, 
   3.6569230575271597`*^9}, {3.6569235250985603`*^9, 
   3.6569235539313307`*^9}, {3.656923590468598*^9, 3.656923617450507*^9}, {
   3.6569240401116858`*^9, 3.6569240793622932`*^9}, {3.6569241143773193`*^9, 
   3.656924171989235*^9}, {3.656948870389608*^9, 3.656948894651574*^9}, 
   3.656949360463978*^9, {3.656949403320425*^9, 3.65694940771012*^9}, {
   3.657016234771323*^9, 3.6570164561432533`*^9}, {3.657016579442316*^9, 
   3.657016670412684*^9}, {3.657017060730248*^9, 3.657017117730708*^9}, 
   3.6570171660803537`*^9, {3.657017230058779*^9, 3.6570174417346582`*^9}, {
   3.657017809121188*^9, 3.657017818021709*^9}, {3.657017941750724*^9, 
   3.657017970316791*^9}, {3.657018013325392*^9, 3.657018092495741*^9}, {
   3.657018142479987*^9, 3.657018157500139*^9}, {3.657018238682044*^9, 
   3.657018241039721*^9}, {3.657018289541935*^9, 3.6570183471863537`*^9}, {
   3.657018417515628*^9, 3.657018445483612*^9}, 3.657018499499278*^9, {
   3.6570188045581417`*^9, 3.657018809900926*^9}, {3.657019010188299*^9, 
   3.657019018466358*^9}, {3.657019452230344*^9, 3.657019458319003*^9}, {
   3.65702925871929*^9, 3.6570293301158323`*^9}, {3.657029380699419*^9, 
   3.657029402185199*^9}, {3.657029550430709*^9, 3.657029652209704*^9}, {
   3.657030008731646*^9, 3.6570300226000223`*^9}, {3.657030077438651*^9, 
   3.657030080398466*^9}, {3.657030122670532*^9, 3.657030211035256*^9}, {
   3.657031181672928*^9, 3.657031183048936*^9}, {3.6570312816067047`*^9, 
   3.657031288790468*^9}, 3.6570328150875*^9, {3.657032948641173*^9, 
   3.6570330158135653`*^9}, {3.657033609624762*^9, 3.657033792753611*^9}, {
   3.657035024671536*^9, 3.657035026343893*^9}, {3.657273085250396*^9, 
   3.657273240728518*^9}, {3.657273280431921*^9, 3.65727336908319*^9}, {
   3.657273400289467*^9, 3.657273453925963*^9}, {3.657273670436378*^9, 
   3.657273701513912*^9}, {3.65727373346601*^9, 3.657273749152103*^9}, {
   3.657273787638586*^9, 3.657273836587677*^9}, {3.6572738945608473`*^9, 
   3.657273899170739*^9}, {3.657274192060039*^9, 3.6572741954358473`*^9}, {
   3.6572743266547623`*^9, 3.657274329716221*^9}, {3.65728839293407*^9, 
   3.657288456713225*^9}, {3.657288495957473*^9, 3.6572885416823*^9}, {
   3.65728859892694*^9, 3.65728860431773*^9}, {3.657288943425694*^9, 
   3.657288949320421*^9}, {3.65728904071599*^9, 3.657289061076434*^9}, {
   3.6572891015061617`*^9, 3.657289110665758*^9}, {3.657289665560132*^9, 
   3.657289666063263*^9}, {3.657289794852515*^9, 3.657289805825234*^9}, {
   3.6572898795039177`*^9, 3.657289879815817*^9}, {3.657290220364443*^9, 
   3.657290254980443*^9}, 3.657290286691408*^9, {3.6572903320560713`*^9, 
   3.657290570688314*^9}, 3.657291475647979*^9, {3.657292231171793*^9, 
   3.6572922713347178`*^9}, 3.657293368079337*^9, {3.657360409152904*^9, 
   3.657360473469185*^9}, {3.657361886258823*^9, 3.657361907215755*^9}, {
   3.65736194209411*^9, 3.657361949301708*^9}, {3.657365424624383*^9, 
   3.657365431876946*^9}, {3.6573654619175653`*^9, 3.6573655156253*^9}, {
   3.657365629254279*^9, 3.657365644763666*^9}, {3.6573657180335083`*^9, 
   3.6573657218559103`*^9}, 3.657365757656426*^9, {3.657365833732998*^9, 
   3.6573658611552687`*^9}, {3.657366099816265*^9, 3.657366102617692*^9}},
 CellLabel->
  "In[406]:=",ExpressionUUID->"99ede8d3-4493-40ab-8632-ef1a6c2209f7"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Auxiliary functions", "Subsubsection",
 CellChangeTimes->{{3.65925144956818*^9, 
  3.659251465326666*^9}},ExpressionUUID->"7243db19-0eab-4264-aa36-\
de8977c41bd1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"OuterBravaisVectors", "::", "usage"}], "=", 
    "\"\<FieldInterpolation Option: List of \!\(\*SubscriptBox[\(A\), \
\(i\)]\) vectors that generate the OuterLattice of a MQGradientMesh object. \
If it exists, this information improves considerably the possibilities to \
interpolate the Field data of the object. If Automatic, it a heuristic \
calculation is attempted.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FieldInterpolation", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"OuterBravaisVectors", "\[Rule]", "None"}], ",", 
      RowBox[{"Options", "[", "FindOuterBravaisVectors", "]"}], ",", " ", 
      RowBox[{"Options", "[", "Interpolation", "]"}]}], "}"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FieldInterpolation", "[", 
    RowBox[{"mesh_MQGradientMesh", ",", 
     RowBox[{"opts", ":", " ", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"IA", ",", " ", "data"}], "}"}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"MatrixQ", "[", 
         RowBox[{"OptionValue", "@", "OuterBravaisVectors"}], "]"}], ",", 
        RowBox[{"IA", "=", 
         RowBox[{"Inverse", "[", 
          RowBox[{
           RowBox[{"OptionValue", "@", "OuterBravaisVectors"}], 
           "\[Transpose]"}], "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "@", "OuterBravaisVectors"}], "===", 
           "Automatic"}], ",", "\[IndentingNewLine]", 
          RowBox[{"IA", "=", 
           RowBox[{"Inverse", "[", 
            RowBox[{
             RowBox[{"FindOuterBravaisVectors", "[", 
              RowBox[{"mesh", ",", " ", 
               RowBox[{"FilterRules", "[", 
                RowBox[{
                 RowBox[{"{", "opts", "}"}], ",", 
                 RowBox[{"Options", "[", "FindOuterBravaisVectors", "]"}]}], 
                "]"}]}], "]"}], "\[Transpose]"}], "]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"IA", "=", 
           RowBox[{"IdentityMatrix", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"mesh", "[", "\"\<System\>\"", "]"}], "[", 
              "\"\<Lattice\>\"", "]"}], "[", "\"\<EmbeddingDimensions\>\"", 
             "]"}], "]"}]}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"data", "=", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"mesh", "[", "\"\<OuterSites\>\"", "]"}], ".", 
           RowBox[{"Transpose", "[", "IA", "]"}]}], ",", 
          RowBox[{"mesh", "[", "\"\<Field\>\"", "]"}]}], "}"}], 
        "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"MatrixQ", "[", 
          RowBox[{"OptionValue", "@", "OuterBravaisVectors"}], "]"}], "||", 
         RowBox[{
          RowBox[{"OptionValue", "@", "OuterBravaisVectors"}], "===", 
          "Automatic"}]}], ",", 
        RowBox[{"data", "=", 
         RowBox[{"PadMesh", "@", 
          RowBox[{"MapAt", "[", 
           RowBox[{"Round", ",", "data", ",", 
            RowBox[{"{", 
             RowBox[{"All", ",", "1"}], "}"}]}], "]"}]}]}]}], "]"}], ";", 
      RowBox[{"ReleaseHold", "[", 
       RowBox[{
        RowBox[{"Evaluate", "[", 
         RowBox[{
          RowBox[{"Interpolation", "[", 
           RowBox[{"data", ",", 
            RowBox[{"FilterRules", "[", 
             RowBox[{
              RowBox[{"{", "opts", "}"}], ",", 
              RowBox[{"Options", "[", "Interpolation", "]"}]}], "]"}]}], 
           "]"}], "[", 
          RowBox[{"Sequence", "@@", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"IA", "[", 
               RowBox[{"[", "i", "]"}], "]"}], ".", "#"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", 
               RowBox[{"Length", "@", "IA"}]}], "}"}]}], "]"}]}], "]"}], 
         "]"}], "&"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "GradientInterpolation", "]"}], "=", 
     RowBox[{"Flatten", "@", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"InnerBravaisVectors", "\[Rule]", "None"}], ",", 
        RowBox[{"Options", "[", "FindInnerBravaisVectors", "]"}], ",", " ", 
        RowBox[{"Options", "[", "Interpolation", "]"}]}], "}"}]}]}], ";", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"GradientInterpolation", "[", 
      RowBox[{"mesh_MQGradientMesh", ",", 
       RowBox[{"opts", ":", " ", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"IA", ",", " ", "data"}], "}"}], ",", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"MatrixQ", "[", 
           RowBox[{"OptionValue", "@", "InnerBravaisVectors"}], "]"}], ",", 
          RowBox[{"IA", "=", 
           RowBox[{"Inverse", "[", 
            RowBox[{
             RowBox[{"OptionValue", "@", "InnerBravaisVectors"}], 
             "\[Transpose]"}], "]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"OptionValue", "@", "InnerBravaisVectors"}], "===", 
             "Automatic"}], ",", "\[IndentingNewLine]", 
            RowBox[{"IA", "=", 
             RowBox[{"Inverse", "[", 
              RowBox[{
               RowBox[{"FindInnerBravaisVectors", "[", 
                RowBox[{"mesh", ",", " ", 
                 RowBox[{"FilterRules", "[", 
                  RowBox[{
                   RowBox[{"{", "opts", "}"}], ",", 
                   RowBox[{"Options", "[", "InnerBravaisVectors", "]"}]}], 
                  "]"}]}], "]"}], "\[Transpose]"}], "]"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"IA", "=", 
             RowBox[{"IdentityMatrix", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"mesh", "[", "\"\<System\>\"", "]"}], "[", 
                "\"\<Lattice\>\"", "]"}], "[", "\"\<EmbeddingDimensions\>\"", 
               "]"}], "]"}]}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"data", "=", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{
             RowBox[{"mesh", "[", "\"\<InnerSites\>\"", "]"}], ".", 
             RowBox[{"Transpose", "[", "IA", "]"}]}], ",", 
            RowBox[{
             RowBox[{"mesh", "[", "\"\<GradientMatrix\>\"", "]"}], ".", 
             RowBox[{"mesh", "[", "\"\<Field\>\"", "]"}]}]}], "}"}], 
          "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"MatrixQ", "[", 
            RowBox[{"OptionValue", "@", "InnerBravaisVectors"}], "]"}], "||", 
           
           RowBox[{
            RowBox[{"OptionValue", "@", "InnerBravaisVectors"}], "===", 
            "Automatic"}]}], ",", 
          RowBox[{"data", "=", 
           RowBox[{"PadMesh", "@", 
            RowBox[{"MapAt", "[", 
             RowBox[{"Round", ",", "data", ",", 
              RowBox[{"{", 
               RowBox[{"All", ",", "1"}], "}"}]}], "]"}]}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"temp", "=", "data"}], ";", "\[IndentingNewLine]", 
        RowBox[{"ReleaseHold", "[", 
         RowBox[{
          RowBox[{"Evaluate", "[", 
           RowBox[{
            RowBox[{"Interpolation", "[", 
             RowBox[{"data", ",", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", 
                RowBox[{"Options", "[", "Interpolation", "]"}]}], "]"}]}], 
             "]"}], "[", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"IA", "[", 
                 RowBox[{"[", "i", "]"}], "]"}], ".", "#"}], ",", 
               RowBox[{"{", 
                RowBox[{"i", ",", "1", ",", 
                 RowBox[{"Length", "@", "IA"}]}], "}"}]}], "]"}]}], "]"}], 
           "]"}], "&"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PadMesh", "[", "data_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"minindices", "=", 
        RowBox[{"Min", "/@", 
         RowBox[{"Transpose", "[", 
          RowBox[{"data", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}]}], ",", 
       "wrapper", ",", " ", "wrappeddata"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"wrappeddata", "=", 
       RowBox[{"MapAt", "[", 
        RowBox[{"wrapper", ",", "data", ",", 
         RowBox[{"{", 
          RowBox[{"All", ",", "2"}], "}"}]}], "]"}]}], ";", 
      RowBox[{"(*", 
       RowBox[{"wrappeddata", ":", " ", 
        RowBox[{
        "necessary", " ", "to", " ", "correctly", " ", "convert", " ", "to", 
         " ", "SparseArray", " ", "when", " ", "the", " ", "data", " ", "has",
          " ", "a", " ", "a", " ", "vector", " ", "at", " ", 
         RowBox[{"{", 
          RowBox[{"All", ",", "2"}], "}"}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"MapAt", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"#", "-", "1", "+", "minindices"}], "&"}], ",", 
          RowBox[{"#", "/.", 
           RowBox[{"wrapper", "\[RuleDelayed]", 
            RowBox[{"(", 
             RowBox[{"#", "&"}], ")"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"All", ",", "1"}], "}"}]}], "]"}], "&"}], "[", 
       RowBox[{
        RowBox[{
         RowBox[{"List", "@@@", 
          RowBox[{"Most", "@", 
           RowBox[{"ArrayRules", "[", 
            RowBox[{
             RowBox[{"Normal", "@", 
              RowBox[{"SparseArray", "[", 
               RowBox[{"Rule", "@@@", "#"}], "]"}]}], ",", "\[Infinity]"}], 
            "]"}]}]}], "&"}], "[", 
        RowBox[{
         RowBox[{
          RowBox[{"MapAt", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"#", "+", "1", "-", "minindices"}], "&"}], ",", "#", ",", 
            RowBox[{"{", 
             RowBox[{"All", ",", "1"}], "}"}]}], "]"}], "&"}], "@", 
         "wrappeddata"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LatticeDimensions", "::", "usage"}], "=", 
    "\"\<FindOuterBravaisVectors Option: Denotes the Lattice dimensions of a \
mesh Lattice.\>\""}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "FindInnerBravaisVectors", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{"LatticeDimensions", "\[Rule]", "Automatic"}], "}"}]}], ";", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"FindInnerBravaisVectors", "[", 
      RowBox[{"mesh_MQGradientMesh", ",", " ", 
       RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"sys", "=", 
          RowBox[{"mesh", "[", "\"\<System\>\"", "]"}]}], ",", " ", 
         "innerindices", ",", " ", "latticedimensions"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "@", "LatticeDimensions"}], "===", 
           "Automatic"}], ",", 
          RowBox[{"latticedimensions", "=", 
           RowBox[{
            RowBox[{"sys", "[", "\"\<Lattice\>\"", "]"}], "[", 
            "\"\<LatticeDimensions\>\"", "]"}]}], ",", 
          RowBox[{"latticedimensions", "=", 
           RowBox[{"OptionValue", "@", "LatticeDimensions"}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"latticedimensions", "\[Equal]", "0"}], ",", 
          RowBox[{"latticedimensions", "=", 
           RowBox[{
            RowBox[{"sys", "[", "\"\<Lattice\>\"", "]"}], "[", 
            "\"\<EmbeddingDimensions\>\"", "]"}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"innerindices", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"sys", "[", "\"\<Lattice\>\"", "]"}], "[", 
           "\"\<SiteIndices\>\"", "]"}], "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"sys", "=", 
         RowBox[{"sys", "[", 
          RowBox[{"\"\<HBloch\>\"", "->", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", "}"}], "->", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"[", 
                    RowBox[{"1", ",", "2"}], "]"}], "]"}], ".", 
                  RowBox[{"#", "[", 
                   RowBox[{"[", 
                    RowBox[{"1", ",", "2"}], "]"}], "]"}]}], ")"}], "[", 
                RowBox[{"[", 
                 RowBox[{"innerindices", ",", "innerindices"}], "]"}], 
                "]"}]}], "}"}], "&"}], ")"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"sys", "=", 
         RowBox[{"sys", "[", 
          RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"\"\<Sites\>\"", "\[Rule]", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"First", "[", "#", "]"}], "}"}], "&"}], ")"}]}], 
              "]"}], "&"}], ")"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"sys", "[", "\"\<SiteNeighborDistances\>\"", "]"}], "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", 
           RowBox[{"1", ";;", "latticedimensions"}]}], "]"}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "FindOuterBravaisVectors", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"LatticeDimensions", "\[Rule]", "Automatic"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FindOuterBravaisVectors", "[", 
   RowBox[{"mesh_MQGradientMesh", ",", " ", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"sys", "=", 
       RowBox[{"mesh", "[", "\"\<System\>\"", "]"}]}], ",", " ", 
      "outerindices", ",", " ", "latticedimensions"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "@", "LatticeDimensions"}], "===", 
        "Automatic"}], ",", 
       RowBox[{"latticedimensions", "=", 
        RowBox[{
         RowBox[{"sys", "[", "\"\<Lattice\>\"", "]"}], "[", 
         "\"\<LatticeDimensions\>\"", "]"}]}], ",", 
       RowBox[{"latticedimensions", "=", 
        RowBox[{"OptionValue", "@", "LatticeDimensions"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"latticedimensions", "\[Equal]", "0"}], ",", 
       RowBox[{"latticedimensions", "=", 
        RowBox[{
         RowBox[{"sys", "[", "\"\<Lattice\>\"", "]"}], "[", 
         "\"\<EmbeddingDimensions\>\"", "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"outerindices", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"sys", "[", "\"\<Lattice\>\"", "]"}], "[", 
        "\"\<SiteIndices\>\"", "]"}], "[", 
       RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"sys", "=", 
      RowBox[{"sys", "[", 
       RowBox[{"\"\<HBloch\>\"", "->", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", "}"}], "->", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "2"}], "]"}], "]"}], ".", 
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "2"}], "]"}], "]"}]}], ")"}], "[", 
             RowBox[{"[", 
              RowBox[{"outerindices", ",", "outerindices"}], "]"}], "]"}]}], 
           "}"}], "&"}], ")"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"sys", "=", 
      RowBox[{"sys", "[", 
       RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"#", "[", 
           RowBox[{"\"\<Sites\>\"", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Last", "[", "#", "]"}], "-", 
                RowBox[{"Min", "[", 
                 RowBox[{"Last", "[", "#", "]"}], "]"}]}], "}"}], "&"}], 
             ")"}]}], "]"}], "&"}], ")"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"sys", "[", "\"\<SiteNeighborDistances\>\"", "]"}], "[", 
      RowBox[{"[", 
       RowBox[{"1", ",", 
        RowBox[{"1", ";;", "latticedimensions"}]}], "]"}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.659251469437729*^9, 3.659251579408539*^9}, {
   3.6592516408309727`*^9, 3.6592517574865303`*^9}, 3.659251806701963*^9, {
   3.659251896503973*^9, 3.659252023847824*^9}, {3.659252054088307*^9, 
   3.65925205813477*^9}, {3.65925210610034*^9, 3.65925211148333*^9}, {
   3.659252146505969*^9, 3.6592521486250362`*^9}, {3.659252188135713*^9, 
   3.6592523546138277`*^9}, {3.6592524113877583`*^9, 3.6592524241643877`*^9}, 
   3.659252474935751*^9, {3.659252710102353*^9, 3.6592527361459627`*^9}, {
   3.659252774208222*^9, 3.659252775551012*^9}, {3.659252838583189*^9, 
   3.659252841195816*^9}, {3.659253173402011*^9, 3.659253231487135*^9}, {
   3.6592532953879642`*^9, 3.6592533006193647`*^9}, {3.659253490306507*^9, 
   3.659253748484619*^9}, {3.659253911854072*^9, 3.659253963706066*^9}, {
   3.659254438171558*^9, 3.659254451872881*^9}, {3.659255003572975*^9, 
   3.659255408080955*^9}, {3.6592554426600933`*^9, 3.659255472389621*^9}, {
   3.659255528402294*^9, 3.6592556446676702`*^9}, {3.659255691434403*^9, 
   3.659255697106189*^9}, {3.659255729600642*^9, 3.6592557398232927`*^9}, {
   3.6592559794288397`*^9, 3.659256003289987*^9}, {3.659256068304158*^9, 
   3.659256124884638*^9}, {3.6592561607475433`*^9, 3.659256161810995*^9}, {
   3.6593355477763643`*^9, 3.65933557282185*^9}, {3.659335650844574*^9, 
   3.659335739824937*^9}, {3.6593358118461037`*^9, 3.6593358188989553`*^9}, {
   3.6593358513711147`*^9, 3.659335854120873*^9}, {3.6593359034265003`*^9, 
   3.659335928648279*^9}, {3.659335994331347*^9, 3.6593359987784986`*^9}, {
   3.659336102329067*^9, 3.659336108765476*^9}},
 CellLabel->
  "In[412]:=",ExpressionUUID->"6bbbe1bb-8566-49ed-977d-55e820fe713d"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Band topology", "Subsection",
 CellChangeTimes->{{3.620017750732185*^9, 
  3.6200177526193743`*^9}},ExpressionUUID->"873a2704-7411-4684-a059-\
287093f25ddc"],

Cell[BoxData[
 RowBox[{
  RowBox[{"MomentumCycles", "[", "Npoints_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "BZlattice", ",", " ", "angles", ",", "faces", ",", " ", "plot", ",", 
      "  ", "Berry", ",", " ", "energies", ",", "BZcenters", ",", "nf", ",", 
      "OrderCycle"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"OrderCycle", "[", "points_", "]"}], ":=", 
      RowBox[{"Block", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"average", "=", 
          RowBox[{"Mean", "[", "points", "]"}]}], "}"}], ",", 
        RowBox[{"Sort", "[", 
         RowBox[{"points", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"ArcTan", "@@", 
             RowBox[{"(", 
              RowBox[{"#1", "-", "average"}], ")"}]}], "<", 
            RowBox[{"ArcTan", "@@", 
             RowBox[{"(", 
              RowBox[{"#2", "-", "average"}], ")"}]}]}], "&"}]}], "]"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"BZlattice", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
       RowBox[{"Outer", "[", 
        RowBox[{"List", ",", 
         RowBox[{"Sequence", "@@", 
          RowBox[{"(", 
           RowBox[{"Array", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Range", "[", 
               RowBox[{
                RowBox[{"-", ".5"}], ",", ".5", ",", 
                RowBox[{"1", "/", 
                 RowBox[{"Round", "[", 
                  RowBox[{"Npoints", "-", "1"}], "]"}]}]}], "]"}], "&"}], ",",
              "2"}], "]"}], ")"}]}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"BZcenters", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
       RowBox[{"Outer", "[", 
        RowBox[{"List", ",", 
         RowBox[{"Sequence", "@@", 
          RowBox[{"(", 
           RowBox[{"Array", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Range", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"-", ".5"}], "+", 
                 RowBox[{".5", "/", 
                  RowBox[{"Round", "[", 
                   RowBox[{"Npoints", "-", "1"}], "]"}]}]}], ",", 
                RowBox[{".5", "-", 
                 RowBox[{".5", "/", 
                  RowBox[{"Round", "[", 
                   RowBox[{"Npoints", "-", "1"}], "]"}]}]}], ",", 
                RowBox[{"1", "/", 
                 RowBox[{"Round", "[", 
                  RowBox[{"Npoints", "-", "1"}], "]"}]}]}], "]"}], "&"}], ",",
              "2"}], "]"}], ")"}]}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"nf", "=", 
      RowBox[{"Nearest", "[", "BZlattice", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"faces", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"nf", "[", 
         RowBox[{"#", ",", "4"}], "]"}], "&"}], "/@", "BZcenters"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"faces", "=", 
      RowBox[{"OrderCycle", "/@", "faces"}]}], ";", " ", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"Graphics", "[", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"EdgeForm", "[", "Gray", "]"}], ",", 
           RowBox[{"FaceForm", "[", 
            RowBox[{"GrayLevel", "[", ".9", "]"}], "]"}], ",", 
           RowBox[{"Polygon", "/@", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               FractionBox[
                RowBox[{"#", ".", "g"}], 
                RowBox[{"2", "\[Pi]"}]], "&"}], "/@", "faces"}], ")"}]}]}], 
          "}"}], "]"}], "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
     "faces"}]}], "]"}]}]], "Input",
 CellChangeTimes->{
  3.620017762092319*^9, {3.620017832257236*^9, 3.620017861270713*^9}, 
   3.620018119414134*^9, {3.620030446277039*^9, 3.620030456130116*^9}, {
   3.620030506210145*^9, 3.620030550470963*^9}, {3.620030601698718*^9, 
   3.620030602417478*^9}},
 CellLabel->
  "In[419]:=",ExpressionUUID->"cafd2122-a97e-4579-8db1-02ac6645c736"],

Cell[BoxData[
 RowBox[{
  RowBox[{"BerryCurvature", "[", 
   RowBox[{"EigenSystemCache_Function", ",", "zlist_List"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "esys", ",", " ", "evals", ",", "evecs", ",", " ", "prods", ",", "z1", 
      ",", "z2"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"esys", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"EigenSystemCache", "[", "#", "]"}], "&"}], "/@", "zlist"}]}],
      ";", " ", "\[IndentingNewLine]", 
     RowBox[{"evals", "=", 
      RowBox[{"Mean", "@", 
       RowBox[{"esys", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"evecs", "=", 
      RowBox[{"esys", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "This", " ", "magical", " ", "line", " ", "groups", " ", "all", " ", 
        "evecs", " ", "in", " ", "the", " ", "cycle", " ", "in", " ", 
        "pairs"}], ",", " ", 
       RowBox[{"closing", " ", "the", " ", 
        RowBox[{"cycles", ".", " ", "Then"}], " ", "computes", " ", "all", 
        " ", "the", " ", "scalar", " ", "products"}], ",", " ", 
       RowBox[{
       "in", " ", "each", " ", "subband", " ", "and", " ", "for", " ", "each",
         " ", 
        RowBox[{"pair", ".", " ", "And"}], " ", "then", " ", 
        RowBox[{"normalizes", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"prods", "=", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          FractionBox["#", 
           RowBox[{"Abs", "[", "#", "]"}]], "&"}], "/@", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"#1", "\[Conjugate]"}], ".", "#2"}], "&"}], ",", "#", 
           ",", "1"}], "]"}]}], "&"}], "/@", 
       RowBox[{"Partition", "[", 
        RowBox[{"evecs", ",", "2", ",", "1", ",", 
         RowBox[{"{", 
          RowBox[{"1", ",", "1"}], "}"}]}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{"evals", ",", 
       RowBox[{"Re", "[", 
        RowBox[{
         FractionBox["1", 
          RowBox[{"2", "\[Pi]", " ", "\[ImaginaryI]"}]], 
         RowBox[{"Log", "[", 
          RowBox[{"Times", "@@", "prods"}], "]"}]}], "]"}]}], "}"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.6200179475606337`*^9, 3.620018033681801*^9}, {
   3.620018609328339*^9, 3.620018699182287*^9}, {3.620018909552598*^9, 
   3.620018910041375*^9}, {3.620019182934101*^9, 3.620019215452881*^9}, {
   3.620030104708971*^9, 3.620030114346135*^9}, {3.620030166661461*^9, 
   3.620030206903432*^9}, {3.6200306287963457`*^9, 3.6200306545337143`*^9}, 
   3.620031218570663*^9, {3.6200320512335663`*^9, 3.620032063295887*^9}, 
   3.6200998353633127`*^9},
 CellLabel->
  "In[420]:=",ExpressionUUID->"bc396290-cb5e-43ee-ad48-3c23293b0cb1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "BerryMesh", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"SamplePoints", "\[Rule]", "50"}], ",", 
     RowBox[{"Sequence", "@@", 
      RowBox[{"Options", "[", "BerryCurvature", "]"}]}], ",", 
     RowBox[{"Sequence", "@@", 
      RowBox[{"Options", "[", "Eigenstates", "]"}]}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"BerryMesh", "[", 
   RowBox[{"system_MQSystem", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "cycles", ",", "  ", "Berry", ",", " ", "energies", ",", " ", "centers", 
      ",", "EigenSystemCache", ",", 
      RowBox[{"Npoints", "=", 
       RowBox[{"OptionValue", "[", "SamplePoints", "]"}]}], ",", " ", 
      RowBox[{"counter", "=", "0"}], ",", " ", "curvatures", ",", " ", 
      "bands"}], "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"EigenSystemCache", "[", 
       RowBox[{"{", 
        RowBox[{"z1_", ",", "z2_"}], "}"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"EigenSystemCache", "[", 
        RowBox[{"{", 
         RowBox[{"z1", ",", "z2"}], "}"}], "]"}], "=", 
       RowBox[{
        RowBox[{
         RowBox[{"MapAt", "[", 
          RowBox[{"Flatten", ",", "#", ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "All"}], "}"}]}], "]"}], "&"}], "@", 
        RowBox[{"Eigenstates", "[", 
         RowBox[{
          RowBox[{"system", "[", 
           RowBox[{
            RowBox[{"2", "\[Pi]", " ", "z1"}], ",", 
            RowBox[{"2", "\[Pi]", " ", "z2"}]}], "]"}], ",", 
          RowBox[{"ReturnEigenvalues", "\[Rule]", "True"}], ",", 
          RowBox[{"FilterRules", "[", 
           RowBox[{
            RowBox[{"{", "opts", "}"}], ",", 
            RowBox[{"Options", "[", "Eigenstates", "]"}]}], "]"}], ",", 
          RowBox[{"Levels", "\[Rule]", "All"}]}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"cycles", "=", 
      RowBox[{"MomentumCycles", "[", "Npoints", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Berry", "=", 
      RowBox[{"Monitor", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"counter", "++"}], ";", 
            RowBox[{"BerryCurvature", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"EigenSystemCache", "[", "#", "]"}], "&"}], ",", "#"}],
              "]"}]}], ")"}], "&"}], "/@", "cycles"}], ",", 
        RowBox[{
         RowBox[{"N", "@", "counter"}], "/", 
         RowBox[{"Length", "@", "cycles"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"energies", "=", 
      RowBox[{"Berry", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Berry", "=", 
      RowBox[{"Berry", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"centers", "=", 
      RowBox[{"Mean", "/@", "cycles"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"We", " ", "build", " ", "a", " ", "list", " ", "of", " ", 
       RowBox[{"{", 
        RowBox[{
         SubscriptBox["k", "i"], ",", 
         SubsuperscriptBox["F", "i", "j"]}], "}"}], " ", "meshes", " ", "for",
        " ", "each", " ", "subband", " ", "j", " ", 
       RowBox[{"(", 
        RowBox[{"F", " ", "is", " ", "Berry", " ", "curvature"}], ")"}]}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"curvatures", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"Flatten", "/@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"{", 
            RowBox[{"centers", ",", "#"}], "}"}], "]"}]}], ")"}], "&"}], "/@", 
       RowBox[{"Transpose", "[", "Berry", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"bands", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"Flatten", "/@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"{", 
            RowBox[{"centers", ",", "#"}], "}"}], "]"}]}], ")"}], "&"}], "/@", 
       RowBox[{"Transpose", "[", "energies", "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "The", " ", "same", " ", "with", " ", "energies", " ", "instead", " ", 
       "of", " ", "curvatures"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"{", 
       RowBox[{"energies", ",", 
        RowBox[{"Transpose", "[", 
         RowBox[{"{", 
          RowBox[{"centers", ",", "Berry"}], "}"}], "]"}]}], "}"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{"curvatures", ",", " ", "bands"}], "}"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.6200181101972017`*^9, 3.620018116819686*^9}, {
   3.620018738108418*^9, 3.6200187734742002`*^9}, {3.620018813434409*^9, 
   3.620018850181126*^9}, {3.620030427381873*^9, 3.620030442368868*^9}, {
   3.6200305369916067`*^9, 3.620030679462429*^9}, {3.620030775150895*^9, 
   3.620030791308806*^9}, {3.6200308437544403`*^9, 3.6200308953123503`*^9}, {
   3.620030942518557*^9, 3.620030960714409*^9}, {3.620031079461026*^9, 
   3.6200310941001043`*^9}, {3.620031220817068*^9, 3.620031242198728*^9}, 
   3.620031512766638*^9, {3.620031588301393*^9, 3.620031614462121*^9}, {
   3.620031742229439*^9, 3.620031823348226*^9}, {3.62003186385352*^9, 
   3.620031927115465*^9}, {3.62004983526585*^9, 3.6200498862338057`*^9}, {
   3.620286817961776*^9, 3.620286822932856*^9}, {3.620286853691835*^9, 
   3.620286856336536*^9}, {3.620286917720738*^9, 3.62028692419049*^9}, 
   3.629641857969263*^9, {3.708075731814603*^9, 3.708075734157405*^9}},
 CellLabel->
  "In[421]:=",ExpressionUUID->"214ac764-d8a9-423c-abc9-3c025c3ed27c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ChernNumber", "[", "berrymesh_", "]"}], ":=", 
  RowBox[{"Total", "/@", 
   RowBox[{"berrymesh", "\[LeftDoubleBracket]", 
    RowBox[{"1", ",", "All", ",", "All", ",", "3"}], 
    "\[RightDoubleBracket]"}]}]}]], "Input",
 CellChangeTimes->{{3.620034705769678*^9, 3.620034746628046*^9}, {
   3.620034784490364*^9, 3.620034784753324*^9}, {3.620099727388857*^9, 
   3.620099754119233*^9}, 3.620099992800598*^9, {3.620100839302656*^9, 
   3.620100892532646*^9}},
 CellLabel->
  "In[423]:=",ExpressionUUID->"ca075226-f1cd-48c1-89de-27dacb9a0ed0"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ShowChern", "::", "usage"}], "=", 
   "\"\<Option for PlotBerryMesh that specifies whether the integrated Berry \
curvature, or Chern number, should be shown as a plot label.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "PlotBerryMesh", "]"}], "=", 
   RowBox[{"Flatten", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Options", "@", "ListDensityPlot"}], ",", " ", 
      RowBox[{"ShowChern", "\[Rule]", "True"}]}], "}"}]}]}], ";", 
  RowBox[{
   RowBox[{"PlotBerryMesh", "[", 
    RowBox[{"lattice_MQLattice", ",", " ", "berrymesh_", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"g", "=", 
        RowBox[{"2", "\[Pi]", " ", 
         RowBox[{"Inverse", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"lattice", "[", "\"\<BravaisVectors\>\"", "]"}], "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"1", ";;", "2"}], ",", 
              RowBox[{"1", ";;", "2"}]}], "]"}], "]"}], "\[Transpose]"}], 
          "]"}]}]}], ",", " ", "curvatures", ",", " ", "momentumshifts", ",", 
       " ", "plotrange", ",", " ", "perimeter", ",", "max", ",", " ", 
       "darea"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"curvatures", "=", 
       RowBox[{"berrymesh", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"darea", "=", 
       RowBox[{"Norm", "[", 
        RowBox[{"Cross", "@@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"PadRight", "[", 
             RowBox[{"#", ",", "3", ",", "0"}], "]"}], "&"}], "/@", 
           FractionBox["g", 
            SqrtBox[
             RowBox[{"Length", "[", 
              RowBox[{"berrymesh", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]]]}], ")"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"curvatures", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Sequence", "@@", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"{", 
                  RowBox[{"1", ",", "2"}], "}"}], "]"}], "]"}], ".", "g"}], 
              ")"}]}], ",", 
            FractionBox[
             RowBox[{"#", "[", 
              RowBox[{"[", "3", "]"}], "]"}], "darea"]}], "}"}], "&"}], ",", 
         "curvatures", ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"max", "=", 
       RowBox[{"Max", "@", 
        RowBox[{"Abs", "@", 
         RowBox[{"curvatures", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "All", ",", "3"}], "]"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"perimeter", "=", 
       RowBox[{
        FractionBox["1", "2"], 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"1", ",", "1"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"-", "1"}], ",", 
             RowBox[{"-", "1"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", 
             RowBox[{"-", "1"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "1"}], "}"}]}], "}"}], ".", "g"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"plotrange", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Min", "[", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}], ",", 
             RowBox[{"Max", "[", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}]}], "}"}], ",", 
           
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Min", "[", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], ",", 
             RowBox[{"Max", "[", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "}"}], ",", 
           " ", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"-", "1"}], ",", "1"}], "}"}], "max"}]}], "}"}], "&"}], 
        "@", "perimeter"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"momentumshifts", "=", 
       RowBox[{
        RowBox[{"Tuples", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"-", "1"}], ",", "0", ",", "1"}], "}"}], ",", "2"}], 
         "]"}], ".", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"Append", "[", 
            RowBox[{"#", ",", "0"}], "]"}], "&"}], "/@", "g"}], ")"}]}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"curvatures", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Join", "@@", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"#", "+", 
               RowBox[{"momentumshifts", "[", 
                RowBox[{"[", "j", "]"}], "]"}]}], "&"}], "/@", 
             RowBox[{"curvatures", "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", 
              RowBox[{"Length", "@", "momentumshifts"}]}], "}"}]}], "]"}]}], 
         ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", 
           RowBox[{"Length", "@", "curvatures"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"MapThread", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"ListDensityPlot", "[", 
          RowBox[{"#1", ",", " ", 
           RowBox[{"FilterRules", "[", 
            RowBox[{
             RowBox[{"{", "opts", "}"}], ",", 
             RowBox[{"Options", "[", "ListDensityPlot", "]"}]}], "]"}], ",", 
           RowBox[{"InterpolationOrder", "\[Rule]", "0"}], ",", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"OptionValue", "[", "ShowChern", "]"}], ",", 
             RowBox[{"PlotLabel", "\[Rule]", 
              RowBox[{"\"\<C=\>\"", "~~", 
               RowBox[{"ToString", "@", 
                RowBox[{"Chop", "@", "#2"}]}]}]}], ",", 
             RowBox[{"PlotLabel", "\[Rule]", "Automatic"}]}], "]"}], ",", 
           RowBox[{"ColorFunction", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Evaluate", "[", 
               RowBox[{"Blend", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"-", "1"}], ",", "0", ",", "1"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"Red", ",", "White", ",", "Blue"}], "}"}]}], 
                   "}"}], "\[Transpose]"}], ",", 
                 RowBox[{"#", "/", "max"}]}], "]"}], "]"}], "&"}], ")"}]}], 
           ",", " ", 
           RowBox[{"ColorFunctionScaling", "\[Rule]", "False"}], ",", 
           RowBox[{"AspectRatio", "\[Rule]", "Automatic"}], ",", 
           RowBox[{"ImageSize", "\[Rule]", "Medium"}], ",", 
           RowBox[{"PlotRange", "\[Rule]", "plotrange"}], ",", 
           RowBox[{"Epilog", "\[Rule]", 
            RowBox[{"{", 
             RowBox[{"Thick", ",", 
              RowBox[{"Line", "[", "perimeter", "]"}]}], "}"}]}], ",", 
           "PlotDefaults"}], "]"}], "&"}], ",", 
        RowBox[{"{", 
         RowBox[{"curvatures", ",", " ", 
          RowBox[{"ChernNumber", "[", "berrymesh", "]"}]}], "}"}]}], 
       "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.620031290646152*^9, 3.620031332841998*^9}, {
   3.620032022859956*^9, 3.620032176274049*^9}, {3.620032207294464*^9, 
   3.620032321711225*^9}, {3.620032363549582*^9, 3.6200323650616283`*^9}, {
   3.620032406525326*^9, 3.6200324089527817`*^9}, {3.6200324633758173`*^9, 
   3.620032468557478*^9}, {3.620032512612296*^9, 3.620032565479034*^9}, {
   3.620032774554*^9, 3.620032828665526*^9}, {3.620032915572551*^9, 
   3.62003303912945*^9}, {3.620033091004319*^9, 3.620033186469029*^9}, {
   3.620033231843792*^9, 3.620033286882987*^9}, {3.620033331493082*^9, 
   3.620033439053165*^9}, {3.620033485802442*^9, 3.620033647758032*^9}, {
   3.620033737285902*^9, 3.620033761886981*^9}, {3.620033818830859*^9, 
   3.620033839513942*^9}, 3.620059931169297*^9, {3.620059980633656*^9, 
   3.6200600460893393`*^9}, {3.6200601486274853`*^9, 3.620060149874922*^9}, {
   3.6200602288377657`*^9, 3.6200602489636803`*^9}, {3.620060282287657*^9, 
   3.620060333717421*^9}, {3.6200603831707783`*^9, 3.620060408628873*^9}, {
   3.620100022096702*^9, 3.6201000502360477`*^9}, {3.620100092146042*^9, 
   3.620100104137241*^9}, {3.6201001356875687`*^9, 3.620100146137869*^9}, {
   3.62010021811201*^9, 3.620100228152605*^9}, {3.6201002597505817`*^9, 
   3.620100283404921*^9}, {3.620100313741231*^9, 3.620100323795936*^9}, {
   3.620100360320368*^9, 3.620100360689802*^9}, {3.62010039716461*^9, 
   3.620100657412642*^9}, {3.620100700698474*^9, 3.620100811179449*^9}, {
   3.620100895294202*^9, 3.62010096384112*^9}, {3.620101015268681*^9, 
   3.620101074983762*^9}, 3.620104346129528*^9, 3.6296418584742107`*^9, {
   3.634024215919839*^9, 3.6340242167983093`*^9}},
 CellLabel->
  "In[424]:=",ExpressionUUID->"ce9daa6a-5d8b-445d-bcee-7dac9cce8592"]
}, Open  ]],

Cell[CellGroupData[{

Cell["KPM DOS", "Subsection",
 CellChangeTimes->{{3.6315290621935167`*^9, 
  3.631529064080838*^9}},ExpressionUUID->"9cbadb5a-a4dd-4f4f-b9f7-\
431078e53239"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ChebyVector", "=", 
    RowBox[{"Compile", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Epsilon]", ",", "_Real"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"nmax", ",", "_Integer"}], "}"}]}], "}"}], ",", 
      RowBox[{
       FractionBox["2.", 
        RowBox[{"\[Pi]", 
         SqrtBox[
          RowBox[{"1", "-", 
           SuperscriptBox["\[Epsilon]", "2"]}]]}]], 
       RowBox[{"Prepend", "[", 
        RowBox[{
         RowBox[{"Last", "/@", 
          RowBox[{"NestList", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}], ",", 
               RowBox[{
                RowBox[{"2", "\[Epsilon]", " ", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}], "-", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}]}], "}"}], "&"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "\[Epsilon]"}], "}"}], ",", 
            RowBox[{"nmax", "-", "1"}]}], "]"}]}], ",", "1"}], "]"}]}], ",", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ","}], "*)"}], 
      
      RowBox[{"RuntimeAttributes", "\[Rule]", 
       RowBox[{"{", "Listable", "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DeltaJackson", "=", 
    RowBox[{"Compile", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[Epsilon]", ",", "_Real"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"nmax", ",", "_Integer"}], "}"}]}], "}"}], ",", 
      RowBox[{
       FractionBox["2.", 
        RowBox[{"\[Pi]", 
         SqrtBox[
          RowBox[{"1", "-", 
           SuperscriptBox["\[Epsilon]", "2"]}]]}]], 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           FractionBox[
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{"nmax", "+", "2", "-", "#"}], ")"}], 
              RowBox[{"Cos", "[", 
               FractionBox[
                RowBox[{"\[Pi]", "#"}], 
                RowBox[{"nmax", "+", "2"}]], "]"}]}], "+", 
             RowBox[{
              RowBox[{"Sin", "[", 
               FractionBox[
                RowBox[{"\[Pi]", "#"}], 
                RowBox[{"nmax", "+", "2"}]], "]"}], 
              RowBox[{"Cot", "[", 
               FractionBox["\[Pi]", 
                RowBox[{"nmax", "+", "2"}]], "]"}]}]}], 
            RowBox[{"nmax", "+", "2"}]], "&"}], ")"}], "@", 
         RowBox[{"Range", "[", 
          RowBox[{"0", ",", "nmax"}], "]"}]}], ")"}], 
       RowBox[{"Prepend", "[", 
        RowBox[{
         RowBox[{"Last", "/@", 
          RowBox[{"NestList", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}], ",", 
               RowBox[{
                RowBox[{"2", "\[Epsilon]", " ", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}], "-", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}]}], "}"}], "&"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "\[Epsilon]"}], "}"}], ",", 
            RowBox[{"nmax", "-", "1"}]}], "]"}]}], ",", "1"}], "]"}]}], ",", 
      RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
      RowBox[{"RuntimeAttributes", "\[Rule]", 
       RowBox[{"{", "Listable", "}"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "DOSKPM", "]"}], "=", 
    RowBox[{"Flatten", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"RandomSamples", "\[Rule]", "1"}], ",", 
       RowBox[{"Order", "\[Rule]", "100"}], ",", 
       RowBox[{"Seed", "\[Rule]", "\"\<Uniform\>\""}], ",", " ", 
       RowBox[{"Rescale", "\[Rule]", "Automatic"}], ",", 
       RowBox[{"Parallel", "\[Rule]", "False"}], ",", 
       RowBox[{"Filter", "\[Rule]", 
        RowBox[{
         FractionBox["1", "4."], 
         RowBox[{"{", 
          RowBox[{"1", ",", "2", ",", "1"}], "}"}]}]}], ",", " ", 
       RowBox[{"Options", "[", "Sample", "]"}], ",", " ", 
       RowBox[{"Monitor", "\[Rule]", "True"}]}], "}"}]}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"DOSKPM", "[", 
     RowBox[{"sys_MQSystem", ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"z", ",", "k", ",", 
        RowBox[{"latdim", "=", 
         RowBox[{"sys", "[", "\"\<LatticeDimensions\>\"", "]"}]}]}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"H", "=", 
           RowBox[{
            RowBox[{"sys", "[", 
             RowBox[{"Sequence", "@@", 
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{"2", "\[Pi]", " ", 
                 SubscriptBox["z", "k"]}], ",", 
                RowBox[{"{", 
                 RowBox[{"k", ",", "1", ",", "latdim"}], "}"}]}], "]"}]}], 
             "]"}], "[", "\"\<HBloch\>\"", "]"}]}], ",", 
          RowBox[{"range", "=", 
           RowBox[{"Sequence", "@@", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                SubscriptBox["z", "k"], ",", "0", ",", "1"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"k", ",", "1", ",", "latdim"}], "}"}]}], "]"}]}]}]}], 
         "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Mean", "@", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"Sample", "[", 
            RowBox[{"DOSKPM", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"sys", "[", 
                RowBox[{
                 RowBox[{"2", "\[Pi]", " ", 
                  SubscriptBox["z", "1"]}], ",", 
                 RowBox[{"2", "\[Pi]", " ", 
                  SubscriptBox["z", "2"]}]}], "]"}], "[", "\"\<H\>\"", "]"}], 
              ",", "range", ",", 
              RowBox[{"MaxRecursion", "\[Rule]", "0"}], ",", 
              RowBox[{"FilterRules", "[", 
               RowBox[{
                RowBox[{"{", "opts", "}"}], ",", 
                RowBox[{"Options", "[", "Sample", "]"}]}], "]"}]}], "]"}], 
            "]"}], ",", "1"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"DOSKPM", "[", 
   RowBox[{"sys_MQSystem", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"DOSKPM", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"sys", "[", "\"\<Flat\>\"", "]"}], "[", "\"\<H\>\"", "]"}], ",", 
    "opts"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DOSKPM", "[", 
    RowBox[{"H_SparseArray", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "rescale", ",", "h", ",", "\[Beta]", ",", "h\[Beta]", ",", "dim", ",", 
       "kernel", ",", "meankernel", ",", "\[Epsilon]list", ",", "NN", ",", 
       "m", ",", " ", "dos", ",", " ", "\[Epsilon]mesh", ",", "s", ",", " ", 
       "seed", ",", " ", "samples", ",", " ", "order", ",", " ", 
       RowBox[{"counter", "=", "0"}]}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"NumericQ", "@", 
          RowBox[{"OptionValue", "[", "Rescale", "]"}]}], ",", 
         RowBox[{"rescale", "=", 
          RowBox[{"OptionValue", "[", "Rescale", "]"}]}], ",", 
         RowBox[{"rescale", "=", 
          RowBox[{"Abs", "[", 
           RowBox[{"First", "[", 
            RowBox[{"1.01", 
             RowBox[{"Eigenvalues", "[", 
              RowBox[{"H", ",", "1"}], "]"}]}], "]"}], "]"}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"h", "=", 
        RowBox[{"H", "/", "rescale"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"dim", "=", 
        RowBox[{"Length", "@", "h"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"samples", "=", 
        RowBox[{"OptionValue", "@", "RandomSamples"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"order", "=", 
        RowBox[{"OptionValue", "@", "Order"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"Switch", "[", 
        RowBox[{
         RowBox[{"OptionValue", "@", "Seed"}], ",", "\[IndentingNewLine]", 
         "\"\<UnitNorm\>\"", ",", 
         RowBox[{
          RowBox[{"seed", "[", "]"}], ":=", 
          RowBox[{"Normalize", "[", 
           RowBox[{"Exp", "[", 
            RowBox[{"2", "\[Pi]", " ", "\[ImaginaryI]", " ", 
             RowBox[{"RandomReal", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"0", ",", "1"}], "}"}], ",", "dim"}], "]"}]}], "]"}], 
           "]"}]}], ",", "\[IndentingNewLine]", "\"\<Uniform\>\"", ",", 
         RowBox[{
          RowBox[{"seed", "[", "]"}], ":=", 
          RowBox[{"Normalize", "[", 
           RowBox[{"RandomComplex", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"-", "1"}], "-", "\[ImaginaryI]"}], ",", 
               RowBox[{"1", "+", "\[ImaginaryI]"}]}], "}"}], ",", "dim"}], 
            "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"_", "?", "ArrayQ"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"seed", "[", "]"}], "=", 
           RowBox[{"N", "@", 
            RowBox[{"OptionValue", "@", "Seed"}]}]}], ";", 
          RowBox[{"samples", "=", "1"}]}], ",", "\[IndentingNewLine]", "_", 
         ",", 
         RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"meankernel", "=", "\[IndentingNewLine]", 
        RowBox[{"Monitor", "[", 
         RowBox[{
          RowBox[{"Mean", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"OptionValue", "@", "Parallel"}], ",", "ParallelTable", 
              ",", "Table"}], "]"}], "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"Clear", "[", "\[Beta]", "]"}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"\[Beta]", "=", 
               RowBox[{"seed", "[", "]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"counter", "=", "0"}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"With", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"collector", "=", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"VectorQ", "[", "\[Beta]", "]"}], ",", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Sow", "[", 
                    RowBox[{
                    RowBox[{"\[Beta]", "\[Conjugate]"}], ".", "#"}], "]"}], 
                    ";", "#"}], ")"}], "&"}], ",", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Sow", "[", 
                    RowBox[{"Tr", "[", 
                    RowBox[{
                    RowBox[{"\[Beta]", "\[HermitianConjugate]"}], ".", "#"}], 
                    "]"}], "]"}], ";", "#"}], ")"}], "&"}]}], "]"}]}], "}"}], 
                ",", "\[IndentingNewLine]", 
                RowBox[{"kernel", "=", 
                 RowBox[{"First", "@", 
                  RowBox[{"Last", "@", 
                   RowBox[{"Reap", "@", 
                    RowBox[{"Nest", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"counter", "++"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Last", "@", "#"}], ",", "\[IndentingNewLine]", 
                    RowBox[{"collector", "[", 
                    RowBox[{
                    RowBox[{"2", 
                    RowBox[{"h", ".", 
                    RowBox[{"Last", "@", "#"}]}]}], "-", 
                    RowBox[{"First", "@", "#"}]}], "]"}]}], "}"}]}], ")"}], 
                    "&"}], ",", "\[IndentingNewLine]", 
                    RowBox[{"collector", "/@", 
                    RowBox[{"{", 
                    RowBox[{"\[Beta]", ",", 
                    RowBox[{"h", ".", "\[Beta]"}]}], "}"}]}], ",", 
                    RowBox[{"order", "-", "1"}]}], "]"}]}]}]}]}]}], "]"}], 
              ";", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"kernel", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "*=", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"MatrixQ", "[", "\[Beta]", "]"}], ",", 
                 RowBox[{"0.5", 
                  RowBox[{"Last", "@", 
                   RowBox[{"Dimensions", "@", "\[Beta]"}]}]}], ",", " ", 
                 "0.5"}], "]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"Re", "@", "kernel"}]}], ",", 
             RowBox[{"{", 
              RowBox[{"s", ",", "samples"}], "}"}]}], "]"}], 
           "\[IndentingNewLine]", "]"}], ",", 
          RowBox[{"\"\<sample = \>\"", "~~", 
           RowBox[{"ToString", "@", "s"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"NN", "=", 
        RowBox[{
         RowBox[{"Length", "@", "kernel"}], "-", "1"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Epsilon]mesh", "[", 
         RowBox[{"m_", ",", "NN_"}], "]"}], "=", 
        RowBox[{
         RowBox[{"Sign", "[", "m", "]"}], 
         RowBox[{"Cos", "[", 
          RowBox[{"\[Pi]", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"m", "-", "0.5"}], ")"}], "/", 
            RowBox[{"(", 
             RowBox[{"NN", "+", "1"}], ")"}]}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Epsilon]list", "=", 
        RowBox[{"Sort", "@", 
         RowBox[{"\[Epsilon]mesh", "[", 
          RowBox[{
           RowBox[{"Range", "[", 
            RowBox[{"1", ",", 
             RowBox[{"NN", "+", "1"}]}], "]"}], ",", "NN"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"dos", "=", 
          RowBox[{
           RowBox[{"ChebyVector", "[", 
            RowBox[{"\[Epsilon]list", ",", "NN"}], "]"}], ".", 
           "meankernel"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"dos", "=", 
        RowBox[{
         RowBox[{"DeltaJackson", "[", 
          RowBox[{"\[Epsilon]list", ",", "NN"}], "]"}], ".", "meankernel"}]}],
        ";"}], "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"ListQ", "@", 
          RowBox[{"OptionValue", "@", "Filter"}]}], ",", 
         RowBox[{"dos", "=", 
          RowBox[{"ListConvolve", "[", 
           RowBox[{
            RowBox[{"OptionValue", "@", "Filter"}], ",", "dos", ",", "2"}], 
           "]"}]}]}], "]"}], "*)"}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"rescale", " ", "\[Epsilon]list"}], ",", 
         FractionBox["dos", "rescale"]}], "}"}], "\[Transpose]"}]}]}], 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.566553374441791*^9, 3.566553442065063*^9}, {
   3.5665534934416924`*^9, 3.566553553926557*^9}, {3.566553584797792*^9, 
   3.5665541349927607`*^9}, {3.566554222792721*^9, 3.566554426705925*^9}, {
   3.566554465232478*^9, 3.56655452525869*^9}, {3.566554584247437*^9, 
   3.566555026552243*^9}, {3.566555057398885*^9, 3.566555229985588*^9}, {
   3.5665555918573217`*^9, 3.566555628060627*^9}, {3.5665556654347353`*^9, 
   3.5665558772900467`*^9}, {3.566556229392263*^9, 3.566556235543766*^9}, {
   3.5665562753197927`*^9, 3.566556332435583*^9}, {3.566556379188273*^9, 
   3.5665563795398397`*^9}, {3.566556414644058*^9, 3.5665564873615093`*^9}, {
   3.5665565706314297`*^9, 3.566556596450479*^9}, {3.56655682407316*^9, 
   3.566556824496616*^9}, {3.566559294171907*^9, 3.566559299686417*^9}, {
   3.5665593650863113`*^9, 3.56655936566891*^9}, {3.566559527552991*^9, 
   3.566559528144747*^9}, {3.5665613543153057`*^9, 3.5665613644246683`*^9}, {
   3.566561490606056*^9, 3.566561551802723*^9}, {3.566562111837949*^9, 
   3.566562122509704*^9}, {3.5665622338828373`*^9, 3.5665622463545628`*^9}, {
   3.566562288937965*^9, 3.5665623020086803`*^9}, {3.566562366040516*^9, 
   3.566562382029907*^9}, {3.566562450983391*^9, 3.566562533489994*^9}, {
   3.5665625874038773`*^9, 3.566562591504506*^9}, {3.5665626555349903`*^9, 
   3.566562669157312*^9}, {3.566564362996744*^9, 3.566564364770685*^9}, {
   3.5665644996502237`*^9, 3.566564519551176*^9}, {3.566566541739232*^9, 
   3.566566569243353*^9}, {3.566566811771666*^9, 3.566566812018961*^9}, {
   3.566573548109089*^9, 3.566573554077236*^9}, {3.566575927999856*^9, 
   3.566575985896263*^9}, {3.566576026007929*^9, 3.5665760340704927`*^9}, {
   3.566639341494479*^9, 3.566639345913435*^9}, {3.5666398337757673`*^9, 
   3.566639841406878*^9}, {3.5666398922844048`*^9, 3.566639898828457*^9}, {
   3.5666399955752277`*^9, 3.566640038465806*^9}, {3.566640118928097*^9, 
   3.5666401193519278`*^9}, 3.566640545096157*^9, {3.5666406705313683`*^9, 
   3.566640700528975*^9}, {3.566640762304008*^9, 3.566640762631069*^9}, {
   3.56664079413667*^9, 3.566640794382804*^9}, {3.566640853516711*^9, 
   3.566640877413603*^9}, {3.566640915658512*^9, 3.566640932676758*^9}, {
   3.566640985351412*^9, 3.566641102293242*^9}, {3.566641210732842*^9, 
   3.566641250696278*^9}, {3.566641405382887*^9, 3.5666414059357157`*^9}, {
   3.566641466158701*^9, 3.5666415110587397`*^9}, {3.566641575651813*^9, 
   3.566641627603256*^9}, {3.566641663826055*^9, 3.566641718020385*^9}, {
   3.5666417509187183`*^9, 3.566641757564703*^9}, {3.566642608306859*^9, 
   3.566642612368649*^9}, {3.566643398517659*^9, 3.566643409889482*^9}, {
   3.566646518260606*^9, 3.566646739158821*^9}, {3.5666468670789833`*^9, 
   3.566646874656766*^9}, {3.566646911093891*^9, 3.566646944643333*^9}, {
   3.5666470221479683`*^9, 3.566647147127363*^9}, {3.566647207378509*^9, 
   3.566647210220858*^9}, {3.566647387437126*^9, 3.566647495061318*^9}, {
   3.566647538437312*^9, 3.5666477840310917`*^9}, {3.566713890643626*^9, 
   3.566713896586185*^9}, {3.5667262727073603`*^9, 3.566726303265999*^9}, {
   3.566892029133008*^9, 3.566892029595766*^9}, {3.566905120673156*^9, 
   3.5669051212543983`*^9}, {3.566905188615*^9, 3.5669051906151323`*^9}, {
   3.56690531320501*^9, 3.56690531604916*^9}, 3.5671468750227127`*^9, {
   3.567250545237028*^9, 3.567250859335053*^9}, {3.567250901354484*^9, 
   3.5672509093484983`*^9}, 3.567250947955648*^9, {3.56725109081015*^9, 
   3.567251093629487*^9}, {3.567251763540215*^9, 3.567251790638358*^9}, {
   3.567252193200906*^9, 3.5672521973973103`*^9}, 3.567319513987464*^9, {
   3.567419764125676*^9, 3.567419768275383*^9}, {3.5674198569916973`*^9, 
   3.567419866094038*^9}, {3.567420252781149*^9, 3.5674202959872293`*^9}, {
   3.567542943376091*^9, 3.567542991316122*^9}, {3.567543022482895*^9, 
   3.567543105203409*^9}, {3.567543172915553*^9, 3.567543176180007*^9}, {
   3.567930966711067*^9, 3.567930967016882*^9}, {3.577634858840439*^9, 
   3.5776348862514563`*^9}, {3.6315249243480797`*^9, 
   3.6315249493135853`*^9}, {3.63152504918963*^9, 3.631525351535912*^9}, {
   3.631525451043132*^9, 3.631525508431082*^9}, {3.63152555426889*^9, 
   3.6315258164105988`*^9}, {3.631526332721786*^9, 3.6315265279499617`*^9}, {
   3.631526565293133*^9, 3.631526770202725*^9}, {3.631526808146817*^9, 
   3.6315268669350452`*^9}, {3.6315269045182*^9, 3.631526913076047*^9}, {
   3.6315269528667517`*^9, 3.631526998824108*^9}, {3.631527037263413*^9, 
   3.6315271657372923`*^9}, {3.631527446352632*^9, 3.631527451865684*^9}, {
   3.631528098107956*^9, 3.631528171806692*^9}, {3.6315282120056562`*^9, 
   3.6315282682674*^9}, {3.631528569975692*^9, 3.6315285809912653`*^9}, {
   3.6315287193999233`*^9, 3.631528722662594*^9}, {3.6315290443268213`*^9, 
   3.631529052006401*^9}, 3.635236093113756*^9, 3.6518119186582203`*^9, {
   3.673860677588619*^9, 3.673860801543783*^9}, {3.673860929248001*^9, 
   3.6738609383526382`*^9}, {3.67386098926924*^9, 3.673861320712729*^9}, {
   3.67386145344735*^9, 3.6738614588402243`*^9}, {3.6738615403078327`*^9, 
   3.673861562552948*^9}, {3.673862598793146*^9, 3.6738626008873158`*^9}, {
   3.673862664459173*^9, 3.6738626727580223`*^9}, {3.67387983029994*^9, 
   3.67387983277929*^9}, {3.6738799438841963`*^9, 3.6738799635091887`*^9}, {
   3.673880265569045*^9, 3.673880274621911*^9}, {3.6738804641256437`*^9, 
   3.673880464252873*^9}, {3.673880810012281*^9, 3.673880829431798*^9}, 
   3.673880926127503*^9, {3.673880993292736*^9, 3.673881007587276*^9}, {
   3.673881107301272*^9, 3.673881109587759*^9}, {3.673881209202684*^9, 
   3.673881216345537*^9}, 3.673881246351371*^9, 3.6738813557068253`*^9, 
   3.673881417433182*^9, {3.673881455354394*^9, 3.67388148542155*^9}, {
   3.673881665381547*^9, 3.67388166621937*^9}, {3.6738817147629538`*^9, 
   3.673881724953973*^9}, {3.6738818070573997`*^9, 3.6738818284082193`*^9}, {
   3.6738819514469233`*^9, 3.6738819518697767`*^9}, {3.673882151828514*^9, 
   3.6738821634333267`*^9}, {3.673942264972989*^9, 3.673942296265909*^9}, {
   3.6739423500969477`*^9, 3.67394236503911*^9}, {3.673942408557784*^9, 
   3.6739425218480787`*^9}, {3.6739425798477297`*^9, 3.6739426037964*^9}, {
   3.673942653874984*^9, 3.6739426861607723`*^9}, {3.6739492333792467`*^9, 
   3.673949234695984*^9}, {3.673949269355278*^9, 3.673949271010201*^9}, {
   3.673949669239739*^9, 3.6739496749427567`*^9}, {3.673949708552443*^9, 
   3.6739497516513166`*^9}, {3.673949781666629*^9, 3.673949799195924*^9}, {
   3.673950181974869*^9, 3.673950196798635*^9}, {3.673950252892377*^9, 
   3.673950254796105*^9}, {3.6739503236153717`*^9, 3.673950343496378*^9}, 
   3.6739504452587137`*^9, {3.673950576057477*^9, 3.673950625451037*^9}, {
   3.673950733132864*^9, 3.673950780770859*^9}, {3.707917917406151*^9, 
   3.707917950050671*^9}, {3.70791824323037*^9, 3.707918244246005*^9}, {
   3.707918749057621*^9, 3.7079187589828672`*^9}, {3.707918798849743*^9, 
   3.7079188467883673`*^9}, {3.707918922644393*^9, 3.707918977577017*^9}, {
   3.707919012952835*^9, 3.707919016699161*^9}, {3.70791919788566*^9, 
   3.707919289163937*^9}, {3.7079193717942467`*^9, 3.7079193970642843`*^9}, {
   3.7080634171513643`*^9, 3.708063445167845*^9}, {3.708063518623316*^9, 
   3.708063550725254*^9}},
 CellLabel->
  "In[426]:=",ExpressionUUID->"24cf69d3-6d7d-4c58-abcc-a3d368e82368"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Linear Response", "Subsection",
 CellChangeTimes->{{3.6659214253958483`*^9, 
  3.665921428691841*^9}},ExpressionUUID->"92f93ead-3726-4594-818b-\
7b96ff9e1318"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BuildBandstructure", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"MomentumSamplePoints", "\[Rule]", "10"}], ",", 
      RowBox[{"BrillouinZoneRange", "\[Rule]", "All"}], ",", " ", 
      RowBox[{"Parallelize", "\[Rule]", "False"}], ",", 
      RowBox[{"Sequence", "@@", 
       RowBox[{"Options", "[", "Eigenstates", "]"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MomentumSamplePoints", "::", "usage"}], "=", 
    "\"\<BuildBandstructure option: number of points along each direction in \
the Brillouin zone to sample. It may be an integer or a list of \
LatticeDimension integers\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BrillouinZoneRange", "::", "usage"}], "=", 
    "\"\<BuildBandstructure option: a specification for the range of k\
\[CenterDot]A/2\[Pi] to sweep. Default is All, which corresponds to \
{{0,1},{0,1}...}.\>\""}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BuildBandstructure", "::", "zpoints"}], "=", 
    "\"\<MomentumSamplePoints should be a number of a vector of numbers of \
length equal to LatticeDimensions\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BuildBandstructure", "[", 
    RowBox[{"sys_MQSystem", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"latdim", "=", 
        RowBox[{"sys", "[", "\"\<LatticeDimensions\>\"", "]"}]}], ",", 
       "numops", ",", " ", "zranges", ",", " ", "zvals", ",", "$nz", ",", 
       "zpoints", ",", "extrapoint", ",", "\[IndentingNewLine]", "numkpoints",
        ",", "\[IndentingNewLine]", "data", ",", " ", "collectdata", ",", 
       "\[IndentingNewLine]", "detA", ",", " ", "zini", ",", " ", "zend", ",",
        "z"}], "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"sys", "[", "\"\<Lattice\>\"", "]"}], "\[Equal]", 
         RowBox[{"Missing", "[", "]"}]}], ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"MQSystem", "::", "missinglat"}], "]"}], ";", 
         RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"detA", "=", 
       RowBox[{
        RowBox[{"sys", "[", "\"\<Lattice\>\"", "]"}], "[", 
        "\"\<UnitCellArea\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"collectdata", "[", "z_", "]"}], ":=", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"evals", ",", " ", "evecs"}], "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"evals", ",", " ", "evecs"}], "}"}], "=", 
           RowBox[{"Eigenstates", "[", 
            RowBox[{
             RowBox[{"sys", "[", "z", "]"}], ",", 
             RowBox[{"ReturnEigenvalues", "\[Rule]", "True"}], ",", 
             RowBox[{"FilterRules", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"opts", ",", 
                 RowBox[{"Levels", "\[Rule]", "All"}]}], "}"}], ",", 
               RowBox[{"Options", "[", "Eigenstates", "]"}]}], "]"}]}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"z", ",", 
            RowBox[{"Developer`ToPackedArray", "@", 
             RowBox[{"Re", "@", "evals"}]}], ",", 
            RowBox[{"Developer`ToPackedArray", "@", "evecs"}]}], "}"}]}]}], 
        "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Build", " ", "distinct", " ", "symbols", " ", "for", " ", "each", " ",
         "dimension", " ", "so", " ", "that", " ", "ParallelTable", " ", 
        RowBox[{"doesn", "'"}], "t", " ", "choke"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"zvals", "=", 
       RowBox[{"ToExpression", "/@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"\"\<$nz\>\"", "<>", 
            RowBox[{"ToString", "[", "#", "]"}]}], "&"}], "/@", 
          RowBox[{"Range", "[", "latdim", "]"}]}], ")"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Dimensions", "[", 
          RowBox[{"OptionValue", "@", "BrillouinZoneRange"}], "]"}], "==", 
         RowBox[{"{", 
          RowBox[{"latdim", ",", "2"}], "}"}]}], ",", " ", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"zini", ",", " ", "zend"}], "}"}], "=", 
         RowBox[{
          RowBox[{"OptionValue", "@", "BrillouinZoneRange"}], 
          "\[Transpose]"}]}], ",", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"zini", ",", " ", "zend"}], "}"}], "=", 
         RowBox[{
          RowBox[{"ConstantArray", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"0", ",", "1"}], "}"}], ",", "latdim"}], "]"}], 
          "\[Transpose]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"zpoints", "=", 
       RowBox[{"OptionValue", "@", "MomentumSamplePoints"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"NumericQ", "[", "zpoints", "]"}], ",", 
        RowBox[{"zpoints", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"zpoints", ",", "latdim"}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"VectorQ", "[", 
          RowBox[{"zpoints", ",", " ", "NumericQ"}], "]"}], "&&", 
         RowBox[{
          RowBox[{"Length", "@", "zpoints"}], "\[Equal]", "latdim"}]}], ",", 
        "None", ",", "\[IndentingNewLine]", "True", ",", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"BuildBandstructure", "::", "zpoints"}], "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "If", " ", "the", " ", "BZ", " ", "sampling", " ", "is", " ", "not", 
         " ", "full", " ", "in", " ", "a", " ", "given", " ", "direction"}], 
        ",", " ", 
        RowBox[{
        "we", " ", "include", " ", "both", " ", "endpoints", " ", "of", " ", 
         "the", " ", "range"}], ",", " ", 
        RowBox[{
        "otherwise", " ", "we", " ", "drop", " ", "the", " ", "extra", " ", 
         "point"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"extrapoint", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Chop", "[", 
             RowBox[{"Mod", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"zend", "[", 
                 RowBox[{"[", "j", "]"}], "]"}], "-", 
                RowBox[{"zini", "[", 
                 RowBox[{"[", "j", "]"}], "]"}]}], ",", "1"}], "]"}], "]"}], 
            "\[Equal]", "0"}], ",", "0", ",", "1"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "latdim"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"numkpoints", "=", 
       RowBox[{"Times", "@@", "zpoints"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"zranges", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"zvals", "[", 
            RowBox[{"[", "j", "]"}], "]"}], ",", "0", ",", 
           RowBox[{
            RowBox[{"zpoints", "[", 
             RowBox[{"[", "j", "]"}], "]"}], "-", "1"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "latdim"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"data", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{"#", ",", " ", 
           RowBox[{"latdim", "-", "1"}]}], "]"}], "&"}], "@", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"OptionValue", "[", "Parallelize", "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"ParallelTable", "[", 
           RowBox[{
            RowBox[{"collectdata", "[", 
             RowBox[{"2", "\[Pi]", " ", 
              RowBox[{"N", "[", 
               RowBox[{"zini", "+", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"zend", "-", "zini"}], ")"}], 
                 RowBox[{"zvals", "/", 
                  RowBox[{"(", 
                   RowBox[{"zpoints", "-", "extrapoint"}], ")"}]}]}]}], 
               "]"}]}], "]"}], ",", 
            RowBox[{"Evaluate", "[", 
             RowBox[{"Sequence", "@@", "zranges"}], "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"Monitor", "[", 
           RowBox[{
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"collectdata", "[", 
               RowBox[{"2", "\[Pi]", " ", 
                RowBox[{"N", "[", 
                 RowBox[{"zini", "+", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{"zend", "-", "zini"}], ")"}], 
                   RowBox[{"zvals", "/", 
                    RowBox[{"(", 
                    RowBox[{"zpoints", "-", "extrapoint"}], ")"}]}]}]}], 
                 "]"}]}], "]"}], ",", 
              RowBox[{"Evaluate", "[", 
               RowBox[{"Sequence", "@@", "zranges"}], "]"}]}], "]"}], ",", 
            RowBox[{"N", "[", 
             RowBox[{"zvals", "/", "zpoints"}], "]"}]}], "]"}]}], 
         "\[IndentingNewLine]", "]"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"MQBandstructure", "[", 
        RowBox[{
         RowBox[{"\"\<BandData\>\"", "\[Rule]", "data"}], ",", " ", 
         RowBox[{"\"\<LatticeDimensions\>\"", "\[Rule]", "latdim"}], ",", 
         RowBox[{"\"\<NumberOfPoints\>\"", "->", "numkpoints"}], ",", " ", 
         RowBox[{"\"\<UnitCellArea\>\"", "\[Rule]", "detA"}], ",", " ", 
         RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
          RowBox[{"sys", "[", "\"\<Lattice\>\"", "]"}]}]}], "]"}], "]"}]}]}], 
    "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"CombineBandstructures", "[", "bstructs__MQBandstructure", "]"}], ":=",
   "\[IndentingNewLine]", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Equal", "@@", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"#", "[", "\"\<LatticeDimensions\>\"", "]"}], "&"}], "/@", 
        RowBox[{"{", "bstructs", "}"}]}], ")"}]}], "&&", 
     RowBox[{"Equal", "@@", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"#", "[", "\"\<UnitCellArea\>\"", "]"}], "&"}], "/@", 
        RowBox[{"{", "bstructs", "}"}]}], ")"}]}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"{", "bstructs", "}"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}], "[", 
      RowBox[{"\"\<BandData\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Join", "@@", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"#", "[", "\"\<BandData\>\"", "]"}], "&"}], "/@", 
            RowBox[{"{", "bstructs", "}"}]}], ")"}]}], "&"}], ")"}]}], "]"}], 
     "[", 
     RowBox[{"\"\<NumberOfPoints\>\"", "\[Rule]", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Total", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"#", "[", "\"\<NumberOfPoints\>\"", "]"}], "&"}], "/@", 
          RowBox[{"{", "bstructs", "}"}]}], "]"}], "&"}], ")"}]}], "]"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.665904442414667*^9, 3.665904745803578*^9}, {
   3.665904828015769*^9, 3.66590483598272*^9}, {3.665904890572002*^9, 
   3.6659050548847437`*^9}, {3.665905540188839*^9, 3.6659058103360233`*^9}, {
   3.665905875556087*^9, 3.665906123704599*^9}, {3.665906153911407*^9, 
   3.665906319664904*^9}, {3.6659063553968067`*^9, 3.665906383875965*^9}, {
   3.665906483182592*^9, 3.6659065135445547`*^9}, {3.665906568654306*^9, 
   3.665906578117402*^9}, {3.665906689037449*^9, 3.665906740234027*^9}, {
   3.665906877455594*^9, 3.665907051572845*^9}, {3.665907119648879*^9, 
   3.665907189366372*^9}, {3.665907241826877*^9, 3.6659072548197107`*^9}, {
   3.66590802986899*^9, 3.6659080307191343`*^9}, {3.665908061630443*^9, 
   3.6659083275099897`*^9}, {3.665908359956729*^9, 3.665908375220035*^9}, {
   3.665908422818129*^9, 3.665908473534789*^9}, {3.665908519980802*^9, 
   3.665908566714424*^9}, {3.665908599138042*^9, 3.6659086576947002`*^9}, {
   3.66590869315773*^9, 3.665908707051338*^9}, {3.665908792594289*^9, 
   3.665908847181954*^9}, {3.665908885803179*^9, 3.665909124255952*^9}, {
   3.665909254897163*^9, 3.665909293495027*^9}, {3.665909327270391*^9, 
   3.665909356163464*^9}, {3.665911738620035*^9, 3.665911747232451*^9}, {
   3.665911786295289*^9, 3.665911824308571*^9}, {3.665911974085487*^9, 
   3.665912013379524*^9}, {3.665912050737924*^9, 3.665912050914805*^9}, {
   3.665912097064786*^9, 3.665912110416381*^9}, {3.665912147654332*^9, 
   3.665912155677466*^9}, {3.665912207130671*^9, 3.665912252872916*^9}, {
   3.665912333700795*^9, 3.66591233806034*^9}, {3.6659125389787827`*^9, 
   3.665912689042815*^9}, {3.665912729768427*^9, 3.665912763390575*^9}, {
   3.665912814291401*^9, 3.665912849154834*^9}, {3.665913001131617*^9, 
   3.6659131781231117`*^9}, {3.665913233344966*^9, 3.665913308357654*^9}, {
   3.665913343468554*^9, 3.665913374939348*^9}, {3.6659135023568773`*^9, 
   3.6659135178111563`*^9}, {3.665913721396494*^9, 3.665913735975691*^9}, {
   3.665913813620965*^9, 3.665913819116885*^9}, {3.66591388449546*^9, 
   3.665913912584662*^9}, {3.665913943511909*^9, 3.665914191794359*^9}, {
   3.665914388991869*^9, 3.66591442133454*^9}, {3.665914518409671*^9, 
   3.665914629460793*^9}, {3.665914732168407*^9, 3.6659147714311037`*^9}, {
   3.665914872210286*^9, 3.665914892783749*^9}, {3.665915020851427*^9, 
   3.665915048056325*^9}, {3.665915647036181*^9, 3.665915651540187*^9}, {
   3.6659157507734003`*^9, 3.665915867417192*^9}, 3.665915918150826*^9, {
   3.665915958540494*^9, 3.66591596076431*^9}, {3.665916026837682*^9, 
   3.665916065855657*^9}, 3.665917135730322*^9, {3.6659178238266163`*^9, 
   3.6659178958507767`*^9}, {3.665917944353722*^9, 3.6659179460137367`*^9}, {
   3.665922460871641*^9, 3.6659224619875097`*^9}, {3.6659225160186977`*^9, 
   3.665922530307783*^9}, {3.665922576871327*^9, 3.665922604924931*^9}, {
   3.665922642731719*^9, 3.6659226930656567`*^9}, {3.665925916286154*^9, 
   3.665926036512175*^9}, {3.665926217907237*^9, 3.6659262262743883`*^9}, {
   3.665926304497993*^9, 3.665926350031171*^9}, {3.665926507763406*^9, 
   3.665926507850663*^9}, {3.665926601209243*^9, 3.66592665678344*^9}, {
   3.6659268935924788`*^9, 3.665926896119759*^9}, {3.665927208263839*^9, 
   3.665927210854574*^9}, {3.665941400308502*^9, 3.665941402419056*^9}, {
   3.665941520073189*^9, 3.665941521017943*^9}, {3.665981864708221*^9, 
   3.66598188042209*^9}, {3.665985927562758*^9, 3.665985932513548*^9}, 
   3.665989546776025*^9, {3.6663359983774223`*^9, 3.666336015600945*^9}, {
   3.6665943699088984`*^9, 3.6665943713319817`*^9}, {3.666596904867773*^9, 
   3.666597010397964*^9}, {3.6665972330775967`*^9, 3.666597250571013*^9}, {
   3.666597291792779*^9, 3.6665973154870653`*^9}, {3.6667894234444933`*^9, 
   3.666789524010077*^9}, {3.6667896169048967`*^9, 3.66678963266402*^9}, {
   3.666789827923971*^9, 3.66679001147178*^9}, 3.666790088168293*^9, 
   3.666790177166757*^9, 3.666790370136592*^9, {3.6667905840333967`*^9, 
   3.666790613477154*^9}, {3.666792479175407*^9, 3.666792513382641*^9}, {
   3.6668442051257753`*^9, 3.666844214645548*^9}, {3.666884655808413*^9, 
   3.66688472121128*^9}, {3.6668855673680468`*^9, 3.666885608397764*^9}, {
   3.666885640964622*^9, 3.666885712826377*^9}, {3.666885804849682*^9, 
   3.6668858284068193`*^9}, {3.666885878494276*^9, 3.666885880211108*^9}, {
   3.6668867006336517`*^9, 3.666886720736247*^9}, {3.666950548389331*^9, 
   3.666950767578931*^9}, {3.6669508035761547`*^9, 3.666950807458582*^9}, {
   3.666950870844611*^9, 3.6669511904128532`*^9}, {3.666951274007317*^9, 
   3.666951370568549*^9}, {3.6669514242205143`*^9, 3.666951485984351*^9}, {
   3.666951521105152*^9, 3.666951611345553*^9}, {3.6669518769390097`*^9, 
   3.66695187850702*^9}, {3.6669519274804993`*^9, 3.66695192887125*^9}, {
   3.6669519785498667`*^9, 3.666952080902864*^9}, {3.6669527446668253`*^9, 
   3.6669527739748163`*^9}, {3.6669528637163973`*^9, 3.666953007890213*^9}, {
   3.666953163273795*^9, 3.666953205639597*^9}, {3.666953348865456*^9, 
   3.6669533752392473`*^9}, {3.667104720420126*^9, 3.667104728210766*^9}, {
   3.667104798093419*^9, 3.6671047982638693`*^9}, 3.667104896875586*^9, {
   3.667105273991037*^9, 3.6671053801159973`*^9}, {3.66710541771415*^9, 
   3.667105462223899*^9}, {3.667105528662342*^9, 3.6671055307068443`*^9}, {
   3.667107365433188*^9, 3.667107365807849*^9}, {3.667107399724885*^9, 
   3.6671074002779293`*^9}, {3.667107706451922*^9, 3.667107736371326*^9}, {
   3.667115247160021*^9, 3.667115247519915*^9}},
 CellLabel->
  "In[431]:=",ExpressionUUID->"2be76843-2c49-4a50-a3e6-ac71dd42c336"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "data", " ", "is", " ", "a", " ", "list", " ", "of", " ", "pairs", " ", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"energy", ",", " ", "observable"}], ")"}], ".", " ", "The"}], 
    " ", "0.33", " ", "value", " ", "is", " ", "empirically", " ", "adjusted",
     " ", "to", " ", "minimize", " ", "noise", " ", "in", " ", 
    RowBox[{"graphene", "'"}], "s", " ", "\[Sigma]xx"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"BuildSmoothDensity", "[", 
     RowBox[{"data_", ",", " ", "radius_"}], "]"}], ":=", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"nf", "=", 
         RowBox[{"Nearest", "[", 
          RowBox[{"Thread", "[", 
           RowBox[{
            RowBox[{"data", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}], "\[Rule]", "data"}], 
           "]"}], "]"}]}], ",", " ", 
        RowBox[{"\[Sigma]", "=", 
         RowBox[{".33", "radius"}]}], ",", " ", 
        RowBox[{"zero", "=", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"NumericQ", "[", 
            RowBox[{"data", "[", 
             RowBox[{"[", 
              RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}], ",", "0", ",", 
           " ", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", 
             RowBox[{"Length", "[", 
              RowBox[{"data", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}]}], "]"}]}], 
          "]"}]}]}], "}"}], ",", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", "\[Omega]", "}"}], ",", 
        RowBox[{"zero", "+", 
         RowBox[{"Total", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], 
             FractionBox[
              SuperscriptBox["\[ExponentialE]", 
               RowBox[{
                FractionBox[
                 RowBox[{"-", "1"}], "2"], 
                SuperscriptBox[
                 RowBox[{"(", 
                  FractionBox[
                   RowBox[{"\[Omega]", "-", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "\[Sigma]"], ")"}], 
                 "2"]}]], 
              RowBox[{
               SqrtBox[
                RowBox[{"2", "\[Pi]"}]], "\[Sigma]"}]]}], "&"}], "/@", 
           RowBox[{"nf", "[", 
            RowBox[{"\[Omega]", ",", 
             RowBox[{"{", 
              RowBox[{"All", ",", "radius"}], "}"}]}], "]"}]}], "]"}]}]}], 
       "]"}]}], "]"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "LinearResponseIm", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"KBT", "\[Rule]", "0"}], ",", " ", 
       RowBox[{"ChemicalPotential", "\[Rule]", "0"}], ",", 
       RowBox[{"Broadening", "\[Rule]", "0.1"}], ",", " ", 
       RowBox[{"Verbose", "\[Rule]", "False"}]}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"LinearResponseIm", "[", 
       RowBox[{"bstruct_MQBandstructure", ",", " ", 
        RowBox[{"opts", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
      RowBox[{"LinearResponseIm", "[", 
       RowBox[{"bstruct", ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "1"}], "}"}], ",", "opts"}], "]"}]}], ";"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"LinearResponseIm", "::", "noops"}], "=", 
     "\"\<No correlation operators are contained in the provided \
MQBandstructure. Provide Operators->{__MQSystem} to \
BuildBandstructure.\>\""}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"LinearResponseIm", "[", 
     RowBox[{"bstruct_MQBandstructure", ",", "Op1_MQSystem", ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"LinearResponseIm", "[", 
     RowBox[{"bstruct", ",", 
      RowBox[{"{", 
       RowBox[{"Op1", ",", "Op1"}], "}"}], ",", " ", "opts"}], "]"}]}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"LinearResponseIm", "[", 
     RowBox[{"bstruct_MQBandstructure", ",", 
      RowBox[{"{", "Op1_MQSystem", "}"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"LinearResponseIm", "[", 
     RowBox[{"bstruct", ",", 
      RowBox[{"{", 
       RowBox[{"Op1", ",", "Op1"}], "}"}], ",", " ", "opts"}], "]"}]}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"LinearResponseIm", "[", 
      RowBox[{"bstruct_MQBandstructure", ",", 
       RowBox[{"{", 
        RowBox[{"Op1_MQSystem", ",", "Op2_MQSystem"}], "}"}], ",", " ", 
       RowBox[{"opts", ":", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\[Sigma]", "=", 
          RowBox[{"OptionValue", "[", "Broadening", "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Mu]", "=", 
          RowBox[{"OptionValue", "@", "ChemicalPotential"}]}], ",", 
         RowBox[{"KT", "=", 
          RowBox[{"OptionValue", "@", "KBT"}]}], ",", "\[IndentingNewLine]", 
         "z", ",", "\[IndentingNewLine]", 
         RowBox[{"latdim", "=", 
          RowBox[{"bstruct", "[", "\"\<LatticeDimensions\>\"", "]"}]}], ",", 
         RowBox[{"numkpoints", "=", 
          RowBox[{"bstruct", "[", "\"\<NumberOfPoints\>\"", "]"}]}], ",", " ",
          "\[IndentingNewLine]", 
         RowBox[{"detA", "=", 
          RowBox[{"bstruct", "[", "\"\<UnitCellArea\>\"", "]"}]}], ",", 
         "\[IndentingNewLine]", "aux", ",", "aux2", ",", 
         "\[IndentingNewLine]", "nFermi", ",", "data"}], "}"}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"KT", "\[Equal]", "0"}], ",", "\[IndentingNewLine]", 
          RowBox[{"nFermi", "=", 
           RowBox[{"Compile", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"{", 
               RowBox[{"\[Epsilon]", ",", "_Real"}], "}"}], "}"}], ",", 
             RowBox[{"UnitStep", "[", 
              RowBox[{"\[Mu]", "-", "\[Epsilon]"}], "]"}], ",", 
             RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", " ", 
             
             RowBox[{"Parallelization", "\[Rule]", "True"}]}], "]"}]}], ",", 
          RowBox[{"nFermi", "=", 
           RowBox[{"Compile", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"{", 
               RowBox[{"\[Epsilon]", ",", "_Real"}], "}"}], "}"}], ",", 
             FractionBox["1", 
              RowBox[{
               SuperscriptBox["\[ExponentialE]", 
                RowBox[{"\[Epsilon]", "/", "KT"}]], "+", "1"}]], ",", 
             RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
             RowBox[{"Parallelization", "\[Rule]", "True"}]}], "]"}]}]}], 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "We", " ", "implicity", " ", "drop", " ", "imaginary", " ", "parts", 
          " ", "here"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"aux", "[", 
          RowBox[{"{", 
           RowBox[{"z_", ",", "\[Epsilon]_List", ",", "evecs_List"}], "}"}], 
          "]"}], ":=", 
         RowBox[{
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\[Epsilon]", "[", 
               RowBox[{"[", 
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "1", ",", "1"}], "]"}], "]"}], "]"}], 
               "]"}], ",", 
              RowBox[{"\[Epsilon]", "[", 
               RowBox[{"[", 
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "1", ",", "2"}], "]"}], "]"}], "]"}], 
               "]"}], ",", 
              RowBox[{"Re", "[", 
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "}"}], 
            "]"}], "&"}], "@", 
          RowBox[{"Most", "@", 
           RowBox[{"ArrayRules", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"#", "\[Conjugate]"}], ".", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Op1", "[", "z", "]"}], "[", "\"\<Flat\>\"", 
                    "]"}], "[", "\"\<H\>\"", "]"}], ".", 
                  RowBox[{"#", "\[Transpose]"}]}], ")"}], "\[Transpose]"}], 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"#", "\[Conjugate]"}], ".", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Op2", "[", "z", "]"}], "[", "\"\<Flat\>\"", "]"}],
                   "[", "\"\<H\>\"", "]"}], ".", 
                 RowBox[{"#", "\[Transpose]"}]}], ")"}]}], "&"}], "[", 
             "evecs", "]"}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"aux2", "=", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"nk", "=", "numkpoints"}], ",", " ", 
             RowBox[{"nF", "=", "nFermi"}], ",", " ", 
             RowBox[{"area", "=", "detA"}]}], "}"}], ",", 
           RowBox[{"Compile", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"{", 
               RowBox[{"vec", ",", "_Real", ",", "2"}], "}"}], "}"}], ",", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"vec", "[", 
                   RowBox[{"[", 
                    RowBox[{"k", ",", "2"}], "]"}], "]"}], "-", 
                  RowBox[{"vec", "[", 
                   RowBox[{"[", 
                    RowBox[{"k", ",", "1"}], "]"}], "]"}]}], ",", 
                 RowBox[{
                  FractionBox["\[Pi]", 
                   RowBox[{"area", " ", "nk", " "}]], 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"nF", "[", 
                    RowBox[{"vec", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "1"}], "]"}], "]"}], "]"}], "-", 
                    RowBox[{"nF", "[", 
                    RowBox[{"vec", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "2"}], "]"}], "]"}], "]"}]}], ")"}], 
                  RowBox[{"vec", "[", 
                   RowBox[{"[", 
                    RowBox[{"k", ",", "3"}], "]"}], "]"}]}]}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"k", ",", "1", ",", 
                 RowBox[{"Length", "@", "vec"}]}], "}"}]}], "]"}], ",", 
             RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
             RowBox[{"Parallelization", "\[Rule]", "True"}]}], "]"}]}], 
          "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"data", "=", 
         RowBox[{"MapAt", "[", 
          RowBox[{"Flatten", ",", 
           RowBox[{"bstruct", "[", "\"\<BandData\>\"", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"All", ",", "3", ",", "All"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"data", "=", 
         RowBox[{"Join", "@@", 
          RowBox[{"(", 
           RowBox[{"Map", "[", 
            RowBox[{"aux", ",", "data"}], "]"}], ")"}]}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"data", "=", 
         RowBox[{"aux2", "[", "data", "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"data", "=", 
         RowBox[{"Sort", "@", "data"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"data", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
             RowBox[{"Chop", "@", 
              RowBox[{"Total", "[", 
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}]}], "}"}], 
           "&"}], "/@", 
          RowBox[{"Split", "[", 
           RowBox[{"data", ",", 
            RowBox[{
             RowBox[{
              RowBox[{"#1", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
              RowBox[{"#2", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], "&"}]}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"data", "=", 
         RowBox[{"DeleteCases", "[", 
          RowBox[{"data", ",", 
           RowBox[{"{", 
            RowBox[{"_", ",", "0"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"BuildWeightedDistribution", "[", 
          RowBox[{"data", ",", 
           RowBox[{"OptionValue", "@", "Broadening"}]}], "]"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"BuildSmoothDensity", "[", 
         RowBox[{"data", ",", 
          RowBox[{"OptionValue", "@", "Broadening"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Optimized", " ", "version"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"LinearResponseIm", "[", 
     RowBox[{"bstruct_MQBandstructure", ",", 
      RowBox[{"{", 
       RowBox[{"Op1_MQSystem", ",", "Op2_MQSystem"}], "}"}], ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Sigma]", "=", 
         RowBox[{"OptionValue", "[", "Broadening", "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Mu]", "=", 
         RowBox[{"OptionValue", "@", "ChemicalPotential"}]}], ",", 
        RowBox[{"KT", "=", 
         RowBox[{"OptionValue", "@", "KBT"}]}], ",", "\[IndentingNewLine]", 
        "z", ",", "zvals", ",", "$nz", ",", "h1", ",", "h2", ",", 
        "\[Epsilon]", ",", "evals", ",", "evecs", ",", "\[IndentingNewLine]", 
        
        RowBox[{"latdim", "=", 
         RowBox[{"bstruct", "[", "\"\<LatticeDimensions\>\"", "]"}]}], ",", 
        RowBox[{"numkpoints", "=", 
         RowBox[{"bstruct", "[", "\"\<NumberOfPoints\>\"", "]"}]}], ",", " ", 
        "\[IndentingNewLine]", 
        RowBox[{"detA", "=", 
         RowBox[{"bstruct", "[", "\"\<UnitCellArea\>\"", "]"}]}], ",", 
        "\[IndentingNewLine]", "aux", ",", "aux2", ",", "\[IndentingNewLine]",
         "nFermi", ",", "data", ",", "\[IndentingNewLine]", 
        RowBox[{"verbose", "=", 
         RowBox[{"OptionValue", "@", "Verbose"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"SetSystemOptions", "[", 
        RowBox[{"\"\<PackedArrayOptions\>\"", "\[Rule]", 
         RowBox[{"\"\<UnpackMessage\>\"", "\[Rule]", "True"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{"verbose", ",", 
         RowBox[{
         "PrintTemporary", "[", "\"\<Compiling system...\>\"", "]"}]}], "]"}],
        ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"KT", "\[Equal]", "0"}], ",", "\[IndentingNewLine]", 
         RowBox[{"nFermi", "=", 
          RowBox[{"Compile", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"{", 
              RowBox[{"\[Epsilon]", ",", "_Real"}], "}"}], "}"}], ",", 
            RowBox[{"UnitStep", "[", 
             RowBox[{"\[Mu]", "-", "\[Epsilon]"}], "]"}], ",", 
            RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", " ", 
            RowBox[{"Parallelization", "\[Rule]", "True"}]}], "]"}]}], ",", 
         RowBox[{"nFermi", "=", 
          RowBox[{"Compile", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"{", 
              RowBox[{"\[Epsilon]", ",", "_Real"}], "}"}], "}"}], ",", 
            FractionBox["1", 
             RowBox[{
              SuperscriptBox["\[ExponentialE]", 
               RowBox[{"\[Epsilon]", "/", "KT"}]], "+", "1"}]], ",", 
            RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
            RowBox[{"Parallelization", "\[Rule]", "True"}]}], "]"}]}]}], 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"zvals", "=", 
        RowBox[{"ToExpression", "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"\"\<$nz\>\"", "<>", 
             RowBox[{"ToString", "[", "#", "]"}]}], "&"}], "/@", 
           RowBox[{"Range", "[", "latdim", "]"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "We", " ", "explicity", " ", "drop", " ", "imaginary", " ", "parts", 
         " ", "here"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"aux", "=", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"H1", "=", 
             RowBox[{"Normal", "@", 
              RowBox[{
               RowBox[{
                RowBox[{"Op1", "[", "zvals", "]"}], "[", "\"\<Flat\>\"", 
                "]"}], "[", "\"\<H\>\"", "]"}]}]}], ",", " ", 
            RowBox[{"H2", "=", 
             RowBox[{"Normal", "@", 
              RowBox[{
               RowBox[{
                RowBox[{"Op2", "[", "zvals", "]"}], "[", "\"\<Flat\>\"", 
                "]"}], "[", "\"\<H\>\"", "]"}]}]}], ",", " ", 
            RowBox[{"Z", "=", "zvals"}], ",", " ", 
            RowBox[{"args", "=", 
             RowBox[{"Join", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"#", ",", "_Real"}], "}"}], "&"}], "/@", "zvals"}], 
               ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"\[Epsilon]", ",", "_Real", ",", "1"}], "}"}], ",", 
                 
                 RowBox[{"{", 
                  RowBox[{"evecs", ",", "_Complex", ",", "2"}], "}"}]}], 
                "}"}]}], "]"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
          RowBox[{"Compile", "[", 
           RowBox[{
            RowBox[{"Evaluate", "[", "args", "]"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"Chop", "@", 
             RowBox[{"Re", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"evecs", "\[Conjugate]"}], ".", "H1", ".", 
                  RowBox[{"evecs", "\[Transpose]"}]}], ")"}], 
                "\[Transpose]"}], 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"evecs", "\[Conjugate]"}], ".", "H2", ".", 
                 RowBox[{"evecs", "\[Transpose]"}]}], ")"}]}], "]"}]}], ",", 
            RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
            RowBox[{"Parallelization", "\[Rule]", "True"}]}], "]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"aux2", "=", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"nk", "=", "numkpoints"}], ",", " ", 
            RowBox[{"nF", "=", "nFermi"}], ",", " ", 
            RowBox[{"area", "=", "detA"}]}], "}"}], ",", 
          RowBox[{"Compile", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"{", 
              RowBox[{"vec", ",", "_Real", ",", "2"}], "}"}], "}"}], ",", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"vec", "[", 
                  RowBox[{"[", 
                   RowBox[{"k", ",", "2"}], "]"}], "]"}], "-", 
                 RowBox[{"vec", "[", 
                  RowBox[{"[", 
                   RowBox[{"k", ",", "1"}], "]"}], "]"}]}], ",", 
                RowBox[{
                 FractionBox["\[Pi]", 
                  RowBox[{"area", " ", "nk", " "}]], 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"nF", "[", 
                    RowBox[{"vec", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "1"}], "]"}], "]"}], "]"}], "-", 
                   RowBox[{"nF", "[", 
                    RowBox[{"vec", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "2"}], "]"}], "]"}], "]"}]}], ")"}], 
                 RowBox[{"vec", "[", 
                  RowBox[{"[", 
                   RowBox[{"k", ",", "3"}], "]"}], "]"}]}]}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"k", ",", "1", ",", 
                RowBox[{"Length", "@", "vec"}]}], "}"}]}], "]"}], ",", 
            RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
            RowBox[{"Parallelization", "\[Rule]", "True"}]}], "]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{"verbose", ",", 
         RowBox[{"PrintTemporary", "[", "\"\<Done\>\"", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{"verbose", ",", 
         RowBox[{"PrintTemporary", "[", "\"\<Stage 1/4\>\"", "]"}]}], "]"}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "We", " ", "first", " ", "flatten", " ", "the", " ", "input", " ", 
         "to", " ", "accomodate", " ", "to", " ", "the", " ", "format", " ", 
         "of", " ", "compiled", " ", "aux", " ", 
         RowBox[{"function", ":", " ", 
          RowBox[{"{", 
           RowBox[{"z1", ",", " ", 
            RowBox[{"z2", "..."}], ",", " ", 
            RowBox[{"{", "\[Epsilon]__", "}"}], ",", " ", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", "evec__", "}"}], "__"}], "}"}]}], "}"}]}]}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"zvals", ",", "evals", ",", "evecs"}], "}"}], "=", 
        RowBox[{
         RowBox[{"bstruct", "[", "\"\<BandData\>\"", "]"}], 
         "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"evecs", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"evecs", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", "1", "}"}], ",", 
            RowBox[{"{", "2", "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"FlattenAt", "[", 
           RowBox[{"#", ",", "1"}], "]"}], "&"}], "/@", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"zvals", ",", "evals", ",", "evecs"}], "}"}], "]"}]}]}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{"verbose", ",", 
         RowBox[{"PrintTemporary", "[", "\"\<Stage 2/4\>\"", "]"}]}], "]"}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "We", " ", "then", " ", "compute", " ", "the", " ", "matrix", " ", 
         "elements", " ", "with", " ", "Op1", " ", "and", " ", "Op2", " ", 
         "at", " ", "each", " ", "momentum"}], "*)"}], "\[IndentingNewLine]", 
       
       RowBox[{"data", "=", 
        RowBox[{"aux", "@@@", "data"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{"verbose", ",", 
         RowBox[{"PrintTemporary", "[", "\"\<Stage 3/4\>\"", "]"}]}], "]"}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "We", " ", "transform", " ", "the", " ", "ArrayRules", " ", "to", " ",
          "get", " ", "pairs", " ", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\[Epsilon]i", ",", " ", "\[Epsilon]j", ",", 
            RowBox[{"O1_ij", " ", "O2_ji"}]}], "}"}], "."}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"Join", "@@", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{"Function", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[Epsilon]", ",", "mat"}], "}"}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"Transpose", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"\[Epsilon]", "[", 
                   RowBox[{"[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "1", ",", "1"}], "]"}], "]"}], "]"}], 
                   "]"}], ",", 
                  RowBox[{"\[Epsilon]", "[", 
                   RowBox[{"[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "1", ",", "2"}], "]"}], "]"}], "]"}], 
                   "]"}], ",", 
                  RowBox[{"#", "[", 
                   RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "}"}], "]"}], 
               "&"}], "@", 
              RowBox[{"Most", "[", 
               RowBox[{"ArrayRules", "[", "mat", "]"}], "]"}]}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"evals", ",", "data"}], "}"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{"verbose", ",", 
         RowBox[{"PrintTemporary", "[", "\"\<Stage 4/4\>\"", "]"}]}], "]"}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"We", " ", "apply", " ", "Kubo", " ", "formula"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"aux2", "[", "data", "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"Sort", "@", "data"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"aux", "=", 
        RowBox[{"Compile", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"x", ",", "_Real", ",", "1"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"y", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
          RowBox[{
           RowBox[{"x", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
           RowBox[{"y", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"aux2", "=", 
        RowBox[{"Compile", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"{", 
            RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x", "[", 
             RowBox[{"[", 
              RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
            RowBox[{"Chop", "[", 
             RowBox[{"Total", "[", 
              RowBox[{"x", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], 
           "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"data", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"Chop", "@", 
               RowBox[{"Total", "[", 
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}]}], "}"}], 
            "&"}], "/@", 
           RowBox[{"Split", "[", 
            RowBox[{"data", ",", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{
                RowBox[{"#1", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
                RowBox[{"#2", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "&"}], "*)"}], "aux"}], 
            "]"}]}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"aux2", "/@", 
         RowBox[{"Split", "[", 
          RowBox[{"data", ",", "aux"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"DeleteCases", "[", 
         RowBox[{"data", ",", 
          RowBox[{"{", 
           RowBox[{"_", ",", "0.0"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"aux", "=", 
          RowBox[{"Compile", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"x", ",", "_Real", ",", "1"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"y", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
            RowBox[{
             RowBox[{"x", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
             RowBox[{"y", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"data", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"Chop", "@", 
               RowBox[{"Total", "[", 
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}]}], "}"}], 
            "&"}], "/@", 
           RowBox[{"Split", "[", 
            RowBox[{"data", ",", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{
                RowBox[{"#1", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
                RowBox[{"#2", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "&"}], "*)"}], "aux"}], 
            "]"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"temp2", "=", 
          RowBox[{"data", "=", 
           RowBox[{"Developer`ToPackedArray", "/@", 
            RowBox[{"DeleteCases", "[", 
             RowBox[{"data", ",", 
              RowBox[{"{", 
               RowBox[{"_", ",", "0"}], "}"}]}], "]"}]}]}]}], ";"}], "*)"}], 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"aux", "=", 
          RowBox[{"Compile", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"{", 
              RowBox[{"dat", ",", "_Real", ",", "2"}], "}"}], "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"With", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"precision", "=", 
                SuperscriptBox["10.", 
                 RowBox[{"-", "13"}]]}], "}"}], ",", "\[IndentingNewLine]", 
              RowBox[{"Block", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"output", "=", 
                  RowBox[{"dat", "[", 
                   RowBox[{"[", 
                    RowBox[{"{", "1", "}"}], "]"}], "]"}]}], "}"}], ",", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"Do", "[", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Chop", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"dat", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}], "-", 
                    RowBox[{"output", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"-", "1"}], ",", "1"}], "]"}], "]"}]}], ",", " ", 
                    "precision"}], "]"}], "==", "0"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"output", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"-", "1"}], ",", "2"}], "]"}], "]"}], "+=", 
                    RowBox[{"dat", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Chop", "[", 
                    RowBox[{
                    RowBox[{"output", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"-", "1"}], ",", "2"}], "]"}], "]"}], ",", 
                    "precision"}], "]"}], "\[Equal]", "0"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"output", "[", 
                    RowBox[{"[", 
                    RowBox[{"-", "1"}], "]"}], "]"}], "=", 
                    RowBox[{"dat", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"AppendTo", "[", 
                    RowBox[{"output", ",", 
                    RowBox[{"dat", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], "]"}]}], "]"}]}], "]"}],
                    ",", 
                   RowBox[{"{", 
                    RowBox[{"i", ",", "2", ",", 
                    RowBox[{"Length", "[", "dat", "]"}]}], "}"}]}], "]"}], 
                 ";", "\[IndentingNewLine]", 
                 RowBox[{"Return", "[", "output", "]"}]}]}], 
               "\[IndentingNewLine]", "]"}]}], "]"}], ",", " ", 
            RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", " ", 
            RowBox[{"Parallelization", "\[Rule]", "True"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"data", "=", 
          RowBox[{"aux", "[", "data", "]"}]}], ";"}], "*)"}], 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "We", " ", "build", " ", "a", " ", "smooth", " ", "density", " ", 
         "out", " ", "of", " ", "the", " ", "data"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"BuildSmoothDensity", "[", 
        RowBox[{"data", ",", 
         RowBox[{"OptionValue", "@", "Broadening"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "OpticalConductivity", "]"}], "=", 
     RowBox[{"Options", "[", "LinearResponseIm", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"OpticalConductivity", "[", 
     RowBox[{"bstruct_MQBandstructure", ",", "Ops_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"lr", "=", 
        RowBox[{"LinearResponseIm", "[", 
         RowBox[{"bstruct", ",", "Ops", ",", "opts"}], "]"}]}], "}"}], ",", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", "\[Omega]", "}"}], ",", 
        RowBox[{
         FractionBox[
          RowBox[{"2", "\[Pi]"}], "\[Omega]"], " ", 
         RowBox[{"lr", "[", "\[Omega]", "]"}]}]}], "]"}]}], "]"}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"SiteObservable", "::", "usage"}], "=", 
     "\"\<Option for various functions that specifies an operator defined \
within a system site, such as e.g. \!\(\*SubscriptBox[\(\[Sigma]\), \(z\)]\).\
\>\""}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "LocalDensityOfStates", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Broadening", "\[Rule]", "1"}], ",", " ", 
       RowBox[{"SiteObservable", "\[Rule]", "Automatic"}]}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"LocalDensityOfStates", "[", 
      RowBox[{"bstruct_MQBandstructure", ",", " ", 
       RowBox[{"opts", ":", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "data", ",", "evecs", ",", " ", "evals", ",", " ", "obs", ",", " ", 
         "obsF"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Dimensions", "@", 
            RowBox[{"OptionValue", "@", "SiteObservable"}]}], "\[Equal]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], 
            RowBox[{"bstruct", "[", "\"\<SiteDimensions\>\"", "]"}]}]}], ",", 
          
          RowBox[{"obs", "=", 
           RowBox[{"OptionValue", "@", "SiteObservable"}]}], ",", 
          RowBox[{"obs", "=", 
           RowBox[{"IdentityMatrix", "[", 
            RowBox[{"bstruct", "[", "\"\<SiteDimensions\>\"", "]"}], 
            "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"o", "=", "obs"}], "}"}], ",", "\[IndentingNewLine]", 
          RowBox[{"obsF", "=", 
           RowBox[{"Compile", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"{", 
               RowBox[{"evecs", ",", "_Complex", ",", "3"}], "}"}], "}"}], 
             ",", 
             RowBox[{"Map", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"#", "\[Conjugate]"}], ".", "o", ".", "#"}], "&"}], 
               ",", "evecs", ",", 
               RowBox[{"{", "2", "}"}]}], "]"}], ",", 
             RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
             RowBox[{"Parallelization", "\[Rule]", "True"}]}], "]"}]}]}], 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"evals", ",", " ", "evecs"}], "}"}], "=", 
         RowBox[{"Transpose", "@", 
          RowBox[{"Flatten", "[", 
           RowBox[{
            RowBox[{"Transpose", "/@", 
             RowBox[{
              RowBox[{"bstruct", "[", "\"\<BandData\>\"", "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", 
                RowBox[{"2", ";;", "3"}]}], "]"}], "]"}]}], ",", "1"}], 
           "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"evecs", "=", 
         RowBox[{"obsF", "[", "evecs", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"BuildSmoothDensity", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"evals", ",", " ", "evecs"}], "}"}], "\[Transpose]"}], 
          ",", 
          RowBox[{"OptionValue", "@", "Broadening"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"evecs", "=", 
         RowBox[{"ParallelMap", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Chop", "[", 
             RowBox[{
              RowBox[{"#", "\[Conjugate]"}], ".", "obs", ".", "#"}], "]"}], 
            "&"}], ",", "evecs", ",", " ", 
           RowBox[{"{", "2", "}"}]}], "]"}]}], ";"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"data", "=", 
         RowBox[{"MapAt", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Chop", "[", 
             RowBox[{
              RowBox[{"#", "\[Conjugate]"}], ".", "obs", ".", "#"}], "]"}], 
            "&"}], ",", "data", ",", 
           RowBox[{"{", 
            RowBox[{"All", ",", "2", ",", "All"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"BuildSmoothDensity", "[", 
         RowBox[{"data", ",", 
          RowBox[{"OptionValue", "@", "Broadening"}]}], "]"}]}], "*)"}], 
      "]"}]}], ";"}], "\[IndentingNewLine]"}]}]], "Input",
 CellChangeTimes->{{3.665917137450635*^9, 3.665917183808755*^9}, {
   3.665917215823503*^9, 3.665917259949376*^9}, {3.665917299444006*^9, 
   3.66591730001976*^9}, {3.665917400878497*^9, 3.665917401438346*^9}, {
   3.665917498706744*^9, 3.665917516681594*^9}, {3.665917775060466*^9, 
   3.665917818883531*^9}, {3.665917985370185*^9, 3.665917990353322*^9}, {
   3.665918510008952*^9, 3.665918510538433*^9}, {3.6659185863489428`*^9, 
   3.665918653852808*^9}, {3.665918726679057*^9, 3.665918732582183*^9}, {
   3.665918763549059*^9, 3.665918771651935*^9}, {3.665918818266968*^9, 
   3.6659188466164083`*^9}, {3.665918919068609*^9, 3.665918919621324*^9}, {
   3.6659189753831053`*^9, 3.665919013224299*^9}, {3.665919096029221*^9, 
   3.665919169713995*^9}, {3.6659192315506763`*^9, 3.6659193452104597`*^9}, {
   3.665919378160131*^9, 3.6659194630027533`*^9}, {3.6659194975851717`*^9, 
   3.665919675802203*^9}, {3.6659197098292*^9, 3.665919718151422*^9}, {
   3.6659198135298233`*^9, 3.665919818666852*^9}, {3.665920164322505*^9, 
   3.665920167370479*^9}, {3.6659202812847557`*^9, 3.665920290572618*^9}, {
   3.665921293811623*^9, 3.665921379151849*^9}, {3.66592154783235*^9, 
   3.665921551071207*^9}, {3.665941311952281*^9, 3.665941385962438*^9}, {
   3.6659416079341927`*^9, 3.6659417465692244`*^9}, {3.665941796655871*^9, 
   3.6659419840339537`*^9}, {3.665942035728207*^9, 3.6659421013484364`*^9}, {
   3.665942171120268*^9, 3.665942175636088*^9}, {3.665942213324032*^9, 
   3.6659422505220346`*^9}, {3.665942295908972*^9, 3.6659423081727333`*^9}, 
   3.665942395439097*^9, {3.665981891202032*^9, 3.6659819564111357`*^9}, {
   3.665982000475602*^9, 3.665982002449149*^9}, {3.665984500458523*^9, 
   3.6659845364073553`*^9}, {3.6659846854725237`*^9, 
   3.6659846999759903`*^9}, {3.6659847439341927`*^9, 
   3.6659848557592087`*^9}, {3.665984896504984*^9, 3.665984939714962*^9}, {
   3.665985051071003*^9, 3.665985052272786*^9}, {3.665985087014615*^9, 
   3.6659850891727457`*^9}, {3.665985165503848*^9, 3.665985191790038*^9}, {
   3.665985253932353*^9, 3.665985371261715*^9}, {3.665985404350731*^9, 
   3.665985415475217*^9}, {3.665985447356944*^9, 3.665985511438574*^9}, {
   3.665985660014229*^9, 3.6659856993416567`*^9}, {3.66598574690765*^9, 
   3.665985761230123*^9}, {3.665985799824979*^9, 3.665985873896744*^9}, {
   3.665985905795628*^9, 3.665985918970584*^9}, {3.6659859890179996`*^9, 
   3.665985994292088*^9}, {3.665986063315729*^9, 3.665986113036745*^9}, {
   3.665986149240288*^9, 3.6659862899204683`*^9}, 3.665986352374523*^9, 
   3.6659863893238497`*^9, {3.66598648579959*^9, 3.6659865450352488`*^9}, {
   3.6659866400727177`*^9, 3.6659866480689383`*^9}, {3.665987377754258*^9, 
   3.6659873786095953`*^9}, 3.665987435898066*^9, {3.6659874703335247`*^9, 
   3.665987471948728*^9}, {3.665987514276432*^9, 3.665987522611281*^9}, {
   3.665987639430195*^9, 3.665987652107861*^9}, {3.665987852683928*^9, 
   3.66598788728314*^9}, {3.665987933949502*^9, 3.665987942445517*^9}, {
   3.665987972702703*^9, 3.665988013229781*^9}, 3.665988058250471*^9, {
   3.6659881739726048`*^9, 3.665988185441968*^9}, {3.665988250039914*^9, 
   3.665988348306225*^9}, {3.665988387577944*^9, 3.665988642395759*^9}, {
   3.665988683930818*^9, 3.665988801051654*^9}, {3.665989017570899*^9, 
   3.665989020513577*^9}, {3.665989079862321*^9, 3.665989127629287*^9}, {
   3.66598915859197*^9, 3.6659894306216087`*^9}, {3.66598949707586*^9, 
   3.665989513657672*^9}, {3.66598960107025*^9, 3.665989723728169*^9}, {
   3.6659897961817636`*^9, 3.6659898219464073`*^9}, {3.666336698990041*^9, 
   3.666336699908449*^9}, {3.666594143825362*^9, 3.666594159567865*^9}, 
   3.6665951900042963`*^9, {3.666595310879632*^9, 3.666595311678956*^9}, {
   3.666595355881854*^9, 3.666595358157291*^9}, 3.666595392741806*^9, {
   3.666595470634261*^9, 3.666595472801071*^9}, 3.666595577420985*^9, 
   3.666595655008758*^9, 3.66659568864081*^9, {3.6665968204874573`*^9, 
   3.666596825366865*^9}, {3.666597379972227*^9, 3.666597398587418*^9}, {
   3.6665974366112013`*^9, 3.6665974550910597`*^9}, {3.666597504398509*^9, 
   3.666597505933721*^9}, {3.666598824209663*^9, 3.666598829487393*^9}, {
   3.666790065569257*^9, 3.6667900655764647`*^9}, {3.6667902419223413`*^9, 
   3.666790263409778*^9}, 3.666790341282661*^9, {3.666790438976499*^9, 
   3.666790516566626*^9}, {3.666790631869227*^9, 3.666790666083893*^9}, {
   3.6667919734344*^9, 3.666792028707658*^9}, {3.666792083549529*^9, 
   3.6667920851886683`*^9}, {3.666792119023978*^9, 3.666792223077608*^9}, {
   3.6667922532770157`*^9, 3.6667923419246397`*^9}, {3.6667923861351013`*^9, 
   3.666792398151219*^9}, {3.666792604888623*^9, 3.66679305585693*^9}, {
   3.666793275333303*^9, 3.666793322882121*^9}, {3.666793355708899*^9, 
   3.666793359519761*^9}, {3.666793390163908*^9, 3.6667934169469748`*^9}, {
   3.666793450655959*^9, 3.666793454153356*^9}, {3.6667934961225033`*^9, 
   3.666793528813394*^9}, {3.6667935680693083`*^9, 3.666793578101165*^9}, {
   3.666793660085608*^9, 3.666793671094529*^9}, {3.666793705187977*^9, 
   3.666793917367008*^9}, {3.6667939750861073`*^9, 3.666793976458928*^9}, {
   3.666794040741173*^9, 3.6667940840815372`*^9}, {3.666794126151164*^9, 
   3.666794137387335*^9}, {3.666794190150887*^9, 3.6667942669500017`*^9}, {
   3.666794307304761*^9, 3.666794308553782*^9}, {3.666794343412126*^9, 
   3.666794346369379*^9}, {3.66679438803979*^9, 3.666794491716833*^9}, {
   3.6667945288953953`*^9, 3.666794529829858*^9}, {3.666794578563361*^9, 
   3.666794641737486*^9}, {3.666794712049995*^9, 3.666794836086829*^9}, {
   3.66679487445045*^9, 3.666794875972808*^9}, {3.6667949502699003`*^9, 
   3.666794979423684*^9}, {3.666795258672266*^9, 3.6667952606543713`*^9}, {
   3.666795497349099*^9, 3.6667955028474903`*^9}, {3.666796110992878*^9, 
   3.666796133737597*^9}, {3.6667966822826977`*^9, 3.6667966843860893`*^9}, {
   3.666796725666697*^9, 3.666796764904727*^9}, {3.6667970071092787`*^9, 
   3.6667970387600813`*^9}, {3.666797270491479*^9, 3.666797271714477*^9}, {
   3.6667976401282167`*^9, 3.666797664586171*^9}, {3.666797790295587*^9, 
   3.6667979609995937`*^9}, 3.666798000052656*^9, {3.666798067158699*^9, 
   3.666798075935848*^9}, {3.6667981149136047`*^9, 3.666798149647748*^9}, {
   3.6667981931726227`*^9, 3.666798198928719*^9}, {3.666847244599647*^9, 
   3.666847317973482*^9}, {3.666847895885927*^9, 3.666847899380398*^9}, {
   3.666847988571632*^9, 3.666847991049798*^9}, {3.666848042516514*^9, 
   3.666848085999148*^9}, {3.666850807303773*^9, 3.666850813126231*^9}, {
   3.666850869430285*^9, 3.666850889406314*^9}, {3.6668509353473682`*^9, 
   3.6668509435475616`*^9}, {3.666855761601512*^9, 3.666855777071937*^9}, {
   3.6668558160251637`*^9, 3.666855856260929*^9}, {3.66685591297834*^9, 
   3.6668559663918133`*^9}, {3.6668560056420717`*^9, 3.666856014726437*^9}, {
   3.666856088095841*^9, 3.666856088294744*^9}, {3.666884085178784*^9, 
   3.666884109382057*^9}, {3.66688475933916*^9, 3.6668847712815657`*^9}, {
   3.666884878503078*^9, 3.666884987850469*^9}, 3.666885555736865*^9, {
   3.6668858897730713`*^9, 3.6668859644818783`*^9}, {3.6668860208889847`*^9, 
   3.6668861968098717`*^9}, {3.6668862964879017`*^9, 
   3.6668862972943583`*^9}, {3.66688635391739*^9, 3.666886441546001*^9}, {
   3.66688650252034*^9, 3.666886584518483*^9}, {3.666886621621476*^9, 
   3.66688674187221*^9}, {3.6669379776006527`*^9, 3.666937982074795*^9}, 
   3.666938334962545*^9, 3.666953566278391*^9, 3.667027979195956*^9, {
   3.667031104952351*^9, 3.667031231583721*^9}, {3.667031271631462*^9, 
   3.667031348708005*^9}, {3.667031382290493*^9, 3.6670314008238688`*^9}, 
   3.667039327071508*^9, {3.667039410198197*^9, 3.667039422018059*^9}, {
   3.667039785494598*^9, 3.667039940492216*^9}, {3.667039975893271*^9, 
   3.667040040232519*^9}, {3.6671066959394836`*^9, 3.6671067113699217`*^9}, {
   3.6671080819017572`*^9, 3.667108110949012*^9}, 3.667108976072838*^9, {
   3.667109426232781*^9, 3.667109440750373*^9}, {3.667109491537212*^9, 
   3.667109544816248*^9}, {3.667109575627499*^9, 3.66710958164933*^9}, {
   3.667109616629115*^9, 3.667109695177932*^9}, {3.667109753017248*^9, 
   3.6671097680807323`*^9}, {3.667109798774925*^9, 3.667109800345642*^9}, {
   3.667109856669821*^9, 3.667109884670085*^9}, {3.667109976475545*^9, 
   3.667109977163495*^9}, {3.667110027460026*^9, 3.667110070616535*^9}, {
   3.667110139231731*^9, 3.667110144445599*^9}, {3.667111581961149*^9, 
   3.667111598271989*^9}, {3.667111651097349*^9, 3.6671116888082333`*^9}, {
   3.667111739408996*^9, 3.667111771945997*^9}, 3.667111805353157*^9, {
   3.6671118378051577`*^9, 3.6671118576580877`*^9}, {3.667111890163566*^9, 
   3.667111895753119*^9}, {3.667112319460724*^9, 3.66711236153091*^9}, 
   3.667112891844125*^9, {3.667112948905612*^9, 3.667112951917057*^9}, {
   3.6671129926603727`*^9, 3.667113007664118*^9}, {3.667113077216279*^9, 
   3.667113087169037*^9}, {3.667113136219619*^9, 3.6671131461011887`*^9}, {
   3.667113211764608*^9, 3.667113214810087*^9}, {3.667113314573976*^9, 
   3.667113341899197*^9}, {3.667113392418572*^9, 3.667113411843375*^9}, {
   3.667113497079824*^9, 3.6671135195162354`*^9}, {3.667113587962027*^9, 
   3.667113641180251*^9}, {3.6671136747741957`*^9, 3.66711375891856*^9}, {
   3.667113883778119*^9, 3.6671139479999313`*^9}, {3.6671139787515497`*^9, 
   3.667114000089138*^9}, 3.667114089273397*^9, {3.667114136863762*^9, 
   3.66711417309727*^9}, {3.66711424876904*^9, 3.6671142578359613`*^9}, 
   3.667114567282872*^9, {3.667114612649316*^9, 3.6671146389037523`*^9}, {
   3.6671148532787046`*^9, 3.6671148534540453`*^9}, {3.667114916305011*^9, 
   3.667114918249687*^9}, {3.6671149637143507`*^9, 3.667114963861631*^9}, {
   3.667115042484078*^9, 3.667115048051585*^9}, {3.667115142418436*^9, 
   3.667115142574626*^9}, 3.6671153441200314`*^9, {3.667115417745781*^9, 
   3.667115424042926*^9}, {3.667115464340721*^9, 3.667115496367065*^9}, {
   3.667115532436757*^9, 3.667115545581108*^9}, {3.667115616465267*^9, 
   3.667115617760376*^9}, {3.6671156791449747`*^9, 3.6671157931676064`*^9}, {
   3.6671158231847277`*^9, 3.667116016299806*^9}, {3.667116087429009*^9, 
   3.667116113716366*^9}, {3.667116167479782*^9, 3.667116510742703*^9}, {
   3.667116587212103*^9, 3.6671166214176598`*^9}, {3.667116665859797*^9, 
   3.667116674848852*^9}, {3.667116736344666*^9, 3.6671167443472223`*^9}, {
   3.667117832387463*^9, 3.667117833119535*^9}, 3.6821596271280727`*^9},
 CellLabel->
  "In[437]:=",ExpressionUUID->"3b3384d4-c8d6-47dc-8059-982b73b60dc0"],

Cell["One can do this type of adaptive-width functions", "Text",
 CellChangeTimes->{{3.6667976921696787`*^9, 
  3.666797705836678*^9}},ExpressionUUID->"ee7f7648-64d2-4117-a60b-\
25814f6f182c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"\[Sigma]r", "[", "r_", "]"}], "=", 
     RowBox[{"OpticalConductivity", "[", 
      RowBox[{"bs", ",", 
       RowBox[{
        RowBox[{"sys", "[", "\"\<Velocities\>\"", "]"}], "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"Broadening", "\[Rule]", "r"}]}], "]"}]}], ";", 
    "\[IndentingNewLine]", 
    RowBox[{"Plot", "[", 
     RowBox[{
      RowBox[{"2", " ", 
       RowBox[{
        RowBox[{"\[Sigma]r", "[", ".3", "]"}], "[", "\[Omega]", "]"}]}], ",", 
      
      RowBox[{"{", 
       RowBox[{"\[Omega]", ",", 
        RowBox[{"-", "10"}], ",", "10"}], "}"}], ",", " ", 
      RowBox[{"GridLines", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{"None", ",", 
         RowBox[{"{", 
          RowBox[{"\[Pi]", "/", "2"}], "}"}]}], "}"}]}], ",", " ", 
      RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "*)"}], 
  "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.6667976811439123`*^9, 3.66679772190985*^9}},
 CellLabel->
  "In[448]:=",ExpressionUUID->"142266a8-a43b-46e5-93fc-ed5d766922e3"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["Presets", "Section",
 CellChangeTimes->{{3.635240026834777*^9, 
  3.6352400286009703`*^9}},ExpressionUUID->"946cc172-4e33-4df3-af8f-\
6fe169d52c2c"],

Cell[CellGroupData[{

Cell["Auxiliary functions", "Subsubsection",
 CellChangeTimes->{{3.6355825559199953`*^9, 
  3.635582561863391*^9}},ExpressionUUID->"6863bd99-0d08-4655-a74e-\
1dfa79a79be2"],

Cell["\<\
General function to interpolate values in segments of given length (or at \
points of given position), with given smoothnesses\
\>", "Text",
 CellChangeTimes->{{3.635509417881427*^9, 
  3.635509449312558*^9}},ExpressionUUID->"3542947b-cb3c-4a7a-b30b-\
57f0be7bbc6a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", 
   RowBox[{"SmoothUnitStep", ",", "SmoothCurve"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Attributes", "[", "SmoothUnitStep", "]"}], "=", 
   RowBox[{"{", "Listable", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SmoothUnitStep", "[", 
     RowBox[{"0", ",", 
      RowBox[{"xmax_", "?", "NumericQ"}]}], "]"}], "[", "x_", "]"}], "=", 
   RowBox[{"UnitStep", "[", "x", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SmoothUnitStep", "[", 
     RowBox[{"0.", ",", 
      RowBox[{"xmax_", "?", "NumericQ"}]}], "]"}], "[", "x_", "]"}], "=", 
   RowBox[{"UnitStep", "[", "x", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"SmoothUnitStep", "[", 
      RowBox[{
       RowBox[{"d_", "/;", 
        RowBox[{
         RowBox[{"N", "[", "d", "]"}], "\[NotEqual]", "0."}]}], ",", 
       "xmax_"}], "]"}], "[", "x_", "]"}], "=", 
    RowBox[{"(", 
     RowBox[{
      FractionBox["1", "2"], "+", 
      RowBox[{
       FractionBox["1", "2"], 
       FractionBox[
        RowBox[{"Erf", "[", 
         RowBox[{"4", 
          FractionBox["x", "d"]}], "]"}], 
        RowBox[{"Erf", "[", 
         RowBox[{"4", 
          FractionBox["xmax", "d"]}], "]"}]]}]}], ")"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"SmoothCurve", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"x0_List", ",", "y_List", ",", "\[Delta]x_List"}], "}"}], "/;", 
      RowBox[{
       RowBox[{"Length", "@", "x0"}], "\[Equal]", 
       RowBox[{"Length", "@", "y"}], "\[Equal]", 
       RowBox[{"Length", "@", "\[Delta]x"}]}]}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"xM", "=", 
         RowBox[{"MovingAverage", "[", 
          RowBox[{"x0", ",", "2"}], "]"}]}], ",", "x"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", "x", "}"}], ",", 
          RowBox[{"Piecewise", "[", "#", "]"}]}], "]"}], "&"}], "@", 
       RowBox[{"Join", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"y", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", 
            RowBox[{"x", "<=", 
             RowBox[{"x0", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}]}], "}"}], "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"y", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "+", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"y", "[", 
                  RowBox[{"[", 
                   RowBox[{"i", "+", "1"}], "]"}], "]"}], "-", 
                 RowBox[{"y", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]}], ")"}], 
               RowBox[{
                RowBox[{"SmoothUnitStep", "[", 
                 RowBox[{
                  RowBox[{"\[Delta]x", "[", 
                   RowBox[{"[", "i", "]"}], "]"}], ",", 
                  RowBox[{
                   RowBox[{"x0", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", "+", "1"}], "]"}], "]"}], "-", 
                   RowBox[{"xM", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}]}], "]"}], "[", 
                RowBox[{"x", "-", 
                 RowBox[{"xM", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]}], "]"}]}]}], ",", 
             RowBox[{
              RowBox[{"x0", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "<", "x", "\[LessEqual]", 
              RowBox[{"x0", "[", 
               RowBox[{"[", 
                RowBox[{"i", "+", "1"}], "]"}], "]"}]}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "1", ",", 
             RowBox[{
              RowBox[{"Length", "@", "x0"}], "-", "1"}]}], "}"}]}], "]"}], 
         ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"y", "[", 
             RowBox[{"[", 
              RowBox[{"-", "1"}], "]"}], "]"}], ",", 
            RowBox[{"x", ">", 
             RowBox[{"x0", "[", 
              RowBox[{"[", 
               RowBox[{"-", "1"}], "]"}], "]"}]}]}], "}"}], "}"}]}], 
        "]"}]}]}], "]"}]}], "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SmoothCurve", "::", "params"}], "=", 
    "\"\<Wrong combination of parameters `1` for SmoothCurve\>\""}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{
     "For", " ", "conventional", " ", "case", " ", "in", " ", "which", " ", 
      RowBox[{"Length", "@", "y"}]}], "\[Equal]", 
     RowBox[{"Length", "@", "L"}]}], ",", " ", 
    RowBox[{
     RowBox[{"and", " ", "only", " ", "in"}], "-", 
     RowBox[{"between", " ", 
      RowBox[{"smoothnesses", " ", "[", 
       RowBox[{"closed", " ", "systems"}], "]"}]}]}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SmoothCurve", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"L_List", ",", "y_List", ",", "\[Delta]x_List"}], "}"}], "/;", 
     RowBox[{
      RowBox[{"Length", "@", "L"}], "\[Equal]", 
      RowBox[{"Length", "@", "y"}], "\[Equal]", 
      RowBox[{
       RowBox[{"Length", "@", "\[Delta]x"}], "+", "1"}]}]}], "]"}], ":=", 
   RowBox[{"SmoothCurve", "[", 
    RowBox[{"{", 
     RowBox[{"L", ",", 
      RowBox[{"Append", "[", 
       RowBox[{
        RowBox[{"Prepend", "[", 
         RowBox[{"y", ",", 
          RowBox[{"First", "@", "y"}]}], "]"}], ",", 
        RowBox[{"Last", "@", "y"}]}], "]"}], ",", 
      RowBox[{"Append", "[", 
       RowBox[{
        RowBox[{"Prepend", "[", 
         RowBox[{"\[Delta]x", ",", "0"}], "]"}], ",", "0"}], "]"}]}], "}"}], 
    "]"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"For", " ", "extended", " ", "case", " ", "in", " ", "which", " ", 
     RowBox[{"Length", "@", "y"}]}], "\[Equal]", 
    RowBox[{
     RowBox[{"Length", "@", "L"}], "+", 
     RowBox[{"2", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
        "asymptotic", " ", "values", " ", "and", " ", "contact", " ", 
         "smoothnesses", " ", "are", " ", "provided"}], ")"}], " ", "[", 
       RowBox[{"open", " ", "systems"}], "]"}]}]}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SmoothCurve", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"L_List", ",", "y_List", ",", "\[Delta]x_List"}], "}"}], "/;", 
     RowBox[{
      RowBox[{
       RowBox[{"Length", "@", "L"}], "+", "1"}], "\[Equal]", 
      RowBox[{
       RowBox[{"Length", "@", "y"}], "-", "1"}], "\[Equal]", 
      RowBox[{"Length", "@", "\[Delta]x"}]}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"xb", "=", 
        RowBox[{"Prepend", "[", 
         RowBox[{
          RowBox[{"Accumulate", "@", "L"}], ",", "0"}], "]"}]}], ",", " ", 
       "\[CapitalDelta]xb", ",", "pieces", ",", "x"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"xj", " ", "are", " ", "boundaries"}], ",", " ", 
       RowBox[{
        RowBox[{
        "\[CapitalDelta]xj", " ", "are", " ", "maximum", " ", "thickness", 
         " ", "of", " ", "boundaries"}], " ", "-", " ", 
        RowBox[{
        "shortest", " ", "L", " ", "at", " ", "either", " ", "side"}]}]}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[CapitalDelta]xb", "=", 
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Min", "[", 
           RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Append", "[", 
            RowBox[{"L", ",", "\[Infinity]"}], "]"}], ",", 
           RowBox[{"Prepend", "[", 
            RowBox[{"L", ",", "\[Infinity]"}], "]"}]}], "}"}]}], "]"}]}], ";",
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"pieces", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{"#", ",", "1"}], "]"}], "&"}], "@", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Join", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"y", "[", 
                 RowBox[{"[", "j", "]"}], "]"}], "+", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"y", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", "+", "1"}], "]"}], "]"}], "-", 
                   RowBox[{"y", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], ")"}], 
                 RowBox[{
                  RowBox[{"SmoothUnitStep", "[", 
                   RowBox[{
                    RowBox[{"\[Delta]x", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"\[CapitalDelta]xb", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "/", "2"}]}], "]"}], "[", 
                  
                  RowBox[{"x", "-", 
                   RowBox[{"xb", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}]}]}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"xb", "[", 
                  RowBox[{"[", "j", "]"}], "]"}], "-", 
                 RowBox[{
                  RowBox[{"\[CapitalDelta]xb", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "/", "2"}]}], "<=", "x", 
                "<", 
                RowBox[{
                 RowBox[{"xb", "[", 
                  RowBox[{"[", "j", "]"}], "]"}], "+", 
                 RowBox[{
                  RowBox[{"\[CapitalDelta]xb", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "/", "2"}]}]}]}], "}"}], 
             "}"}], ",", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"j", "<", 
                RowBox[{"Length", "@", "xb"}]}], "&&", 
               RowBox[{
                RowBox[{"\[CapitalDelta]xb", "[", 
                 RowBox[{"[", "j", "]"}], "]"}], "<=", 
                RowBox[{"L", "[", 
                 RowBox[{"[", "j", "]"}], "]"}]}]}], ",", 
              RowBox[{"{", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"y", "[", 
                  RowBox[{"[", 
                   RowBox[{"j", "+", "1"}], "]"}], "]"}], ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"xb", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "+", 
                   RowBox[{
                    RowBox[{"\[CapitalDelta]xb", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "/", "2"}]}], 
                  "\[LessEqual]", "x", "<", 
                  RowBox[{
                   RowBox[{"xb", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", "+", "1"}], "]"}], "]"}], "-", 
                   RowBox[{
                    RowBox[{"\[CapitalDelta]xb", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", "+", "1"}], "]"}], "]"}], "/", "2"}]}]}]}], 
                "}"}], "}"}], ",", 
              RowBox[{"{", "}"}]}], "]"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", 
            RowBox[{"Length", "@", "xb"}]}], "}"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", "x", "}"}], ",", 
          RowBox[{"Piecewise", "[", "#", "]"}]}], "]"}], "&"}], "@", 
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"y", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", 
            RowBox[{"x", "\[LessEqual]", 
             RowBox[{
              RowBox[{"xb", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "-", 
              RowBox[{
               RowBox[{"\[CapitalDelta]xb", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "/", "2"}]}]}]}], "}"}], 
          "}"}], ",", "pieces", ",", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"y", "[", 
             RowBox[{"[", 
              RowBox[{"-", "1"}], "]"}], "]"}], ",", 
            RowBox[{"x", ">", 
             RowBox[{
              RowBox[{"xb", "[", 
               RowBox[{"[", 
                RowBox[{"-", "1"}], "]"}], "]"}], "+", 
              RowBox[{
               RowBox[{"\[CapitalDelta]xb", "[", 
                RowBox[{"[", 
                 RowBox[{"-", "1"}], "]"}], "]"}], "/", "2"}]}]}]}], "}"}], 
          "}"}]}], "]"}]}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SmoothCurve", "[", "a__", "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"Message", "[", 
      RowBox[{
       RowBox[{"SmoothCurve", "::", "params"}], ",", "a"}], "]"}], ";", 
     "$Failed"}], ")"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.6355049413516197`*^9, 3.635505070348895*^9}, {
   3.6355051191504707`*^9, 3.6355051640218267`*^9}, {3.635505256680489*^9, 
   3.635505285885839*^9}, {3.635505463726181*^9, 3.635505463957054*^9}, {
   3.635505495596428*^9, 3.635505495884296*^9}, {3.6355055468348627`*^9, 
   3.6355055568465643`*^9}, 3.635505615908543*^9, {3.635505836889922*^9, 
   3.635505873363549*^9}, {3.635505941809943*^9, 3.635505968487509*^9}, {
   3.635506026194737*^9, 3.635506087503331*^9}, {3.635506147900449*^9, 
   3.6355062208200197`*^9}, {3.635507835066388*^9, 3.635507849256298*^9}, {
   3.6355087285820503`*^9, 3.635508752204492*^9}, {3.6355087894852667`*^9, 
   3.635508820417118*^9}, {3.6355089099777613`*^9, 3.635509166790941*^9}, 
   3.635509198118013*^9, {3.635509250543548*^9, 3.635509327554804*^9}, {
   3.635509371685203*^9, 3.635509374173313*^9}, {3.635509454793041*^9, 
   3.635509605195137*^9}, {3.63550965152122*^9, 3.6355096834655848`*^9}, {
   3.635509713878208*^9, 3.635509729860917*^9}, 3.635514946767167*^9, {
   3.635516287887039*^9, 3.635516300919832*^9}, {3.635517465962096*^9, 
   3.6355174661202602`*^9}, {3.6355176393769817`*^9, 
   3.6355176505085583`*^9}, {3.63551768925667*^9, 3.635517699734798*^9}, {
   3.635576896447352*^9, 3.635576905471345*^9}, {3.6355769467798758`*^9, 
   3.635576980119351*^9}, {3.635577013150144*^9, 3.635577039801152*^9}, {
   3.635664842556532*^9, 3.6356648660964117`*^9}, {3.635664899251541*^9, 
   3.635664984386888*^9}, {3.635665137972951*^9, 3.635665144001618*^9}, {
   3.635665353170265*^9, 3.635665418228463*^9}, {3.635835943700841*^9, 
   3.635835980713619*^9}, {3.635837059015418*^9, 3.635837064718629*^9}, {
   3.635837097445875*^9, 3.635837212679276*^9}, {3.637578331848534*^9, 
   3.637578335608118*^9}, {3.6375786545763283`*^9, 3.63757867943259*^9}, {
   3.637578713129423*^9, 3.637578830766099*^9}, {3.6386072918273067`*^9, 
   3.638607294601969*^9}, {3.638607700574728*^9, 3.638607700919767*^9}, {
   3.7524735840526733`*^9, 3.752473587484716*^9}, {3.752473661162195*^9, 
   3.752473686615295*^9}},
 CellLabel->
  "In[449]:=",ExpressionUUID->"cacd306b-3ccf-4bc5-aea8-cdc818cc73a8"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Plot", "[", 
     RowBox[{
      RowBox[{"Evaluate", "[", 
       RowBox[{
        RowBox[{"SmoothCurve", "[", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"2", ",", "3"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"-", "2"}], ",", "2", ",", 
             RowBox[{"-", "1"}], ",", "3"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{".2", ",", ".3", ",", ".4"}], "}"}]}], "}"}], "]"}], "[", 
        "x", "]"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"x", ",", 
        RowBox[{"-", "2"}], ",", "8"}], "}"}], ",", " ", 
      RowBox[{"ImageSize", "\[Rule]", "Small"}]}], "]"}], 
    "\[IndentingNewLine]", 
    RowBox[{"Plot", "[", 
     RowBox[{
      RowBox[{"Evaluate", "[", 
       RowBox[{
        RowBox[{"SmoothCurve", "[", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"2", ",", "3", ",", "2"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"-", "2"}], ",", "2", ",", 
             RowBox[{"-", "1"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{".2", ",", ".4"}], "}"}]}], "}"}], "]"}], "[", "x", "]"}],
        "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"x", ",", 
        RowBox[{"-", "2"}], ",", "8"}], "}"}], ",", " ", 
      RowBox[{"ImageSize", "\[Rule]", "Small"}], ",", " ", 
      RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "*)"}]}]], "Input",
 CellChangeTimes->{3.664903209523378*^9},
 CellLabel->
  "In[458]:=",ExpressionUUID->"d4e93104-6ea9-4d1c-ab64-6ff2c38299b4"],

Cell["\<\
MakeCommensurate[vector_, basis_] returns a {vector\[CloseCurlyQuote], \
indices} so that vector\[CloseCurlyQuote] is close to an integer multiple of \
vector, and can be expressed as vector\[CloseCurlyQuote]=indices.basis
It also works with several vectors as input. Then, all vectors should be \
scaled by the same constant.\
\>", "Text",
 CellChangeTimes->{{3.664903215752318*^9, 3.664903286418728*^9}, {
  3.664903469117812*^9, 3.664903480213191*^9}, {3.665127557188748*^9, 
  3.665127579788095*^9}},ExpressionUUID->"4dd2ec47-a0e6-495d-a95b-\
a51f64c57108"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "MakeCommensurate", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"MaxMultiple", "\[Rule]", "10"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MakeCommensurate", "[", 
   RowBox[{
    RowBox[{"vector_", "?", "VectorQ"}], ",", 
    RowBox[{"basis_", "?", "MatrixQ"}], ",", " ", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"maxmul", "=", 
       RowBox[{"OptionValue", "@", "MaxMultiple"}]}], ",", "mul", ",", 
      "indices"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"First", " ", "assume", " ", "maxmimum", " ", "multiple"}], ",",
       " ", 
      RowBox[{"and", " ", "round", " ", "indices", " ", "to", " ", "1"}]}], 
     "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"indices", "=", " ", 
      RowBox[{"Round", "[", 
       RowBox[{"maxmul", " ", 
        RowBox[{"vector", ".", 
         RowBox[{"Inverse", "[", "basis", "]"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "We", " ", "then", " ", "remove", " ", "common", " ", "factors", " ", 
       "to", " ", "reduce", " ", "the", " ", "vector", " ", "to", " ", "the", 
       " ", "least", " ", "multiple", " ", "of", " ", "the", " ", "input", 
       " ", "vector"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"mul", ",", "indices"}], "}"}], "=", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"maxmul", ",", "indices"}], "}"}], "/", 
       RowBox[{"GCD", "@@", 
        RowBox[{"Append", "[", 
         RowBox[{"indices", ",", "maxmul"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"indices", ".", "basis"}], ",", "indices", ",", " ", "mul"}], 
      "}"}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MakeCommensurate", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"vectors__", "?", "VectorQ"}], "}"}], ",", 
    RowBox[{"basis_", "?", "MatrixQ"}], ",", " ", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"maxmul", "=", 
       RowBox[{"OptionValue", "@", "MaxMultiple"}]}], ",", "mul", ",", 
      "indices"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"First", " ", "assume", " ", "maxmimum", " ", "multiple"}], ",",
       " ", 
      RowBox[{"and", " ", "round", " ", "indices", " ", "to", " ", "1"}]}], 
     "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"indices", "=", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"Round", "[", 
         RowBox[{"maxmul", " ", 
          RowBox[{"#", ".", 
           RowBox[{"Inverse", "[", "basis", "]"}]}]}], "]"}], "&"}], "/@", 
       RowBox[{"{", "vectors", "}"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "We", " ", "then", " ", "remove", " ", "common", " ", "factors", " ", 
       "to", " ", "reduce", " ", "the", " ", "vector", " ", "to", " ", "the", 
       " ", "least", " ", "multiple", " ", "of", " ", "the", " ", "input", 
       " ", "vector"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"mul", ",", "indices"}], "}"}], "=", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"maxmul", ",", "indices"}], "}"}], "/", 
       RowBox[{"GCD", "@@", 
        RowBox[{"Append", "[", 
         RowBox[{
          RowBox[{"Flatten", "@", "indices"}], ",", "maxmul"}], "]"}]}]}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"indices", ".", "basis"}], ",", "indices", ",", " ", "mul"}], 
      "}"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.66490328755025*^9, 3.6649034410430613`*^9}, {
  3.664903486996941*^9, 3.664903510018073*^9}, {3.664903547034642*^9, 
  3.664903549185726*^9}, {3.6649035809583178`*^9, 3.6649035853732347`*^9}, {
  3.664904179725583*^9, 3.664904183178096*^9}, {3.6649042246903667`*^9, 
  3.664904298108498*^9}, {3.6649043544861603`*^9, 3.664904380053062*^9}, {
  3.664904459227377*^9, 3.66490445930588*^9}, {3.6649045735621767`*^9, 
  3.664904618729433*^9}, {3.664904831361321*^9, 3.664904841497121*^9}, {
  3.6649048758138733`*^9, 3.6649049632290993`*^9}, {3.6649050965221977`*^9, 
  3.664905131656103*^9}, {3.664905217972657*^9, 3.6649052531303673`*^9}, {
  3.6651388914851847`*^9, 3.665138892039875*^9}, {3.665296147467783*^9, 
  3.665296175188064*^9}, {3.6652962059750843`*^9, 3.665296208452903*^9}},
 CellLabel->
  "In[459]:=",ExpressionUUID->"6f156344-3584-4059-bbf1-1fec9ca3bb01"],

Cell["\<\
MakeCommensurateBasis[basis1_, basis0_] returns a {basis1\[CloseCurlyQuote], \
indices} so that basis1\[CloseCurlyQuote] is close to basis1 (M\
\[CloseCurlyQuote] basis1\[CloseCurlyQuote]=M basis 1, for some integer M, M\
\[CloseCurlyQuote]<maxmultiple), and can be expressed as \
indices\[CenterDot]basis1\[CloseCurlyQuote]=basis0.
\
\>", "Text",
 CellChangeTimes->{{3.664903215752318*^9, 3.664903286418728*^9}, {
   3.664903469117812*^9, 3.664903480213191*^9}, {3.665127557188748*^9, 
   3.665127579788095*^9}, {3.6652962315239687`*^9, 3.6652963256312647`*^9}, 
   3.665296363235682*^9, {3.6652964139478483`*^9, 3.665296450478209*^9}, {
   3.6652965686618547`*^9, 
   3.665296571819509*^9}},ExpressionUUID->"d364e038-4c34-4dc3-8b74-\
c9770735ae46"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "MakeCommensurateBasis", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"MaxMultiple", "\[Rule]", "10"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MakeCommensurateBasis", "[", 
   RowBox[{
    RowBox[{"basis1_", "?", "MatrixQ"}], ",", 
    RowBox[{"basis0_", "?", "MatrixQ"}], ",", " ", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"maxmul", "=", 
       RowBox[{"OptionValue", "@", "MaxMultiple"}]}], ",", "mul", ",", 
      "indices"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"First", " ", "assume", " ", "maxmimum", " ", "multiple"}], ",",
       " ", 
      RowBox[{"and", " ", "round", " ", "indices", " ", "to", " ", "1"}]}], 
     "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"indices", "=", " ", 
      RowBox[{"Round", "[", 
       RowBox[{"maxmul", " ", 
        RowBox[{"basis0", ".", 
         RowBox[{"Inverse", "[", "basis1", "]"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "We", " ", "then", " ", "remove", " ", "common", " ", "factors", " ", 
       "to", " ", "reduce", " ", "the", " ", "vector", " ", "to", " ", "the", 
       " ", "least", " ", "multiple", " ", "of", " ", "the", " ", "input", 
       " ", "vector"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"mul", ",", "indices"}], "}"}], "=", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"maxmul", ",", "indices"}], "}"}], "/", 
       RowBox[{"GCD", "@@", 
        RowBox[{"Append", "[", 
         RowBox[{
          RowBox[{"Flatten", "@", "indices"}], ",", "maxmul"}], "]"}]}]}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"mul", " ", 
        RowBox[{
         RowBox[{"Inverse", "[", "indices", "]"}], ".", "basis0"}]}], ",", 
       "indices", ",", " ", "mul"}], "}"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->CompressedData["
1:eJxTTMoPSmViYGAQBmIQvWz2xz57v9eOhxIUF4Hoj8/uLwfRfFMOrALRp6QT
14Poio9LwXTXqnmbwfRH7S0g+pd5+T8Q/W3TUzBdIy7G4gCkL1Y484LoBX3+
IiB6/aZGcRC9xi1dEUQfPZkJpqP+btQH0S3h4aYg+mP/a38QnfVCPxBEO3BX
hYLoEyHpCSD6xlaBQhB95l9JKYhmUrBvANE/tJe0gOhFbfkzNwHpFW6NYFrk
R17SfyA9n+VZKoh+Yrw/E0Tr1fFlgegyifs1IDokcEk9iF7fKXcTRLdXznwI
ome19Ikw+APdI9EkCqIBHVuWjw==
  "],
 CellLabel->
  "In[462]:=",ExpressionUUID->"89927f94-c9be-42bc-8d47-219e59ff15d3"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.665127393312903*^9, 3.665127417837216*^9}, {
   3.6651274713138247`*^9, 3.6651274740160913`*^9}, {3.665138881852092*^9, 
   3.665138887533394*^9}, {3.66529613866992*^9, 3.6652961432173758`*^9}, 
   3.665296173715892*^9, 3.6652962045011597`*^9},
 CellLabel->
  "In[464]:=",ExpressionUUID->"b66a02d9-cbc3-486e-9c30-30c6812333f7"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Lattice presets [name is geometry]", "Subsubsection",
 CellChangeTimes->{{3.597635191140554*^9, 3.597635195628335*^9}, {
  3.635248606168252*^9, 
  3.635248610496245*^9}},ExpressionUUID->"d9ca92ed-df0c-4eeb-8c51-\
16eca9cab494"],

Cell[BoxData[
 RowBox[{
  RowBox[{"BuildLattice", "[", 
   RowBox[{"preset_String", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
  RowBox[{"BuildLattice", "[", 
   RowBox[{
    RowBox[{"LatticePreset", "[", "preset", "]"}], ",", "opts"}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.635244434681612*^9, 3.635244456545397*^9}, {
   3.635244655276935*^9, 3.635244709445406*^9}, {3.6352447591196203`*^9, 
   3.6352447594910097`*^9}, {3.6352448235735903`*^9, 
   3.6352448496111107`*^9}, {3.6352456273813*^9, 3.6352456388961163`*^9}, {
   3.635245694789289*^9, 3.635245724197649*^9}, 3.6355190237419662`*^9},
 CellLabel->
  "In[465]:=",ExpressionUUID->"a205e2e9-d853-417b-8ee7-cb59e9609a36"],

Cell["Basic Bravais Lattices", "Text",
 CellChangeTimes->{{3.635242695437335*^9, 
  3.635242710756707*^9}},ExpressionUUID->"bf98179f-d055-4461-8a3a-\
e2c927530e7e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"LatticePreset", "[", "\"\<Linear\>\"", "]"}], ":=", 
   RowBox[{"BuildLattice", "@", 
    RowBox[{"N", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"{", "1", "}"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<A\>\"", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", "0", "}"}], "}"}]}], "}"}]}], "}"}]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LatticePreset", "[", "\"\<Honeycomb\>\"", "]"}], ":=", 
   RowBox[{"BuildLattice", "@", 
    RowBox[{"N", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", 
            FractionBox["\[Pi]", "3"], "]"}], ",", 
           RowBox[{"Sin", "[", 
            FractionBox["\[Pi]", "3"], "]"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", 
             FractionBox["\[Pi]", "3"], "]"}]}], ",", 
           RowBox[{"Sin", "[", 
            FractionBox["\[Pi]", "3"], "]"}]}], "}"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<A\>\"", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{
            FractionBox["1", 
             SqrtBox["3"]], 
            RowBox[{"{", 
             RowBox[{"0", ",", 
              RowBox[{"-", 
               FractionBox["1", "2"]}]}], "}"}]}], "}"}]}], ",", 
         RowBox[{"\"\<B\>\"", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{
            FractionBox["1", 
             SqrtBox["3"]], 
            RowBox[{"{", 
             RowBox[{"0", ",", 
              FractionBox["1", "2"]}], "}"}]}], "}"}]}]}], "}"}]}], 
      "}"}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LatticePreset", "[", "\"\<Square\>\"", "]"}], ":=", 
   RowBox[{"BuildLattice", "@", 
    RowBox[{"N", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"1", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"0", ",", "1"}], "}"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<A\>\"", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"0", ",", "0"}], "}"}], "}"}]}], "}"}]}], "}"}]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LatticePreset", "[", "\"\<Triangular\>\"", "]"}], ":=", 
   RowBox[{"BuildLattice", "@", 
    RowBox[{"N", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Cos", "[", 
            FractionBox["\[Pi]", "3"], "]"}], ",", 
           RowBox[{"Sin", "[", 
            FractionBox["\[Pi]", "3"], "]"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Cos", "[", 
             FractionBox["\[Pi]", "3"], "]"}]}], ",", 
           RowBox[{"Sin", "[", 
            FractionBox["\[Pi]", "3"], "]"}]}], "}"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<A\>\"", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"0.", ",", "0.000000000001"}], "}"}], "}"}]}], "}"}]}], 
      "}"}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LatticePreset", "[", "\"\<Cubic\>\"", "]"}], ":=", 
   RowBox[{"BuildLattice", "@", 
    RowBox[{"N", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"1", ",", "0", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"0", ",", "1", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"0", ",", "0", ",", "1"}], "}"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<A\>\"", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"0", ",", "0", ",", "0"}], "}"}], "}"}]}], "}"}]}], 
      "}"}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LatticePreset", "[", "\"\<FCC\>\"", "]"}], ":=", 
   RowBox[{"BuildLattice", "@", 
    RowBox[{"N", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        FractionBox["1", 
         SqrtBox["2"]], 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"-", "1"}], ",", 
            RowBox[{"-", "1"}], ",", "0"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"1", ",", 
            RowBox[{"-", "1"}], ",", "0"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"0", ",", "1", ",", 
            RowBox[{"-", "1"}]}], "}"}]}], "}"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<A\>\"", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"0", ",", "0", ",", "0"}], "}"}], "}"}]}], "}"}]}], 
      "}"}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LatticePreset", "[", "\"\<BCC\>\"", "]"}], ":=", 
   RowBox[{"BuildLattice", "@", 
    RowBox[{"N", "@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        FractionBox["1", "2"], 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "0", ",", "0"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"0", ",", "2", ",", "0"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"1", ",", "1", ",", "1"}], "}"}]}], "}"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<A\>\"", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"0", ",", "0", ",", "0"}], "}"}], "}"}]}], "}"}]}], 
      "}"}]}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.6352391103547993`*^9, 3.635239175405504*^9}, {
   3.635239268120384*^9, 3.6352393165612164`*^9}, {3.635239672425881*^9, 
   3.635239678247158*^9}, {3.635239837647435*^9, 3.635239839502427*^9}, {
   3.635239886407157*^9, 3.6352398967477913`*^9}, 3.635239944681851*^9, {
   3.635240003784737*^9, 3.635240005486843*^9}, {3.635240040215774*^9, 
   3.635240046571508*^9}, {3.635241456988687*^9, 3.6352414585153437`*^9}, {
   3.635242204112012*^9, 3.635242326124044*^9}, {3.635242616748905*^9, 
   3.635242640908971*^9}, {3.635244319271575*^9, 3.635244319696039*^9}, {
   3.6352444166126623`*^9, 3.6352444307556133`*^9}, {3.6352448538125563`*^9, 
   3.63524493417727*^9}, {3.6352456081771297`*^9, 3.6352456109846077`*^9}, {
   3.635245642732933*^9, 3.635245685260912*^9}, {3.635245726741954*^9, 
   3.635245730650771*^9}, {3.6352477205592117`*^9, 3.635247732694894*^9}, {
   3.635247935780797*^9, 3.635247954443997*^9}},
 CellLabel->
  "In[466]:=",ExpressionUUID->"fba62133-07f7-4cd9-909b-6696f1306214"],

Cell["Twisted Honeycomb bilayers", "Text",
 CellChangeTimes->{{3.63524268657446*^9, 3.635242690629469*^9}, {
  3.6352467593884277`*^9, 
  3.635246760443798*^9}},ExpressionUUID->"d9540dc1-b897-407c-98fe-\
2526926d4303"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"MoireAngle", "[", 
    RowBox[{"n_", ",", "m_"}], "]"}], "=", 
   RowBox[{"-", 
    RowBox[{"Arg", "[", 
     FractionBox[
      RowBox[{
       RowBox[{"m", " ", 
        SuperscriptBox["\[ExponentialE]", 
         RowBox[{
          RowBox[{"-", "\[ImaginaryI]"}], " ", 
          RowBox[{"\[Pi]", "/", "6"}]}]]}], "+", 
       RowBox[{"n", " ", 
        SuperscriptBox["\[ExponentialE]", 
         RowBox[{"\[ImaginaryI]", " ", 
          RowBox[{"\[Pi]", "/", "6"}]}]]}]}], 
      RowBox[{
       RowBox[{"n", " ", 
        SuperscriptBox["\[ExponentialE]", 
         RowBox[{
          RowBox[{"-", "\[ImaginaryI]"}], " ", 
          RowBox[{"\[Pi]", "/", "6"}]}]]}], "+", 
       RowBox[{"m", " ", 
        SuperscriptBox["\[ExponentialE]", 
         RowBox[{"\[ImaginaryI]", " ", 
          RowBox[{"\[Pi]", "/", "6"}]}]]}]}]], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MoireAngle", "[", "j_", "]"}], "=", 
    RowBox[{"MoireAngle", "[", 
     RowBox[{"j", ",", 
      RowBox[{"j", "+", "1"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LatticePreset", "[", 
     RowBox[{"\"\<TwistedHoneycombBilayer\>\"", ",", "j_Integer", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"LatticePreset", "[", 
     RowBox[{"\"\<TwistedHoneycombBilayer\>\"", ",", 
      RowBox[{"{", 
       RowBox[{"j", ",", 
        RowBox[{"j", "+", "1"}]}], "}"}], ",", "opts"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"LatticePreset", "[", 
   RowBox[{"\"\<TwistedHoneycombBilayer\>\"", ",", 
    RowBox[{"{", 
     RowBox[{"n_Integer", ",", "m_Integer"}], "}"}], ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"InterlayerDistance", "\[Rule]", "1"}], ",", 
        RowBox[{"LatticeConstant", "\[Rule]", "1"}]}], "}"}], "]"}]}]}], 
   "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "\[Theta]", ",", " ", "lattop", ",", " ", "latbot", ",", "supercell", 
      ",", "\[IndentingNewLine]", 
      RowBox[{"\[CapitalDelta]z", "=", 
       RowBox[{"OptionValue", "[", "InterlayerDistance", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"a0", "=", 
       RowBox[{"OptionValue", "[", "LatticeConstant", "]"}]}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{"Moir\[EAcute]", " ", "angle"}], "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"\[Theta]", "=", 
      RowBox[{"-", 
       RowBox[{"Arg", "[", 
        FractionBox[
         RowBox[{
          RowBox[{"m", " ", 
           SuperscriptBox["\[ExponentialE]", 
            RowBox[{
             RowBox[{"-", "\[ImaginaryI]"}], " ", 
             RowBox[{"\[Pi]", "/", "6"}]}]]}], "+", 
          RowBox[{"n", " ", 
           SuperscriptBox["\[ExponentialE]", 
            RowBox[{"\[ImaginaryI]", " ", 
             RowBox[{"\[Pi]", "/", "6"}]}]]}]}], 
         RowBox[{
          RowBox[{"n", " ", 
           SuperscriptBox["\[ExponentialE]", 
            RowBox[{
             RowBox[{"-", "\[ImaginaryI]"}], " ", 
             RowBox[{"\[Pi]", "/", "6"}]}]]}], "+", 
          RowBox[{"m", " ", 
           SuperscriptBox["\[ExponentialE]", 
            RowBox[{"\[ImaginaryI]", " ", 
             RowBox[{"\[Pi]", "/", "6"}]}]]}]}]], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"GCD", "[", 
           RowBox[{
            RowBox[{"n", "-", "m"}], ",", "3"}], "]"}], "\[Equal]", "1"}], 
         ",", 
         RowBox[{"supercell", "=", 
          RowBox[{"(", GridBox[{
             {"m", "n"},
             {
              RowBox[{"-", "n"}], 
              RowBox[{"m", "+", "n"}]}
            }], ")"}]}], ",", 
         RowBox[{"supercell", "=", 
          RowBox[{"(", GridBox[{
             {
              RowBox[{"m", "+", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"n", "-", "m"}], ")"}], "/", "3"}]}], 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"n", "-", "m"}], ")"}], "/", "3"}]},
             {
              RowBox[{
               RowBox[{"-", 
                RowBox[{"(", 
                 RowBox[{"n", "-", "m"}], ")"}]}], "/", "3"}], 
              RowBox[{"m", "+", 
               RowBox[{"2", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"n", "-", "m"}], ")"}], "/", "3"}]}]}]}
            }], ")"}]}]}], "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"supercell", "=", 
      RowBox[{"(", GridBox[{
         {"m", "n"},
         {
          RowBox[{"-", "n"}], 
          RowBox[{"m", "+", "n"}]}
        }], ")"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"lattop", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"\"\<Honeycomb\>\"", ",", 
        RowBox[{"LatticeConstant", "\[Rule]", "a0"}], ",", 
        RowBox[{"EmbeddingDimensions", "\[Rule]", "3"}], ",", 
        RowBox[{"Supercell", "\[Rule]", "supercell"}], ",", 
        RowBox[{"Transform", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"(", GridBox[{
               {
                RowBox[{"Cos", "[", 
                 RowBox[{"\[Theta]", "/", "2"}], "]"}], 
                RowBox[{"-", 
                 RowBox[{"Sin", "[", 
                  RowBox[{"\[Theta]", "/", "2"}], "]"}]}], "0"},
               {
                RowBox[{"Sin", "[", 
                 RowBox[{"\[Theta]", "/", "2"}], "]"}], 
                RowBox[{"Cos", "[", 
                 RowBox[{"\[Theta]", "/", "2"}], "]"}], "0"},
               {"0", "0", "1"}
              }], ")"}], ".", 
            RowBox[{"(", 
             RowBox[{"#", "+", 
              RowBox[{"{", 
               RowBox[{
                FractionBox["1", "2"], ",", "0", ",", 
                RowBox[{"\[CapitalDelta]z", "/", "2"}]}], "}"}]}], ")"}]}], 
           "&"}], ")"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"GCD", "[", 
           RowBox[{
            RowBox[{"n", "-", "m"}], ",", "3"}], "]"}], "\[Equal]", "1"}], 
         ",", 
         RowBox[{"supercell", "=", 
          RowBox[{"(", GridBox[{
             {"n", "m"},
             {
              RowBox[{"-", "m"}], 
              RowBox[{"m", "+", "n"}]}
            }], ")"}]}], ",", 
         RowBox[{"supercell", "=", 
          RowBox[{"(", GridBox[{
             {
              RowBox[{
               RowBox[{"(", 
                RowBox[{"n", "-", "m"}], ")"}], "/", "3"}], 
              RowBox[{"m", "+", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"n", "-", "m"}], ")"}], "/", "3"}]}]},
             {
              RowBox[{
               RowBox[{"-", "m"}], "-", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"n", "-", "m"}], ")"}], "/", "3"}]}], 
              RowBox[{
               RowBox[{"-", 
                RowBox[{"(", 
                 RowBox[{"n", "-", "m"}], ")"}]}], "/", "3"}]}
            }], ")"}]}]}], "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"supercell", "=", 
      RowBox[{"(", GridBox[{
         {"n", "m"},
         {
          RowBox[{"-", "m"}], 
          RowBox[{"m", "+", "n"}]}
        }], ")"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"latbot", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"\"\<Honeycomb\>\"", ",", 
        RowBox[{"LatticeConstant", "\[Rule]", "a0"}], ",", 
        RowBox[{"EmbeddingDimensions", "\[Rule]", "3"}], ",", " ", 
        RowBox[{"Supercell", "\[Rule]", "supercell"}], ",", 
        RowBox[{"Transform", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"(", GridBox[{
               {
                RowBox[{"Cos", "[", 
                 RowBox[{
                  RowBox[{"-", "\[Theta]"}], "/", "2"}], "]"}], 
                RowBox[{"-", 
                 RowBox[{"Sin", "[", 
                  RowBox[{
                   RowBox[{"-", "\[Theta]"}], "/", "2"}], "]"}]}], "0"},
               {
                RowBox[{"Sin", "[", 
                 RowBox[{
                  RowBox[{"-", "\[Theta]"}], "/", "2"}], "]"}], 
                RowBox[{"Cos", "[", 
                 RowBox[{
                  RowBox[{"-", "\[Theta]"}], "/", "2"}], "]"}], "0"},
               {"0", "0", "1"}
              }], ")"}], ".", 
            RowBox[{"(", 
             RowBox[{"#", "+", 
              RowBox[{"{", 
               RowBox[{
                FractionBox["1", "2"], ",", "0", ",", 
                RowBox[{
                 RowBox[{"-", "\[CapitalDelta]z"}], "/", "2"}]}], "}"}]}], 
             ")"}]}], "&"}], ")"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"latbot", "=", 
      RowBox[{"latbot", "/.", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<A\>\"", "\[Rule]", "\"\<C\>\""}], ",", 
         RowBox[{"\"\<B\>\"", "\[Rule]", "\"\<D\>\""}]}], "}"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Theta]", "=", 
      RowBox[{
       RowBox[{"-", "2"}], 
       RowBox[{"\[Pi]", "/", "3"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TransformLattice", "[", 
       RowBox[{
        RowBox[{"CombineLattices", "[", 
         RowBox[{"lattop", ",", "latbot"}], "]"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"(", GridBox[{
             {
              RowBox[{"Cos", "[", "\[Theta]", "]"}], 
              RowBox[{"-", 
               RowBox[{"Sin", "[", "\[Theta]", "]"}]}], "0"},
             {
              RowBox[{"Sin", "[", "\[Theta]", "]"}], 
              RowBox[{"Cos", "[", "\[Theta]", "]"}], "0"},
             {"0", "0", "1"}
            }], ")"}], ".", "#"}], "&"}]}], "]"}], "[", 
      RowBox[{"\"\<BravaisVectors\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"Reverse", "[", "#", "]"}], 
          RowBox[{"{", 
           RowBox[{"1", ",", 
            RowBox[{"-", "1"}]}], "}"}]}], "&"}], ")"}]}], "]"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.597778524908202*^9, 3.5977785531472588`*^9}, {
   3.5986022867587423`*^9, 3.5986023806008253`*^9}, {3.598602495857108*^9, 
   3.598602686897234*^9}, {3.5986029256438417`*^9, 3.5986030768843*^9}, {
   3.598607138581458*^9, 3.5986072216658897`*^9}, {3.598607283895175*^9, 
   3.598607303766403*^9}, {3.5986073503087797`*^9, 3.598607370042721*^9}, {
   3.598607482731531*^9, 3.598607525477363*^9}, {3.598607560788601*^9, 
   3.598607649663886*^9}, {3.5986080826815166`*^9, 3.59860812053292*^9}, 
   3.598608171721591*^9, {3.598608202482645*^9, 3.598608213876999*^9}, {
   3.5986082538890343`*^9, 3.598608336439548*^9}, {3.598608411490093*^9, 
   3.5986084269861927`*^9}, {3.598608473603298*^9, 3.598608479527557*^9}, 
   3.598685247135528*^9, {3.5986861479963217`*^9, 3.5986862031600933`*^9}, {
   3.598686261707034*^9, 3.598686288133378*^9}, {3.598686646646967*^9, 
   3.59868671042649*^9}, {3.598687663927294*^9, 3.598687815909318*^9}, {
   3.598687852911193*^9, 3.598687854797378*^9}, {3.598687991034292*^9, 
   3.598688007753639*^9}, {3.5986880683886557`*^9, 3.5986880688321943`*^9}, {
   3.598688157702783*^9, 3.598688159829402*^9}, {3.598688233257468*^9, 
   3.598688235320751*^9}, {3.598688282080241*^9, 3.598688300383581*^9}, {
   3.598688402909182*^9, 3.5986884049791203`*^9}, {3.598688532172147*^9, 
   3.59868863593674*^9}, {3.598688741643224*^9, 3.5986890155296173`*^9}, {
   3.598689255627309*^9, 3.598689433326643*^9}, {3.59870188359851*^9, 
   3.598701910168613*^9}, {3.598702062683696*^9, 3.598702065533586*^9}, 
   3.598702106655616*^9, {3.5987021720617867`*^9, 3.598702243043263*^9}, {
   3.5987024138042316`*^9, 3.598702426589411*^9}, {3.598702670205593*^9, 
   3.5987026813196497`*^9}, {3.602914665287225*^9, 3.6029146848442507`*^9}, {
   3.623147303163156*^9, 3.6231473117672863`*^9}, {3.635242644692503*^9, 
   3.6352426459804087`*^9}, {3.635242802228195*^9, 3.6352428093627234`*^9}, {
   3.6352433362501993`*^9, 3.635243383173895*^9}, {3.635244374735701*^9, 
   3.635244376447381*^9}, {3.6352457405780888`*^9, 3.635245765738759*^9}, {
   3.635245799511529*^9, 3.6352458049188004`*^9}, {3.635245981997793*^9, 
   3.635246043580577*^9}, {3.635246090248855*^9, 3.635246185924368*^9}, {
   3.635246309397835*^9, 3.635246314727682*^9}, {3.6352465926007423`*^9, 
   3.635246782431966*^9}, {3.6352471267969923`*^9, 3.635247212417046*^9}, {
   3.635247295909724*^9, 3.635247311654512*^9}, 3.635247377019072*^9, 
   3.635247414065494*^9, {3.63524757470549*^9, 3.635247596917612*^9}, {
   3.6352479563106413`*^9, 3.635247958478036*^9}, {3.635248094965066*^9, 
   3.6352480961256104`*^9}, {3.635248748318039*^9, 3.635248748476666*^9}, 
   3.6352489074154987`*^9, 3.6359649291785316`*^9, {3.6820698562461357`*^9, 
   3.682069924785088*^9}, {3.682069992040202*^9, 3.682069993805806*^9}, 
   3.68207026120955*^9, {3.682071578648642*^9, 3.682071583909083*^9}, {
   3.682071659572158*^9, 3.68207166176838*^9}},
 CellLabel->
  "In[473]:=",ExpressionUUID->"f9c50d79-a3a6-464b-8bcf-56d262111f08"],

Cell["Chiral Honeycomb nanoribbon", "Text",
 CellChangeTimes->{{3.635248758705468*^9, 
  3.635248769456202*^9}},ExpressionUUID->"d2cc44dd-f9f8-4890-8f54-\
db6e8043d7d7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"Width", " ", "can", " ", "be", " ", "a", " ", "function"}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"LatticePreset", "[", 
    RowBox[{"\"\<HoneycombNanoribbon\>\"", ",", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Width", "\[Rule]", "10"}], ",", 
         RowBox[{"Type", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"1", ",", 
            RowBox[{"-", "1"}]}], "}"}]}], ",", 
         RowBox[{"LatticeConstant", "\[Rule]", "1"}]}], "}"}], "]"}]}]}], 
    "]"}], ":=", "\[IndentingNewLine]", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"indices", "=", 
        RowBox[{"Switch", "[", 
         RowBox[{
          RowBox[{"OptionValue", "@", "Type"}], ",", "\"\<Armchair\>\"", ",", 
          
          RowBox[{"{", 
           RowBox[{"1", ",", 
            RowBox[{"-", "1"}]}], "}"}], ",", "\"\<Zigzag\>\"", ",", 
          RowBox[{"{", 
           RowBox[{"1", ",", 
            RowBox[{"-", "1"}]}], "}"}], ",", "_", ",", 
          RowBox[{"OptionValue", "@", "Type"}]}], "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"a0", "=", 
        RowBox[{"OptionValue", "@", "LatticeConstant"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"baselattice", "=", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"OptionValue", "@", "Type"}], "===", 
             "\"\<Armchair\>\""}], ",", " ", "\[IndentingNewLine]", 
            RowBox[{"BuildLattice", "[", 
             RowBox[{"\"\<Honeycomb\>\"", ",", 
              RowBox[{"Transform", "\[Rule]", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"(", GridBox[{
                    {"0", 
                    RowBox[{"-", "1"}]},
                    {"1", "0"}
                    }], ")"}], ".", "#"}], "&"}], ")"}]}], ",", 
              RowBox[{"Supercell", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"-", "1"}], ",", "0"}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"0", ",", "1"}], "}"}]}], "}"}]}], ",", 
              RowBox[{"LatticeConstant", "\[Rule]", "a0"}]}], "]"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"BuildLattice", "[", 
             RowBox[{"\"\<Honeycomb\>\"", ",", 
              RowBox[{"LatticeConstant", "\[Rule]", "a0"}]}], "]"}]}], 
           "]"}]}], ",", 
         RowBox[{"RibbonAxis", "=", 
          RowBox[{"Normalize", "[", 
           RowBox[{
            RowBox[{"(", GridBox[{
               {
                RowBox[{"Cos", "[", 
                 RowBox[{"\[Pi]", "/", "3"}], "]"}], 
                RowBox[{"Cos", "[", 
                 RowBox[{"2", 
                  RowBox[{"\[Pi]", "/", "3"}]}], "]"}]},
               {
                RowBox[{"Sin", "[", 
                 RowBox[{"\[Pi]", "/", "3"}], "]"}], 
                RowBox[{"Sin", "[", 
                 RowBox[{"2", 
                  RowBox[{"\[Pi]", "/", "3"}]}], "]"}]}
              }], ")"}], ".", "indices"}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"W", "=", 
          RowBox[{"OptionValue", "@", "Width"}]}]}], "}"}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Head", "@", "W"}], "===", "Function"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"BuildLattice", "[", 
          RowBox[{"baselattice", ",", 
           RowBox[{"Supercell", "\[Rule]", 
            RowBox[{"{", 
             RowBox[{"indices", ",", 
              RowBox[{"{", 
               RowBox[{"1", ",", "1"}], "}"}]}], "}"}]}], ",", 
           RowBox[{"Bounded", "\[Rule]", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Axes", "\[Rule]", 
               RowBox[{"{", "2", "}"}]}], ",", 
              RowBox[{"Region", "\[Rule]", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"0", "<=", 
                  RowBox[{"#", ".", 
                   RowBox[{"(", GridBox[{
                    {"0", 
                    RowBox[{"-", "1"}]},
                    {"1", "0"}
                    }], ")"}], ".", "RibbonAxis"}], "\[LessEqual]", 
                  RowBox[{"W", "[", 
                   RowBox[{"#", ".", "RibbonAxis"}], "]"}]}], "&"}], 
                ")"}]}]}], "}"}]}]}], "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{"BuildLattice", "[", 
          RowBox[{"baselattice", ",", 
           RowBox[{"Supercell", "\[Rule]", 
            RowBox[{"{", 
             RowBox[{"indices", ",", 
              RowBox[{"{", 
               RowBox[{"1", ",", "1"}], "}"}]}], "}"}]}], ",", 
           RowBox[{"Bounded", "\[Rule]", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Axes", "\[Rule]", 
               RowBox[{"{", "2", "}"}]}], ",", 
              RowBox[{"Region", "\[Rule]", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"0", "<=", 
                  RowBox[{"#", ".", 
                   RowBox[{"(", GridBox[{
                    {"0", 
                    RowBox[{"-", "1"}]},
                    {"1", "0"}
                    }], ")"}], ".", "RibbonAxis"}], "<=", "W"}], "&"}], 
                ")"}]}]}], "}"}]}]}], "]"}]}], "]"}]}], "]"}]}], 
    "]"}]}]}]], "Input",
 CellChangeTimes->{{3.6352487771960907`*^9, 3.635248815951118*^9}, {
   3.6352488462052803`*^9, 3.635248879107596*^9}, {3.63524892165197*^9, 
   3.635249045372168*^9}, {3.635249165598838*^9, 3.63524917363033*^9}, {
   3.6352492134044237`*^9, 3.6352493521443872`*^9}, {3.635249439601344*^9, 
   3.635249553779028*^9}, {3.6352495872664347`*^9, 3.635249597737091*^9}, {
   3.635249642182613*^9, 3.6352497415618668`*^9}, {3.635249886923731*^9, 
   3.635250012076811*^9}, {3.635250062964221*^9, 3.635250122737454*^9}, {
   3.645849054880731*^9, 3.645849139943553*^9}, {3.645849182991535*^9, 
   3.645849216326974*^9}, {3.645849267717414*^9, 3.645849287455043*^9}, 
   3.64584932978015*^9, {3.646029264472507*^9, 3.6460292670287867`*^9}},
 CellLabel->
  "In[477]:=",ExpressionUUID->"0b38fa54-b794-4050-9595-dec5021cf52c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"LatticePresets", " ", "=", " ", 
   RowBox[{
    RowBox[{"DownValues", "[", "LatticePreset", "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "1", ",", "1", ",", "1"}], "]"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.707563249214529*^9, 3.707563253683956*^9}},
 CellLabel->
  "In[478]:=",ExpressionUUID->"16d54f49-87ae-4a4f-9c31-ff6135519d1d"]
}, Open  ]],

Cell[CellGroupData[{

Cell["System presets [name is physical system]", "Subsubsection",
 CellChangeTimes->{{3.6352402641349173`*^9, 3.635240266686254*^9}, {
  3.635248595322722*^9, 
  3.635248601168784*^9}},ExpressionUUID->"bb874350-6be7-4630-b2d8-\
a15a61a2598b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SystemPreset", "[", "\"\<Graphene\>\"", "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"a0", "=", "2.46"}], ",", 
      RowBox[{"t", "=", "3.16"}]}], "}"}], ",", 
    RowBox[{"BuildSystem", "[", 
     RowBox[{
      RowBox[{"BuildLattice", "[", 
       RowBox[{"\"\<Honeycomb\>\"", ",", " ", 
        RowBox[{"LatticeConstant", "\[Rule]", "a0"}]}], "]"}], ",", 
      RowBox[{"HoppingRange", "\[Rule]", 
       RowBox[{"1.01", 
        RowBox[{"a0", "/", 
         SqrtBox["3"]}]}]}], ",", 
      RowBox[{"Hopping", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{"t", "&"}], ")"}]}]}], "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.6667931049547043`*^9, 3.6667931723611383`*^9}},
 CellLabel->
  "In[479]:=",ExpressionUUID->"94f1d63d-dbf0-4c72-a708-34eba0d44fa0"],

Cell["Twisted graphene bilayers", "Text",
 CellChangeTimes->{{3.635243588793343*^9, 
  3.6352435922167273`*^9}},ExpressionUUID->"490d6fdd-2a80-4c29-a772-\
0e4011184bc5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SystemPreset", "[", 
   RowBox[{"\"\<TwistedGrapheneBilayer\>\"", ",", "indices_", ",", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"InterlayerDistance", "\[Rule]", "0.335"}], ",", 
        RowBox[{"LatticeConstant", "\[Rule]", "0.246"}], ",", 
        RowBox[{"HoppingRange", "\[Rule]", " ", 
         RowBox[{"1.01", " ", "4", " ", 
          RowBox[{".246", "/", 
           SqrtBox["3"]}]}]}], ",", " ", 
        RowBox[{"ScalingFactor", "\[Rule]", "1"}], ",", " ", 
        RowBox[{"Bias", "\[Rule]", "0."}], ",", " ", 
        RowBox[{"Bipartite", "\[Rule]", "False"}], ",", " ", 
        RowBox[{"Lattice", "\[Rule]", "Automatic"}]}], "}"}], "]"}]}]}], 
   "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"\[Lambda]", "=", 
      RowBox[{"OptionValue", "[", "ScalingFactor", "]"}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{"lat", ",", "\[IndentingNewLine]", 
        RowBox[{"range", "=", 
         RowBox[{"OptionValue", "[", "HoppingRange", "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"a0", "=", 
         RowBox[{"OptionValue", "[", "LatticeConstant", "]"}]}], " ", ",", 
        "\[IndentingNewLine]", 
        RowBox[{"acc", "=", 
         RowBox[{
          RowBox[{"OptionValue", "[", "LatticeConstant", "]"}], " ", "/", 
          SqrtBox["3"]}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\[CapitalDelta]z", "=", 
         RowBox[{"OptionValue", "[", "InterlayerDistance", "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"bias", "=", 
         RowBox[{"OptionValue", "[", "Bias", "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Gamma]0", "=", "2.70"}], ",", 
        RowBox[{"\[Gamma]1", "=", "0.48"}], ",", " ", 
        RowBox[{"\[Beta]", "=", "3.137"}], ",", "\[IndentingNewLine]", 
        "hopping"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "Lattice", "]"}], "===", "Automatic"}], 
         ",", " ", "\[IndentingNewLine]", 
         RowBox[{"lat", "=", 
          RowBox[{
           RowBox[{"LatticePreset", "[", 
            RowBox[{"\"\<TwistedHoneycombBilayer\>\"", ",", "indices", ",", 
             RowBox[{"InterlayerDistance", "\[Rule]", 
              RowBox[{"\[CapitalDelta]z", " ", "\[Lambda]"}]}], ",", 
             RowBox[{"LatticeConstant", "\[Rule]", 
              RowBox[{"a0", " ", "\[Lambda]"}]}]}], "]"}], "/.", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"\"\<C\>\"", "\[Rule]", "\"\<A\>\""}], ",", 
             RowBox[{"\"\<D\>\"", "\[Rule]", "\"\<B\>\""}]}], "}"}]}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"lat", "=", 
          RowBox[{
           RowBox[{"OptionValue", "[", "Lattice", "]"}], "/.", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"\"\<C\>\"", "\[Rule]", "\"\<A\>\""}], ",", 
             RowBox[{"\"\<D\>\"", "\[Rule]", "\"\<B\>\""}]}], "}"}]}]}]}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "Bipartite", "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"hopping", "=", 
          RowBox[{"Function", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"r1", ",", "r2", ",", "tag1", ",", "tag2"}], "}"}], ",", 
            
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"tag1", "\[Equal]", "tag2"}], ",", "0", ",", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                 RowBox[{"-", 
                  FractionBox["\[Gamma]0", "\[Lambda]"]}], 
                 SuperscriptBox[
                  RowBox[{"(", 
                   FractionBox[
                    RowBox[{"Norm", "[", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ";;", "2"}], "]"}], "]"}], "]"}], 
                    RowBox[{"Norm", "[", 
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "]"}]], ")"}], "2"], 
                 RowBox[{"Exp", "[", 
                  RowBox[{
                   RowBox[{"-", "\[Beta]"}], 
                   RowBox[{"(", 
                    FractionBox[
                    RowBox[{
                    RowBox[{"Norm", "[", 
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "]"}], "-", 
                    RowBox[{"acc", " ", "\[Lambda]"}]}], 
                    RowBox[{"acc", " ", "\[Lambda]"}]], ")"}]}], "]"}]}], "+", 
                RowBox[{"\[Gamma]1", 
                 SuperscriptBox[
                  RowBox[{"(", 
                   FractionBox[
                    RowBox[{"Abs", "[", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "[", 
                    RowBox[{"[", "3", "]"}], "]"}], "]"}], 
                    RowBox[{"Norm", "[", 
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "]"}]], ")"}], "2"], 
                 RowBox[{"Exp", "[", 
                  RowBox[{
                   RowBox[{"-", "\[Beta]"}], 
                   RowBox[{"(", 
                    FractionBox[
                    RowBox[{
                    RowBox[{"Norm", "[", 
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "]"}], "-", 
                    RowBox[{"\[CapitalDelta]z", " ", "\[Lambda]"}]}], 
                    RowBox[{"acc", " ", "\[Lambda]"}]], ")"}]}], "]"}]}]}], 
               ")"}]}], "]"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"hopping", "=", 
          RowBox[{"Function", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"r1", ",", "r2", ",", "tag1", ",", "tag2"}], "}"}], ",", 
            
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"-", 
                FractionBox["\[Gamma]0", "\[Lambda]"]}], 
               SuperscriptBox[
                RowBox[{"(", 
                 FractionBox[
                  RowBox[{"Norm", "[", 
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ";;", "2"}], "]"}], "]"}], "]"}], 
                  RowBox[{"Norm", "[", 
                   RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "]"}]], ")"}], "2"], 
               RowBox[{"Exp", "[", 
                RowBox[{
                 RowBox[{"-", "\[Beta]"}], 
                 RowBox[{"(", 
                  FractionBox[
                   RowBox[{
                    RowBox[{"Norm", "[", 
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "]"}], "-", 
                    RowBox[{"acc", " ", "\[Lambda]"}]}], 
                   RowBox[{"acc", " ", "\[Lambda]"}]], ")"}]}], "]"}]}], "+", 
              
              RowBox[{"\[Gamma]1", 
               SuperscriptBox[
                RowBox[{"(", 
                 FractionBox[
                  RowBox[{"Abs", "[", 
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "[", 
                    RowBox[{"[", "3", "]"}], "]"}], "]"}], 
                  RowBox[{"Norm", "[", 
                   RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "]"}]], ")"}], "2"], 
               RowBox[{"Exp", "[", 
                RowBox[{
                 RowBox[{"-", "\[Beta]"}], 
                 RowBox[{"(", 
                  FractionBox[
                   RowBox[{
                    RowBox[{"Norm", "[", 
                    RowBox[{"(", 
                    RowBox[{"r1", "-", "r2"}], ")"}], "]"}], "-", 
                    RowBox[{"\[CapitalDelta]z", " ", "\[Lambda]"}]}], 
                   RowBox[{"acc", " ", "\[Lambda]"}]], ")"}]}], "]"}]}]}], 
             ")"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"BuildSystem", "[", 
        RowBox[{"lat", ",", "\[IndentingNewLine]", 
         RowBox[{"Onsite", "\[Rule]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"0.5", " ", "bias", " ", 
             RowBox[{"Sign", "[", 
              RowBox[{"#", "[", 
               RowBox[{"[", "3", "]"}], "]"}], "]"}]}], "&"}], ")"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"HoppingRange", "\[Rule]", 
          RowBox[{"Min", "[", 
           RowBox[{
            RowBox[{"\[Lambda]", " ", "range"}], ",", 
            RowBox[{"Min", "[", 
             RowBox[{"Norm", "/@", 
              RowBox[{"lat", "[", "\"\<BravaisVectors\>\"", "]"}]}], "]"}]}], 
           "]"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"Hopping", "\[Rule]", "hopping"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"EmbedLattice", "\[Rule]", "True"}]}], "]"}]}]}], "]"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.635240268024884*^9, 3.6352402706222773`*^9}, {
   3.635242761922876*^9, 3.635242773018227*^9}, {3.635242904742634*^9, 
   3.6352430350478086`*^9}, 3.635243131867131*^9, {3.635243163724584*^9, 
   3.635243285603879*^9}, {3.635243322183723*^9, 3.6352433258953333`*^9}, {
   3.635243413843079*^9, 3.6352434675043373`*^9}, {3.635243813960328*^9, 
   3.635243822158979*^9}, {3.635244352709691*^9, 3.635244388082972*^9}, {
   3.635245847163414*^9, 3.635245859834177*^9}, {3.635246058442347*^9, 
   3.635246073881565*^9}, 3.63524698156813*^9, {3.635247043946949*^9, 
   3.635247109443775*^9}, {3.635247636172387*^9, 3.6352476510667973`*^9}, {
   3.6352479635140123`*^9, 3.635247972288959*^9}, {3.6352480741080236`*^9, 
   3.635248257722981*^9}, {3.635248305953784*^9, 3.635248333781055*^9}, 
   3.635248388335431*^9, {3.6352484240785093`*^9, 3.635248473592431*^9}, {
   3.63596563776789*^9, 3.635965694102504*^9}, {3.635965764100739*^9, 
   3.6359658210274363`*^9}, {3.6359658661230097`*^9, 3.635965866498291*^9}, {
   3.635966137924721*^9, 3.635966138867716*^9}, {3.654583606784337*^9, 
   3.654583624629924*^9}, {3.65458381333418*^9, 3.654583928334557*^9}, 
   3.654584032428206*^9, 3.68207197327964*^9, {3.6820720370924788`*^9, 
   3.682072112263515*^9}, {3.6906245300746403`*^9, 3.690624678306072*^9}, {
   3.690624911221984*^9, 3.690625047879733*^9}, {3.690625334719833*^9, 
   3.690625335703767*^9}, {3.6906260286159763`*^9, 3.690626028741235*^9}, {
   3.6906260913301077`*^9, 3.690626092025943*^9}, 3.690626326110546*^9, {
   3.690626558755538*^9, 3.6906266183596573`*^9}, 3.693814622803481*^9, {
   3.74574372533637*^9, 3.745743809861624*^9}, {3.745744071805634*^9, 
   3.745744159266605*^9}, {3.7457443472529573`*^9, 3.745744352978024*^9}, {
   3.7457443834921503`*^9, 3.7457444259933357`*^9}, {3.7457444756030493`*^9, 
   3.745744477548991*^9}, {3.745809558323009*^9, 3.745809564607749*^9}, {
   3.753711621668584*^9, 3.753711668737706*^9}, 3.753712593483057*^9},
 CellLabel->
  "In[480]:=",ExpressionUUID->"51b85ad4-3fa1-4f48-a23d-429265fdb449"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Scattering system presets", "Subsubsection",
 CellChangeTimes->{{3.6352402641349173`*^9, 3.635240266686254*^9}, {
  3.635248509709813*^9, 3.635248513716887*^9}, {3.635248635470749*^9, 
  3.635248643502573*^9}},ExpressionUUID->"b55be332-a3d7-4651-a0ea-\
92288ade4811"],

Cell["Hybrid Nanowires - Units in meV, nm and Tesla", "Text",
 CellChangeTimes->{{3.635243588793343*^9, 3.6352435922167273`*^9}, {
  3.6352502941970654`*^9, 3.635250311644638*^9}, {3.6352511401810913`*^9, 
  3.635251141051386*^9}, {3.635667358005726*^9, 
  3.635667363116169*^9}},ExpressionUUID->"ee51b2f6-1d03-4d64-8649-\
4ca5fa50adb9"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"UnitConvert", "[", 
   FractionBox[
    RowBox[{
     RowBox[{"Quantity", "[", "\"\<Tesla\>\"", "]"}], 
     RowBox[{"Quantity", "[", "\"\<nm\>\"", "]"}], 
     RowBox[{
      RowBox[{"Quantity", "[", "\"\<ElectronCharge\>\"", "]"}], "/", 
      RowBox[{"Quantity", "[", "\"\<ReducedPlanckConstant\>\"", "]"}]}]}], 
    RowBox[{"1", "/", 
     RowBox[{"Quantity", "[", "\"\<nm\>\"", "]"}]}]], "]"}], "*)"}]], "Input",\

 CellChangeTimes->{{3.635667530015151*^9, 3.635667556859211*^9}, {
   3.635667702927332*^9, 3.63566776452941*^9}, 3.636109649675804*^9},
 CellLabel->
  "In[481]:=",ExpressionUUID->"0f526d64-7c17-4c63-8842-8ab1691b596d"],

Cell["\<\
Multimode quasi1D nanowire.
FermiEnergy and Pairing can be either a number, a list of values for each \
segment (including leads), or a list of pairs {value, smoothness}\
\>", "Text",
 CellChangeTimes->{{3.635582528449492*^9, 3.63558253466497*^9}, {
   3.635662718384729*^9, 3.6356627333043613`*^9}, 3.635858078523466*^9, 
   3.635858120995626*^9},ExpressionUUID->"aad08327-1dfb-48e2-8639-\
376bddf9de5d"],

Cell[TextData[StyleBox["ALERT: Is the gauge field Nambufied?",
 FontWeight->"Bold"]], "Text",
 CellChangeTimes->{{3.638699027558127*^9, 3.6386990354702597`*^9}, {
  3.63869907900394*^9, 
  3.6386990866834908`*^9}},ExpressionUUID->"595b6675-407e-4fee-88bc-\
57cb8e85c1d2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ScatteringSystemPreset", "[", 
   RowBox[{"\"\<HybridNanowire\>\"", ",", " ", 
    RowBox[{"OptionsPattern", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Lengths", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{"400", ",", "400", ",", "400"}], "}"}]}], ",", 
       RowBox[{"LatticeConstant", "\[Rule]", "10"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Flux", "\[Rule]", "0"}], ",", 
       RowBox[{"GaugeField", "\[Rule]", "Automatic"}], ",", 
       RowBox[{"Rashba", "\[Rule]", "20"}], ",", 
       RowBox[{"Zeeman", "\[Rule]", "0"}], ",", 
       RowBox[{"EffectiveMass", "\[Rule]", "0.015"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"FermiEnergy", "\[Rule]", "0"}], ",", " ", 
       RowBox[{"Pairing", "\[Rule]", "0"}], ",", " ", 
       RowBox[{"WeakLinks", "\[Rule]", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"Modes", "\[Rule]", "1"}], ",", "\[IndentingNewLine]", 
       RowBox[{"CouplingFactor", "\[Rule]", "1"}]}], "}"}], "]"}]}], "]"}], ":=",
   "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[HBar]\[HBar]ome", "=", "76.1996"}], ",", " ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"This", " ", "is", " ", 
         RowBox[{
          SuperscriptBox["\[HBar]", "2"], "/", 
          SubscriptBox["m", "e"]}]}], ",", " ", 
        RowBox[{
        "in", " ", "units", " ", "of", " ", "meV", " ", "and", " ", "nm"}]}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"eo\[HBar]", "=", "0.001519"}], ",", " ", 
      RowBox[{"(*", 
       RowBox[{"This", " ", "is", " ", 
        RowBox[{"e", "/", "\[HBar]"}], " ", "in", " ", "units", " ", "of", 
        " ", "Tesla", " ", "and", " ", "nm"}], "*)"}], "\[IndentingNewLine]", 
      
      RowBox[{"m", "=", 
       RowBox[{"OptionValue", "@", "EffectiveMass"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"L", "=", 
       RowBox[{"OptionValue", "@", "Lengths"}]}], ",", "\[IndentingNewLine]", 
      
      RowBox[{"Bf", "=", 
       RowBox[{"OptionValue", "@", "Zeeman"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\[Alpha]", "=", 
       RowBox[{"OptionValue", "@", "Rashba"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"a0", "=", 
       RowBox[{"OptionValue", "@", "LatticeConstant"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"nmodes", "=", 
       RowBox[{"OptionValue", "@", "Modes"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"pairings", "=", 
       RowBox[{"OptionValue", "[", "Pairing", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"fermienergies", "=", 
       RowBox[{"OptionValue", "[", "FermiEnergy", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"flux", "=", 
       RowBox[{"OptionValue", "@", "Flux"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"Agauge", "=", 
       RowBox[{"OptionValue", "@", "GaugeField"}]}], ",", 
      "\[IndentingNewLine]", "weaklinksites", ",", "weaklinkhops", ",", 
      "\[IndentingNewLine]", "tag1", ",", "tag2", ",", "tag", ",", 
      "\[IndentingNewLine]", "\[Mu]", ",", "\[Delta]L\[Mu]", ",", " ", 
      "\[CapitalDelta]", ",", "\[Delta]L\[CapitalDelta]", ",", 
      "\[CapitalDelta]f", ",", "\[Mu]f", ",", "B", ",", "\[IndentingNewLine]",
       "WLf", ",", "x", ",", "y", ",", "x1", ",", "x2", ",", "y1", ",", "y2", 
      ",", "\[IndentingNewLine]", "t", ",", "d0", ",", "Hhopping", ",", " ", 
      "Honsite", ",", "Lmin", ",", "Lmax", ",", " ", "lat0", ",", " ", "latC",
       ",", " ", "latR", ",", " ", "latL"}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "@", "fermienergies"}], "===", "Function"}], ",", 
       RowBox[{"\[Mu]f", "=", "fermienergies"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "@", "fermienergies"}], "=!=", "List"}], ",", 
          RowBox[{
           RowBox[{"\[Mu]", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"fermienergies", ",", 
              RowBox[{
               RowBox[{"Length", "@", "L"}], "+", "2"}]}], "]"}]}], ";", 
           RowBox[{"\[Delta]L\[Mu]", "=", 
            RowBox[{"0", 
             RowBox[{"Most", "@", "\[Mu]"}]}]}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"VectorQ", "@", "fermienergies"}], ",", 
            RowBox[{
             RowBox[{"\[Mu]", "=", "fermienergies"}], ";", 
             RowBox[{"\[Delta]L\[Mu]", "=", 
              RowBox[{"0", 
               RowBox[{"Most", "@", "\[Mu]"}]}]}]}], ",", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[Mu]", ",", "\[Delta]L\[Mu]"}], "}"}], "=", 
             "fermienergies"}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\[Mu]f", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"x_", ",", "y_"}], "}"}], ",", "tag_"}], "]"}], "=", 
         RowBox[{
          RowBox[{"SmoothCurve", "[", 
           RowBox[{"{", 
            RowBox[{"L", ",", "\[Mu]", ",", "\[Delta]L\[Mu]"}], "}"}], "]"}], 
          "[", "x", "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "@", "pairings"}], "===", "Function"}], ",", 
       RowBox[{"\[CapitalDelta]f", "=", "pairings"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "@", "pairings"}], "=!=", "List"}], ",", 
          RowBox[{
           RowBox[{"\[CapitalDelta]", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"pairings", ",", 
              RowBox[{
               RowBox[{"Length", "@", "L"}], "+", "2"}]}], "]"}]}], ";", 
           RowBox[{"\[Delta]L\[CapitalDelta]", "=", 
            RowBox[{"0", 
             RowBox[{"Most", "@", "\[CapitalDelta]"}]}]}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"VectorQ", "@", "pairings"}], ",", 
            RowBox[{
             RowBox[{"\[CapitalDelta]", "=", "pairings"}], ";", 
             RowBox[{"\[Delta]L\[CapitalDelta]", "=", 
              RowBox[{"0", 
               RowBox[{"Most", "@", "\[CapitalDelta]"}]}]}]}], ",", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[CapitalDelta]", ",", "\[Delta]L\[CapitalDelta]"}], 
              "}"}], "=", "pairings"}]}], "]"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\[CapitalDelta]f", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"x_", ",", "y_"}], "}"}], ",", "tag_"}], "]"}], "=", 
         RowBox[{
          RowBox[{"SmoothCurve", "[", 
           RowBox[{"{", 
            RowBox[{
            "L", ",", "\[CapitalDelta]", ",", "\[Delta]L\[CapitalDelta]"}], 
            "}"}], "]"}], "[", "x", "]"}]}], ";"}]}], "\[IndentingNewLine]", 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"If", " ", "smoothnesses", " ", "are", " ", "provided"}], ",", 
       " ", 
       RowBox[{"leave", " ", "margin", " ", "for", " ", "tails"}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"Lmin", "=", 
      RowBox[{"-", 
       RowBox[{"Max", "[", 
        RowBox[{
         RowBox[{"Abs", "@", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"First", "@", "\[Delta]L\[CapitalDelta]"}], ",", 
            RowBox[{"First", "@", "\[Delta]L\[Mu]"}]}], "}"}]}], "/", "2"}], 
        "]"}]}]}], ";", 
     RowBox[{"Lmax", "=", 
      RowBox[{
       RowBox[{"Total", "@", "L"}], "+", 
       RowBox[{"Max", "[", 
        RowBox[{
         RowBox[{"Abs", "@", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Last", "@", "\[Delta]L\[CapitalDelta]"}], ",", 
            RowBox[{"Last", "@", "\[Delta]L\[Mu]"}]}], "}"}]}], "/", "2"}], 
        "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"lat0", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"\"\<Square\>\"", ",", 
        RowBox[{"LatticeConstant", "\[Rule]", "a0"}], ",", 
        RowBox[{"Bounded", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axes", "\[Rule]", 
            RowBox[{"{", "2", "}"}]}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"0", "\[LessEqual]", 
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "<", 
               RowBox[{"a0", " ", 
                RowBox[{"(", 
                 RowBox[{"nmodes", "-", ".01"}], ")"}]}]}], "&"}], ")"}]}]}], 
          "}"}]}], ",", 
        RowBox[{"Transform", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{".5", ",", "0"}], "}"}], "a0"}]}], ")"}], "&"}], 
          ")"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"latC", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"lat0", ",", " ", 
        RowBox[{"Supercell", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", "1", "}"}], "}"}]}], ",", " ", 
        RowBox[{"Bounded", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axes", "\[Rule]", 
            RowBox[{"{", "1", "}"}]}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Lmin", "<=", 
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "\[LessEqual]", "Lmax"}], 
              "&"}], ")"}]}]}], "}"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"latR", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"lat0", ",", 
        RowBox[{"Supercell", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", "1", "}"}], "}"}]}], ",", " ", 
        RowBox[{"Reshape", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axis", "\[Rule]", "1"}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Lmax", "<", 
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], "&"}], ")"}]}]}], "}"}]}]}],
        "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"latL", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"lat0", ",", 
        RowBox[{"Supercell", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"-", "1"}], "}"}], "}"}]}], ",", " ", 
        RowBox[{"Reshape", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axis", "\[Rule]", "1"}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "<", "Lmin"}], "&"}], 
             ")"}]}]}], "}"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"weaklinksites", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"First", "@", 
         RowBox[{"Nearest", "[", 
          RowBox[{
           RowBox[{"MovingAverage", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"latC", "[", "\"\<FlatSites\>\"", "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}], 
           ",", "#", ",", "1"}], "]"}]}], "&"}], "/@", 
       RowBox[{
        RowBox[{"OptionValue", "[", "WeakLinks", "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"weaklinkhops", "=", 
      RowBox[{
       RowBox[{"OptionValue", "[", "WeakLinks", "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"WLf", "[", "x_", "]"}], "=", 
      RowBox[{"Piecewise", "[", 
       RowBox[{
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"{", 
            RowBox[{"1", ",", 
             RowBox[{
              RowBox[{"x", "\[LessEqual]", "Lmin"}], "||", 
              RowBox[{"x", ">=", "Lmax"}]}]}], "}"}], "}"}], ",", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", 
              RowBox[{
               RowBox[{"Abs", "[", 
                RowBox[{"x", "-", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "<", 
               RowBox[{".1", "a0"}]}]}], "}"}], "&"}], "/@", 
           RowBox[{"Transpose", "[", 
            RowBox[{"{", 
             RowBox[{"weaklinksites", ",", "weaklinkhops"}], "}"}], "]"}]}]}],
          "]"}], ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "@", "Bf"}], "===", "Function"}], ",", 
       RowBox[{"B", "=", "Bf"}], ",", 
       RowBox[{"B", "=", 
        RowBox[{"Bf", "&"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Agauge", "===", "Automatic"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Clear", "[", "Agauge", "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "[", "flux", "]"}], "===", "Function"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Agauge", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x_", ",", "y_"}], "}"}], ",", "tag1_", ",", "tag2_"}], 
            "]"}], "=", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"-", 
              RowBox[{"Integrate", "[", 
               RowBox[{
                RowBox[{"flux", "[", 
                 RowBox[{"y", ",", " ", "tag1", ",", "tag2"}], "]"}], ",", 
                "x"}], "]"}]}], ",", "y"}], "}"}]}], ",", " ", 
          RowBox[{
           RowBox[{"Agauge", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x_", ",", "y_"}], "}"}], ",", "tag1_", ",", "tag2_"}], 
            "]"}], "=", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"-", "y"}], " ", "flux"}], ",", "0"}], "}"}]}]}], "]"}],
         ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"!", 
           RowBox[{"NumericQ", "[", 
            RowBox[{"Total", "@", 
             RowBox[{"Agauge", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"0", ",", "0"}], "}"}], ",", "\"\<A\>\"", ",", 
               "\"\<A\>\""}], "]"}]}], "]"}]}], ",", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{"ScatteringSystemPreset", "::", "flux"}], "]"}], ";", 
           RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"t", "=", 
      FractionBox["\[HBar]\[HBar]ome", 
       RowBox[{"2", " ", "m", " ", 
        SuperscriptBox["a0", "2"]}]]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Honsite", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x_", ",", "y_"}], "}"}], ",", " ", "tag_"}], "]"}], "=", 
      RowBox[{
       RowBox[{"(", GridBox[{
          {
           RowBox[{
            RowBox[{"2", "t"}], " ", "+", 
            RowBox[{"B", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}]}], "0", "0", "0"},
          {"0", 
           RowBox[{
            RowBox[{"2", "t"}], "-", 
            RowBox[{"B", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}]}], "0", "0"},
          {"0", "0", 
           RowBox[{
            RowBox[{
             RowBox[{"-", "2"}], "t"}], "-", 
            RowBox[{"B", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}]}], "0"},
          {"0", "0", "0", 
           RowBox[{
            RowBox[{
             RowBox[{"-", "2"}], "t"}], "+", 
            RowBox[{"B", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}]}]}
         }], ")"}], "+", 
       RowBox[{"(", GridBox[{
          {
           RowBox[{"-", 
            RowBox[{"\[Mu]f", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}]}], "0", 
           "0", "0"},
          {"0", 
           RowBox[{"-", 
            RowBox[{"\[Mu]f", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}]}], "0", 
           "0"},
          {"0", "0", 
           RowBox[{"\[Mu]f", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}], "0"},
          {"0", "0", "0", 
           RowBox[{"\[Mu]f", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}]}
         }], ")"}], "+", 
       RowBox[{"(", GridBox[{
          {"0", "0", "0", 
           RowBox[{
            RowBox[{"\[CapitalDelta]f", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}], 
            "\[Conjugate]"}]},
          {"0", "0", 
           RowBox[{"-", 
            RowBox[{
             RowBox[{"\[CapitalDelta]f", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}], 
             "\[Conjugate]"}]}], "0"},
          {"0", 
           RowBox[{"-", 
            RowBox[{"\[CapitalDelta]f", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}]}], "0", 
           "0"},
          {
           RowBox[{"\[CapitalDelta]f", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}], "0", "0", 
           "0"}
         }], ")"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Hhopping", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x1_", ",", "y1_"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"x2_", ",", "y2_"}], "}"}], ",", " ", "tag1_", ",", 
        "tag2_"}], "]"}], "=", 
      RowBox[{
       RowBox[{"WLf", "[", 
        FractionBox[
         RowBox[{"x1", "+", "x2"}], "2"], "]"}], 
       SuperscriptBox["\[ExponentialE]", 
        RowBox[{"\[ImaginaryI]", " ", "eo\[HBar]", " ", 
         RowBox[{"{", 
          RowBox[{"1", ",", "1", ",", 
           RowBox[{"-", "1"}], ",", 
           RowBox[{"-", "1"}]}], "}"}], " ", 
         RowBox[{
          RowBox[{"Agauge", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              FractionBox[
               RowBox[{"x1", "+", "x2"}], "2"], ",", 
              FractionBox[
               RowBox[{"y1", "+", "y2"}], "2"]}], "}"}], ",", "tag1", ",", 
            " ", "tag2"}], "]"}], ".", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x2", "-", "x1"}], ",", 
            RowBox[{"y2", "-", "y1"}]}], "}"}]}]}]], 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"(", GridBox[{
            {
             RowBox[{"-", "t"}], "0", "0", "0"},
            {"0", 
             RowBox[{"-", "t"}], "0", "0"},
            {"0", "0", "t", "0"},
            {"0", "0", "0", "t"}
           }], ")"}], "+", 
         RowBox[{"\[Alpha]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             FractionBox[
              RowBox[{
               RowBox[{"-", "\[ImaginaryI]"}], " ", 
               RowBox[{"Sign", "[", 
                RowBox[{"x2", "-", "x1"}], "]"}]}], 
              RowBox[{"2", " ", "a0"}]], 
             RowBox[{"(", GridBox[{
                {"0", 
                 RowBox[{"-", "\[ImaginaryI]"}], "0", "0"},
                {"\[ImaginaryI]", "0", "0", "0"},
                {"0", "0", "0", "\[ImaginaryI]"},
                {"0", "0", 
                 RowBox[{"-", "\[ImaginaryI]"}], "0"}
               }], ")"}]}], "-", 
            RowBox[{
             FractionBox[
              RowBox[{
               RowBox[{"-", "\[ImaginaryI]"}], " ", 
               RowBox[{"Sign", "[", 
                RowBox[{"y2", "-", "y1"}], "]"}]}], 
              RowBox[{"2", " ", "a0"}]], 
             RowBox[{"(", GridBox[{
                {"0", "1", "0", "0"},
                {"1", "0", "0", "0"},
                {"0", "0", "0", "1"},
                {"0", "0", "1", "0"}
               }], ")"}]}]}], ")"}]}]}], ")"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"BuildScatteringSystem", "[", 
      RowBox[{"latC", ",", 
       RowBox[{"{", 
        RowBox[{"latL", ",", "latR"}], "}"}], ",", 
       RowBox[{"HoppingRange", "\[Rule]", 
        RowBox[{"1.01", "a0"}]}], ",", 
       RowBox[{"Onsite", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Honsite", "[", 
           RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ")"}]}], ",", 
       RowBox[{"Hopping", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Hhopping", "[", 
           RowBox[{"#1", ",", "#2", ",", "#3", ",", "#4"}], "]"}], "&"}], 
         ")"}]}], ",", " ", 
       RowBox[{"Nambu", "\[Rule]", "True"}], ",", " ", 
       RowBox[{"EmbedLattice", "\[Rule]", "True"}], ",", 
       RowBox[{"CouplingFactor", "\[Rule]", 
        RowBox[{"OptionValue", "[", "CouplingFactor", "]"}]}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.635240268024884*^9, 3.6352402706222773`*^9}, {
   3.635242761922876*^9, 3.635242773018227*^9}, {3.635242904742634*^9, 
   3.6352430350478086`*^9}, 3.635243131867131*^9, {3.635243163724584*^9, 
   3.635243285603879*^9}, {3.635243322183723*^9, 3.6352433258953333`*^9}, {
   3.635243413843079*^9, 3.6352434675043373`*^9}, {3.635243813960328*^9, 
   3.635243822158979*^9}, {3.635244352709691*^9, 3.635244388082972*^9}, {
   3.635245847163414*^9, 3.635245859834177*^9}, {3.635246058442347*^9, 
   3.635246073881565*^9}, 3.63524698156813*^9, {3.635247043946949*^9, 
   3.635247109443775*^9}, {3.635247636172387*^9, 3.6352476510667973`*^9}, {
   3.6352479635140123`*^9, 3.635247972288959*^9}, {3.6352480741080236`*^9, 
   3.635248257722981*^9}, {3.635248305953784*^9, 3.635248333781055*^9}, 
   3.635248388335431*^9, {3.6352484240785093`*^9, 3.635248473592431*^9}, {
   3.635248516126663*^9, 3.635248555860209*^9}, {3.635248626417906*^9, 
   3.635248649518626*^9}, {3.635250172989195*^9, 3.635250175563641*^9}, {
   3.635250284558476*^9, 3.635250285925956*^9}, {3.635250328878433*^9, 
   3.6352503705094557`*^9}, {3.635250462036043*^9, 3.635250486600439*^9}, {
   3.63525057061973*^9, 3.6352508302387047`*^9}, {3.63525091187572*^9, 
   3.6352510103178596`*^9}, {3.635251072130802*^9, 3.635251075451931*^9}, {
   3.635505585970664*^9, 3.63550570112642*^9}, {3.6355074981826563`*^9, 
   3.635507638612836*^9}, {3.635507669459896*^9, 3.635507772199223*^9}, {
   3.635508948928389*^9, 3.635508957109768*^9}, {3.635517716978877*^9, 
   3.635517726161366*^9}, {3.6355177579771347`*^9, 3.635517847000959*^9}, {
   3.6355178785267277`*^9, 3.6355179877719517`*^9}, {3.635518113354371*^9, 
   3.635518140161817*^9}, {3.635518239574399*^9, 3.635518352405554*^9}, {
   3.6355184858200607`*^9, 3.6355185703936777`*^9}, {3.635518752555869*^9, 
   3.635518764756246*^9}, {3.6355188684254513`*^9, 3.635518994581627*^9}, {
   3.635519031749248*^9, 3.635519070117453*^9}, {3.635519125779709*^9, 
   3.635519267756012*^9}, {3.635519335127901*^9, 3.635519349277349*^9}, {
   3.635519420941581*^9, 3.6355194254750147`*^9}, {3.635520505190023*^9, 
   3.635520538096972*^9}, {3.635520568637418*^9, 3.635520599005844*^9}, {
   3.635576785744869*^9, 3.635576848783383*^9}, 3.635586231264408*^9, {
   3.635586285268647*^9, 3.635586305208428*^9}, {3.635586367995511*^9, 
   3.63558637450037*^9}, {3.635588975755814*^9, 3.6355890698680573`*^9}, 
   3.635589160251978*^9, {3.63566168850879*^9, 3.635661760305048*^9}, 
   3.635661929008582*^9, {3.635662522525885*^9, 3.635662576037245*^9}, {
   3.635662640629084*^9, 3.635662669712874*^9}, {3.6356641236243267`*^9, 
   3.6356641257539883`*^9}, {3.635665236882888*^9, 3.635665294592527*^9}, {
   3.635666790627543*^9, 3.63566686641848*^9}, {3.6356677901113358`*^9, 
   3.6356678391906223`*^9}, 3.635667903211369*^9, {3.6358339247042913`*^9, 
   3.635833924809596*^9}, {3.635833961133306*^9, 3.635833961462796*^9}, {
   3.6358358927091637`*^9, 3.6358358991358347`*^9}, {3.63583609635461*^9, 
   3.635836244032666*^9}, {3.635836286084893*^9, 3.635836549619882*^9}, {
   3.6358366885513363`*^9, 3.6358367357328053`*^9}, {3.635836800142229*^9, 
   3.6358368195890636`*^9}, {3.635836849780366*^9, 3.635836888181932*^9}, {
   3.635836952357127*^9, 3.635837028107993*^9}, {3.635837282845181*^9, 
   3.635837296503085*^9}, {3.635837329433999*^9, 3.6358374044014187`*^9}, {
   3.6358376382533197`*^9, 3.635837640703828*^9}, 3.635847196916665*^9, {
   3.6358472578063993`*^9, 3.635847274385453*^9}, {3.635857374081032*^9, 
   3.635857380230832*^9}, {3.635857462820581*^9, 3.635857463322975*^9}, {
   3.635857509594614*^9, 3.635857510936513*^9}, {3.635857559254519*^9, 
   3.6358575593647423`*^9}, {3.635858029670295*^9, 3.635858030397043*^9}, {
   3.635858078534898*^9, 3.6358580785422792`*^9}, {3.635858121592765*^9, 
   3.635858122288402*^9}, {3.6361816965774527`*^9, 3.6361817089656143`*^9}, {
   3.636181852010211*^9, 3.636181852623076*^9}, {3.6366139259299726`*^9, 
   3.636613936062639*^9}, {3.636613993718198*^9, 3.636614032427166*^9}, {
   3.636615961934698*^9, 3.636615966188201*^9}, {3.636616177144948*^9, 
   3.63661618297253*^9}, {3.636617864630765*^9, 3.6366178795890913`*^9}, {
   3.6366179208520527`*^9, 3.6366179754082737`*^9}, {3.6366180281439743`*^9, 
   3.6366180285589037`*^9}, {3.637566023993618*^9, 3.637566101790267*^9}, {
   3.6375661544767933`*^9, 3.637566164401188*^9}, 3.6375692039200583`*^9, {
   3.6386075887576323`*^9, 3.6386075906205873`*^9}, {3.638607645939055*^9, 
   3.638607683177136*^9}, {3.638699068816073*^9, 3.6386990738721037`*^9}, {
   3.642328415791143*^9, 3.64232862024023*^9}, {3.642328689446299*^9, 
   3.642328723152273*^9}, {3.647161397184579*^9, 3.647161397774145*^9}, {
   3.650952620702929*^9, 3.650952621309206*^9}, {3.653127541595566*^9, 
   3.653127541803174*^9}, {3.653127581449687*^9, 3.653127581929269*^9}, {
   3.6538082903836*^9, 3.65380832094281*^9}, 3.653808578566065*^9, {
   3.654240164988298*^9, 3.6542402170010977`*^9}, {3.675399706976276*^9, 
   3.675399712014081*^9}, {3.675399774972405*^9, 3.675399800692781*^9}, {
   3.675399833052384*^9, 3.675399948426804*^9}, {3.675399988065844*^9, 
   3.675400036598209*^9}, {3.675400132090266*^9, 3.67540013341899*^9}, {
   3.675400360287569*^9, 3.675400409948403*^9}, {3.676025670884975*^9, 
   3.676025675994835*^9}, {3.676026260649603*^9, 3.676026260991742*^9}, 
   3.685962156397431*^9, 3.751986427669043*^9, {3.752471527386119*^9, 
   3.752471531528591*^9}, {3.75247158639295*^9, 3.752471589525258*^9}, {
   3.7524716344551153`*^9, 3.752471693178697*^9}, {3.752471859553142*^9, 
   3.7524718685109873`*^9}, {3.752473191783681*^9, 3.75247319398402*^9}, {
   3.752473235995928*^9, 3.7524732364438877`*^9}, {3.7524749948397017`*^9, 
   3.752475003856123*^9}},
 CellLabel->
  "In[482]:=",ExpressionUUID->"5eb08d9e-1d0b-4a12-8b97-90a7f7e658cc"],

Cell["\<\
Multimode nanowire with perpendicular finger as leads. FingerParameters are \
{Positions, CouplingLengths, FermiEnergy, Pairing}
FermiEnergy and Pairing can be either a number, a list of values for each \
segment, or a list of pairs {value, smoothness}\
\>", "Text",
 CellChangeTimes->{{3.635582587678446*^9, 3.635582600781705*^9}, {
  3.635589197809682*^9, 3.635589222735618*^9}, {3.635662199698176*^9, 
  3.635662232320385*^9}, {3.635858078556514*^9, 3.635858078571308*^9}, {
  3.63585811737219*^9, 
  3.635858123315342*^9}},ExpressionUUID->"a688fd3c-ae67-45b8-a708-\
3fdaded1b63b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ScatteringSystemPreset", "::", "flux"}], "=", 
   "\"\<Warning: computed gauge field is not numerical.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ScatteringSystemPreset", "[", 
   RowBox[{"\"\<HybridNanowireFingers\>\"", ",", " ", 
    RowBox[{"OptionsPattern", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Lengths", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{"400", ",", "400", ",", "400"}], "}"}]}], ",", 
       RowBox[{"LatticeConstant", "\[Rule]", "10"}], ",", " ", 
       RowBox[{"Rashba", "\[Rule]", "20"}], ",", 
       RowBox[{"Zeeman", "\[Rule]", "0"}], ",", 
       RowBox[{"EffectiveMass", "\[Rule]", "0.015"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Flux", "\[Rule]", "0"}], ",", 
       RowBox[{"GaugeField", "\[Rule]", "Automatic"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"FermiEnergy", "\[Rule]", "0"}], ",", " ", 
       RowBox[{"Pairing", "\[Rule]", "0"}], ",", " ", 
       RowBox[{"WeakLinks", "\[Rule]", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"Modes", "\[Rule]", "1"}], ",", " ", "\[IndentingNewLine]", 
       RowBox[{"FingerParameters", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"200", ",", "1000"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"200", ",", "200"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"10", ",", "10"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"4", ",", "4"}], "}"}]}], "}"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"CouplingFactor", "\[Rule]", "1"}]}], "}"}], "]"}]}], "]"}], ":=",
   "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[HBar]\[HBar]ome", "=", "76.1996"}], ",", " ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"This", " ", "is", " ", 
         RowBox[{
          SuperscriptBox["\[HBar]", "2"], "/", 
          SubscriptBox["m", "e"]}]}], ",", " ", 
        RowBox[{
        "in", " ", "units", " ", "of", " ", "meV", " ", "and", " ", "nm"}]}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"eo\[HBar]", "=", "0.001519"}], ",", " ", 
      RowBox[{"(*", 
       RowBox[{"This", " ", "is", " ", 
        RowBox[{"e", "/", "\[HBar]"}], " ", "in", " ", "units", " ", "of", 
        " ", "Tesla", " ", "and", " ", "nm"}], "*)"}], "\[IndentingNewLine]", 
      
      RowBox[{"m", "=", 
       RowBox[{"OptionValue", "@", "EffectiveMass"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"L", "=", 
       RowBox[{"OptionValue", "@", "Lengths"}]}], ",", "\[IndentingNewLine]", 
      
      RowBox[{"B", "=", 
       RowBox[{"OptionValue", "@", "Zeeman"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\[Alpha]", "=", 
       RowBox[{"OptionValue", "@", "Rashba"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"a0", "=", 
       RowBox[{"OptionValue", "@", "LatticeConstant"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"nmodes", "=", 
       RowBox[{"OptionValue", "@", "Modes"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"pairings", "=", 
       RowBox[{"OptionValue", "[", "Pairing", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"fermienergies", "=", 
       RowBox[{"OptionValue", "[", "FermiEnergy", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"posfingers", "=", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FingerParameters", "]"}], "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"widthfingers", "=", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FingerParameters", "]"}], "[", 
        RowBox[{"[", "2", "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\[Mu]fingers", "=", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FingerParameters", "]"}], "[", 
        RowBox[{"[", "3", "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\[CapitalDelta]fingers", "=", 
       RowBox[{
        RowBox[{"OptionValue", "[", "FingerParameters", "]"}], "[", 
        RowBox[{"[", "4", "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"flux", "=", 
       RowBox[{"OptionValue", "@", "Flux"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"Agauge", "=", 
       RowBox[{"OptionValue", "@", "GaugeField"}]}], ",", 
      "\[IndentingNewLine]", "tag1", ",", "tag2", ",", "tag", ",", 
      "\[IndentingNewLine]", "\[Mu]", ",", "\[Delta]L\[Mu]", ",", " ", 
      "\[CapitalDelta]", ",", "\[Delta]L\[CapitalDelta]", ",", " ", 
      "\[CapitalDelta]f", ",", "\[Mu]f", ",", "\[CapitalDelta]Ff", ",", " ", 
      "\[Mu]Ff", ",", "\[IndentingNewLine]", "WLf", ",", "x", ",", "y", ",", 
      "x1", ",", "x2", ",", "y1", ",", "y2", ",", "\[IndentingNewLine]", "t", 
      ",", "d0", ",", "Hhopping", ",", " ", "Honsite", ",", "Lmin", ",", 
      "Lmax", ",", " ", "lat0", ",", " ", "latC", ",", " ", "latFingers", ",",
       " ", "Ltot"}], "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{"Finger", " ", "functions"}], "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"\[CapitalDelta]Ff", "[", "x_", "]"}], "=", 
      RowBox[{"Piecewise", "[", 
       RowBox[{
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"#2", ",", 
             RowBox[{
              RowBox[{"Abs", "[", 
               RowBox[{"x", "-", "#1"}], "]"}], "<=", 
              RowBox[{"#3", "/", "2"}]}]}], "}"}], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{
           "posfingers", ",", "\[CapitalDelta]fingers", ",", "widthfingers"}],
            "}"}]}], "]"}], ",", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[Mu]Ff", "[", "x_", "]"}], "=", 
      RowBox[{"Piecewise", "[", 
       RowBox[{
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"#2", ",", 
             RowBox[{
              RowBox[{"Abs", "[", 
               RowBox[{"x", "-", "#1"}], "]"}], "<=", 
              RowBox[{"#3", "/", "2"}]}]}], "}"}], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{"posfingers", ",", "\[Mu]fingers", ",", "widthfingers"}], 
           "}"}]}], "]"}], ",", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "@", "fermienergies"}], "=!=", "List"}], ",", 
       RowBox[{
        RowBox[{"\[Mu]", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"fermienergies", ",", 
           RowBox[{"Length", "@", "L"}]}], "]"}]}], ";", 
        RowBox[{"\[Delta]L\[Mu]", "=", 
         RowBox[{"0", 
          RowBox[{"Most", "@", "\[Mu]"}]}]}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "@", 
           RowBox[{"Dimensions", "@", "fermienergies"}]}], "\[Equal]", "2"}], 
         ",", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\[Mu]", ",", "\[Delta]L\[Mu]"}], "}"}], "=", 
          RowBox[{"fermienergies", "\[Transpose]"}]}], ",", 
         RowBox[{
          RowBox[{"\[Mu]", "=", "fermienergies"}], ";", 
          RowBox[{"\[Delta]L\[Mu]", "=", 
           RowBox[{"0", 
            RowBox[{"Most", "@", "\[Mu]"}]}]}]}]}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "@", "pairings"}], "=!=", "List"}], ",", 
       RowBox[{
        RowBox[{"\[CapitalDelta]", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"pairings", ",", 
           RowBox[{"Length", "@", "L"}]}], "]"}]}], ";", 
        RowBox[{"\[Delta]L\[CapitalDelta]", "=", 
         RowBox[{"0", 
          RowBox[{"Most", "@", "\[CapitalDelta]"}]}]}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "@", 
           RowBox[{"Dimensions", "@", "pairings"}]}], "\[Equal]", "2"}], ",", 
         
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\[CapitalDelta]", ",", "\[Delta]L\[CapitalDelta]"}], 
           "}"}], "=", 
          RowBox[{"pairings", "\[Transpose]"}]}], ",", 
         RowBox[{
          RowBox[{"\[CapitalDelta]", "=", "pairings"}], ";", 
          RowBox[{"\[Delta]L\[CapitalDelta]", "=", 
           RowBox[{"0", 
            RowBox[{"Most", "@", "\[CapitalDelta]"}]}]}]}]}], "]"}]}], "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"If", " ", "smoothnesses", " ", "are", " ", "provided"}], ",", 
       " ", 
       RowBox[{"leave", " ", "margin", " ", "for", " ", "tails"}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"MatrixQ", "@", "fermienergies"}], " ", "||", " ", 
        RowBox[{"MatrixQ", "@", "pairings"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Lmin", "=", 
         RowBox[{
          RowBox[{"-", 
           RowBox[{"L", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], "/", "2"}]}], ";", 
        RowBox[{"Lmax", "=", 
         RowBox[{
          RowBox[{"Total", "@", "L"}], "+", 
          RowBox[{
           RowBox[{"L", "[", 
            RowBox[{"[", 
             RowBox[{"-", "1"}], "]"}], "]"}], "/", "2"}]}]}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Lmin", "=", "0"}], ";", 
        RowBox[{"Lmax", "=", 
         RowBox[{"Total", "@", "L"}]}]}]}], "\[IndentingNewLine]", "]"}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[CapitalDelta]f", "[", 
       RowBox[{"{", 
        RowBox[{"x_", ",", "y_"}], "}"}], "]"}], "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"0", "\[LessEqual]", "y", "<", 
         RowBox[{"a0", 
          RowBox[{"(", 
           RowBox[{"nmodes", "-", ".01"}], ")"}]}]}], ",", 
        RowBox[{
         RowBox[{"SmoothCurve", "[", 
          RowBox[{"{", 
           RowBox[{
           "L", ",", "\[CapitalDelta]", ",", "\[Delta]L\[CapitalDelta]"}], 
           "}"}], "]"}], "[", "x", "]"}], ",", 
        RowBox[{"\[CapitalDelta]Ff", "[", "x", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[Mu]f", "[", 
       RowBox[{"{", 
        RowBox[{"x_", ",", "y_"}], "}"}], "]"}], "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"0", "\[LessEqual]", "y", "<", 
         RowBox[{"a0", 
          RowBox[{"(", 
           RowBox[{"nmodes", "-", ".01"}], ")"}]}]}], ",", 
        RowBox[{
         RowBox[{"SmoothCurve", "[", 
          RowBox[{"{", 
           RowBox[{"L", ",", "\[Mu]", ",", "\[Delta]L\[Mu]"}], "}"}], "]"}], 
         "[", "x", "]"}], ",", 
        RowBox[{"\[Mu]Ff", "[", "x", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"WLf", "[", 
       RowBox[{"{", 
        RowBox[{"x_", ",", "y_"}], "}"}], "]"}], "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"0", "\[LessEqual]", "y", "<", 
         RowBox[{"a0", 
          RowBox[{"(", 
           RowBox[{"nmodes", "-", ".01"}], ")"}]}]}], ",", 
        RowBox[{"Piecewise", "[", 
         RowBox[{
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"{", 
              RowBox[{"1", ",", 
               RowBox[{
                RowBox[{"x", "\[LessEqual]", "Lmin"}], "||", 
                RowBox[{"x", ">=", "Lmax"}]}]}], "}"}], "}"}], ",", 
            RowBox[{
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", "2", "]"}], "]"}], ",", 
                RowBox[{
                 RowBox[{"Abs", "[", 
                  RowBox[{"x", "-", 
                   RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "<", 
                 RowBox[{".5", "a0"}]}]}], "}"}], "&"}], "/@", 
             RowBox[{"OptionValue", "@", "WeakLinks"}]}]}], "]"}], ",", "1"}],
          "]"}], ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Agauge", "===", "Automatic"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "[", "flux", "]"}], "===", "Function"}], ",", 
          RowBox[{
           RowBox[{"Agauge", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x_", ",", "y_"}], "}"}], ",", "tag1_", ",", "tag2_"}], 
            "]"}], "=", 
           RowBox[{"{", 
            RowBox[{"0", ",", 
             RowBox[{"Integrate", "[", 
              RowBox[{
               RowBox[{"flux", "[", 
                RowBox[{"x", ",", " ", "tag1", ",", "tag2"}], "]"}], ",", 
               "x"}], "]"}]}], "}"}]}], ",", " ", 
          RowBox[{
           RowBox[{"Agauge", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x_", ",", "y_"}], "}"}], ",", "tag1_", ",", "tag2_"}], 
            "]"}], "=", 
           RowBox[{"{", 
            RowBox[{"0", ",", 
             RowBox[{"x", " ", "flux"}]}], "}"}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"!", 
           RowBox[{"NumericQ", "[", 
            RowBox[{"Total", "@", 
             RowBox[{"Agauge", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"0", ",", "0"}], "}"}], ",", "\"\<A\>\"", ",", 
               "\"\<A\>\""}], "]"}]}], "]"}]}], ",", 
          RowBox[{"Message", "[", 
           RowBox[{"ScatteringSystemPreset", "::", "flux"}], "]"}]}], "]"}], 
        ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"t", "=", 
      FractionBox["\[HBar]\[HBar]ome", 
       RowBox[{"2", " ", "m", " ", 
        SuperscriptBox["a0", "2"]}]]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Honsite", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x_", ",", "y_"}], "}"}], ",", " ", "tag_"}], "]"}], "=", 
      RowBox[{
       RowBox[{"(", GridBox[{
          {
           RowBox[{
            RowBox[{"2", "t"}], " ", "+", "B"}], "0", "0", "0"},
          {"0", 
           RowBox[{
            RowBox[{"2", "t"}], "-", "B"}], "0", "0"},
          {"0", "0", 
           RowBox[{
            RowBox[{
             RowBox[{"-", "2"}], "t"}], "-", "B"}], "0"},
          {"0", "0", "0", 
           RowBox[{
            RowBox[{
             RowBox[{"-", "2"}], "t"}], "+", "B"}]}
         }], ")"}], "+", 
       RowBox[{"(", GridBox[{
          {
           RowBox[{"-", 
            RowBox[{"\[Mu]f", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}]}], "0", "0", "0"},
          {"0", 
           RowBox[{"-", 
            RowBox[{"\[Mu]f", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}]}], "0", "0"},
          {"0", "0", 
           RowBox[{"\[Mu]f", "[", 
            RowBox[{"{", 
             RowBox[{"x", ",", "y"}], "}"}], "]"}], "0"},
          {"0", "0", "0", 
           RowBox[{"\[Mu]f", "[", 
            RowBox[{"{", 
             RowBox[{"x", ",", "y"}], "}"}], "]"}]}
         }], ")"}], "+", 
       RowBox[{"(", GridBox[{
          {"0", "0", "0", 
           RowBox[{
            RowBox[{"\[CapitalDelta]f", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}], "\[Conjugate]"}]},
          {"0", "0", 
           RowBox[{"-", 
            RowBox[{
             RowBox[{"\[CapitalDelta]f", "[", 
              RowBox[{"{", 
               RowBox[{"x", ",", "y"}], "}"}], "]"}], "\[Conjugate]"}]}], "0"},
          {"0", 
           RowBox[{"-", 
            RowBox[{"\[CapitalDelta]f", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}]}], "0", "0"},
          {
           RowBox[{"\[CapitalDelta]f", "[", 
            RowBox[{"{", 
             RowBox[{"x", ",", "y"}], "}"}], "]"}], "0", "0", "0"}
         }], ")"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Hhopping", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x1_", ",", "y1_"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"x2_", ",", "y2_"}], "}"}], ",", " ", "tag1_", ",", " ", 
        "tag2_"}], "]"}], "=", 
      RowBox[{
       RowBox[{"WLf", "[", 
        RowBox[{"{", 
         RowBox[{
          FractionBox[
           RowBox[{"x1", "+", "x2"}], "2"], ",", 
          FractionBox[
           RowBox[{"y1", "+", "y2"}], "2"]}], "}"}], "]"}], 
       SuperscriptBox["\[ExponentialE]", 
        RowBox[{"\[ImaginaryI]", " ", "eo\[HBar]", " ", 
         RowBox[{"{", 
          RowBox[{"1", ",", "1", ",", 
           RowBox[{"-", "1"}], ",", 
           RowBox[{"-", "1"}]}], "}"}], 
         RowBox[{
          RowBox[{"Agauge", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              FractionBox[
               RowBox[{"x1", "+", "x2"}], "2"], ",", 
              FractionBox[
               RowBox[{"y1", "+", "y2"}], "2"]}], "}"}], ",", "tag1", ",", 
            " ", "tag2"}], "]"}], ".", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x2", "-", "x1"}], ",", 
            RowBox[{"y2", "-", "y1"}]}], "}"}]}]}]], 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"(", GridBox[{
            {
             RowBox[{"-", "t"}], "0", "0", "0"},
            {"0", 
             RowBox[{"-", "t"}], "0", "0"},
            {"0", "0", "t", "0"},
            {"0", "0", "0", "t"}
           }], ")"}], "+", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"tag1", "\[Equal]", "tag2", "\[Equal]", "\"\<A\>\""}], 
            ",", "1", ",", "0"}], "]"}], "\[Alpha]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             FractionBox[
              RowBox[{
               RowBox[{"-", "\[ImaginaryI]"}], " ", 
               RowBox[{"Sign", "[", 
                RowBox[{"x2", "-", "x1"}], "]"}]}], 
              RowBox[{"2", " ", "a0"}]], 
             RowBox[{"(", GridBox[{
                {"0", 
                 RowBox[{"-", "\[ImaginaryI]"}], "0", "0"},
                {"\[ImaginaryI]", "0", "0", "0"},
                {"0", "0", "0", "\[ImaginaryI]"},
                {"0", "0", 
                 RowBox[{"-", "\[ImaginaryI]"}], "0"}
               }], ")"}]}], "-", 
            RowBox[{
             FractionBox[
              RowBox[{
               RowBox[{"-", "\[ImaginaryI]"}], " ", 
               RowBox[{"Sign", "[", 
                RowBox[{"y2", "-", "y1"}], "]"}]}], 
              RowBox[{"2", " ", "a0"}]], 
             RowBox[{"(", GridBox[{
                {"0", "1", "0", "0"},
                {"1", "0", "0", "0"},
                {"0", "0", "0", "1"},
                {"0", "0", "1", "0"}
               }], ")"}]}]}], ")"}]}]}], ")"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"lat0", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"\"\<Square\>\"", ",", 
        RowBox[{"LatticeConstant", "\[Rule]", "a0"}], ",", 
        RowBox[{"Bounded", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axes", "\[Rule]", 
            RowBox[{"{", "2", "}"}]}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"0", "\[LessEqual]", 
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "<", 
               RowBox[{"a0", " ", 
                RowBox[{"(", 
                 RowBox[{"nmodes", "-", ".01"}], ")"}]}]}], "&"}], ")"}]}]}], 
          "}"}]}], ",", 
        RowBox[{"Transform", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{".5", "a0"}], ",", "0"}], "}"}]}], ")"}], "&"}], 
          ")"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"latC", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"lat0", ",", " ", 
        RowBox[{"Supercell", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", "1", "}"}], "}"}]}], ",", " ", 
        RowBox[{"Bounded", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axes", "\[Rule]", 
            RowBox[{"{", "1", "}"}]}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Lmin", "<=", 
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "\[LessEqual]", "Lmax"}], 
              "&"}], ")"}]}]}], "}"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"latFingers", "=", 
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"BuildLattice", "[", 
          RowBox[{"\"\<Square\>\"", ",", 
           RowBox[{"LatticeConstant", "\[Rule]", "a0"}], ",", 
           RowBox[{"Supercell", "->", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"OddQ", "[", "i", "]"}], ",", "1", ",", 
              RowBox[{"-", "1"}]}], "]"}]}], ",", 
           RowBox[{"Bounded", "\[Rule]", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Axes", "\[Rule]", 
               RowBox[{"{", "1", "}"}]}], ",", 
              RowBox[{"Region", "\[Rule]", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"-", 
                    RowBox[{"widthfingers", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], "/", "2"}], "<", 
                  RowBox[{
                   RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "-", 
                   RowBox[{"posfingers", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], "<=", 
                  RowBox[{
                   RowBox[{"widthfingers", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "/", "2"}]}], "&"}], 
                ")"}]}]}], "}"}]}], ",", 
           RowBox[{"Transform", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"#", "+", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"-", ".5"}], " ", "a0"}], ",", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"OddQ", "[", "i", "]"}], ",", 
                    RowBox[{"a0", " ", "nmodes"}], ",", 
                    RowBox[{"-", "a0"}]}], "]"}]}], "}"}]}], ")"}], "&"}], 
             ")"}]}]}], "]"}], "/.", 
         RowBox[{"\"\<A\>\"", "\[Rule]", 
          RowBox[{"ToString", "@", "i"}]}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", 
          RowBox[{"Length", "@", "posfingers"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"BuildScatteringSystem", "[", 
      RowBox[{"latC", ",", "latFingers", ",", 
       RowBox[{"HoppingRange", "\[Rule]", 
        RowBox[{"1.01", "a0"}]}], ",", 
       RowBox[{"Onsite", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Honsite", "[", 
           RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ")"}]}], ",", 
       RowBox[{"Hopping", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Hhopping", "[", 
           RowBox[{"#1", ",", "#2", ",", "#3", ",", "#4"}], "]"}], "&"}], 
         ")"}]}], ",", " ", 
       RowBox[{"Nambu", "\[Rule]", "True"}], ",", " ", 
       RowBox[{"EmbedLattice", "\[Rule]", "True"}], ",", " ", 
       RowBox[{"CouplingFactor", "\[Rule]", 
        RowBox[{"OptionValue", "[", "CouplingFactor", "]"}]}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.635240268024884*^9, 3.6352402706222773`*^9}, {
   3.635242761922876*^9, 3.635242773018227*^9}, {3.635242904742634*^9, 
   3.6352430350478086`*^9}, 3.635243131867131*^9, {3.635243163724584*^9, 
   3.635243285603879*^9}, {3.635243322183723*^9, 3.6352433258953333`*^9}, {
   3.635243413843079*^9, 3.6352434675043373`*^9}, {3.635243813960328*^9, 
   3.635243822158979*^9}, {3.635244352709691*^9, 3.635244388082972*^9}, {
   3.635245847163414*^9, 3.635245859834177*^9}, {3.635246058442347*^9, 
   3.635246073881565*^9}, 3.63524698156813*^9, {3.635247043946949*^9, 
   3.635247109443775*^9}, {3.635247636172387*^9, 3.6352476510667973`*^9}, {
   3.6352479635140123`*^9, 3.635247972288959*^9}, {3.6352480741080236`*^9, 
   3.635248257722981*^9}, {3.635248305953784*^9, 3.635248333781055*^9}, 
   3.635248388335431*^9, {3.6352484240785093`*^9, 3.635248473592431*^9}, {
   3.635248516126663*^9, 3.635248555860209*^9}, {3.635248626417906*^9, 
   3.635248649518626*^9}, {3.635250172989195*^9, 3.635250175563641*^9}, {
   3.635250284558476*^9, 3.635250285925956*^9}, {3.635250328878433*^9, 
   3.6352503705094557`*^9}, {3.635250462036043*^9, 3.635250486600439*^9}, {
   3.63525057061973*^9, 3.6352508302387047`*^9}, {3.63525091187572*^9, 
   3.6352510103178596`*^9}, {3.635251072130802*^9, 3.635251075451931*^9}, {
   3.635505585970664*^9, 3.63550570112642*^9}, {3.6355074981826563`*^9, 
   3.635507638612836*^9}, {3.635507669459896*^9, 3.635507772199223*^9}, {
   3.635508948928389*^9, 3.635508957109768*^9}, {3.635517716978877*^9, 
   3.635517726161366*^9}, {3.6355177579771347`*^9, 3.635517847000959*^9}, {
   3.6355178785267277`*^9, 3.6355179877719517`*^9}, {3.635518113354371*^9, 
   3.635518140161817*^9}, {3.635518239574399*^9, 3.635518352405554*^9}, {
   3.6355184858200607`*^9, 3.6355185703936777`*^9}, {3.635518752555869*^9, 
   3.635518764756246*^9}, {3.6355188684254513`*^9, 3.635518994581627*^9}, {
   3.635519031749248*^9, 3.635519070117453*^9}, {3.635519125779709*^9, 
   3.635519267756012*^9}, {3.635519335127901*^9, 3.635519349277349*^9}, {
   3.635519420941581*^9, 3.6355194254750147`*^9}, {3.635520505190023*^9, 
   3.635520538096972*^9}, {3.635520568637418*^9, 3.635520599005844*^9}, {
   3.635576785744869*^9, 3.635576848783383*^9}, {3.6355826060405073`*^9, 
   3.635582630326763*^9}, {3.635582715754737*^9, 3.635582741201241*^9}, {
   3.6355858449465*^9, 3.635585856753448*^9}, {3.635585914430225*^9, 
   3.635585950204493*^9}, {3.6355859891551647`*^9, 3.635586021313691*^9}, {
   3.635586091461688*^9, 3.6355861693534527`*^9}, {3.635586199688944*^9, 
   3.6355862392861147`*^9}, {3.635586356131949*^9, 3.6355863612894793`*^9}, {
   3.635586392952669*^9, 3.635586454453147*^9}, {3.635586590030406*^9, 
   3.635586776813283*^9}, {3.6355868962309647`*^9, 3.6355869470924377`*^9}, {
   3.635587118145055*^9, 3.635587183369163*^9}, {3.6355873241318007`*^9, 
   3.635587357737638*^9}, {3.635587661538184*^9, 3.635587663233593*^9}, {
   3.63558792020551*^9, 3.6355880790454283`*^9}, {3.635588155938211*^9, 
   3.635588165977882*^9}, {3.635588250149643*^9, 3.635588258652253*^9}, 
   3.635588344629362*^9, 3.635588718253933*^9, {3.635588762023839*^9, 
   3.63558882463548*^9}, {3.635588864170803*^9, 3.635588969793888*^9}, {
   3.6355891164724216`*^9, 3.6355891547682743`*^9}, {3.635655518738608*^9, 
   3.635655557337723*^9}, {3.6356555990131063`*^9, 3.6356556063391743`*^9}, {
   3.63565564361944*^9, 3.635655679863202*^9}, {3.635660072737303*^9, 
   3.635660099060802*^9}, {3.6356601442127*^9, 3.6356603215243387`*^9}, {
   3.635660631699339*^9, 3.6356606570692577`*^9}, {3.635660944362176*^9, 
   3.635660995794723*^9}, {3.635661076199539*^9, 3.635661079390712*^9}, 
   3.635661212053589*^9, {3.635661298060069*^9, 3.635661477340324*^9}, {
   3.635661512016099*^9, 3.635661534697294*^9}, {3.6356615735106*^9, 
   3.6356616768315783`*^9}, 3.635661711200871*^9, {3.635661745363428*^9, 
   3.635661748653566*^9}, {3.6356619132302227`*^9, 3.63566192305895*^9}, {
   3.6356622675620728`*^9, 3.635662270979866*^9}, {3.635662326656378*^9, 
   3.6356625061299143`*^9}, {3.635662583274558*^9, 3.635662628899764*^9}, {
   3.635662697099495*^9, 3.6356626985429583`*^9}, {3.635662775930847*^9, 
   3.635662782691554*^9}, {3.635664073190312*^9, 3.635664155729166*^9}, {
   3.635665299990711*^9, 3.63566532459971*^9}, {3.635665534556801*^9, 
   3.635665574539453*^9}, {3.635665627455288*^9, 3.635665643301947*^9}, {
   3.6356657331633463`*^9, 3.6356657727377777`*^9}, {3.635665815191689*^9, 
   3.635665850133794*^9}, {3.6356659871674013`*^9, 3.635665987734449*^9}, {
   3.635666033717635*^9, 3.635666080756589*^9}, {3.635666119462748*^9, 
   3.635666123083226*^9}, {3.635666227635681*^9, 3.6356662587198353`*^9}, {
   3.635666298336207*^9, 3.6356663122384663`*^9}, {3.635666480477701*^9, 
   3.635666497853067*^9}, {3.635666647526783*^9, 3.635666670469961*^9}, {
   3.635666702027897*^9, 3.63566671566603*^9}, {3.6356667592329082`*^9, 
   3.635666778153347*^9}, {3.6356668808605413`*^9, 3.635666887047214*^9}, {
   3.6356678483660583`*^9, 3.635667895035741*^9}, {3.63582826595189*^9, 
   3.63582831495681*^9}, {3.635833897913352*^9, 3.6358339559112883`*^9}, {
   3.635837412366975*^9, 3.635837484194442*^9}, {3.635837515512227*^9, 
   3.635837558877062*^9}, {3.6358376283625107`*^9, 3.6358376362236757`*^9}, 
   3.635846802346313*^9, {3.635847192335875*^9, 3.635847237268959*^9}, {
   3.635847505540595*^9, 3.635847522068788*^9}, {3.635847599269087*^9, 
   3.6358476466892347`*^9}, {3.6358484037096786`*^9, 3.635848452155155*^9}, {
   3.63585561617321*^9, 3.635855620251835*^9}, {3.635855659963292*^9, 
   3.635855680897358*^9}, 3.6358575681748867`*^9, {3.635858031484536*^9, 
   3.635858032100956*^9}, {3.635858078495351*^9, 3.635858078502624*^9}, {
   3.63585811913687*^9, 3.635858119832844*^9}, {3.636614110382813*^9, 
   3.636614138952849*^9}, {3.636615949403561*^9, 3.636615973310075*^9}, {
   3.636616141887648*^9, 3.636616156086753*^9}, {3.6366178852389727`*^9, 
   3.6366178923822727`*^9}, 3.6386990976672773`*^9, {3.6538087912916937`*^9, 
   3.653808801747373*^9}, {3.682329580792691*^9, 3.6823295819288607`*^9}, 
   3.685962160605098*^9},
 CellLabel->
  "In[483]:=",ExpressionUUID->"dd67b214-e50e-49b8-b49d-b6482a24d2e7"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Normal nanowires", "Subsubsection",
 CellChangeTimes->{{3.6386988978938828`*^9, 
  3.6386989004365788`*^9}},ExpressionUUID->"103518bc-8512-4e33-857b-\
eada89ecb3b6"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ScatteringSystemPreset", "[", 
   RowBox[{"\"\<NormalNanowire\>\"", ",", " ", 
    RowBox[{"OptionsPattern", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Lengths", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{"400", ",", "400", ",", "400"}], "}"}]}], ",", 
       RowBox[{"LatticeConstant", "\[Rule]", "10"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Flux", "\[Rule]", "0"}], ",", 
       RowBox[{"GaugeField", "\[Rule]", "Automatic"}], ",", 
       RowBox[{"Rashba", "\[Rule]", "20"}], ",", 
       RowBox[{"Zeeman", "\[Rule]", "0"}], ",", 
       RowBox[{"EffectiveMass", "\[Rule]", "0.015"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"FermiEnergy", "\[Rule]", "0"}], ",", 
       RowBox[{"WeakLinks", "\[Rule]", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"Modes", "\[Rule]", "1"}], ",", "\[IndentingNewLine]", 
       RowBox[{"CouplingFactor", "\[Rule]", "1"}]}], "}"}], "]"}]}], "]"}], ":=",
   "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[HBar]\[HBar]ome", "=", "76.1996"}], ",", " ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"This", " ", "is", " ", 
         RowBox[{
          SuperscriptBox["\[HBar]", "2"], "/", 
          SubscriptBox["m", "e"]}]}], ",", " ", 
        RowBox[{
        "in", " ", "units", " ", "of", " ", "meV", " ", "and", " ", "nm"}]}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"eo\[HBar]", "=", "0.001519"}], ",", " ", 
      RowBox[{"(*", 
       RowBox[{"This", " ", "is", " ", 
        RowBox[{"e", "/", "\[HBar]"}], " ", "in", " ", "units", " ", "of", 
        " ", "Tesla", " ", "and", " ", "nm"}], "*)"}], "\[IndentingNewLine]", 
      
      RowBox[{"m", "=", 
       RowBox[{"OptionValue", "@", "EffectiveMass"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"L", "=", 
       RowBox[{"OptionValue", "@", "Lengths"}]}], ",", "\[IndentingNewLine]", 
      
      RowBox[{"Bf", "=", 
       RowBox[{"OptionValue", "@", "Zeeman"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"\[Alpha]", "=", 
       RowBox[{"OptionValue", "@", "Rashba"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"a0", "=", 
       RowBox[{"OptionValue", "@", "LatticeConstant"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"nmodes", "=", 
       RowBox[{"OptionValue", "@", "Modes"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"fermienergies", "=", 
       RowBox[{"OptionValue", "[", "FermiEnergy", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"flux", "=", 
       RowBox[{"OptionValue", "@", "Flux"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"Agauge", "=", 
       RowBox[{"OptionValue", "@", "GaugeField"}]}], ",", 
      "\[IndentingNewLine]", "tag1", ",", "tag2", ",", "tag", ",", 
      "weaklinksites", ",", "weaklinkhops", ",", "\[IndentingNewLine]", 
      "\[Mu]", ",", "\[Delta]L\[Mu]", ",", "\[Mu]f", ",", "B", ",", 
      "\[IndentingNewLine]", "WLf", ",", "x", ",", "y", ",", "x1", ",", "x2", 
      ",", "y1", ",", "y2", ",", "\[IndentingNewLine]", "t", ",", "d0", ",", 
      "Hhopping", ",", " ", "Honsite", ",", "Lmin", ",", "Lmax", ",", " ", 
      "lat0", ",", " ", "latC", ",", " ", "latR", ",", " ", "latL"}], "}"}], 
    ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Head", "@", "fermienergies"}], "=!=", "List"}], ",", 
        RowBox[{
         RowBox[{"\[Mu]", "=", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"fermienergies", ",", 
            RowBox[{
             RowBox[{"Length", "@", "L"}], "+", "2"}]}], "]"}]}], ";", 
         RowBox[{"\[Delta]L\[Mu]", "=", 
          RowBox[{"0", 
           RowBox[{"Most", "@", "\[Mu]"}]}]}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"VectorQ", "@", "fermienergies"}], ",", 
          RowBox[{
           RowBox[{"\[Mu]", "=", "fermienergies"}], ";", 
           RowBox[{"\[Delta]L\[Mu]", "=", 
            RowBox[{"0", 
             RowBox[{"Most", "@", "\[Mu]"}]}]}]}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\[Mu]", ",", "\[Delta]L\[Mu]"}], "}"}], "=", 
           "fermienergies"}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Head", "@", "pairings"}], "=!=", "List"}], ",", 
        RowBox[{
         RowBox[{"\[CapitalDelta]", "=", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"pairings", ",", 
            RowBox[{
             RowBox[{"Length", "@", "L"}], "+", "2"}]}], "]"}]}], ";", 
         RowBox[{"\[Delta]L\[CapitalDelta]", "=", 
          RowBox[{"0", 
           RowBox[{"Most", "@", "\[CapitalDelta]"}]}]}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"VectorQ", "@", "pairings"}], ",", 
          RowBox[{
           RowBox[{"\[CapitalDelta]", "=", "pairings"}], ";", 
           RowBox[{"\[Delta]L\[CapitalDelta]", "=", 
            RowBox[{"0", 
             RowBox[{"Most", "@", "\[CapitalDelta]"}]}]}]}], ",", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\[CapitalDelta]", ",", "\[Delta]L\[CapitalDelta]"}], 
            "}"}], "=", "pairings"}]}], "]"}]}], "]"}], ";"}], 
     "\[IndentingNewLine]", "*)"}], "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Head", "@", "fermienergies"}], "===", "Function"}], ",", 
        RowBox[{"\[Mu]f", "=", "fermienergies"}], ",", "\[IndentingNewLine]", 
        
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Head", "@", "fermienergies"}], "=!=", "List"}], ",", 
           RowBox[{
            RowBox[{"\[Mu]", "=", 
             RowBox[{"ConstantArray", "[", 
              RowBox[{"fermienergies", ",", 
               RowBox[{
                RowBox[{"Length", "@", "L"}], "+", "2"}]}], "]"}]}], ";", 
            RowBox[{"\[Delta]L\[Mu]", "=", 
             RowBox[{"0", 
              RowBox[{"Most", "@", "\[Mu]"}]}]}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"VectorQ", "@", "fermienergies"}], ",", 
             RowBox[{
              RowBox[{"\[Mu]", "=", "fermienergies"}], ";", 
              RowBox[{"\[Delta]L\[Mu]", "=", 
               RowBox[{"0", 
                RowBox[{"Most", "@", "\[Mu]"}]}]}]}], ",", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"\[Mu]", ",", "\[Delta]L\[Mu]"}], "}"}], "=", 
              "fermienergies"}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]",
          "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"\[Mu]f", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"x_", ",", "y_"}], "}"}], ",", "tag_"}], "]"}], "=", 
          RowBox[{
           RowBox[{"SmoothCurve", "[", 
            RowBox[{"{", 
             RowBox[{"L", ",", "\[Mu]", ",", "\[Delta]L\[Mu]"}], "}"}], "]"}],
            "[", "x", "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"If", " ", "smoothnesses", " ", "are", " ", "provided"}], ",",
         " ", 
        RowBox[{"leave", " ", "margin", " ", "for", " ", "tails"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"MatrixQ", "@", "fermienergies"}], " ", ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Lmin", "=", 
          RowBox[{
           RowBox[{"-", 
            RowBox[{"L", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], "/", "2"}]}], ";", 
         RowBox[{"Lmax", "=", 
          RowBox[{
           RowBox[{"Total", "@", "L"}], "+", 
           RowBox[{
            RowBox[{"L", "[", 
             RowBox[{"[", 
              RowBox[{"-", "1"}], "]"}], "]"}], "/", "2"}]}]}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Lmin", "=", "0"}], ";", 
         RowBox[{"Lmax", "=", 
          RowBox[{"Total", "@", "L"}]}]}]}], "\[IndentingNewLine]", "]"}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"lat0", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"\"\<Square\>\"", ",", 
        RowBox[{"LatticeConstant", "\[Rule]", "a0"}], ",", 
        RowBox[{"Bounded", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axes", "\[Rule]", 
            RowBox[{"{", "2", "}"}]}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"0", "\[LessEqual]", 
               RowBox[{"#", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "<", 
               RowBox[{"a0", " ", 
                RowBox[{"(", 
                 RowBox[{"nmodes", "-", ".01"}], ")"}]}]}], "&"}], ")"}]}]}], 
          "}"}]}], ",", 
        RowBox[{"Transform", "\[Rule]", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"#", "-", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{".5", ",", "0"}], "}"}], "a0"}]}], ")"}], "&"}], 
          ")"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"latC", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"lat0", ",", " ", 
        RowBox[{"Supercell", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", "1", "}"}], "}"}]}], ",", " ", 
        RowBox[{"Bounded", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axes", "\[Rule]", 
            RowBox[{"{", "1", "}"}]}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Lmin", "<=", 
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "\[LessEqual]", "Lmax"}], 
              "&"}], ")"}]}]}], "}"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"latR", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"lat0", ",", 
        RowBox[{"Supercell", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", "1", "}"}], "}"}]}], ",", " ", 
        RowBox[{"Reshape", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axis", "\[Rule]", "1"}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Lmax", "<", 
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], "&"}], ")"}]}]}], "}"}]}]}],
        "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"latL", "=", 
      RowBox[{"BuildLattice", "[", 
       RowBox[{"lat0", ",", 
        RowBox[{"Supercell", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"-", "1"}], "}"}], "}"}]}], ",", " ", 
        RowBox[{"Reshape", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Axis", "\[Rule]", "1"}], ",", 
           RowBox[{"Region", "\[Rule]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "<", "Lmin"}], "&"}], 
             ")"}]}]}], "}"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"weaklinksites", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"First", "@", 
         RowBox[{"Nearest", "[", 
          RowBox[{
           RowBox[{"MovingAverage", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"latC", "[", "\"\<FlatSites\>\"", "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}], 
           ",", "#", ",", "1"}], "]"}]}], "&"}], "/@", 
       RowBox[{
        RowBox[{"OptionValue", "[", "WeakLinks", "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"weaklinkhops", "=", 
      RowBox[{
       RowBox[{"OptionValue", "[", "WeakLinks", "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"WLf", "[", "x_", "]"}], "=", 
      RowBox[{"Piecewise", "[", 
       RowBox[{
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"{", 
            RowBox[{"1", ",", 
             RowBox[{
              RowBox[{"x", "\[LessEqual]", "Lmin"}], "||", 
              RowBox[{"x", ">=", "Lmax"}]}]}], "}"}], "}"}], ",", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", 
              RowBox[{
               RowBox[{"Abs", "[", 
                RowBox[{"x", "-", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "<", 
               RowBox[{".1", "a0"}]}]}], "}"}], "&"}], "/@", 
           RowBox[{"Transpose", "[", 
            RowBox[{"{", 
             RowBox[{"weaklinksites", ",", "weaklinkhops"}], "}"}], "]"}]}]}],
          "]"}], ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Agauge", "===", "Automatic"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Clear", "[", "Agauge", "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "[", "flux", "]"}], "===", "Function"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Agauge", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x_", ",", "y_"}], "}"}], ",", "tag1_", ",", "tag2_"}], 
            "]"}], "=", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"-", 
              RowBox[{"Integrate", "[", 
               RowBox[{
                RowBox[{"flux", "[", 
                 RowBox[{"y", ",", " ", "tag1", ",", "tag2"}], "]"}], ",", 
                "x"}], "]"}]}], ",", "y"}], "}"}]}], ",", " ", 
          RowBox[{
           RowBox[{"Agauge", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x_", ",", "y_"}], "}"}], ",", "tag1_", ",", "tag2_"}], 
            "]"}], "=", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"-", "y"}], " ", "flux"}], ",", "0"}], "}"}]}]}], "]"}],
         ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"!", 
           RowBox[{"NumericQ", "[", 
            RowBox[{"Total", "@", 
             RowBox[{"Agauge", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"0", ",", "0"}], "}"}], ",", "\"\<A\>\"", ",", 
               "\"\<A\>\""}], "]"}]}], "]"}]}], ",", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{"ScatteringSystemPreset", "::", "flux"}], "]"}], ";", 
           RowBox[{"Return", "[", "$Failed", "]"}]}]}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "@", "Bf"}], "===", "Function"}], ",", 
       RowBox[{"B", "=", "Bf"}], ",", 
       RowBox[{"B", "=", 
        RowBox[{"Bf", "&"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"t", "=", 
      FractionBox["\[HBar]\[HBar]ome", 
       RowBox[{"2", " ", "m", " ", 
        SuperscriptBox["a0", "2"]}]]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Honsite", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x_", ",", "y_"}], "}"}], ",", " ", "tag_"}], "]"}], "=", 
      RowBox[{
       RowBox[{"(", GridBox[{
          {
           RowBox[{
            RowBox[{"2", "t"}], "+", 
            RowBox[{"B", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}]}], "0"},
          {"0", 
           RowBox[{
            RowBox[{"2", "t"}], "-", 
            RowBox[{"B", "[", 
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], "]"}]}]}
         }], ")"}], "+", 
       RowBox[{"(", GridBox[{
          {
           RowBox[{"-", 
            RowBox[{"\[Mu]f", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}]}], "0"},
          {"0", 
           RowBox[{"-", 
            RowBox[{"\[Mu]f", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"x", ",", "y"}], "}"}], ",", "tag"}], "]"}]}]}
         }], ")"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Hhopping", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x1_", ",", "y1_"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"x2_", ",", "y2_"}], "}"}], ",", " ", "tag1_", ",", 
        "tag2_"}], "]"}], "=", 
      RowBox[{
       RowBox[{"WLf", "[", 
        FractionBox[
         RowBox[{"x1", "+", "x2"}], "2"], "]"}], 
       SuperscriptBox["\[ExponentialE]", 
        RowBox[{"\[ImaginaryI]", " ", "eo\[HBar]", " ", 
         RowBox[{
          RowBox[{"Agauge", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              FractionBox[
               RowBox[{"x1", "+", "x2"}], "2"], ",", 
              FractionBox[
               RowBox[{"y1", "+", "y2"}], "2"]}], "}"}], ",", "tag1", ",", 
            " ", "tag2"}], "]"}], ".", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x2", "-", "x1"}], ",", 
            RowBox[{"y2", "-", "y1"}]}], "}"}]}]}]], 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"(", GridBox[{
            {
             RowBox[{"-", "t"}], "0"},
            {"0", 
             RowBox[{"-", "t"}]}
           }], ")"}], "+", 
         RowBox[{"\[Alpha]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             FractionBox[
              RowBox[{
               RowBox[{"-", "\[ImaginaryI]"}], " ", 
               RowBox[{"Sign", "[", 
                RowBox[{"x2", "-", "x1"}], "]"}]}], 
              RowBox[{"2", " ", "a0"}]], 
             RowBox[{"(", GridBox[{
                {"0", 
                 RowBox[{"-", "\[ImaginaryI]"}]},
                {"\[ImaginaryI]", "0"}
               }], ")"}]}], "-", 
            RowBox[{
             FractionBox[
              RowBox[{
               RowBox[{"-", "\[ImaginaryI]"}], " ", 
               RowBox[{"Sign", "[", 
                RowBox[{"y2", "-", "y1"}], "]"}]}], 
              RowBox[{"2", " ", "a0"}]], 
             RowBox[{"(", GridBox[{
                {"0", "1"},
                {"1", "0"}
               }], ")"}]}]}], ")"}]}]}], ")"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"BuildScatteringSystem", "[", 
      RowBox[{"latC", ",", 
       RowBox[{"{", 
        RowBox[{"latL", ",", "latR"}], "}"}], ",", 
       RowBox[{"HoppingRange", "\[Rule]", 
        RowBox[{"1.01", "a0"}]}], ",", 
       RowBox[{"Onsite", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Honsite", "[", 
           RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ")"}]}], ",", 
       RowBox[{"Hopping", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Hhopping", "[", 
           RowBox[{"#1", ",", "#2", ",", "#3", ",", "#4"}], "]"}], "&"}], 
         ")"}]}], ",", " ", 
       RowBox[{"Nambu", "\[Rule]", "False"}], ",", " ", 
       RowBox[{"EmbedLattice", "\[Rule]", "True"}], ",", 
       RowBox[{"CouplingFactor", "\[Rule]", 
        RowBox[{"OptionValue", "[", "CouplingFactor", "]"}]}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.6386989059539213`*^9, 3.638699011114821*^9}, {
   3.6471625506969767`*^9, 3.647162551326324*^9}, {3.653808813525247*^9, 
   3.6538088229686813`*^9}, {3.654928335518425*^9, 3.654928353714438*^9}, {
   3.676026280798038*^9, 3.676026310300663*^9}, {3.682329446815279*^9, 
   3.682329471645508*^9}, {3.68232951494375*^9, 3.68232964890963*^9}, 
   3.68596216465971*^9},
 CellLabel->
  "In[485]:=",ExpressionUUID->"20aa1bac-97fd-4702-920f-36939296d1e5"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Hamiltonian presets", "Subsubsection",
 CellChangeTimes->{{3.656391418394706*^9, 3.656391420010014*^9}, {
  3.6563954612678003`*^9, 
  3.656395462423802*^9}},ExpressionUUID->"3efb631d-22f8-492c-a455-\
da5e1ed361da"],

Cell[BoxData[{
 RowBox[{"Clear", "[", "HPreset", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"HPreset", "[", 
    RowBox[{"\"\<1DNambuWire\>\"", ",", 
     RowBox[{"LatticeConstant_", "?", "NumericQ"}], ",", 
     RowBox[{"OptionsPattern", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"EffectiveMass", "\[Rule]", "0.015"}], ",", " ", 
        RowBox[{"ZeemanZ", "\[Rule]", "0."}], ",", " ", 
        RowBox[{"Pairing", "\[Rule]", "0."}], ",", " ", 
        RowBox[{"FermiEnergy", "\[Rule]", "0"}], ",", " ", 
        RowBox[{"Rashba", "\[Rule]", "20"}]}], "}"}], "]"}]}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[HBar]\[HBar]ome", "=", "76.1996"}], ",", " ", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"This", " ", "is", " ", 
          RowBox[{
           SuperscriptBox["\[HBar]", "2"], "/", 
           SubscriptBox["m", "e"]}]}], ",", " ", 
         RowBox[{
         "in", " ", "units", " ", "of", " ", "meV", " ", "and", " ", "nm"}]}],
         "*)"}], "\[IndentingNewLine]", 
       RowBox[{"eo\[HBar]", "=", "0.001519"}], " ", 
       RowBox[{"(*", 
        RowBox[{"This", " ", "is", " ", 
         RowBox[{"e", "/", "\[HBar]"}], " ", "in", " ", "units", " ", "of", 
         " ", "Tesla", " ", "and", " ", "nm"}], "*)"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"a0", "=", "LatticeConstant"}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"t", "=", 
          FractionBox["\[HBar]\[HBar]ome", 
           RowBox[{"2", " ", 
            RowBox[{"OptionValue", "[", "EffectiveMass", "]"}], " ", 
            SuperscriptBox["a0", "2"]}]]}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"B", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Head", "[", "#", "]"}], "===", "Function"}], ",", " ",
               "#", ",", 
              RowBox[{"Function", "[", 
               RowBox[{
                RowBox[{"{", "r", "}"}], ",", "#"}], "]"}]}], "]"}], "&"}], 
           "@", 
           RowBox[{"OptionValue", "[", "ZeemanZ", "]"}]}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\[CapitalDelta]", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Head", "[", "#", "]"}], "===", "Function"}], ",", " ",
               "#", ",", 
              RowBox[{"Function", "[", 
               RowBox[{
                RowBox[{"{", "r", "}"}], ",", "#"}], "]"}]}], "]"}], "&"}], 
           "@", 
           RowBox[{"OptionValue", "@", "Pairing"}]}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Mu]", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Head", "[", "#", "]"}], "===", "Function"}], ",", " ",
               "#", ",", 
              RowBox[{"Function", "[", 
               RowBox[{
                RowBox[{"{", "r", "}"}], ",", "#"}], "]"}]}], "]"}], "&"}], 
           "@", 
           RowBox[{"OptionValue", "@", "FermiEnergy"}]}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Alpha]", "=", 
          RowBox[{"OptionValue", "@", "Rashba"}]}]}], "}"}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{
           RowBox[{"{", "r", "}"}], ",", 
           RowBox[{"Evaluate", "[", 
            RowBox[{
             RowBox[{"(", GridBox[{
                {
                 RowBox[{
                  RowBox[{"2", "t"}], " ", "+", 
                  RowBox[{"B", "[", 
                   RowBox[{"r", ".", 
                    RowBox[{"{", "1", "}"}]}], "]"}]}], "0", "0", "0"},
                {"0", 
                 RowBox[{
                  RowBox[{"2", "t"}], "-", 
                  RowBox[{"B", "[", 
                   RowBox[{"r", ".", 
                    RowBox[{"{", "1", "}"}]}], "]"}]}], "0", "0"},
                {"0", "0", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"-", "2"}], "t"}], "-", 
                  RowBox[{"B", "[", 
                   RowBox[{"r", ".", 
                    RowBox[{"{", "1", "}"}]}], "]"}]}], "0"},
                {"0", "0", "0", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"-", "2"}], "t"}], "+", 
                  RowBox[{"B", "[", 
                   RowBox[{"r", ".", 
                    RowBox[{"{", "1", "}"}]}], "]"}]}]}
               }], ")"}], "+", 
             RowBox[{"(", GridBox[{
                {
                 RowBox[{"-", 
                  RowBox[{"\[Mu]", "[", 
                   RowBox[{"r", ".", 
                    RowBox[{"{", "1", "}"}]}], "]"}]}], "0", "0", "0"},
                {"0", 
                 RowBox[{"-", 
                  RowBox[{"\[Mu]", "[", 
                   RowBox[{"r", ".", 
                    RowBox[{"{", "1", "}"}]}], "]"}]}], "0", "0"},
                {"0", "0", 
                 RowBox[{"\[Mu]", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", "1", "}"}]}], "]"}], "0"},
                {"0", "0", "0", 
                 RowBox[{"\[Mu]", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", "1", "}"}]}], "]"}]}
               }], ")"}], "+", 
             RowBox[{"(", GridBox[{
                {"0", "0", "0", 
                 RowBox[{
                  RowBox[{"\[CapitalDelta]", "[", 
                   RowBox[{"r", ".", 
                    RowBox[{"{", "1", "}"}]}], "]"}], "\[Conjugate]"}]},
                {"0", "0", 
                 RowBox[{"-", 
                  RowBox[{
                   RowBox[{"\[CapitalDelta]", "[", 
                    RowBox[{"r", ".", 
                    RowBox[{"{", "1", "}"}]}], "]"}], "\[Conjugate]"}]}], "0"},
                {"0", 
                 RowBox[{"-", 
                  RowBox[{"\[CapitalDelta]", "[", 
                   RowBox[{"r", ".", 
                    RowBox[{"{", "1", "}"}]}], "]"}]}], "0", "0"},
                {
                 RowBox[{"\[CapitalDelta]", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", "1", "}"}]}], "]"}], "0", "0", "0"}
               }], ")"}]}], "]"}]}], "]"}], ",", 
         RowBox[{"Function", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"r1", ",", " ", "r2"}], "}"}], ",", 
           RowBox[{"Evaluate", "[", 
            RowBox[{
             RowBox[{"(", GridBox[{
                {
                 RowBox[{"-", "t"}], "0", "0", "0"},
                {"0", 
                 RowBox[{"-", "t"}], "0", "0"},
                {"0", "0", "t", "0"},
                {"0", "0", "0", "t"}
               }], ")"}], "+", 
             RowBox[{
              FractionBox[
               RowBox[{
                RowBox[{"-", "\[ImaginaryI]"}], " ", "\[Alpha]"}], 
               RowBox[{"2", " ", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"r1", "-", "r2"}], ")"}], ".", 
                 RowBox[{"{", "1", "}"}]}]}]], 
              RowBox[{"(", GridBox[{
                 {"0", 
                  RowBox[{"-", "\[ImaginaryI]"}], "0", "0"},
                 {"\[ImaginaryI]", "0", "0", "0"},
                 {"0", "0", "0", "\[ImaginaryI]"},
                 {"0", "0", 
                  RowBox[{"-", "\[ImaginaryI]"}], "0"}
                }], ")"}]}]}], "]"}]}], "]"}]}], "}"}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.6563914258841333`*^9, 3.656391481683097*^9}, {
   3.6563915157962093`*^9, 3.656391880859578*^9}, 3.656391916438225*^9, {
   3.656395470694449*^9, 3.656395471664714*^9}, {3.656395694655884*^9, 
   3.65639569797117*^9}, {3.656395732930525*^9, 3.656395799626946*^9}, {
   3.656395859862421*^9, 3.656395886317688*^9}, {3.656395933293784*^9, 
   3.656395976123632*^9}, {3.656396023859042*^9, 3.656396028802359*^9}, {
   3.656396084194071*^9, 3.656396117352392*^9}, {3.6563965658066187`*^9, 
   3.656396658011826*^9}, {3.656396740457615*^9, 3.656396807400585*^9}, {
   3.656396844350896*^9, 3.656396866397402*^9}, {3.656396909238109*^9, 
   3.656396975130658*^9}, {3.656397012738365*^9, 3.656397031250784*^9}, {
   3.656397268299712*^9, 3.656397405456532*^9}, {3.656397456632094*^9, 
   3.656397471237357*^9}, {3.656397535205853*^9, 3.656397537468933*^9}, {
   3.656397577484166*^9, 3.656397588858889*^9}, {3.656397620835198*^9, 
   3.656397672536737*^9}, {3.656398023017293*^9, 3.656398041968631*^9}, 
   3.685962140827257*^9, 3.697890529064004*^9},
 CellLabel->
  "In[486]:=",ExpressionUUID->"0701de14-3d8b-4600-a7f3-fb8447ed027d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"HPreset", "[", 
   RowBox[{"\"\<2DNambuRashba\>\"", ",", 
    RowBox[{"LatticeConstant_", "?", "NumericQ"}], ",", 
    RowBox[{"OptionsPattern", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"EffectiveMass", "\[Rule]", "0.015"}], ",", " ", 
       RowBox[{"ZeemanZ", "\[Rule]", "0."}], ",", " ", 
       RowBox[{"Pairing", "\[Rule]", "0."}], ",", " ", 
       RowBox[{"FermiEnergy", "\[Rule]", "0"}], ",", " ", 
       RowBox[{"Rashba", "\[Rule]", "20"}], ",", " ", 
       RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "}"}], "]"}]}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[HBar]\[HBar]ome", "=", "76.1996"}], ",", " ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"This", " ", "is", " ", 
         RowBox[{
          SuperscriptBox["\[HBar]", "2"], "/", 
          SubscriptBox["m", "e"]}]}], ",", " ", 
        RowBox[{
        "in", " ", "units", " ", "of", " ", "meV", " ", "and", " ", "nm"}]}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"eo\[HBar]", "=", "0.001519"}], " ", 
      RowBox[{"(*", 
       RowBox[{"This", " ", "is", " ", 
        RowBox[{"e", "/", "\[HBar]"}], " ", "in", " ", "units", " ", "of", 
        " ", "Tesla", " ", "and", " ", "nm"}], "*)"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"a0", "=", "LatticeConstant"}], ",", "\[IndentingNewLine]", 
      RowBox[{"ar", "=", 
       RowBox[{"OptionValue", "@", "AspectRatio"}]}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"t", "=", 
         FractionBox["\[HBar]\[HBar]ome", 
          RowBox[{"2", " ", 
           RowBox[{"OptionValue", "[", "EffectiveMass", "]"}], " ", 
           SuperscriptBox["a0", "2"]}]]}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{"B", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Head", "[", "#", "]"}], "===", "Function"}], ",", " ", 
             "#", ",", 
             RowBox[{"Function", "[", 
              RowBox[{
               RowBox[{"{", "r", "}"}], ",", "#"}], "]"}]}], "]"}], "&"}], 
          "@", 
          RowBox[{"OptionValue", "[", "ZeemanZ", "]"}]}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\[CapitalDelta]", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Head", "[", "#", "]"}], "===", "Function"}], ",", " ", 
             "#", ",", 
             RowBox[{"Function", "[", 
              RowBox[{
               RowBox[{"{", "r", "}"}], ",", "#"}], "]"}]}], "]"}], "&"}], 
          "@", 
          RowBox[{"OptionValue", "@", "Pairing"}]}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Mu]", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Head", "[", "#", "]"}], "===", "Function"}], ",", " ", 
             "#", ",", 
             RowBox[{"Function", "[", 
              RowBox[{
               RowBox[{"{", "r", "}"}], ",", "#"}], "]"}]}], "]"}], "&"}], 
          "@", 
          RowBox[{"OptionValue", "@", "FermiEnergy"}]}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Alpha]", "=", 
         RowBox[{"OptionValue", "@", "Rashba"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", "r", "}"}], ",", 
          RowBox[{"Evaluate", "[", 
           RowBox[{
            RowBox[{"(", GridBox[{
               {
                RowBox[{
                 RowBox[{"2", 
                  RowBox[{"(", 
                   RowBox[{"1", "+", 
                    FractionBox["1", 
                    SuperscriptBox["ar", "2"]]}], ")"}], "t"}], " ", "+", 
                 RowBox[{"B", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", 
                    RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}], "0", "0", 
                "0"},
               {"0", 
                RowBox[{
                 RowBox[{"2", 
                  RowBox[{"(", 
                   RowBox[{"1", "+", 
                    FractionBox["1", 
                    SuperscriptBox["ar", "2"]]}], ")"}], "t"}], "-", 
                 RowBox[{"B", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", 
                    RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}], "0", "0"},
               {"0", "0", 
                RowBox[{
                 RowBox[{
                  RowBox[{"-", "2"}], 
                  RowBox[{"(", 
                   RowBox[{"1", "+", 
                    FractionBox["1", 
                    SuperscriptBox["ar", "2"]]}], ")"}], "t"}], "-", 
                 RowBox[{"B", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", 
                    RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}], "0"},
               {"0", "0", "0", 
                RowBox[{
                 RowBox[{
                  RowBox[{"-", "2"}], 
                  RowBox[{"(", 
                   RowBox[{"1", "+", 
                    FractionBox["1", 
                    SuperscriptBox["ar", "2"]]}], ")"}], "t"}], "+", 
                 RowBox[{"B", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", 
                    RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}]}
              }], ")"}], "+", 
            RowBox[{"(", GridBox[{
               {
                RowBox[{"-", 
                 RowBox[{"\[Mu]", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", 
                    RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}], "0", "0", 
                "0"},
               {"0", 
                RowBox[{"-", 
                 RowBox[{"\[Mu]", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", 
                    RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}], "0", "0"},
               {"0", "0", 
                RowBox[{"\[Mu]", "[", 
                 RowBox[{"r", ".", 
                  RowBox[{"{", 
                   RowBox[{"1", ",", "0"}], "}"}]}], "]"}], "0"},
               {"0", "0", "0", 
                RowBox[{"\[Mu]", "[", 
                 RowBox[{"r", ".", 
                  RowBox[{"{", 
                   RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}
              }], ")"}], "+", 
            RowBox[{"(", GridBox[{
               {"0", "0", "0", 
                RowBox[{
                 RowBox[{"\[CapitalDelta]", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", 
                    RowBox[{"1", ",", "0"}], "}"}]}], "]"}], "\[Conjugate]"}]},
               {"0", "0", 
                RowBox[{"-", 
                 RowBox[{
                  RowBox[{"\[CapitalDelta]", "[", 
                   RowBox[{"r", ".", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "0"}], "}"}]}], "]"}], 
                  "\[Conjugate]"}]}], "0"},
               {"0", 
                RowBox[{"-", 
                 RowBox[{"\[CapitalDelta]", "[", 
                  RowBox[{"r", ".", 
                   RowBox[{"{", 
                    RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}], "0", "0"},
               {
                RowBox[{"\[CapitalDelta]", "[", 
                 RowBox[{"r", ".", 
                  RowBox[{"{", 
                   RowBox[{"1", ",", "0"}], "}"}]}], "]"}], "0", "0", "0"}
              }], ")"}]}], "]"}]}], "]"}], ",", 
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"r1", ",", " ", "r2"}], "}"}], ",", 
          RowBox[{"Evaluate", "[", 
           RowBox[{
            RowBox[{"(", GridBox[{
               {
                RowBox[{"-", "t"}], "0", "0", "0"},
               {"0", 
                RowBox[{"-", "t"}], "0", "0"},
               {"0", "0", "t", "0"},
               {"0", "0", "0", "t"}
              }], ")"}], "+", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               FractionBox["1", 
                SuperscriptBox["ar", "2"]], "-", "1"}], ")"}], 
             RowBox[{"(", GridBox[{
                {
                 RowBox[{"-", "t"}], "0", "0", "0"},
                {"0", 
                 RowBox[{"-", "t"}], "0", "0"},
                {"0", "0", "t", "0"},
                {"0", "0", "0", "t"}
               }], ")"}], 
             RowBox[{"Abs", "@", 
              RowBox[{"Sign", "[", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"r1", "-", "r2"}], ")"}], ".", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "1"}], "}"}]}], "]"}]}]}], "+", 
            RowBox[{
             FractionBox[
              RowBox[{
               RowBox[{"-", "\[ImaginaryI]"}], " ", "\[Alpha]", " ", 
               RowBox[{"Sign", "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"r1", "-", "r2"}], ")"}], ".", 
                 RowBox[{"{", 
                  RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}], 
              RowBox[{"2", " ", "a0"}]], 
             RowBox[{"(", GridBox[{
                {"0", 
                 RowBox[{"-", "\[ImaginaryI]"}], "0", "0"},
                {"\[ImaginaryI]", "0", "0", "0"},
                {"0", "0", "0", "\[ImaginaryI]"},
                {"0", "0", 
                 RowBox[{"-", "\[ImaginaryI]"}], "0"}
               }], ")"}]}], "-", 
            RowBox[{
             FractionBox["1", "ar"], 
             FractionBox[
              RowBox[{
               RowBox[{"-", "\[ImaginaryI]"}], " ", "\[Alpha]", " ", 
               RowBox[{"Sign", "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"r1", "-", "r2"}], ")"}], ".", 
                 RowBox[{"{", 
                  RowBox[{"0", ",", "1"}], "}"}]}], "]"}]}], 
              RowBox[{"2", " ", "a0"}]], 
             RowBox[{"(", GridBox[{
                {"0", "1", "0", "0"},
                {"1", "0", "0", "0"},
                {"0", "0", "0", "1"},
                {"0", "0", "1", "0"}
               }], ")"}]}]}], "]"}]}], "]"}]}], "}"}]}], "]"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.697890481995282*^9, 3.69789049805503*^9}, {
  3.697890535172201*^9, 3.697890535885038*^9}, {3.6978910730838947`*^9, 
  3.697891103132395*^9}, {3.6978911611700497`*^9, 3.6978911806689672`*^9}, {
  3.697891232580744*^9, 3.69789123702754*^9}, {3.697891338645906*^9, 
  3.697891351140957*^9}, {3.697974904781611*^9, 3.6979750656377296`*^9}, {
  3.697975547161161*^9, 3.6979755482386417`*^9}, {3.69797574483349*^9, 
  3.697975760868331*^9}, {3.6984127915025043`*^9, 3.698412855673003*^9}, {
  3.6984130669736023`*^9, 3.698413075509851*^9}},
 CellLabel->
  "In[488]:=",ExpressionUUID->"517e18a0-942f-4bc4-98a8-488c096ba7ec"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{3.697890523355495*^9},
 CellLabel->
  "In[489]:=",ExpressionUUID->"4bb66ffd-2852-49f6-876a-47b714c4a2ea"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["Lab", "Section",
 CellChangeTimes->{{3.636104666268796*^9, 
  3.6361046666682367`*^9}},ExpressionUUID->"e97a629b-f9a9-4da1-aba0-\
7f65d9f5be57"],

Cell[CellGroupData[{

Cell["Hub terms as a bending rigidity", "Subsubsection",
 CellChangeTimes->{{3.653713446151411*^9, 
  3.653713453622396*^9}},ExpressionUUID->"02774cef-7a4c-418e-bb84-\
6a09fd9df543"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Simplify", "@", 
     RowBox[{"Series", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           FractionBox["1", 
            SuperscriptBox["a", "2"]], 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              SqrtBox[
               RowBox[{
                SuperscriptBox["a", "2"], "-", 
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{"h0", "-", "hm"}], ")"}], "2"]}]], ",", 
              RowBox[{"h0", "-", "hm"}]}], "}"}], ".", 
            RowBox[{"{", 
             RowBox[{
              SqrtBox[
               RowBox[{
                SuperscriptBox["a", "2"], "-", 
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{"hp", "-", "h0"}], ")"}], "2"]}]], ",", 
              RowBox[{"hp", "-", "h0"}]}], "}"}]}]}], "-", "1"}], ")"}], "/.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"h0", "\[Rule]", 
           RowBox[{"\[Alpha]", " ", "h0"}]}], ",", " ", 
          RowBox[{"hp", "\[Rule]", 
           RowBox[{"\[Alpha]", " ", "hp"}]}], ",", 
          RowBox[{"hm", "\[Rule]", 
           RowBox[{"\[Alpha]", " ", "hm"}]}]}], "}"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"\[Alpha]", ",", "0", ",", "2"}], "}"}]}], "]"}]}], 
    "\[IndentingNewLine]", 
    RowBox[{"Simplify", "@", 
     RowBox[{"Series", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         FractionBox["1", "2"], 
         SuperscriptBox["a", "2"], 
         SuperscriptBox[
          RowBox[{"(", 
           FractionBox[
            RowBox[{"(", 
             RowBox[{
              RowBox[{"2", "h0"}], "-", "hm", "-", "hp"}], ")"}], 
            SuperscriptBox["a", "2"]], ")"}], "2"]}], "/.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"h0", "\[Rule]", 
           RowBox[{"\[Alpha]", " ", "h0"}]}], ",", " ", 
          RowBox[{"hp", "\[Rule]", 
           RowBox[{"\[Alpha]", " ", "hp"}]}], ",", 
          RowBox[{"hm", "\[Rule]", 
           RowBox[{"\[Alpha]", " ", "hm"}]}]}], "}"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"\[Alpha]", ",", "0", ",", "2"}], "}"}]}], "]"}]}]}], "*)"}], 
  "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.6537122001701813`*^9, 3.653712387500918*^9}, {
   3.653712488631728*^9, 3.653712511726716*^9}, {3.653712556053256*^9, 
   3.653712584786881*^9}, 3.6537127165137243`*^9, 3.65371372120993*^9},
 CellLabel->
  "In[490]:=",ExpressionUUID->"34b7fd84-4372-43e8-bbdc-dc6c305060be"],

Cell[TextData[{
 "Force: ",
 Cell[BoxData[
  RowBox[{
   RowBox[{
    RowBox[{
     SubscriptBox["\[Del]", "ra"], 
     FractionBox[
      RowBox[{"r1", ".", "r2"}], 
      RowBox[{"|", 
       RowBox[{"r1", "||", "r2"}], "|"}]]}], "=", 
    RowBox[{
     FractionBox["1", 
      RowBox[{"|", 
       RowBox[{"r1", "||", "r2"}], "|"}]], 
     RowBox[{"(", 
      RowBox[{"r2", "-", 
       RowBox[{
        FractionBox[
         RowBox[{"r1", ".", "r2"}], 
         RowBox[{"|", "r1", 
          SuperscriptBox["|", "2"]}]], "r1"}]}], ")"}]}]}], ",", 
   RowBox[{
    RowBox[{
     SubscriptBox["\[Del]", "rb"], 
     FractionBox[
      RowBox[{"r1", ".", "r2"}], 
      RowBox[{"|", 
       RowBox[{"r1", "||", "r2"}], "|"}]]}], "=", 
    RowBox[{
     FractionBox["1", 
      RowBox[{"|", 
       RowBox[{"r1", "||", "r2"}], "|"}]], 
     RowBox[{"(", 
      RowBox[{"r1", "-", 
       RowBox[{
        FractionBox[
         RowBox[{"r1", ".", "r2"}], 
         RowBox[{"|", "r2", 
          SuperscriptBox["|", "2"]}]], "r2"}]}], ")"}]}]}]}]],ExpressionUUID->
  "359d129d-22b3-498f-93d7-f060c2c23046"],
 ", where r1 is really ra-r0 and r2=rb-r0\nForce: ",
 Cell[BoxData[
  RowBox[{
   RowBox[{
    SubscriptBox["\[Del]", "r0"], 
    FractionBox[
     RowBox[{"r1", ".", "r2"}], 
     RowBox[{"|", 
      RowBox[{"r1", "||", "r2"}], "|"}]]}], "=", 
   RowBox[{
    RowBox[{"-", 
     RowBox[{
      SubscriptBox["\[Del]", "ra"], 
      FractionBox[
       RowBox[{"r1", ".", "r2"}], 
       RowBox[{"|", 
        RowBox[{"r1", "||", "r2"}], "|"}]]}]}], "-", 
    RowBox[{
     SubscriptBox["\[Del]", "rb"], 
     FractionBox[
      RowBox[{"r1", ".", "r2"}], 
      RowBox[{"|", 
       RowBox[{"r1", "||", "r2"}], "|"}]]}]}]}]],ExpressionUUID->
  "4603e7dd-78a5-4a61-b63e-2c3c7a4dbca0"]
}], "Text",
 CellChangeTimes->{{3.653713472069952*^9, 3.653713473765317*^9}, {
  3.65371363683031*^9, 3.653713708675725*^9}, {3.653713827310487*^9, 
  3.6537138332613792`*^9}, {3.65371386343257*^9, 
  3.6537139292713947`*^9}},ExpressionUUID->"6ca0cd71-0f4d-4256-ad9c-\
263a405f738f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["LDOS", "Subsubsection",
 CellChangeTimes->{{3.636227555357638*^9, 3.636227555789566*^9}, {
  3.636279675347406*^9, 
  3.636279675666527*^9}},ExpressionUUID->"12afe558-04f3-484e-8e43-\
f82c7c9ea63b"],

Cell[TextData[{
 StyleBox["Theory",
  FontSize->18],
 "\nWe interpolate the normalized eigenstates moduli ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SubscriptBox["\[Phi]", "n"], "(", "z", ")"}], "="}], TraditionalForm]],
  ExpressionUUID->"9a0345b6-f2be-47ba-a0e6-71b6a9bac461"],
 Cell[BoxData[
  FormBox[
   FractionBox[
    RowBox[{"|", 
     RowBox[{
      SubscriptBox["\[Psi]", "n"], "(", "z", ")"}], "|"}], 
    SqrtBox[
     RowBox[{
      SubscriptBox["v", "n"], "(", "z", ")"}]]], TraditionalForm]],
  ExpressionUUID->"aa175650-6667-4665-9417-60ceddbc2384"],
 " returned by SolveLead in the interval [",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["z", "0"], "-", 
    RowBox[{
     FractionBox["1", "2"], "\[Delta]z"}]}], TraditionalForm]],ExpressionUUID->
  "a66cc0c8-700b-4dfb-a6f9-d178abe43967"],
 ", ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["z", "0"], "+", 
    RowBox[{
     FractionBox["1", "2"], "\[Delta]z"}]}], TraditionalForm]],ExpressionUUID->
  "f28793e3-262c-4721-9ee5-76eb15378451"],
 "]  as",
 Cell[BoxData[
  FormBox[
   RowBox[{" ", 
    SuperscriptBox[
     RowBox[{"(", " ", 
      RowBox[{"a", " ", "+", " ", 
       RowBox[{"b", " ", 
        FractionBox["z", 
         RowBox[{"\[Delta]z", "/", "2"}]]}]}], ")"}], 
     RowBox[{"n", "/", "2"}]]}], TraditionalForm]],ExpressionUUID->
  "c0ddf9ad-b3cc-4b6a-8c98-110e7ab255b7"],
 ", where a=",
 Cell[BoxData[
  RowBox[{
   FractionBox["1", "2"], " ", 
   RowBox[{"(", 
    RowBox[{
     SuperscriptBox[
      RowBox[{"\[Phi]", "[", "0", "]"}], 
      FractionBox["2", "n"]], "+", 
     SuperscriptBox[
      RowBox[{"\[Phi]", "[", "1", "]"}], 
      FractionBox["2", "n"]]}], ")"}]}]],
  CellChangeTimes->{3.63608831472412*^9},ExpressionUUID->
  "e936c693-d365-442a-a59e-536d4f7f20dd"],
 " and b=",
 Cell[BoxData[
  RowBox[{
   FractionBox["1", "2"], " ", 
   RowBox[{"(", 
    RowBox[{
     SuperscriptBox[
      RowBox[{"\[Phi]", "[", "1", "]"}], 
      FractionBox["2", "n"]], "-", 
     SuperscriptBox[
      RowBox[{"\[Phi]", "[", "0", "]"}], 
      FractionBox["2", "n"]]}], ")"}]}]],
  CellChangeTimes->{3.63608831472412*^9},ExpressionUUID->
  "0252ae67-29ef-4915-9434-dd7d1881430c"],
 ". n=-1/2 for a 1D integral. Then, ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SubsuperscriptBox["\[Integral]", 
      RowBox[{
       SubscriptBox["z", "0"], "-", 
       RowBox[{"\[Delta]z", "/", "2"}]}], 
      RowBox[{
       SubscriptBox["z", "0"], "+", 
       RowBox[{"\[Delta]z", "/", "2"}]}]], 
     FractionBox[
      RowBox[{"|", 
       RowBox[{
        SubscriptBox["\[Psi]", "n"], "(", "z", ")"}], 
       SuperscriptBox["|", "2"]}], 
      RowBox[{
       SubscriptBox["v", "n"], "(", "z", ")"}]]}], "="}], TraditionalForm]],
  ExpressionUUID->"5d6f1d77-566a-4ead-a00b-e38d3e56fca8"],
 Cell[BoxData[
  FormBox[
   SubsuperscriptBox["\[Integral]", 
    RowBox[{
     SubscriptBox["z", "0"], "-", 
     RowBox[{"\[Delta]z", "/", "2"}]}], 
    RowBox[{
     SubscriptBox["z", "0"], "+", 
     RowBox[{"\[Delta]z", "/", "2"}]}]], TraditionalForm]],ExpressionUUID->
  "7ff2068c-c42d-4e46-b7dd-de2d1beab378"],
 Cell[BoxData[
  FormBox[
   SuperscriptBox[
    RowBox[{"(", " ", 
     RowBox[{"a", " ", "+", " ", 
      RowBox[{"b", " ", 
       FractionBox["z", 
        RowBox[{"\[Delta]z", "/", "2"}]]}]}], ")"}], "n"], TraditionalForm]],
  ExpressionUUID->"37538cd0-a845-454e-a84f-637335ac58d4"],
 "dz=",
 Cell[BoxData[
  RowBox[{
   FractionBox[
    RowBox[{"(", 
     RowBox[{
      RowBox[{"-", 
       SuperscriptBox[
        RowBox[{"(", 
         RowBox[{"a", "-", "b"}], ")"}], 
        RowBox[{"1", "+", "n"}]]}], "+", 
      SuperscriptBox[
       RowBox[{"(", 
        RowBox[{"a", "+", "b"}], ")"}], 
       RowBox[{"1", "+", "n"}]]}], ")"}], 
    RowBox[{"2", " ", "b", 
     RowBox[{"(", 
      RowBox[{"n", "+", "1"}], ")"}]}]], "\[Delta]z"}]],
  CellChangeTimes->{
   3.63608831472412*^9, 3.636090942506281*^9, {3.636091072369977*^9, 
    3.636091089652738*^9}},ExpressionUUID->
  "dfa1f541-8d6d-4413-a9df-7b17893491bf"],
 "=",
 Cell[BoxData[
  FractionBox[
   RowBox[{"\[Delta]z", " ", 
    RowBox[{"(", 
     RowBox[{
      SuperscriptBox[
       RowBox[{"\[Phi]", "[", "0", "]"}], 
       RowBox[{"2", "+", 
        FractionBox["2", "n"]}]], "-", 
      SuperscriptBox[
       RowBox[{"\[Phi]", "[", "1", "]"}], 
       RowBox[{"2", "+", 
        FractionBox["2", "n"]}]]}], ")"}]}], 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"1", "+", "n"}], ")"}], " ", 
    RowBox[{"(", 
     RowBox[{
      SuperscriptBox[
       RowBox[{"\[Phi]", "[", "0", "]"}], 
       RowBox[{"2", "/", "n"}]], "-", 
      SuperscriptBox[
       RowBox[{"\[Phi]", "[", "1", "]"}], 
       RowBox[{"2", "/", "n"}]]}], ")"}]}]]],
  CellChangeTimes->{
   3.63608831472412*^9, 3.636090942506281*^9, {3.636091072369977*^9, 
    3.636091109652463*^9}, {3.636091202190378*^9, 3.636091283723009*^9}, 
    3.6360914176141167`*^9},ExpressionUUID->
  "e84852d6-9c21-45a3-89a2-6501bbc6014d"]
}], "Text",
 CellChangeTimes->{{3.636087971801774*^9, 3.6360881700962267`*^9}, {
  3.636088251212861*^9, 3.636088280203401*^9}, {3.636088326718701*^9, 
  3.636088386928145*^9}, {3.63608842126009*^9, 3.636088421372114*^9}, {
  3.6360909316492043`*^9, 3.636091047543798*^9}, {3.636091097481992*^9, 
  3.6360911500138817`*^9}, {3.636091423309163*^9, 3.6360914234408627`*^9}, {
  3.6360923337332563`*^9, 3.6360923614940653`*^9}, {3.636092394050335*^9, 
  3.6360924495415897`*^9}, {3.636095238177459*^9, 3.63609529057456*^9}, {
  3.636279819270133*^9, 3.636279823165099*^9}, {3.680333242290011*^9, 
  3.6803332510825157`*^9}},ExpressionUUID->"93030a6d-b0eb-4106-a9eb-\
48cbdb70b7f6"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{"Solve", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"\[Phi]", "[", "0", "]"}], "==", 
         SuperscriptBox[
          RowBox[{"(", 
           FormBox[
            RowBox[{"a", "+", 
             RowBox[{"b", " ", 
              FractionBox[
               RowBox[{
                RowBox[{"-", "\[Delta]z"}], "/", "2"}], 
               RowBox[{"\[Delta]z", "/", "2"}]]}]}],
            TraditionalForm], ")"}], 
          RowBox[{"n", "/", "2"}]]}], ",", 
        RowBox[{
         RowBox[{"\[Phi]", "[", "1", "]"}], "==", 
         FormBox[
          SuperscriptBox[
           RowBox[{"(", 
            RowBox[{"a", "+", 
             RowBox[{"b", " ", 
              FractionBox[
               RowBox[{"\[Delta]z", "/", "2"}], 
               RowBox[{"\[Delta]z", "/", "2"}]]}]}], ")"}], 
           RowBox[{"n", "/", "2"}]],
          TraditionalForm]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"a", ",", "b"}], "}"}]}], "]"}], "//", 
    RowBox[{"Simplify", "\[IndentingNewLine]", 
     RowBox[{"Integrate", "[", 
      RowBox[{
       SuperscriptBox[
        RowBox[{"(", 
         FormBox[
          RowBox[{"a", "+", 
           RowBox[{"b", " ", 
            FractionBox["z", 
             RowBox[{"\[Delta]z", "/", "2"}]]}]}],
          TraditionalForm], ")"}], "n"], ",", 
       RowBox[{"{", 
        RowBox[{"z", ",", 
         RowBox[{
          RowBox[{"-", "\[Delta]z"}], "/", "2"}], ",", 
         RowBox[{"\[Delta]z", "/", "2"}]}], "}"}], ",", " ", 
       RowBox[{"GenerateConditions", "\[Rule]", "False"}]}], "]"}]}]}], "//", 
   
   RowBox[{"Simplify", "\[IndentingNewLine]", 
    RowBox[{"Simplify", "[", 
     RowBox[{
      RowBox[{"%", "/.", 
       RowBox[{"First", "@", "%%"}]}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"\[Phi]", "[", "1", "]"}], ">", "0"}], ",", 
        RowBox[{
         RowBox[{"\[Phi]", "[", "0", "]"}], ">", "0"}], ",", 
        RowBox[{"n", ">", "0"}]}], "}"}]}], "]"}]}]}], "*)"}]], "Input",
 CellChangeTimes->{{3.6360882975445423`*^9, 3.636088313962366*^9}, {
   3.636090937970077*^9, 3.636090942024852*^9}, {3.636091056936652*^9, 
   3.6360911084536037`*^9}, {3.636091198153895*^9, 3.6360912833579273`*^9}, {
   3.636091410568321*^9, 3.636091411206902*^9}, 3.636092343530726*^9, {
   3.636095249263117*^9, 3.636095268570505*^9}, 3.636279866662139*^9},
 CellLabel->
  "In[491]:=",ExpressionUUID->"69417181-fd75-4959-b9cd-3809eedde5a3"],

Cell[TextData[{
 "If ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["\[Phi]", "n"], "(", "z", ")"}], TraditionalForm]],
  ExpressionUUID->"c067daca-1d66-4824-80e8-192ed8bd6866"],
 " is known for ",
 Cell[BoxData[
  FormBox[
   RowBox[{"z", "=", 
    RowBox[{
     SubscriptBox["z", "0"], "+", "\[CapitalDelta]z"}]}], TraditionalForm]],
  ExpressionUUID->"b225a3ea-9ae6-4a53-8440-65edef414008"],
 ", and we also know that ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["\[Phi]", "n"], "(", 
    RowBox[{"z", "\[Rule]", 
     SubscriptBox["z", "0"]}], ")"}], TraditionalForm]],ExpressionUUID->
  "098e1d83-e62c-4893-9a0c-eb3d796a9082"],
 " goes like ",
 Cell[BoxData[
  FormBox[
   SuperscriptBox[
    RowBox[{"(", 
     RowBox[{"z", "-", 
      SubscriptBox["z", "0"]}], ")"}], 
    RowBox[{"n", "/", "2"}]], TraditionalForm]],ExpressionUUID->
  "0e4d9617-606a-43da-9416-802b6c2cf08b"],
 " (Fermi line edge), we can compute the integral too. Shift ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["z", "0"], "=", "0."}], TraditionalForm]],ExpressionUUID->
  "3a1d0001-12cc-4f01-a0e2-58dc050b5348"],
 " Then ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["\[Phi]", "n"], "(", "z", ")"}], TraditionalForm]],
  ExpressionUUID->"97762b8d-b204-4131-9e57-ce4ae6f5c4fe"],
 "=",
 Cell[BoxData[
  FormBox[
   SuperscriptBox[
    RowBox[{"(", " ", 
     RowBox[{"b", " ", 
      FractionBox["z", "\[CapitalDelta]z"]}], ")"}], 
    RowBox[{"n", "/", "2"}]], TraditionalForm]],ExpressionUUID->
  "cacc9cef-5f3b-4270-8982-615ee92c4cc1"],
 ", and ",
 Cell[BoxData[
  FormBox[
   RowBox[{"b", "=", 
    SuperscriptBox[
     RowBox[{
      SubscriptBox["\[Phi]", "n"], "(", "z", ")"}], 
     RowBox[{"2", "/", "n"}]]}], TraditionalForm]],ExpressionUUID->
  "496e927f-f62e-4175-9cab-904116c15503"],
 ". The integral ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SubsuperscriptBox["\[Integral]", 
      SubscriptBox["z", "0"], 
      RowBox[{
       SubscriptBox["z", "0"], "+", "\[CapitalDelta]z"}]], 
     FractionBox[
      RowBox[{"|", 
       RowBox[{
        SubscriptBox["\[Psi]", "n"], "(", "z", ")"}], 
       SuperscriptBox["|", "2"]}], 
      RowBox[{
       SubscriptBox["v", "n"], "(", "z", ")"}]]}], "="}], TraditionalForm]],
  ExpressionUUID->"32403058-6e70-4b0c-bd67-0f4bb9dcfa73"],
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SubsuperscriptBox["\[Integral]", 
      SubscriptBox["z", "0"], 
      RowBox[{
       SubscriptBox["z", "0"], "+", "\[CapitalDelta]z"}]], 
     SuperscriptBox[
      RowBox[{"(", 
       RowBox[{"b", " ", 
        FractionBox["z", "\[CapitalDelta]z"]}], ")"}], "n"]}], "="}], 
   TraditionalForm]],ExpressionUUID->"c69ec598-84e4-40d7-9c31-85d02eefb3bb"],
 Cell[BoxData[
  FractionBox[
   RowBox[{"\[CapitalDelta]z", " ", 
    SuperscriptBox["\[Phi]", "2"]}], 
   RowBox[{"1", "+", "n"}]]],
  CellChangeTimes->{{3.636201178212965*^9, 3.636201227583599*^9}},
  ExpressionUUID->"d6dca449-dccf-4748-9f45-75f6371f951d"]
}], "Text",
 CellChangeTimes->{{3.63620086205871*^9, 3.6362011607017317`*^9}, 
   3.636201241211604*^9},ExpressionUUID->"a1b53242-82ce-451e-b171-\
5caf5ae4aeae"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"Simplify", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Integrate", "[", 
      RowBox[{
       SuperscriptBox[
        RowBox[{"(", 
         FormBox[
          RowBox[{"b", " ", 
           FractionBox["z", "\[CapitalDelta]z"]}],
          TraditionalForm], ")"}], "n"], ",", 
       RowBox[{"{", 
        RowBox[{"z", ",", "0", ",", "\[CapitalDelta]z"}], "}"}], ",", " ", 
       RowBox[{"GenerateConditions", "\[Rule]", "False"}]}], "]"}], "/.", 
     RowBox[{"b", "\[Rule]", 
      SuperscriptBox["\[Phi]", 
       RowBox[{"2", "/", "n"}]]}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"n", ">", "0"}], ",", " ", 
      RowBox[{"\[Phi]", ">", "0"}]}], "}"}]}], "]"}], "*)"}]], "Input",
 CellChangeTimes->{{3.6362011689617434`*^9, 3.6362012271694593`*^9}, 
   3.63627987366217*^9},
 CellLabel->
  "In[492]:=",ExpressionUUID->"062c7e38-0e2a-4912-91f3-949f465bbc29"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"LDOS", "::", "zcap"}], "=", 
   "\"\<Unable to cap Fermi line at z = `1`. Defaulted to a cap at \
`2`.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "LDOS", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"OrbitalFunction", "\[Rule]", 
      RowBox[{"(", 
       RowBox[{
        SuperscriptBox[
         RowBox[{"Norm", "[", "#", "]"}], "2"], "&"}], ")"}]}], ",", 
     RowBox[{"DispersiveAxis", "\[Rule]", "1"}], ",", " ", 
     RowBox[{"Sequence", "@@", 
      RowBox[{"Options", "[", "Eigenstates", "]"}]}], ",", " ", 
     RowBox[{"SamplePoints", "\[Rule]", "33"}], ",", " ", 
     RowBox[{"EdgePower", "\[Rule]", 
      RowBox[{"-", ".5"}]}], ",", " ", 
     RowBox[{"MonitorFermiLine", "\[Rule]", "False"}], ",", " ", 
     RowBox[{"ReturnFermiLine", "\[Rule]", "False"}], ",", " ", 
     RowBox[{"ScanRange", "\[Rule]", "All"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"Clear", "[", "LDOS", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"LDOS", "[", 
   RowBox[{
    RowBox[{"\[Epsilon]_", "?", "NumericQ"}], ",", 
    RowBox[{"system_MQSystem", "/;", 
     RowBox[{
      RowBox[{"system", "[", "\"\<LatticeDimensions\>\"", "]"}], "\[Equal]", 
      "2"}]}], ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"latsize", "=", 
       RowBox[{"system", "[", "\"\<NumberOfSites\>\"", "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"np", "=", 
       RowBox[{"OptionValue", "@", "SamplePoints"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"dispersiveaxis", "=", 
       RowBox[{"OptionValue", "@", "DispersiveAxis"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"sweepaxis", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "@", "DispersiveAxis"}], "\[Equal]", "1"}], 
         ",", "2", ",", "1"}], "]"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"edgepower", "=", 
       RowBox[{"OptionValue", "@", "EdgePower"}]}], ",", 
      "\[IndentingNewLine]", "PadLists", ",", "TerminateFermiLine", ",", 
      "ModMean", ",", "\[IndentingNewLine]", "zmodes", ",", "momenta", ",", 
      "z", ",", " ", "ranges", ",", "zFermiLine", ",", "\[CapitalDelta]LDoS", 
      ",", "LDoS", ",", " ", "freezmomenta", ",", " ", "old"}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"ModMean", "[", 
       RowBox[{"{", 
        RowBox[{"z1_", ",", "z2_"}], "}"}], "]"}], ":=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Abs", "[", 
          RowBox[{"z1", "-", "z2"}], "]"}], "<=", "0.5"}], ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"z1", "+", "z2"}], ")"}], "/", "2"}], ",", 
        RowBox[{"Mod", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"z1", "+", "z2", "+", "1"}], ")"}], "/", "2"}], ",", "1", 
          ",", 
          RowBox[{"-", ".5"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TerminateFermiLine", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"zmode1_", ",", "zmode2_"}], "}"}], ",", " ", 
        "direction_String", ",", " ", "zsweep_"}], "]"}], ":=", 
      RowBox[{"Block", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "Z", ",", " ", "\[Phi]bloch", ",", " ", "zcap", ",", " ", 
          "zveccap"}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\[Phi]bloch", "=", 
          RowBox[{
           RowBox[{"ReplacePart", "[", 
            RowBox[{
             RowBox[{"2", "\[Pi]", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Z", "[", "1", "]"}], ",", 
                RowBox[{"Z", "[", "2", "]"}]}], "}"}]}], ",", 
             RowBox[{"sweepaxis", "\[Rule]", "None"}]}], "]"}], "/.", 
           RowBox[{
            RowBox[{"Z", "[", "dispersiveaxis", "]"}], "\[Rule]", 
            RowBox[{"ModMean", "[", 
             RowBox[{"Chop", "@", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"First", "[", "zmode1", "]"}], "[", 
                 RowBox[{"[", "dispersiveaxis", "]"}], "]"}], ",", 
                RowBox[{
                 RowBox[{"First", "[", "zmode2", "]"}], "[", 
                 RowBox[{"[", "dispersiveaxis", "]"}], "]"}]}], "}"}]}], 
             "]"}]}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"We", " ", "find", " ", "the", " ", 
           RowBox[{"z", "'"}], "s", " ", "along", " ", "the", " ", "sweep", 
           " ", "direction", " ", "that", " ", "have", " ", "can", " ", "cap",
            " ", "the", " ", "edge", " ", "between", " ", "zmode1", " ", 
           "and", " ", "zmode2"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"zcap", "=", 
          RowBox[{"Re", "@", 
           RowBox[{"First", "@", 
            RowBox[{"SolveLead", "[", 
             RowBox[{"\[Epsilon]", ",", 
              RowBox[{"system", "[", 
               RowBox[{"Sequence", "@@", "\[Phi]bloch"}], "]"}], ",", 
              RowBox[{"ComputeOnlyModes", "\[Rule]", "True"}]}], "]"}]}]}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"We", " ", "select", " ", "the", " ", 
            RowBox[{"z", "'"}], "s", " ", "that", " ", "cap", " ", "the", " ",
             "Fermi", " ", "line"}], ",", " ", 
           RowBox[{
           "from", " ", "those", " ", "obtained", " ", "by", " ", "the", " ", 
            "transverse", " ", "SolveLead"}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"direction", "===", "\"\<forward\>\""}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"zcap", "=", 
            RowBox[{"Min", "@", 
             RowBox[{"Select", "[", 
              RowBox[{"zcap", ",", 
               RowBox[{
                RowBox[{"0", "<=", 
                 RowBox[{"#", "-", "zsweep"}], "<", 
                 RowBox[{"1", "/", "np"}]}], "&"}]}], "]"}]}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"zcap", "=", 
            RowBox[{"Max", "@", 
             RowBox[{"Select", "[", 
              RowBox[{"zcap", ",", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"-", "1"}], "/", "np"}], "<", 
                 RowBox[{"#", "-", "zsweep"}], "<=", "0"}], "&"}]}], 
              "]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"If", " ", "nothing", " ", "was", " ", "found"}], ",", " ", 
           RowBox[{
            RowBox[{"Max", "[", 
             RowBox[{"{", "}"}], "]"}], "=", 
            RowBox[{"-", "\[Infinity]"}]}], ",", " ", 
           RowBox[{
            RowBox[{"and", " ", 
             RowBox[{"Min", "[", 
              RowBox[{"{", "}"}], "]"}]}], "=", 
            RowBox[{
             RowBox[{"\[Infinity]", ".", " ", "Then"}], " ", "we", " ", "try",
              " ", "again", " ", "with", " ", 
             RowBox[{"Mean", ".", " ", "And"}], " ", "then"}]}], ",", " ", 
           RowBox[{"if", " ", "not"}], ",", " ", 
           RowBox[{"choose", " ", "the", " ", "midpoint"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Abs", "[", "zcap", "]"}], "===", "\[Infinity]"}], ",", 
           "\[IndentingNewLine]", " ", 
           RowBox[{
            RowBox[{"\[Phi]bloch", "=", 
             RowBox[{
              RowBox[{"ReplacePart", "[", 
               RowBox[{
                RowBox[{"2", "\[Pi]", " ", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"Z", "[", "1", "]"}], ",", 
                   RowBox[{"Z", "[", "2", "]"}]}], "}"}]}], ",", 
                RowBox[{"sweepaxis", "\[Rule]", "None"}]}], "]"}], "/.", 
              RowBox[{
               RowBox[{"Z", "[", "dispersiveaxis", "]"}], "\[Rule]", 
               RowBox[{"Mean", "[", 
                RowBox[{"Chop", "@", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"First", "[", "zmode1", "]"}], "[", 
                    RowBox[{"[", "dispersiveaxis", "]"}], "]"}], ",", 
                   RowBox[{
                    RowBox[{"First", "[", "zmode2", "]"}], "[", 
                    RowBox[{"[", "dispersiveaxis", "]"}], "]"}]}], "}"}]}], 
                "]"}]}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"zcap", "=", 
             RowBox[{"Re", "@", 
              RowBox[{"First", "@", 
               RowBox[{"SolveLead", "[", 
                RowBox[{"\[Epsilon]", ",", 
                 RowBox[{"system", "[", 
                  RowBox[{"Sequence", "@@", "\[Phi]bloch"}], "]"}], ",", 
                 RowBox[{"ComputeOnlyModes", "\[Rule]", "True"}]}], 
                "]"}]}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"direction", "===", "\"\<forward\>\""}], ",", 
              RowBox[{"zcap", "=", 
               RowBox[{"Min", "@", 
                RowBox[{"Select", "[", 
                 RowBox[{"zcap", ",", 
                  RowBox[{
                   RowBox[{"0", "<=", 
                    RowBox[{"#", "-", "zsweep"}], "<", 
                    RowBox[{"1", "/", "np"}]}], "&"}]}], "]"}]}]}], ",", 
              RowBox[{"zcap", "=", 
               RowBox[{"Max", "@", 
                RowBox[{"Select", "[", 
                 RowBox[{"zcap", ",", 
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{"-", "1"}], "/", "np"}], "<", 
                    RowBox[{"#", "-", "zsweep"}], "<=", "0"}], "&"}]}], 
                 "]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Abs", "[", "zcap", "]"}], "===", "\[Infinity]"}], ",", 
              RowBox[{
               RowBox[{"zcap", "=", "zsweep"}], ";", 
               RowBox[{"Message", "[", 
                RowBox[{
                 RowBox[{"LDOS", "::", "zcap"}], ",", 
                 RowBox[{"Chop", "@", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"First", "[", "zmode1", "]"}], ",", 
                    RowBox[{"First", "[", "zmode2", "]"}]}], "}"}]}], ",", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"\[Phi]bloch", "/.", 
                    RowBox[{"None", "\[Rule]", 
                    RowBox[{"2", "\[Pi]", " ", "zcap"}]}]}], ")"}], "/", 
                  RowBox[{"(", 
                   RowBox[{"2", "\[Pi]"}], ")"}]}]}], "]"}], ";"}]}], 
             "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
           "We", " ", "return", " ", "the", " ", "padding", " ", "zmodes"}], 
           ",", " ", 
           RowBox[{
           "with", " ", "\[Infinity]", " ", "in", " ", "place", " ", "of", 
            " ", "eigenstate", " ", "at", " ", "the", " ", "edge"}]}], "*)"}],
          "\[IndentingNewLine]", 
         RowBox[{"zveccap", "=", 
          FractionBox[
           RowBox[{"\[Phi]bloch", "/.", 
            RowBox[{"None", "\[Rule]", 
             RowBox[{"2", "\[Pi]", " ", "zcap"}]}]}], 
           RowBox[{"2", "\[Pi]"}]]}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"zFermiLine", ",", "zveccap"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"zveccap", ",", "\[Infinity]"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"zveccap", ",", "\[Infinity]"}], "}"}]}], "}"}]}]}], 
       "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"PadLists", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"zmodeold_List", ",", " ", "zmodenew_List"}], "}"}], ",", 
        "zsweep_"}], "]"}], ":=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "@", "zmodeold"}], "\[Equal]", 
         RowBox[{"Length", "@", "zmodenew"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"zmodeold", ",", " ", "zmodenew"}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "@", "zmodeold"}], ">", 
           RowBox[{"Length", "@", "zmodenew"}]}], ",", "\[IndentingNewLine]", 
          
          RowBox[{"{", 
           RowBox[{"zmodeold", ",", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"Flatten", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"TerminateFermiLine", "[", 
                   RowBox[{"#", ",", "\"\<forward\>\"", ",", 
                    RowBox[{"zsweep", "-", 
                    RowBox[{"1", "/", "np"}]}]}], "]"}], "&"}], "/@", 
                 RowBox[{"Partition", "[", 
                  RowBox[{
                   RowBox[{"Sort", "[", 
                    RowBox[{
                    RowBox[{"zmodeold", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ";;", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Length", "@", "zmodeold"}], "-", 
                    RowBox[{"Length", "@", "zmodenew"}]}], ")"}]}], "]"}], 
                    "]"}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Chop", "[", 
                    RowBox[{"#1", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "dispersiveaxis"}], "]"}], "]"}], "]"}],
                     "<", 
                    RowBox[{"Chop", "[", 
                    RowBox[{"#2", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "dispersiveaxis"}], "]"}], "]"}], 
                    "]"}]}], "&"}]}], "]"}], ",", "2"}], "]"}]}], ",", "1"}], 
               "]"}], ",", "zmodenew"}], "]"}]}], "}"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"Flatten", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"TerminateFermiLine", "[", 
                   RowBox[{"#", ",", "\"\<backward\>\"", ",", "zsweep"}], 
                   "]"}], "&"}], "/@", 
                 RowBox[{"Partition", "[", 
                  RowBox[{
                   RowBox[{"Sort", "[", 
                    RowBox[{
                    RowBox[{"zmodenew", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ";;", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Length", "@", "zmodenew"}], "-", 
                    RowBox[{"Length", "@", "zmodeold"}]}], ")"}]}], "]"}], 
                    "]"}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Chop", "[", 
                    RowBox[{"#1", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "dispersiveaxis"}], "]"}], "]"}], "]"}],
                     "<", 
                    RowBox[{"Chop", "[", 
                    RowBox[{"#2", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "dispersiveaxis"}], "]"}], "]"}], 
                    "]"}]}], "&"}]}], "]"}], ",", "2"}], "]"}]}], ",", "1"}], 
               "]"}], ",", "zmodeold"}], "]"}], ",", "zmodenew"}], "}"}]}], 
         "\[IndentingNewLine]", "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"momenta", "=", 
      RowBox[{"2", "\[Pi]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"z", "[", "1", "]"}], ",", 
         RowBox[{"z", "[", "2", "]"}]}], "}"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"momenta", "[", 
       RowBox[{"[", "dispersiveaxis", "]"}], "]"}], "=", "None"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"freezmomenta", "=", 
      FractionBox[
       RowBox[{"DeleteCases", "[", 
        RowBox[{"momenta", ",", "None"}], "]"}], 
       RowBox[{"2", "\[Pi]"}]]}], ";", "\[IndentingNewLine]", 
     RowBox[{"zFermiLine", "=", 
      RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"zmodes", "[", "\[Phi]bloch_List", "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"AppendTo", "[", 
               RowBox[{"zFermiLine", ",", "#"}], "]"}], ";", "#"}], ")"}], 
            "&"}], "@", 
           FractionBox[
            RowBox[{"\[Phi]bloch", "/.", 
             RowBox[{"None", "\[Rule]", 
              RowBox[{"2", "\[Pi]", " ", 
               RowBox[{"Chop", "[", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], "]"}]}]}]}], 
            RowBox[{"2", "\[Pi]"}]]}], ",", "\[IndentingNewLine]", 
          RowBox[{"Abs", "[", 
           RowBox[{"#", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "]"}]}], "}"}], "&"}], "/@", 
       RowBox[{"Transpose", "[", 
        RowBox[{"SolveLead", "[", 
         RowBox[{"\[Epsilon]", ",", 
          RowBox[{"system", "[", 
           RowBox[{"Sequence", "@@", "\[Phi]bloch"}], "]"}], ",", 
          RowBox[{"ComputeOnlyModes", "\[Rule]", "True"}]}], "]"}], "]"}]}]}],
      ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[CapitalDelta]LDoS", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}]}], "}"}], ",", "n_"}], "]"}], "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0.", ",", "latsize"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[CapitalDelta]LDoS", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"zmodeold_", ",", "zmodenew_"}], "}"}], ",", "n_"}], "]"}], ":=",
       "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"!", 
             RowBox[{"FreeQ", "[", 
              RowBox[{"#", ",", "Indeterminate"}], "]"}]}], ",", 
            RowBox[{
             RowBox[{"Print", "[", 
              RowBox[{"{", 
               RowBox[{"zmodeold", ",", "zmodenew"}], "}"}], "]"}], ";", 
             RowBox[{"Print", "[", "#", "]"}]}]}], "]"}], ";", "#"}], ")"}], 
        "&"}], "@", 
       RowBox[{"Total", "[", 
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[CapitalDelta]z", "=", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"#2", "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", "sweepaxis"}], "]"}], "]"}], "-", 
                 RowBox[{"#1", "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", "sweepaxis"}], "]"}], "]"}]}], ")"}]}], 
              "}"}], ",", "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"#1", "[", 
                 RowBox[{"[", "2", "]"}], "]"}], "===", "\[Infinity]"}], ",", 
               
               RowBox[{"\[CapitalDelta]z", 
                FractionBox[
                 SuperscriptBox[
                  RowBox[{"#2", "[", 
                   RowBox[{"[", "2", "]"}], "]"}], "2"], 
                 RowBox[{"n", "+", "1"}]]}], ",", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"#2", "[", 
                   RowBox[{"[", "2", "]"}], "]"}], "===", "\[Infinity]"}], 
                 ",", 
                 RowBox[{"\[CapitalDelta]z", 
                  FractionBox[
                   SuperscriptBox[
                    RowBox[{"#1", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "2"], 
                   RowBox[{"n", "+", "1"}]]}], ",", 
                 RowBox[{
                  FractionBox["1", "np"], 
                  FractionBox["1", 
                   RowBox[{"1", "+", "n"}]], 
                  FractionBox[
                   RowBox[{
                    SuperscriptBox[
                    RowBox[{"#2", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], 
                    RowBox[{"2", "+", 
                    RowBox[{"2", "/", "n"}]}]], "-", 
                    SuperscriptBox[
                    RowBox[{"#1", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], 
                    RowBox[{"2", "+", 
                    RowBox[{"2", "/", "n"}]}]]}], 
                   RowBox[{
                    SuperscriptBox["10", 
                    RowBox[{"-", "9"}]], "+", 
                    SuperscriptBox[
                    RowBox[{"#2", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], 
                    RowBox[{"2", "/", "n"}]], "-", 
                    SuperscriptBox[
                    RowBox[{"#1", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], 
                    RowBox[{"2", "/", "n"}]]}]]}]}], "]"}]}], "]"}]}], "]"}], 
           "&"}], ",", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"zmodeold", ",", "zmodenew"}], "}"}]}], "]"}], "]"}]}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"OptionValue", "@", "ScanRange"}], "===", "All"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"ranges", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"#", ",", 
            RowBox[{"N", "@", 
             RowBox[{"Range", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"-", "1"}], "/", "2"}], "+", 
                RowBox[{"1", "/", "np"}]}], ",", 
               RowBox[{"1", "/", "2"}], ",", 
               RowBox[{"1", "/", "np"}]}], "]"}]}]}], "}"}], "&"}], "/@", 
         "freezmomenta"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"ranges", "=", 
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"#1", ",", 
             RowBox[{"N", "@", 
              RowBox[{"Range", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"#2", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "+", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"#2", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "-", 
                    RowBox[{"#2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], ")"}], "/", "np"}]}], 
                ",", 
                RowBox[{"#2", "[", 
                 RowBox[{"[", "2", "]"}], "]"}], ",", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"#2", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "-", 
                   RowBox[{"#2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], ")"}], "/", "np"}]}], 
               "]"}]}]}], "}"}], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{"freezmomenta", ",", 
            RowBox[{"Sort", "/@", 
             RowBox[{
              FractionBox[
               RowBox[{"OptionValue", "@", "ScanRange"}], 
               RowBox[{"2", "\[Pi]"}]], "[", 
              RowBox[{"[", 
               RowBox[{"{", "sweepaxis", "}"}], "]"}], "]"}]}]}], "}"}]}], 
         "]"}]}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"LDoS", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0.", ",", "latsize"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"old", "=", 
      RowBox[{"zmodes", "[", 
       RowBox[{"momenta", "/.", 
        RowBox[{
         RowBox[{"z", "[", "_", "]"}], "\[Rule]", 
         RowBox[{"-", ".5"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "@", "MonitorFermiLine"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Monitor", "[", 
        RowBox[{
         RowBox[{"Do", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"LDoS", "+=", 
             RowBox[{"\[CapitalDelta]LDoS", "[", 
              RowBox[{
               RowBox[{"PadLists", "[", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"old", ",", 
                   RowBox[{"old", "=", 
                    RowBox[{"zmodes", "[", "momenta", "]"}]}]}], "}"}], ",", 
                 RowBox[{"z", "[", "sweepaxis", "]"}]}], "]"}], ",", 
               "edgepower"}], "]"}]}], ";"}], ",", 
           RowBox[{"Evaluate", "@", 
            RowBox[{"First", "@", "ranges"}]}]}], "]"}], ",", 
         RowBox[{"ListPlot", "[", 
          RowBox[{"zFermiLine", ",", " ", 
           RowBox[{"PlotRange", "\[Rule]", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "}"}], ".5"}]}], 
           ",", 
           RowBox[{"AspectRatio", "\[Rule]", "1"}]}], "]"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"LDoS", "+=", 
           RowBox[{"\[CapitalDelta]LDoS", "[", 
            RowBox[{
             RowBox[{"PadLists", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"old", ",", 
                 RowBox[{"old", "=", 
                  RowBox[{"zmodes", "[", "momenta", "]"}]}]}], "}"}], ",", 
               RowBox[{"z", "[", "sweepaxis", "]"}]}], "]"}], ",", 
             "edgepower"}], "]"}]}], ";"}], ",", 
         RowBox[{"Evaluate", "@", 
          RowBox[{"First", "@", "ranges"}]}]}], "]"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "@", "ReturnFermiLine"}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Chop", "[", 
           FractionBox["LDoS", 
            RowBox[{"\[Pi]", " ", "latsize"}]], "]"}], ",", "zFermiLine"}], 
         "}"}], "]"}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"Chop", "[", 
         FractionBox["LDoS", 
          RowBox[{"\[Pi]", " ", "latsize"}]], "]"}], "]"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.636209712377615*^9, 3.636209739824459*^9}, {
   3.636209813886341*^9, 3.636210119793867*^9}, {3.636210153616928*^9, 
   3.636210243478838*^9}, 3.636210293244609*^9, {3.6362103718806553`*^9, 
   3.636210626741679*^9}, {3.636210670740302*^9, 3.636210822869323*^9}, {
   3.6362108751812487`*^9, 3.6362108876748247`*^9}, {3.636210929737595*^9, 
   3.636211092115803*^9}, {3.636211129811298*^9, 3.6362111633212442`*^9}, {
   3.63621119979182*^9, 3.636211370520095*^9}, {3.6362114150234003`*^9, 
   3.63621145426178*^9}, {3.636211498877742*^9, 3.6362115131232767`*^9}, {
   3.6362115431561193`*^9, 3.636211690236611*^9}, 3.636211738539248*^9, {
   3.6362117706353693`*^9, 3.636212037352466*^9}, {3.6362120754956007`*^9, 
   3.6362122555500927`*^9}, {3.636216732999955*^9, 3.636216810883746*^9}, {
   3.63621688185878*^9, 3.636216895777034*^9}, {3.6362169528418694`*^9, 
   3.636217067611418*^9}, {3.636217543868429*^9, 3.6362175445469418`*^9}, {
   3.636217579474679*^9, 3.636217620208445*^9}, {3.636217655938376*^9, 
   3.636217757756041*^9}, 3.6362178005183573`*^9, {3.6362178415804863`*^9, 
   3.636218045018498*^9}, {3.636218092010666*^9, 3.636218101862862*^9}, {
   3.636218145238533*^9, 3.636218148517437*^9}, {3.636218189993843*^9, 
   3.636218332951317*^9}, {3.636218371089362*^9, 3.6362184033632*^9}, {
   3.636218446220995*^9, 3.6362185857408743`*^9}, {3.636218623320015*^9, 
   3.636218817183323*^9}, {3.6362188668486853`*^9, 3.636219068812992*^9}, {
   3.636219130915636*^9, 3.636219148102146*^9}, {3.6362191849699574`*^9, 
   3.636219251128572*^9}, {3.636219359668371*^9, 3.636219390297968*^9}, {
   3.636219421724265*^9, 3.63621962273724*^9}, {3.63621966769667*^9, 
   3.636219715845765*^9}, {3.6362198172582693`*^9, 3.636219841883141*^9}, {
   3.636219892032975*^9, 3.636219893650251*^9}, {3.636219965804927*^9, 
   3.6362199780281878`*^9}, {3.636220174734108*^9, 3.636220204108848*^9}, 
   3.636220247290393*^9, {3.636220295594902*^9, 3.6362202976978273`*^9}, {
   3.6362203313528633`*^9, 3.636220357167426*^9}, {3.636220395925839*^9, 
   3.636220451484254*^9}, {3.636220507237167*^9, 3.636220535224958*^9}, {
   3.636220570928224*^9, 3.636220590406865*^9}, {3.6362206793250847`*^9, 
   3.636220681028212*^9}, {3.6362218867133007`*^9, 3.636221949039014*^9}, {
   3.6362224665292788`*^9, 3.636222535653207*^9}, 3.6362226203307962`*^9, {
   3.636223126146474*^9, 3.636223133889202*^9}, 3.6362233372050734`*^9, 
   3.6362233844006987`*^9, {3.6362234908928556`*^9, 3.6362234970517273`*^9}, {
   3.636223557305624*^9, 3.6362235642573223`*^9}, {3.636223635175023*^9, 
   3.636223637061895*^9}, {3.6362237207380667`*^9, 3.636223761042253*^9}, {
   3.636223806554186*^9, 3.6362238080170803`*^9}, {3.636223858328569*^9, 
   3.6362238745903053`*^9}, {3.6362239625717173`*^9, 
   3.6362239800950127`*^9}, {3.636224024513502*^9, 3.636224046751708*^9}, {
   3.63622410321603*^9, 3.636224148837975*^9}, {3.636224181828053*^9, 
   3.636224217921258*^9}, {3.636224269977713*^9, 3.636224357892563*^9}, {
   3.6362244147755203`*^9, 3.6362244726058617`*^9}, {3.636224553225895*^9, 
   3.636224606435611*^9}, {3.6362246402596607`*^9, 3.63622464595378*^9}, {
   3.636224688722475*^9, 3.636224725231329*^9}, {3.6362248179169483`*^9, 
   3.636224844342986*^9}, {3.636224884218725*^9, 3.636224930864575*^9}, {
   3.636225127789003*^9, 3.636225147945321*^9}, {3.636225208931409*^9, 
   3.636225215429625*^9}, {3.636225283559354*^9, 3.6362254265908957`*^9}, {
   3.636225909745439*^9, 3.6362259148526783`*^9}, {3.6362266438360853`*^9, 
   3.6362266531602488`*^9}, {3.636227286689871*^9, 3.636227289768263*^9}, {
   3.636227347858036*^9, 3.636227351449053*^9}, {3.636227642773592*^9, 
   3.636227643520246*^9}, {3.6362766942726107`*^9, 3.6362767630447407`*^9}, {
   3.636276898664486*^9, 3.6362769187828712`*^9}, {3.636279604045567*^9, 
   3.636279751486513*^9}, {3.639215552658497*^9, 3.6392156493818502`*^9}, {
   3.6392157044986563`*^9, 3.6392157588678303`*^9}, {3.639215882317692*^9, 
   3.639215939063526*^9}, {3.639216057652203*^9, 3.639216063098941*^9}, {
   3.639216160358107*^9, 3.639216161120378*^9}, {3.639216282087199*^9, 
   3.6392163383028173`*^9}, {3.639216473534092*^9, 3.639216476318735*^9}, {
   3.639724827145258*^9, 3.6397248310793943`*^9}, {3.6424900786346827`*^9, 
   3.6424900794417353`*^9}},
 CellLabel->
  "In[493]:=",ExpressionUUID->"25bfe1ae-3c32-48df-8a76-728fe8b040ff"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
Reduce a system by integrating out a block, assumed diagonal, using constant \
self-energy\
\>", "Subsubsection",
 CellChangeTimes->{{3.6392076032786083`*^9, 
  3.63920765412363*^9}},ExpressionUUID->"ba1c0d69-c499-4964-8968-\
50551176232a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ReduceSystem", "::", "orb"}], "=", 
   "\"\<Multiorbital reduction not yet implemented\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ReduceSystem", "[", 
   RowBox[{"system_MQSystem", ",", " ", "dimblocktokeep_Integer"}], "]"}], ":=", 
  RowBox[{"ReduceSystem", "[", 
   RowBox[{"system", ",", 
    RowBox[{"Range", "[", "dimblocktokeep", "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ReduceSystem", "[", 
   RowBox[{"system_MQSystem", ",", " ", "sitestokeep_List"}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"iH22", ",", " ", 
      RowBox[{"HBloch", "=", 
       RowBox[{"system", "[", "\"\<HBloch\>\"", "]"}]}], ",", " ", 
      RowBox[{"H", "=", 
       RowBox[{"system", "[", "\"\<H\>\"", "]"}]}], ",", " ", "V21", ",", 
      "V12", ",", " ", "\[CapitalSigma]", ",", " ", "sitestoremove"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"system", "[", "\"\<SiteDimensions\>\"", "]"}], "\[NotEqual]",
         "1"}], ",", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"ReduceSystem", "::", "orb"}], "]"}], ";", 
        RowBox[{"Return", "[", "system", "]"}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"sitestoremove", "=", 
      RowBox[{"Complement", "[", 
       RowBox[{
        RowBox[{"Range", "[", 
         RowBox[{"system", "[", "\"\<NumberOfSites\>\"", "]"}], "]"}], ",", 
        "sitestokeep"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"iH22", "=", 
      RowBox[{"DiagonalMatrix", "@", 
       RowBox[{"SparseArray", "[", 
        RowBox[{"1", "/", 
         RowBox[{"(", 
          RowBox[{"Normal", "@", 
           RowBox[{"Diagonal", "@", 
            RowBox[{"H", "[", 
             RowBox[{"[", 
              RowBox[{"sitestoremove", ",", "sitestoremove"}], "]"}], 
             "]"}]}]}], ")"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"temp", "=", 
      RowBox[{
       RowBox[{"H", "[", 
        RowBox[{"[", 
         RowBox[{"sitestokeep", ",", "sitestokeep"}], "]"}], "]"}], "-", 
       RowBox[{
        RowBox[{"H", "[", 
         RowBox[{"[", 
          RowBox[{"sitestokeep", ",", "sitestoremove"}], "]"}], "]"}], ".", 
        "iH22", ".", 
        RowBox[{"H", "[", 
         RowBox[{"[", 
          RowBox[{"sitestoremove", ",", "sitestokeep"}], "]"}], "]"}]}]}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"V21", "=", 
      RowBox[{"MapAt", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"#", "[", 
          RowBox[{"[", 
           RowBox[{"sitestoremove", ",", "sitestokeep"}], "]"}], "]"}], "&"}],
         ",", "HBloch", ",", 
        RowBox[{"{", 
         RowBox[{"All", ",", "2"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"V12", "=", 
      RowBox[{"MapAt", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"#", "[", 
          RowBox[{"[", 
           RowBox[{"sitestokeep", ",", "sitestoremove"}], "]"}], "]"}], "&"}],
         ",", "HBloch", ",", 
        RowBox[{"{", 
         RowBox[{"All", ",", "2"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "@", 
       RowBox[{"Outer", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Max", "@", 
              RowBox[{"Abs", "[", 
               RowBox[{
                RowBox[{"#1", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], "+", 
                RowBox[{"#2", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], "\[LessEqual]", 
             "1"}], ",", 
            RowBox[{
             RowBox[{
              RowBox[{"#1", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "+", 
              RowBox[{"#2", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], "\[Rule]", 
             RowBox[{"-", 
              RowBox[{
               RowBox[{"#1", "[", 
                RowBox[{"[", "2", "]"}], "]"}], ".", "iH22", ".", 
               RowBox[{"#2", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}]}]}], ",", 
            RowBox[{"{", "}"}]}], "]"}], "&"}], ",", "V12", ",", "V21"}], 
        "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"HBloch", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}], "\[Rule]", 
           RowBox[{"Total", "[", 
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "}"}], "&"}], 
        "/@", 
        RowBox[{"(", 
         RowBox[{"Gather", "[", 
          RowBox[{
           RowBox[{"Join", "[", 
            RowBox[{
             RowBox[{"MapAt", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"sitestokeep", ",", "sitestokeep"}], "]"}], "]"}], 
                "&"}], ",", "HBloch", ",", 
               RowBox[{"{", 
                RowBox[{"All", ",", "2"}], "}"}]}], "]"}], ",", 
             "\[CapitalSigma]"}], "]"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"#1", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", 
             RowBox[{"#2", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "&"}]}], "]"}], ")"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"system", "[", 
       RowBox[{"\"\<HBloch\>\"", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{"HBloch", "&"}], ")"}]}], "]"}], "[", 
      RowBox[{"\"\<Lattice\>\"", "\[Rule]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"RemoveSites", "[", 
          RowBox[{"#", ",", "sitestoremove"}], "]"}], "&"}], ")"}]}], 
      "]"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.639213908097929*^9, 3.639213961966351*^9}, {
   3.6392143284235888`*^9, 3.639214378465179*^9}, 3.639214409296973*^9, {
   3.6392144422450933`*^9, 3.6392144451037693`*^9}, {3.6392145175070753`*^9, 
   3.639214544742548*^9}, 3.639214610303029*^9, {3.639214921015407*^9, 
   3.639214922135067*^9}, 3.639214958140745*^9},
 CellLabel->
  "In[497]:=",ExpressionUUID->"307d93b3-493e-454b-983b-655edb2ff377"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["Extras", "Section",
 CellChangeTimes->{{3.662278215983877*^9, 
  3.6622782172950993`*^9}},ExpressionUUID->"f04613a5-43e6-4d39-8cf3-\
527860ad3c1d"],

Cell[CellGroupData[{

Cell["Graphics", "Subsection",
 CellChangeTimes->{{3.6622782233909082`*^9, 
  3.662278231366473*^9}},ExpressionUUID->"cfb72009-de4e-416d-83e3-\
8c77d00e9507"],

Cell["Legends", "Text",
 CellChangeTimes->{{3.6622782458163233`*^9, 
  3.6622782466616793`*^9}},ExpressionUUID->"9c54f10d-8469-40fc-a510-\
9648d55c2327"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", "HorizontalGradientBar", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"HorizontalGradientBar", "[", 
   RowBox[{"colorfunc_", ",", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"x0_", ",", "x1_"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"y0_", ",", "y1_"}], "}"}]}], "}"}], ",", " ", 
    RowBox[{"tags_:", 
     RowBox[{"{", "}"}]}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"npoints", "=", "100"}], ",", " ", "dx"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"dx", "=", 
      FractionBox[
       RowBox[{"x1", "-", "x0"}], 
       RowBox[{"npoints", "-", "1"}]]}], ";", "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FaceForm", "[", 
            RowBox[{"colorfunc", "[", 
             FractionBox[
              RowBox[{"#", "-", "x0"}], 
              RowBox[{"x1", "-", "x0"}]], "]"}], "]"}], ",", 
           RowBox[{"Rectangle", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"#", ",", "y0"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"#", "+", "dx"}], ",", "y1"}], "}"}]}], "]"}]}], "}"}],
          "&"}], "/@", 
        RowBox[{"Most", "@", 
         RowBox[{"Range", "[", 
          RowBox[{"x0", ",", "x1", ",", "dx"}], "]"}]}]}], ",", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"FaceForm", "[", "None", "]"}], ",", 
         RowBox[{"EdgeForm", "[", "Black", "]"}], ",", 
         RowBox[{"Rectangle", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"x0", ",", "y0"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"x1", ",", "y1"}], "}"}]}], "]"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "tags", "]"}], ">", "1"}], ",", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Text", "[", 
             RowBox[{"#1", ",", 
              RowBox[{"{", 
               RowBox[{"#2", ",", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"y1", "+", "y0"}], ")"}], "/", "2"}]}], "}"}]}], 
             "]"}], "&"}], ",", 
           RowBox[{"{", 
            RowBox[{"tags", ",", 
             RowBox[{"Range", "[", 
              RowBox[{"x0", ",", "x1", ",", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"x1", "-", "x0"}], ")"}], "/", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Length", "[", "tags", "]"}], "-", "1"}], ")"}]}]}],
               "]"}]}], "}"}]}], "]"}], ",", 
         RowBox[{"{", "}"}]}], "]"}]}], "}"}]}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.662278287374166*^9, 3.662278465780113*^9}, {
  3.662278530945981*^9, 3.662278574534881*^9}, {3.662288703742984*^9, 
  3.6622887206465397`*^9}, {3.66228899160039*^9, 3.66228899225561*^9}},
 CellLabel->
  "In[500]:=",ExpressionUUID->"ed5d90a5-dc42-48d2-8cd6-95fe0052795a"],

Cell["Plot Tagging", "Text",
 CellChangeTimes->{{3.65882019125863*^9, 
  3.658820195745657*^9}},ExpressionUUID->"47c6fe0c-2dea-467d-b68b-\
54e212940f14"],

Cell[BoxData[{
 RowBox[{"Clear", "[", "Tag", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Tag", "[", 
    RowBox[{"name_String", ",", 
     RowBox[{"opts", ":", " ", 
      RowBox[{"OptionsPattern", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"FontFamily", "->", "\"\<Helvetica\>\""}], ",", 
         RowBox[{"FontSize", "\[Rule]", "15"}]}], "}"}], "]"}]}]}], "]"}], 
   "[", "fig_", "]"}], ":=", 
  RowBox[{"Overlay", "[", 
   RowBox[{"{", 
    RowBox[{"fig", ",", 
     RowBox[{"Style", "[", 
      RowBox[{"name", ",", "Bold", ",", 
       RowBox[{"FontFamily", "\[Rule]", 
        RowBox[{"OptionValue", "[", "FontFamily", "]"}]}], ",", 
       RowBox[{"OptionValue", "[", "FontSize", "]"}]}], "]"}]}], "}"}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.658820209874199*^9, 3.658820215025362*^9}, {
  3.658820299670492*^9, 3.658820354618105*^9}},
 CellLabel->
  "In[502]:=",ExpressionUUID->"4312f548-4444-4a6c-9a98-36a49134a10d"],

Cell["Plot alignment", "Text",
 CellChangeTimes->{{3.7402250103559713`*^9, 
  3.740225013130106*^9}},ExpressionUUID->"10b097e9-e242-45fe-9e80-\
6d382a5ad363"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"InnerPadding", "::", "usage"}], "=", 
   "\"\<Option to AlignPlots of the form {{\!\(\*SubscriptBox[\(\
\[CapitalDelta]x\), \(-\)]\), \!\(\*SubscriptBox[\(\[CapitalDelta]x\), \(+\)]\
\)},{\!\(\*SubscriptBox[\(\[CapitalDelta]y\), \(-\)]\), \!\(\*SubscriptBox[\(\
\[CapitalDelta]y\), \(+\)]\)}} that specifies the padding margins between \
panels\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"OuterPadding", "::", "usage"}], "=", 
   "\"\<Option to AlignPlots of the form {{\!\(\*SubscriptBox[\(\
\[CapitalDelta]x\), \(-\)]\), \!\(\*SubscriptBox[\(\[CapitalDelta]x\), \(+\)]\
\)},{\!\(\*SubscriptBox[\(\[CapitalDelta]y\), \(-\)]\), \!\(\*SubscriptBox[\(\
\[CapitalDelta]y\), \(+\)]\)}} that specifies the padding margins around \
array of panels\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SharedAxes", "::", "usage"}], "=", 
   "\"\<Option to AlignPlots of the form True or False that specifies whether \
to omit shared Axes and Frame sides\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"PanelSize", "::", "usage"}], "=", 
    "\"\<Option to AlignPlots similar to ImageSize that specifies the size of \
each panel. It can be a number sizex, {Automatic, sizey}, {sizex, Automatic}, \
or even {sizesx_List, sizesy_List}.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "AlignPlots", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"PanelSize", "\[Rule]", "180"}], ",", 
     RowBox[{"InnerPadding", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1", ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "1"}], "}"}]}], "}"}]}], ",", 
     RowBox[{"SharedAxes", "\[Rule]", "True"}], ",", 
     RowBox[{"OuterPadding", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"55", ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"40", ",", "1"}], "}"}]}], "}"}]}], ",", 
     RowBox[{"Flatten", "@", 
      RowBox[{"Options", "[", "Show", "]"}]}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"AlignPlots", "[", 
    RowBox[{
     RowBox[{"plots_", "?", "MatrixQ"}], ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "m", ",", "n", ",", " ", "sizes", ",", "showopts", ",", "aspects", ",", 
       "pad", ",", "framelabel", ",", " ", "frameticks", ",", "axeslabel", 
       ",", " ", "ticks", ",", "updateframe", ",", " ", "updateaxes", ",", 
       "makearray", ",", "grid", ",", "plotlabels", ",", 
       "\[IndentingNewLine]", 
       RowBox[{"shared", "=", 
        RowBox[{"OptionValue", "[", "SharedAxes", "]"}]}], ",", 
       RowBox[{"size", "=", 
        RowBox[{"OptionValue", "[", "PanelSize", "]"}]}], ",", " ", 
       RowBox[{"ipad", "=", 
        RowBox[{"OptionValue", "[", "InnerPadding", "]"}]}], ",", " ", 
       RowBox[{"opad", "=", 
        RowBox[{"OptionValue", "[", "OuterPadding", "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"m", ",", "n"}], "}"}], "=", 
       RowBox[{"Dimensions", "[", "plots", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"showopts", "=", 
       RowBox[{"FilterRules", "[", 
        RowBox[{
         RowBox[{"{", "opts", "}"}], ",", 
         RowBox[{"Options", "[", "Show", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"aspects", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"getoption", "[", 
           RowBox[{"AspectRatio", ",", "#"}], "]"}], "&"}], ",", "plots", ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"framelabel", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"getoption", "[", 
           RowBox[{"FrameLabel", ",", "#"}], "]"}], "&"}], ",", "plots", ",", 
         
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"frameticks", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"getoption", "[", 
           RowBox[{"FrameTicks", ",", "#"}], "]"}], "&"}], ",", "plots", ",", 
         
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"axeslabel", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"getoption", "[", 
           RowBox[{"AxesLabel", ",", "#"}], "]"}], "&"}], ",", "plots", ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"plotlabels", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"getoption", "[", 
           RowBox[{"PlotLabel", ",", "#"}], "]"}], "&"}], ",", "plots", ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ticks", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"getoption", "[", 
           RowBox[{"Ticks", ",", "#"}], "]"}], "&"}], ",", "plots", ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"framelabel", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Head", "[", "#", "]"}], "===", "Symbol"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"#", ",", "#"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"#", ",", "#"}], "}"}]}], "}"}], ",", "#"}], "]"}], 
          "&"}], ",", "framelabel", ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"frameticks", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Head", "[", "#", "]"}], "===", "Symbol"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"#", ",", "#"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"#", ",", "#"}], "}"}]}], "}"}], ",", "#"}], "]"}], 
          "&"}], ",", "frameticks", ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"updateframe", "[", "opt0_", "]"}], ":=", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"opt", "=", "opt0"}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"m", ">", "1"}], ",", 
            RowBox[{
             RowBox[{
              RowBox[{"opt", "[", 
               RowBox[{"[", 
                RowBox[{
                 RowBox[{"1", ";;", 
                  RowBox[{"m", "-", "1"}]}], ",", "All"}], "]"}], "]"}], "[", 
              
              RowBox[{"[", 
               RowBox[{"2", ",", "1"}], "]"}], "]"}], "=", 
             RowBox[{
              RowBox[{
               RowBox[{"opt", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"2", ";;", "m"}], ",", "All"}], "]"}], "]"}], "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "2"}], "]"}], "]"}], "=", "None"}]}]}], 
           "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"n", ">", "1"}], ",", 
            RowBox[{
             RowBox[{
              RowBox[{"opt", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", 
                 RowBox[{"2", ";;", "n"}]}], "]"}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "1"}], "]"}], "]"}], "=", 
             RowBox[{
              RowBox[{
               RowBox[{"opt", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", 
                  RowBox[{"1", ";;", 
                   RowBox[{"n", "-", "1"}]}]}], "]"}], "]"}], "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", "None"}]}]}], " ",
            "]"}], ";", "\[IndentingNewLine]", "opt"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"updateaxes", "[", "opt0_", "]"}], ":=", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"opt", "=", "opt0"}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"m", ">", "1"}], ",", 
            RowBox[{
             RowBox[{
              RowBox[{"opt", "[", 
               RowBox[{"[", 
                RowBox[{
                 RowBox[{"1", ";;", 
                  RowBox[{"m", "-", "1"}]}], ",", "All"}], "]"}], "]"}], "[", 
              
              RowBox[{"[", "1", "]"}], "]"}], "=", "None"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"n", ">", "1"}], ",", 
            RowBox[{
             RowBox[{
              RowBox[{"opt", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", 
                 RowBox[{"2", ";;", "n"}]}], "]"}], "]"}], "[", 
              RowBox[{"[", "2", "]"}], "]"}], "=", "None"}]}], "]"}], " ", 
          ";", "\[IndentingNewLine]", "opt"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"shared", ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"framelabel", "=", 
          RowBox[{"updateframe", "[", "framelabel", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"frameticks", "=", 
          RowBox[{"updateframe", "[", "frameticks", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"axeslabel", "=", 
          RowBox[{"updateaxes", "[", "axeslabel", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"ticks", "=", 
          RowBox[{"updateaxes", "[", "ticks", "]"}]}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"pad", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"j", "==", "1"}], ",", 
               RowBox[{"opad", "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
               RowBox[{"ipad", "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "1"}], "]"}], "]"}]}], "]"}], ",", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"j", "==", "n"}], ",", 
               RowBox[{"opad", "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "2"}], "]"}], "]"}], ",", 
               RowBox[{"ipad", "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "2"}], "]"}], "]"}]}], "]"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"i", "\[Equal]", "m"}], ",", 
               RowBox[{"opad", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "1"}], "]"}], "]"}], ",", 
               RowBox[{"ipad", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "1"}], "]"}], "]"}]}], "]"}], ",", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"i", "==", "1"}], ",", 
               RowBox[{"opad", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "2"}], "]"}], "]"}], ",", 
               RowBox[{"ipad", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "2"}], "]"}], "]"}]}], "]"}]}], "}"}]}], 
          "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "m"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"sizes", ",", " ", "aspects"}], "}"}], "=", 
       RowBox[{"sizesandaspects", "[", 
        RowBox[{"size", ",", "aspects", ",", "pad", ",", 
         RowBox[{"{", 
          RowBox[{"m", ",", "n"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"grid", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Show", "[", 
          RowBox[{
           RowBox[{"plots", "[", 
            RowBox[{"[", 
             RowBox[{"i", ",", "j"}], "]"}], "]"}], ",", " ", 
           "\[IndentingNewLine]", 
           RowBox[{"ImageSize", "\[Rule]", 
            RowBox[{"sizes", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "j"}], "]"}], "]"}]}], ",", 
           RowBox[{"AspectRatio", "\[Rule]", 
            RowBox[{"aspects", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "j"}], "]"}], "]"}]}], ",", 
           RowBox[{"ImagePadding", "\[Rule]", 
            RowBox[{"pad", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "j"}], "]"}], "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"FrameLabel", "\[Rule]", 
            RowBox[{"framelabel", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "j"}], "]"}], "]"}]}], ",", 
           RowBox[{"FrameTicks", "\[Rule]", 
            RowBox[{"frameticks", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "j"}], "]"}], "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"AxesLabel", "\[Rule]", 
            RowBox[{"axeslabel", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "j"}], "]"}], "]"}]}], ",", 
           RowBox[{"Ticks", "\[Rule]", 
            RowBox[{"ticks", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "j"}], "]"}], "]"}]}], ",", 
           "\[IndentingNewLine]", "showopts"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "m"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "grid", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getoption", "[", 
   RowBox[{"opt_", ",", "g_Graphics"}], "]"}], ":=", 
  RowBox[{"opt", "/.", 
   RowBox[{"Options", "[", 
    RowBox[{"g", ",", "opt"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getoption", "[", 
    RowBox[{"opt_", ",", "l_Legended"}], "]"}], ":=", 
   RowBox[{"opt", "/.", 
    RowBox[{"Options", "[", 
     RowBox[{
      RowBox[{"l", "[", 
       RowBox[{"[", "1", "]"}], "]"}], ",", "opt"}], "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"sizesandaspects", "[", 
   RowBox[{"size0_", ",", "aspects0_", ",", "pad_", ",", 
    RowBox[{"{", 
     RowBox[{"m_", ",", "n_"}], "}"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"makearray", ",", " ", "actualsize", ",", "sizes", ",", 
      RowBox[{"size", "=", "size0"}], ",", " ", 
      RowBox[{"aspects", "=", "aspects0"}], ",", " ", "noauto"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"makearray", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"s1_", "?", "NumericQ"}], "|", "s1_Symbol"}], ",", 
         RowBox[{
          RowBox[{"s2_", "?", "NumericQ"}], "|", "s2_Symbol"}]}], "}"}], 
       "]"}], ":=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"ConstantArray", "[", 
         RowBox[{"s1", ",", "n"}], "]"}], ",", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"s2", ",", "m"}], "]"}]}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"makearray", "[", 
       RowBox[{"{", 
        RowBox[{"s1_List", ",", 
         RowBox[{
          RowBox[{"s2_", "?", "NumericQ"}], "|", "s2_Symbol"}]}], "}"}], 
       "]"}], ":=", 
      RowBox[{"{", 
       RowBox[{"s1", ",", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"s2", ",", "m"}], "]"}]}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"makearray", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"s1_", "?", "NumericQ"}], "|", "s1_Symbol"}], ",", ",", 
         "s2_List"}], "}"}], "]"}], ":=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"ConstantArray", "[", 
         RowBox[{"s1", ",", "n"}], "]"}], ",", " ", "s2"}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"makearray", "[", 
       RowBox[{"{", 
        RowBox[{"s1_List", ",", "s2_List"}], "}"}], "]"}], ":=", 
      RowBox[{"{", 
       RowBox[{"s1", ",", "s2"}], "}"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"makearray", "[", "s_", "]"}], ":=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"ConstantArray", "[", 
         RowBox[{"s", ",", "n"}], "]"}], ",", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"Automatic", ",", "m"}], "]"}]}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"size", "=", 
      RowBox[{"makearray", "[", "size0", "]"}]}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "/@", "size"}], "!=", 
        RowBox[{"{", 
         RowBox[{"n", ",", "m"}], "}"}]}], ",", " ", 
       RowBox[{"Throw", "[", "\"\<Error with PanelSize\>\"", "]"}]}], "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"noauto", "[", 
       RowBox[{
        RowBox[{"s_", "?", "NumericQ"}], ",", "ss_", ",", "as_"}], "]"}], ":=",
       "s"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"noauto", "[", 
       RowBox[{"Automatic", ",", "ss_", ",", "as_"}], "]"}], ":=", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", "===", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"Throw", "[", "\"\<Specify a PanelSize\>\"", "]"}], ",", 
          RowBox[{"First", "[", "#", "]"}]}], "]"}], "&"}], "[", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{"ss", " ", "as"}], ",", " ", "NumericQ", ",", "1"}], "]"}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"size", "[", 
       RowBox[{"[", "1", "]"}], "]"}], " ", "=", " ", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"noauto", "[", 
         RowBox[{
          RowBox[{"size", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "j"}], "]"}], "]"}], ",", 
          RowBox[{"size", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", "  ", 
          RowBox[{"1", "/", 
           RowBox[{"aspects", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "j"}], "]"}], "]"}]}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"size", "[", 
       RowBox[{"[", "2", "]"}], "]"}], " ", "=", " ", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"noauto", "[", 
         RowBox[{
          RowBox[{"size", "[", 
           RowBox[{"[", 
            RowBox[{"2", ",", "i"}], "]"}], "]"}], ",", 
          RowBox[{"size", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", 
          RowBox[{"aspects", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "All"}], "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "m"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"aspects", " ", "=", " ", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"size", "[", 
          RowBox[{"[", 
           RowBox[{"2", ",", "i"}], "]"}], "]"}], "/", 
         RowBox[{"size", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "j"}], "]"}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "m"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"sizes", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"size", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "j"}], "]"}], "]"}], ",", 
           RowBox[{"size", "[", 
            RowBox[{"[", 
             RowBox[{"2", ",", "i"}], "]"}], "]"}]}], "}"}], "+", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Total", "[", 
            RowBox[{
             RowBox[{"pad", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "j"}], "]"}], "]"}], "[", 
             RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
           RowBox[{"Total", "[", 
            RowBox[{
             RowBox[{"pad", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "j"}], "]"}], "]"}], "[", 
             RowBox[{"[", "2", "]"}], "]"}], "]"}]}], "}"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "m"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Return", "[", 
      RowBox[{"{", 
       RowBox[{"sizes", ",", "aspects"}], "}"}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.7402286586319*^9, 3.740228795442005*^9}, {
   3.740228832353423*^9, 3.740228906425556*^9}, {3.740229388831709*^9, 
   3.740229512133026*^9}, {3.740229549613433*^9, 3.740229550627592*^9}, {
   3.7402295853496313`*^9, 3.7402296119629908`*^9}, {3.740229642443507*^9, 
   3.74022980187211*^9}, {3.740229903006304*^9, 3.740230070018652*^9}, {
   3.740230102260716*^9, 3.740230176806161*^9}, {3.740230934112973*^9, 
   3.740231128333889*^9}, {3.7402312869376087`*^9, 3.740231295199747*^9}, {
   3.740231371660735*^9, 3.740231444427205*^9}, {3.740232254434417*^9, 
   3.740232260025805*^9}, {3.740232307546492*^9, 3.7402323745533533`*^9}, {
   3.7402325071612062`*^9, 3.740232641601161*^9}, {3.740232679032859*^9, 
   3.740232778285428*^9}, {3.7402328155680113`*^9, 3.740233126614272*^9}, {
   3.740233187886346*^9, 3.740233221523774*^9}, {3.7402332558169813`*^9, 
   3.7402336131665583`*^9}, {3.740233750816246*^9, 3.74023399635037*^9}, {
   3.74023405602083*^9, 3.740234255061027*^9}, {3.740234480925694*^9, 
   3.740234738761166*^9}, {3.7402347954837837`*^9, 3.740234954609198*^9}, {
   3.7402350369855843`*^9, 3.7402350394571123`*^9}, {3.740235090902076*^9, 
   3.740235121961708*^9}, {3.740235165246702*^9, 3.740235521285787*^9}, {
   3.740235585676557*^9, 3.740235606699005*^9}, {3.7402356693468647`*^9, 
   3.7402356733624353`*^9}, {3.740235773071177*^9, 3.740235793314228*^9}, {
   3.7402358984358997`*^9, 3.7402359238023767`*^9}, {3.7402360363560867`*^9, 
   3.740236043043157*^9}, {3.740236184510168*^9, 3.740236191325274*^9}, {
   3.7402362263660803`*^9, 3.740236232493919*^9}, {3.740236503816999*^9, 
   3.7402365081832237`*^9}, {3.740236668784091*^9, 3.74023681413652*^9}, {
   3.740236849895965*^9, 3.7402368591035643`*^9}, {3.740236929721628*^9, 
   3.740236955912282*^9}, {3.740239196404982*^9, 3.740239199481894*^9}, {
   3.740239302111249*^9, 3.740239336098529*^9}, {3.740239576550186*^9, 
   3.7402396233954144`*^9}, {3.7402400291730747`*^9, 3.740240039157868*^9}, {
   3.7402400921347933`*^9, 3.740240105742074*^9}, {3.740240202863295*^9, 
   3.740240269086596*^9}, {3.740240309151495*^9, 3.740240318038248*^9}, {
   3.740241056237501*^9, 3.740241130844161*^9}, {3.740241162252527*^9, 
   3.740241234245624*^9}, {3.7405150856144648`*^9, 3.740515136348083*^9}, {
   3.7407226314286957`*^9, 3.740722747227418*^9}, {3.740724326830564*^9, 
   3.740724350482088*^9}, {3.740724435099525*^9, 3.740724495361966*^9}, 
   3.740724615836611*^9, {3.740724659716546*^9, 3.7407247578434973`*^9}, {
   3.740724816108129*^9, 3.740724846475833*^9}, {3.7407257746475677`*^9, 
   3.740725868025915*^9}},
 CellLabel->
  "In[504]:=",ExpressionUUID->"9b4b9278-8338-49df-aa4a-db3569227381"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ExpandPlot", "[", 
   RowBox[{"plot_", ",", 
    RowBox[{"{", 
     RowBox[{"\[CapitalDelta]x_", ",", "\[CapitalDelta]y_"}], "}"}]}], "]"}], 
  ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"size", ",", " ", "newplot"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"size", "=", 
      RowBox[{"getoption", "[", 
       RowBox[{"ImageSize", ",", "plot"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"size", "===", "Automatic"}], ",", " ", 
       RowBox[{"newplot", "=", "plot"}], ",", "\[IndentingNewLine]", 
       RowBox[{"newplot", "=", 
        RowBox[{"Show", "[", 
         RowBox[{"plot", ",", " ", 
          RowBox[{"ImageSize", "\[Rule]", 
           RowBox[{"size", "+", 
            RowBox[{"{", 
             RowBox[{"\[CapitalDelta]x", ",", "\[CapitalDelta]y"}], 
             "}"}]}]}]}], "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Return", "[", "newplot", "]"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.740241249116435*^9, 3.740241347245965*^9}, 
   3.7402414201499166`*^9},
 CellLabel->
  "In[513]:=",ExpressionUUID->"9ee7b3b8-07f4-4999-bccb-623be8f2f3e6"]
}, Open  ]]
}, Open  ]]
},
WindowSize->{818, 1005},
WindowMargins->{{Automatic, 0}, {Automatic, 0}},
ShowSelection->True,
FrontEndVersion->"12.1 for Mac OS X x86 (64-bit) (March 18, 2020)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"3a6451d2-8933-4dbf-83ff-c1ca4572ec12"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[579, 22, 600, 9, 67, "Section",ExpressionUUID->"cd22e688-f470-4680-87da-25388b4b55b5"],
Cell[CellGroupData[{
Cell[1204, 35, 251, 4, 54, "Subsection",ExpressionUUID->"e96489e7-8028-41db-b27d-0bc3aefbac22"],
Cell[1458, 41, 213, 5, 31, "Text",ExpressionUUID->"afb87119-c016-4d06-9fb7-9abdfac51aec"],
Cell[1674, 48, 1472, 28, 403, "Text",ExpressionUUID->"15b01f8d-d832-4eda-8ed7-239ee0a7f65e"]
}, Closed]],
Cell[CellGroupData[{
Cell[3183, 81, 163, 3, 38, "Subsection",ExpressionUUID->"a5398dc3-a4f2-45cf-bfe3-9873562342fc"],
Cell[CellGroupData[{
Cell[3371, 88, 158, 3, 45, "Subsubsection",ExpressionUUID->"e118da1c-40fb-484e-a3cf-1fb98fecf5b1"],
Cell[3532, 93, 5081, 88, 780, "Text",ExpressionUUID->"bf73ff40-fef4-458c-bd3b-2d5d48a0e2b3"]
}, Open  ]],
Cell[CellGroupData[{
Cell[8650, 186, 141, 3, 45, "Subsubsection",ExpressionUUID->"a65a86bd-ebf4-4245-9dd1-d557dcf541f1"],
Cell[8794, 191, 1946, 38, 246, "Text",ExpressionUUID->"c2b46c93-b88f-4d9d-8a91-65f90ff6cd12"]
}, Open  ]],
Cell[CellGroupData[{
Cell[10777, 234, 222, 4, 45, "Subsubsection",ExpressionUUID->"7334bdbb-5c0c-45f4-b4b9-7986ecba4ed7"],
Cell[11002, 240, 4029, 66, 383, "Text",ExpressionUUID->"932c8bd3-ae05-4ba2-91a8-c4a8defc367e"]
}, Open  ]],
Cell[CellGroupData[{
Cell[15068, 311, 160, 3, 45, "Subsubsection",ExpressionUUID->"46fdaf51-1cdb-4f34-af1f-499e93df54c4"],
Cell[15231, 316, 3210, 63, 796, "Text",ExpressionUUID->"2014de58-1d09-48f8-84c8-9925c462c056"]
}, Open  ]]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[18502, 386, 149, 3, 53, "Section",ExpressionUUID->"67b6cebb-1f95-4ed6-957f-9c5eb2473d9f"],
Cell[18654, 391, 598, 14, 52, "Input",ExpressionUUID->"69c56072-bce5-438c-a276-ea1a9565578e"],
Cell[CellGroupData[{
Cell[19277, 409, 257, 4, 54, "Subsection",ExpressionUUID->"8f94a3c6-5afc-49e0-a98f-a0dcc07374ac"],
Cell[19537, 415, 442, 6, 35, "Text",ExpressionUUID->"abbe5c14-6f6c-4f0e-b692-c0efa522825a"],
Cell[19982, 423, 13111, 274, 1654, "Input",ExpressionUUID->"f159e95b-38b0-4511-92f7-87a9d1a63a65"],
Cell[33096, 699, 511, 9, 58, "Text",ExpressionUUID->"5c5f998a-c21d-4469-9be3-bddeca6108ef"],
Cell[33610, 710, 786, 19, 115, "Input",ExpressionUUID->"895e5d95-7ea1-4ea7-b0a4-7c9f1beaae8b"],
Cell[34399, 731, 48301, 1254, 4474, "Input",ExpressionUUID->"39b9d71d-9652-40f2-a830-97087880be44"],
Cell[82703, 1987, 2844, 59, 358, "Input",ExpressionUUID->"e84b6709-d5fa-4f77-a699-08f6ef79397f"],
Cell[85550, 2048, 160, 3, 35, "Text",ExpressionUUID->"13fa215d-60c2-4633-bc2f-49050a3851a8"],
Cell[85713, 2053, 1664, 45, 157, "Input",ExpressionUUID->"33d7e375-cd5b-4ed3-aece-e4ef02c4a600"],
Cell[87380, 2100, 161, 3, 35, "Text",ExpressionUUID->"2659125a-d7de-4605-8f61-fa147d957422"],
Cell[87544, 2105, 3427, 88, 283, "Input",ExpressionUUID->"8d224c67-5561-40c7-9578-611e31830a81"],
Cell[90974, 2195, 160, 3, 35, "Text",ExpressionUUID->"826f227b-c925-4e4b-bcf3-f164e73aa7e6"],
Cell[91137, 2200, 608, 16, 30, "Input",ExpressionUUID->"d92dc094-b1e4-4ee3-b43f-d31edb8e25ad"],
Cell[91748, 2218, 183, 3, 35, "Text",ExpressionUUID->"4c1fd15b-2847-444e-bea8-5233256cfd26"],
Cell[91934, 2223, 8178, 158, 1060, "Input",ExpressionUUID->"3fcf4910-a7e4-4fcb-a591-834618a46ba8"],
Cell[100115, 2383, 150, 3, 35, "Text",ExpressionUUID->"949a1acf-3e2c-4d9f-aee1-e7bcd35a3745"],
Cell[100268, 2388, 231, 5, 30, "Input",ExpressionUUID->"3c46dbd2-5d8c-4e6f-9456-ae2d5d7822d1"]
}, Closed]],
Cell[CellGroupData[{
Cell[100536, 2398, 169, 3, 38, "Subsection",ExpressionUUID->"cadafcae-da97-4dae-a418-75e5f6390aa7"],
Cell[100708, 2403, 387, 11, 30, "Input",ExpressionUUID->"927a4088-71c5-4999-8800-276edb84f787"],
Cell[101098, 2416, 5549, 137, 637, "Input",ExpressionUUID->"0fa73d88-9b6b-4a6b-bfe7-a19306b47aec"],
Cell[106650, 2555, 191, 3, 35, "Text",ExpressionUUID->"a687a2a7-05d0-4a9a-9e6a-04704ad8e12f"],
Cell[106844, 2560, 2292, 57, 220, "Input",ExpressionUUID->"c5eaeced-f0d1-4e2d-9a45-2a8b38ec7135"],
Cell[109139, 2619, 238, 6, 35, "Text",ExpressionUUID->"35bd862e-d0ac-41b9-830a-878f5ce4090a"],
Cell[109380, 2627, 17637, 418, 1480, "Input",ExpressionUUID->"0f88713a-584d-4320-a469-4f0af8f4bdb7"],
Cell[127020, 3047, 541, 10, 104, "Text",ExpressionUUID->"930df3c4-a4a5-49a7-95d7-142f7cf98b57"],
Cell[127564, 3059, 2809, 78, 157, "Input",ExpressionUUID->"4e19fb14-b081-42d0-9b95-0f1108ffab65"],
Cell[130376, 3139, 586, 11, 81, "Text",ExpressionUUID->"67db5dde-49af-4db9-a5d0-3efd5f54f483"],
Cell[130965, 3152, 5983, 153, 724, "Input",ExpressionUUID->"52f1116d-2f3e-4a74-9fae-6715ac669cb1"],
Cell[136951, 3307, 297, 7, 35, "Text",ExpressionUUID->"a1720522-2568-4644-992e-d9d0a87a1e0b"],
Cell[137251, 3316, 548, 15, 52, "Input",ExpressionUUID->"49904088-6550-45b5-9e25-4af059d48204"],
Cell[137802, 3333, 161, 3, 35, "Text",ExpressionUUID->"c893b609-886f-4c41-ad0d-38d5b1126c7b"],
Cell[137966, 3338, 566, 16, 30, "Input",ExpressionUUID->"b934363b-ef19-47a9-b334-de3705b7a1cd"],
Cell[138535, 3356, 237, 4, 35, "Text",ExpressionUUID->"90c5b0c5-0380-498f-926d-06393adf4d77"],
Cell[138775, 3362, 6476, 147, 787, "Input",ExpressionUUID->"7434fad4-5035-4287-8d6c-2cc8d9440e94"],
Cell[145254, 3511, 163, 3, 35, "Text",ExpressionUUID->"96d21d9c-8700-4d5e-b3c9-c6132da04ee3"],
Cell[145420, 3516, 6952, 215, 346, "Input",ExpressionUUID->"5bf97291-b845-4ce3-8671-acbc26514ecb"],
Cell[152375, 3733, 265, 7, 58, "Text",ExpressionUUID->"1c02f269-a4a4-4089-a7c3-4b76b2cabe43"],
Cell[152643, 3742, 1952, 60, 178, "Input",ExpressionUUID->"85880098-e953-4496-9f89-255f578da65b"],
Cell[154598, 3804, 799, 20, 52, "Input",ExpressionUUID->"cb3c7b3c-af8a-4225-a029-b0b9d9d699a5"],
Cell[155400, 3826, 1800, 49, 265, "Input",ExpressionUUID->"a23d7914-4f62-462e-8619-3feeb8763d1b"],
Cell[157203, 3877, 5289, 137, 535, "Input",ExpressionUUID->"03fd85dc-7635-4bee-bfc3-e44ba6826b1e"]
}, Open  ]],
Cell[CellGroupData[{
Cell[162529, 4019, 258, 4, 54, "Subsection",ExpressionUUID->"395e8849-ec81-4b72-8b5a-f1313d3c946a"],
Cell[162790, 4025, 227, 4, 35, "Text",ExpressionUUID->"9a045385-8700-4d28-9583-3bec5a6553d3"],
Cell[163020, 4031, 867, 19, 52, "Input",ExpressionUUID->"8443fd08-9637-47dd-9532-c181e8b7635e"],
Cell[CellGroupData[{
Cell[163912, 4054, 61154, 1298, 5575, "Input",ExpressionUUID->"f37536ec-0aed-4cbb-9be1-8883fef5d0f4"],
Cell[225069, 5354, 1015, 15, 70, "Output",ExpressionUUID->"103dc98c-4374-4dfb-ba68-0a48f20d8aea"]
}, Open  ]],
Cell[226099, 5372, 11931, 295, 997, "Input",ExpressionUUID->"9b924cc7-0dbe-4345-a47b-b8037d3993c4"],
Cell[238033, 5669, 30861, 645, 2305, "Input",ExpressionUUID->"355267a4-b31c-4b0b-b18a-b19652ecbe01"]
}, Open  ]],
Cell[CellGroupData[{
Cell[268931, 6319, 238, 4, 54, "Subsection",ExpressionUUID->"69886058-1f12-4527-92a7-a681b640421d"],
Cell[269172, 6325, 3356, 89, 409, "Input",ExpressionUUID->"579c9606-a1f1-4b9b-a445-289f117b59c3"],
Cell[272531, 6416, 267, 6, 58, "Text",ExpressionUUID->"bc4d7fcf-2165-4250-84f7-ac4c28cb57e8"],
Cell[272801, 6424, 10512, 230, 1614, "Input",ExpressionUUID->"130f8484-1162-49c9-8266-3bb545959e95"],
Cell[283316, 6656, 8236, 183, 829, "Input",ExpressionUUID->"cf3ef84b-c9cd-49bc-ae54-8d1da841527e"],
Cell[291555, 6841, 5553, 122, 514, "Input",ExpressionUUID->"8b443192-b90e-4374-a91d-2a8b956f6c55"],
Cell[297111, 6965, 6976, 169, 997, "Input",ExpressionUUID->"c4929cc9-0125-490e-b0c7-a645aad1e181"],
Cell[304090, 7136, 4404, 101, 518, "Input",ExpressionUUID->"c0983397-f859-443b-a648-eca7729830e6"],
Cell[308497, 7239, 250, 6, 58, "Text",ExpressionUUID->"d0ed749f-0b97-4eb6-9ab8-c3dbdbdd97ab"],
Cell[308750, 7247, 2613, 62, 304, "Input",ExpressionUUID->"e658e0fc-1be1-44a4-b8e1-a7aa25c4939d"],
Cell[311366, 7311, 202, 3, 35, "Text",ExpressionUUID->"74a329e5-832e-4f2a-8196-69f33af8d367"],
Cell[311571, 7316, 4903, 123, 451, "Input",ExpressionUUID->"ff8ee831-a1e4-4354-969b-21aeb517e15a"]
}, Closed]],
Cell[CellGroupData[{
Cell[316511, 7444, 469, 7, 38, "Subsection",ExpressionUUID->"9c36287a-e846-42f4-ad1f-70984e180b8d"],
Cell[316983, 7453, 163, 3, 35, "Text",ExpressionUUID->"4e7ae57f-dc92-49f3-be20-cafcf451030e"],
Cell[317149, 7458, 29669, 644, 3281, "Input",ExpressionUUID->"cfb2676c-bc79-4a9c-be3a-1cdcabcd1fb7"],
Cell[346821, 8104, 1819, 45, 157, "Input",ExpressionUUID->"a6cf1c80-4f41-45aa-b23b-96f36b13504d"],
Cell[348643, 8151, 288, 6, 35, "Text",ExpressionUUID->"e4e06a40-1cc3-499f-b901-5638ba2524a9"],
Cell[348934, 8159, 12062, 259, 1102, "Input",ExpressionUUID->"f6149651-1254-4c7d-8fe1-4df6f075bb04"],
Cell[360999, 8420, 429, 9, 35, "Text",ExpressionUUID->"de0a3df1-5f0a-47d8-9d4d-830bc4343217"],
Cell[CellGroupData[{
Cell[361453, 8433, 6192, 153, 976, "Input",ExpressionUUID->"b81e9328-d0ac-49ad-980d-ab00d630c1a1"],
Cell[367648, 8588, 1003, 15, 70, "Output",ExpressionUUID->"24f39c8f-40a2-4206-b3fd-d07fff8b17a9"],
Cell[368654, 8605, 1022, 15, 70, "Output",ExpressionUUID->"f40e36a0-018c-4674-b5b1-3949448cdb73"]
}, Open  ]],
Cell[369691, 8623, 231, 6, 35, "Text",ExpressionUUID->"c9a60adf-b69c-4ba2-b28a-f90cf3ddf324"],
Cell[369925, 8631, 26067, 578, 3055, "Input",ExpressionUUID->"83f99a0d-1984-4da2-9682-9834e57c3fd1"]
}, Closed]],
Cell[CellGroupData[{
Cell[396029, 9214, 227, 4, 38, "Subsection",ExpressionUUID->"75f1a45f-f919-4b02-b1e4-836612a90154"],
Cell[396259, 9220, 69314, 1417, 5272, "Input",ExpressionUUID->"ffb8e7eb-e270-45cf-bdac-22996b5761a2"],
Cell[465576, 10639, 4466, 102, 434, "Input",ExpressionUUID->"ba8a16dd-33f7-403d-b707-f9fa1f3604a8"],
Cell[470045, 10743, 602, 9, 30, "Input",ExpressionUUID->"efa64da9-744c-4d73-893b-c7b27984937f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[470684, 10757, 291, 5, 54, "Subsection",ExpressionUUID->"f3f9d1cc-3e2c-4825-a0d7-29b4585b1124"],
Cell[470978, 10764, 21930, 483, 2121, "Input",ExpressionUUID->"723b05ae-81dd-4f5a-82d0-608322a0564a"],
Cell[492911, 11249, 299, 7, 35, "Text",ExpressionUUID->"fb884284-ac2f-41d0-aacc-f95580f7e033"],
Cell[493213, 11258, 2404, 61, 367, "Input",ExpressionUUID->"11e2c631-ca90-4f72-b10c-321eebe439ae"],
Cell[495620, 11321, 296, 7, 35, "Text",ExpressionUUID->"952a44df-be4c-4f7f-90d6-5a89c0548c30"],
Cell[495919, 11330, 3729, 89, 430, "Input",ExpressionUUID->"b49dfcdc-6087-406c-90d1-f16dd0b9f6f4"],
Cell[499651, 11421, 420, 13, 35, "Text",ExpressionUUID->"3ba059ba-06f4-4174-a033-90e5fbcb331d"],
Cell[500074, 11436, 1245, 31, 94, "Input",ExpressionUUID->"a858eade-84f4-4cd8-a216-d2d8cea4c6b0"],
Cell[501322, 11469, 563, 15, 58, "Text",ExpressionUUID->"76c4fdc0-e0b2-4bd0-8ae9-3dda9ed91817"],
Cell[501888, 11486, 7726, 176, 787, "Input",ExpressionUUID->"e9966499-d622-4d1a-b78d-82aad736f544"]
}, Open  ]],
Cell[CellGroupData[{
Cell[509651, 11667, 170, 3, 38, "Subsection",ExpressionUUID->"761434bf-e162-4044-89ac-59519a9762cf"],
Cell[509824, 11672, 2866, 76, 283, "Input",ExpressionUUID->"5b4245f3-403e-430a-b864-95b9e3df7234"],
Cell[512693, 11750, 216, 4, 30, "Input",ExpressionUUID->"cfce9658-5cb8-4e6c-855c-2f38619f91b2"],
Cell[512912, 11756, 15814, 371, 1837, "Input",ExpressionUUID->"bbce31dc-94dc-42d9-a4aa-db39772575ad"],
Cell[528729, 12129, 12422, 293, 1039, "Input",ExpressionUUID->"ed7548de-bc38-4ba5-8b33-a83e0693409e"],
Cell[541154, 12424, 29366, 661, 2912, "Input",ExpressionUUID->"a0138c57-c216-45c1-b608-b6981c4d095d"],
Cell[570523, 13087, 3455, 87, 283, "Input",ExpressionUUID->"8773a2c9-c433-4cbd-b487-9f4df092d4ef"],
Cell[573981, 13176, 5737, 122, 325, "Input",ExpressionUUID->"f851b8f7-e2c2-4af4-a8be-c6fe61843513"]
}, Open  ]],
Cell[CellGroupData[{
Cell[579755, 13303, 243, 4, 54, "Subsection",ExpressionUUID->"4ac6f23e-8948-4365-8039-1d4306ca47c2"],
Cell[580001, 13309, 230, 4, 35, "Text",ExpressionUUID->"97553782-9080-4992-b89d-5a2875f07bea"],
Cell[580234, 13315, 2124, 50, 178, "Input",ExpressionUUID->"1d996ae2-3bf4-413a-be82-6463abd79b52"],
Cell[582361, 13367, 5368, 135, 471, "Input",ExpressionUUID->"f46644c7-81fd-4951-886d-fc430793c2c1"],
Cell[587732, 13504, 15472, 384, 1690, "Input",ExpressionUUID->"f6149bd6-f663-4f54-a7fd-709c72552da6"],
Cell[603207, 13890, 3638, 87, 304, "Input",ExpressionUUID->"585fdc2b-29dc-4191-a8bc-37fe0b7c3076"],
Cell[606848, 13979, 159, 3, 35, "Text",ExpressionUUID->"31868ee5-77ab-4533-9c72-3e00623f4c1a"],
Cell[607010, 13984, 33161, 712, 2079, "Input",ExpressionUUID->"37a4c006-937c-4841-96cc-9f349e9a8851"],
Cell[640174, 14698, 157, 3, 35, "Text",ExpressionUUID->"59cb92fd-9644-4180-a2fe-d1eba58b6ea3"],
Cell[640334, 14703, 10549, 273, 548, "Input",ExpressionUUID->"03acef43-bbda-4252-8712-d0aa7afd4866"],
Cell[650886, 14978, 9899, 229, 605, "Input",ExpressionUUID->"42cff266-af35-490b-b6b3-c05cd2cc75f2"],
Cell[660788, 15209, 4768, 118, 332, "Input",ExpressionUUID->"65436743-875f-4818-84b1-89c9f84454db"],
Cell[665559, 15329, 14626, 349, 1012, "Input",ExpressionUUID->"33986280-e55a-4ed4-8d08-4f6018f6c626"],
Cell[680188, 15680, 201, 4, 30, "Input",ExpressionUUID->"e3369c4c-ba83-4fe2-9457-fd4c4e003be8"],
Cell[680392, 15686, 2126, 53, 94, "Input",ExpressionUUID->"6bea3851-f1c7-4b2a-974e-dcef60362ffd"]
}, Closed]],
Cell[CellGroupData[{
Cell[682555, 15744, 160, 3, 38, "Subsection",ExpressionUUID->"1227a11e-e469-4b58-b926-62d5603e33af"],
Cell[CellGroupData[{
Cell[682740, 15751, 257, 3, 45, "Subsubsection",ExpressionUUID->"d20dc228-a008-47af-b694-418c372839cf"],
Cell[683000, 15756, 5621, 126, 648, "Input",ExpressionUUID->"ef3bd829-a967-4b35-ae72-4c692dc1016e"]
}, Open  ]],
Cell[CellGroupData[{
Cell[688658, 15887, 426, 8, 71, "Subsubsection",ExpressionUUID->"49253782-1fbe-4b98-837e-e02761ed66df"],
Cell[689087, 15897, 60283, 1309, 3086, "Input",ExpressionUUID->"0f2ea8e6-06df-45da-8312-20a24d3091b0"]
}, Open  ]],
Cell[CellGroupData[{
Cell[749407, 17211, 379, 6, 35, "Subsubsection",ExpressionUUID->"cde515fd-aa2a-4e86-a634-f69ea6b86986"],
Cell[749789, 17219, 60679, 1339, 3367, "Input",ExpressionUUID->"b718fe83-eed9-4d0f-91eb-2b8be0de4905"]
}, Open  ]],
Cell[CellGroupData[{
Cell[810505, 18563, 169, 3, 35, "Subsubsection",ExpressionUUID->"d68c2431-b8e4-4524-b8f1-0aee4b85e94d"],
Cell[810677, 18568, 305, 5, 30, "Text",ExpressionUUID->"9fc3668a-dcf4-4baf-8658-ca03564c51fc"],
Cell[810985, 18575, 22614, 491, 1674, "Input",ExpressionUUID->"0e1ce72a-42f1-4629-9488-140b30af53ab"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[833648, 19072, 213, 4, 44, "Subsection",ExpressionUUID->"058679d3-fdd2-4d3b-83e6-fc0cbe3c46fc"],
Cell[CellGroupData[{
Cell[833886, 19080, 311, 5, 35, "Subsubsection",ExpressionUUID->"18ac942d-dfd0-4b1b-8679-d99cac28d600"],
Cell[834200, 19087, 5675, 176, 239, "Text",ExpressionUUID->"fb9c06c7-f9f5-4597-a63b-c1a33aa45389"],
Cell[839878, 19265, 14772, 322, 954, "Input",ExpressionUUID->"f51f6db9-d747-4850-8cd7-a23ce13b6503"],
Cell[854653, 19589, 604, 14, 52, "Input",ExpressionUUID->"d6a43210-6fbf-4c1e-8f8a-a972716d66ae"]
}, Open  ]],
Cell[CellGroupData[{
Cell[855294, 19608, 161, 3, 45, "Subsubsection",ExpressionUUID->"d4f0873d-8413-404e-abb6-7d2965b89fbe"],
Cell[855458, 19613, 37179, 830, 2395, "Input",ExpressionUUID->"99ede8d3-4493-40ab-8632-ef1a6c2209f7"]
}, Open  ]],
Cell[CellGroupData[{
Cell[892674, 20448, 169, 3, 45, "Subsubsection",ExpressionUUID->"7243db19-0eab-4264-aa36-de8977c41bd1"],
Cell[892846, 20453, 19483, 477, 1249, "Input",ExpressionUUID->"6bbbe1bb-8566-49ed-977d-55e820fe713d"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[912378, 20936, 163, 3, 54, "Subsection",ExpressionUUID->"873a2704-7411-4684-a059-287093f25ddc"],
Cell[912544, 20941, 4217, 113, 241, "Input",ExpressionUUID->"cafd2122-a97e-4579-8db1-02ac6645c736"],
Cell[916764, 21056, 3006, 75, 249, "Input",ExpressionUUID->"bc396290-cb5e-43ee-ad48-3c23293b0cb1"],
Cell[919773, 21133, 5974, 143, 493, "Input",ExpressionUUID->"214ac764-d8a9-423c-abc9-3c025c3ed27c"],
Cell[925750, 21278, 576, 12, 30, "Input",ExpressionUUID->"ca075226-f1cd-48c1-89de-27dacb9a0ed0"],
Cell[926329, 21292, 9984, 243, 867, "Input",ExpressionUUID->"ce9daa6a-5d8b-445d-bcee-7dac9cce8592"]
}, Open  ]],
Cell[CellGroupData[{
Cell[936350, 21540, 157, 3, 54, "Subsection",ExpressionUUID->"9cbadb5a-a4dd-4f4f-b9f7-431078e53239"],
Cell[936510, 21545, 23503, 511, 1868, "Input",ExpressionUUID->"24cf69d3-6d7d-4c58-abcc-a3d368e82368"]
}, Open  ]],
Cell[CellGroupData[{
Cell[960050, 22061, 165, 3, 54, "Subsection",ExpressionUUID->"92f93ead-3726-4594-818b-7b96ff9e1318"],
Cell[960218, 22066, 17844, 380, 1774, "Input",ExpressionUUID->"2be76843-2c49-4a50-a3e6-ac71dd42c336"],
Cell[978065, 22448, 51267, 1143, 4428, "Input",ExpressionUUID->"3b3384d4-c8d6-47dc-8059-982b73b60dc0"],
Cell[1029335, 23593, 192, 3, 35, "Text",ExpressionUUID->"ee7f7648-64d2-4117-a60b-25814f6f182c"],
Cell[1029530, 23598, 1115, 31, 73, "Input",ExpressionUUID->"142266a8-a43b-46e5-93fc-ed5d766922e3"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[1030694, 23635, 154, 3, 53, "Section",ExpressionUUID->"946cc172-4e33-4df3-af8f-6fe169d52c2c"],
Cell[CellGroupData[{
Cell[1030873, 23642, 172, 3, 45, "Subsubsection",ExpressionUUID->"6863bd99-0d08-4655-a74e-1dfa79a79be2"],
Cell[1031048, 23647, 276, 6, 58, "Text",ExpressionUUID->"3542947b-cb3c-4a7a-b30b-57f0be7bbc6a"],
Cell[1031327, 23655, 15744, 404, 971, "Input",ExpressionUUID->"cacd306b-3ccf-4bc5-aea8-cdc818cc73a8"],
Cell[1047074, 24061, 1685, 48, 73, "Input",ExpressionUUID->"d4e93104-6ea9-4d1c-ab64-6ff2c38299b4"],
Cell[1048762, 24111, 571, 10, 58, "Text",ExpressionUUID->"4dd2ec47-a0e6-495d-a95b-a51f64c57108"],
Cell[1049336, 24123, 4742, 115, 325, "Input",ExpressionUUID->"6f156344-3584-4059-bbf1-1fec9ca3bb01"],
Cell[1054081, 24240, 760, 14, 81, "Text",ExpressionUUID->"d364e038-4c34-4dc3-8b74-c9770735ae46"],
Cell[1054844, 24256, 2533, 66, 178, "Input",ExpressionUUID->"89927f94-c9be-42bc-8d47-219e59ff15d3"],
Cell[1057380, 24324, 376, 6, 30, "Input",ExpressionUUID->"b66a02d9-cbc3-486e-9c30-30c6812333f7"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1057793, 24335, 234, 4, 45, "Subsubsection",ExpressionUUID->"d9ca92ed-df0c-4eeb-8c51-16eca9cab494"],
Cell[1058030, 24341, 736, 16, 30, "Input",ExpressionUUID->"a205e2e9-d853-417b-8ee7-cb59e9609a36"],
Cell[1058769, 24359, 164, 3, 35, "Text",ExpressionUUID->"bf98179f-d055-4461-8a3a-e2c927530e7e"],
Cell[1058936, 24364, 6641, 190, 238, "Input",ExpressionUUID->"fba62133-07f7-4cd9-909b-6696f1306214"],
Cell[1065580, 24556, 218, 4, 35, "Text",ExpressionUUID->"d9540dc1-b897-407c-98fe-2526926d4303"],
Cell[1065801, 24562, 13474, 335, 716, "Input",ExpressionUUID->"f9c50d79-a3a6-464b-8bcf-56d262111f08"],
Cell[1079278, 24899, 169, 3, 35, "Text",ExpressionUUID->"d2cc44dd-f9f8-4890-8f54-db6e8043d7d7"],
Cell[1079450, 24904, 6532, 160, 403, "Input",ExpressionUUID->"0b38fa54-b794-4050-9595-dec5021cf52c"],
Cell[1085985, 25066, 395, 10, 30, "Input",ExpressionUUID->"16d54f49-87ae-4a4f-9c31-ff6135519d1d"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1086417, 25081, 242, 4, 45, "Subsubsection",ExpressionUUID->"bb874350-6be7-4630-b2d8-a15a61a2598b"],
Cell[1086662, 25087, 852, 23, 38, "Input",ExpressionUUID->"94f1d63d-dbf0-4c72-a708-34eba0d44fa0"],
Cell[1087517, 25112, 169, 3, 35, "Text",ExpressionUUID->"490d6fdd-2a80-4c29-a772-0e4011184bc5"],
Cell[1087689, 25117, 11403, 251, 682, "Input",ExpressionUUID->"51b85ad4-3fa1-4f48-a23d-429265fdb449"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1099129, 25373, 273, 4, 45, "Subsubsection",ExpressionUUID->"b55be332-a3d7-4651-a0ea-92288ade4811"],
Cell[1099405, 25379, 337, 5, 35, "Text",ExpressionUUID->"ee51b2f6-1d03-4d64-8649-4ca5fa50adb9"],
Cell[1099745, 25386, 680, 16, 39, "Input",ExpressionUUID->"0f526d64-7c17-4c63-8842-8ab1691b596d"],
Cell[1100428, 25404, 415, 8, 58, "Text",ExpressionUUID->"aad08327-1dfb-48e2-8639-376bddf9de5d"],
Cell[1100846, 25414, 271, 5, 35, "Text",ExpressionUUID->"595b6675-407e-4fee-88bc-57cb8e85c1d2"],
Cell[1101120, 25421, 28084, 662, 1699, "Input",ExpressionUUID->"5eb08d9e-1d0b-4a12-8b97-90a7f7e658cc"],
Cell[1129207, 26085, 594, 11, 58, "Text",ExpressionUUID->"a688fd3c-ae67-45b8-a708-3fdaded1b63b"],
Cell[1129804, 26098, 30402, 710, 1699, "Input",ExpressionUUID->"dd67b214-e50e-49b8-b49d-b6482a24d2e7"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1160243, 26813, 171, 3, 45, "Subsubsection",ExpressionUUID->"103518bc-8512-4e33-857b-eada89ecb3b6"],
Cell[1160417, 26818, 20426, 529, 1513, "Input",ExpressionUUID->"20aa1bac-97fd-4702-920f-36939296d1e5"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1180880, 27352, 221, 4, 45, "Subsubsection",ExpressionUUID->"3efb631d-22f8-492c-a455-da5e1ed361da"],
Cell[1181104, 27358, 8920, 216, 471, "Input",ExpressionUUID->"0701de14-3d8b-4600-a7f3-fb8447ed027d"],
Cell[1190027, 27576, 11019, 281, 702, "Input",ExpressionUUID->"517e18a0-942f-4bc4-98a8-488c096ba7ec"],
Cell[1201049, 27859, 151, 3, 30, "Input",ExpressionUUID->"4bb66ffd-2852-49f6-876a-47b714c4a2ea"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[1201249, 27868, 150, 3, 53, "Section",ExpressionUUID->"e97a629b-f9a9-4da1-aba0-7f65d9f5be57"],
Cell[CellGroupData[{
Cell[1201424, 27875, 182, 3, 45, "Subsubsection",ExpressionUUID->"02774cef-7a4c-418e-bb84-6a09fd9df543"],
Cell[1201609, 27880, 2588, 72, 119, "Input",ExpressionUUID->"34b7fd84-4372-43e8-bbdc-dc6c305060be"],
Cell[1204200, 27954, 2073, 70, 103, "Text",ExpressionUUID->"6ca0cd71-0f4d-4256-ad9c-263a405f738f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1206310, 28029, 204, 4, 45, "Subsubsection",ExpressionUUID->"12afe558-04f3-484e-8e43-f82c7c9ea63b"],
Cell[1206517, 28035, 5695, 177, 162, "Text",ExpressionUUID->"93030a6d-b0eb-4106-a9eb-48cbdb70b7f6"],
Cell[1212215, 28214, 2552, 71, 89, "Input",ExpressionUUID->"69417181-fd75-4959-b9cd-3809eedde5a3"],
Cell[1214770, 28287, 3168, 101, 104, "Text",ExpressionUUID->"a1b53242-82ce-451e-b171-5caf5ae4aeae"],
Cell[1217941, 28390, 920, 26, 65, "Input",ExpressionUUID->"062c7e38-0e2a-4912-91f3-949f465bbc29"],
Cell[1218864, 28418, 31714, 737, 2440, "Input",ExpressionUUID->"25bfe1ae-3c32-48df-8a76-728fe8b040ff"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1250615, 29160, 250, 6, 45, "Subsubsection",ExpressionUUID->"ba1c0d69-c499-4964-8968-50551176232a"],
Cell[1250868, 29168, 6487, 174, 304, "Input",ExpressionUUID->"307d93b3-493e-454b-983b-655edb2ff377"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[1257404, 29348, 153, 3, 53, "Section",ExpressionUUID->"f04613a5-43e6-4d39-8cf3-527860ad3c1d"],
Cell[CellGroupData[{
Cell[1257582, 29355, 158, 3, 54, "Subsection",ExpressionUUID->"cfb72009-de4e-416d-83e3-8c77d00e9507"],
Cell[1257743, 29360, 153, 3, 35, "Text",ExpressionUUID->"9c54f10d-8469-40fc-a510-9648d55c2327"],
Cell[1257899, 29365, 3219, 90, 253, "Input",ExpressionUUID->"ed5d90a5-dc42-48d2-8cd6-95fe0052795a"],
Cell[1261121, 29457, 153, 3, 35, "Text",ExpressionUUID->"47c6fe0c-2dea-467d-b68b-54e212940f14"],
Cell[1261277, 29462, 971, 25, 115, "Input",ExpressionUUID->"4312f548-4444-4a6c-9a98-36a49134a10d"],
Cell[1262251, 29489, 158, 3, 35, "Text",ExpressionUUID->"10b097e9-e242-45fe-9e80-6d382a5ad363"],
Cell[1262412, 29494, 24545, 613, 1900, "Input",ExpressionUUID->"9b4b9278-8338-49df-aa4a-db3569227381"],
Cell[1286960, 30109, 1234, 32, 117, "Input",ExpressionUUID->"9ee7b3b8-07f4-4999-bccb-623be8f2f3e6"]
}, Open  ]]
}, Open  ]]
}
]
*)

